<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-07-02">

<title>Ingest NOAA CalCOFI Database</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="ingest_swfsc.noaa.gov_calcofi-db_files/libs/clipboard/clipboard.min.js"></script>
<script src="ingest_swfsc.noaa.gov_calcofi-db_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="ingest_swfsc.noaa.gov_calcofi-db_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="ingest_swfsc.noaa.gov_calcofi-db_files/libs/quarto-html/popper.min.js"></script>
<script src="ingest_swfsc.noaa.gov_calcofi-db_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="ingest_swfsc.noaa.gov_calcofi-db_files/libs/quarto-html/anchor.min.js"></script>
<link href="ingest_swfsc.noaa.gov_calcofi-db_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="ingest_swfsc.noaa.gov_calcofi-db_files/libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="ingest_swfsc.noaa.gov_calcofi-db_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="ingest_swfsc.noaa.gov_calcofi-db_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="ingest_swfsc.noaa.gov_calcofi-db_files/libs/bootstrap/bootstrap-81267100e462c21b3d6c0d5bf76a3417.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="ingest_swfsc.noaa.gov_calcofi-db_files/libs/quarto-diagram/mermaid.min.js"></script>
<script src="ingest_swfsc.noaa.gov_calcofi-db_files/libs/quarto-diagram/mermaid-init.js"></script>
<link href="ingest_swfsc.noaa.gov_calcofi-db_files/libs/quarto-diagram/mermaid.css" rel="stylesheet">
<link href="ingest_swfsc.noaa.gov_calcofi-db_files/libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="ingest_swfsc.noaa.gov_calcofi-db_files/libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="ingest_swfsc.noaa.gov_calcofi-db_files/libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="ingest_swfsc.noaa.gov_calcofi-db_files/libs/datatables-binding-0.33/datatables.js"></script>
<script src="ingest_swfsc.noaa.gov_calcofi-db_files/libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="ingest_swfsc.noaa.gov_calcofi-db_files/libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="ingest_swfsc.noaa.gov_calcofi-db_files/libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="ingest_swfsc.noaa.gov_calcofi-db_files/libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="ingest_swfsc.noaa.gov_calcofi-db_files/libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="ingest_swfsc.noaa.gov_calcofi-db_files/libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a>
  <ul class="collapse">
  <li><a href="#check-for-any-mismatched-tables-and-fields" id="toc-check-for-any-mismatched-tables-and-fields" class="nav-link" data-scroll-target="#check-for-any-mismatched-tables-and-fields"><span class="header-section-number">0.1</span> Check for any mismatched tables and fields</a></li>
  </ul></li>
  <li><a href="#data-integrity-check-failed" id="toc-data-integrity-check-failed" class="nav-link" data-scroll-target="#data-integrity-check-failed"><span class="header-section-number">1</span> ⚠️ Data Integrity Check Failed</a>
  <ul class="collapse">
  <li><a href="#workflow-halted" id="toc-workflow-halted" class="nav-link" data-scroll-target="#workflow-halted"><span class="header-section-number">1.1</span> Workflow Halted</a></li>
  <li><a href="#required-actions" id="toc-required-actions" class="nav-link" data-scroll-target="#required-actions"><span class="header-section-number">1.2</span> Required Actions</a></li>
  <li><a href="#common-resolutions" id="toc-common-resolutions" class="nav-link" data-scroll-target="#common-resolutions"><span class="header-section-number">1.3</span> Common Resolutions</a></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps"><span class="header-section-number">1.4</span> Next Steps</a></li>
  <li><a href="#show-csv-files-on-google-drive" id="toc-show-csv-files-on-google-drive" class="nav-link" data-scroll-target="#show-csv-files-on-google-drive"><span class="header-section-number">1.5</span> Show CSV Files on Google Drive</a></li>
  <li><a href="#show-csv-tables-and-fields-to-ingest" id="toc-show-csv-tables-and-fields-to-ingest" class="nav-link" data-scroll-target="#show-csv-tables-and-fields-to-ingest"><span class="header-section-number">1.6</span> Show CSV Tables and Fields to Ingest</a></li>
  </ul></li>
  <li><a href="#show-tables-and-fields-redefined" id="toc-show-tables-and-fields-redefined" class="nav-link" data-scroll-target="#show-tables-and-fields-redefined"><span class="header-section-number">2</span> Show tables and fields redefined</a></li>
  <li><a href="#apply-remappings-to-data" id="toc-apply-remappings-to-data" class="nav-link" data-scroll-target="#apply-remappings-to-data"><span class="header-section-number">3</span> Apply remappings to data</a></li>
  <li><a href="#load-tables-into-database" id="toc-load-tables-into-database" class="nav-link" data-scroll-target="#load-tables-into-database"><span class="header-section-number">4</span> Load Tables into Database</a></li>
  <li><a href="#create-indexes-relationships" id="toc-create-indexes-relationships" class="nav-link" data-scroll-target="#create-indexes-relationships"><span class="header-section-number">5</span> Create Indexes, Relationships</a>
  <ul class="collapse">
  <li><a href="#show-existing-unique-keys-across-tables" id="toc-show-existing-unique-keys-across-tables" class="nav-link" data-scroll-target="#show-existing-unique-keys-across-tables"><span class="header-section-number">5.1</span> Show existing unique keys across tables</a></li>
  <li><a href="#add-candidate-keys-automatically" id="toc-add-candidate-keys-automatically" class="nav-link" data-scroll-target="#add-candidate-keys-automatically"><span class="header-section-number">5.2</span> Add candidate keys, automatically</a></li>
  <li><a href="#add-primary-keys-manually" id="toc-add-primary-keys-manually" class="nav-link" data-scroll-target="#add-primary-keys-manually"><span class="header-section-number">5.3</span> Add primary keys, manually</a></li>
  <li><a href="#add-other-indexes" id="toc-add-other-indexes" class="nav-link" data-scroll-target="#add-other-indexes"><span class="header-section-number">5.4</span> Add other indexes</a></li>
  <li><a href="#add-foreign-keys" id="toc-add-foreign-keys" class="nav-link" data-scroll-target="#add-foreign-keys"><span class="header-section-number">5.5</span> Add foreign keys</a></li>
  </ul></li>
  <li><a href="#add-spatial" id="toc-add-spatial" class="nav-link" data-scroll-target="#add-spatial"><span class="header-section-number">6</span> Add Spatial</a>
  <ul class="collapse">
  <li><a href="#add-site.geom" id="toc-add-site.geom" class="nav-link" data-scroll-target="#add-site.geom"><span class="header-section-number">6.1</span> Add <code>site.geom</code></a></li>
  <li><a href="#fix-calcofi4r-grid" id="toc-fix-calcofi4r-grid" class="nav-link" data-scroll-target="#fix-calcofi4r-grid"><span class="header-section-number">6.2</span> Fix calcofi4r <code>grid</code></a></li>
  <li><a href="#update-site.grid_key" id="toc-update-site.grid_key" class="nav-link" data-scroll-target="#update-site.grid_key"><span class="header-section-number">6.3</span> Update <code>site.grid_key</code></a></li>
  <li><a href="#add-site_seg-segments-from-site" id="toc-add-site_seg-segments-from-site" class="nav-link" data-scroll-target="#add-site_seg-segments-from-site"><span class="header-section-number">6.4</span> Add <code>site_seg</code>: segments from site</a></li>
  </ul></li>
  <li><a href="#report" id="toc-report" class="nav-link" data-scroll-target="#report"><span class="header-section-number">7</span> Report</a></li>
  <li><a href="#cleanup" id="toc-cleanup" class="nav-link" data-scroll-target="#cleanup"><span class="header-section-number">8</span> Cleanup</a></li>
  <li><a href="#todo" id="toc-todo" class="nav-link" data-scroll-target="#todo"><span class="header-section-number">9</span> TODO</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Ingest NOAA CalCOFI Database</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2025-07-02</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="overview" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="overview">Overview</h2>
<p><strong>Goal</strong>: Generate the database from source files with workflow scripts to make updating easier and provenance fully transparent. This allows us to:</p>
<ul>
<li><p>Rename tables and column names, control data types and use Unicode encoding for a consistent database ingestion strategy, per Database naming conventions in <a href="https://calcofi.io/docs/db.html">Database – CalCOFI.io Docs</a>.</p></li>
<li><p>Differentiate between raw and derived or updated tables and columns. For instance, the taxonomy for any given species can change over time, such as lumping or splitting of a given taxa, and by taxonomic authority (e.g., WoRMS, ITIS or GBIF). These taxonomic identifiers and the full taxonomic hierarchy should get regularly updated regardless of source observational data, and can either be updated in the table directly or joined one-to-one with a seperate table in a materialized view (so as not to slow down queries with a regular view).</p></li>
</ul>
<p>This workflow processes NOAA CalCOFI database CSV files and updates the PostgreSQL database. The workflow:</p>
<ol type="1">
<li>Reads CSV files from source directory</li>
<li>Compares with lookup tables for field descriptions</li>
<li>Initializes or updates database tables</li>
<li>Generates summary statistics</li>
</ol>
<div class="cell" data-file="diagrams/ingest_noaa-calcofi-db_overview.mmd" data-layout-align="default">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>graph TD</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    A[Read CSV Files] --&gt; B[Extract Column Names]</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    B --&gt; C[Compare with Lookups]</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    C --&gt; D[Process Field Descriptions]</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    D --&gt; E{Table Exists?}</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    E --&gt;|Yes| F[Update Table]</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    E --&gt;|No| G[Initialize Table]</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    F --&gt; H[Summary Stats]</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    G --&gt; H</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="overview">
<div>
<pre class="mermaid mermaid-js" data-label="overview">graph TD
    A[Read CSV Files] --&gt; B[Extract Column Names]
    B --&gt; C[Compare with Lookups]
    C --&gt; D[Process Field Descriptions]
    D --&gt; E{Table Exists?}
    E --&gt;|Yes| F[Update Table]
    E --&gt;|No| G[Initialize Table]
    F --&gt; H[Summary Stats]
    G --&gt; H
</pre>
</div>
<p>Overview diagram of CSV ingestion process into the database.</p>
</div>
</div>
</div>
<p>See also <a href="https://calcofi.io/docs/db.html#ingest-datasets-with-documentation">5.3 Ingest datasets with documentation – Database – CalCOFI.io Docs</a> for generic overview of ingestion process.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_local(here::here("../calcofi4db"), force = T)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::load_all(here::here("../calcofi4db"))</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># options(error=NULL)</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  calcofi4db, DBI, dm, dplyr, DT, fs, glue, gargle, googledrive, here, janitor,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  jsonlite, knitr, lubridate, purrr, readr, rlang, tibble, tidyr, uuid,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">quiet =</span> T)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">readr.show_col_types =</span> F)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># get database connection</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>con     <span class="ot">&lt;-</span> <span class="fu">get_db_con</span>(<span class="fu">c</span>(<span class="st">"dev"</span>, <span class="st">"dev_ref"</span>))</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>con_dev <span class="ot">&lt;-</span> <span class="fu">get_db_con</span>(<span class="fu">c</span>(<span class="st">"dev"</span>))</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># define paths ---</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>dataset  <span class="ot">&lt;-</span> <span class="st">"calcofi-db"</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>provider <span class="ot">&lt;-</span> <span class="st">"swfsc.noaa.gov"</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># data directory with CSV files</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co"># dir_data &lt;- "/Users/bbest/My Drive/projects/calcofi/data"</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># same data folder as Google Drive URL</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co"># gdir_data &lt;- "https://drive.google.com/drive/u/0/folders/13A9yDJCdV0M-lrMLqurzIb3G3ozknr9O"</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data using calcofi4db package</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">read_csv_files</span>(provider, dataset)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract variables from data_info for backward compatibility</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co"># workflow_info &lt;- data_info$workflow_info</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="co"># workflow      &lt;- workflow_info$workflow</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co"># workflow_qmd  &lt;- workflow_info$workflow_qmd</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="co"># workflow_url  &lt;- workflow_info$workflow_url</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="co"># dir_csv &lt;- data_info$paths$dir_csv</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="co"># dir_ingest &lt;- dirname(data_info$paths$dir_ingest)</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="co"># tbls_in_csv &lt;- data_info$paths$tbls_in_csv</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="co"># flds_in_csv &lt;- data_info$paths$flds_in_csv</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="co"># tbls_rn_csv &lt;- data_info$paths$tbls_rn_csv</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="co"># flds_rn_csv &lt;- data_info$paths$flds_rn_csv</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="co"># d_gdir_data &lt;- data_info$d_gdir_data</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="co"># d_tbls_rn &lt;- data_info$d_tbls_rn</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="co"># d_flds_rn &lt;- data_info$d_flds_rn</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="co"># d &lt;- data_info$csv_metadata$data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="check-for-any-mismatched-tables-and-fields" class="level3" data-number="0.1">
<h3 data-number="0.1" class="anchored" data-anchor-id="check-for-any-mismatched-tables-and-fields"><span class="header-section-number">0.1</span> Check for any mismatched tables and fields</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># detect changes between csv files and redefinitions</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>changes <span class="ot">&lt;-</span> <span class="fu">detect_csv_changes</span>(d)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># print summary statistics</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print_csv_change_stats</span>(changes, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CSV Change Summary:
==================
Tables added:    3
Tables removed:  0
Fields added:    1 (across 1 tables)
Fields removed:  1 (across 1 tables)
Type mismatches: 0 (across 0 tables)

Tables Added:
  + eggstage
  + larvaesize
  + larvaestage

Fields Added:
  cruise:
    + ship

Fields Removed:
  cruise:
    - Ship</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># display interactive table of changes</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(changes<span class="sc">$</span>summary) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">display_csv_changes</span>(changes, <span class="at">format =</span> <span class="st">"DT"</span>, <span class="at">title =</span> <span class="st">"CSV vs Redefinition Mismatches"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-2f18a8c5a0a7c36de82f" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-2f18a8c5a0a7c36de82f">{"x":{"filter":"none","vertical":false,"caption":"<caption>CSV vs Redefinition Mismatches<\/caption>","data":[["-","+","+","+","+"],["cruise","cruise","eggstage","larvaesize","larvaestage"],["Ship","ship",null,null,null],["removed","added","table_added","table_added","table_added"],["character",null,null,null,null],[null,"character","new table","new table","new table"],["Field removed from CSV","Field added in CSV","Table added in CSV","Table added in CSV","Table added in CSV"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>Icon<\/th>\n      <th>Table<\/th>\n      <th>Field<\/th>\n      <th>Change Type<\/th>\n      <th>Old Value<\/th>\n      <th>New Value<\/th>\n      <th>Description<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":25,"autoWidth":true,"columnDefs":[{"className":"dt-center","targets":0},{"width":"5%","targets":0},{"width":"15%","targets":1},{"width":"15%","targets":2},{"width":"15%","targets":3},{"width":"15%","targets":4},{"width":"15%","targets":5},{"width":"20%","targets":6},{"name":"Icon","targets":0},{"name":"Table","targets":1},{"name":"Field","targets":2},{"name":"Change Type","targets":3},{"name":"Old Value","targets":4},{"name":"New Value","targets":5},{"name":"Description","targets":6}],"order":[],"orderClasses":false,"rowCallback":"function(row, data, displayNum, displayIndex, dataIndex) {\nvar value=data[0]; $(this.api().cell(row, 0).node()).css({'font-weight':'bold','color':value == \"+\" ? \"#28a745\" : value == \"-\" ? \"#dc3545\" : value == \"⚠\" ? \"#fd7e14\" : null,'font-size':'120%'});\n}"},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":["options.rowCallback"],"jsHooks":[]}</script>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check if there are any mismatches that need to be resolved</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(changes<span class="sc">$</span>summary) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># disable evaluation of remaining chunks</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">eval =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># output markdown warning</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="st">    ## ⚠️ Data Integrity Check Failed</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="st">    ### Workflow Halted</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="st">    Mismatches have been detected between the CSV files and redefinition metadata. </span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="st">    These must be resolved before proceeding with database ingestion to ensure data integrity.</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="st">    ### Required Actions</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="st">    Please review the changes detected above and update the following redefinition files:</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="st">    - **Tables redefinition**: `{d$paths$tbls_rd_csv}`</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="st">    - **Fields redefinition**: `{d$paths$flds_rd_csv}`</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="st">    ### Common Resolutions</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="st">    1. **New tables/fields in CSV**: Add them to the appropriate redefinition file</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="st">    2. **Removed tables/fields from CSV**: Remove obsolete entries from redefinition files</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="st">    3. **Type mismatches**: Update field types in redefinition files to match CSV data types</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="st">    4. **Field name changes**: Update `fld_old` entries to match current CSV field names</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="st">    ### Next Steps</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="st">    After updating the redefinition files, re-run this workflow. The remaining code chunks </span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="st">    have been disabled and will not execute until all mismatches are resolved.</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="st">    ---</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a><span class="st">    *Note: The remainder of this document contains code that will not be executed due to </span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a><span class="st">    data integrity issues.*</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a><span class="st">    "</span>))</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># no mismatches found - enable evaluation and show success message</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">eval =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a><span class="st">    ## ✅ Data Integrity Check Passed</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a><span class="st">    ### All Systems Go</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a><span class="st">    No mismatches were found between the CSV files and redefinition metadata. </span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a><span class="st">    The data structures are properly aligned and ready for database ingestion.</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a><span class="st">    ### Proceeding with Workflow</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a><span class="st">    The workflow will now continue with the following steps:</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a><span class="st">    1. Display CSV file metadata from Google Drive</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a><span class="st">    2. Show tables and fields to be ingested</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a><span class="st">    3. Apply data transformations based on redefinitions</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a><span class="st">    4. Load transformed data into the database</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a><span class="st">    5. Create indexes and relationships</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a><span class="st">    6. Add spatial data and generate reports</span></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a><span class="st">    ---</span></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a><span class="st">    "</span>))</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</section>
</section>
<section id="data-integrity-check-failed" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="data-integrity-check-failed"><span class="header-section-number">1</span> ⚠️ Data Integrity Check Failed</h2>
<section id="workflow-halted" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="workflow-halted"><span class="header-section-number">1.1</span> Workflow Halted</h3>
<p>Mismatches have been detected between the CSV files and redefinition metadata. These must be resolved before proceeding with database ingestion to ensure data integrity.</p>
</section>
<section id="required-actions" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="required-actions"><span class="header-section-number">1.2</span> Required Actions</h3>
<p>Please review the changes detected above and update the following redefinition files:</p>
<ul>
<li><strong>Tables redefinition</strong>: <code>/Users/bbest/Github/CalCOFI/workflows/ingest/swfsc.noaa.gov/calcofi-db/tbls_redefine.csv</code></li>
<li><strong>Fields redefinition</strong>: <code>/Users/bbest/Github/CalCOFI/workflows/ingest/swfsc.noaa.gov/calcofi-db/flds_redefine.csv</code></li>
</ul>
</section>
<section id="common-resolutions" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="common-resolutions"><span class="header-section-number">1.3</span> Common Resolutions</h3>
<ol type="1">
<li><strong>New tables/fields in CSV</strong>: Add them to the appropriate redefinition file</li>
<li><strong>Removed tables/fields from CSV</strong>: Remove obsolete entries from redefinition files</li>
<li><strong>Type mismatches</strong>: Update field types in redefinition files to match CSV data types</li>
<li><strong>Field name changes</strong>: Update <code>fld_old</code> entries to match current CSV field names</li>
</ol>
</section>
<section id="next-steps" class="level3" data-number="1.4">
<h3 data-number="1.4" class="anchored" data-anchor-id="next-steps"><span class="header-section-number">1.4</span> Next Steps</h3>
<p>After updating the redefinition files, re-run this workflow. The remaining code chunks have been disabled and will not execute until all mismatches are resolved.</p>
<hr>
<p><em>Note: The remainder of this document contains code that will not be executed due to data integrity issues.</em></p>
</section>
<section id="show-csv-files-on-google-drive" class="level3" data-number="1.5">
<h3 data-number="1.5" class="anchored" data-anchor-id="show-csv-files-on-google-drive"><span class="header-section-number">1.5</span> Show CSV Files on Google Drive</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show_googledrive_files</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="show-csv-tables-and-fields-to-ingest" class="level3" data-number="1.6">
<h3 data-number="1.6" class="anchored" data-anchor-id="show-csv-tables-and-fields-to-ingest"><span class="header-section-number">1.6</span> Show CSV Tables and Fields to Ingest</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>d_csv<span class="sc">$</span>tables <span class="sc">|&gt;</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Tables to ingest."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>d_csv<span class="sc">$</span>fields <span class="sc">|&gt;</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Fields to ingest."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="show-tables-and-fields-redefined" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="show-tables-and-fields-redefined"><span class="header-section-number">2</span> Show tables and fields redefined</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show_tables_redefine</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show_fields_redefine</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="apply-remappings-to-data" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="apply-remappings-to-data"><span class="header-section-number">3</span> Apply remappings to data</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use calcofi4db to transform data</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>transformed_data <span class="ot">&lt;-</span> <span class="fu">transform_data</span>(d)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># For backward compatibility</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> transformed_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="load-tables-into-database" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="load-tables-into-database"><span class="header-section-number">4</span> Load Tables into Database</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>schema    <span class="ot">&lt;-</span> <span class="st">"dev"</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>overwrite <span class="ot">&lt;-</span> T</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Use calcofi4db to ingest tables and generate metadata</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># First, check for changes (this is now done above)</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># changes &lt;- detect_csv_changes(</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   con = con,</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   schema = schema,</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   transformed_data = transformed_data,</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   d_flds_rd = d$d_flds_rd</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Display changes</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(changes<span class="sc">$</span>new_tables) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"New tables to be added:"</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">" -"</span>, changes<span class="sc">$</span>new_tables, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(changes<span class="sc">$</span>field_changes) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Tables with field changes:"</span>)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (tbl <span class="cf">in</span> <span class="fu">names</span>(changes<span class="sc">$</span>field_changes)) {</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">" - {tbl}:"</span>))</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(changes<span class="sc">$</span>field_changes[[tbl]]<span class="sc">$</span>added) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"   Added: {paste(changes$field_changes[[tbl]]$added, collapse = ', ')}"</span>))</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(changes<span class="sc">$</span>field_changes[[tbl]]<span class="sc">$</span>removed) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"   Removed: {paste(changes$field_changes[[tbl]]$removed, collapse = ', ')}"</span>))</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(changes<span class="sc">$</span>type_changes) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Tables with type changes:"</span>)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (tbl <span class="cf">in</span> <span class="fu">names</span>(changes<span class="sc">$</span>type_changes)) {</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">" - {tbl}:"</span>))</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (fld <span class="cf">in</span> <span class="fu">names</span>(changes<span class="sc">$</span>type_changes[[tbl]])) {</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"   {fld}: {changes$type_changes[[tbl]][[fld]]$from} -&gt; {changes$type_changes[[tbl]][[fld]]$to}"</span>))</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Ingest data to database</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>tbl_stats <span class="ot">&lt;-</span> <span class="fu">ingest_csv_to_db</span>(</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">con =</span> con,</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">schema =</span> schema,</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">transformed_data =</span> transformed_data,</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">d_flds_rd =</span> d<span class="sc">$</span>d_flds_rd,</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">d_gdir_data =</span> d<span class="sc">$</span>d_gdata,</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">workflow_info =</span> d<span class="sc">$</span>workflow_info,</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> overwrite</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Display summary statistics</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>tbl_stats <span class="sc">|&gt;</span> </span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">rownames =</span> <span class="cn">FALSE</span>, <span class="at">filter =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>TODO:</p>
<ul class="task-list">
<li><label><input type="checkbox">add COMMENTS to table with JSON of dtime ingested, source, and workflow</label></li>
</ul>
</section>
<section id="create-indexes-relationships" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="create-indexes-relationships"><span class="header-section-number">5</span> Create Indexes, Relationships</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># source(here("../apps_dev/libs/db.R"))</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>tbls_dev <span class="ot">&lt;-</span> <span class="fu">dbListTables</span>(con_dev) <span class="sc">|&gt;</span> <span class="fu">sort</span>()</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>dm_dev <span class="ot">&lt;-</span> <span class="fu">dm_from_con</span>(</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  con_dev, </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">table_names =</span> tbls_dev,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_keys  =</span> T)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_draw</span>(dm_dev, <span class="at">view_type =</span> <span class="st">"all"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="show-existing-unique-keys-across-tables" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="show-existing-unique-keys-across-tables"><span class="header-section-number">5.1</span> Show existing unique keys across tables</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_get_all_uks</span>(dm_dev)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="add-candidate-keys-automatically" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="add-candidate-keys-automatically"><span class="header-section-number">5.2</span> Add candidate keys, automatically</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get primary key constraints for a table</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>tbl_pkeys <span class="ot">&lt;-</span> <span class="cf">function</span>(con, tbl) {</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbGetQuery</span>(con, <span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT a.attname as column_name</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM pg_index i</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="st">    JOIN pg_attribute a ON a.attrelid = i.indrelid</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="st">    AND a.attnum = ANY(i.indkey)</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE i.indrelid = '{tbl}'::regclass</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="st">    AND i.indisprimary;</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="st">  "</span>))<span class="sc">$</span>column_name</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>d_pk <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">tbl =</span> tbls_dev) <span class="sc">|&gt;</span> </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">d        =</span> <span class="fu">map</span>(tbl, \(x) <span class="fu">eval</span>(<span class="fu">bquote</span>(<span class="fu">dm_enum_pk_candidates</span>(dm_dev, .(x)))) ),</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">n        =</span> <span class="fu">map_int</span>(d, \(x) x <span class="sc">|&gt;</span> <span class="fu">filter</span>(candidate <span class="sc">==</span> T) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()),</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">flds     =</span> <span class="fu">map_chr</span>(d, \(x){</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>      x <span class="sc">|&gt;</span> <span class="fu">filter</span>(candidate <span class="sc">==</span> T) <span class="sc">|&gt;</span> <span class="fu">pull</span>(columns) <span class="sc">|&gt;</span> </span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">unlist</span>() <span class="sc">|&gt;</span> <span class="fu">paste</span>(<span class="at">collapse =</span> <span class="st">"; "</span>) }),</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">fld      =</span> <span class="fu">map_chr</span>(d, \(x){</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>      y <span class="ot">&lt;-</span> x <span class="sc">|&gt;</span> <span class="fu">filter</span>(candidate <span class="sc">==</span> T) <span class="sc">|&gt;</span> <span class="fu">pull</span>(columns) <span class="sc">|&gt;</span> </span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">unlist</span>()</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(y) <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(y) <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(y[<span class="dv">1</span>])</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>      y }),</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">add_pkey =</span> <span class="fu">map2_lgl</span>(tbl, fld, \(tbl, fld){</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.na</span>(fld))</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(F)</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>      <span class="co"># tbl &lt;- "cruise"; fld = "cruise_uuid"</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>      pkey_exists <span class="ot">&lt;-</span> <span class="fu">tbl_pkeys</span>(con_dev, <span class="st">"cruise"</span>) <span class="sc">|&gt;</span> <span class="fu">length</span>() <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (pkey_exists)</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(F)</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">dbExecute</span>(con_dev, <span class="fu">glue</span>(<span class="st">"ALTER TABLE {tbl} ADD PRIMARY KEY ({fld})"</span>))</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(T) }) ) <span class="sc">|&gt;</span> </span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>d)</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>d_pk <span class="sc">|&gt;</span> </span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="add-primary-keys-manually" class="level3" data-number="5.3">
<h3 data-number="5.3" class="anchored" data-anchor-id="add-primary-keys-manually"><span class="header-section-number">5.3</span> Add primary keys, manually</h3>
<p>Noticing egg and larva missing pkey.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">"ALTER TABLE egg ADD PRIMARY KEY (net_uuid, sp_id)"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">"ALTER TABLE larva ADD PRIMARY KEY (net_uuid, sp_id)"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">tbl =</span> tbls_dev) <span class="sc">|&gt;</span> </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">pkeys =</span> <span class="fu">map_chr</span>(tbl, \(x) <span class="fu">tbl_pkeys</span>(x, <span class="at">con =</span> con_dev) <span class="sc">|&gt;</span> <span class="fu">paste</span>(<span class="at">collapse =</span> <span class="st">", "</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="add-other-indexes" class="level3" data-number="5.4">
<h3 data-number="5.4" class="anchored" data-anchor-id="add-other-indexes"><span class="header-section-number">5.4</span> Add other indexes</h3>
<p>That are not already the first field of a primary key.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>d_idx <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">tbl =</span> tbls_dev) <span class="sc">|&gt;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">fld   =</span> <span class="fu">map</span>(tbl, <span class="sc">~</span><span class="fu">dbListFields</span>(.x, <span class="at">conn =</span> con_dev)),</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">pkeys =</span> <span class="fu">map</span>(tbl, <span class="sc">~</span><span class="fu">tbl_pkeys</span>(.x, <span class="at">con =</span> con_dev))) <span class="sc">|&gt;</span> </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(fld) <span class="sc">|&gt;</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_pkey  =</span> <span class="fu">map2_lgl</span>(fld, pkeys, <span class="st">`</span><span class="at">%in%</span><span class="st">`</span>),</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_pkey1 =</span> <span class="fu">map2_lgl</span>(fld, pkeys, \(fld, pkeys) fld <span class="sc">==</span> pkeys[<span class="dv">1</span>]),</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_id    =</span> <span class="fu">map_lgl</span>(fld, <span class="sc">~</span><span class="fu">str_detect</span>(.x, <span class="st">"_(id|uuid|tsn)$"</span>)),</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">idx_todo =</span> <span class="sc">!</span>is_pkey1 <span class="sc">&amp;</span> is_id,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">mk_idx   =</span> <span class="fu">pmap_lgl</span>(<span class="fu">list</span>(tbl, fld, idx_todo), \(tbl, fld, idx_todo){</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (idx_todo){</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>        q <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"CREATE INDEX IF NOT EXISTS idx_{tbl}_{fld} ON {tbl} ({fld})"</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># message(q)</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">dbExecute</span>(con_dev, q)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(T)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(F)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>d_idx <span class="sc">|&gt;</span> </span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>pkeys) <span class="sc">|&gt;</span> </span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="add-foreign-keys" class="level3" data-number="5.5">
<h3 data-number="5.5" class="anchored" data-anchor-id="add-foreign-keys"><span class="header-section-number">5.5</span> Add foreign keys</h3>
<p>egg.net_uuid -&gt; net.net_uuid .tow_uuid -&gt; tow.tow_uuid .site_uuid -&gt; site.site_uuid .cruise_uuid -&gt; cruise.cruise_uuid .ship_key -&gt; ship.ship_key</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>dm_dev <span class="ot">&lt;-</span> <span class="fu">dm_from_con</span>(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  con_dev, </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">table_names =</span> tbls_dev,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_keys  =</span> T)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_draw</span>(dm_dev, <span class="at">view_type =</span> <span class="st">"all"</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>dm_dev_fk <span class="ot">&lt;-</span> dm_dev <span class="sc">|&gt;</span> </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_add_fk</span>(egg, net_uuid, net) <span class="sc">|&gt;</span> </span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_add_fk</span>(larva, net_uuid, net) <span class="sc">|&gt;</span> </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_add_fk</span>(net, tow_uuid, tow) <span class="sc">|&gt;</span> </span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_add_fk</span>(tow, site_uuid, site) <span class="sc">|&gt;</span> </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_add_fk</span>(site, cruise_uuid, cruise) <span class="sc">|&gt;</span> </span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_add_fk</span>(cruise, ship_key, ship) <span class="sc">|&gt;</span> </span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_add_fk</span>(tow, tow_type_key, tow_type) <span class="sc">|&gt;</span> </span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_add_fk</span>(egg, sp_id, species) <span class="sc">|&gt;</span> </span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_add_fk</span>(larva, sp_id, species) </span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_draw</span>(dm_dev_fk, <span class="at">view_type =</span> <span class="st">"all"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>add_fkey <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl_m, fld_m, tbl_1, <span class="at">fld_1 =</span> fld_m, <span class="at">schema =</span> <span class="st">"dev"</span>){</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  q <span class="ot">&lt;-</span> <span class="fu">glue</span>(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ALTER TABLE {schema}.{tbl_m} ADD FOREIGN KEY ({fld_m}) </span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="st">    REFERENCES {schema}.{tbl_1} ({fld_1})"</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbExecute</span>(con_dev, q)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"egg"</span>, <span class="st">"net_uuid"</span>, <span class="st">"net"</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"larva"</span>, <span class="st">"net_uuid"</span>, <span class="st">"net"</span>) </span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"net"</span>, <span class="st">"tow_uuid"</span>, <span class="st">"tow"</span>) </span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"tow"</span>, <span class="st">"site_uuid"</span>, <span class="st">"site"</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"site"</span>, <span class="st">"cruise_uuid"</span>, <span class="st">"cruise"</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"cruise"</span>, <span class="st">"ship_key"</span>, <span class="st">"ship"</span>)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"tow"</span>, <span class="st">"tow_type_key"</span>, <span class="st">"tow_type"</span>)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"egg"</span>, <span class="st">"sp_id"</span>, <span class="st">"species"</span>)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"larva"</span>, <span class="st">"sp_id"</span>, <span class="st">"species"</span>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>dm_dev <span class="ot">&lt;-</span> <span class="fu">dm_from_con</span>(</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  con_dev, </span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">table_names =</span> tbls_dev,</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_keys  =</span> T)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_draw</span>(dm_dev, <span class="at">view_type =</span> <span class="st">"all"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<pre><code>Error: Failed to fetch row : ERROR:  insert or update on table "larva" violates foreign key constraint "larva_sp_id_fkey"
DETAIL:  Key (sp_id)=(3023) is not present in table "species".</code></pre>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>sp_missing_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data/ingest/noaa-calcofi-db/larvae-species_not-in-species.csv"</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>d_sp_missing <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_dev, <span class="st">"larva"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anti_join</span>(</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tbl</span>(con_dev, <span class="st">"species"</span>),</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"sp_id"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sp_id) <span class="sc">|&gt;</span> </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_rows =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    dm_dev <span class="sc">|&gt;</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">dm_select_tbl</span>(larva, net, tow, site) <span class="sc">|&gt;</span> </span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">dm_flatten_to_tbl</span>(<span class="at">.start =</span> larva, <span class="at">.recursive =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(sp_id, tally, time_start, line, station, cruise_uuid) <span class="sc">|&gt;</span> </span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(sp_id) <span class="sc">|&gt;</span> </span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarize</span>(</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">sum_tally  =</span> <span class="fu">sum</span>(tally),</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">date_beg   =</span> <span class="fu">min</span>(<span class="fu">as.Date</span>(time_start)),</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">date_end   =</span> <span class="fu">max</span>(<span class="fu">as.Date</span>(time_start)),</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ship_names = str_flatten(distinct(name), collapse = "; ")), </span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_cruises =</span> <span class="fu">n_distinct</span>(cruise_uuid)), </span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"sp_id"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d_sp_missing, sp_missing_csv)</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(d_sp_missing)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="fu">glue</span>(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"DELETE FROM larva WHERE sp_id IN ({paste(d_sp_missing$sp_id, collapse = ',')})"</span>))</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"larva"</span>, <span class="st">"sp_id"</span>, <span class="st">"species"</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>dm_dev <span class="ot">&lt;-</span> <span class="fu">dm_from_con</span>(</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  con_dev, </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">table_names =</span> tbls_dev,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_keys  =</span> T)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_draw</span>(dm_dev, <span class="at">view_type =</span> <span class="st">"all"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="add-spatial" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="add-spatial"><span class="header-section-number">6</span> Add Spatial</h2>
<section id="add-site.geom" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="add-site.geom"><span class="header-section-number">6.1</span> Add <code>site.geom</code></h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># source(here("../apps_dev/libs/db.R"))</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># dbGetQuery(con_dev, "SELECT postgis_full_version()")</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">"ALTER TABLE dev.site ADD COLUMN geom geometry(Point, 4326)"</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">"UPDATE dev.site SET geom = ST_SetSRID(ST_MakePoint(longitude, latitude), 4326)"</span>) <span class="co"># 61,220 rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="fix-calcofi4r-grid" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="fix-calcofi4r-grid"><span class="header-section-number">6.2</span> Fix calcofi4r <code>grid</code></h3>
<p>Problems with <a href="https://calcofi.io/calcofi4r/articles/calcofi4r.html">calcofi4r::<code>cc_grid</code></a>:</p>
<ul>
<li>uses old station (line, position) vs newer site (line, station)</li>
<li><code>sta_lin</code>, <code>sta_pos</code>: integer, so drops necessary decimal that is found in <code>sta_key</code></li>
<li><code>sta_lin == 90, sta_pos == 120</code> repeats for:
<ul>
<li><code>sta_pattern</code> == ‘historical’ (<code>sta_dpos</code> == 20); and</li>
<li><code>sta_pattern</code> == ‘standard’ (<code>sta_dpos</code> == 10)</li>
</ul></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  calcofi4r, dplyr, mapview, sf, tidyr, units)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>cc_grid_v2 <span class="ot">&lt;-</span> calcofi4r<span class="sc">::</span>cc_grid <span class="sc">|&gt;</span> </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sta_key, <span class="at">shore =</span> sta_shore, <span class="at">pattern =</span> sta_pattern, <span class="at">spacing =</span> sta_dpos) <span class="sc">|&gt;</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate_wider_delim</span>(</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    sta_key, <span class="st">","</span>, <span class="at">names =</span> <span class="fu">c</span>(<span class="st">"line"</span>, <span class="st">"station"</span>), <span class="at">cols_remove =</span> F) <span class="sc">|&gt;</span> </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">line    =</span> <span class="fu">as.double</span>(line),</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">station =</span> <span class="fu">as.double</span>(station),</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid_key =</span> <span class="fu">ifelse</span>(</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>      pattern <span class="sc">==</span> <span class="st">"historical"</span>, </span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">glue</span>(<span class="st">"st{station}-ln{line}_hist"</span>),</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">glue</span>(<span class="st">"st{station}-ln{line}"</span>)),</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">zone =</span> <span class="fu">glue</span>(<span class="st">"{shore}-{pattern}"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(grid_key, station) <span class="sc">|&gt;</span> </span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>() <span class="sc">|&gt;</span> </span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">area_km2 =</span> <span class="fu">st_area</span>(geom) <span class="sc">|&gt;</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_units</span>(km<span class="sc">^</span><span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.numeric</span>())</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>cc_grid_ctrs_v2 <span class="ot">&lt;-</span> calcofi4r<span class="sc">::</span>cc_grid_ctrs <span class="sc">|&gt;</span> </span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sta_key, <span class="at">pattern =</span> sta_pattern) <span class="sc">|&gt;</span> </span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    cc_grid_v2 <span class="sc">|&gt;</span> </span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_drop_geometry</span>(),</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"sta_key"</span>, <span class="st">"pattern"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>sta_key) <span class="sc">|&gt;</span> </span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(grid_key)</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>cc_grid_v2 <span class="ot">&lt;-</span> cc_grid_v2 <span class="sc">|&gt;</span> </span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>sta_key)</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>cc_grid_v2 <span class="sc">|&gt;</span> </span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>()</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a><span class="fu">mapview</span>(cc_grid_v2, <span class="at">zcol=</span><span class="st">"zone"</span>) <span class="sc">+</span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapview</span>(cc_grid_ctrs_v2, <span class="at">cex =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> cc_grid_v2 <span class="sc">|&gt;</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    cc_grid_ctrs_v2 <span class="sc">|&gt;</span> </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(grid_key, <span class="at">geom_ctr =</span> geom),</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"grid_key"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">sf_column_name =</span> <span class="st">"geom"</span>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>grid <span class="sc">|&gt;</span> </span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_write</span>(con_dev, <span class="st">"grid"</span>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="fu">glue</span>(</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"CREATE INDEX IF NOT EXISTS idx_grid_geom ON grid USING gist(geom);"</span>))</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">"ALTER TABLE grid ADD PRIMARY KEY (grid_key)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="update-site.grid_key" class="level3" data-number="6.3">
<h3 data-number="6.3" class="anchored" data-anchor-id="update-site.grid_key"><span class="header-section-number">6.3</span> Update <code>site.grid_key</code></h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">"ALTER TABLE site ADD COLUMN grid_key text"</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">"</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="st">  UPDATE site</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="st">  SET</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="st">    grid_key = g.grid_key</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM (</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT s.site_uuid, g.grid_key</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM site s</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="st">    INNER JOIN grid g ON ST_Intersects(s.geom, g.geom)) g</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE site.site_uuid = g.site_uuid"</span>) <span class="co"># 59,136</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="co"># tbl(con_dev, "site") |&gt;</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(is_in_grd = !is.na(grid_key)) |&gt;</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   pull(is_in_grd) |&gt;</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   table()</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="co">#  FALSE    TRUE </span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="co">#  2,084  59,136</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="fu">glue</span>(</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"CREATE INDEX IF NOT EXISTS idx_site_geom_key ON grid (grid_key);"</span>))</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"site"</span>, <span class="st">"grid_key"</span>, <span class="st">"grid"</span>)</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_from_con</span>(</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>  con_dev, </span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># table_names = dbListTables(con_dev_only),</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">table_names =</span> <span class="fu">c</span>(<span class="st">"site"</span>, <span class="st">"grid"</span>),</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_keys  =</span> T) <span class="sc">|&gt;</span> </span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_set_colors</span>(<span class="at">green =</span> grid) <span class="sc">|&gt;</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_draw</span>(<span class="at">view_type =</span> <span class="st">"all"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="add-site_seg-segments-from-site" class="level3" data-number="6.4">
<h3 data-number="6.4" class="anchored" data-anchor-id="add-site_seg-segments-from-site"><span class="header-section-number">6.4</span> Add <code>site_seg</code>: segments from site</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>site_seg <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_dev, <span class="st">"site"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(cruise_uuid, orderocc, site_uuid, <span class="at">lon =</span> longitude, <span class="at">lat =</span> latitude) <span class="sc">|&gt;</span> </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tbl</span>(con_dev, <span class="st">"tow"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(site_uuid, time_start),</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"site_uuid"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(cruise_uuid, orderocc) <span class="sc">|&gt;</span> </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    cruise_uuid, orderocc, site_uuid, lon, lat) <span class="sc">|&gt;</span> </span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_beg =</span> <span class="fu">min</span>(time_start, <span class="at">na.rm =</span> T),</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_end =</span> <span class="fu">max</span>(time_start, <span class="at">na.rm =</span> T),</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span> </span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="co"># table(is.na(site_seg$time_beg))</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   FALSE   TRUE </span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co">#  57,935  3,285</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>site_seg <span class="ot">&lt;-</span> site_seg <span class="sc">|&gt;</span>   </span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(cruise_uuid, orderocc, time_beg) <span class="sc">|&gt;</span> </span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cruise_uuid) <span class="sc">|&gt;</span> </span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">site_uuid_beg =</span> <span class="fu">lag</span>(site_uuid),</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon_beg       =</span> <span class="fu">lag</span>(lon),</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat_beg       =</span> <span class="fu">lag</span>(lat),</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_beg      =</span> <span class="fu">lag</span>(time_beg)) <span class="sc">|&gt;</span> </span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(lon_beg), <span class="sc">!</span><span class="fu">is.na</span>(lat_beg)) <span class="sc">|&gt;</span> </span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">m    =</span> <span class="fu">pmap</span>(</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(lon_beg, lat_beg, lon, lat), </span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>      \(x1, y1, x2, y2){</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">matrix</span>(<span class="fu">c</span>(x1, y1, x2, y2), <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">byrow =</span> T) }),</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="fu">map</span>(m, st_linestring)) <span class="sc">|&gt;</span> </span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>    cruise_uuid,</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>    site_uuid_beg, </span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">site_uuid_end =</span> site_uuid, </span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>    lon_beg, </span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>    lat_beg,</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon_end =</span> lon, </span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat_end =</span> lat,</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>    time_beg, </span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>    time_end, </span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>    geom) <span class="sc">|&gt;</span> </span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">sf_column_name =</span> <span class="st">"geom"</span>, </span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_hr   =</span> <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(time_end, time_beg, <span class="at">units =</span> <span class="st">"hours"</span>)),</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">length_km =</span> <span class="fu">st_length</span>(geom) <span class="sc">|&gt;</span></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_units</span>(km) <span class="sc">|&gt;</span></span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.numeric</span>(),</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">km_per_hr =</span> length_km <span class="sc">/</span> time_hr)</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: check that time_end of previous segment is time_beg of next</span></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: investigate too slow, too fast</span></span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a><span class="co"># site_seg |&gt; </span></span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(</span></span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a><span class="co">#     km_per_hr_flag = ifelse(</span></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a><span class="co">#       km_per_hr &lt; 0.01,</span></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a><span class="co">#       "lt0.01",</span></span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a><span class="co">#       ifelse(</span></span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a><span class="co">#         km_per_hr &gt; 30,</span></span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a><span class="co">#         "gt30",</span></span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a><span class="co">#         NA))) |&gt; </span></span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a><span class="co">#   pull(km_per_hr_flag) |&gt; </span></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a><span class="co">#   table()</span></span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a><span class="co">#   gt30 lt0.01 </span></span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a><span class="co">#    928      9</span></span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>fld_types <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">lst =</span> <span class="fu">lapply</span>(site_seg, class)) <span class="sc">|&gt;</span> </span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">fld    =</span> <span class="fu">names</span>(lst),</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">type_r =</span> <span class="fu">map_chr</span>(lst, pluck, <span class="dv">1</span>),</span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">type   =</span> <span class="fu">map2_chr</span>(fld, type_r, \(fld, type_r){</span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(fld, <span class="st">"uuid"</span>) <span class="sc">~</span> <span class="st">"uuid"</span>,</span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a>        fld    <span class="sc">==</span> <span class="st">"geom"</span>        <span class="sc">~</span> <span class="st">"geometry"</span>,</span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a>        type_r <span class="sc">==</span> <span class="st">"POSIXct"</span>     <span class="sc">~</span> <span class="st">"timestamp"</span>,</span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a>        type_r <span class="sc">==</span> <span class="st">"character"</span>   <span class="sc">~</span> <span class="st">"varchar"</span>,</span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a>        <span class="at">.default =</span> <span class="st">"numeric"</span>) })) <span class="sc">|&gt;</span> </span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(fld, type) <span class="sc">|&gt;</span> </span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">deframe</span>()</span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(site_seg, con_dev, <span class="st">"site_seg"</span>, <span class="at">field.types =</span> fld_types)</span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">"CREATE INDEX IF NOT EXISTS idx_site_seg_geom ON grid USING gist(geom)"</span>)</span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">"ALTER TABLE site_seg ADD PRIMARY KEY (site_uuid_beg)"</span>)</span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">'CREATE EXTENSION IF NOT EXISTS "uuid-ossp"'</span>)</span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"site_seg"</span>, <span class="st">"site_uuid_beg"</span>, <span class="st">"site"</span>, <span class="st">"site_uuid"</span>)</span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"site_seg"</span>, <span class="st">"site_uuid_end"</span>, <span class="st">"site"</span>, <span class="st">"site_uuid"</span>)</span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"site_seg"</span>, <span class="st">"cruise_uuid"</span>, <span class="st">"cruise"</span>)</span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_from_con</span>(</span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a>  con_dev, </span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># table_names = dbListTables(con_dev_only),</span></span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a>  <span class="at">table_names =</span> <span class="fu">c</span>(<span class="st">"site_seg"</span>, <span class="st">"site"</span>, <span class="st">"cruise"</span>),</span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_keys  =</span> T) <span class="sc">|&gt;</span> </span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_set_colors</span>(<span class="at">green =</span> site_seg) <span class="sc">|&gt;</span></span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_draw</span>(<span class="at">view_type =</span> <span class="st">"all"</span>)</span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a>site_seg <span class="ot">&lt;-</span> <span class="fu">st_read</span>(con_dev, <span class="st">"site_seg"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">year</span>(time_beg))</span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a><span class="fu">mapView</span>(site_seg, <span class="at">zcol =</span> <span class="st">"year"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="report" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="report"><span class="header-section-number">7</span> Report</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_from_con</span>(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  con_dev, </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">table_names =</span> <span class="fu">dbListTables</span>(con_dev_only),</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># table_names = c("site_seg", "site", "cruise"),</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_keys  =</span> T) <span class="sc">|&gt;</span> </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_set_colors</span>(<span class="at">lightgreen =</span> <span class="fu">c</span>(site_seg, grid)) <span class="sc">|&gt;</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_draw</span>(<span class="at">view_type =</span> <span class="st">"all"</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>d_eff <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_dev, <span class="st">"site_seg"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">year</span>(time_beg)) <span class="sc">|&gt;</span> </span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">|&gt;</span> </span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_hr   =</span> <span class="fu">sum</span>(time_hr, <span class="at">na.rm =</span> T),</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">length_km =</span> <span class="fu">sum</span>(length_km, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span> </span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(d_eff<span class="sc">$</span>time_hr, <span class="at">na.rm =</span> T)    <span class="co"># 302,516 hours; 12,604 days; 34.5 years</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(d_eff<span class="sc">$</span>length_km, <span class="at">na.rm =</span> T)  <span class="co"># 3,672,794 km</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="cleanup" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="cleanup"><span class="header-section-number">8</span> Cleanup</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Close database connection</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="todo" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="todo"><span class="header-section-number">9</span> TODO</h2>
<ul class="task-list">
<li><label><input type="checkbox">Add <strong>indexes</strong>.</label></li>
<li><label><input type="checkbox">Add <strong>relationships</strong> between primary keys.</label></li>
<li><label><input type="checkbox">Add <strong>points</strong> between <code>sites</code></label></li>
<li><label><input type="checkbox">Add <strong>segments</strong> between <code>sites</code>.</label></li>
<li><label><input type="checkbox">Check all <code>type_new</code> are valid for db connection.</label></li>
<li><label><input type="checkbox">Check that all <code>flds_in</code> are in <code>flds_rn</code>.</label></li>
<li><label><input type="checkbox">Insert table and field SQL <code>COMMENT</code>s into database, using <code>comment</code> field + <code>workflow_md</code> (markdown with name and link) + source with tbl.fld</label></li>
<li><label><input type="checkbox">Review documentation for more comment descriptions at <a href="https://calcofi.com/index.php?option=com_content&amp;view=category&amp;id=73&amp;Itemid=993">Data &gt; Data Formats | CalCOFI.org</a></label></li>
</ul>
<!-- -->

</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb31" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Ingest NOAA CalCOFI Database"</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true  </span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> </span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co">  markdown: </span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co">    wrap: 72</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview {.unnumbered}</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>**Goal**: Generate the database from source files with workflow scripts</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>to make updating easier and provenance fully transparent. This allows us</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>to:</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Rename tables and column names, control data types and use Unicode</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>    encoding for a consistent database ingestion strategy, per Database</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    naming conventions in [Database – CalCOFI.io</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    Docs](https://calcofi.io/docs/db.html).</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Differentiate between raw and derived or updated tables and columns.</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>    For instance, the taxonomy for any given species can change over</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>    time, such as lumping or splitting of a given taxa, and by taxonomic</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>    authority (e.g., WoRMS, ITIS or GBIF). These taxonomic identifiers</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    and the full taxonomic hierarchy should get regularly updated</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>    regardless of source observational data, and can either be updated</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    in the table directly or joined one-to-one with a seperate table in</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>    a materialized view (so as not to slow down queries with a regular</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>    view).</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>This workflow processes NOAA CalCOFI database CSV files and updates the</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>PostgreSQL database. The workflow:</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Reads CSV files from source directory</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Compares with lookup tables for field descriptions</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Initializes or updates database tables</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>Generates summary statistics</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>%%| label: overview</span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>%%| fig-cap: <span class="ot">"</span><span class="st">Overview diagram of CSV ingestion process into the database.</span><span class="ot">"</span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>%%| file: diagrams/ingest_noaa-calcofi-db_overview.mmd</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>See also <span class="co">[</span><span class="ot">5.3 Ingest datasets with documentation – Database – CalCOFI.io Docs</span><span class="co">](https://calcofi.io/docs/db.html#ingest-datasets-with-documentation)</span> for generic overview of ingestion process.</span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_local(here::here("../calcofi4db"), force = T)</span></span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::load_all(here::here("../calcofi4db"))</span></span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a><span class="co"># options(error=NULL)</span></span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a>  calcofi4db, DBI, dm, dplyr, DT, fs, glue, gargle, googledrive, here, janitor,</span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>  jsonlite, knitr, lubridate, purrr, readr, rlang, tibble, tidyr, uuid,</span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">quiet =</span> T)</span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">readr.show_col_types =</span> F)</span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a><span class="co"># get database connection</span></span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a>con     <span class="ot">&lt;-</span> <span class="fu">get_db_con</span>(<span class="fu">c</span>(<span class="st">"dev"</span>, <span class="st">"dev_ref"</span>))</span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a>con_dev <span class="ot">&lt;-</span> <span class="fu">get_db_con</span>(<span class="fu">c</span>(<span class="st">"dev"</span>))</span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a><span class="co"># define paths ---</span></span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a>dataset  <span class="ot">&lt;-</span> <span class="st">"calcofi-db"</span></span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a>provider <span class="ot">&lt;-</span> <span class="st">"swfsc.noaa.gov"</span></span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a><span class="co"># data directory with CSV files</span></span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a><span class="co"># dir_data &lt;- "/Users/bbest/My Drive/projects/calcofi/data"</span></span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a><span class="co"># same data folder as Google Drive URL</span></span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a><span class="co"># gdir_data &lt;- "https://drive.google.com/drive/u/0/folders/13A9yDJCdV0M-lrMLqurzIb3G3ozknr9O"</span></span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data using calcofi4db package</span></span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">read_csv_files</span>(provider, dataset)</span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract variables from data_info for backward compatibility</span></span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a><span class="co"># workflow_info &lt;- data_info$workflow_info</span></span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a><span class="co"># workflow      &lt;- workflow_info$workflow</span></span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a><span class="co"># workflow_qmd  &lt;- workflow_info$workflow_qmd</span></span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a><span class="co"># workflow_url  &lt;- workflow_info$workflow_url</span></span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a><span class="co"># dir_csv &lt;- data_info$paths$dir_csv</span></span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a><span class="co"># dir_ingest &lt;- dirname(data_info$paths$dir_ingest)</span></span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a><span class="co"># tbls_in_csv &lt;- data_info$paths$tbls_in_csv</span></span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a><span class="co"># flds_in_csv &lt;- data_info$paths$flds_in_csv</span></span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a><span class="co"># tbls_rn_csv &lt;- data_info$paths$tbls_rn_csv</span></span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a><span class="co"># flds_rn_csv &lt;- data_info$paths$flds_rn_csv</span></span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a><span class="co"># d_gdir_data &lt;- data_info$d_gdir_data</span></span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a><span class="co"># d_tbls_rn &lt;- data_info$d_tbls_rn</span></span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a><span class="co"># d_flds_rn &lt;- data_info$d_flds_rn</span></span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a><span class="co"># d &lt;- data_info$csv_metadata$data</span></span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a><span class="fu">### Check for any mismatched tables and fields</span></span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check_mismatched_tables_fields</span></span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-111"><a href="#cb31-111" aria-hidden="true" tabindex="-1"></a><span class="co"># detect changes between csv files and redefinitions</span></span>
<span id="cb31-112"><a href="#cb31-112" aria-hidden="true" tabindex="-1"></a>changes <span class="ot">&lt;-</span> <span class="fu">detect_csv_changes</span>(d)</span>
<span id="cb31-113"><a href="#cb31-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-114"><a href="#cb31-114" aria-hidden="true" tabindex="-1"></a><span class="co"># print summary statistics</span></span>
<span id="cb31-115"><a href="#cb31-115" aria-hidden="true" tabindex="-1"></a><span class="fu">print_csv_change_stats</span>(changes, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-116"><a href="#cb31-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-117"><a href="#cb31-117" aria-hidden="true" tabindex="-1"></a><span class="co"># display interactive table of changes</span></span>
<span id="cb31-118"><a href="#cb31-118" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(changes<span class="sc">$</span>summary) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb31-119"><a href="#cb31-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">display_csv_changes</span>(changes, <span class="at">format =</span> <span class="st">"DT"</span>, <span class="at">title =</span> <span class="st">"CSV vs Redefinition Mismatches"</span>)</span>
<span id="cb31-120"><a href="#cb31-120" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-121"><a href="#cb31-121" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-122"><a href="#cb31-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-125"><a href="#cb31-125" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-126"><a href="#cb31-126" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: data_integrity_checkpoint</span></span>
<span id="cb31-127"><a href="#cb31-127" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: asis</span></span>
<span id="cb31-128"><a href="#cb31-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-129"><a href="#cb31-129" aria-hidden="true" tabindex="-1"></a><span class="co"># check if there are any mismatches that need to be resolved</span></span>
<span id="cb31-130"><a href="#cb31-130" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(changes<span class="sc">$</span>summary) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb31-131"><a href="#cb31-131" aria-hidden="true" tabindex="-1"></a>  <span class="co"># disable evaluation of remaining chunks</span></span>
<span id="cb31-132"><a href="#cb31-132" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">eval =</span> <span class="cn">FALSE</span>)</span>
<span id="cb31-133"><a href="#cb31-133" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-134"><a href="#cb31-134" aria-hidden="true" tabindex="-1"></a>  <span class="co"># output markdown warning</span></span>
<span id="cb31-135"><a href="#cb31-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb31-136"><a href="#cb31-136" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-137"><a href="#cb31-137" aria-hidden="true" tabindex="-1"></a><span class="st">    ## ⚠️ Data Integrity Check Failed</span></span>
<span id="cb31-138"><a href="#cb31-138" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-139"><a href="#cb31-139" aria-hidden="true" tabindex="-1"></a><span class="st">    ### Workflow Halted</span></span>
<span id="cb31-140"><a href="#cb31-140" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-141"><a href="#cb31-141" aria-hidden="true" tabindex="-1"></a><span class="st">    Mismatches have been detected between the CSV files and redefinition metadata. </span></span>
<span id="cb31-142"><a href="#cb31-142" aria-hidden="true" tabindex="-1"></a><span class="st">    These must be resolved before proceeding with database ingestion to ensure data integrity.</span></span>
<span id="cb31-143"><a href="#cb31-143" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-144"><a href="#cb31-144" aria-hidden="true" tabindex="-1"></a><span class="st">    ### Required Actions</span></span>
<span id="cb31-145"><a href="#cb31-145" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-146"><a href="#cb31-146" aria-hidden="true" tabindex="-1"></a><span class="st">    Please review the changes detected above and update the following redefinition files:</span></span>
<span id="cb31-147"><a href="#cb31-147" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-148"><a href="#cb31-148" aria-hidden="true" tabindex="-1"></a><span class="st">    - **Tables redefinition**: `{d$paths$tbls_rd_csv}`</span></span>
<span id="cb31-149"><a href="#cb31-149" aria-hidden="true" tabindex="-1"></a><span class="st">    - **Fields redefinition**: `{d$paths$flds_rd_csv}`</span></span>
<span id="cb31-150"><a href="#cb31-150" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-151"><a href="#cb31-151" aria-hidden="true" tabindex="-1"></a><span class="st">    ### Common Resolutions</span></span>
<span id="cb31-152"><a href="#cb31-152" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-153"><a href="#cb31-153" aria-hidden="true" tabindex="-1"></a><span class="st">    1. **New tables/fields in CSV**: Add them to the appropriate redefinition file</span></span>
<span id="cb31-154"><a href="#cb31-154" aria-hidden="true" tabindex="-1"></a><span class="st">    2. **Removed tables/fields from CSV**: Remove obsolete entries from redefinition files</span></span>
<span id="cb31-155"><a href="#cb31-155" aria-hidden="true" tabindex="-1"></a><span class="st">    3. **Type mismatches**: Update field types in redefinition files to match CSV data types</span></span>
<span id="cb31-156"><a href="#cb31-156" aria-hidden="true" tabindex="-1"></a><span class="st">    4. **Field name changes**: Update `fld_old` entries to match current CSV field names</span></span>
<span id="cb31-157"><a href="#cb31-157" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-158"><a href="#cb31-158" aria-hidden="true" tabindex="-1"></a><span class="st">    ### Next Steps</span></span>
<span id="cb31-159"><a href="#cb31-159" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-160"><a href="#cb31-160" aria-hidden="true" tabindex="-1"></a><span class="st">    After updating the redefinition files, re-run this workflow. The remaining code chunks </span></span>
<span id="cb31-161"><a href="#cb31-161" aria-hidden="true" tabindex="-1"></a><span class="st">    have been disabled and will not execute until all mismatches are resolved.</span></span>
<span id="cb31-162"><a href="#cb31-162" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-163"><a href="#cb31-163" aria-hidden="true" tabindex="-1"></a><span class="st">    ---</span></span>
<span id="cb31-164"><a href="#cb31-164" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-165"><a href="#cb31-165" aria-hidden="true" tabindex="-1"></a><span class="st">    *Note: The remainder of this document contains code that will not be executed due to </span></span>
<span id="cb31-166"><a href="#cb31-166" aria-hidden="true" tabindex="-1"></a><span class="st">    data integrity issues.*</span></span>
<span id="cb31-167"><a href="#cb31-167" aria-hidden="true" tabindex="-1"></a><span class="st">    "</span>))</span>
<span id="cb31-168"><a href="#cb31-168" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb31-169"><a href="#cb31-169" aria-hidden="true" tabindex="-1"></a>  <span class="co"># no mismatches found - enable evaluation and show success message</span></span>
<span id="cb31-170"><a href="#cb31-170" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">eval =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-171"><a href="#cb31-171" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-172"><a href="#cb31-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb31-173"><a href="#cb31-173" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-174"><a href="#cb31-174" aria-hidden="true" tabindex="-1"></a><span class="st">    ## ✅ Data Integrity Check Passed</span></span>
<span id="cb31-175"><a href="#cb31-175" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-176"><a href="#cb31-176" aria-hidden="true" tabindex="-1"></a><span class="st">    ### All Systems Go</span></span>
<span id="cb31-177"><a href="#cb31-177" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-178"><a href="#cb31-178" aria-hidden="true" tabindex="-1"></a><span class="st">    No mismatches were found between the CSV files and redefinition metadata. </span></span>
<span id="cb31-179"><a href="#cb31-179" aria-hidden="true" tabindex="-1"></a><span class="st">    The data structures are properly aligned and ready for database ingestion.</span></span>
<span id="cb31-180"><a href="#cb31-180" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-181"><a href="#cb31-181" aria-hidden="true" tabindex="-1"></a><span class="st">    ### Proceeding with Workflow</span></span>
<span id="cb31-182"><a href="#cb31-182" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-183"><a href="#cb31-183" aria-hidden="true" tabindex="-1"></a><span class="st">    The workflow will now continue with the following steps:</span></span>
<span id="cb31-184"><a href="#cb31-184" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-185"><a href="#cb31-185" aria-hidden="true" tabindex="-1"></a><span class="st">    1. Display CSV file metadata from Google Drive</span></span>
<span id="cb31-186"><a href="#cb31-186" aria-hidden="true" tabindex="-1"></a><span class="st">    2. Show tables and fields to be ingested</span></span>
<span id="cb31-187"><a href="#cb31-187" aria-hidden="true" tabindex="-1"></a><span class="st">    3. Apply data transformations based on redefinitions</span></span>
<span id="cb31-188"><a href="#cb31-188" aria-hidden="true" tabindex="-1"></a><span class="st">    4. Load transformed data into the database</span></span>
<span id="cb31-189"><a href="#cb31-189" aria-hidden="true" tabindex="-1"></a><span class="st">    5. Create indexes and relationships</span></span>
<span id="cb31-190"><a href="#cb31-190" aria-hidden="true" tabindex="-1"></a><span class="st">    6. Add spatial data and generate reports</span></span>
<span id="cb31-191"><a href="#cb31-191" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-192"><a href="#cb31-192" aria-hidden="true" tabindex="-1"></a><span class="st">    ---</span></span>
<span id="cb31-193"><a href="#cb31-193" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb31-194"><a href="#cb31-194" aria-hidden="true" tabindex="-1"></a><span class="st">    "</span>))</span>
<span id="cb31-195"><a href="#cb31-195" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-196"><a href="#cb31-196" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-197"><a href="#cb31-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-198"><a href="#cb31-198" aria-hidden="true" tabindex="-1"></a><span class="fu">### Show CSV Files on Google Drive</span></span>
<span id="cb31-199"><a href="#cb31-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-202"><a href="#cb31-202" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-203"><a href="#cb31-203" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: google-drive_csv-list</span></span>
<span id="cb31-204"><a href="#cb31-204" aria-hidden="true" tabindex="-1"></a><span class="fu">show_googledrive_files</span>(d)</span>
<span id="cb31-205"><a href="#cb31-205" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-206"><a href="#cb31-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-207"><a href="#cb31-207" aria-hidden="true" tabindex="-1"></a><span class="fu">### Show CSV Tables and Fields to Ingest</span></span>
<span id="cb31-208"><a href="#cb31-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-211"><a href="#cb31-211" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-212"><a href="#cb31-212" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbls_in</span></span>
<span id="cb31-213"><a href="#cb31-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-214"><a href="#cb31-214" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>d_csv<span class="sc">$</span>tables <span class="sc">|&gt;</span> </span>
<span id="cb31-215"><a href="#cb31-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Tables to ingest."</span>)</span>
<span id="cb31-216"><a href="#cb31-216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-217"><a href="#cb31-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-220"><a href="#cb31-220" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-221"><a href="#cb31-221" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: flds_in</span></span>
<span id="cb31-222"><a href="#cb31-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-223"><a href="#cb31-223" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>d_csv<span class="sc">$</span>fields <span class="sc">|&gt;</span> </span>
<span id="cb31-224"><a href="#cb31-224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Fields to ingest."</span>)</span>
<span id="cb31-225"><a href="#cb31-225" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-226"><a href="#cb31-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-227"><a href="#cb31-227" aria-hidden="true" tabindex="-1"></a><span class="fu">## Show tables and fields redefined</span></span>
<span id="cb31-228"><a href="#cb31-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-231"><a href="#cb31-231" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-232"><a href="#cb31-232" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbls_rd</span></span>
<span id="cb31-233"><a href="#cb31-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-234"><a href="#cb31-234" aria-hidden="true" tabindex="-1"></a><span class="fu">show_tables_redefine</span>(d)</span>
<span id="cb31-235"><a href="#cb31-235" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-236"><a href="#cb31-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-239"><a href="#cb31-239" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-240"><a href="#cb31-240" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: flds_rd</span></span>
<span id="cb31-241"><a href="#cb31-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-242"><a href="#cb31-242" aria-hidden="true" tabindex="-1"></a><span class="fu">show_fields_redefine</span>(d)</span>
<span id="cb31-243"><a href="#cb31-243" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-244"><a href="#cb31-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-245"><a href="#cb31-245" aria-hidden="true" tabindex="-1"></a><span class="fu">## Apply remappings to data</span></span>
<span id="cb31-246"><a href="#cb31-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-249"><a href="#cb31-249" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-250"><a href="#cb31-250" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: make_data_new</span></span>
<span id="cb31-251"><a href="#cb31-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-252"><a href="#cb31-252" aria-hidden="true" tabindex="-1"></a><span class="co"># Use calcofi4db to transform data</span></span>
<span id="cb31-253"><a href="#cb31-253" aria-hidden="true" tabindex="-1"></a>transformed_data <span class="ot">&lt;-</span> <span class="fu">transform_data</span>(d)</span>
<span id="cb31-254"><a href="#cb31-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-255"><a href="#cb31-255" aria-hidden="true" tabindex="-1"></a><span class="co"># For backward compatibility</span></span>
<span id="cb31-256"><a href="#cb31-256" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> transformed_data</span>
<span id="cb31-257"><a href="#cb31-257" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-258"><a href="#cb31-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-259"><a href="#cb31-259" aria-hidden="true" tabindex="-1"></a><span class="fu">## Load Tables into Database</span></span>
<span id="cb31-260"><a href="#cb31-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-263"><a href="#cb31-263" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-264"><a href="#cb31-264" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load_tbls_to_db</span></span>
<span id="cb31-265"><a href="#cb31-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-266"><a href="#cb31-266" aria-hidden="true" tabindex="-1"></a>schema    <span class="ot">&lt;-</span> <span class="st">"dev"</span></span>
<span id="cb31-267"><a href="#cb31-267" aria-hidden="true" tabindex="-1"></a>overwrite <span class="ot">&lt;-</span> T</span>
<span id="cb31-268"><a href="#cb31-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-269"><a href="#cb31-269" aria-hidden="true" tabindex="-1"></a><span class="co"># Use calcofi4db to ingest tables and generate metadata</span></span>
<span id="cb31-270"><a href="#cb31-270" aria-hidden="true" tabindex="-1"></a><span class="co"># First, check for changes (this is now done above)</span></span>
<span id="cb31-271"><a href="#cb31-271" aria-hidden="true" tabindex="-1"></a><span class="co"># changes &lt;- detect_csv_changes(</span></span>
<span id="cb31-272"><a href="#cb31-272" aria-hidden="true" tabindex="-1"></a><span class="co">#   con = con,</span></span>
<span id="cb31-273"><a href="#cb31-273" aria-hidden="true" tabindex="-1"></a><span class="co">#   schema = schema,</span></span>
<span id="cb31-274"><a href="#cb31-274" aria-hidden="true" tabindex="-1"></a><span class="co">#   transformed_data = transformed_data,</span></span>
<span id="cb31-275"><a href="#cb31-275" aria-hidden="true" tabindex="-1"></a><span class="co">#   d_flds_rd = d$d_flds_rd</span></span>
<span id="cb31-276"><a href="#cb31-276" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb31-277"><a href="#cb31-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-278"><a href="#cb31-278" aria-hidden="true" tabindex="-1"></a><span class="co"># Display changes</span></span>
<span id="cb31-279"><a href="#cb31-279" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(changes<span class="sc">$</span>new_tables) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb31-280"><a href="#cb31-280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"New tables to be added:"</span>)</span>
<span id="cb31-281"><a href="#cb31-281" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">paste</span>(<span class="st">" -"</span>, changes<span class="sc">$</span>new_tables, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb31-282"><a href="#cb31-282" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-283"><a href="#cb31-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-284"><a href="#cb31-284" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(changes<span class="sc">$</span>field_changes) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb31-285"><a href="#cb31-285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Tables with field changes:"</span>)</span>
<span id="cb31-286"><a href="#cb31-286" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (tbl <span class="cf">in</span> <span class="fu">names</span>(changes<span class="sc">$</span>field_changes)) {</span>
<span id="cb31-287"><a href="#cb31-287" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">" - {tbl}:"</span>))</span>
<span id="cb31-288"><a href="#cb31-288" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(changes<span class="sc">$</span>field_changes[[tbl]]<span class="sc">$</span>added) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb31-289"><a href="#cb31-289" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"   Added: {paste(changes$field_changes[[tbl]]$added, collapse = ', ')}"</span>))</span>
<span id="cb31-290"><a href="#cb31-290" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-291"><a href="#cb31-291" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(changes<span class="sc">$</span>field_changes[[tbl]]<span class="sc">$</span>removed) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb31-292"><a href="#cb31-292" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"   Removed: {paste(changes$field_changes[[tbl]]$removed, collapse = ', ')}"</span>))</span>
<span id="cb31-293"><a href="#cb31-293" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-294"><a href="#cb31-294" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-295"><a href="#cb31-295" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-296"><a href="#cb31-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-297"><a href="#cb31-297" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(changes<span class="sc">$</span>type_changes) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb31-298"><a href="#cb31-298" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Tables with type changes:"</span>)</span>
<span id="cb31-299"><a href="#cb31-299" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (tbl <span class="cf">in</span> <span class="fu">names</span>(changes<span class="sc">$</span>type_changes)) {</span>
<span id="cb31-300"><a href="#cb31-300" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">" - {tbl}:"</span>))</span>
<span id="cb31-301"><a href="#cb31-301" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (fld <span class="cf">in</span> <span class="fu">names</span>(changes<span class="sc">$</span>type_changes[[tbl]])) {</span>
<span id="cb31-302"><a href="#cb31-302" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"   {fld}: {changes$type_changes[[tbl]][[fld]]$from} -&gt; {changes$type_changes[[tbl]][[fld]]$to}"</span>))</span>
<span id="cb31-303"><a href="#cb31-303" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-304"><a href="#cb31-304" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-305"><a href="#cb31-305" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-306"><a href="#cb31-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-307"><a href="#cb31-307" aria-hidden="true" tabindex="-1"></a><span class="co"># Ingest data to database</span></span>
<span id="cb31-308"><a href="#cb31-308" aria-hidden="true" tabindex="-1"></a>tbl_stats <span class="ot">&lt;-</span> <span class="fu">ingest_csv_to_db</span>(</span>
<span id="cb31-309"><a href="#cb31-309" aria-hidden="true" tabindex="-1"></a>  <span class="at">con =</span> con,</span>
<span id="cb31-310"><a href="#cb31-310" aria-hidden="true" tabindex="-1"></a>  <span class="at">schema =</span> schema,</span>
<span id="cb31-311"><a href="#cb31-311" aria-hidden="true" tabindex="-1"></a>  <span class="at">transformed_data =</span> transformed_data,</span>
<span id="cb31-312"><a href="#cb31-312" aria-hidden="true" tabindex="-1"></a>  <span class="at">d_flds_rd =</span> d<span class="sc">$</span>d_flds_rd,</span>
<span id="cb31-313"><a href="#cb31-313" aria-hidden="true" tabindex="-1"></a>  <span class="at">d_gdir_data =</span> d<span class="sc">$</span>d_gdata,</span>
<span id="cb31-314"><a href="#cb31-314" aria-hidden="true" tabindex="-1"></a>  <span class="at">workflow_info =</span> d<span class="sc">$</span>workflow_info,</span>
<span id="cb31-315"><a href="#cb31-315" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> overwrite</span>
<span id="cb31-316"><a href="#cb31-316" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-317"><a href="#cb31-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-318"><a href="#cb31-318" aria-hidden="true" tabindex="-1"></a><span class="co"># Display summary statistics</span></span>
<span id="cb31-319"><a href="#cb31-319" aria-hidden="true" tabindex="-1"></a>tbl_stats <span class="sc">|&gt;</span> </span>
<span id="cb31-320"><a href="#cb31-320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">rownames =</span> <span class="cn">FALSE</span>, <span class="at">filter =</span> <span class="st">"top"</span>)</span>
<span id="cb31-321"><a href="#cb31-321" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-322"><a href="#cb31-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-323"><a href="#cb31-323" aria-hidden="true" tabindex="-1"></a>TODO:</span>
<span id="cb31-324"><a href="#cb31-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-325"><a href="#cb31-325" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> add COMMENTS to table with JSON of dtime ingested, source, and</span>
<span id="cb31-326"><a href="#cb31-326" aria-hidden="true" tabindex="-1"></a>    workflow</span>
<span id="cb31-327"><a href="#cb31-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-328"><a href="#cb31-328" aria-hidden="true" tabindex="-1"></a><span class="fu">## Create Indexes, Relationships</span></span>
<span id="cb31-329"><a href="#cb31-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-332"><a href="#cb31-332" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-333"><a href="#cb31-333" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: dm_tbls</span></span>
<span id="cb31-334"><a href="#cb31-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-335"><a href="#cb31-335" aria-hidden="true" tabindex="-1"></a><span class="co"># source(here("../apps_dev/libs/db.R"))</span></span>
<span id="cb31-336"><a href="#cb31-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-337"><a href="#cb31-337" aria-hidden="true" tabindex="-1"></a>tbls_dev <span class="ot">&lt;-</span> <span class="fu">dbListTables</span>(con_dev) <span class="sc">|&gt;</span> <span class="fu">sort</span>()</span>
<span id="cb31-338"><a href="#cb31-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-339"><a href="#cb31-339" aria-hidden="true" tabindex="-1"></a>dm_dev <span class="ot">&lt;-</span> <span class="fu">dm_from_con</span>(</span>
<span id="cb31-340"><a href="#cb31-340" aria-hidden="true" tabindex="-1"></a>  con_dev, </span>
<span id="cb31-341"><a href="#cb31-341" aria-hidden="true" tabindex="-1"></a>  <span class="at">table_names =</span> tbls_dev,</span>
<span id="cb31-342"><a href="#cb31-342" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_keys  =</span> T)</span>
<span id="cb31-343"><a href="#cb31-343" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_draw</span>(dm_dev, <span class="at">view_type =</span> <span class="st">"all"</span>)</span>
<span id="cb31-344"><a href="#cb31-344" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-345"><a href="#cb31-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-346"><a href="#cb31-346" aria-hidden="true" tabindex="-1"></a><span class="fu">### Show existing unique keys across tables</span></span>
<span id="cb31-347"><a href="#cb31-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-350"><a href="#cb31-350" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-351"><a href="#cb31-351" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: show_keys</span></span>
<span id="cb31-352"><a href="#cb31-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-353"><a href="#cb31-353" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_get_all_uks</span>(dm_dev)</span>
<span id="cb31-354"><a href="#cb31-354" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-355"><a href="#cb31-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-356"><a href="#cb31-356" aria-hidden="true" tabindex="-1"></a><span class="fu">### Add candidate keys, automatically</span></span>
<span id="cb31-357"><a href="#cb31-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-360"><a href="#cb31-360" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-361"><a href="#cb31-361" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mk_keys_auto</span></span>
<span id="cb31-362"><a href="#cb31-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-363"><a href="#cb31-363" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get primary key constraints for a table</span></span>
<span id="cb31-364"><a href="#cb31-364" aria-hidden="true" tabindex="-1"></a>tbl_pkeys <span class="ot">&lt;-</span> <span class="cf">function</span>(con, tbl) {</span>
<span id="cb31-365"><a href="#cb31-365" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbGetQuery</span>(con, <span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb31-366"><a href="#cb31-366" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT a.attname as column_name</span></span>
<span id="cb31-367"><a href="#cb31-367" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM pg_index i</span></span>
<span id="cb31-368"><a href="#cb31-368" aria-hidden="true" tabindex="-1"></a><span class="st">    JOIN pg_attribute a ON a.attrelid = i.indrelid</span></span>
<span id="cb31-369"><a href="#cb31-369" aria-hidden="true" tabindex="-1"></a><span class="st">    AND a.attnum = ANY(i.indkey)</span></span>
<span id="cb31-370"><a href="#cb31-370" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE i.indrelid = '{tbl}'::regclass</span></span>
<span id="cb31-371"><a href="#cb31-371" aria-hidden="true" tabindex="-1"></a><span class="st">    AND i.indisprimary;</span></span>
<span id="cb31-372"><a href="#cb31-372" aria-hidden="true" tabindex="-1"></a><span class="st">  "</span>))<span class="sc">$</span>column_name</span>
<span id="cb31-373"><a href="#cb31-373" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-374"><a href="#cb31-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-375"><a href="#cb31-375" aria-hidden="true" tabindex="-1"></a>d_pk <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb31-376"><a href="#cb31-376" aria-hidden="true" tabindex="-1"></a>  <span class="at">tbl =</span> tbls_dev) <span class="sc">|&gt;</span> </span>
<span id="cb31-377"><a href="#cb31-377" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-378"><a href="#cb31-378" aria-hidden="true" tabindex="-1"></a>    <span class="at">d        =</span> <span class="fu">map</span>(tbl, \(x) <span class="fu">eval</span>(<span class="fu">bquote</span>(<span class="fu">dm_enum_pk_candidates</span>(dm_dev, .(x)))) ),</span>
<span id="cb31-379"><a href="#cb31-379" aria-hidden="true" tabindex="-1"></a>    <span class="at">n        =</span> <span class="fu">map_int</span>(d, \(x) x <span class="sc">|&gt;</span> <span class="fu">filter</span>(candidate <span class="sc">==</span> T) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()),</span>
<span id="cb31-380"><a href="#cb31-380" aria-hidden="true" tabindex="-1"></a>    <span class="at">flds     =</span> <span class="fu">map_chr</span>(d, \(x){</span>
<span id="cb31-381"><a href="#cb31-381" aria-hidden="true" tabindex="-1"></a>      x <span class="sc">|&gt;</span> <span class="fu">filter</span>(candidate <span class="sc">==</span> T) <span class="sc">|&gt;</span> <span class="fu">pull</span>(columns) <span class="sc">|&gt;</span> </span>
<span id="cb31-382"><a href="#cb31-382" aria-hidden="true" tabindex="-1"></a>        <span class="fu">unlist</span>() <span class="sc">|&gt;</span> <span class="fu">paste</span>(<span class="at">collapse =</span> <span class="st">"; "</span>) }),</span>
<span id="cb31-383"><a href="#cb31-383" aria-hidden="true" tabindex="-1"></a>    <span class="at">fld      =</span> <span class="fu">map_chr</span>(d, \(x){</span>
<span id="cb31-384"><a href="#cb31-384" aria-hidden="true" tabindex="-1"></a>      y <span class="ot">&lt;-</span> x <span class="sc">|&gt;</span> <span class="fu">filter</span>(candidate <span class="sc">==</span> T) <span class="sc">|&gt;</span> <span class="fu">pull</span>(columns) <span class="sc">|&gt;</span> </span>
<span id="cb31-385"><a href="#cb31-385" aria-hidden="true" tabindex="-1"></a>        <span class="fu">unlist</span>()</span>
<span id="cb31-386"><a href="#cb31-386" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(y) <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb31-387"><a href="#cb31-387" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb31-388"><a href="#cb31-388" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(y) <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb31-389"><a href="#cb31-389" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(y[<span class="dv">1</span>])</span>
<span id="cb31-390"><a href="#cb31-390" aria-hidden="true" tabindex="-1"></a>      y }),</span>
<span id="cb31-391"><a href="#cb31-391" aria-hidden="true" tabindex="-1"></a>    <span class="at">add_pkey =</span> <span class="fu">map2_lgl</span>(tbl, fld, \(tbl, fld){</span>
<span id="cb31-392"><a href="#cb31-392" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.na</span>(fld))</span>
<span id="cb31-393"><a href="#cb31-393" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(F)</span>
<span id="cb31-394"><a href="#cb31-394" aria-hidden="true" tabindex="-1"></a>      <span class="co"># tbl &lt;- "cruise"; fld = "cruise_uuid"</span></span>
<span id="cb31-395"><a href="#cb31-395" aria-hidden="true" tabindex="-1"></a>      pkey_exists <span class="ot">&lt;-</span> <span class="fu">tbl_pkeys</span>(con_dev, <span class="st">"cruise"</span>) <span class="sc">|&gt;</span> <span class="fu">length</span>() <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb31-396"><a href="#cb31-396" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (pkey_exists)</span>
<span id="cb31-397"><a href="#cb31-397" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(F)</span>
<span id="cb31-398"><a href="#cb31-398" aria-hidden="true" tabindex="-1"></a>      <span class="fu">dbExecute</span>(con_dev, <span class="fu">glue</span>(<span class="st">"ALTER TABLE {tbl} ADD PRIMARY KEY ({fld})"</span>))</span>
<span id="cb31-399"><a href="#cb31-399" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(T) }) ) <span class="sc">|&gt;</span> </span>
<span id="cb31-400"><a href="#cb31-400" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>d)</span>
<span id="cb31-401"><a href="#cb31-401" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-402"><a href="#cb31-402" aria-hidden="true" tabindex="-1"></a>d_pk <span class="sc">|&gt;</span> </span>
<span id="cb31-403"><a href="#cb31-403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>()</span>
<span id="cb31-404"><a href="#cb31-404" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-405"><a href="#cb31-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-406"><a href="#cb31-406" aria-hidden="true" tabindex="-1"></a><span class="fu">### Add primary keys, manually</span></span>
<span id="cb31-407"><a href="#cb31-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-408"><a href="#cb31-408" aria-hidden="true" tabindex="-1"></a>Noticing egg and larva missing pkey.</span>
<span id="cb31-409"><a href="#cb31-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-412"><a href="#cb31-412" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-413"><a href="#cb31-413" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mk_keys_manual</span></span>
<span id="cb31-414"><a href="#cb31-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-415"><a href="#cb31-415" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">"ALTER TABLE egg ADD PRIMARY KEY (net_uuid, sp_id)"</span>)</span>
<span id="cb31-416"><a href="#cb31-416" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">"ALTER TABLE larva ADD PRIMARY KEY (net_uuid, sp_id)"</span>)</span>
<span id="cb31-417"><a href="#cb31-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-418"><a href="#cb31-418" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb31-419"><a href="#cb31-419" aria-hidden="true" tabindex="-1"></a>  <span class="at">tbl =</span> tbls_dev) <span class="sc">|&gt;</span> </span>
<span id="cb31-420"><a href="#cb31-420" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-421"><a href="#cb31-421" aria-hidden="true" tabindex="-1"></a>    <span class="at">pkeys =</span> <span class="fu">map_chr</span>(tbl, \(x) <span class="fu">tbl_pkeys</span>(x, <span class="at">con =</span> con_dev) <span class="sc">|&gt;</span> <span class="fu">paste</span>(<span class="at">collapse =</span> <span class="st">", "</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb31-422"><a href="#cb31-422" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>()</span>
<span id="cb31-423"><a href="#cb31-423" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-424"><a href="#cb31-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-425"><a href="#cb31-425" aria-hidden="true" tabindex="-1"></a><span class="fu">### Add other indexes</span></span>
<span id="cb31-426"><a href="#cb31-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-427"><a href="#cb31-427" aria-hidden="true" tabindex="-1"></a>That are not already the first field of a primary key.</span>
<span id="cb31-428"><a href="#cb31-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-431"><a href="#cb31-431" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-432"><a href="#cb31-432" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mk_idx</span></span>
<span id="cb31-433"><a href="#cb31-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-434"><a href="#cb31-434" aria-hidden="true" tabindex="-1"></a>d_idx <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb31-435"><a href="#cb31-435" aria-hidden="true" tabindex="-1"></a>  <span class="at">tbl =</span> tbls_dev) <span class="sc">|&gt;</span></span>
<span id="cb31-436"><a href="#cb31-436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-437"><a href="#cb31-437" aria-hidden="true" tabindex="-1"></a>    <span class="at">fld   =</span> <span class="fu">map</span>(tbl, <span class="sc">~</span><span class="fu">dbListFields</span>(.x, <span class="at">conn =</span> con_dev)),</span>
<span id="cb31-438"><a href="#cb31-438" aria-hidden="true" tabindex="-1"></a>    <span class="at">pkeys =</span> <span class="fu">map</span>(tbl, <span class="sc">~</span><span class="fu">tbl_pkeys</span>(.x, <span class="at">con =</span> con_dev))) <span class="sc">|&gt;</span> </span>
<span id="cb31-439"><a href="#cb31-439" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(fld) <span class="sc">|&gt;</span></span>
<span id="cb31-440"><a href="#cb31-440" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-441"><a href="#cb31-441" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_pkey  =</span> <span class="fu">map2_lgl</span>(fld, pkeys, <span class="st">`</span><span class="at">%in%</span><span class="st">`</span>),</span>
<span id="cb31-442"><a href="#cb31-442" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_pkey1 =</span> <span class="fu">map2_lgl</span>(fld, pkeys, \(fld, pkeys) fld <span class="sc">==</span> pkeys[<span class="dv">1</span>]),</span>
<span id="cb31-443"><a href="#cb31-443" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_id    =</span> <span class="fu">map_lgl</span>(fld, <span class="sc">~</span><span class="fu">str_detect</span>(.x, <span class="st">"_(id|uuid|tsn)$"</span>)),</span>
<span id="cb31-444"><a href="#cb31-444" aria-hidden="true" tabindex="-1"></a>    <span class="at">idx_todo =</span> <span class="sc">!</span>is_pkey1 <span class="sc">&amp;</span> is_id,</span>
<span id="cb31-445"><a href="#cb31-445" aria-hidden="true" tabindex="-1"></a>    <span class="at">mk_idx   =</span> <span class="fu">pmap_lgl</span>(<span class="fu">list</span>(tbl, fld, idx_todo), \(tbl, fld, idx_todo){</span>
<span id="cb31-446"><a href="#cb31-446" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (idx_todo){</span>
<span id="cb31-447"><a href="#cb31-447" aria-hidden="true" tabindex="-1"></a>        q <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"CREATE INDEX IF NOT EXISTS idx_{tbl}_{fld} ON {tbl} ({fld})"</span>)</span>
<span id="cb31-448"><a href="#cb31-448" aria-hidden="true" tabindex="-1"></a>        <span class="co"># message(q)</span></span>
<span id="cb31-449"><a href="#cb31-449" aria-hidden="true" tabindex="-1"></a>        <span class="fu">dbExecute</span>(con_dev, q)</span>
<span id="cb31-450"><a href="#cb31-450" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(T)</span>
<span id="cb31-451"><a href="#cb31-451" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb31-452"><a href="#cb31-452" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(F)</span>
<span id="cb31-453"><a href="#cb31-453" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb31-454"><a href="#cb31-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-455"><a href="#cb31-455" aria-hidden="true" tabindex="-1"></a>d_idx <span class="sc">|&gt;</span> </span>
<span id="cb31-456"><a href="#cb31-456" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>pkeys) <span class="sc">|&gt;</span> </span>
<span id="cb31-457"><a href="#cb31-457" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>()</span>
<span id="cb31-458"><a href="#cb31-458" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-459"><a href="#cb31-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-460"><a href="#cb31-460" aria-hidden="true" tabindex="-1"></a><span class="fu">### Add foreign keys</span></span>
<span id="cb31-461"><a href="#cb31-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-462"><a href="#cb31-462" aria-hidden="true" tabindex="-1"></a>egg.net_uuid -<span class="sc">\&gt;</span> net.net_uuid .tow_uuid -<span class="sc">\&gt;</span> tow.tow_uuid .site_uuid -<span class="sc">\&gt;</span></span>
<span id="cb31-463"><a href="#cb31-463" aria-hidden="true" tabindex="-1"></a>site.site_uuid .cruise_uuid -<span class="sc">\&gt;</span> cruise.cruise_uuid .ship_key -<span class="sc">\&gt;</span></span>
<span id="cb31-464"><a href="#cb31-464" aria-hidden="true" tabindex="-1"></a>ship.ship_key</span>
<span id="cb31-465"><a href="#cb31-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-468"><a href="#cb31-468" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-469"><a href="#cb31-469" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: dm_fk</span></span>
<span id="cb31-470"><a href="#cb31-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-471"><a href="#cb31-471" aria-hidden="true" tabindex="-1"></a>dm_dev <span class="ot">&lt;-</span> <span class="fu">dm_from_con</span>(</span>
<span id="cb31-472"><a href="#cb31-472" aria-hidden="true" tabindex="-1"></a>  con_dev, </span>
<span id="cb31-473"><a href="#cb31-473" aria-hidden="true" tabindex="-1"></a>  <span class="at">table_names =</span> tbls_dev,</span>
<span id="cb31-474"><a href="#cb31-474" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_keys  =</span> T)</span>
<span id="cb31-475"><a href="#cb31-475" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_draw</span>(dm_dev, <span class="at">view_type =</span> <span class="st">"all"</span>)</span>
<span id="cb31-476"><a href="#cb31-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-477"><a href="#cb31-477" aria-hidden="true" tabindex="-1"></a>dm_dev_fk <span class="ot">&lt;-</span> dm_dev <span class="sc">|&gt;</span> </span>
<span id="cb31-478"><a href="#cb31-478" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_add_fk</span>(egg, net_uuid, net) <span class="sc">|&gt;</span> </span>
<span id="cb31-479"><a href="#cb31-479" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_add_fk</span>(larva, net_uuid, net) <span class="sc">|&gt;</span> </span>
<span id="cb31-480"><a href="#cb31-480" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_add_fk</span>(net, tow_uuid, tow) <span class="sc">|&gt;</span> </span>
<span id="cb31-481"><a href="#cb31-481" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_add_fk</span>(tow, site_uuid, site) <span class="sc">|&gt;</span> </span>
<span id="cb31-482"><a href="#cb31-482" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_add_fk</span>(site, cruise_uuid, cruise) <span class="sc">|&gt;</span> </span>
<span id="cb31-483"><a href="#cb31-483" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_add_fk</span>(cruise, ship_key, ship) <span class="sc">|&gt;</span> </span>
<span id="cb31-484"><a href="#cb31-484" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_add_fk</span>(tow, tow_type_key, tow_type) <span class="sc">|&gt;</span> </span>
<span id="cb31-485"><a href="#cb31-485" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_add_fk</span>(egg, sp_id, species) <span class="sc">|&gt;</span> </span>
<span id="cb31-486"><a href="#cb31-486" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_add_fk</span>(larva, sp_id, species) </span>
<span id="cb31-487"><a href="#cb31-487" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_draw</span>(dm_dev_fk, <span class="at">view_type =</span> <span class="st">"all"</span>)</span>
<span id="cb31-488"><a href="#cb31-488" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-489"><a href="#cb31-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-492"><a href="#cb31-492" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-493"><a href="#cb31-493" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: sql_fk</span></span>
<span id="cb31-494"><a href="#cb31-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-495"><a href="#cb31-495" aria-hidden="true" tabindex="-1"></a>add_fkey <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl_m, fld_m, tbl_1, <span class="at">fld_1 =</span> fld_m, <span class="at">schema =</span> <span class="st">"dev"</span>){</span>
<span id="cb31-496"><a href="#cb31-496" aria-hidden="true" tabindex="-1"></a>  q <span class="ot">&lt;-</span> <span class="fu">glue</span>(</span>
<span id="cb31-497"><a href="#cb31-497" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ALTER TABLE {schema}.{tbl_m} ADD FOREIGN KEY ({fld_m}) </span></span>
<span id="cb31-498"><a href="#cb31-498" aria-hidden="true" tabindex="-1"></a><span class="st">    REFERENCES {schema}.{tbl_1} ({fld_1})"</span>)</span>
<span id="cb31-499"><a href="#cb31-499" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbExecute</span>(con_dev, q)</span>
<span id="cb31-500"><a href="#cb31-500" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-501"><a href="#cb31-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-502"><a href="#cb31-502" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"egg"</span>, <span class="st">"net_uuid"</span>, <span class="st">"net"</span>)</span>
<span id="cb31-503"><a href="#cb31-503" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"larva"</span>, <span class="st">"net_uuid"</span>, <span class="st">"net"</span>) </span>
<span id="cb31-504"><a href="#cb31-504" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"net"</span>, <span class="st">"tow_uuid"</span>, <span class="st">"tow"</span>) </span>
<span id="cb31-505"><a href="#cb31-505" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"tow"</span>, <span class="st">"site_uuid"</span>, <span class="st">"site"</span>)</span>
<span id="cb31-506"><a href="#cb31-506" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"site"</span>, <span class="st">"cruise_uuid"</span>, <span class="st">"cruise"</span>)</span>
<span id="cb31-507"><a href="#cb31-507" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"cruise"</span>, <span class="st">"ship_key"</span>, <span class="st">"ship"</span>)</span>
<span id="cb31-508"><a href="#cb31-508" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"tow"</span>, <span class="st">"tow_type_key"</span>, <span class="st">"tow_type"</span>)</span>
<span id="cb31-509"><a href="#cb31-509" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"egg"</span>, <span class="st">"sp_id"</span>, <span class="st">"species"</span>)</span>
<span id="cb31-510"><a href="#cb31-510" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"larva"</span>, <span class="st">"sp_id"</span>, <span class="st">"species"</span>)</span>
<span id="cb31-511"><a href="#cb31-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-512"><a href="#cb31-512" aria-hidden="true" tabindex="-1"></a>dm_dev <span class="ot">&lt;-</span> <span class="fu">dm_from_con</span>(</span>
<span id="cb31-513"><a href="#cb31-513" aria-hidden="true" tabindex="-1"></a>  con_dev, </span>
<span id="cb31-514"><a href="#cb31-514" aria-hidden="true" tabindex="-1"></a>  <span class="at">table_names =</span> tbls_dev,</span>
<span id="cb31-515"><a href="#cb31-515" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_keys  =</span> T)</span>
<span id="cb31-516"><a href="#cb31-516" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_draw</span>(dm_dev, <span class="at">view_type =</span> <span class="st">"all"</span>)</span>
<span id="cb31-517"><a href="#cb31-517" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-518"><a href="#cb31-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-519"><a href="#cb31-519" aria-hidden="true" tabindex="-1"></a><span class="in">```         </span></span>
<span id="cb31-520"><a href="#cb31-520" aria-hidden="true" tabindex="-1"></a><span class="in">Error: Failed to fetch row : ERROR:  insert or update on table "larva" violates foreign key constraint "larva_sp_id_fkey"</span></span>
<span id="cb31-521"><a href="#cb31-521" aria-hidden="true" tabindex="-1"></a><span class="in">DETAIL:  Key (sp_id)=(3023) is not present in table "species".</span></span>
<span id="cb31-522"><a href="#cb31-522" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-523"><a href="#cb31-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-526"><a href="#cb31-526" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-527"><a href="#cb31-527" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: sp_missing</span></span>
<span id="cb31-528"><a href="#cb31-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-529"><a href="#cb31-529" aria-hidden="true" tabindex="-1"></a>sp_missing_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(</span>
<span id="cb31-530"><a href="#cb31-530" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data/ingest/noaa-calcofi-db/larvae-species_not-in-species.csv"</span>)</span>
<span id="cb31-531"><a href="#cb31-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-532"><a href="#cb31-532" aria-hidden="true" tabindex="-1"></a>d_sp_missing <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_dev, <span class="st">"larva"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb31-533"><a href="#cb31-533" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anti_join</span>(</span>
<span id="cb31-534"><a href="#cb31-534" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tbl</span>(con_dev, <span class="st">"species"</span>),</span>
<span id="cb31-535"><a href="#cb31-535" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"sp_id"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb31-536"><a href="#cb31-536" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sp_id) <span class="sc">|&gt;</span> </span>
<span id="cb31-537"><a href="#cb31-537" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb31-538"><a href="#cb31-538" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_rows =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb31-539"><a href="#cb31-539" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb31-540"><a href="#cb31-540" aria-hidden="true" tabindex="-1"></a>    dm_dev <span class="sc">|&gt;</span></span>
<span id="cb31-541"><a href="#cb31-541" aria-hidden="true" tabindex="-1"></a>      <span class="fu">dm_select_tbl</span>(larva, net, tow, site) <span class="sc">|&gt;</span> </span>
<span id="cb31-542"><a href="#cb31-542" aria-hidden="true" tabindex="-1"></a>      <span class="fu">dm_flatten_to_tbl</span>(<span class="at">.start =</span> larva, <span class="at">.recursive =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb31-543"><a href="#cb31-543" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(sp_id, tally, time_start, line, station, cruise_uuid) <span class="sc">|&gt;</span> </span>
<span id="cb31-544"><a href="#cb31-544" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(sp_id) <span class="sc">|&gt;</span> </span>
<span id="cb31-545"><a href="#cb31-545" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarize</span>(</span>
<span id="cb31-546"><a href="#cb31-546" aria-hidden="true" tabindex="-1"></a>        <span class="at">sum_tally  =</span> <span class="fu">sum</span>(tally),</span>
<span id="cb31-547"><a href="#cb31-547" aria-hidden="true" tabindex="-1"></a>        <span class="at">date_beg   =</span> <span class="fu">min</span>(<span class="fu">as.Date</span>(time_start)),</span>
<span id="cb31-548"><a href="#cb31-548" aria-hidden="true" tabindex="-1"></a>        <span class="at">date_end   =</span> <span class="fu">max</span>(<span class="fu">as.Date</span>(time_start)),</span>
<span id="cb31-549"><a href="#cb31-549" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ship_names = str_flatten(distinct(name), collapse = "; ")), </span></span>
<span id="cb31-550"><a href="#cb31-550" aria-hidden="true" tabindex="-1"></a>        <span class="at">n_cruises =</span> <span class="fu">n_distinct</span>(cruise_uuid)), </span>
<span id="cb31-551"><a href="#cb31-551" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"sp_id"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb31-552"><a href="#cb31-552" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb31-553"><a href="#cb31-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-554"><a href="#cb31-554" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d_sp_missing, sp_missing_csv)</span>
<span id="cb31-555"><a href="#cb31-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-556"><a href="#cb31-556" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(d_sp_missing)</span>
<span id="cb31-557"><a href="#cb31-557" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-558"><a href="#cb31-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-561"><a href="#cb31-561" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-562"><a href="#cb31-562" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: delete_larva_sp_missing</span></span>
<span id="cb31-563"><a href="#cb31-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-564"><a href="#cb31-564" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="fu">glue</span>(</span>
<span id="cb31-565"><a href="#cb31-565" aria-hidden="true" tabindex="-1"></a>  <span class="st">"DELETE FROM larva WHERE sp_id IN ({paste(d_sp_missing$sp_id, collapse = ',')})"</span>))</span>
<span id="cb31-566"><a href="#cb31-566" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"larva"</span>, <span class="st">"sp_id"</span>, <span class="st">"species"</span>)</span>
<span id="cb31-567"><a href="#cb31-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-568"><a href="#cb31-568" aria-hidden="true" tabindex="-1"></a>dm_dev <span class="ot">&lt;-</span> <span class="fu">dm_from_con</span>(</span>
<span id="cb31-569"><a href="#cb31-569" aria-hidden="true" tabindex="-1"></a>  con_dev, </span>
<span id="cb31-570"><a href="#cb31-570" aria-hidden="true" tabindex="-1"></a>  <span class="at">table_names =</span> tbls_dev,</span>
<span id="cb31-571"><a href="#cb31-571" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_keys  =</span> T)</span>
<span id="cb31-572"><a href="#cb31-572" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_draw</span>(dm_dev, <span class="at">view_type =</span> <span class="st">"all"</span>)</span>
<span id="cb31-573"><a href="#cb31-573" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-574"><a href="#cb31-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-575"><a href="#cb31-575" aria-hidden="true" tabindex="-1"></a><span class="fu">## Add Spatial</span></span>
<span id="cb31-576"><a href="#cb31-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-577"><a href="#cb31-577" aria-hidden="true" tabindex="-1"></a><span class="fu">### Add `site.geom`</span></span>
<span id="cb31-578"><a href="#cb31-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-581"><a href="#cb31-581" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-582"><a href="#cb31-582" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mk_site_pts</span></span>
<span id="cb31-583"><a href="#cb31-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-584"><a href="#cb31-584" aria-hidden="true" tabindex="-1"></a><span class="co"># source(here("../apps_dev/libs/db.R"))</span></span>
<span id="cb31-585"><a href="#cb31-585" aria-hidden="true" tabindex="-1"></a><span class="co"># dbGetQuery(con_dev, "SELECT postgis_full_version()")</span></span>
<span id="cb31-586"><a href="#cb31-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-587"><a href="#cb31-587" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">"ALTER TABLE dev.site ADD COLUMN geom geometry(Point, 4326)"</span>)</span>
<span id="cb31-588"><a href="#cb31-588" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">"UPDATE dev.site SET geom = ST_SetSRID(ST_MakePoint(longitude, latitude), 4326)"</span>) <span class="co"># 61,220 rows</span></span>
<span id="cb31-589"><a href="#cb31-589" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-590"><a href="#cb31-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-591"><a href="#cb31-591" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fix calcofi4r `grid`</span></span>
<span id="cb31-592"><a href="#cb31-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-593"><a href="#cb31-593" aria-hidden="true" tabindex="-1"></a>Problems with</span>
<span id="cb31-594"><a href="#cb31-594" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">calcofi4r::`cc_grid`</span><span class="co">](https://calcofi.io/calcofi4r/articles/calcofi4r.html)</span>:</span>
<span id="cb31-595"><a href="#cb31-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-596"><a href="#cb31-596" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>uses old station (line, position) vs newer site (line, station)</span>
<span id="cb31-597"><a href="#cb31-597" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`sta_lin`</span>, <span class="in">`sta_pos`</span>: integer, so drops necessary decimal that is</span>
<span id="cb31-598"><a href="#cb31-598" aria-hidden="true" tabindex="-1"></a>    found in <span class="in">`sta_key`</span></span>
<span id="cb31-599"><a href="#cb31-599" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`sta_lin == 90, sta_pos == 120`</span> repeats for:</span>
<span id="cb31-600"><a href="#cb31-600" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="in">`sta_pattern`</span> <span class="al">== 'historical' (`sta_dpos` ==</span> 20); and</span>
<span id="cb31-601"><a href="#cb31-601" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="in">`sta_pattern`</span> <span class="al">== 'standard' (`sta_dpos` ==</span> 10)</span>
<span id="cb31-602"><a href="#cb31-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-605"><a href="#cb31-605" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-606"><a href="#cb31-606" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mk_grid_v2</span></span>
<span id="cb31-607"><a href="#cb31-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-608"><a href="#cb31-608" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb31-609"><a href="#cb31-609" aria-hidden="true" tabindex="-1"></a>  calcofi4r, dplyr, mapview, sf, tidyr, units)</span>
<span id="cb31-610"><a href="#cb31-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-611"><a href="#cb31-611" aria-hidden="true" tabindex="-1"></a>cc_grid_v2 <span class="ot">&lt;-</span> calcofi4r<span class="sc">::</span>cc_grid <span class="sc">|&gt;</span> </span>
<span id="cb31-612"><a href="#cb31-612" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sta_key, <span class="at">shore =</span> sta_shore, <span class="at">pattern =</span> sta_pattern, <span class="at">spacing =</span> sta_dpos) <span class="sc">|&gt;</span></span>
<span id="cb31-613"><a href="#cb31-613" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate_wider_delim</span>(</span>
<span id="cb31-614"><a href="#cb31-614" aria-hidden="true" tabindex="-1"></a>    sta_key, <span class="st">","</span>, <span class="at">names =</span> <span class="fu">c</span>(<span class="st">"line"</span>, <span class="st">"station"</span>), <span class="at">cols_remove =</span> F) <span class="sc">|&gt;</span> </span>
<span id="cb31-615"><a href="#cb31-615" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-616"><a href="#cb31-616" aria-hidden="true" tabindex="-1"></a>    <span class="at">line    =</span> <span class="fu">as.double</span>(line),</span>
<span id="cb31-617"><a href="#cb31-617" aria-hidden="true" tabindex="-1"></a>    <span class="at">station =</span> <span class="fu">as.double</span>(station),</span>
<span id="cb31-618"><a href="#cb31-618" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid_key =</span> <span class="fu">ifelse</span>(</span>
<span id="cb31-619"><a href="#cb31-619" aria-hidden="true" tabindex="-1"></a>      pattern <span class="sc">==</span> <span class="st">"historical"</span>, </span>
<span id="cb31-620"><a href="#cb31-620" aria-hidden="true" tabindex="-1"></a>      <span class="fu">glue</span>(<span class="st">"st{station}-ln{line}_hist"</span>),</span>
<span id="cb31-621"><a href="#cb31-621" aria-hidden="true" tabindex="-1"></a>      <span class="fu">glue</span>(<span class="st">"st{station}-ln{line}"</span>)),</span>
<span id="cb31-622"><a href="#cb31-622" aria-hidden="true" tabindex="-1"></a>    <span class="at">zone =</span> <span class="fu">glue</span>(<span class="st">"{shore}-{pattern}"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb31-623"><a href="#cb31-623" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(grid_key, station) <span class="sc">|&gt;</span> </span>
<span id="cb31-624"><a href="#cb31-624" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>() <span class="sc">|&gt;</span> </span>
<span id="cb31-625"><a href="#cb31-625" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-626"><a href="#cb31-626" aria-hidden="true" tabindex="-1"></a>    <span class="at">area_km2 =</span> <span class="fu">st_area</span>(geom) <span class="sc">|&gt;</span></span>
<span id="cb31-627"><a href="#cb31-627" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_units</span>(km<span class="sc">^</span><span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb31-628"><a href="#cb31-628" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.numeric</span>())</span>
<span id="cb31-629"><a href="#cb31-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-630"><a href="#cb31-630" aria-hidden="true" tabindex="-1"></a>cc_grid_ctrs_v2 <span class="ot">&lt;-</span> calcofi4r<span class="sc">::</span>cc_grid_ctrs <span class="sc">|&gt;</span> </span>
<span id="cb31-631"><a href="#cb31-631" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sta_key, <span class="at">pattern =</span> sta_pattern) <span class="sc">|&gt;</span> </span>
<span id="cb31-632"><a href="#cb31-632" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb31-633"><a href="#cb31-633" aria-hidden="true" tabindex="-1"></a>    cc_grid_v2 <span class="sc">|&gt;</span> </span>
<span id="cb31-634"><a href="#cb31-634" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_drop_geometry</span>(),</span>
<span id="cb31-635"><a href="#cb31-635" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"sta_key"</span>, <span class="st">"pattern"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb31-636"><a href="#cb31-636" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>sta_key) <span class="sc">|&gt;</span> </span>
<span id="cb31-637"><a href="#cb31-637" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(grid_key)</span>
<span id="cb31-638"><a href="#cb31-638" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-639"><a href="#cb31-639" aria-hidden="true" tabindex="-1"></a>cc_grid_v2 <span class="ot">&lt;-</span> cc_grid_v2 <span class="sc">|&gt;</span> </span>
<span id="cb31-640"><a href="#cb31-640" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>sta_key)</span>
<span id="cb31-641"><a href="#cb31-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-642"><a href="#cb31-642" aria-hidden="true" tabindex="-1"></a>cc_grid_v2 <span class="sc">|&gt;</span> </span>
<span id="cb31-643"><a href="#cb31-643" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb31-644"><a href="#cb31-644" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>()</span>
<span id="cb31-645"><a href="#cb31-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-646"><a href="#cb31-646" aria-hidden="true" tabindex="-1"></a><span class="fu">mapview</span>(cc_grid_v2, <span class="at">zcol=</span><span class="st">"zone"</span>) <span class="sc">+</span></span>
<span id="cb31-647"><a href="#cb31-647" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapview</span>(cc_grid_ctrs_v2, <span class="at">cex =</span> <span class="dv">1</span>)</span>
<span id="cb31-648"><a href="#cb31-648" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-649"><a href="#cb31-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-652"><a href="#cb31-652" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-653"><a href="#cb31-653" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: grid_to_db</span></span>
<span id="cb31-654"><a href="#cb31-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-655"><a href="#cb31-655" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> cc_grid_v2 <span class="sc">|&gt;</span> </span>
<span id="cb31-656"><a href="#cb31-656" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb31-657"><a href="#cb31-657" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb31-658"><a href="#cb31-658" aria-hidden="true" tabindex="-1"></a>    cc_grid_ctrs_v2 <span class="sc">|&gt;</span> </span>
<span id="cb31-659"><a href="#cb31-659" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb31-660"><a href="#cb31-660" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(grid_key, <span class="at">geom_ctr =</span> geom),</span>
<span id="cb31-661"><a href="#cb31-661" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"grid_key"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb31-662"><a href="#cb31-662" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">sf_column_name =</span> <span class="st">"geom"</span>)</span>
<span id="cb31-663"><a href="#cb31-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-664"><a href="#cb31-664" aria-hidden="true" tabindex="-1"></a>grid <span class="sc">|&gt;</span> </span>
<span id="cb31-665"><a href="#cb31-665" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_write</span>(con_dev, <span class="st">"grid"</span>)</span>
<span id="cb31-666"><a href="#cb31-666" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="fu">glue</span>(</span>
<span id="cb31-667"><a href="#cb31-667" aria-hidden="true" tabindex="-1"></a>  <span class="st">"CREATE INDEX IF NOT EXISTS idx_grid_geom ON grid USING gist(geom);"</span>))</span>
<span id="cb31-668"><a href="#cb31-668" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">"ALTER TABLE grid ADD PRIMARY KEY (grid_key)"</span>)</span>
<span id="cb31-669"><a href="#cb31-669" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-670"><a href="#cb31-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-671"><a href="#cb31-671" aria-hidden="true" tabindex="-1"></a><span class="fu">### Update `site.grid_key`</span></span>
<span id="cb31-672"><a href="#cb31-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-675"><a href="#cb31-675" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-676"><a href="#cb31-676" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: update_site_from_grid</span></span>
<span id="cb31-677"><a href="#cb31-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-678"><a href="#cb31-678" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">"ALTER TABLE site ADD COLUMN grid_key text"</span>)</span>
<span id="cb31-679"><a href="#cb31-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-680"><a href="#cb31-680" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">"</span></span>
<span id="cb31-681"><a href="#cb31-681" aria-hidden="true" tabindex="-1"></a><span class="st">  UPDATE site</span></span>
<span id="cb31-682"><a href="#cb31-682" aria-hidden="true" tabindex="-1"></a><span class="st">  SET</span></span>
<span id="cb31-683"><a href="#cb31-683" aria-hidden="true" tabindex="-1"></a><span class="st">    grid_key = g.grid_key</span></span>
<span id="cb31-684"><a href="#cb31-684" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM (</span></span>
<span id="cb31-685"><a href="#cb31-685" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT s.site_uuid, g.grid_key</span></span>
<span id="cb31-686"><a href="#cb31-686" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM site s</span></span>
<span id="cb31-687"><a href="#cb31-687" aria-hidden="true" tabindex="-1"></a><span class="st">    INNER JOIN grid g ON ST_Intersects(s.geom, g.geom)) g</span></span>
<span id="cb31-688"><a href="#cb31-688" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE site.site_uuid = g.site_uuid"</span>) <span class="co"># 59,136</span></span>
<span id="cb31-689"><a href="#cb31-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-690"><a href="#cb31-690" aria-hidden="true" tabindex="-1"></a><span class="co"># tbl(con_dev, "site") |&gt;</span></span>
<span id="cb31-691"><a href="#cb31-691" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(is_in_grd = !is.na(grid_key)) |&gt;</span></span>
<span id="cb31-692"><a href="#cb31-692" aria-hidden="true" tabindex="-1"></a><span class="co">#   pull(is_in_grd) |&gt;</span></span>
<span id="cb31-693"><a href="#cb31-693" aria-hidden="true" tabindex="-1"></a><span class="co">#   table()</span></span>
<span id="cb31-694"><a href="#cb31-694" aria-hidden="true" tabindex="-1"></a><span class="co">#  FALSE    TRUE </span></span>
<span id="cb31-695"><a href="#cb31-695" aria-hidden="true" tabindex="-1"></a><span class="co">#  2,084  59,136</span></span>
<span id="cb31-696"><a href="#cb31-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-697"><a href="#cb31-697" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="fu">glue</span>(</span>
<span id="cb31-698"><a href="#cb31-698" aria-hidden="true" tabindex="-1"></a>  <span class="st">"CREATE INDEX IF NOT EXISTS idx_site_geom_key ON grid (grid_key);"</span>))</span>
<span id="cb31-699"><a href="#cb31-699" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"site"</span>, <span class="st">"grid_key"</span>, <span class="st">"grid"</span>)</span>
<span id="cb31-700"><a href="#cb31-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-701"><a href="#cb31-701" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_from_con</span>(</span>
<span id="cb31-702"><a href="#cb31-702" aria-hidden="true" tabindex="-1"></a>  con_dev, </span>
<span id="cb31-703"><a href="#cb31-703" aria-hidden="true" tabindex="-1"></a>  <span class="co"># table_names = dbListTables(con_dev_only),</span></span>
<span id="cb31-704"><a href="#cb31-704" aria-hidden="true" tabindex="-1"></a>  <span class="at">table_names =</span> <span class="fu">c</span>(<span class="st">"site"</span>, <span class="st">"grid"</span>),</span>
<span id="cb31-705"><a href="#cb31-705" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_keys  =</span> T) <span class="sc">|&gt;</span> </span>
<span id="cb31-706"><a href="#cb31-706" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_set_colors</span>(<span class="at">green =</span> grid) <span class="sc">|&gt;</span></span>
<span id="cb31-707"><a href="#cb31-707" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_draw</span>(<span class="at">view_type =</span> <span class="st">"all"</span>)</span>
<span id="cb31-708"><a href="#cb31-708" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-709"><a href="#cb31-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-710"><a href="#cb31-710" aria-hidden="true" tabindex="-1"></a><span class="fu">### Add `site_seg`: segments from site</span></span>
<span id="cb31-711"><a href="#cb31-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-714"><a href="#cb31-714" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-715"><a href="#cb31-715" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mk_site_seg</span></span>
<span id="cb31-716"><a href="#cb31-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-717"><a href="#cb31-717" aria-hidden="true" tabindex="-1"></a>site_seg <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_dev, <span class="st">"site"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb31-718"><a href="#cb31-718" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(cruise_uuid, orderocc, site_uuid, <span class="at">lon =</span> longitude, <span class="at">lat =</span> latitude) <span class="sc">|&gt;</span> </span>
<span id="cb31-719"><a href="#cb31-719" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb31-720"><a href="#cb31-720" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tbl</span>(con_dev, <span class="st">"tow"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb31-721"><a href="#cb31-721" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(site_uuid, time_start),</span>
<span id="cb31-722"><a href="#cb31-722" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"site_uuid"</span>) <span class="sc">|&gt;</span></span>
<span id="cb31-723"><a href="#cb31-723" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(cruise_uuid, orderocc) <span class="sc">|&gt;</span> </span>
<span id="cb31-724"><a href="#cb31-724" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(</span>
<span id="cb31-725"><a href="#cb31-725" aria-hidden="true" tabindex="-1"></a>    cruise_uuid, orderocc, site_uuid, lon, lat) <span class="sc">|&gt;</span> </span>
<span id="cb31-726"><a href="#cb31-726" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb31-727"><a href="#cb31-727" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_beg =</span> <span class="fu">min</span>(time_start, <span class="at">na.rm =</span> T),</span>
<span id="cb31-728"><a href="#cb31-728" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_end =</span> <span class="fu">max</span>(time_start, <span class="at">na.rm =</span> T),</span>
<span id="cb31-729"><a href="#cb31-729" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb31-730"><a href="#cb31-730" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span> </span>
<span id="cb31-731"><a href="#cb31-731" aria-hidden="true" tabindex="-1"></a><span class="co"># table(is.na(site_seg$time_beg))</span></span>
<span id="cb31-732"><a href="#cb31-732" aria-hidden="true" tabindex="-1"></a><span class="co">#   FALSE   TRUE </span></span>
<span id="cb31-733"><a href="#cb31-733" aria-hidden="true" tabindex="-1"></a><span class="co">#  57,935  3,285</span></span>
<span id="cb31-734"><a href="#cb31-734" aria-hidden="true" tabindex="-1"></a>site_seg <span class="ot">&lt;-</span> site_seg <span class="sc">|&gt;</span>   </span>
<span id="cb31-735"><a href="#cb31-735" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(cruise_uuid, orderocc, time_beg) <span class="sc">|&gt;</span> </span>
<span id="cb31-736"><a href="#cb31-736" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cruise_uuid) <span class="sc">|&gt;</span> </span>
<span id="cb31-737"><a href="#cb31-737" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-738"><a href="#cb31-738" aria-hidden="true" tabindex="-1"></a>    <span class="at">site_uuid_beg =</span> <span class="fu">lag</span>(site_uuid),</span>
<span id="cb31-739"><a href="#cb31-739" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon_beg       =</span> <span class="fu">lag</span>(lon),</span>
<span id="cb31-740"><a href="#cb31-740" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat_beg       =</span> <span class="fu">lag</span>(lat),</span>
<span id="cb31-741"><a href="#cb31-741" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_beg      =</span> <span class="fu">lag</span>(time_beg)) <span class="sc">|&gt;</span> </span>
<span id="cb31-742"><a href="#cb31-742" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb31-743"><a href="#cb31-743" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(lon_beg), <span class="sc">!</span><span class="fu">is.na</span>(lat_beg)) <span class="sc">|&gt;</span> </span>
<span id="cb31-744"><a href="#cb31-744" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-745"><a href="#cb31-745" aria-hidden="true" tabindex="-1"></a>    <span class="at">m    =</span> <span class="fu">pmap</span>(</span>
<span id="cb31-746"><a href="#cb31-746" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(lon_beg, lat_beg, lon, lat), </span>
<span id="cb31-747"><a href="#cb31-747" aria-hidden="true" tabindex="-1"></a>      \(x1, y1, x2, y2){</span>
<span id="cb31-748"><a href="#cb31-748" aria-hidden="true" tabindex="-1"></a>        <span class="fu">matrix</span>(<span class="fu">c</span>(x1, y1, x2, y2), <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">byrow =</span> T) }),</span>
<span id="cb31-749"><a href="#cb31-749" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="fu">map</span>(m, st_linestring)) <span class="sc">|&gt;</span> </span>
<span id="cb31-750"><a href="#cb31-750" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb31-751"><a href="#cb31-751" aria-hidden="true" tabindex="-1"></a>    cruise_uuid,</span>
<span id="cb31-752"><a href="#cb31-752" aria-hidden="true" tabindex="-1"></a>    site_uuid_beg, </span>
<span id="cb31-753"><a href="#cb31-753" aria-hidden="true" tabindex="-1"></a>    <span class="at">site_uuid_end =</span> site_uuid, </span>
<span id="cb31-754"><a href="#cb31-754" aria-hidden="true" tabindex="-1"></a>    lon_beg, </span>
<span id="cb31-755"><a href="#cb31-755" aria-hidden="true" tabindex="-1"></a>    lat_beg,</span>
<span id="cb31-756"><a href="#cb31-756" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon_end =</span> lon, </span>
<span id="cb31-757"><a href="#cb31-757" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat_end =</span> lat,</span>
<span id="cb31-758"><a href="#cb31-758" aria-hidden="true" tabindex="-1"></a>    time_beg, </span>
<span id="cb31-759"><a href="#cb31-759" aria-hidden="true" tabindex="-1"></a>    time_end, </span>
<span id="cb31-760"><a href="#cb31-760" aria-hidden="true" tabindex="-1"></a>    geom) <span class="sc">|&gt;</span> </span>
<span id="cb31-761"><a href="#cb31-761" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(</span>
<span id="cb31-762"><a href="#cb31-762" aria-hidden="true" tabindex="-1"></a>    <span class="at">sf_column_name =</span> <span class="st">"geom"</span>, </span>
<span id="cb31-763"><a href="#cb31-763" aria-hidden="true" tabindex="-1"></a>    <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">|&gt;</span> </span>
<span id="cb31-764"><a href="#cb31-764" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-765"><a href="#cb31-765" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_hr   =</span> <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(time_end, time_beg, <span class="at">units =</span> <span class="st">"hours"</span>)),</span>
<span id="cb31-766"><a href="#cb31-766" aria-hidden="true" tabindex="-1"></a>    <span class="at">length_km =</span> <span class="fu">st_length</span>(geom) <span class="sc">|&gt;</span></span>
<span id="cb31-767"><a href="#cb31-767" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set_units</span>(km) <span class="sc">|&gt;</span></span>
<span id="cb31-768"><a href="#cb31-768" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.numeric</span>(),</span>
<span id="cb31-769"><a href="#cb31-769" aria-hidden="true" tabindex="-1"></a>    <span class="at">km_per_hr =</span> length_km <span class="sc">/</span> time_hr)</span>
<span id="cb31-770"><a href="#cb31-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-771"><a href="#cb31-771" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: check that time_end of previous segment is time_beg of next</span></span>
<span id="cb31-772"><a href="#cb31-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-773"><a href="#cb31-773" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: investigate too slow, too fast</span></span>
<span id="cb31-774"><a href="#cb31-774" aria-hidden="true" tabindex="-1"></a><span class="co"># site_seg |&gt; </span></span>
<span id="cb31-775"><a href="#cb31-775" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(</span></span>
<span id="cb31-776"><a href="#cb31-776" aria-hidden="true" tabindex="-1"></a><span class="co">#     km_per_hr_flag = ifelse(</span></span>
<span id="cb31-777"><a href="#cb31-777" aria-hidden="true" tabindex="-1"></a><span class="co">#       km_per_hr &lt; 0.01,</span></span>
<span id="cb31-778"><a href="#cb31-778" aria-hidden="true" tabindex="-1"></a><span class="co">#       "lt0.01",</span></span>
<span id="cb31-779"><a href="#cb31-779" aria-hidden="true" tabindex="-1"></a><span class="co">#       ifelse(</span></span>
<span id="cb31-780"><a href="#cb31-780" aria-hidden="true" tabindex="-1"></a><span class="co">#         km_per_hr &gt; 30,</span></span>
<span id="cb31-781"><a href="#cb31-781" aria-hidden="true" tabindex="-1"></a><span class="co">#         "gt30",</span></span>
<span id="cb31-782"><a href="#cb31-782" aria-hidden="true" tabindex="-1"></a><span class="co">#         NA))) |&gt; </span></span>
<span id="cb31-783"><a href="#cb31-783" aria-hidden="true" tabindex="-1"></a><span class="co">#   pull(km_per_hr_flag) |&gt; </span></span>
<span id="cb31-784"><a href="#cb31-784" aria-hidden="true" tabindex="-1"></a><span class="co">#   table()</span></span>
<span id="cb31-785"><a href="#cb31-785" aria-hidden="true" tabindex="-1"></a><span class="co">#   gt30 lt0.01 </span></span>
<span id="cb31-786"><a href="#cb31-786" aria-hidden="true" tabindex="-1"></a><span class="co">#    928      9</span></span>
<span id="cb31-787"><a href="#cb31-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-788"><a href="#cb31-788" aria-hidden="true" tabindex="-1"></a>fld_types <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb31-789"><a href="#cb31-789" aria-hidden="true" tabindex="-1"></a>  <span class="at">lst =</span> <span class="fu">lapply</span>(site_seg, class)) <span class="sc">|&gt;</span> </span>
<span id="cb31-790"><a href="#cb31-790" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-791"><a href="#cb31-791" aria-hidden="true" tabindex="-1"></a>    <span class="at">fld    =</span> <span class="fu">names</span>(lst),</span>
<span id="cb31-792"><a href="#cb31-792" aria-hidden="true" tabindex="-1"></a>    <span class="at">type_r =</span> <span class="fu">map_chr</span>(lst, pluck, <span class="dv">1</span>),</span>
<span id="cb31-793"><a href="#cb31-793" aria-hidden="true" tabindex="-1"></a>    <span class="at">type   =</span> <span class="fu">map2_chr</span>(fld, type_r, \(fld, type_r){</span>
<span id="cb31-794"><a href="#cb31-794" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb31-795"><a href="#cb31-795" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_detect</span>(fld, <span class="st">"uuid"</span>) <span class="sc">~</span> <span class="st">"uuid"</span>,</span>
<span id="cb31-796"><a href="#cb31-796" aria-hidden="true" tabindex="-1"></a>        fld    <span class="sc">==</span> <span class="st">"geom"</span>        <span class="sc">~</span> <span class="st">"geometry"</span>,</span>
<span id="cb31-797"><a href="#cb31-797" aria-hidden="true" tabindex="-1"></a>        type_r <span class="sc">==</span> <span class="st">"POSIXct"</span>     <span class="sc">~</span> <span class="st">"timestamp"</span>,</span>
<span id="cb31-798"><a href="#cb31-798" aria-hidden="true" tabindex="-1"></a>        type_r <span class="sc">==</span> <span class="st">"character"</span>   <span class="sc">~</span> <span class="st">"varchar"</span>,</span>
<span id="cb31-799"><a href="#cb31-799" aria-hidden="true" tabindex="-1"></a>        <span class="at">.default =</span> <span class="st">"numeric"</span>) })) <span class="sc">|&gt;</span> </span>
<span id="cb31-800"><a href="#cb31-800" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(fld, type) <span class="sc">|&gt;</span> </span>
<span id="cb31-801"><a href="#cb31-801" aria-hidden="true" tabindex="-1"></a>  <span class="fu">deframe</span>()</span>
<span id="cb31-802"><a href="#cb31-802" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(site_seg, con_dev, <span class="st">"site_seg"</span>, <span class="at">field.types =</span> fld_types)</span>
<span id="cb31-803"><a href="#cb31-803" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">"CREATE INDEX IF NOT EXISTS idx_site_seg_geom ON grid USING gist(geom)"</span>)</span>
<span id="cb31-804"><a href="#cb31-804" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">"ALTER TABLE site_seg ADD PRIMARY KEY (site_uuid_beg)"</span>)</span>
<span id="cb31-805"><a href="#cb31-805" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con_dev, <span class="st">'CREATE EXTENSION IF NOT EXISTS "uuid-ossp"'</span>)</span>
<span id="cb31-806"><a href="#cb31-806" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"site_seg"</span>, <span class="st">"site_uuid_beg"</span>, <span class="st">"site"</span>, <span class="st">"site_uuid"</span>)</span>
<span id="cb31-807"><a href="#cb31-807" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"site_seg"</span>, <span class="st">"site_uuid_end"</span>, <span class="st">"site"</span>, <span class="st">"site_uuid"</span>)</span>
<span id="cb31-808"><a href="#cb31-808" aria-hidden="true" tabindex="-1"></a><span class="fu">add_fkey</span>(<span class="st">"site_seg"</span>, <span class="st">"cruise_uuid"</span>, <span class="st">"cruise"</span>)</span>
<span id="cb31-809"><a href="#cb31-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-810"><a href="#cb31-810" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_from_con</span>(</span>
<span id="cb31-811"><a href="#cb31-811" aria-hidden="true" tabindex="-1"></a>  con_dev, </span>
<span id="cb31-812"><a href="#cb31-812" aria-hidden="true" tabindex="-1"></a>  <span class="co"># table_names = dbListTables(con_dev_only),</span></span>
<span id="cb31-813"><a href="#cb31-813" aria-hidden="true" tabindex="-1"></a>  <span class="at">table_names =</span> <span class="fu">c</span>(<span class="st">"site_seg"</span>, <span class="st">"site"</span>, <span class="st">"cruise"</span>),</span>
<span id="cb31-814"><a href="#cb31-814" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_keys  =</span> T) <span class="sc">|&gt;</span> </span>
<span id="cb31-815"><a href="#cb31-815" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_set_colors</span>(<span class="at">green =</span> site_seg) <span class="sc">|&gt;</span></span>
<span id="cb31-816"><a href="#cb31-816" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_draw</span>(<span class="at">view_type =</span> <span class="st">"all"</span>)</span>
<span id="cb31-817"><a href="#cb31-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-818"><a href="#cb31-818" aria-hidden="true" tabindex="-1"></a>site_seg <span class="ot">&lt;-</span> <span class="fu">st_read</span>(con_dev, <span class="st">"site_seg"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb31-819"><a href="#cb31-819" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-820"><a href="#cb31-820" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">year</span>(time_beg))</span>
<span id="cb31-821"><a href="#cb31-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-822"><a href="#cb31-822" aria-hidden="true" tabindex="-1"></a><span class="fu">mapView</span>(site_seg, <span class="at">zcol =</span> <span class="st">"year"</span>)</span>
<span id="cb31-823"><a href="#cb31-823" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-824"><a href="#cb31-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-825"><a href="#cb31-825" aria-hidden="true" tabindex="-1"></a><span class="fu">## Report</span></span>
<span id="cb31-826"><a href="#cb31-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-829"><a href="#cb31-829" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-830"><a href="#cb31-830" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: show_latest</span></span>
<span id="cb31-831"><a href="#cb31-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-832"><a href="#cb31-832" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_from_con</span>(</span>
<span id="cb31-833"><a href="#cb31-833" aria-hidden="true" tabindex="-1"></a>  con_dev, </span>
<span id="cb31-834"><a href="#cb31-834" aria-hidden="true" tabindex="-1"></a>  <span class="at">table_names =</span> <span class="fu">dbListTables</span>(con_dev_only),</span>
<span id="cb31-835"><a href="#cb31-835" aria-hidden="true" tabindex="-1"></a>  <span class="co"># table_names = c("site_seg", "site", "cruise"),</span></span>
<span id="cb31-836"><a href="#cb31-836" aria-hidden="true" tabindex="-1"></a>  <span class="at">learn_keys  =</span> T) <span class="sc">|&gt;</span> </span>
<span id="cb31-837"><a href="#cb31-837" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_set_colors</span>(<span class="at">lightgreen =</span> <span class="fu">c</span>(site_seg, grid)) <span class="sc">|&gt;</span></span>
<span id="cb31-838"><a href="#cb31-838" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dm_draw</span>(<span class="at">view_type =</span> <span class="st">"all"</span>)</span>
<span id="cb31-839"><a href="#cb31-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-840"><a href="#cb31-840" aria-hidden="true" tabindex="-1"></a>d_eff <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_dev, <span class="st">"site_seg"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb31-841"><a href="#cb31-841" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-842"><a href="#cb31-842" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">year</span>(time_beg)) <span class="sc">|&gt;</span> </span>
<span id="cb31-843"><a href="#cb31-843" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">|&gt;</span> </span>
<span id="cb31-844"><a href="#cb31-844" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb31-845"><a href="#cb31-845" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_hr   =</span> <span class="fu">sum</span>(time_hr, <span class="at">na.rm =</span> T),</span>
<span id="cb31-846"><a href="#cb31-846" aria-hidden="true" tabindex="-1"></a>    <span class="at">length_km =</span> <span class="fu">sum</span>(length_km, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span> </span>
<span id="cb31-847"><a href="#cb31-847" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb31-848"><a href="#cb31-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-849"><a href="#cb31-849" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(d_eff<span class="sc">$</span>time_hr, <span class="at">na.rm =</span> T)    <span class="co"># 302,516 hours; 12,604 days; 34.5 years</span></span>
<span id="cb31-850"><a href="#cb31-850" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(d_eff<span class="sc">$</span>length_km, <span class="at">na.rm =</span> T)  <span class="co"># 3,672,794 km</span></span>
<span id="cb31-851"><a href="#cb31-851" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-852"><a href="#cb31-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-853"><a href="#cb31-853" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cleanup</span></span>
<span id="cb31-854"><a href="#cb31-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-857"><a href="#cb31-857" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-858"><a href="#cb31-858" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cleanup</span></span>
<span id="cb31-859"><a href="#cb31-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-860"><a href="#cb31-860" aria-hidden="true" tabindex="-1"></a><span class="co"># Close database connection</span></span>
<span id="cb31-861"><a href="#cb31-861" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con)</span>
<span id="cb31-862"><a href="#cb31-862" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-863"><a href="#cb31-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-864"><a href="#cb31-864" aria-hidden="true" tabindex="-1"></a><span class="fu">## TODO</span></span>
<span id="cb31-865"><a href="#cb31-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-866"><a href="#cb31-866" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> Add **indexes**.</span>
<span id="cb31-867"><a href="#cb31-867" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> Add **relationships** between primary keys.</span>
<span id="cb31-868"><a href="#cb31-868" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> Add **points** between <span class="in">`sites`</span></span>
<span id="cb31-869"><a href="#cb31-869" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> Add **segments** between <span class="in">`sites`</span>.</span>
<span id="cb31-870"><a href="#cb31-870" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> Check all <span class="in">`type_new`</span> are valid for db connection.</span>
<span id="cb31-871"><a href="#cb31-871" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> Check that all <span class="in">`flds_in`</span> are in <span class="in">`flds_rn`</span>.</span>
<span id="cb31-872"><a href="#cb31-872" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> Insert table and field SQL <span class="in">`COMMENT`</span>s into database, using</span>
<span id="cb31-873"><a href="#cb31-873" aria-hidden="true" tabindex="-1"></a>    <span class="in">`comment`</span> field + <span class="in">`workflow_md`</span> (markdown with name and link) +</span>
<span id="cb31-874"><a href="#cb31-874" aria-hidden="true" tabindex="-1"></a>    source with tbl.fld</span>
<span id="cb31-875"><a href="#cb31-875" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> Review documentation for more comment descriptions at [Data <span class="sc">\&gt;</span></span>
<span id="cb31-876"><a href="#cb31-876" aria-hidden="true" tabindex="-1"></a>    Data Formats <span class="sc">\|</span></span>
<span id="cb31-877"><a href="#cb31-877" aria-hidden="true" tabindex="-1"></a>    CalCOFI.org](https://calcofi.com/index.php?option=com_content&amp;view=category&amp;id=73&amp;Itemid=993)</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>