<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2026-02-24">

<title>Publish Ichthyoplankton &amp; Bottle Data to OBIS</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="publish_icthyo-bottle_to_obis_files/libs/clipboard/clipboard.min.js"></script>
<script src="publish_icthyo-bottle_to_obis_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="publish_icthyo-bottle_to_obis_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="publish_icthyo-bottle_to_obis_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="publish_icthyo-bottle_to_obis_files/libs/quarto-html/popper.min.js"></script>
<script src="publish_icthyo-bottle_to_obis_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="publish_icthyo-bottle_to_obis_files/libs/quarto-html/anchor.min.js"></script>
<link href="publish_icthyo-bottle_to_obis_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="publish_icthyo-bottle_to_obis_files/libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="publish_icthyo-bottle_to_obis_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="publish_icthyo-bottle_to_obis_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="publish_icthyo-bottle_to_obis_files/libs/bootstrap/bootstrap-d6a003b94517c951b2d65075d42fb01b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="publish_icthyo-bottle_to_obis_files/libs/quarto-diagram/mermaid.min.js"></script>
<script src="publish_icthyo-bottle_to_obis_files/libs/quarto-diagram/mermaid-init.js"></script>
<link href="publish_icthyo-bottle_to_obis_files/libs/quarto-diagram/mermaid.css" rel="stylesheet">


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">1</span> Overview</a></li>
  <li><a href="#event-hierarchy-design" id="toc-event-hierarchy-design" class="nav-link" data-scroll-target="#event-hierarchy-design"><span class="header-section-number">2</span> Event Hierarchy Design</a></li>
  <li><a href="#data-extraction" id="toc-data-extraction" class="nav-link" data-scroll-target="#data-extraction"><span class="header-section-number">3</span> Data Extraction</a></li>
  <li><a href="#mint-globally-unique-identifiers" id="toc-mint-globally-unique-identifiers" class="nav-link" data-scroll-target="#mint-globally-unique-identifiers"><span class="header-section-number">4</span> Mint Globally Unique Identifiers</a></li>
  <li><a href="#life-stage-vocabulary" id="toc-life-stage-vocabulary" class="nav-link" data-scroll-target="#life-stage-vocabulary"><span class="header-section-number">5</span> Life Stage Vocabulary</a></li>
  <li><a href="#build-event-hierarchy" id="toc-build-event-hierarchy" class="nav-link" data-scroll-target="#build-event-hierarchy"><span class="header-section-number">6</span> Build Event Hierarchy</a>
  <ul>
  <li><a href="#cruise-events" id="toc-cruise-events" class="nav-link" data-scroll-target="#cruise-events"><span class="header-section-number">6.1</span> Cruise Events</a></li>
  <li><a href="#net-sample-events" id="toc-net-sample-events" class="nav-link" data-scroll-target="#net-sample-events"><span class="header-section-number">6.2</span> Net Sample Events</a></li>
  <li><a href="#ctd-cast-events" id="toc-ctd-cast-events" class="nav-link" data-scroll-target="#ctd-cast-events"><span class="header-section-number">6.3</span> CTD Cast Events</a></li>
  <li><a href="#combine-all-events" id="toc-combine-all-events" class="nav-link" data-scroll-target="#combine-all-events"><span class="header-section-number">6.4</span> Combine All Events</a></li>
  </ul></li>
  <li><a href="#build-occurrence-records" id="toc-build-occurrence-records" class="nav-link" data-scroll-target="#build-occurrence-records"><span class="header-section-number">7</span> Build Occurrence Records</a></li>
  <li><a href="#build-extendedmeasurementorfact-extension" id="toc-build-extendedmeasurementorfact-extension" class="nav-link" data-scroll-target="#build-extendedmeasurementorfact-extension"><span class="header-section-number">8</span> Build ExtendedMeasurementOrFact Extension</a>
  <ul>
  <li><a href="#a.-net-level-sample-measurements" id="toc-a.-net-level-sample-measurements" class="nav-link" data-scroll-target="#a.-net-level-sample-measurements"><span class="header-section-number">8.1</span> 10a. Net-level sample measurements</a></li>
  <li><a href="#b.-stage-specific-abundance" id="toc-b.-stage-specific-abundance" class="nav-link" data-scroll-target="#b.-stage-specific-abundance"><span class="header-section-number">8.2</span> 10b. Stage-specific abundance</a></li>
  <li><a href="#c.-body-length-measurements" id="toc-c.-body-length-measurements" class="nav-link" data-scroll-target="#c.-body-length-measurements"><span class="header-section-number">8.3</span> 10c. Body length measurements</a></li>
  <li><a href="#d.-bottle-measurements" id="toc-d.-bottle-measurements" class="nav-link" data-scroll-target="#d.-bottle-measurements"><span class="header-section-number">8.4</span> 10d. Bottle measurements</a></li>
  <li><a href="#e.-cast-conditions" id="toc-e.-cast-conditions" class="nav-link" data-scroll-target="#e.-cast-conditions"><span class="header-section-number">8.5</span> 10e. Cast conditions</a></li>
  <li><a href="#combine-all-emof-records" id="toc-combine-all-emof-records" class="nav-link" data-scroll-target="#combine-all-emof-records"><span class="header-section-number">8.6</span> Combine All eMoF Records</a></li>
  </ul></li>
  <li><a href="#write-darwincore-archive-files" id="toc-write-darwincore-archive-files" class="nav-link" data-scroll-target="#write-darwincore-archive-files"><span class="header-section-number">9</span> Write DarwinCore Archive Files</a></li>
  <li><a href="#create-meta.xml" id="toc-create-meta.xml" class="nav-link" data-scroll-target="#create-meta.xml"><span class="header-section-number">10</span> Create meta.xml</a></li>
  <li><a href="#create-eml-metadata" id="toc-create-eml-metadata" class="nav-link" data-scroll-target="#create-eml-metadata"><span class="header-section-number">11</span> Create EML Metadata</a></li>
  <li><a href="#data-quality-checks" id="toc-data-quality-checks" class="nav-link" data-scroll-target="#data-quality-checks"><span class="header-section-number">12</span> Data Quality Checks</a></li>
  <li><a href="#package-darwincore-archive" id="toc-package-darwincore-archive" class="nav-link" data-scroll-target="#package-darwincore-archive"><span class="header-section-number">13</span> Package DarwinCore Archive</a></li>
  <li><a href="#validate-with-obistools" id="toc-validate-with-obistools" class="nav-link" data-scroll-target="#validate-with-obistools"><span class="header-section-number">14</span> Validate with obistools</a></li>
  <li><a href="#cleanup" id="toc-cleanup" class="nav-link" data-scroll-target="#cleanup"><span class="header-section-number">15</span> Cleanup</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Publish Ichthyoplankton &amp; Bottle Data to OBIS</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2026-02-24</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="overview" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="overview"><span class="header-section-number">1</span> Overview</h2>
<p>This workflow converts CalCOFI ichthyoplankton (fish eggs and larvae) and bottle hydrography data to an OBIS-compliant DarwinCore Archive for publication. The archive follows the Event Core structure with Occurrence and ExtendedMeasurementOrFact (eMoF) extensions.</p>
<p><strong>Data source</strong>: merged DuckDB from <code>merge_ichthyo_bottle.qmd</code>, combining:</p>
<ul>
<li>SWFSC ichthyoplankton tables (cruise, ship, site, tow, net, ichthyo, species, lookup)</li>
<li>CalCOFI.org bottle tables (casts, bottle, bottle_measurement, cast_condition, measurement_type)</li>
</ul>
<p><strong>References</strong>: <a href="https://calcofi.org/data/marine-ecosystem-data/fish-eggs-larvae/">CalCOFI Fish Eggs &amp; Larvae</a> | <a href="https://calcofi.org/data/oceanographic-data/bottle-database/">CalCOFI Bottle Database</a> | <a href="https://manual.obis.org/">OBIS Manual</a> | <a href="https://dwc.tdwg.org/terms/">DarwinCore Terms</a></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  CalCOFI<span class="sc">/</span>calcofi4db,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  DBI,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  dplyr,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  DT,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  duckdb,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  EML,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  glue,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  here,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  lubridate,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  iobis<span class="sc">/</span>obistools,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  purrr,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  stringr,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  readr,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  tibble,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  tidyr,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  uuid,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  xml2,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">quiet =</span> T)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">readr.show_col_types =</span> F)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># calcofi namespace for deterministic UUID v5 generation</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>CALCOFI_NS <span class="ot">&lt;-</span> <span class="st">"c0f1ca00-ca1c-5000-b000-1c4790000000"</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># dataset metadata ----</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>dataset_title <span class="ot">&lt;-</span> <span class="st">"CalCOFI Ichthyoplankton Tows &amp; Bottle Hydrography"</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>dataset_abstract <span class="ot">&lt;-</span> <span class="st">"Fish larvae and egg counts from CalCOFI ichthyoplankton nets (primarily vertical [Calvet or Pairovet], oblique [bongo or ring nets], and surface tows [Manta nets]) combined with CTD rosette bottle hydrography (temperature, salinity, dissolved oxygen, nutrients, chlorophyll, and carbon system parameters). Oblique tows are normally standardized to count per 10 m^2 of surface sampled. Surface tows are normally standardized to count per 1,000 m^3 strained. Bottle data include depth-resolved measurements from Niskin bottles on CTD casts at CalCOFI grid stations."</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>dataset_keywords <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"atmosphere"</span>,</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">"biology"</span>,</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"biosphere"</span>,</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  <span class="st">"calcofi"</span>,</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"earth science"</span>,</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"environment"</span>,</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  <span class="st">"hydrography"</span>,</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ichthyoplankton"</span>,</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  <span class="st">"latitude"</span>,</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>  <span class="st">"longitude"</span>,</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  <span class="st">"nutrients"</span>,</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ocean"</span>,</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  <span class="st">"time"</span>)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>country_code <span class="ot">&lt;-</span> <span class="st">"US"</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>water_body   <span class="ot">&lt;-</span> <span class="st">"California Current"</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>dataset_id <span class="ot">&lt;-</span> <span class="fu">glue</span>(</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  <span class="st">"calcofi.io_workflow_ichthyo-bottle_to_obis_{format(Sys.Date(), '%Y-%m-%d')}"</span>)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>sampling_methods_description <span class="ot">&lt;-</span> <span class="st">"Standard CalCOFI ichthyoplankton tows: The standard oblique tow uses a bongo net (71 cm diameter, 0.505 mm mesh) or 1-m ring net (prior to 1978) retrieved at a constant wire angle (45 degrees) from 210 m depth to surface. Surface tows use a Manta net; vertical tows use CalVET/Pairovet nets. Flowmeters measure volume filtered. Samples are preserved in 5% formalin. Fish eggs and larvae are sorted, identified to lowest taxon possible, enumerated, and measured. CTD bottle data: Seawater samples collected using Niskin bottles mounted on a CTD rosette cast to near-bottom depths. Temperature, salinity, and dissolved oxygen are measured by CTD sensors and calibrated against bottle samples. Nutrient concentrations (phosphate, silicate, nitrite, nitrate, ammonia) determined by autoanalyzer. Chlorophyll-a and phaeopigment measured fluorometrically."</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>study_extent_description <span class="ot">&lt;-</span> <span class="st">"The study covers the California Current ecosystem, primarily off Southern California (standard lines 77-93) but historically extending from the border of Canada to the tip of Baja California. The time series for this dataset generally begins in 1949 for bottle data and 1951 for ichthyoplankton, continuing to the present with quarterly cruises."</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>sampling_description <span class="ot">&lt;-</span> <span class="st">"Samples are collected at fixed stations along the CalCOFI grid. Oblique tows are standardized to counts per 10 m^2 of sea surface. Surface tows are standardized to counts per 1,000 m^3. Bottle hydrography data provide depth-resolved oceanographic context at the same grid stations."</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>funding_information <span class="ot">&lt;-</span> <span class="st">"CalCOFI is a partnership between the NOAA National Marine Fisheries Service (NMFS), Scripps Institution of Oceanography (SIO), and California Department of Fish and Wildlife (CDFW)."</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>rights <span class="ot">&lt;-</span> <span class="st">"The data may be used and redistributed for free but is not intended for legal use, since it may contain inaccuracies. Neither the data Contributor, ERD, NOAA, nor the United States Government, nor any of their employees or contractors, makes any warranty, express or implied, including warranties of merchantability and fitness for a particular purpose, or assumes any legal liability for the accuracy, completeness, or usefulness, of this information."</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>license <span class="ot">&lt;-</span> <span class="st">"To the extent possible under law, the publisher has waived all rights to these data and has dedicated them to the Public Domain (CC0 1.0). Users may copy, modify, distribute and use the work, including for commercial purposes, without restriction."</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>license_xml <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Public Domain (CC0 1.0)"</span> <span class="ot">=</span> <span class="st">'&lt;ulink url="http://creativecommons.org/publicdomain/zero/1.0/legalcode"&gt;&lt;citetitle&gt;Public Domain (CC0 1.0)&lt;/citetitle&gt;&lt;/ulink&gt;'</span>)</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>intellectual_rights <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">para =</span> <span class="fu">paste</span>(rights, license, <span class="at">collapse =</span> <span class="st">" "</span>))</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>dir_out <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/darwincore/ichthyo_bottle"</span>)</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="co"># get merged duckdb connection ----</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>db_path <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/wrangling/merge_ichthyo_bottle.duckdb"</span>)</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">file.exists</span>(db_path))</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">duckdb</span>(), <span class="at">dbdir =</span> db_path, <span class="at">read_only =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="event-hierarchy-design" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="event-hierarchy-design"><span class="header-section-number">2</span> Event Hierarchy Design</h2>
<p>The archive uses a <strong>sibling-event architecture</strong>: ichthyoplankton net tows and CTD bottle casts are both children of cruise events, linked spatially via <code>locationID</code> (CalCOFI <code>line_station</code> format) rather than nested within each other. This avoids falsely implying that bottle measurements were co-located with specific net tows — they happen at the same station but at different times and depths.</p>
<div class="cell" data-file="diagrams/ichthyo_bottle_event_hierarchy.mmd" data-layout-align="default">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>graph TD</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    A["Cruise Event&lt;br/&gt;(eventID = cruise_key)"] --&gt;|parentEventID| B["Net Sample Event&lt;br/&gt;(eventID = net_uuid)"]</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    A --&gt;|parentEventID| C["CTD Cast Event&lt;br/&gt;(eventID = cast_uuid)"]</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    B --&gt;|eventID| D[Occurrence Records&lt;br/&gt;ichthyo tally]</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    B --&gt;|eventID| E["eMoF: Net Sample&lt;br/&gt;(std_haul_factor, prop_sorted,&lt;br/&gt;plankton biomass)"]</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    D --&gt;|occurrenceID| F["eMoF: Stage Abundance&lt;br/&gt;&amp; Body Length"]</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    C --&gt;|eventID| G["eMoF: Bottle Measurements&lt;br/&gt;(temperature, salinity,&lt;br/&gt;O2, nutrients, ...)"]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    C --&gt;|eventID| H["eMoF: Cast Conditions&lt;br/&gt;(wave, wind, weather, ...)"]</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    B -.-|locationID| C</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    A:::cruise</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    B:::net</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    C:::cast</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    D:::occurrence</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    E:::measurement</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    F:::measurement</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    G:::measurement</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    H:::measurement</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    classDef cruise fill:#e1f5ff,stroke:#0066cc,stroke-width:2px</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    classDef net fill:#e1ffe1,stroke:#00cc66,stroke-width:2px</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    classDef cast fill:#fff4e1,stroke:#ff9900,stroke-width:2px</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    classDef occurrence fill:#f0e1ff,stroke:#6600cc,stroke-width:2px</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    classDef measurement fill:#ffe1e1,stroke:#cc0000,stroke-width:2px</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    subgraph Event Core</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        A</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>        B</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        C</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    subgraph Extensions</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>        D</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>        E</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>        F</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        G</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        H</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    end</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div id="fig-ichthyo_bottle_event_hierarchy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ichthyo_bottle_event_hierarchy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-ichthyo_bottle_event_hierarchy">graph TD
    A["Cruise Event&lt;br/&gt;(eventID = cruise_key)"] --&gt;|parentEventID| B["Net Sample Event&lt;br/&gt;(eventID = net_uuid)"]
    A --&gt;|parentEventID| C["CTD Cast Event&lt;br/&gt;(eventID = cast_uuid)"]
    B --&gt;|eventID| D[Occurrence Records&lt;br/&gt;ichthyo tally]
    B --&gt;|eventID| E["eMoF: Net Sample&lt;br/&gt;(std_haul_factor, prop_sorted,&lt;br/&gt;plankton biomass)"]
    D --&gt;|occurrenceID| F["eMoF: Stage Abundance&lt;br/&gt;&amp; Body Length"]
    C --&gt;|eventID| G["eMoF: Bottle Measurements&lt;br/&gt;(temperature, salinity,&lt;br/&gt;O2, nutrients, ...)"]
    C --&gt;|eventID| H["eMoF: Cast Conditions&lt;br/&gt;(wave, wind, weather, ...)"]

    B -.-|locationID| C

    A:::cruise
    B:::net
    C:::cast
    D:::occurrence
    E:::measurement
    F:::measurement
    G:::measurement
    H:::measurement

    classDef cruise fill:#e1f5ff,stroke:#0066cc,stroke-width:2px
    classDef net fill:#e1ffe1,stroke:#00cc66,stroke-width:2px
    classDef cast fill:#fff4e1,stroke:#ff9900,stroke-width:2px
    classDef occurrence fill:#f0e1ff,stroke:#6600cc,stroke-width:2px
    classDef measurement fill:#ffe1e1,stroke:#cc0000,stroke-width:2px

    subgraph Event Core
        A
        B
        C
    end

    subgraph Extensions
        D
        E
        F
        G
        H
    end
</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ichthyo_bottle_event_hierarchy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Event hierarchy for CalCOFI ichthyoplankton &amp; bottle data in DarwinCore Archive format.
</figcaption>
</figure>
</div>
</div>
</div>
<p><strong>Key design decisions</strong>:</p>
<ol type="1">
<li><strong>Collapsed hierarchy</strong>: cruise → net_sample / ctd_cast (no intermediate site/tow levels) to avoid event inheritance issues with NA values in the IPT</li>
<li><strong><code>locationID</code></strong>: both net_sample and ctd_cast events share <code>locationID = "{line}_{station}"</code> for spatial joining by OBIS consumers</li>
<li><strong><code>cast_uuid</code></strong>: deterministic UUID v5 minted from <code>cast_id</code> using the CalCOFI namespace — same approach as <code>ichthyo_uuid</code></li>
<li><strong>Occurrence consolidation</strong>: one occurrence per life stage (egg or larva) per species per net sample</li>
<li><strong>eMoF structure</strong>: five sub-tables covering net-level measurements, stage abundance, body length, bottle measurements, and cast conditions</li>
</ol>
</section>
<section id="data-extraction" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="data-extraction"><span class="header-section-number">3</span> Data Extraction</h2>
<p>Load all necessary tables from the merged DuckDB:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ichthyo chain ----</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>tbl_cruise  <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"cruise"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>tbl_ship    <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"ship"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>tbl_site    <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"site"</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>tbl_tow     <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"tow"</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>tbl_net     <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"net"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>tbl_ichthyo <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"ichthyo"</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>tbl_species <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"species"</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>tbl_lookup  <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"lookup"</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># bottle chain ----</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>tbl_casts             <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"casts"</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>tbl_bottle            <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"bottle"</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>tbl_bottle_meas       <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"bottle_measurement"</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>tbl_cast_condition    <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"cast_condition"</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>tbl_measurement_type  <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"measurement_type"</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co"># taxonomy ----</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>tbl_taxon     <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"taxon"</span>)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>tbl_taxa_rank <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"taxa_rank"</span>)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co"># quick counts</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Table row counts:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Table row counts:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (tname <span class="cf">in</span> <span class="fu">c</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"cruise"</span>, <span class="st">"ship"</span>, <span class="st">"site"</span>, <span class="st">"tow"</span>, <span class="st">"net"</span>, <span class="st">"ichthyo"</span>, <span class="st">"species"</span>, <span class="st">"lookup"</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"casts"</span>, <span class="st">"bottle"</span>, <span class="st">"bottle_measurement"</span>, <span class="st">"cast_condition"</span>, <span class="st">"measurement_type"</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"taxon"</span>, <span class="st">"taxa_rank"</span>)) {</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, tname) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"  {tname}: {prettyNum(n, big.mark = ',')}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  cruise: 691 
  ship: 48 
  site: 61,104 
  tow: 75,506 
  net: 76,512 
  ichthyo: 830,873 
  species: 1,144 
  lookup: 26 
  casts: 35,644 
  bottle: 895,371 
  bottle_measurement: 11,135,600 
  cast_condition: 235,513 
  measurement_type: 47 
  taxon: 1,671 
  taxa_rank: 41 </code></pre>
</div>
</div>
</section>
<section id="mint-globally-unique-identifiers" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="mint-globally-unique-identifiers"><span class="header-section-number">4</span> Mint Globally Unique Identifiers</h2>
<p>The merged DuckDB uses integer <code>*_id</code> columns for joins and SWFSC <code>_source_uuid</code> for provenance. For OBIS, we need globally unique, stable identifiers:</p>
<ul>
<li><strong>Net eventID</strong>: use net’s <code>_source_uuid</code> (original SWFSC UUID, unique per net)</li>
<li><strong>Ichthyo occurrenceID / measurementID</strong>: mint deterministic UUID v5 from composite key</li>
<li><strong>Cast eventID</strong>: mint deterministic UUID v5 from <code>cast_id</code></li>
<li><strong>Bottle/cast eMoF measurementID</strong>: mint deterministic UUID v5 from integer IDs</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># collect net table with source UUIDs for eventID ----</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>d_net <span class="ot">&lt;-</span> tbl_net <span class="sc">|&gt;</span> <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">net_uuid =</span> <span class="st">`</span><span class="at">_source_uuid</span><span class="st">`</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">duplicated</span>(d_net<span class="sc">$</span>net_uuid)))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"Net UUIDs: {nrow(d_net)} (all unique)"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Net UUIDs: 76512 (all unique) </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># collect and mint ichthyo UUIDs ----</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>d_ichthyo <span class="ot">&lt;-</span> tbl_ichthyo <span class="sc">|&gt;</span> <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># join net_uuid for composite key</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d_net <span class="sc">|&gt;</span> <span class="fu">select</span>(net_id, net_uuid), <span class="at">by =</span> <span class="st">"net_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">ichthyo_uuid =</span> <span class="fu">UUIDfromName</span>(</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>      CALCOFI_NS,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        net_uuid, <span class="st">"|"</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        species_id, <span class="st">"|"</span>,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        life_stage, <span class="st">"|"</span>,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>(<span class="fu">is.na</span>(measurement_type), <span class="st">""</span>, measurement_type), <span class="st">"|"</span>,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>(<span class="fu">is.na</span>(measurement_value), <span class="st">""</span>, measurement_value))))</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">duplicated</span>(d_ichthyo<span class="sc">$</span>ichthyo_uuid)))</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"Ichthyo UUIDs: {nrow(d_ichthyo)} (all unique)"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Ichthyo UUIDs: 830873 (all unique) </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># collect casts and mint cast_uuid ----</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>d_casts <span class="ot">&lt;-</span> tbl_casts <span class="sc">|&gt;</span> <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">cast_uuid =</span> <span class="fu">UUIDfromName</span>(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>      CALCOFI_NS,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"cast:"</span>, cast_id)))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">duplicated</span>(d_casts<span class="sc">$</span>cast_uuid)))</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"Cast UUIDs: {nrow(d_casts)} (all unique)"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Cast UUIDs: 35644 (all unique) </code></pre>
</div>
</div>
</section>
<section id="life-stage-vocabulary" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="life-stage-vocabulary"><span class="header-section-number">5</span> Life Stage Vocabulary</h2>
<p>Define mappings for egg and larva developmental stages to descriptive terms:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># P06 measurement unit vocabulary (NERC) ----</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>measurement_unit_vocab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">measurementUnit =</span> <span class="fu">c</span>(</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"individuals"</span>, <span class="st">"millimeters"</span>, <span class="st">"dimensionless"</span>, <span class="st">"cubic meters"</span>,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"grams"</span>, <span class="st">"proportion"</span>, <span class="st">"m^3"</span>,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"degC"</span>, <span class="st">"PSS-78"</span>, <span class="st">"ml/L"</span>, <span class="st">"umol/kg"</span>, <span class="st">"%"</span>, <span class="st">"kg/m3"</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ug/L"</span>, <span class="st">"umol/L"</span>, <span class="st">"mgC/m3/hld"</span>,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"degrees"</span>, <span class="st">"feet"</span>, <span class="st">"seconds"</span>, <span class="st">"knots"</span>, <span class="st">"millibars"</span>,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"oktas"</span>, <span class="st">"meters"</span>, <span class="st">"Forel-Ule"</span>, <span class="st">"pH"</span>,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"10^-8 m3/kg"</span>, <span class="st">"dyn m"</span>),</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">measurementUnitID =</span> <span class="fu">c</span>(</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,  <span class="co"># individuals</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UXMM/"</span>,  <span class="co"># millimeters</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,  <span class="co"># dimensionless</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/MCUB/"</span>,  <span class="co"># cubic meters</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UGRM/"</span>,  <span class="co"># grams</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,  <span class="co"># proportion</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/MCUB/"</span>,  <span class="co"># m^3</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UPAA/"</span>,  <span class="co"># degC</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UGKG/"</span>,  <span class="co"># PSS-78</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UMLL/"</span>,  <span class="co"># ml/L</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UMKG/"</span>,  <span class="co"># umol/kg</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UPCT/"</span>,  <span class="co"># %</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UKGM/"</span>,  <span class="co"># kg/m3</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UGPL/"</span>,  <span class="co"># ug/L</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UPOX/"</span>,  <span class="co"># umol/L</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,  <span class="co"># mgC/m3/hld (no std P06)</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UAAA/"</span>,  <span class="co"># degrees</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UXFT/"</span>,  <span class="co"># feet</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UTBB/"</span>,  <span class="co"># seconds</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UKNT/"</span>,  <span class="co"># knots</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UPML/"</span>,  <span class="co"># millibars</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,  <span class="co"># oktas (no std P06)</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/ULAA/"</span>,  <span class="co"># meters</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,  <span class="co"># Forel-Ule (no std P06)</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,  <span class="co"># pH</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,  <span class="co"># 10^-8 m3/kg</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>))  <span class="co"># dyn m</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a><span class="co"># NERC P01 vocabulary for bottle measurement types ----</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>bottle_p01_vocab <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>measurement_type,     <span class="sc">~</span>measurementTypeID,</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>  <span class="st">"temperature"</span>,         <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/TEMPPR01/"</span>,</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>  <span class="st">"salinity"</span>,            <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/PSALST01/"</span>,</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>  <span class="st">"oxygen_ml_l"</span>,         <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/DOXYZZXX/"</span>,</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>  <span class="st">"oxygen_umol_kg"</span>,      <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/DLOXYUMK/"</span>,</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>  <span class="st">"oxygen_saturation"</span>,   <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/OXYSSC01/"</span>,</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sigma_theta"</span>,         <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/SIGTEQ01/"</span>,</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>  <span class="st">"chlorophyll_a"</span>,       <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/CPHLPR01/"</span>,</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>  <span class="st">"phaeopigment"</span>,        <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/PHAEFLUO/"</span>,</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>  <span class="st">"phosphate"</span>,           <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/PHOSZZXX/"</span>,</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>  <span class="st">"silicate"</span>,            <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/SLCAZZXX/"</span>,</span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>  <span class="st">"nitrite"</span>,             <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/NTRIZZXX/"</span>,</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>  <span class="st">"nitrate"</span>,             <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/NTRAZZXX/"</span>,</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ammonia"</span>,             <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/AMOAZZXX/"</span>,</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>  <span class="st">"c14_rep1"</span>,            <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/OLOCSMP1/"</span>,</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>  <span class="st">"c14_rep2"</span>,            <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/OLOCSMP1/"</span>,</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>  <span class="st">"c14_dark"</span>,            <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/OLOCSMP1/"</span>,</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>  <span class="st">"c14_mean"</span>,            <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/OLOCSMP1/"</span>,</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>  <span class="st">"light_pct"</span>,           <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/IRRDSV01/"</span>,</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dic_rep1"</span>,            <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/DICATSWT/"</span>,</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dic_rep2"</span>,            <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/DICATSWT/"</span>,</span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>  <span class="st">"alkalinity_rep1"</span>,     <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/MDMAP014/"</span>,</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>  <span class="st">"alkalinity_rep2"</span>,     <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/MDMAP014/"</span>,</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ph_rep1"</span>,             <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/PHXXZZXX/"</span>,</span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ph_rep2"</span>,             <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/PHXXZZXX/"</span>,</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>  <span class="st">"r_depth"</span>,             <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/ADEPZZ01/"</span>,</span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>  <span class="st">"r_temperature"</span>,       <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/TEMPPR01/"</span>,</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>  <span class="st">"r_salinity_sva"</span>,      <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/SVELXXXX/"</span>,</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>  <span class="st">"r_dynamic_height"</span>,    <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/DYNHTTAU/"</span>,</span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>  <span class="st">"r_ammonium"</span>,          <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/AMOAZZXX/"</span>,</span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>  <span class="st">"r_oxygen_umol_kg"</span>,    <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/DLOXYUMK/"</span>)</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a><span class="co"># NERC P01 vocabulary for cast condition types ----</span></span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>cast_p01_vocab <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>condition_type,       <span class="sc">~</span>measurementTypeID,</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wave_direction"</span>,      <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/GWDRZZ01/"</span>,</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wave_height"</span>,         <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/GAVHZZ01/"</span>,</span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wave_period"</span>,         <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/GAVTZZ01/"</span>,</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wind_direction"</span>,      <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/EWDAZZ01/"</span>,</span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wind_speed"</span>,          <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/EWSBZZ01/"</span>,</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>  <span class="st">"barometric_pressure"</span>, <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/CAPAZZ01/"</span>,</span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dry_air_temp"</span>,        <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/CTMPZZ01/"</span>,</span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wet_air_temp"</span>,        <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/CWETZZ01/"</span>,</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>  <span class="st">"weather_code"</span>,        <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/WMOCWWXX/"</span>,</span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>  <span class="st">"cloud_type"</span>,          <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/WMOCLTXX/"</span>,</span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>  <span class="st">"cloud_amount"</span>,        <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/CLAMAMTS/"</span>,</span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>  <span class="st">"visibility"</span>,          <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/WMOVISXX/"</span>,</span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>  <span class="st">"secchi_depth"</span>,        <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/SECCSDNX/"</span>,</span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>  <span class="st">"water_color"</span>,         <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/CCOLXXXX/"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="build-event-hierarchy" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="build-event-hierarchy"><span class="header-section-number">6</span> Build Event Hierarchy</h2>
<section id="cruise-events" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="cruise-events"><span class="header-section-number">6.1</span> Cruise Events</h3>
<p>Aggregate over both net tows and casts to build cruise-level events:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># collect joined net→tow→site for cruise summaries ----</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>d_net_site <span class="ot">&lt;-</span> d_net <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    tbl_tow <span class="sc">|&gt;</span> <span class="fu">collect</span>() <span class="sc">|&gt;</span> <span class="fu">select</span>(tow_id, site_id, time_start),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"tow_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    tbl_site <span class="sc">|&gt;</span> <span class="fu">collect</span>() <span class="sc">|&gt;</span> <span class="fu">select</span>(site_id, cruise_key, longitude, latitude, line, station),</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"site_id"</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># net cruise summaries ----</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>d_net_cruise_summary <span class="ot">&lt;-</span> d_net_site <span class="sc">|&gt;</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cruise_key) <span class="sc">|&gt;</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">net_time_min =</span> <span class="fu">min</span>(time_start, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">net_time_max =</span> <span class="fu">max</span>(time_start, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">net_lon_min  =</span> <span class="fu">min</span>(longitude,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">net_lon_max  =</span> <span class="fu">max</span>(longitude,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">net_lat_min  =</span> <span class="fu">min</span>(latitude,   <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">net_lat_max  =</span> <span class="fu">max</span>(latitude,   <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="co"># cast cruise summaries ----</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>d_cast_cruise_summary <span class="ot">&lt;-</span> d_casts <span class="sc">|&gt;</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cruise_key) <span class="sc">|&gt;</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">cast_time_min =</span> <span class="fu">min</span>(datetime_utc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">cast_time_max =</span> <span class="fu">max</span>(datetime_utc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">cast_lon_min  =</span> <span class="fu">min</span>(lon_dec,      <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">cast_lon_max  =</span> <span class="fu">max</span>(lon_dec,      <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">cast_lat_min  =</span> <span class="fu">min</span>(lat_dec,      <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">cast_lat_max  =</span> <span class="fu">max</span>(lat_dec,      <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="co"># combine cruise metadata ----</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>d_cruise_events <span class="ot">&lt;-</span> tbl_cruise <span class="sc">|&gt;</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_ship, <span class="at">by =</span> <span class="st">"ship_key"</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d_net_cruise_summary,  <span class="at">by =</span> <span class="st">"cruise_key"</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d_cast_cruise_summary, <span class="at">by =</span> <span class="st">"cruise_key"</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># date range: union of net tows and casts</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_min =</span> <span class="fu">pmin</span>(net_time_min, cast_time_min, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_max =</span> <span class="fu">pmax</span>(net_time_max, cast_time_max, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># bounding box: union of net sites and cast positions</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon_min =</span> <span class="fu">pmin</span>(net_lon_min, cast_lon_min, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon_max =</span> <span class="fu">pmax</span>(net_lon_max, cast_lon_max, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat_min =</span> <span class="fu">pmin</span>(net_lat_min, cast_lat_min, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat_max =</span> <span class="fu">pmax</span>(net_lat_max, cast_lat_max, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(time_min) <span class="sc">|</span> <span class="sc">!</span><span class="fu">is.na</span>(cast_time_min)) <span class="sc">|&gt;</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID          =</span> cruise_key,</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">parentEventID    =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType        =</span> <span class="st">"cruise"</span>,</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventDate        =</span> <span class="fu">case_when</span>(</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(time_min) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(time_max) <span class="sc">~</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste0</span>(</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>          <span class="fu">format</span>(time_min, <span class="st">"%Y-%m-%dT%H:%M:%SZ"</span>), <span class="st">"/"</span>,</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>          <span class="fu">format</span>(time_max, <span class="st">"%Y-%m-%dT%H:%M:%SZ"</span>)),</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span>),</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">footprintWKT     =</span> <span class="fu">case_when</span>(</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(lon_min) <span class="sc">~</span></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>        <span class="fu">glue</span>(<span class="st">"POLYGON(({lon_min} {lat_min}, {lon_max} {lat_min}, {lon_max} {lat_max}, {lon_min} {lat_max}, {lon_min} {lat_min}))"</span>),</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span>),</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="st">"Marine plankton survey cruise"</span>,</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">habitat          =</span> <span class="st">"marine"</span>,</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks     =</span> <span class="fu">glue</span>(<span class="st">"Cruise on {ship_name} from {as.Date(time_min)} to {as.Date(time_max)}"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>    eventID, parentEventID, eventType, eventDate, footprintWKT,</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>    samplingProtocol, habitat, eventRemarks)</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"Cruise events: {nrow(d_cruise_events)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Cruise events: 687 </code></pre>
</div>
</div>
</section>
<section id="net-sample-events" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="net-sample-events"><span class="header-section-number">6.2</span> Net Sample Events</h3>
<p>Collapsed net_sample events (cruise → net_sample) with coordinates, date, and sampling info:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>d_net_events <span class="ot">&lt;-</span> d_net_site <span class="sc">|&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID          =</span> net_uuid,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">parentEventID    =</span> cruise_key,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType        =</span> <span class="st">"net_sample"</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventDate        =</span> <span class="fu">format</span>(time_start, <span class="st">"%Y-%m-%dT%H:%M:%SZ"</span>),</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimalLatitude  =</span> latitude,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimalLongitude =</span> longitude,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">locationID       =</span> <span class="fu">paste0</span>(line, <span class="st">"_"</span>, station),</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="st">"CalCOFI ichthyoplankton net tow"</span>,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeValue  =</span> vol_sampled_m3,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeUnit   =</span> <span class="st">"m^3"</span>,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks     =</span> <span class="fu">glue</span>(</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Net: {side} side; "</span>,</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">"{prop_sorted} proportion sorted of {vol_sampled_m3} m3 sampled"</span>))</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co"># keep full data for eMoF</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>d_net_events_full <span class="ot">&lt;-</span> d_net_events</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>d_net_events <span class="ot">&lt;-</span> d_net_events <span class="sc">|&gt;</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    eventID, parentEventID, eventType, eventDate,</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    decimalLatitude, decimalLongitude, locationID,</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    samplingProtocol, sampleSizeValue, sampleSizeUnit, eventRemarks)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">duplicated</span>(d_net_events<span class="sc">$</span>eventID)))</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"Net sample events: {nrow(d_net_events)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Net sample events: 76512 </code></pre>
</div>
</div>
</section>
<section id="ctd-cast-events" class="level3" data-number="6.3">
<h3 data-number="6.3" class="anchored" data-anchor-id="ctd-cast-events"><span class="header-section-number">6.3</span> CTD Cast Events</h3>
<p>One event per cast:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>d_cast_events <span class="ot">&lt;-</span> d_casts <span class="sc">|&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID          =</span> cast_uuid,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">parentEventID    =</span> cruise_key,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType        =</span> <span class="st">"ctd_cast"</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventDate        =</span> <span class="fu">format</span>(datetime_utc, <span class="st">"%Y-%m-%dT%H:%M:%SZ"</span>),</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimalLatitude  =</span> lat_dec,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimalLongitude =</span> lon_dec,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">locationID       =</span> <span class="fu">paste0</span>(rpt_line, <span class="st">"_"</span>, rpt_sta),</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="st">"CTD rosette cast"</span>,</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeValue  =</span> bottom_depth_m,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeUnit   =</span> <span class="st">"m"</span>,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks     =</span> <span class="fu">glue</span>(</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CTD cast at station {rpt_line}_{rpt_sta}, bottom depth {bottom_depth_m} m"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    eventID, parentEventID, eventType, eventDate,</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    decimalLatitude, decimalLongitude, locationID,</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    samplingProtocol, sampleSizeValue, sampleSizeUnit, eventRemarks)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">duplicated</span>(d_cast_events<span class="sc">$</span>eventID)))</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"CTD cast events: {nrow(d_cast_events)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CTD cast events: 35644 </code></pre>
</div>
</div>
</section>
<section id="combine-all-events" class="level3" data-number="6.4">
<h3 data-number="6.4" class="anchored" data-anchor-id="combine-all-events"><span class="header-section-number">6.4</span> Combine All Events</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>d_event <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  d_cruise_events,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  d_net_events,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  d_cast_events) <span class="sc">|&gt;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">geodeticDatum                 =</span> <span class="st">"WGS84"</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">coordinateUncertaintyInMeters =</span> <span class="dv">1000</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">countryCode                   =</span> country_code,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">waterBody                     =</span> water_body,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasetID                     =</span> dataset_id)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Event counts by type:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Event counts by type:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>d_event <span class="sc">|&gt;</span> <span class="fu">count</span>(eventType) <span class="sc">|&gt;</span> <span class="fu">print</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  eventType      n
  &lt;chr&gt;      &lt;int&gt;
1 cruise       687
2 ctd_cast   35644
3 net_sample 76512</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># verify all child events have valid parentEventID</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>cruise_ids <span class="ot">&lt;-</span> d_event <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"cruise"</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(eventID)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>child_events <span class="ot">&lt;-</span> d_event <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">!=</span> <span class="st">"cruise"</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>orphan_children <span class="ot">&lt;-</span> child_events <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>parentEventID <span class="sc">%in%</span> cruise_ids)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(orphan_children) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="fu">glue</span>(<span class="st">"{nrow(orphan_children)} child events have no matching cruise parent"</span>))</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"All child events have valid cruise parents.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
</section>
<section id="build-occurrence-records" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="build-occurrence-records"><span class="header-section-number">7</span> Build Occurrence Records</h2>
<p>From the consolidated <code>ichthyo</code> table — one occurrence per life stage per species per net sample (tally rows where <code>measurement_type</code> is NULL):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>d_occurrence <span class="ot">&lt;-</span> d_ichthyo <span class="sc">|&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(measurement_type)) <span class="sc">|&gt;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    tbl_species <span class="sc">|&gt;</span> <span class="fu">collect</span>(),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"species_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID         =</span> ichthyo_uuid,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID              =</span> net_uuid,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificName       =</span> scientific_name,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificNameID     =</span> <span class="fu">ifelse</span>(</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(worms_id) <span class="sc">&amp;</span> worms_id <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"urn:lsid:marinespecies.org:taxname:"</span>, worms_id),</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NA_character_</span>),</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">kingdom              =</span> <span class="st">"Animalia"</span>,</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceStatus     =</span> <span class="fu">ifelse</span>(tally <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"present"</span>, <span class="st">"absent"</span>),</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantity     =</span> tally,</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantityType =</span> <span class="st">"individuals"</span>,</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">lifeStage            =</span> life_stage,</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">preparations         =</span> <span class="fu">paste0</span>(life_stage, <span class="st">" sample"</span>),</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">basisOfRecord        =</span> <span class="st">"HumanObservation"</span>,</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">modified             =</span> <span class="fu">Sys.Date</span>())</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="co"># verify all occurrences link to valid net_sample events</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>net_ids <span class="ot">&lt;-</span> d_net_events <span class="sc">|&gt;</span> <span class="fu">pull</span>(eventID)</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>orphan_occs <span class="ot">&lt;-</span> d_occurrence <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>eventID <span class="sc">%in%</span> net_ids)</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(orphan_occs) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="fu">glue</span>(<span class="st">"{nrow(orphan_occs)} occurrences have no matching net_sample event"</span>))</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"All occurrences link to valid net_sample events.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>All occurrences link to valid net_sample events.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>d_occurrence_out <span class="ot">&lt;-</span> d_occurrence <span class="sc">|&gt;</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    occurrenceID, eventID, scientificName, scientificNameID,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    kingdom, occurrenceStatus, organismQuantity, organismQuantityType,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    lifeStage, preparations, basisOfRecord, modified)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"Occurrences: {nrow(d_occurrence_out)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Occurrences: 463655 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"Unique species: {n_distinct(d_occurrence_out$scientificName)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Unique species: 899 </code></pre>
</div>
</div>
</section>
<section id="build-extendedmeasurementorfact-extension" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="build-extendedmeasurementorfact-extension"><span class="header-section-number">8</span> Build ExtendedMeasurementOrFact Extension</h2>
<section id="a.-net-level-sample-measurements" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="a.-net-level-sample-measurements"><span class="header-section-number">8.1</span> 10a. Net-level sample measurements</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>d_emof_net <span class="ot">&lt;-</span> d_net_events_full <span class="sc">|&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(eventID, net_uuid, std_haul_factor, prop_sorted, smallplankton, totalplankton) <span class="sc">|&gt;</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols      =</span> <span class="fu">c</span>(std_haul_factor, prop_sorted, smallplankton, totalplankton),</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to  =</span> <span class="st">"meas_type"</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"measurementValue"</span>) <span class="sc">|&gt;</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(measurementValue)) <span class="sc">|&gt;</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID =</span> <span class="fu">UUIDfromName</span>(</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>      CALCOFI_NS,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"net:"</span>, net_uuid, <span class="st">":"</span>, meas_type)),</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID     =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType  =</span> <span class="fu">case_when</span>(</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span> <span class="sc">~</span> <span class="st">"standardized haul factor"</span>,</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span>     <span class="sc">~</span> <span class="st">"proportion of sample sorted"</span>,</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"smallplankton"</span>   <span class="sc">~</span> <span class="st">"small plankton biomass"</span>,</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"totalplankton"</span>   <span class="sc">~</span> <span class="st">"total plankton biomass"</span>),</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit  =</span> <span class="fu">case_when</span>(</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span>                         <span class="sc">~</span> <span class="st">"dimensionless"</span>,</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span>                             <span class="sc">~</span> <span class="st">"dimensionless"</span>,</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"smallplankton"</span>, <span class="st">"totalplankton"</span>)     <span class="sc">~</span> <span class="st">"grams"</span>),</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod  =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> <span class="fu">case_when</span>(</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span> <span class="sc">~</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Standardization factor for water filtered; abundances per 10 m^2 (Smith 1977)"</span>,</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span> <span class="sc">~</span> <span class="st">"Fraction of total sample examined"</span>,</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span>)) <span class="sc">|&gt;</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    eventID, occurrenceID, measurementID, measurementType, measurementTypeID,</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>    measurementValue, measurementUnit, measurementUnitID,</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    measurementMethod, measurementRemarks)</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"eMoF net-level: {nrow(d_emof_net)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>eMoF net-level: 243598 </code></pre>
</div>
</div>
</section>
<section id="b.-stage-specific-abundance" class="level3" data-number="8.2">
<h3 data-number="8.2" class="anchored" data-anchor-id="b.-stage-specific-abundance"><span class="header-section-number">8.2</span> 10b. Stage-specific abundance</h3>
<p>From <code>ichthyo</code> rows where <code>measurement_type = 'stage'</code>, linked to the matching tally row’s <code>ichthyo_uuid</code> as <code>occurrenceID</code>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># build lookup: tally occurrenceIDs with their eventID (net_uuid)</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>d_occ_lookup <span class="ot">&lt;-</span> d_occurrence <span class="sc">|&gt;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(net_id, species_id, life_stage,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">occurrenceID =</span> ichthyo_uuid, <span class="at">occ_eventID =</span> eventID)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co"># collect lookup descriptions for stages</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>d_lookup <span class="ot">&lt;-</span> tbl_lookup <span class="sc">|&gt;</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(lookup_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"egg_stage"</span>, <span class="st">"larva_stage"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co"># stage records — join to lookup via derived lookup_type</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>d_emof_stage <span class="ot">&lt;-</span> d_ichthyo <span class="sc">|&gt;</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(measurement_type <span class="sc">==</span> <span class="st">"stage"</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">lookup_type =</span> <span class="fu">paste0</span>(life_stage, <span class="st">"_stage"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    d_lookup <span class="sc">|&gt;</span> <span class="fu">select</span>(lookup_type, lookup_num, description),</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"lookup_type"</span>, <span class="st">"measurement_value"</span> <span class="ot">=</span> <span class="st">"lookup_num"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d_occ_lookup, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"net_id"</span>, <span class="st">"species_id"</span>, <span class="st">"life_stage"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID            =</span> occ_eventID,</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID      =</span> ichthyo_uuid,</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType    =</span> <span class="st">"abundance by life stage"</span>,</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID  =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">meas_val           =</span> tally,</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValueID =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit    =</span> <span class="st">"individuals"</span>,</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod  =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> description) <span class="sc">|&gt;</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>    eventID, occurrenceID, measurementID, measurementType, measurementTypeID,</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue =</span> meas_val, measurementValueID,</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>    measurementUnit, measurementUnitID,</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>    measurementMethod, measurementRemarks)</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"eMoF stage abundance: {nrow(d_emof_stage)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>eMoF stage abundance: 125347 </code></pre>
</div>
</div>
</section>
<section id="c.-body-length-measurements" class="level3" data-number="8.3">
<h3 data-number="8.3" class="anchored" data-anchor-id="c.-body-length-measurements"><span class="header-section-number">8.3</span> 10c. Body length measurements</h3>
<p>From <code>ichthyo</code> rows where <code>measurement_type = 'size'</code>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>d_emof_length <span class="ot">&lt;-</span> d_ichthyo <span class="sc">|&gt;</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(measurement_type <span class="sc">==</span> <span class="st">"size"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d_occ_lookup, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"net_id"</span>, <span class="st">"species_id"</span>, <span class="st">"life_stage"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(measurement_value)) <span class="sc">|&gt;</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID            =</span> occ_eventID,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID      =</span> ichthyo_uuid,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType    =</span> <span class="st">"body length"</span>,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID  =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">meas_val           =</span> measurement_value,</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValueID =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit    =</span> <span class="st">"millimeters"</span>,</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod  =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> <span class="fu">paste0</span>(<span class="st">"Count: "</span>, tally, <span class="st">"; Total length measurement"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    eventID, occurrenceID, measurementID, measurementType, measurementTypeID,</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue =</span> meas_val, measurementValueID,</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    measurementUnit, measurementUnitID,</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    measurementMethod, measurementRemarks)</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"eMoF body length: {nrow(d_emof_length)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>eMoF body length: 241871 </code></pre>
</div>
</div>
</section>
<section id="d.-bottle-measurements" class="level3" data-number="8.4">
<h3 data-number="8.4" class="anchored" data-anchor-id="d.-bottle-measurements"><span class="header-section-number">8.4</span> 10d. Bottle measurements</h3>
<p>From <code>bottle_measurement</code> joined through <code>bottle</code> → <code>casts</code>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># build cast_id → cast_uuid lookup</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>d_cast_uuid_lookup <span class="ot">&lt;-</span> d_casts <span class="sc">|&gt;</span> <span class="fu">select</span>(cast_id, cast_uuid)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># get measurement type descriptions and units</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>d_mtype <span class="ot">&lt;-</span> tbl_measurement_type <span class="sc">|&gt;</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dataset <span class="sc">==</span> <span class="st">"bottle"</span>) <span class="sc">|&gt;</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>d_emof_bottle <span class="ot">&lt;-</span> tbl_bottle_meas <span class="sc">|&gt;</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_bottle <span class="sc">|&gt;</span> <span class="fu">select</span>(bottle_id, cast_id, depth_m), <span class="at">by =</span> <span class="st">"bottle_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(d_cast_uuid_lookup, <span class="at">by =</span> <span class="st">"cast_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d_mtype <span class="sc">|&gt;</span> <span class="fu">select</span>(measurement_type, description, units), <span class="at">by =</span> <span class="st">"measurement_type"</span>) <span class="sc">|&gt;</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(bottle_p01_vocab, <span class="at">by =</span> <span class="st">"measurement_type"</span>) <span class="sc">|&gt;</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID            =</span> cast_uuid,</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID       =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID      =</span> <span class="fu">UUIDfromName</span>(</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>      CALCOFI_NS,</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"bm:"</span>, bottle_measurement_id)),</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType    =</span> description,</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">meas_val           =</span> measurement_value,</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit    =</span> units,</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod  =</span> <span class="st">"https://calcofi.org/data/oceanographic-data/bottle-database/"</span>,</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> <span class="fu">paste0</span>(<span class="st">"depth_m: "</span>, depth_m)) <span class="sc">|&gt;</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>    eventID, occurrenceID, measurementID, measurementType, measurementTypeID,</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue =</span> meas_val,</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    measurementUnit, measurementUnitID,</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>    measurementMethod, measurementRemarks)</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"eMoF bottle measurements: {nrow(d_emof_bottle)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>eMoF bottle measurements: 11135600 </code></pre>
</div>
</div>
</section>
<section id="e.-cast-conditions" class="level3" data-number="8.5">
<h3 data-number="8.5" class="anchored" data-anchor-id="e.-cast-conditions"><span class="header-section-number">8.5</span> 10e. Cast conditions</h3>
<p>From <code>cast_condition</code> joined to <code>casts</code>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>d_emof_cast_cond <span class="ot">&lt;-</span> tbl_cast_condition <span class="sc">|&gt;</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(d_cast_uuid_lookup, <span class="at">by =</span> <span class="st">"cast_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    tbl_measurement_type <span class="sc">|&gt;</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(dataset <span class="sc">==</span> <span class="st">"cast"</span>) <span class="sc">|&gt;</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(measurement_type, description, units),</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"condition_type"</span> <span class="ot">=</span> <span class="st">"measurement_type"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cast_p01_vocab, <span class="at">by =</span> <span class="st">"condition_type"</span>) <span class="sc">|&gt;</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID            =</span> cast_uuid,</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID       =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID      =</span> <span class="fu">UUIDfromName</span>(</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>      CALCOFI_NS,</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"cc:"</span>, cast_condition_id)),</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType    =</span> description,</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue   =</span> condition_value,</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit    =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(units) <span class="sc">|</span> units <span class="sc">==</span> <span class="st">""</span>, <span class="cn">NA_character_</span>, units),</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod  =</span> <span class="st">"https://calcofi.org/data/oceanographic-data/bottle-database/"</span>,</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> <span class="cn">NA_character_</span>) <span class="sc">|&gt;</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>    eventID, occurrenceID, measurementID, measurementType, measurementTypeID,</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>    measurementValue,</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>    measurementUnit, measurementUnitID,</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>    measurementMethod, measurementRemarks)</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"eMoF cast conditions: {nrow(d_emof_cast_cond)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>eMoF cast conditions: 235513 </code></pre>
</div>
</div>
</section>
<section id="combine-all-emof-records" class="level3" data-number="8.6">
<h3 data-number="8.6" class="anchored" data-anchor-id="combine-all-emof-records"><span class="header-section-number">8.6</span> Combine All eMoF Records</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>d_emof <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  d_emof_net,</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  d_emof_stage <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>measurementValueID),</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  d_emof_length <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>measurementValueID),</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  d_emof_bottle,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  d_emof_cast_cond)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"eMoF counts by source:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>eMoF counts by source:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"  Net-level:       {nrow(d_emof_net)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Net-level:       243598 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"  Stage abundance: {nrow(d_emof_stage)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Stage abundance: 125347 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"  Body length:     {nrow(d_emof_length)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Body length:     241871 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"  Bottle meas:     {nrow(d_emof_bottle)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Bottle meas:     11135600 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"  Cast conditions: {nrow(d_emof_cast_cond)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Cast conditions: 235513 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"  Total:           {nrow(d_emof)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Total:           11981929 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># verify all eMoF records link to a valid eventID or occurrenceID</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>event_ids <span class="ot">&lt;-</span> d_event<span class="sc">$</span>eventID</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>occ_ids   <span class="ot">&lt;-</span> d_occurrence_out<span class="sc">$</span>occurrenceID</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>emof_with_event <span class="ot">&lt;-</span> d_emof <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(eventID))</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>emof_with_occ   <span class="ot">&lt;-</span> d_emof <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(occurrenceID))</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>emof_orphan_event <span class="ot">&lt;-</span> emof_with_event <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>eventID <span class="sc">%in%</span> event_ids)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>emof_orphan_occ   <span class="ot">&lt;-</span> emof_with_occ <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>occurrenceID <span class="sc">%in%</span> occ_ids)</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(emof_orphan_event) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="fu">glue</span>(<span class="st">"{nrow(emof_orphan_event)} eMoF records have invalid eventID"</span>))</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(emof_orphan_occ) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="fu">glue</span>(<span class="st">"{nrow(emof_orphan_occ)} eMoF records have invalid occurrenceID"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
</section>
<section id="write-darwincore-archive-files" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="write-darwincore-archive-files"><span class="header-section-number">9</span> Write DarwinCore Archive Files</h2>
<p>Export the event core and extension files as CSV:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(dir_out, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d_event,          <span class="fu">file.path</span>(dir_out, <span class="st">"event.csv"</span>), <span class="at">na =</span> <span class="st">""</span>)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d_occurrence_out, <span class="fu">file.path</span>(dir_out, <span class="st">"occurrence.csv"</span>), <span class="at">na =</span> <span class="st">""</span>)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d_emof,           <span class="fu">file.path</span>(dir_out, <span class="st">"extendedMeasurementOrFact.csv"</span>), <span class="at">na =</span> <span class="st">""</span>)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Wrote CSV files to:"</span>, dir_out, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Wrote CSV files to: /Users/bbest/Github/CalCOFI/workflows/data/darwincore/ichthyo_bottle </code></pre>
</div>
</div>
</section>
<section id="create-meta.xml" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="create-meta.xml"><span class="header-section-number">10</span> Create meta.xml</h2>
<p>Generate <code>meta.xml</code> by mapping CSV column names to DarwinCore term URIs:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DwC term mappings ----</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>dwc_terms <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">event =</span> <span class="fu">list</span>(</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">rowType =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/Event"</span>,</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">idField =</span> <span class="st">"eventID"</span>,</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms =</span> <span class="fu">c</span>(</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventID                       =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventID"</span>,</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">parentEventID                 =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/parentEventID"</span>,</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventType                     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventType"</span>,</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventDate                     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventDate"</span>,</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">samplingProtocol              =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/samplingProtocol"</span>,</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeValue               =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/sampleSizeValue"</span>,</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeUnit                =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/sampleSizeUnit"</span>,</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventRemarks                  =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventRemarks"</span>,</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">habitat                       =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/habitat"</span>,</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">footprintWKT                  =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/footprintWKT"</span>,</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">decimalLatitude               =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/decimalLatitude"</span>,</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">decimalLongitude              =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/decimalLongitude"</span>,</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">geodeticDatum                 =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/geodeticDatum"</span>,</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">coordinateUncertaintyInMeters =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/coordinateUncertaintyInMeters"</span>,</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">locationID                    =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/locationID"</span>,</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">countryCode                   =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/countryCode"</span>,</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">waterBody                     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/waterBody"</span>,</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">datasetID                     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/datasetID"</span>)),</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">occurrence =</span> <span class="fu">list</span>(</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">rowType     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/Occurrence"</span>,</span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">idField     =</span> <span class="st">"occurrenceID"</span>,</span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreIdField =</span> <span class="st">"eventID"</span>,</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms =</span> <span class="fu">c</span>(</span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">occurrenceID         =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceID"</span>,</span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventID              =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventID"</span>,</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">scientificName       =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/scientificName"</span>,</span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">scientificNameID     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/scientificNameID"</span>,</span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">kingdom              =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/kingdom"</span>,</span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">occurrenceStatus     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceStatus"</span>,</span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">organismQuantity     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/organismQuantity"</span>,</span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">organismQuantityType =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/organismQuantityType"</span>,</span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">lifeStage            =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/lifeStage"</span>,</span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">preparations         =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/preparations"</span>,</span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">basisOfRecord        =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/basisOfRecord"</span>,</span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">modified             =</span> <span class="st">"http://purl.org/dc/terms/modified"</span>)),</span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">extendedmeasurementorfact =</span> <span class="fu">list</span>(</span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">rowType     =</span> <span class="st">"http://rs.iobis.org/obis/terms/ExtendedMeasurementOrFact"</span>,</span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">idField     =</span> <span class="st">"measurementID"</span>,</span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreIdField =</span> <span class="st">"eventID"</span>,</span>
<span id="cb58-46"><a href="#cb58-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms =</span> <span class="fu">c</span>(</span>
<span id="cb58-47"><a href="#cb58-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventID            =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventID"</span>,</span>
<span id="cb58-48"><a href="#cb58-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">occurrenceID       =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceID"</span>,</span>
<span id="cb58-49"><a href="#cb58-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementID      =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementID"</span>,</span>
<span id="cb58-50"><a href="#cb58-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementType    =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementType"</span>,</span>
<span id="cb58-51"><a href="#cb58-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementTypeID  =</span> <span class="st">"http://rs.iobis.org/obis/terms/measurementTypeID"</span>,</span>
<span id="cb58-52"><a href="#cb58-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementValue   =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementValue"</span>,</span>
<span id="cb58-53"><a href="#cb58-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementUnit    =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementUnit"</span>,</span>
<span id="cb58-54"><a href="#cb58-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementUnitID  =</span> <span class="st">"http://rs.iobis.org/obis/terms/measurementUnitID"</span>,</span>
<span id="cb58-55"><a href="#cb58-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementMethod  =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementMethod"</span>,</span>
<span id="cb58-56"><a href="#cb58-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementRemarks =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementRemarks"</span>)))</span>
<span id="cb58-57"><a href="#cb58-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-58"><a href="#cb58-58" aria-hidden="true" tabindex="-1"></a><span class="co"># helper functions ----</span></span>
<span id="cb58-59"><a href="#cb58-59" aria-hidden="true" tabindex="-1"></a>create_field_elements <span class="ot">&lt;-</span> <span class="cf">function</span>(csv_file, term_map, <span class="at">coreid_field =</span> <span class="cn">NULL</span>) {</span>
<span id="cb58-60"><a href="#cb58-60" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">read_csv</span>(csv_file, <span class="at">n_max =</span> <span class="dv">0</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>))</span>
<span id="cb58-61"><a href="#cb58-61" aria-hidden="true" tabindex="-1"></a>  field_elements <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="fu">seq_along</span>(col_names), <span class="cf">function</span>(i) {</span>
<span id="cb58-62"><a href="#cb58-62" aria-hidden="true" tabindex="-1"></a>    col <span class="ot">&lt;-</span> col_names[i]</span>
<span id="cb58-63"><a href="#cb58-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(coreid_field) <span class="sc">&amp;&amp;</span> col <span class="sc">==</span> coreid_field) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb58-64"><a href="#cb58-64" aria-hidden="true" tabindex="-1"></a>    term <span class="ot">&lt;-</span> term_map<span class="sc">$</span>terms[[col]]</span>
<span id="cb58-65"><a href="#cb58-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(term)) {</span>
<span id="cb58-66"><a href="#cb58-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">glue</span>(<span class="st">'    &lt;field index="{i-1}" term="{term}"/&gt;'</span>)</span>
<span id="cb58-67"><a href="#cb58-67" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb58-68"><a href="#cb58-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Warning: Column '"</span>, col, <span class="st">"' in "</span>, csv_file, <span class="st">" has no DwC mapping."</span>)</span>
<span id="cb58-69"><a href="#cb58-69" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NULL</span></span>
<span id="cb58-70"><a href="#cb58-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb58-71"><a href="#cb58-71" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb58-72"><a href="#cb58-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="fu">compact</span>(field_elements), <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb58-73"><a href="#cb58-73" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb58-74"><a href="#cb58-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-75"><a href="#cb58-75" aria-hidden="true" tabindex="-1"></a>get_coreid_index <span class="ot">&lt;-</span> <span class="cf">function</span>(csv_file, coreid_field) {</span>
<span id="cb58-76"><a href="#cb58-76" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">read_csv</span>(csv_file, <span class="at">n_max =</span> <span class="dv">0</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>))</span>
<span id="cb58-77"><a href="#cb58-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coreid_field) <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb58-78"><a href="#cb58-78" aria-hidden="true" tabindex="-1"></a>    coreid_field <span class="ot">&lt;-</span> <span class="fu">intersect</span>(coreid_field, col_names)[<span class="dv">1</span>]</span>
<span id="cb58-79"><a href="#cb58-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">which</span>(col_names <span class="sc">==</span> coreid_field) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb58-80"><a href="#cb58-80" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb58-81"><a href="#cb58-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-82"><a href="#cb58-82" aria-hidden="true" tabindex="-1"></a><span class="co"># generate meta.xml ----</span></span>
<span id="cb58-83"><a href="#cb58-83" aria-hidden="true" tabindex="-1"></a>generate_meta_xml <span class="ot">&lt;-</span> <span class="cf">function</span>(dir_out) {</span>
<span id="cb58-84"><a href="#cb58-84" aria-hidden="true" tabindex="-1"></a>  event_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"event.csv"</span>)</span>
<span id="cb58-85"><a href="#cb58-85" aria-hidden="true" tabindex="-1"></a>  event_fields <span class="ot">&lt;-</span> <span class="fu">create_field_elements</span>(event_file, dwc_terms<span class="sc">$</span>event)</span>
<span id="cb58-86"><a href="#cb58-86" aria-hidden="true" tabindex="-1"></a>  event_id_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(</span>
<span id="cb58-87"><a href="#cb58-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(<span class="fu">read_csv</span>(event_file, <span class="at">n_max =</span> <span class="dv">0</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)) <span class="sc">==</span></span>
<span id="cb58-88"><a href="#cb58-88" aria-hidden="true" tabindex="-1"></a>      dwc_terms<span class="sc">$</span>event<span class="sc">$</span>idField) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb58-89"><a href="#cb58-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-90"><a href="#cb58-90" aria-hidden="true" tabindex="-1"></a>  occ_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"occurrence.csv"</span>)</span>
<span id="cb58-91"><a href="#cb58-91" aria-hidden="true" tabindex="-1"></a>  occ_fields <span class="ot">&lt;-</span> <span class="fu">create_field_elements</span>(</span>
<span id="cb58-92"><a href="#cb58-92" aria-hidden="true" tabindex="-1"></a>    occ_file, dwc_terms<span class="sc">$</span>occurrence,</span>
<span id="cb58-93"><a href="#cb58-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreid_field =</span> dwc_terms<span class="sc">$</span>occurrence<span class="sc">$</span>coreIdField)</span>
<span id="cb58-94"><a href="#cb58-94" aria-hidden="true" tabindex="-1"></a>  occ_coreid_idx <span class="ot">&lt;-</span> <span class="fu">get_coreid_index</span>(occ_file, dwc_terms<span class="sc">$</span>occurrence<span class="sc">$</span>coreIdField)</span>
<span id="cb58-95"><a href="#cb58-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-96"><a href="#cb58-96" aria-hidden="true" tabindex="-1"></a>  emof_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"extendedMeasurementOrFact.csv"</span>)</span>
<span id="cb58-97"><a href="#cb58-97" aria-hidden="true" tabindex="-1"></a>  emof_fields <span class="ot">&lt;-</span> <span class="fu">create_field_elements</span>(</span>
<span id="cb58-98"><a href="#cb58-98" aria-hidden="true" tabindex="-1"></a>    emof_file, dwc_terms<span class="sc">$</span>extendedmeasurementorfact,</span>
<span id="cb58-99"><a href="#cb58-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreid_field =</span> dwc_terms<span class="sc">$</span>extendedmeasurementorfact<span class="sc">$</span>coreIdField)</span>
<span id="cb58-100"><a href="#cb58-100" aria-hidden="true" tabindex="-1"></a>  emof_coreid_idx <span class="ot">&lt;-</span> <span class="fu">get_coreid_index</span>(</span>
<span id="cb58-101"><a href="#cb58-101" aria-hidden="true" tabindex="-1"></a>    emof_file, dwc_terms<span class="sc">$</span>extendedmeasurementorfact<span class="sc">$</span>coreIdField)</span>
<span id="cb58-102"><a href="#cb58-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-103"><a href="#cb58-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glue</span>(</span>
<span id="cb58-104"><a href="#cb58-104" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span>
<span id="cb58-105"><a href="#cb58-105" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;archive xmlns="http://rs.tdwg.org/dwc/text/"</span></span>
<span id="cb58-106"><a href="#cb58-106" aria-hidden="true" tabindex="-1"></a><span class="st">         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</span></span>
<span id="cb58-107"><a href="#cb58-107" aria-hidden="true" tabindex="-1"></a><span class="st">         xsi:schemaLocation="http://rs.tdwg.org/dwc/text/ http://rs.tdwg.org/dwc/text/tdwg_dwc_text.xsd"&gt;</span></span>
<span id="cb58-108"><a href="#cb58-108" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;core encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="</span><span class="sc">\\</span><span class="st">n"</span></span>
<span id="cb58-109"><a href="#cb58-109" aria-hidden="true" tabindex="-1"></a><span class="st">        fieldsEnclosedBy=</span><span class="sc">\'</span><span class="st">"</span><span class="sc">\'</span><span class="st"> ignoreHeaderLines="1" rowType="{dwc_terms$event$rowType}"&gt;</span></span>
<span id="cb58-110"><a href="#cb58-110" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;files&gt;</span></span>
<span id="cb58-111"><a href="#cb58-111" aria-hidden="true" tabindex="-1"></a><span class="st">      &lt;location&gt;event.csv&lt;/location&gt;</span></span>
<span id="cb58-112"><a href="#cb58-112" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/files&gt;</span></span>
<span id="cb58-113"><a href="#cb58-113" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;id index="{event_id_idx}" /&gt;</span></span>
<span id="cb58-114"><a href="#cb58-114" aria-hidden="true" tabindex="-1"></a><span class="st">{event_fields}</span></span>
<span id="cb58-115"><a href="#cb58-115" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;/core&gt;</span></span>
<span id="cb58-116"><a href="#cb58-116" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="</span><span class="sc">\\</span><span class="st">n"</span></span>
<span id="cb58-117"><a href="#cb58-117" aria-hidden="true" tabindex="-1"></a><span class="st">             fieldsEnclosedBy=</span><span class="sc">\'</span><span class="st">"</span><span class="sc">\'</span><span class="st"> ignoreHeaderLines="1" rowType="{dwc_terms$occurrence$rowType}"&gt;</span></span>
<span id="cb58-118"><a href="#cb58-118" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;files&gt;</span></span>
<span id="cb58-119"><a href="#cb58-119" aria-hidden="true" tabindex="-1"></a><span class="st">      &lt;location&gt;occurrence.csv&lt;/location&gt;</span></span>
<span id="cb58-120"><a href="#cb58-120" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/files&gt;</span></span>
<span id="cb58-121"><a href="#cb58-121" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;coreid index="{occ_coreid_idx}" /&gt;</span></span>
<span id="cb58-122"><a href="#cb58-122" aria-hidden="true" tabindex="-1"></a><span class="st">{occ_fields}</span></span>
<span id="cb58-123"><a href="#cb58-123" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;/extension&gt;</span></span>
<span id="cb58-124"><a href="#cb58-124" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="</span><span class="sc">\\</span><span class="st">n"</span></span>
<span id="cb58-125"><a href="#cb58-125" aria-hidden="true" tabindex="-1"></a><span class="st">             fieldsEnclosedBy=</span><span class="sc">\'</span><span class="st">"</span><span class="sc">\'</span><span class="st"> ignoreHeaderLines="1" rowType="{dwc_terms$extendedmeasurementorfact$rowType}"&gt;</span></span>
<span id="cb58-126"><a href="#cb58-126" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;files&gt;</span></span>
<span id="cb58-127"><a href="#cb58-127" aria-hidden="true" tabindex="-1"></a><span class="st">      &lt;location&gt;extendedMeasurementOrFact.csv&lt;/location&gt;</span></span>
<span id="cb58-128"><a href="#cb58-128" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/files&gt;</span></span>
<span id="cb58-129"><a href="#cb58-129" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;coreid index="{emof_coreid_idx}" /&gt;</span></span>
<span id="cb58-130"><a href="#cb58-130" aria-hidden="true" tabindex="-1"></a><span class="st">{emof_fields}</span></span>
<span id="cb58-131"><a href="#cb58-131" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;/extension&gt;</span></span>
<span id="cb58-132"><a href="#cb58-132" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/archive&gt;'</span>)</span>
<span id="cb58-133"><a href="#cb58-133" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb58-134"><a href="#cb58-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-135"><a href="#cb58-135" aria-hidden="true" tabindex="-1"></a>meta_xml <span class="ot">&lt;-</span> <span class="fu">generate_meta_xml</span>(dir_out)</span>
<span id="cb58-136"><a href="#cb58-136" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(meta_xml, <span class="fu">file.path</span>(dir_out, <span class="st">"meta.xml"</span>))</span>
<span id="cb58-137"><a href="#cb58-137" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Generated meta.xml</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Generated meta.xml</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(meta_xml)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;archive xmlns="http://rs.tdwg.org/dwc/text/"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://rs.tdwg.org/dwc/text/ http://rs.tdwg.org/dwc/text/tdwg_dwc_text.xsd"&gt;
  &lt;core encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="\n"
        fieldsEnclosedBy='"' ignoreHeaderLines="1" rowType="http://rs.tdwg.org/dwc/terms/Event"&gt;
    &lt;files&gt;
      &lt;location&gt;event.csv&lt;/location&gt;
    &lt;/files&gt;
    &lt;id index="0" /&gt;
    &lt;field index="0" term="http://rs.tdwg.org/dwc/terms/eventID"/&gt;
    &lt;field index="1" term="http://rs.tdwg.org/dwc/terms/parentEventID"/&gt;
    &lt;field index="2" term="http://rs.tdwg.org/dwc/terms/eventType"/&gt;
    &lt;field index="3" term="http://rs.tdwg.org/dwc/terms/eventDate"/&gt;
    &lt;field index="4" term="http://rs.tdwg.org/dwc/terms/footprintWKT"/&gt;
    &lt;field index="5" term="http://rs.tdwg.org/dwc/terms/samplingProtocol"/&gt;
    &lt;field index="6" term="http://rs.tdwg.org/dwc/terms/habitat"/&gt;
    &lt;field index="7" term="http://rs.tdwg.org/dwc/terms/eventRemarks"/&gt;
    &lt;field index="8" term="http://rs.tdwg.org/dwc/terms/decimalLatitude"/&gt;
    &lt;field index="9" term="http://rs.tdwg.org/dwc/terms/decimalLongitude"/&gt;
    &lt;field index="10" term="http://rs.tdwg.org/dwc/terms/locationID"/&gt;
    &lt;field index="11" term="http://rs.tdwg.org/dwc/terms/sampleSizeValue"/&gt;
    &lt;field index="12" term="http://rs.tdwg.org/dwc/terms/sampleSizeUnit"/&gt;
    &lt;field index="13" term="http://rs.tdwg.org/dwc/terms/geodeticDatum"/&gt;
    &lt;field index="14" term="http://rs.tdwg.org/dwc/terms/coordinateUncertaintyInMeters"/&gt;
    &lt;field index="15" term="http://rs.tdwg.org/dwc/terms/countryCode"/&gt;
    &lt;field index="16" term="http://rs.tdwg.org/dwc/terms/waterBody"/&gt;
    &lt;field index="17" term="http://rs.tdwg.org/dwc/terms/datasetID"/&gt;
  &lt;/core&gt;
  &lt;extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="\n"
             fieldsEnclosedBy='"' ignoreHeaderLines="1" rowType="http://rs.tdwg.org/dwc/terms/Occurrence"&gt;
    &lt;files&gt;
      &lt;location&gt;occurrence.csv&lt;/location&gt;
    &lt;/files&gt;
    &lt;coreid index="1" /&gt;
    &lt;field index="0" term="http://rs.tdwg.org/dwc/terms/occurrenceID"/&gt;
    &lt;field index="2" term="http://rs.tdwg.org/dwc/terms/scientificName"/&gt;
    &lt;field index="3" term="http://rs.tdwg.org/dwc/terms/scientificNameID"/&gt;
    &lt;field index="4" term="http://rs.tdwg.org/dwc/terms/kingdom"/&gt;
    &lt;field index="5" term="http://rs.tdwg.org/dwc/terms/occurrenceStatus"/&gt;
    &lt;field index="6" term="http://rs.tdwg.org/dwc/terms/organismQuantity"/&gt;
    &lt;field index="7" term="http://rs.tdwg.org/dwc/terms/organismQuantityType"/&gt;
    &lt;field index="8" term="http://rs.tdwg.org/dwc/terms/lifeStage"/&gt;
    &lt;field index="9" term="http://rs.tdwg.org/dwc/terms/preparations"/&gt;
    &lt;field index="10" term="http://rs.tdwg.org/dwc/terms/basisOfRecord"/&gt;
    &lt;field index="11" term="http://purl.org/dc/terms/modified"/&gt;
  &lt;/extension&gt;
  &lt;extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="\n"
             fieldsEnclosedBy='"' ignoreHeaderLines="1" rowType="http://rs.iobis.org/obis/terms/ExtendedMeasurementOrFact"&gt;
    &lt;files&gt;
      &lt;location&gt;extendedMeasurementOrFact.csv&lt;/location&gt;
    &lt;/files&gt;
    &lt;coreid index="0" /&gt;
    &lt;field index="1" term="http://rs.tdwg.org/dwc/terms/occurrenceID"/&gt;
    &lt;field index="2" term="http://rs.tdwg.org/dwc/terms/measurementID"/&gt;
    &lt;field index="3" term="http://rs.tdwg.org/dwc/terms/measurementType"/&gt;
    &lt;field index="4" term="http://rs.iobis.org/obis/terms/measurementTypeID"/&gt;
    &lt;field index="5" term="http://rs.tdwg.org/dwc/terms/measurementValue"/&gt;
    &lt;field index="6" term="http://rs.tdwg.org/dwc/terms/measurementUnit"/&gt;
    &lt;field index="7" term="http://rs.iobis.org/obis/terms/measurementUnitID"/&gt;
    &lt;field index="8" term="http://rs.tdwg.org/dwc/terms/measurementMethod"/&gt;
    &lt;field index="9" term="http://rs.tdwg.org/dwc/terms/measurementRemarks"/&gt;
  &lt;/extension&gt;
&lt;/archive&gt;</code></pre>
</div>
</div>
</section>
<section id="create-eml-metadata" class="level2" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="create-eml-metadata"><span class="header-section-number">11</span> Create EML Metadata</h2>
<p>Build EML document with geographic, temporal, and taxonomic coverage:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># geographic coverage: union of net sites and cast positions ----</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>geo_net <span class="ot">&lt;-</span> tbl_site <span class="sc">|&gt;</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon_min =</span> <span class="fu">min</span>(longitude, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon_max =</span> <span class="fu">max</span>(longitude, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat_min =</span> <span class="fu">min</span>(latitude,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat_max =</span> <span class="fu">max</span>(latitude,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>geo_cast <span class="ot">&lt;-</span> d_casts <span class="sc">|&gt;</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon_min =</span> <span class="fu">min</span>(lon_dec, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon_max =</span> <span class="fu">max</span>(lon_dec, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat_min =</span> <span class="fu">min</span>(lat_dec, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat_max =</span> <span class="fu">max</span>(lat_dec, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>geo_coverage <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">westBoundingCoordinate  =</span> <span class="fu">min</span>(geo_net<span class="sc">$</span>lon_min, geo_cast<span class="sc">$</span>lon_min, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">eastBoundingCoordinate  =</span> <span class="fu">max</span>(geo_net<span class="sc">$</span>lon_max, geo_cast<span class="sc">$</span>lon_max, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">southBoundingCoordinate =</span> <span class="fu">min</span>(geo_net<span class="sc">$</span>lat_min, geo_cast<span class="sc">$</span>lat_min, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">northBoundingCoordinate =</span> <span class="fu">max</span>(geo_net<span class="sc">$</span>lat_max, geo_cast<span class="sc">$</span>lat_max, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a><span class="co"># temporal coverage: union of tow and cast dates ----</span></span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>temp_net <span class="ot">&lt;-</span> tbl_tow <span class="sc">|&gt;</span></span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">tmin =</span> <span class="fu">min</span>(time_start,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">tmax =</span> <span class="fu">max</span>(time_start,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>temp_cast <span class="ot">&lt;-</span> d_casts <span class="sc">|&gt;</span></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">tmin =</span> <span class="fu">min</span>(datetime_utc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">tmax =</span> <span class="fu">max</span>(datetime_utc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>temp_coverage <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">beginDate =</span> <span class="fu">as.character</span>(<span class="fu">as.Date</span>(<span class="fu">min</span>(temp_net<span class="sc">$</span>tmin, temp_cast<span class="sc">$</span>tmin, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))),</span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">endDate   =</span> <span class="fu">as.character</span>(<span class="fu">as.Date</span>(<span class="fu">max</span>(temp_net<span class="sc">$</span>tmax, temp_cast<span class="sc">$</span>tmax, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))))</span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a><span class="co"># taxonomic coverage ----</span></span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a>d_taxa <span class="ot">&lt;-</span> tbl_taxon <span class="sc">|&gt;</span> <span class="fu">collect</span>()</span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a>taxa_coverage <span class="ot">&lt;-</span> tbl_species <span class="sc">|&gt;</span></span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">worms_id =</span> <span class="fu">case_when</span>(</span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(worms_id) <span class="sc">|</span> worms_id <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="cn">NA_integer_</span>,</span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> worms_id)) <span class="sc">|&gt;</span></span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(worms_id)) <span class="sc">|&gt;</span></span>
<span id="cb62-49"><a href="#cb62-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(species_id, worms_id, common_name) <span class="sc">|&gt;</span></span>
<span id="cb62-50"><a href="#cb62-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb62-51"><a href="#cb62-51" aria-hidden="true" tabindex="-1"></a>    d_taxa <span class="sc">|&gt;</span> <span class="fu">distinct</span>(taxonID, taxonRank, scientificName),</span>
<span id="cb62-52"><a href="#cb62-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">join_by</span>(worms_id <span class="sc">==</span> taxonID)) <span class="sc">|&gt;</span></span>
<span id="cb62-53"><a href="#cb62-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(worms_id, taxonRank, scientificName) <span class="sc">|&gt;</span></span>
<span id="cb62-54"><a href="#cb62-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb62-55"><a href="#cb62-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_id  =</span> <span class="fu">first</span>(species_id),</span>
<span id="cb62-56"><a href="#cb62-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">common_name =</span> <span class="fu">paste</span>(<span class="fu">unique</span>(<span class="fu">na.omit</span>(common_name)), <span class="at">collapse =</span> <span class="st">", "</span>),</span>
<span id="cb62-57"><a href="#cb62-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups     =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb62-58"><a href="#cb62-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(species_id) <span class="sc">|&gt;</span></span>
<span id="cb62-59"><a href="#cb62-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(scientificName)) <span class="sc">|&gt;</span></span>
<span id="cb62-60"><a href="#cb62-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pmap</span>(<span class="cf">function</span>(species_id, taxonRank, scientificName, common_name, worms_id, ...) {</span>
<span id="cb62-61"><a href="#cb62-61" aria-hidden="true" tabindex="-1"></a>    item <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb62-62"><a href="#cb62-62" aria-hidden="true" tabindex="-1"></a>      <span class="at">id             =</span> <span class="fu">glue</span>(<span class="st">"calcofi_species_{species_id}"</span>),</span>
<span id="cb62-63"><a href="#cb62-63" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxonRankName  =</span> taxonRank,</span>
<span id="cb62-64"><a href="#cb62-64" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxonRankValue =</span> scientificName,</span>
<span id="cb62-65"><a href="#cb62-65" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxonId        =</span> <span class="fu">list</span>(</span>
<span id="cb62-66"><a href="#cb62-66" aria-hidden="true" tabindex="-1"></a>        <span class="at">provider =</span> <span class="st">"https://www.marinespecies.org"</span>,</span>
<span id="cb62-67"><a href="#cb62-67" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.character</span>(worms_id)))</span>
<span id="cb62-68"><a href="#cb62-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(common_name) <span class="sc">&amp;&amp;</span> common_name <span class="sc">!=</span> <span class="st">""</span>)</span>
<span id="cb62-69"><a href="#cb62-69" aria-hidden="true" tabindex="-1"></a>      item<span class="sc">$</span>commonName <span class="ot">&lt;-</span> common_name</span>
<span id="cb62-70"><a href="#cb62-70" aria-hidden="true" tabindex="-1"></a>    item</span>
<span id="cb62-71"><a href="#cb62-71" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb62-72"><a href="#cb62-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-73"><a href="#cb62-73" aria-hidden="true" tabindex="-1"></a><span class="co"># build EML document ----</span></span>
<span id="cb62-74"><a href="#cb62-74" aria-hidden="true" tabindex="-1"></a>my_eml <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb62-75"><a href="#cb62-75" aria-hidden="true" tabindex="-1"></a>  <span class="at">packageId =</span> dataset_id,</span>
<span id="cb62-76"><a href="#cb62-76" aria-hidden="true" tabindex="-1"></a>  <span class="at">system    =</span> <span class="st">"calcofi.io"</span>,</span>
<span id="cb62-77"><a href="#cb62-77" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset   =</span> <span class="fu">list</span>(</span>
<span id="cb62-78"><a href="#cb62-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">title              =</span> dataset_title,</span>
<span id="cb62-79"><a href="#cb62-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">intellectualRights =</span> intellectual_rights,</span>
<span id="cb62-80"><a href="#cb62-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">creator =</span> <span class="fu">list</span>(</span>
<span id="cb62-81"><a href="#cb62-81" aria-hidden="true" tabindex="-1"></a>      <span class="at">individualName        =</span> <span class="fu">list</span>(<span class="at">givenName =</span> <span class="st">"Ed"</span>, <span class="at">surName =</span> <span class="st">"Weber"</span>),</span>
<span id="cb62-82"><a href="#cb62-82" aria-hidden="true" tabindex="-1"></a>      <span class="at">organizationName      =</span> <span class="st">"NOAA SWFSC"</span>,</span>
<span id="cb62-83"><a href="#cb62-83" aria-hidden="true" tabindex="-1"></a>      <span class="at">electronicMailAddress =</span> <span class="st">"ed.weber@noaa.gov"</span>,</span>
<span id="cb62-84"><a href="#cb62-84" aria-hidden="true" tabindex="-1"></a>      <span class="at">userId =</span> <span class="fu">list</span>(</span>
<span id="cb62-85"><a href="#cb62-85" aria-hidden="true" tabindex="-1"></a>        <span class="at">directory =</span> <span class="st">"https://orcid.org/"</span>,</span>
<span id="cb62-86"><a href="#cb62-86" aria-hidden="true" tabindex="-1"></a>        <span class="at">userId   =</span> <span class="st">"0000-0002-0942-434X"</span>)),</span>
<span id="cb62-87"><a href="#cb62-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">abstract   =</span> dataset_abstract,</span>
<span id="cb62-88"><a href="#cb62-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">keywordSet =</span> <span class="fu">list</span>(</span>
<span id="cb62-89"><a href="#cb62-89" aria-hidden="true" tabindex="-1"></a>      <span class="at">keyword          =</span> dataset_keywords,</span>
<span id="cb62-90"><a href="#cb62-90" aria-hidden="true" tabindex="-1"></a>      <span class="at">keywordThesaurus =</span> <span class="st">"GCMD Science Keywords"</span>),</span>
<span id="cb62-91"><a href="#cb62-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">coverage =</span> <span class="fu">list</span>(</span>
<span id="cb62-92"><a href="#cb62-92" aria-hidden="true" tabindex="-1"></a>      <span class="at">geographicCoverage =</span> <span class="fu">list</span>(</span>
<span id="cb62-93"><a href="#cb62-93" aria-hidden="true" tabindex="-1"></a>        <span class="at">geographicDescription =</span> <span class="st">"California Current Large Marine Ecoregion"</span>,</span>
<span id="cb62-94"><a href="#cb62-94" aria-hidden="true" tabindex="-1"></a>        <span class="at">boundingCoordinates   =</span> geo_coverage),</span>
<span id="cb62-95"><a href="#cb62-95" aria-hidden="true" tabindex="-1"></a>      <span class="at">temporalCoverage =</span> <span class="fu">list</span>(</span>
<span id="cb62-96"><a href="#cb62-96" aria-hidden="true" tabindex="-1"></a>        <span class="at">rangeOfDates =</span> <span class="fu">list</span>(</span>
<span id="cb62-97"><a href="#cb62-97" aria-hidden="true" tabindex="-1"></a>          <span class="at">beginDate =</span> <span class="fu">list</span>(<span class="at">calendarDate =</span> temp_coverage<span class="sc">$</span>beginDate),</span>
<span id="cb62-98"><a href="#cb62-98" aria-hidden="true" tabindex="-1"></a>          <span class="at">endDate   =</span> <span class="fu">list</span>(<span class="at">calendarDate =</span> temp_coverage<span class="sc">$</span>endDate))),</span>
<span id="cb62-99"><a href="#cb62-99" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxonomicCoverage =</span> <span class="fu">list</span>(</span>
<span id="cb62-100"><a href="#cb62-100" aria-hidden="true" tabindex="-1"></a>        <span class="at">generalTaxonomicCoverage =</span> <span class="st">"Marine ichthyoplankton (fish eggs and larvae)"</span>,</span>
<span id="cb62-101"><a href="#cb62-101" aria-hidden="true" tabindex="-1"></a>        <span class="at">taxonomicClassification  =</span> taxa_coverage)),</span>
<span id="cb62-102"><a href="#cb62-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">contact =</span> <span class="fu">list</span>(</span>
<span id="cb62-103"><a href="#cb62-103" aria-hidden="true" tabindex="-1"></a>      <span class="at">individualName        =</span> <span class="fu">list</span>(<span class="at">givenName =</span> <span class="st">"Ed"</span>, <span class="at">surName =</span> <span class="st">"Weber"</span>),</span>
<span id="cb62-104"><a href="#cb62-104" aria-hidden="true" tabindex="-1"></a>      <span class="at">electronicMailAddress =</span> <span class="st">"ed.weber@noaa.gov"</span>),</span>
<span id="cb62-105"><a href="#cb62-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">methods =</span> <span class="fu">list</span>(</span>
<span id="cb62-106"><a href="#cb62-106" aria-hidden="true" tabindex="-1"></a>      <span class="at">methodStep =</span> <span class="fu">list</span>(</span>
<span id="cb62-107"><a href="#cb62-107" aria-hidden="true" tabindex="-1"></a>        <span class="at">description =</span> <span class="fu">list</span>(<span class="at">para =</span> sampling_methods_description)),</span>
<span id="cb62-108"><a href="#cb62-108" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampling =</span> <span class="fu">list</span>(</span>
<span id="cb62-109"><a href="#cb62-109" aria-hidden="true" tabindex="-1"></a>        <span class="at">studyExtent =</span> <span class="fu">list</span>(</span>
<span id="cb62-110"><a href="#cb62-110" aria-hidden="true" tabindex="-1"></a>          <span class="at">description =</span> <span class="fu">list</span>(<span class="at">para =</span> study_extent_description)),</span>
<span id="cb62-111"><a href="#cb62-111" aria-hidden="true" tabindex="-1"></a>        <span class="at">samplingDescription =</span> <span class="fu">list</span>(</span>
<span id="cb62-112"><a href="#cb62-112" aria-hidden="true" tabindex="-1"></a>          <span class="at">para =</span> sampling_description))),</span>
<span id="cb62-113"><a href="#cb62-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">project =</span> <span class="fu">list</span>(</span>
<span id="cb62-114"><a href="#cb62-114" aria-hidden="true" tabindex="-1"></a>      <span class="at">title     =</span> dataset_title,</span>
<span id="cb62-115"><a href="#cb62-115" aria-hidden="true" tabindex="-1"></a>      <span class="at">personnel =</span> <span class="fu">list</span>(</span>
<span id="cb62-116"><a href="#cb62-116" aria-hidden="true" tabindex="-1"></a>        <span class="at">individualName =</span> <span class="fu">list</span>(<span class="at">givenName =</span> <span class="st">"Ed"</span>, <span class="at">surName =</span> <span class="st">"Weber"</span>),</span>
<span id="cb62-117"><a href="#cb62-117" aria-hidden="true" tabindex="-1"></a>        <span class="at">role           =</span> <span class="st">"Data Manager"</span>),</span>
<span id="cb62-118"><a href="#cb62-118" aria-hidden="true" tabindex="-1"></a>      <span class="at">funding =</span> <span class="fu">list</span>(<span class="at">para =</span> funding_information))))</span>
<span id="cb62-119"><a href="#cb62-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-120"><a href="#cb62-120" aria-hidden="true" tabindex="-1"></a>eml_xml <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"eml.xml"</span>)</span>
<span id="cb62-121"><a href="#cb62-121" aria-hidden="true" tabindex="-1"></a><span class="fu">write_eml</span>(my_eml, eml_xml)</span>
<span id="cb62-122"><a href="#cb62-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-123"><a href="#cb62-123" aria-hidden="true" tabindex="-1"></a><span class="co"># replace license placeholder with actual license xml</span></span>
<span id="cb62-124"><a href="#cb62-124" aria-hidden="true" tabindex="-1"></a><span class="fu">readLines</span>(eml_xml) <span class="sc">|&gt;</span></span>
<span id="cb62-125"><a href="#cb62-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_replace</span>(<span class="fu">fixed</span>(<span class="fu">names</span>(license_xml)), license_xml) <span class="sc">|&gt;</span></span>
<span id="cb62-126"><a href="#cb62-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeLines</span>(eml_xml)</span>
<span id="cb62-127"><a href="#cb62-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-128"><a href="#cb62-128" aria-hidden="true" tabindex="-1"></a>validation_result <span class="ot">&lt;-</span> <span class="fu">eml_validate</span>(eml_xml)</span>
<span id="cb62-129"><a href="#cb62-129" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>validation_result) {</span>
<span id="cb62-130"><a href="#cb62-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"EML validation errors:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb62-131"><a href="#cb62-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">attr</span>(validation_result, <span class="st">"errors"</span>))</span>
<span id="cb62-132"><a href="#cb62-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"EML validation failed"</span>)</span>
<span id="cb62-133"><a href="#cb62-133" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb62-134"><a href="#cb62-134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"EML is valid!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb62-135"><a href="#cb62-135" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>EML is valid!</code></pre>
</div>
</div>
</section>
<section id="data-quality-checks" class="level2" data-number="12">
<h2 data-number="12" class="anchored" data-anchor-id="data-quality-checks"><span class="header-section-number">12</span> Data Quality Checks</h2>
<p>Validate event hierarchy, orphan records, and output summary statistics:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check for missing WoRMS IDs</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>d_missing_worms <span class="ot">&lt;-</span> tbl_species <span class="sc">|&gt;</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(worms_id) <span class="sc">|</span> worms_id <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(species_id, scientific_name) <span class="sc">|&gt;</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(d_missing_worms) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"WARNING:"</span>, <span class="fu">nrow</span>(d_missing_worms), <span class="st">"species missing WoRMS IDs:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(d_missing_worms, <span class="at">n =</span> <span class="dv">20</span>)</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="co"># summary statistics ----</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>n_cruises   <span class="ot">&lt;-</span> d_event <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"cruise"</span>)     <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>n_nets      <span class="ot">&lt;-</span> d_event <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"net_sample"</span>) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>n_casts_out <span class="ot">&lt;-</span> d_event <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"ctd_cast"</span>)   <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>n_occs      <span class="ot">&lt;-</span> <span class="fu">nrow</span>(d_occurrence_out)</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>n_species   <span class="ot">&lt;-</span> <span class="fu">n_distinct</span>(d_occurrence_out<span class="sc">$</span>scientificName)</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>n_emof      <span class="ot">&lt;-</span> <span class="fu">nrow</span>(d_emof)</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a><span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a><span class="st">=== Dataset Summary ===</span></span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a><span class="st">Total events:         {prettyNum(nrow(d_event), big.mark = ',')}</span></span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a><span class="st">  - Cruises:          {prettyNum(n_cruises, big.mark = ',')}</span></span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a><span class="st">  - Net samples:      {prettyNum(n_nets, big.mark = ',')}</span></span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a><span class="st">  - CTD casts:        {prettyNum(n_casts_out, big.mark = ',')}</span></span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a><span class="st">Total occurrences:    {prettyNum(n_occs, big.mark = ',')}</span></span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a><span class="st">Unique species:       {prettyNum(n_species, big.mark = ',')}</span></span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a><span class="st">Total eMoF records:   {prettyNum(n_emof, big.mark = ',')}"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>=== Dataset Summary ===
Total events:         112,843
  - Cruises:          687
  - Net samples:      76,512
  - CTD casts:        35,644
Total occurrences:    463,655
Unique species:       899
Total eMoF records:   11,981,929</code></pre>
</div>
</div>
</section>
<section id="package-darwincore-archive" class="level2" data-number="13">
<h2 data-number="13" class="anchored" data-anchor-id="package-darwincore-archive"><span class="header-section-number">13</span> Package DarwinCore Archive</h2>
<p>Create the final DwC-A zip file:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>zip_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dirname</span>(dir_out),</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="st">"ichthyo_bottle_"</span>, <span class="fu">Sys.Date</span>(), <span class="st">".zip"</span>))</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="fu">zip</span>(</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  zip_file,</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">files =</span> <span class="fu">file.path</span>(</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>    dir_out,</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"event.csv"</span>, <span class="st">"occurrence.csv"</span>, <span class="st">"extendedMeasurementOrFact.csv"</span>,</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">"meta.xml"</span>, <span class="st">"eml.xml"</span>)),</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">flags =</span> <span class="st">"-j"</span>)</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Darwin Core Archive created:"</span>, zip_file, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Darwin Core Archive created: /Users/bbest/Github/CalCOFI/workflows/data/darwincore/ichthyo_bottle_2026-02-24.zip </code></pre>
</div>
</div>
</section>
<section id="validate-with-obistools" class="level2" data-number="14">
<h2 data-number="14" class="anchored" data-anchor-id="validate-with-obistools"><span class="header-section-number">14</span> Validate with obistools</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read back the CSVs</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>d_event_check <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(dir_out, <span class="st">"event.csv"</span>))</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>d_occ_check   <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(dir_out, <span class="st">"occurrence.csv"</span>))</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>d_emof_check  <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(dir_out, <span class="st">"extendedMeasurementOrFact.csv"</span>))</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="co"># event hierarchy check</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Event hierarchy check ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>=== Event hierarchy check ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>event_check <span class="ot">&lt;-</span> <span class="fu">check_eventids</span>(d_event_check)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(event_check) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"PASS: all event parent-child relationships valid</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"ISSUES found:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(event_check)</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>ISSUES found:
# A tibble: 8,393 × 4
   field         level   row message                                          
   &lt;chr&gt;         &lt;chr&gt; &lt;int&gt; &lt;chr&gt;                                            
 1 parentEventID error 77200 parentEventID 4903CR has no corresponding eventID
 2 parentEventID error 77201 parentEventID 4903CR has no corresponding eventID
 3 parentEventID error 77202 parentEventID 4903CR has no corresponding eventID
 4 parentEventID error 77203 parentEventID 4903CR has no corresponding eventID
 5 parentEventID error 77204 parentEventID 4903CR has no corresponding eventID
 6 parentEventID error 77205 parentEventID 4903CR has no corresponding eventID
 7 parentEventID error 77206 parentEventID 4903CR has no corresponding eventID
 8 parentEventID error 77207 parentEventID 4903CR has no corresponding eventID
 9 parentEventID error 77208 parentEventID 4903CR has no corresponding eventID
10 parentEventID error 77209 parentEventID 4903CR has no corresponding eventID
# ℹ 8,383 more rows</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># occurrence → event linkage</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== Occurrence-event linkage ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== Occurrence-event linkage ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>occ_check <span class="ot">&lt;-</span> <span class="fu">check_extension_eventids</span>(d_event_check, d_occ_check)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(occ_check) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"PASS: all occurrences link to valid events</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"ISSUES found:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(occ_check)</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>PASS: all occurrences link to valid events</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># eMoF → event linkage</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== eMoF-event linkage ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== eMoF-event linkage ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>emof_event_check <span class="ot">&lt;-</span> d_emof_check <span class="sc">|&gt;</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(eventID)) <span class="sc">|&gt;</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>eventID <span class="sc">%in%</span> d_event_check<span class="sc">$</span>eventID)</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(emof_event_check) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"PASS: all eMoF eventIDs link to valid events</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">nrow</span>(emof_event_check), <span class="st">"eMoF records with invalid eventID</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>PASS: all eMoF eventIDs link to valid events</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># eMoF → occurrence linkage</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>emof_occ_check <span class="ot">&lt;-</span> d_emof_check <span class="sc">|&gt;</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(occurrenceID)) <span class="sc">|&gt;</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>occurrenceID <span class="sc">%in%</span> d_occ_check<span class="sc">$</span>occurrenceID)</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(emof_occ_check) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"PASS: all eMoF occurrenceIDs link to valid occurrences</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">nrow</span>(emof_occ_check), <span class="st">"eMoF records with invalid occurrenceID</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>PASS: all eMoF occurrenceIDs link to valid occurrences</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># summary by event type</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== Events by type ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== Events by type ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>d_event_check <span class="sc">|&gt;</span> <span class="fu">count</span>(eventType) <span class="sc">|&gt;</span> <span class="fu">print</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  eventType      n
  &lt;chr&gt;      &lt;int&gt;
1 cruise       687
2 ctd_cast   35644
3 net_sample 76512</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== eMoF by measurementType ===</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=== eMoF by measurementType ===</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>d_emof_check <span class="sc">|&gt;</span> <span class="fu">count</span>(measurementType, <span class="at">sort =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">50</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 45 × 2
   measurementType                                                             n
   &lt;chr&gt;                                                                   &lt;int&gt;
 1 Dissolved oxygen (QC'd)                                                1.42e6
 2 Reported depth from pressure (pre-QC)                                  8.95e5
 3 Water temperature (QC'd)                                               8.84e5
 4 Reported potential temperature (pre-QC)                                8.49e5
 5 Reported dynamic height (no QC'd counterpart)                          8.49e5
 6 Salinity - Practical Salinity Scale 1978 (QC'd)                        8.48e5
 7 Potential density (Sigma Theta)                                        8.43e5
 8 Reported Specific Volume Anomaly (pre-QC); WARNING: different paramet… 8.43e5
 9 Oxygen percent saturation                                              6.91e5
10 Reported oxygen (pre-QC)                                               6.91e5
11 Phosphate concentration                                                4.41e5
12 Silicate concentration                                                 3.82e5
13 Nitrate concentration                                                  3.65e5
14 Nitrite concentration                                                  3.64e5
15 Chlorophyll-a measured fluorometrically                                2.46e5
16 Phaeopigment measured fluorometrically                                 2.46e5
17 body length                                                            2.42e5
18 abundance by life stage                                                1.25e5
19 Reported ammonium concentration (pre-QC)                               9.05e4
20 Ammonia concentration (QC'd)                                           9.05e4
21 proportion of sample sorted                                            7.65e4
22 standardized haul factor                                               7.65e4
23 small plankton biomass                                                 4.53e4
24 total plankton biomass                                                 4.53e4
25 Wind direction (abbreviated 360 degree azimuth)                        3.42e4
26 Wind speed                                                             3.40e4
27 WMO weather code (WMO 4501)                                            2.75e4
28 Mean 14C assimilation of replicates 1 and 2                            2.38e4
29 14C assimilation dark/control bottle                                   2.38e4
30 Dry air temperature from sling psychrometer                            2.03e4
31 Barometric pressure                                                    2.03e4
32 Wet air temperature from sling psychrometer                            2.02e4
33 Light intensity of incubation tubes                                    1.98e4
34 14C assimilation replicate 1                                           1.55e4
35 14C assimilation replicate 2                                           1.55e4
36 Wave direction (abbreviated 360 degree azimuth)                        1.32e4
37 Wave height                                                            1.27e4
38 Cloud amount in oktas (WMO 2700)                                       1.25e4
39 Wave period                                                            1.23e4
40 WMO cloud type code (WMO 0500)                                         1.05e4
41 WMO visibility code (WMO 4300)                                         1.01e4
42 Secchi disk depth                                                      5.69e3
43 Total alkalinity replicate 1                                           2.08e3
44 Water color on Forel-Ule scale                                         2.08e3
45 Dissolved inorganic carbon replicate 1                                 2.00e3</code></pre>
</div>
</div>
</section>
<section id="cleanup" class="level2" data-number="15">
<h2 data-number="15" class="anchored" data-anchor-id="cleanup"><span class="header-section-number">15</span> Cleanup</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con, <span class="at">shutdown =</span> <span class="cn">TRUE</span>)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Database connection closed.</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Database connection closed.</code></pre>
</div>
</div>
<!-- -->

</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb92" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Publish Ichthyoplankton &amp; Bottle Data to OBIS"</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>This workflow converts CalCOFI ichthyoplankton (fish eggs and larvae) and bottle hydrography data to an OBIS-compliant DarwinCore Archive for publication. The archive follows the Event Core structure with Occurrence and ExtendedMeasurementOrFact (eMoF) extensions.</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>**Data source**: merged DuckDB from <span class="in">`merge_ichthyo_bottle.qmd`</span>, combining:</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>SWFSC ichthyoplankton tables (cruise, ship, site, tow, net, ichthyo, species, lookup)</span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>CalCOFI.org bottle tables (casts, bottle, bottle_measurement, cast_condition, measurement_type)</span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>**References**: <span class="co">[</span><span class="ot">CalCOFI Fish Eggs &amp; Larvae</span><span class="co">](https://calcofi.org/data/marine-ecosystem-data/fish-eggs-larvae/)</span> | <span class="co">[</span><span class="ot">CalCOFI Bottle Database</span><span class="co">](https://calcofi.org/data/oceanographic-data/bottle-database/)</span> | <span class="co">[</span><span class="ot">OBIS Manual</span><span class="co">](https://manual.obis.org/)</span> | <span class="co">[</span><span class="ot">DarwinCore Terms</span><span class="co">](https://dwc.tdwg.org/terms/)</span></span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a>  CalCOFI<span class="sc">/</span>calcofi4db,</span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a>  DBI,</span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a>  dplyr,</span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a>  DT,</span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a>  duckdb,</span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a>  EML,</span>
<span id="cb92-30"><a href="#cb92-30" aria-hidden="true" tabindex="-1"></a>  glue,</span>
<span id="cb92-31"><a href="#cb92-31" aria-hidden="true" tabindex="-1"></a>  here,</span>
<span id="cb92-32"><a href="#cb92-32" aria-hidden="true" tabindex="-1"></a>  lubridate,</span>
<span id="cb92-33"><a href="#cb92-33" aria-hidden="true" tabindex="-1"></a>  iobis<span class="sc">/</span>obistools,</span>
<span id="cb92-34"><a href="#cb92-34" aria-hidden="true" tabindex="-1"></a>  purrr,</span>
<span id="cb92-35"><a href="#cb92-35" aria-hidden="true" tabindex="-1"></a>  stringr,</span>
<span id="cb92-36"><a href="#cb92-36" aria-hidden="true" tabindex="-1"></a>  readr,</span>
<span id="cb92-37"><a href="#cb92-37" aria-hidden="true" tabindex="-1"></a>  tibble,</span>
<span id="cb92-38"><a href="#cb92-38" aria-hidden="true" tabindex="-1"></a>  tidyr,</span>
<span id="cb92-39"><a href="#cb92-39" aria-hidden="true" tabindex="-1"></a>  uuid,</span>
<span id="cb92-40"><a href="#cb92-40" aria-hidden="true" tabindex="-1"></a>  xml2,</span>
<span id="cb92-41"><a href="#cb92-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">quiet =</span> T)</span>
<span id="cb92-42"><a href="#cb92-42" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">readr.show_col_types =</span> F)</span>
<span id="cb92-43"><a href="#cb92-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-44"><a href="#cb92-44" aria-hidden="true" tabindex="-1"></a><span class="co"># calcofi namespace for deterministic UUID v5 generation</span></span>
<span id="cb92-45"><a href="#cb92-45" aria-hidden="true" tabindex="-1"></a>CALCOFI_NS <span class="ot">&lt;-</span> <span class="st">"c0f1ca00-ca1c-5000-b000-1c4790000000"</span></span>
<span id="cb92-46"><a href="#cb92-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-47"><a href="#cb92-47" aria-hidden="true" tabindex="-1"></a><span class="co"># dataset metadata ----</span></span>
<span id="cb92-48"><a href="#cb92-48" aria-hidden="true" tabindex="-1"></a>dataset_title <span class="ot">&lt;-</span> <span class="st">"CalCOFI Ichthyoplankton Tows &amp; Bottle Hydrography"</span></span>
<span id="cb92-49"><a href="#cb92-49" aria-hidden="true" tabindex="-1"></a>dataset_abstract <span class="ot">&lt;-</span> <span class="st">"Fish larvae and egg counts from CalCOFI ichthyoplankton nets (primarily vertical [Calvet or Pairovet], oblique [bongo or ring nets], and surface tows [Manta nets]) combined with CTD rosette bottle hydrography (temperature, salinity, dissolved oxygen, nutrients, chlorophyll, and carbon system parameters). Oblique tows are normally standardized to count per 10 m^2 of surface sampled. Surface tows are normally standardized to count per 1,000 m^3 strained. Bottle data include depth-resolved measurements from Niskin bottles on CTD casts at CalCOFI grid stations."</span></span>
<span id="cb92-50"><a href="#cb92-50" aria-hidden="true" tabindex="-1"></a>dataset_keywords <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb92-51"><a href="#cb92-51" aria-hidden="true" tabindex="-1"></a>  <span class="st">"atmosphere"</span>,</span>
<span id="cb92-52"><a href="#cb92-52" aria-hidden="true" tabindex="-1"></a>  <span class="st">"biology"</span>,</span>
<span id="cb92-53"><a href="#cb92-53" aria-hidden="true" tabindex="-1"></a>  <span class="st">"biosphere"</span>,</span>
<span id="cb92-54"><a href="#cb92-54" aria-hidden="true" tabindex="-1"></a>  <span class="st">"calcofi"</span>,</span>
<span id="cb92-55"><a href="#cb92-55" aria-hidden="true" tabindex="-1"></a>  <span class="st">"earth science"</span>,</span>
<span id="cb92-56"><a href="#cb92-56" aria-hidden="true" tabindex="-1"></a>  <span class="st">"environment"</span>,</span>
<span id="cb92-57"><a href="#cb92-57" aria-hidden="true" tabindex="-1"></a>  <span class="st">"hydrography"</span>,</span>
<span id="cb92-58"><a href="#cb92-58" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ichthyoplankton"</span>,</span>
<span id="cb92-59"><a href="#cb92-59" aria-hidden="true" tabindex="-1"></a>  <span class="st">"latitude"</span>,</span>
<span id="cb92-60"><a href="#cb92-60" aria-hidden="true" tabindex="-1"></a>  <span class="st">"longitude"</span>,</span>
<span id="cb92-61"><a href="#cb92-61" aria-hidden="true" tabindex="-1"></a>  <span class="st">"nutrients"</span>,</span>
<span id="cb92-62"><a href="#cb92-62" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ocean"</span>,</span>
<span id="cb92-63"><a href="#cb92-63" aria-hidden="true" tabindex="-1"></a>  <span class="st">"time"</span>)</span>
<span id="cb92-64"><a href="#cb92-64" aria-hidden="true" tabindex="-1"></a>country_code <span class="ot">&lt;-</span> <span class="st">"US"</span></span>
<span id="cb92-65"><a href="#cb92-65" aria-hidden="true" tabindex="-1"></a>water_body   <span class="ot">&lt;-</span> <span class="st">"California Current"</span></span>
<span id="cb92-66"><a href="#cb92-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-67"><a href="#cb92-67" aria-hidden="true" tabindex="-1"></a>dataset_id <span class="ot">&lt;-</span> <span class="fu">glue</span>(</span>
<span id="cb92-68"><a href="#cb92-68" aria-hidden="true" tabindex="-1"></a>  <span class="st">"calcofi.io_workflow_ichthyo-bottle_to_obis_{format(Sys.Date(), '%Y-%m-%d')}"</span>)</span>
<span id="cb92-69"><a href="#cb92-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-70"><a href="#cb92-70" aria-hidden="true" tabindex="-1"></a>sampling_methods_description <span class="ot">&lt;-</span> <span class="st">"Standard CalCOFI ichthyoplankton tows: The standard oblique tow uses a bongo net (71 cm diameter, 0.505 mm mesh) or 1-m ring net (prior to 1978) retrieved at a constant wire angle (45 degrees) from 210 m depth to surface. Surface tows use a Manta net; vertical tows use CalVET/Pairovet nets. Flowmeters measure volume filtered. Samples are preserved in 5% formalin. Fish eggs and larvae are sorted, identified to lowest taxon possible, enumerated, and measured. CTD bottle data: Seawater samples collected using Niskin bottles mounted on a CTD rosette cast to near-bottom depths. Temperature, salinity, and dissolved oxygen are measured by CTD sensors and calibrated against bottle samples. Nutrient concentrations (phosphate, silicate, nitrite, nitrate, ammonia) determined by autoanalyzer. Chlorophyll-a and phaeopigment measured fluorometrically."</span></span>
<span id="cb92-71"><a href="#cb92-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-72"><a href="#cb92-72" aria-hidden="true" tabindex="-1"></a>study_extent_description <span class="ot">&lt;-</span> <span class="st">"The study covers the California Current ecosystem, primarily off Southern California (standard lines 77-93) but historically extending from the border of Canada to the tip of Baja California. The time series for this dataset generally begins in 1949 for bottle data and 1951 for ichthyoplankton, continuing to the present with quarterly cruises."</span></span>
<span id="cb92-73"><a href="#cb92-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-74"><a href="#cb92-74" aria-hidden="true" tabindex="-1"></a>sampling_description <span class="ot">&lt;-</span> <span class="st">"Samples are collected at fixed stations along the CalCOFI grid. Oblique tows are standardized to counts per 10 m^2 of sea surface. Surface tows are standardized to counts per 1,000 m^3. Bottle hydrography data provide depth-resolved oceanographic context at the same grid stations."</span></span>
<span id="cb92-75"><a href="#cb92-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-76"><a href="#cb92-76" aria-hidden="true" tabindex="-1"></a>funding_information <span class="ot">&lt;-</span> <span class="st">"CalCOFI is a partnership between the NOAA National Marine Fisheries Service (NMFS), Scripps Institution of Oceanography (SIO), and California Department of Fish and Wildlife (CDFW)."</span></span>
<span id="cb92-77"><a href="#cb92-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-78"><a href="#cb92-78" aria-hidden="true" tabindex="-1"></a>rights <span class="ot">&lt;-</span> <span class="st">"The data may be used and redistributed for free but is not intended for legal use, since it may contain inaccuracies. Neither the data Contributor, ERD, NOAA, nor the United States Government, nor any of their employees or contractors, makes any warranty, express or implied, including warranties of merchantability and fitness for a particular purpose, or assumes any legal liability for the accuracy, completeness, or usefulness, of this information."</span></span>
<span id="cb92-79"><a href="#cb92-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-80"><a href="#cb92-80" aria-hidden="true" tabindex="-1"></a>license <span class="ot">&lt;-</span> <span class="st">"To the extent possible under law, the publisher has waived all rights to these data and has dedicated them to the Public Domain (CC0 1.0). Users may copy, modify, distribute and use the work, including for commercial purposes, without restriction."</span></span>
<span id="cb92-81"><a href="#cb92-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-82"><a href="#cb92-82" aria-hidden="true" tabindex="-1"></a>license_xml <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb92-83"><a href="#cb92-83" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Public Domain (CC0 1.0)"</span> <span class="ot">=</span> <span class="st">'&lt;ulink url="http://creativecommons.org/publicdomain/zero/1.0/legalcode"&gt;&lt;citetitle&gt;Public Domain (CC0 1.0)&lt;/citetitle&gt;&lt;/ulink&gt;'</span>)</span>
<span id="cb92-84"><a href="#cb92-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-85"><a href="#cb92-85" aria-hidden="true" tabindex="-1"></a>intellectual_rights <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb92-86"><a href="#cb92-86" aria-hidden="true" tabindex="-1"></a>  <span class="at">para =</span> <span class="fu">paste</span>(rights, license, <span class="at">collapse =</span> <span class="st">" "</span>))</span>
<span id="cb92-87"><a href="#cb92-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-88"><a href="#cb92-88" aria-hidden="true" tabindex="-1"></a>dir_out <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/darwincore/ichthyo_bottle"</span>)</span>
<span id="cb92-89"><a href="#cb92-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-90"><a href="#cb92-90" aria-hidden="true" tabindex="-1"></a><span class="co"># get merged duckdb connection ----</span></span>
<span id="cb92-91"><a href="#cb92-91" aria-hidden="true" tabindex="-1"></a>db_path <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/wrangling/merge_ichthyo_bottle.duckdb"</span>)</span>
<span id="cb92-92"><a href="#cb92-92" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">file.exists</span>(db_path))</span>
<span id="cb92-93"><a href="#cb92-93" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">duckdb</span>(), <span class="at">dbdir =</span> db_path, <span class="at">read_only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb92-94"><a href="#cb92-94" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-95"><a href="#cb92-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-96"><a href="#cb92-96" aria-hidden="true" tabindex="-1"></a><span class="fu">## Event Hierarchy Design</span></span>
<span id="cb92-97"><a href="#cb92-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-98"><a href="#cb92-98" aria-hidden="true" tabindex="-1"></a>The archive uses a **sibling-event architecture**: ichthyoplankton net tows and CTD bottle casts are both children of cruise events, linked spatially via <span class="in">`locationID`</span> (CalCOFI <span class="in">`line_station`</span> format) rather than nested within each other. This avoids falsely implying that bottle measurements were co-located with specific net tows — they happen at the same station but at different times and depths.</span>
<span id="cb92-99"><a href="#cb92-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-102"><a href="#cb92-102" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb92-103"><a href="#cb92-103" aria-hidden="true" tabindex="-1"></a>%%| label: fig-ichthyo_bottle_event_hierarchy</span>
<span id="cb92-104"><a href="#cb92-104" aria-hidden="true" tabindex="-1"></a>%%| fig-cap: <span class="ot">"</span><span class="st">Event hierarchy for CalCOFI ichthyoplankton &amp; bottle data in DarwinCore Archive format.</span><span class="ot">"</span></span>
<span id="cb92-105"><a href="#cb92-105" aria-hidden="true" tabindex="-1"></a>%%| file: diagrams/ichthyo_bottle_event_hierarchy.mmd</span>
<span id="cb92-106"><a href="#cb92-106" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-107"><a href="#cb92-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-108"><a href="#cb92-108" aria-hidden="true" tabindex="-1"></a>**Key design decisions**:</span>
<span id="cb92-109"><a href="#cb92-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-110"><a href="#cb92-110" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Collapsed hierarchy**: cruise → net_sample / ctd_cast (no intermediate site/tow levels) to avoid event inheritance issues with NA values in the IPT</span>
<span id="cb92-111"><a href="#cb92-111" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**`locationID`**: both net_sample and ctd_cast events share `locationID = "{line}_{station}"` for spatial joining by OBIS consumers</span>
<span id="cb92-112"><a href="#cb92-112" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**`cast_uuid`**: deterministic UUID v5 minted from <span class="in">`cast_id`</span> using the CalCOFI namespace — same approach as <span class="in">`ichthyo_uuid`</span></span>
<span id="cb92-113"><a href="#cb92-113" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Occurrence consolidation**: one occurrence per life stage (egg or larva) per species per net sample</span>
<span id="cb92-114"><a href="#cb92-114" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**eMoF structure**: five sub-tables covering net-level measurements, stage abundance, body length, bottle measurements, and cast conditions</span>
<span id="cb92-115"><a href="#cb92-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-116"><a href="#cb92-116" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Extraction</span></span>
<span id="cb92-117"><a href="#cb92-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-118"><a href="#cb92-118" aria-hidden="true" tabindex="-1"></a>Load all necessary tables from the merged DuckDB:</span>
<span id="cb92-119"><a href="#cb92-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-122"><a href="#cb92-122" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-123"><a href="#cb92-123" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: extract-tables</span></span>
<span id="cb92-124"><a href="#cb92-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-125"><a href="#cb92-125" aria-hidden="true" tabindex="-1"></a><span class="co"># ichthyo chain ----</span></span>
<span id="cb92-126"><a href="#cb92-126" aria-hidden="true" tabindex="-1"></a>tbl_cruise  <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"cruise"</span>)</span>
<span id="cb92-127"><a href="#cb92-127" aria-hidden="true" tabindex="-1"></a>tbl_ship    <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"ship"</span>)</span>
<span id="cb92-128"><a href="#cb92-128" aria-hidden="true" tabindex="-1"></a>tbl_site    <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"site"</span>)</span>
<span id="cb92-129"><a href="#cb92-129" aria-hidden="true" tabindex="-1"></a>tbl_tow     <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"tow"</span>)</span>
<span id="cb92-130"><a href="#cb92-130" aria-hidden="true" tabindex="-1"></a>tbl_net     <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"net"</span>)</span>
<span id="cb92-131"><a href="#cb92-131" aria-hidden="true" tabindex="-1"></a>tbl_ichthyo <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"ichthyo"</span>)</span>
<span id="cb92-132"><a href="#cb92-132" aria-hidden="true" tabindex="-1"></a>tbl_species <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"species"</span>)</span>
<span id="cb92-133"><a href="#cb92-133" aria-hidden="true" tabindex="-1"></a>tbl_lookup  <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"lookup"</span>)</span>
<span id="cb92-134"><a href="#cb92-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-135"><a href="#cb92-135" aria-hidden="true" tabindex="-1"></a><span class="co"># bottle chain ----</span></span>
<span id="cb92-136"><a href="#cb92-136" aria-hidden="true" tabindex="-1"></a>tbl_casts             <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"casts"</span>)</span>
<span id="cb92-137"><a href="#cb92-137" aria-hidden="true" tabindex="-1"></a>tbl_bottle            <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"bottle"</span>)</span>
<span id="cb92-138"><a href="#cb92-138" aria-hidden="true" tabindex="-1"></a>tbl_bottle_meas       <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"bottle_measurement"</span>)</span>
<span id="cb92-139"><a href="#cb92-139" aria-hidden="true" tabindex="-1"></a>tbl_cast_condition    <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"cast_condition"</span>)</span>
<span id="cb92-140"><a href="#cb92-140" aria-hidden="true" tabindex="-1"></a>tbl_measurement_type  <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"measurement_type"</span>)</span>
<span id="cb92-141"><a href="#cb92-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-142"><a href="#cb92-142" aria-hidden="true" tabindex="-1"></a><span class="co"># taxonomy ----</span></span>
<span id="cb92-143"><a href="#cb92-143" aria-hidden="true" tabindex="-1"></a>tbl_taxon     <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"taxon"</span>)</span>
<span id="cb92-144"><a href="#cb92-144" aria-hidden="true" tabindex="-1"></a>tbl_taxa_rank <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"taxa_rank"</span>)</span>
<span id="cb92-145"><a href="#cb92-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-146"><a href="#cb92-146" aria-hidden="true" tabindex="-1"></a><span class="co"># quick counts</span></span>
<span id="cb92-147"><a href="#cb92-147" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Table row counts:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-148"><a href="#cb92-148" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (tname <span class="cf">in</span> <span class="fu">c</span>(</span>
<span id="cb92-149"><a href="#cb92-149" aria-hidden="true" tabindex="-1"></a>  <span class="st">"cruise"</span>, <span class="st">"ship"</span>, <span class="st">"site"</span>, <span class="st">"tow"</span>, <span class="st">"net"</span>, <span class="st">"ichthyo"</span>, <span class="st">"species"</span>, <span class="st">"lookup"</span>,</span>
<span id="cb92-150"><a href="#cb92-150" aria-hidden="true" tabindex="-1"></a>  <span class="st">"casts"</span>, <span class="st">"bottle"</span>, <span class="st">"bottle_measurement"</span>, <span class="st">"cast_condition"</span>, <span class="st">"measurement_type"</span>,</span>
<span id="cb92-151"><a href="#cb92-151" aria-hidden="true" tabindex="-1"></a>  <span class="st">"taxon"</span>, <span class="st">"taxa_rank"</span>)) {</span>
<span id="cb92-152"><a href="#cb92-152" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, tname) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb92-153"><a href="#cb92-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"  {tname}: {prettyNum(n, big.mark = ',')}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-154"><a href="#cb92-154" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-155"><a href="#cb92-155" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-156"><a href="#cb92-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-157"><a href="#cb92-157" aria-hidden="true" tabindex="-1"></a><span class="fu">## Mint Globally Unique Identifiers</span></span>
<span id="cb92-158"><a href="#cb92-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-159"><a href="#cb92-159" aria-hidden="true" tabindex="-1"></a>The merged DuckDB uses integer <span class="in">`*_id`</span> columns for joins and SWFSC <span class="in">`_source_uuid`</span> for provenance. For OBIS, we need globally unique, stable identifiers:</span>
<span id="cb92-160"><a href="#cb92-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-161"><a href="#cb92-161" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Net eventID**: use net's <span class="in">`_source_uuid`</span> (original SWFSC UUID, unique per net)</span>
<span id="cb92-162"><a href="#cb92-162" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Ichthyo occurrenceID / measurementID**: mint deterministic UUID v5 from composite key</span>
<span id="cb92-163"><a href="#cb92-163" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Cast eventID**: mint deterministic UUID v5 from <span class="in">`cast_id`</span></span>
<span id="cb92-164"><a href="#cb92-164" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Bottle/cast eMoF measurementID**: mint deterministic UUID v5 from integer IDs</span>
<span id="cb92-165"><a href="#cb92-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-168"><a href="#cb92-168" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-169"><a href="#cb92-169" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mint-uuids</span></span>
<span id="cb92-170"><a href="#cb92-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-171"><a href="#cb92-171" aria-hidden="true" tabindex="-1"></a><span class="co"># collect net table with source UUIDs for eventID ----</span></span>
<span id="cb92-172"><a href="#cb92-172" aria-hidden="true" tabindex="-1"></a>d_net <span class="ot">&lt;-</span> tbl_net <span class="sc">|&gt;</span> <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb92-173"><a href="#cb92-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">net_uuid =</span> <span class="st">`</span><span class="at">_source_uuid</span><span class="st">`</span>)</span>
<span id="cb92-174"><a href="#cb92-174" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">duplicated</span>(d_net<span class="sc">$</span>net_uuid)))</span>
<span id="cb92-175"><a href="#cb92-175" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"Net UUIDs: {nrow(d_net)} (all unique)"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-176"><a href="#cb92-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-177"><a href="#cb92-177" aria-hidden="true" tabindex="-1"></a><span class="co"># collect and mint ichthyo UUIDs ----</span></span>
<span id="cb92-178"><a href="#cb92-178" aria-hidden="true" tabindex="-1"></a>d_ichthyo <span class="ot">&lt;-</span> tbl_ichthyo <span class="sc">|&gt;</span> <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb92-179"><a href="#cb92-179" aria-hidden="true" tabindex="-1"></a>  <span class="co"># join net_uuid for composite key</span></span>
<span id="cb92-180"><a href="#cb92-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d_net <span class="sc">|&gt;</span> <span class="fu">select</span>(net_id, net_uuid), <span class="at">by =</span> <span class="st">"net_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-181"><a href="#cb92-181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb92-182"><a href="#cb92-182" aria-hidden="true" tabindex="-1"></a>    <span class="at">ichthyo_uuid =</span> <span class="fu">UUIDfromName</span>(</span>
<span id="cb92-183"><a href="#cb92-183" aria-hidden="true" tabindex="-1"></a>      CALCOFI_NS,</span>
<span id="cb92-184"><a href="#cb92-184" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(</span>
<span id="cb92-185"><a href="#cb92-185" aria-hidden="true" tabindex="-1"></a>        net_uuid, <span class="st">"|"</span>,</span>
<span id="cb92-186"><a href="#cb92-186" aria-hidden="true" tabindex="-1"></a>        species_id, <span class="st">"|"</span>,</span>
<span id="cb92-187"><a href="#cb92-187" aria-hidden="true" tabindex="-1"></a>        life_stage, <span class="st">"|"</span>,</span>
<span id="cb92-188"><a href="#cb92-188" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>(<span class="fu">is.na</span>(measurement_type), <span class="st">""</span>, measurement_type), <span class="st">"|"</span>,</span>
<span id="cb92-189"><a href="#cb92-189" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ifelse</span>(<span class="fu">is.na</span>(measurement_value), <span class="st">""</span>, measurement_value))))</span>
<span id="cb92-190"><a href="#cb92-190" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">duplicated</span>(d_ichthyo<span class="sc">$</span>ichthyo_uuid)))</span>
<span id="cb92-191"><a href="#cb92-191" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"Ichthyo UUIDs: {nrow(d_ichthyo)} (all unique)"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-192"><a href="#cb92-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-193"><a href="#cb92-193" aria-hidden="true" tabindex="-1"></a><span class="co"># collect casts and mint cast_uuid ----</span></span>
<span id="cb92-194"><a href="#cb92-194" aria-hidden="true" tabindex="-1"></a>d_casts <span class="ot">&lt;-</span> tbl_casts <span class="sc">|&gt;</span> <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb92-195"><a href="#cb92-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb92-196"><a href="#cb92-196" aria-hidden="true" tabindex="-1"></a>    <span class="at">cast_uuid =</span> <span class="fu">UUIDfromName</span>(</span>
<span id="cb92-197"><a href="#cb92-197" aria-hidden="true" tabindex="-1"></a>      CALCOFI_NS,</span>
<span id="cb92-198"><a href="#cb92-198" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"cast:"</span>, cast_id)))</span>
<span id="cb92-199"><a href="#cb92-199" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">duplicated</span>(d_casts<span class="sc">$</span>cast_uuid)))</span>
<span id="cb92-200"><a href="#cb92-200" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"Cast UUIDs: {nrow(d_casts)} (all unique)"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-201"><a href="#cb92-201" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-202"><a href="#cb92-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-203"><a href="#cb92-203" aria-hidden="true" tabindex="-1"></a><span class="fu">## Life Stage Vocabulary</span></span>
<span id="cb92-204"><a href="#cb92-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-205"><a href="#cb92-205" aria-hidden="true" tabindex="-1"></a>Define mappings for egg and larva developmental stages to descriptive terms:</span>
<span id="cb92-206"><a href="#cb92-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-209"><a href="#cb92-209" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-210"><a href="#cb92-210" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: vocabulary-lookups</span></span>
<span id="cb92-211"><a href="#cb92-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-212"><a href="#cb92-212" aria-hidden="true" tabindex="-1"></a><span class="co"># P06 measurement unit vocabulary (NERC) ----</span></span>
<span id="cb92-213"><a href="#cb92-213" aria-hidden="true" tabindex="-1"></a>measurement_unit_vocab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb92-214"><a href="#cb92-214" aria-hidden="true" tabindex="-1"></a>  <span class="at">measurementUnit =</span> <span class="fu">c</span>(</span>
<span id="cb92-215"><a href="#cb92-215" aria-hidden="true" tabindex="-1"></a>    <span class="st">"individuals"</span>, <span class="st">"millimeters"</span>, <span class="st">"dimensionless"</span>, <span class="st">"cubic meters"</span>,</span>
<span id="cb92-216"><a href="#cb92-216" aria-hidden="true" tabindex="-1"></a>    <span class="st">"grams"</span>, <span class="st">"proportion"</span>, <span class="st">"m^3"</span>,</span>
<span id="cb92-217"><a href="#cb92-217" aria-hidden="true" tabindex="-1"></a>    <span class="st">"degC"</span>, <span class="st">"PSS-78"</span>, <span class="st">"ml/L"</span>, <span class="st">"umol/kg"</span>, <span class="st">"%"</span>, <span class="st">"kg/m3"</span>,</span>
<span id="cb92-218"><a href="#cb92-218" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ug/L"</span>, <span class="st">"umol/L"</span>, <span class="st">"mgC/m3/hld"</span>,</span>
<span id="cb92-219"><a href="#cb92-219" aria-hidden="true" tabindex="-1"></a>    <span class="st">"degrees"</span>, <span class="st">"feet"</span>, <span class="st">"seconds"</span>, <span class="st">"knots"</span>, <span class="st">"millibars"</span>,</span>
<span id="cb92-220"><a href="#cb92-220" aria-hidden="true" tabindex="-1"></a>    <span class="st">"oktas"</span>, <span class="st">"meters"</span>, <span class="st">"Forel-Ule"</span>, <span class="st">"pH"</span>,</span>
<span id="cb92-221"><a href="#cb92-221" aria-hidden="true" tabindex="-1"></a>    <span class="st">"10^-8 m3/kg"</span>, <span class="st">"dyn m"</span>),</span>
<span id="cb92-222"><a href="#cb92-222" aria-hidden="true" tabindex="-1"></a>  <span class="at">measurementUnitID =</span> <span class="fu">c</span>(</span>
<span id="cb92-223"><a href="#cb92-223" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,  <span class="co"># individuals</span></span>
<span id="cb92-224"><a href="#cb92-224" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UXMM/"</span>,  <span class="co"># millimeters</span></span>
<span id="cb92-225"><a href="#cb92-225" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,  <span class="co"># dimensionless</span></span>
<span id="cb92-226"><a href="#cb92-226" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/MCUB/"</span>,  <span class="co"># cubic meters</span></span>
<span id="cb92-227"><a href="#cb92-227" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UGRM/"</span>,  <span class="co"># grams</span></span>
<span id="cb92-228"><a href="#cb92-228" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,  <span class="co"># proportion</span></span>
<span id="cb92-229"><a href="#cb92-229" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/MCUB/"</span>,  <span class="co"># m^3</span></span>
<span id="cb92-230"><a href="#cb92-230" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UPAA/"</span>,  <span class="co"># degC</span></span>
<span id="cb92-231"><a href="#cb92-231" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UGKG/"</span>,  <span class="co"># PSS-78</span></span>
<span id="cb92-232"><a href="#cb92-232" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UMLL/"</span>,  <span class="co"># ml/L</span></span>
<span id="cb92-233"><a href="#cb92-233" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UMKG/"</span>,  <span class="co"># umol/kg</span></span>
<span id="cb92-234"><a href="#cb92-234" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UPCT/"</span>,  <span class="co"># %</span></span>
<span id="cb92-235"><a href="#cb92-235" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UKGM/"</span>,  <span class="co"># kg/m3</span></span>
<span id="cb92-236"><a href="#cb92-236" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UGPL/"</span>,  <span class="co"># ug/L</span></span>
<span id="cb92-237"><a href="#cb92-237" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UPOX/"</span>,  <span class="co"># umol/L</span></span>
<span id="cb92-238"><a href="#cb92-238" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,  <span class="co"># mgC/m3/hld (no std P06)</span></span>
<span id="cb92-239"><a href="#cb92-239" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UAAA/"</span>,  <span class="co"># degrees</span></span>
<span id="cb92-240"><a href="#cb92-240" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UXFT/"</span>,  <span class="co"># feet</span></span>
<span id="cb92-241"><a href="#cb92-241" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UTBB/"</span>,  <span class="co"># seconds</span></span>
<span id="cb92-242"><a href="#cb92-242" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UKNT/"</span>,  <span class="co"># knots</span></span>
<span id="cb92-243"><a href="#cb92-243" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UPML/"</span>,  <span class="co"># millibars</span></span>
<span id="cb92-244"><a href="#cb92-244" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,  <span class="co"># oktas (no std P06)</span></span>
<span id="cb92-245"><a href="#cb92-245" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/ULAA/"</span>,  <span class="co"># meters</span></span>
<span id="cb92-246"><a href="#cb92-246" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,  <span class="co"># Forel-Ule (no std P06)</span></span>
<span id="cb92-247"><a href="#cb92-247" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,  <span class="co"># pH</span></span>
<span id="cb92-248"><a href="#cb92-248" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,  <span class="co"># 10^-8 m3/kg</span></span>
<span id="cb92-249"><a href="#cb92-249" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>))  <span class="co"># dyn m</span></span>
<span id="cb92-250"><a href="#cb92-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-251"><a href="#cb92-251" aria-hidden="true" tabindex="-1"></a><span class="co"># NERC P01 vocabulary for bottle measurement types ----</span></span>
<span id="cb92-252"><a href="#cb92-252" aria-hidden="true" tabindex="-1"></a>bottle_p01_vocab <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb92-253"><a href="#cb92-253" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>measurement_type,     <span class="sc">~</span>measurementTypeID,</span>
<span id="cb92-254"><a href="#cb92-254" aria-hidden="true" tabindex="-1"></a>  <span class="st">"temperature"</span>,         <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/TEMPPR01/"</span>,</span>
<span id="cb92-255"><a href="#cb92-255" aria-hidden="true" tabindex="-1"></a>  <span class="st">"salinity"</span>,            <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/PSALST01/"</span>,</span>
<span id="cb92-256"><a href="#cb92-256" aria-hidden="true" tabindex="-1"></a>  <span class="st">"oxygen_ml_l"</span>,         <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/DOXYZZXX/"</span>,</span>
<span id="cb92-257"><a href="#cb92-257" aria-hidden="true" tabindex="-1"></a>  <span class="st">"oxygen_umol_kg"</span>,      <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/DLOXYUMK/"</span>,</span>
<span id="cb92-258"><a href="#cb92-258" aria-hidden="true" tabindex="-1"></a>  <span class="st">"oxygen_saturation"</span>,   <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/OXYSSC01/"</span>,</span>
<span id="cb92-259"><a href="#cb92-259" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sigma_theta"</span>,         <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/SIGTEQ01/"</span>,</span>
<span id="cb92-260"><a href="#cb92-260" aria-hidden="true" tabindex="-1"></a>  <span class="st">"chlorophyll_a"</span>,       <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/CPHLPR01/"</span>,</span>
<span id="cb92-261"><a href="#cb92-261" aria-hidden="true" tabindex="-1"></a>  <span class="st">"phaeopigment"</span>,        <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/PHAEFLUO/"</span>,</span>
<span id="cb92-262"><a href="#cb92-262" aria-hidden="true" tabindex="-1"></a>  <span class="st">"phosphate"</span>,           <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/PHOSZZXX/"</span>,</span>
<span id="cb92-263"><a href="#cb92-263" aria-hidden="true" tabindex="-1"></a>  <span class="st">"silicate"</span>,            <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/SLCAZZXX/"</span>,</span>
<span id="cb92-264"><a href="#cb92-264" aria-hidden="true" tabindex="-1"></a>  <span class="st">"nitrite"</span>,             <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/NTRIZZXX/"</span>,</span>
<span id="cb92-265"><a href="#cb92-265" aria-hidden="true" tabindex="-1"></a>  <span class="st">"nitrate"</span>,             <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/NTRAZZXX/"</span>,</span>
<span id="cb92-266"><a href="#cb92-266" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ammonia"</span>,             <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/AMOAZZXX/"</span>,</span>
<span id="cb92-267"><a href="#cb92-267" aria-hidden="true" tabindex="-1"></a>  <span class="st">"c14_rep1"</span>,            <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/OLOCSMP1/"</span>,</span>
<span id="cb92-268"><a href="#cb92-268" aria-hidden="true" tabindex="-1"></a>  <span class="st">"c14_rep2"</span>,            <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/OLOCSMP1/"</span>,</span>
<span id="cb92-269"><a href="#cb92-269" aria-hidden="true" tabindex="-1"></a>  <span class="st">"c14_dark"</span>,            <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/OLOCSMP1/"</span>,</span>
<span id="cb92-270"><a href="#cb92-270" aria-hidden="true" tabindex="-1"></a>  <span class="st">"c14_mean"</span>,            <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/OLOCSMP1/"</span>,</span>
<span id="cb92-271"><a href="#cb92-271" aria-hidden="true" tabindex="-1"></a>  <span class="st">"light_pct"</span>,           <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/IRRDSV01/"</span>,</span>
<span id="cb92-272"><a href="#cb92-272" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dic_rep1"</span>,            <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/DICATSWT/"</span>,</span>
<span id="cb92-273"><a href="#cb92-273" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dic_rep2"</span>,            <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/DICATSWT/"</span>,</span>
<span id="cb92-274"><a href="#cb92-274" aria-hidden="true" tabindex="-1"></a>  <span class="st">"alkalinity_rep1"</span>,     <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/MDMAP014/"</span>,</span>
<span id="cb92-275"><a href="#cb92-275" aria-hidden="true" tabindex="-1"></a>  <span class="st">"alkalinity_rep2"</span>,     <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/MDMAP014/"</span>,</span>
<span id="cb92-276"><a href="#cb92-276" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ph_rep1"</span>,             <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/PHXXZZXX/"</span>,</span>
<span id="cb92-277"><a href="#cb92-277" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ph_rep2"</span>,             <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/PHXXZZXX/"</span>,</span>
<span id="cb92-278"><a href="#cb92-278" aria-hidden="true" tabindex="-1"></a>  <span class="st">"r_depth"</span>,             <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/ADEPZZ01/"</span>,</span>
<span id="cb92-279"><a href="#cb92-279" aria-hidden="true" tabindex="-1"></a>  <span class="st">"r_temperature"</span>,       <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/TEMPPR01/"</span>,</span>
<span id="cb92-280"><a href="#cb92-280" aria-hidden="true" tabindex="-1"></a>  <span class="st">"r_salinity_sva"</span>,      <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/SVELXXXX/"</span>,</span>
<span id="cb92-281"><a href="#cb92-281" aria-hidden="true" tabindex="-1"></a>  <span class="st">"r_dynamic_height"</span>,    <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/DYNHTTAU/"</span>,</span>
<span id="cb92-282"><a href="#cb92-282" aria-hidden="true" tabindex="-1"></a>  <span class="st">"r_ammonium"</span>,          <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/AMOAZZXX/"</span>,</span>
<span id="cb92-283"><a href="#cb92-283" aria-hidden="true" tabindex="-1"></a>  <span class="st">"r_oxygen_umol_kg"</span>,    <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/DLOXYUMK/"</span>)</span>
<span id="cb92-284"><a href="#cb92-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-285"><a href="#cb92-285" aria-hidden="true" tabindex="-1"></a><span class="co"># NERC P01 vocabulary for cast condition types ----</span></span>
<span id="cb92-286"><a href="#cb92-286" aria-hidden="true" tabindex="-1"></a>cast_p01_vocab <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb92-287"><a href="#cb92-287" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>condition_type,       <span class="sc">~</span>measurementTypeID,</span>
<span id="cb92-288"><a href="#cb92-288" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wave_direction"</span>,      <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/GWDRZZ01/"</span>,</span>
<span id="cb92-289"><a href="#cb92-289" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wave_height"</span>,         <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/GAVHZZ01/"</span>,</span>
<span id="cb92-290"><a href="#cb92-290" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wave_period"</span>,         <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/GAVTZZ01/"</span>,</span>
<span id="cb92-291"><a href="#cb92-291" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wind_direction"</span>,      <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/EWDAZZ01/"</span>,</span>
<span id="cb92-292"><a href="#cb92-292" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wind_speed"</span>,          <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/EWSBZZ01/"</span>,</span>
<span id="cb92-293"><a href="#cb92-293" aria-hidden="true" tabindex="-1"></a>  <span class="st">"barometric_pressure"</span>, <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/CAPAZZ01/"</span>,</span>
<span id="cb92-294"><a href="#cb92-294" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dry_air_temp"</span>,        <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/CTMPZZ01/"</span>,</span>
<span id="cb92-295"><a href="#cb92-295" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wet_air_temp"</span>,        <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/CWETZZ01/"</span>,</span>
<span id="cb92-296"><a href="#cb92-296" aria-hidden="true" tabindex="-1"></a>  <span class="st">"weather_code"</span>,        <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/WMOCWWXX/"</span>,</span>
<span id="cb92-297"><a href="#cb92-297" aria-hidden="true" tabindex="-1"></a>  <span class="st">"cloud_type"</span>,          <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/WMOCLTXX/"</span>,</span>
<span id="cb92-298"><a href="#cb92-298" aria-hidden="true" tabindex="-1"></a>  <span class="st">"cloud_amount"</span>,        <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/CLAMAMTS/"</span>,</span>
<span id="cb92-299"><a href="#cb92-299" aria-hidden="true" tabindex="-1"></a>  <span class="st">"visibility"</span>,          <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/WMOVISXX/"</span>,</span>
<span id="cb92-300"><a href="#cb92-300" aria-hidden="true" tabindex="-1"></a>  <span class="st">"secchi_depth"</span>,        <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/SECCSDNX/"</span>,</span>
<span id="cb92-301"><a href="#cb92-301" aria-hidden="true" tabindex="-1"></a>  <span class="st">"water_color"</span>,         <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/CCOLXXXX/"</span>)</span>
<span id="cb92-302"><a href="#cb92-302" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-303"><a href="#cb92-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-304"><a href="#cb92-304" aria-hidden="true" tabindex="-1"></a><span class="fu">## Build Event Hierarchy</span></span>
<span id="cb92-305"><a href="#cb92-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-306"><a href="#cb92-306" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cruise Events</span></span>
<span id="cb92-307"><a href="#cb92-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-308"><a href="#cb92-308" aria-hidden="true" tabindex="-1"></a>Aggregate over both net tows and casts to build cruise-level events:</span>
<span id="cb92-309"><a href="#cb92-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-312"><a href="#cb92-312" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-313"><a href="#cb92-313" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: build-cruise-events</span></span>
<span id="cb92-314"><a href="#cb92-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-315"><a href="#cb92-315" aria-hidden="true" tabindex="-1"></a><span class="co"># collect joined net→tow→site for cruise summaries ----</span></span>
<span id="cb92-316"><a href="#cb92-316" aria-hidden="true" tabindex="-1"></a>d_net_site <span class="ot">&lt;-</span> d_net <span class="sc">|&gt;</span></span>
<span id="cb92-317"><a href="#cb92-317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb92-318"><a href="#cb92-318" aria-hidden="true" tabindex="-1"></a>    tbl_tow <span class="sc">|&gt;</span> <span class="fu">collect</span>() <span class="sc">|&gt;</span> <span class="fu">select</span>(tow_id, site_id, time_start),</span>
<span id="cb92-319"><a href="#cb92-319" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"tow_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-320"><a href="#cb92-320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb92-321"><a href="#cb92-321" aria-hidden="true" tabindex="-1"></a>    tbl_site <span class="sc">|&gt;</span> <span class="fu">collect</span>() <span class="sc">|&gt;</span> <span class="fu">select</span>(site_id, cruise_key, longitude, latitude, line, station),</span>
<span id="cb92-322"><a href="#cb92-322" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"site_id"</span>)</span>
<span id="cb92-323"><a href="#cb92-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-324"><a href="#cb92-324" aria-hidden="true" tabindex="-1"></a><span class="co"># net cruise summaries ----</span></span>
<span id="cb92-325"><a href="#cb92-325" aria-hidden="true" tabindex="-1"></a>d_net_cruise_summary <span class="ot">&lt;-</span> d_net_site <span class="sc">|&gt;</span></span>
<span id="cb92-326"><a href="#cb92-326" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cruise_key) <span class="sc">|&gt;</span></span>
<span id="cb92-327"><a href="#cb92-327" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb92-328"><a href="#cb92-328" aria-hidden="true" tabindex="-1"></a>    <span class="at">net_time_min =</span> <span class="fu">min</span>(time_start, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-329"><a href="#cb92-329" aria-hidden="true" tabindex="-1"></a>    <span class="at">net_time_max =</span> <span class="fu">max</span>(time_start, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-330"><a href="#cb92-330" aria-hidden="true" tabindex="-1"></a>    <span class="at">net_lon_min  =</span> <span class="fu">min</span>(longitude,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-331"><a href="#cb92-331" aria-hidden="true" tabindex="-1"></a>    <span class="at">net_lon_max  =</span> <span class="fu">max</span>(longitude,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-332"><a href="#cb92-332" aria-hidden="true" tabindex="-1"></a>    <span class="at">net_lat_min  =</span> <span class="fu">min</span>(latitude,   <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-333"><a href="#cb92-333" aria-hidden="true" tabindex="-1"></a>    <span class="at">net_lat_max  =</span> <span class="fu">max</span>(latitude,   <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-334"><a href="#cb92-334" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb92-335"><a href="#cb92-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-336"><a href="#cb92-336" aria-hidden="true" tabindex="-1"></a><span class="co"># cast cruise summaries ----</span></span>
<span id="cb92-337"><a href="#cb92-337" aria-hidden="true" tabindex="-1"></a>d_cast_cruise_summary <span class="ot">&lt;-</span> d_casts <span class="sc">|&gt;</span></span>
<span id="cb92-338"><a href="#cb92-338" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cruise_key) <span class="sc">|&gt;</span></span>
<span id="cb92-339"><a href="#cb92-339" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb92-340"><a href="#cb92-340" aria-hidden="true" tabindex="-1"></a>    <span class="at">cast_time_min =</span> <span class="fu">min</span>(datetime_utc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-341"><a href="#cb92-341" aria-hidden="true" tabindex="-1"></a>    <span class="at">cast_time_max =</span> <span class="fu">max</span>(datetime_utc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-342"><a href="#cb92-342" aria-hidden="true" tabindex="-1"></a>    <span class="at">cast_lon_min  =</span> <span class="fu">min</span>(lon_dec,      <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-343"><a href="#cb92-343" aria-hidden="true" tabindex="-1"></a>    <span class="at">cast_lon_max  =</span> <span class="fu">max</span>(lon_dec,      <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-344"><a href="#cb92-344" aria-hidden="true" tabindex="-1"></a>    <span class="at">cast_lat_min  =</span> <span class="fu">min</span>(lat_dec,      <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-345"><a href="#cb92-345" aria-hidden="true" tabindex="-1"></a>    <span class="at">cast_lat_max  =</span> <span class="fu">max</span>(lat_dec,      <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-346"><a href="#cb92-346" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb92-347"><a href="#cb92-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-348"><a href="#cb92-348" aria-hidden="true" tabindex="-1"></a><span class="co"># combine cruise metadata ----</span></span>
<span id="cb92-349"><a href="#cb92-349" aria-hidden="true" tabindex="-1"></a>d_cruise_events <span class="ot">&lt;-</span> tbl_cruise <span class="sc">|&gt;</span></span>
<span id="cb92-350"><a href="#cb92-350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_ship, <span class="at">by =</span> <span class="st">"ship_key"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-351"><a href="#cb92-351" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb92-352"><a href="#cb92-352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d_net_cruise_summary,  <span class="at">by =</span> <span class="st">"cruise_key"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-353"><a href="#cb92-353" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d_cast_cruise_summary, <span class="at">by =</span> <span class="st">"cruise_key"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-354"><a href="#cb92-354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb92-355"><a href="#cb92-355" aria-hidden="true" tabindex="-1"></a>    <span class="co"># date range: union of net tows and casts</span></span>
<span id="cb92-356"><a href="#cb92-356" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_min =</span> <span class="fu">pmin</span>(net_time_min, cast_time_min, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-357"><a href="#cb92-357" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_max =</span> <span class="fu">pmax</span>(net_time_max, cast_time_max, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-358"><a href="#cb92-358" aria-hidden="true" tabindex="-1"></a>    <span class="co"># bounding box: union of net sites and cast positions</span></span>
<span id="cb92-359"><a href="#cb92-359" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon_min =</span> <span class="fu">pmin</span>(net_lon_min, cast_lon_min, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-360"><a href="#cb92-360" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon_max =</span> <span class="fu">pmax</span>(net_lon_max, cast_lon_max, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-361"><a href="#cb92-361" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat_min =</span> <span class="fu">pmin</span>(net_lat_min, cast_lat_min, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-362"><a href="#cb92-362" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat_max =</span> <span class="fu">pmax</span>(net_lat_max, cast_lat_max, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb92-363"><a href="#cb92-363" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(time_min) <span class="sc">|</span> <span class="sc">!</span><span class="fu">is.na</span>(cast_time_min)) <span class="sc">|&gt;</span></span>
<span id="cb92-364"><a href="#cb92-364" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb92-365"><a href="#cb92-365" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID          =</span> cruise_key,</span>
<span id="cb92-366"><a href="#cb92-366" aria-hidden="true" tabindex="-1"></a>    <span class="at">parentEventID    =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb92-367"><a href="#cb92-367" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType        =</span> <span class="st">"cruise"</span>,</span>
<span id="cb92-368"><a href="#cb92-368" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventDate        =</span> <span class="fu">case_when</span>(</span>
<span id="cb92-369"><a href="#cb92-369" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(time_min) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(time_max) <span class="sc">~</span></span>
<span id="cb92-370"><a href="#cb92-370" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste0</span>(</span>
<span id="cb92-371"><a href="#cb92-371" aria-hidden="true" tabindex="-1"></a>          <span class="fu">format</span>(time_min, <span class="st">"%Y-%m-%dT%H:%M:%SZ"</span>), <span class="st">"/"</span>,</span>
<span id="cb92-372"><a href="#cb92-372" aria-hidden="true" tabindex="-1"></a>          <span class="fu">format</span>(time_max, <span class="st">"%Y-%m-%dT%H:%M:%SZ"</span>)),</span>
<span id="cb92-373"><a href="#cb92-373" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span>),</span>
<span id="cb92-374"><a href="#cb92-374" aria-hidden="true" tabindex="-1"></a>    <span class="at">footprintWKT     =</span> <span class="fu">case_when</span>(</span>
<span id="cb92-375"><a href="#cb92-375" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(lon_min) <span class="sc">~</span></span>
<span id="cb92-376"><a href="#cb92-376" aria-hidden="true" tabindex="-1"></a>        <span class="fu">glue</span>(<span class="st">"POLYGON(({lon_min} {lat_min}, {lon_max} {lat_min}, {lon_max} {lat_max}, {lon_min} {lat_max}, {lon_min} {lat_min}))"</span>),</span>
<span id="cb92-377"><a href="#cb92-377" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span>),</span>
<span id="cb92-378"><a href="#cb92-378" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="st">"Marine plankton survey cruise"</span>,</span>
<span id="cb92-379"><a href="#cb92-379" aria-hidden="true" tabindex="-1"></a>    <span class="at">habitat          =</span> <span class="st">"marine"</span>,</span>
<span id="cb92-380"><a href="#cb92-380" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks     =</span> <span class="fu">glue</span>(<span class="st">"Cruise on {ship_name} from {as.Date(time_min)} to {as.Date(time_max)}"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb92-381"><a href="#cb92-381" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb92-382"><a href="#cb92-382" aria-hidden="true" tabindex="-1"></a>    eventID, parentEventID, eventType, eventDate, footprintWKT,</span>
<span id="cb92-383"><a href="#cb92-383" aria-hidden="true" tabindex="-1"></a>    samplingProtocol, habitat, eventRemarks)</span>
<span id="cb92-384"><a href="#cb92-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-385"><a href="#cb92-385" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"Cruise events: {nrow(d_cruise_events)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-386"><a href="#cb92-386" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-387"><a href="#cb92-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-388"><a href="#cb92-388" aria-hidden="true" tabindex="-1"></a><span class="fu">### Net Sample Events</span></span>
<span id="cb92-389"><a href="#cb92-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-390"><a href="#cb92-390" aria-hidden="true" tabindex="-1"></a>Collapsed net_sample events (cruise → net_sample) with coordinates, date, and sampling info:</span>
<span id="cb92-391"><a href="#cb92-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-394"><a href="#cb92-394" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-395"><a href="#cb92-395" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: build-net-events</span></span>
<span id="cb92-396"><a href="#cb92-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-397"><a href="#cb92-397" aria-hidden="true" tabindex="-1"></a>d_net_events <span class="ot">&lt;-</span> d_net_site <span class="sc">|&gt;</span></span>
<span id="cb92-398"><a href="#cb92-398" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb92-399"><a href="#cb92-399" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID          =</span> net_uuid,</span>
<span id="cb92-400"><a href="#cb92-400" aria-hidden="true" tabindex="-1"></a>    <span class="at">parentEventID    =</span> cruise_key,</span>
<span id="cb92-401"><a href="#cb92-401" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType        =</span> <span class="st">"net_sample"</span>,</span>
<span id="cb92-402"><a href="#cb92-402" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventDate        =</span> <span class="fu">format</span>(time_start, <span class="st">"%Y-%m-%dT%H:%M:%SZ"</span>),</span>
<span id="cb92-403"><a href="#cb92-403" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimalLatitude  =</span> latitude,</span>
<span id="cb92-404"><a href="#cb92-404" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimalLongitude =</span> longitude,</span>
<span id="cb92-405"><a href="#cb92-405" aria-hidden="true" tabindex="-1"></a>    <span class="at">locationID       =</span> <span class="fu">paste0</span>(line, <span class="st">"_"</span>, station),</span>
<span id="cb92-406"><a href="#cb92-406" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="st">"CalCOFI ichthyoplankton net tow"</span>,</span>
<span id="cb92-407"><a href="#cb92-407" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeValue  =</span> vol_sampled_m3,</span>
<span id="cb92-408"><a href="#cb92-408" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeUnit   =</span> <span class="st">"m^3"</span>,</span>
<span id="cb92-409"><a href="#cb92-409" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks     =</span> <span class="fu">glue</span>(</span>
<span id="cb92-410"><a href="#cb92-410" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Net: {side} side; "</span>,</span>
<span id="cb92-411"><a href="#cb92-411" aria-hidden="true" tabindex="-1"></a>      <span class="st">"{prop_sorted} proportion sorted of {vol_sampled_m3} m3 sampled"</span>))</span>
<span id="cb92-412"><a href="#cb92-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-413"><a href="#cb92-413" aria-hidden="true" tabindex="-1"></a><span class="co"># keep full data for eMoF</span></span>
<span id="cb92-414"><a href="#cb92-414" aria-hidden="true" tabindex="-1"></a>d_net_events_full <span class="ot">&lt;-</span> d_net_events</span>
<span id="cb92-415"><a href="#cb92-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-416"><a href="#cb92-416" aria-hidden="true" tabindex="-1"></a>d_net_events <span class="ot">&lt;-</span> d_net_events <span class="sc">|&gt;</span></span>
<span id="cb92-417"><a href="#cb92-417" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb92-418"><a href="#cb92-418" aria-hidden="true" tabindex="-1"></a>    eventID, parentEventID, eventType, eventDate,</span>
<span id="cb92-419"><a href="#cb92-419" aria-hidden="true" tabindex="-1"></a>    decimalLatitude, decimalLongitude, locationID,</span>
<span id="cb92-420"><a href="#cb92-420" aria-hidden="true" tabindex="-1"></a>    samplingProtocol, sampleSizeValue, sampleSizeUnit, eventRemarks)</span>
<span id="cb92-421"><a href="#cb92-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-422"><a href="#cb92-422" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">duplicated</span>(d_net_events<span class="sc">$</span>eventID)))</span>
<span id="cb92-423"><a href="#cb92-423" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"Net sample events: {nrow(d_net_events)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-424"><a href="#cb92-424" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-425"><a href="#cb92-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-426"><a href="#cb92-426" aria-hidden="true" tabindex="-1"></a><span class="fu">### CTD Cast Events</span></span>
<span id="cb92-427"><a href="#cb92-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-428"><a href="#cb92-428" aria-hidden="true" tabindex="-1"></a>One event per cast:</span>
<span id="cb92-429"><a href="#cb92-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-432"><a href="#cb92-432" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-433"><a href="#cb92-433" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: build-cast-events</span></span>
<span id="cb92-434"><a href="#cb92-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-435"><a href="#cb92-435" aria-hidden="true" tabindex="-1"></a>d_cast_events <span class="ot">&lt;-</span> d_casts <span class="sc">|&gt;</span></span>
<span id="cb92-436"><a href="#cb92-436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb92-437"><a href="#cb92-437" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID          =</span> cast_uuid,</span>
<span id="cb92-438"><a href="#cb92-438" aria-hidden="true" tabindex="-1"></a>    <span class="at">parentEventID    =</span> cruise_key,</span>
<span id="cb92-439"><a href="#cb92-439" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType        =</span> <span class="st">"ctd_cast"</span>,</span>
<span id="cb92-440"><a href="#cb92-440" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventDate        =</span> <span class="fu">format</span>(datetime_utc, <span class="st">"%Y-%m-%dT%H:%M:%SZ"</span>),</span>
<span id="cb92-441"><a href="#cb92-441" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimalLatitude  =</span> lat_dec,</span>
<span id="cb92-442"><a href="#cb92-442" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimalLongitude =</span> lon_dec,</span>
<span id="cb92-443"><a href="#cb92-443" aria-hidden="true" tabindex="-1"></a>    <span class="at">locationID       =</span> <span class="fu">paste0</span>(rpt_line, <span class="st">"_"</span>, rpt_sta),</span>
<span id="cb92-444"><a href="#cb92-444" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="st">"CTD rosette cast"</span>,</span>
<span id="cb92-445"><a href="#cb92-445" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeValue  =</span> bottom_depth_m,</span>
<span id="cb92-446"><a href="#cb92-446" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeUnit   =</span> <span class="st">"m"</span>,</span>
<span id="cb92-447"><a href="#cb92-447" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks     =</span> <span class="fu">glue</span>(</span>
<span id="cb92-448"><a href="#cb92-448" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CTD cast at station {rpt_line}_{rpt_sta}, bottom depth {bottom_depth_m} m"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb92-449"><a href="#cb92-449" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb92-450"><a href="#cb92-450" aria-hidden="true" tabindex="-1"></a>    eventID, parentEventID, eventType, eventDate,</span>
<span id="cb92-451"><a href="#cb92-451" aria-hidden="true" tabindex="-1"></a>    decimalLatitude, decimalLongitude, locationID,</span>
<span id="cb92-452"><a href="#cb92-452" aria-hidden="true" tabindex="-1"></a>    samplingProtocol, sampleSizeValue, sampleSizeUnit, eventRemarks)</span>
<span id="cb92-453"><a href="#cb92-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-454"><a href="#cb92-454" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="sc">!</span><span class="fu">duplicated</span>(d_cast_events<span class="sc">$</span>eventID)))</span>
<span id="cb92-455"><a href="#cb92-455" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"CTD cast events: {nrow(d_cast_events)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-456"><a href="#cb92-456" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-457"><a href="#cb92-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-458"><a href="#cb92-458" aria-hidden="true" tabindex="-1"></a><span class="fu">### Combine All Events</span></span>
<span id="cb92-459"><a href="#cb92-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-462"><a href="#cb92-462" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-463"><a href="#cb92-463" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: combine-events</span></span>
<span id="cb92-464"><a href="#cb92-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-465"><a href="#cb92-465" aria-hidden="true" tabindex="-1"></a>d_event <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb92-466"><a href="#cb92-466" aria-hidden="true" tabindex="-1"></a>  d_cruise_events,</span>
<span id="cb92-467"><a href="#cb92-467" aria-hidden="true" tabindex="-1"></a>  d_net_events,</span>
<span id="cb92-468"><a href="#cb92-468" aria-hidden="true" tabindex="-1"></a>  d_cast_events) <span class="sc">|&gt;</span></span>
<span id="cb92-469"><a href="#cb92-469" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb92-470"><a href="#cb92-470" aria-hidden="true" tabindex="-1"></a>    <span class="at">geodeticDatum                 =</span> <span class="st">"WGS84"</span>,</span>
<span id="cb92-471"><a href="#cb92-471" aria-hidden="true" tabindex="-1"></a>    <span class="at">coordinateUncertaintyInMeters =</span> <span class="dv">1000</span>,</span>
<span id="cb92-472"><a href="#cb92-472" aria-hidden="true" tabindex="-1"></a>    <span class="at">countryCode                   =</span> country_code,</span>
<span id="cb92-473"><a href="#cb92-473" aria-hidden="true" tabindex="-1"></a>    <span class="at">waterBody                     =</span> water_body,</span>
<span id="cb92-474"><a href="#cb92-474" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasetID                     =</span> dataset_id)</span>
<span id="cb92-475"><a href="#cb92-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-476"><a href="#cb92-476" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Event counts by type:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-477"><a href="#cb92-477" aria-hidden="true" tabindex="-1"></a>d_event <span class="sc">|&gt;</span> <span class="fu">count</span>(eventType) <span class="sc">|&gt;</span> <span class="fu">print</span>()</span>
<span id="cb92-478"><a href="#cb92-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-479"><a href="#cb92-479" aria-hidden="true" tabindex="-1"></a><span class="co"># verify all child events have valid parentEventID</span></span>
<span id="cb92-480"><a href="#cb92-480" aria-hidden="true" tabindex="-1"></a>cruise_ids <span class="ot">&lt;-</span> d_event <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"cruise"</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(eventID)</span>
<span id="cb92-481"><a href="#cb92-481" aria-hidden="true" tabindex="-1"></a>child_events <span class="ot">&lt;-</span> d_event <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">!=</span> <span class="st">"cruise"</span>)</span>
<span id="cb92-482"><a href="#cb92-482" aria-hidden="true" tabindex="-1"></a>orphan_children <span class="ot">&lt;-</span> child_events <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>parentEventID <span class="sc">%in%</span> cruise_ids)</span>
<span id="cb92-483"><a href="#cb92-483" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(orphan_children) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb92-484"><a href="#cb92-484" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="fu">glue</span>(<span class="st">"{nrow(orphan_children)} child events have no matching cruise parent"</span>))</span>
<span id="cb92-485"><a href="#cb92-485" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb92-486"><a href="#cb92-486" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"All child events have valid cruise parents.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-487"><a href="#cb92-487" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-488"><a href="#cb92-488" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-489"><a href="#cb92-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-490"><a href="#cb92-490" aria-hidden="true" tabindex="-1"></a><span class="fu">## Build Occurrence Records</span></span>
<span id="cb92-491"><a href="#cb92-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-492"><a href="#cb92-492" aria-hidden="true" tabindex="-1"></a>From the consolidated <span class="in">`ichthyo`</span> table — one occurrence per life stage per species per net sample (tally rows where <span class="in">`measurement_type`</span> is NULL):</span>
<span id="cb92-493"><a href="#cb92-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-496"><a href="#cb92-496" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-497"><a href="#cb92-497" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: build-occurrences</span></span>
<span id="cb92-498"><a href="#cb92-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-499"><a href="#cb92-499" aria-hidden="true" tabindex="-1"></a>d_occurrence <span class="ot">&lt;-</span> d_ichthyo <span class="sc">|&gt;</span></span>
<span id="cb92-500"><a href="#cb92-500" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(measurement_type)) <span class="sc">|&gt;</span></span>
<span id="cb92-501"><a href="#cb92-501" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb92-502"><a href="#cb92-502" aria-hidden="true" tabindex="-1"></a>    tbl_species <span class="sc">|&gt;</span> <span class="fu">collect</span>(),</span>
<span id="cb92-503"><a href="#cb92-503" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"species_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-504"><a href="#cb92-504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb92-505"><a href="#cb92-505" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID         =</span> ichthyo_uuid,</span>
<span id="cb92-506"><a href="#cb92-506" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID              =</span> net_uuid,</span>
<span id="cb92-507"><a href="#cb92-507" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificName       =</span> scientific_name,</span>
<span id="cb92-508"><a href="#cb92-508" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificNameID     =</span> <span class="fu">ifelse</span>(</span>
<span id="cb92-509"><a href="#cb92-509" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.na</span>(worms_id) <span class="sc">&amp;</span> worms_id <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb92-510"><a href="#cb92-510" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"urn:lsid:marinespecies.org:taxname:"</span>, worms_id),</span>
<span id="cb92-511"><a href="#cb92-511" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NA_character_</span>),</span>
<span id="cb92-512"><a href="#cb92-512" aria-hidden="true" tabindex="-1"></a>    <span class="at">kingdom              =</span> <span class="st">"Animalia"</span>,</span>
<span id="cb92-513"><a href="#cb92-513" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceStatus     =</span> <span class="fu">ifelse</span>(tally <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"present"</span>, <span class="st">"absent"</span>),</span>
<span id="cb92-514"><a href="#cb92-514" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantity     =</span> tally,</span>
<span id="cb92-515"><a href="#cb92-515" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantityType =</span> <span class="st">"individuals"</span>,</span>
<span id="cb92-516"><a href="#cb92-516" aria-hidden="true" tabindex="-1"></a>    <span class="at">lifeStage            =</span> life_stage,</span>
<span id="cb92-517"><a href="#cb92-517" aria-hidden="true" tabindex="-1"></a>    <span class="at">preparations         =</span> <span class="fu">paste0</span>(life_stage, <span class="st">" sample"</span>),</span>
<span id="cb92-518"><a href="#cb92-518" aria-hidden="true" tabindex="-1"></a>    <span class="at">basisOfRecord        =</span> <span class="st">"HumanObservation"</span>,</span>
<span id="cb92-519"><a href="#cb92-519" aria-hidden="true" tabindex="-1"></a>    <span class="at">modified             =</span> <span class="fu">Sys.Date</span>())</span>
<span id="cb92-520"><a href="#cb92-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-521"><a href="#cb92-521" aria-hidden="true" tabindex="-1"></a><span class="co"># verify all occurrences link to valid net_sample events</span></span>
<span id="cb92-522"><a href="#cb92-522" aria-hidden="true" tabindex="-1"></a>net_ids <span class="ot">&lt;-</span> d_net_events <span class="sc">|&gt;</span> <span class="fu">pull</span>(eventID)</span>
<span id="cb92-523"><a href="#cb92-523" aria-hidden="true" tabindex="-1"></a>orphan_occs <span class="ot">&lt;-</span> d_occurrence <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>eventID <span class="sc">%in%</span> net_ids)</span>
<span id="cb92-524"><a href="#cb92-524" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(orphan_occs) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb92-525"><a href="#cb92-525" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="fu">glue</span>(<span class="st">"{nrow(orphan_occs)} occurrences have no matching net_sample event"</span>))</span>
<span id="cb92-526"><a href="#cb92-526" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb92-527"><a href="#cb92-527" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"All occurrences link to valid net_sample events.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-528"><a href="#cb92-528" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-529"><a href="#cb92-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-530"><a href="#cb92-530" aria-hidden="true" tabindex="-1"></a>d_occurrence_out <span class="ot">&lt;-</span> d_occurrence <span class="sc">|&gt;</span></span>
<span id="cb92-531"><a href="#cb92-531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb92-532"><a href="#cb92-532" aria-hidden="true" tabindex="-1"></a>    occurrenceID, eventID, scientificName, scientificNameID,</span>
<span id="cb92-533"><a href="#cb92-533" aria-hidden="true" tabindex="-1"></a>    kingdom, occurrenceStatus, organismQuantity, organismQuantityType,</span>
<span id="cb92-534"><a href="#cb92-534" aria-hidden="true" tabindex="-1"></a>    lifeStage, preparations, basisOfRecord, modified)</span>
<span id="cb92-535"><a href="#cb92-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-536"><a href="#cb92-536" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"Occurrences: {nrow(d_occurrence_out)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-537"><a href="#cb92-537" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"Unique species: {n_distinct(d_occurrence_out$scientificName)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-538"><a href="#cb92-538" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-539"><a href="#cb92-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-540"><a href="#cb92-540" aria-hidden="true" tabindex="-1"></a><span class="fu">## Build ExtendedMeasurementOrFact Extension</span></span>
<span id="cb92-541"><a href="#cb92-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-542"><a href="#cb92-542" aria-hidden="true" tabindex="-1"></a><span class="fu">### 10a. Net-level sample measurements</span></span>
<span id="cb92-543"><a href="#cb92-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-546"><a href="#cb92-546" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-547"><a href="#cb92-547" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: emof-net-level</span></span>
<span id="cb92-548"><a href="#cb92-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-549"><a href="#cb92-549" aria-hidden="true" tabindex="-1"></a>d_emof_net <span class="ot">&lt;-</span> d_net_events_full <span class="sc">|&gt;</span></span>
<span id="cb92-550"><a href="#cb92-550" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(eventID, net_uuid, std_haul_factor, prop_sorted, smallplankton, totalplankton) <span class="sc">|&gt;</span></span>
<span id="cb92-551"><a href="#cb92-551" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb92-552"><a href="#cb92-552" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols      =</span> <span class="fu">c</span>(std_haul_factor, prop_sorted, smallplankton, totalplankton),</span>
<span id="cb92-553"><a href="#cb92-553" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to  =</span> <span class="st">"meas_type"</span>,</span>
<span id="cb92-554"><a href="#cb92-554" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"measurementValue"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-555"><a href="#cb92-555" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(measurementValue)) <span class="sc">|&gt;</span></span>
<span id="cb92-556"><a href="#cb92-556" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb92-557"><a href="#cb92-557" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID =</span> <span class="fu">UUIDfromName</span>(</span>
<span id="cb92-558"><a href="#cb92-558" aria-hidden="true" tabindex="-1"></a>      CALCOFI_NS,</span>
<span id="cb92-559"><a href="#cb92-559" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"net:"</span>, net_uuid, <span class="st">":"</span>, meas_type)),</span>
<span id="cb92-560"><a href="#cb92-560" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID     =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb92-561"><a href="#cb92-561" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType  =</span> <span class="fu">case_when</span>(</span>
<span id="cb92-562"><a href="#cb92-562" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span> <span class="sc">~</span> <span class="st">"standardized haul factor"</span>,</span>
<span id="cb92-563"><a href="#cb92-563" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span>     <span class="sc">~</span> <span class="st">"proportion of sample sorted"</span>,</span>
<span id="cb92-564"><a href="#cb92-564" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"smallplankton"</span>   <span class="sc">~</span> <span class="st">"small plankton biomass"</span>,</span>
<span id="cb92-565"><a href="#cb92-565" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"totalplankton"</span>   <span class="sc">~</span> <span class="st">"total plankton biomass"</span>),</span>
<span id="cb92-566"><a href="#cb92-566" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb92-567"><a href="#cb92-567" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit  =</span> <span class="fu">case_when</span>(</span>
<span id="cb92-568"><a href="#cb92-568" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span>                         <span class="sc">~</span> <span class="st">"dimensionless"</span>,</span>
<span id="cb92-569"><a href="#cb92-569" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span>                             <span class="sc">~</span> <span class="st">"dimensionless"</span>,</span>
<span id="cb92-570"><a href="#cb92-570" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"smallplankton"</span>, <span class="st">"totalplankton"</span>)     <span class="sc">~</span> <span class="st">"grams"</span>),</span>
<span id="cb92-571"><a href="#cb92-571" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod  =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb92-572"><a href="#cb92-572" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> <span class="fu">case_when</span>(</span>
<span id="cb92-573"><a href="#cb92-573" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span> <span class="sc">~</span></span>
<span id="cb92-574"><a href="#cb92-574" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Standardization factor for water filtered; abundances per 10 m^2 (Smith 1977)"</span>,</span>
<span id="cb92-575"><a href="#cb92-575" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span> <span class="sc">~</span> <span class="st">"Fraction of total sample examined"</span>,</span>
<span id="cb92-576"><a href="#cb92-576" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span>)) <span class="sc">|&gt;</span></span>
<span id="cb92-577"><a href="#cb92-577" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-578"><a href="#cb92-578" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb92-579"><a href="#cb92-579" aria-hidden="true" tabindex="-1"></a>    eventID, occurrenceID, measurementID, measurementType, measurementTypeID,</span>
<span id="cb92-580"><a href="#cb92-580" aria-hidden="true" tabindex="-1"></a>    measurementValue, measurementUnit, measurementUnitID,</span>
<span id="cb92-581"><a href="#cb92-581" aria-hidden="true" tabindex="-1"></a>    measurementMethod, measurementRemarks)</span>
<span id="cb92-582"><a href="#cb92-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-583"><a href="#cb92-583" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"eMoF net-level: {nrow(d_emof_net)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-584"><a href="#cb92-584" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-585"><a href="#cb92-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-586"><a href="#cb92-586" aria-hidden="true" tabindex="-1"></a><span class="fu">### 10b. Stage-specific abundance</span></span>
<span id="cb92-587"><a href="#cb92-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-588"><a href="#cb92-588" aria-hidden="true" tabindex="-1"></a>From <span class="in">`ichthyo`</span> rows where <span class="in">`measurement_type = 'stage'`</span>, linked to the matching tally row's <span class="in">`ichthyo_uuid`</span> as <span class="in">`occurrenceID`</span>:</span>
<span id="cb92-589"><a href="#cb92-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-592"><a href="#cb92-592" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-593"><a href="#cb92-593" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: emof-stage-abundance</span></span>
<span id="cb92-594"><a href="#cb92-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-595"><a href="#cb92-595" aria-hidden="true" tabindex="-1"></a><span class="co"># build lookup: tally occurrenceIDs with their eventID (net_uuid)</span></span>
<span id="cb92-596"><a href="#cb92-596" aria-hidden="true" tabindex="-1"></a>d_occ_lookup <span class="ot">&lt;-</span> d_occurrence <span class="sc">|&gt;</span></span>
<span id="cb92-597"><a href="#cb92-597" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(net_id, species_id, life_stage,</span>
<span id="cb92-598"><a href="#cb92-598" aria-hidden="true" tabindex="-1"></a>         <span class="at">occurrenceID =</span> ichthyo_uuid, <span class="at">occ_eventID =</span> eventID)</span>
<span id="cb92-599"><a href="#cb92-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-600"><a href="#cb92-600" aria-hidden="true" tabindex="-1"></a><span class="co"># collect lookup descriptions for stages</span></span>
<span id="cb92-601"><a href="#cb92-601" aria-hidden="true" tabindex="-1"></a>d_lookup <span class="ot">&lt;-</span> tbl_lookup <span class="sc">|&gt;</span></span>
<span id="cb92-602"><a href="#cb92-602" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(lookup_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"egg_stage"</span>, <span class="st">"larva_stage"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb92-603"><a href="#cb92-603" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb92-604"><a href="#cb92-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-605"><a href="#cb92-605" aria-hidden="true" tabindex="-1"></a><span class="co"># stage records — join to lookup via derived lookup_type</span></span>
<span id="cb92-606"><a href="#cb92-606" aria-hidden="true" tabindex="-1"></a>d_emof_stage <span class="ot">&lt;-</span> d_ichthyo <span class="sc">|&gt;</span></span>
<span id="cb92-607"><a href="#cb92-607" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(measurement_type <span class="sc">==</span> <span class="st">"stage"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-608"><a href="#cb92-608" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb92-609"><a href="#cb92-609" aria-hidden="true" tabindex="-1"></a>    <span class="at">lookup_type =</span> <span class="fu">paste0</span>(life_stage, <span class="st">"_stage"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb92-610"><a href="#cb92-610" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb92-611"><a href="#cb92-611" aria-hidden="true" tabindex="-1"></a>    d_lookup <span class="sc">|&gt;</span> <span class="fu">select</span>(lookup_type, lookup_num, description),</span>
<span id="cb92-612"><a href="#cb92-612" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"lookup_type"</span>, <span class="st">"measurement_value"</span> <span class="ot">=</span> <span class="st">"lookup_num"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb92-613"><a href="#cb92-613" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d_occ_lookup, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"net_id"</span>, <span class="st">"species_id"</span>, <span class="st">"life_stage"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb92-614"><a href="#cb92-614" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb92-615"><a href="#cb92-615" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID            =</span> occ_eventID,</span>
<span id="cb92-616"><a href="#cb92-616" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID      =</span> ichthyo_uuid,</span>
<span id="cb92-617"><a href="#cb92-617" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType    =</span> <span class="st">"abundance by life stage"</span>,</span>
<span id="cb92-618"><a href="#cb92-618" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID  =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb92-619"><a href="#cb92-619" aria-hidden="true" tabindex="-1"></a>    <span class="at">meas_val           =</span> tally,</span>
<span id="cb92-620"><a href="#cb92-620" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValueID =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb92-621"><a href="#cb92-621" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit    =</span> <span class="st">"individuals"</span>,</span>
<span id="cb92-622"><a href="#cb92-622" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod  =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb92-623"><a href="#cb92-623" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> description) <span class="sc">|&gt;</span></span>
<span id="cb92-624"><a href="#cb92-624" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-625"><a href="#cb92-625" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb92-626"><a href="#cb92-626" aria-hidden="true" tabindex="-1"></a>    eventID, occurrenceID, measurementID, measurementType, measurementTypeID,</span>
<span id="cb92-627"><a href="#cb92-627" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue =</span> meas_val, measurementValueID,</span>
<span id="cb92-628"><a href="#cb92-628" aria-hidden="true" tabindex="-1"></a>    measurementUnit, measurementUnitID,</span>
<span id="cb92-629"><a href="#cb92-629" aria-hidden="true" tabindex="-1"></a>    measurementMethod, measurementRemarks)</span>
<span id="cb92-630"><a href="#cb92-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-631"><a href="#cb92-631" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"eMoF stage abundance: {nrow(d_emof_stage)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-632"><a href="#cb92-632" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-633"><a href="#cb92-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-634"><a href="#cb92-634" aria-hidden="true" tabindex="-1"></a><span class="fu">### 10c. Body length measurements</span></span>
<span id="cb92-635"><a href="#cb92-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-636"><a href="#cb92-636" aria-hidden="true" tabindex="-1"></a>From <span class="in">`ichthyo`</span> rows where <span class="in">`measurement_type = 'size'`</span>:</span>
<span id="cb92-637"><a href="#cb92-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-640"><a href="#cb92-640" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-641"><a href="#cb92-641" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: emof-body-length</span></span>
<span id="cb92-642"><a href="#cb92-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-643"><a href="#cb92-643" aria-hidden="true" tabindex="-1"></a>d_emof_length <span class="ot">&lt;-</span> d_ichthyo <span class="sc">|&gt;</span></span>
<span id="cb92-644"><a href="#cb92-644" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(measurement_type <span class="sc">==</span> <span class="st">"size"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-645"><a href="#cb92-645" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d_occ_lookup, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"net_id"</span>, <span class="st">"species_id"</span>, <span class="st">"life_stage"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb92-646"><a href="#cb92-646" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(measurement_value)) <span class="sc">|&gt;</span></span>
<span id="cb92-647"><a href="#cb92-647" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb92-648"><a href="#cb92-648" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID            =</span> occ_eventID,</span>
<span id="cb92-649"><a href="#cb92-649" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID      =</span> ichthyo_uuid,</span>
<span id="cb92-650"><a href="#cb92-650" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType    =</span> <span class="st">"body length"</span>,</span>
<span id="cb92-651"><a href="#cb92-651" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID  =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb92-652"><a href="#cb92-652" aria-hidden="true" tabindex="-1"></a>    <span class="at">meas_val           =</span> measurement_value,</span>
<span id="cb92-653"><a href="#cb92-653" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValueID =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb92-654"><a href="#cb92-654" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit    =</span> <span class="st">"millimeters"</span>,</span>
<span id="cb92-655"><a href="#cb92-655" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod  =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb92-656"><a href="#cb92-656" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> <span class="fu">paste0</span>(<span class="st">"Count: "</span>, tally, <span class="st">"; Total length measurement"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb92-657"><a href="#cb92-657" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-658"><a href="#cb92-658" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb92-659"><a href="#cb92-659" aria-hidden="true" tabindex="-1"></a>    eventID, occurrenceID, measurementID, measurementType, measurementTypeID,</span>
<span id="cb92-660"><a href="#cb92-660" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue =</span> meas_val, measurementValueID,</span>
<span id="cb92-661"><a href="#cb92-661" aria-hidden="true" tabindex="-1"></a>    measurementUnit, measurementUnitID,</span>
<span id="cb92-662"><a href="#cb92-662" aria-hidden="true" tabindex="-1"></a>    measurementMethod, measurementRemarks)</span>
<span id="cb92-663"><a href="#cb92-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-664"><a href="#cb92-664" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"eMoF body length: {nrow(d_emof_length)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-665"><a href="#cb92-665" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-666"><a href="#cb92-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-667"><a href="#cb92-667" aria-hidden="true" tabindex="-1"></a><span class="fu">### 10d. Bottle measurements</span></span>
<span id="cb92-668"><a href="#cb92-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-669"><a href="#cb92-669" aria-hidden="true" tabindex="-1"></a>From <span class="in">`bottle_measurement`</span> joined through <span class="in">`bottle`</span> → <span class="in">`casts`</span>:</span>
<span id="cb92-670"><a href="#cb92-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-673"><a href="#cb92-673" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-674"><a href="#cb92-674" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: emof-bottle</span></span>
<span id="cb92-675"><a href="#cb92-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-676"><a href="#cb92-676" aria-hidden="true" tabindex="-1"></a><span class="co"># build cast_id → cast_uuid lookup</span></span>
<span id="cb92-677"><a href="#cb92-677" aria-hidden="true" tabindex="-1"></a>d_cast_uuid_lookup <span class="ot">&lt;-</span> d_casts <span class="sc">|&gt;</span> <span class="fu">select</span>(cast_id, cast_uuid)</span>
<span id="cb92-678"><a href="#cb92-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-679"><a href="#cb92-679" aria-hidden="true" tabindex="-1"></a><span class="co"># get measurement type descriptions and units</span></span>
<span id="cb92-680"><a href="#cb92-680" aria-hidden="true" tabindex="-1"></a>d_mtype <span class="ot">&lt;-</span> tbl_measurement_type <span class="sc">|&gt;</span></span>
<span id="cb92-681"><a href="#cb92-681" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dataset <span class="sc">==</span> <span class="st">"bottle"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-682"><a href="#cb92-682" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb92-683"><a href="#cb92-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-684"><a href="#cb92-684" aria-hidden="true" tabindex="-1"></a>d_emof_bottle <span class="ot">&lt;-</span> tbl_bottle_meas <span class="sc">|&gt;</span></span>
<span id="cb92-685"><a href="#cb92-685" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_bottle <span class="sc">|&gt;</span> <span class="fu">select</span>(bottle_id, cast_id, depth_m), <span class="at">by =</span> <span class="st">"bottle_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-686"><a href="#cb92-686" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb92-687"><a href="#cb92-687" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(d_cast_uuid_lookup, <span class="at">by =</span> <span class="st">"cast_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-688"><a href="#cb92-688" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(d_mtype <span class="sc">|&gt;</span> <span class="fu">select</span>(measurement_type, description, units), <span class="at">by =</span> <span class="st">"measurement_type"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-689"><a href="#cb92-689" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(bottle_p01_vocab, <span class="at">by =</span> <span class="st">"measurement_type"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-690"><a href="#cb92-690" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb92-691"><a href="#cb92-691" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID            =</span> cast_uuid,</span>
<span id="cb92-692"><a href="#cb92-692" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID       =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb92-693"><a href="#cb92-693" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID      =</span> <span class="fu">UUIDfromName</span>(</span>
<span id="cb92-694"><a href="#cb92-694" aria-hidden="true" tabindex="-1"></a>      CALCOFI_NS,</span>
<span id="cb92-695"><a href="#cb92-695" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"bm:"</span>, bottle_measurement_id)),</span>
<span id="cb92-696"><a href="#cb92-696" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType    =</span> description,</span>
<span id="cb92-697"><a href="#cb92-697" aria-hidden="true" tabindex="-1"></a>    <span class="at">meas_val           =</span> measurement_value,</span>
<span id="cb92-698"><a href="#cb92-698" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit    =</span> units,</span>
<span id="cb92-699"><a href="#cb92-699" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod  =</span> <span class="st">"https://calcofi.org/data/oceanographic-data/bottle-database/"</span>,</span>
<span id="cb92-700"><a href="#cb92-700" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> <span class="fu">paste0</span>(<span class="st">"depth_m: "</span>, depth_m)) <span class="sc">|&gt;</span></span>
<span id="cb92-701"><a href="#cb92-701" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-702"><a href="#cb92-702" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb92-703"><a href="#cb92-703" aria-hidden="true" tabindex="-1"></a>    eventID, occurrenceID, measurementID, measurementType, measurementTypeID,</span>
<span id="cb92-704"><a href="#cb92-704" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue =</span> meas_val,</span>
<span id="cb92-705"><a href="#cb92-705" aria-hidden="true" tabindex="-1"></a>    measurementUnit, measurementUnitID,</span>
<span id="cb92-706"><a href="#cb92-706" aria-hidden="true" tabindex="-1"></a>    measurementMethod, measurementRemarks)</span>
<span id="cb92-707"><a href="#cb92-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-708"><a href="#cb92-708" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"eMoF bottle measurements: {nrow(d_emof_bottle)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-709"><a href="#cb92-709" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-710"><a href="#cb92-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-711"><a href="#cb92-711" aria-hidden="true" tabindex="-1"></a><span class="fu">### 10e. Cast conditions</span></span>
<span id="cb92-712"><a href="#cb92-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-713"><a href="#cb92-713" aria-hidden="true" tabindex="-1"></a>From <span class="in">`cast_condition`</span> joined to <span class="in">`casts`</span>:</span>
<span id="cb92-714"><a href="#cb92-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-717"><a href="#cb92-717" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-718"><a href="#cb92-718" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: emof-cast-conditions</span></span>
<span id="cb92-719"><a href="#cb92-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-720"><a href="#cb92-720" aria-hidden="true" tabindex="-1"></a>d_emof_cast_cond <span class="ot">&lt;-</span> tbl_cast_condition <span class="sc">|&gt;</span></span>
<span id="cb92-721"><a href="#cb92-721" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb92-722"><a href="#cb92-722" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(d_cast_uuid_lookup, <span class="at">by =</span> <span class="st">"cast_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-723"><a href="#cb92-723" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb92-724"><a href="#cb92-724" aria-hidden="true" tabindex="-1"></a>    tbl_measurement_type <span class="sc">|&gt;</span></span>
<span id="cb92-725"><a href="#cb92-725" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(dataset <span class="sc">==</span> <span class="st">"cast"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-726"><a href="#cb92-726" aria-hidden="true" tabindex="-1"></a>      <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb92-727"><a href="#cb92-727" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(measurement_type, description, units),</span>
<span id="cb92-728"><a href="#cb92-728" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"condition_type"</span> <span class="ot">=</span> <span class="st">"measurement_type"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb92-729"><a href="#cb92-729" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(cast_p01_vocab, <span class="at">by =</span> <span class="st">"condition_type"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-730"><a href="#cb92-730" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb92-731"><a href="#cb92-731" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID            =</span> cast_uuid,</span>
<span id="cb92-732"><a href="#cb92-732" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID       =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb92-733"><a href="#cb92-733" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID      =</span> <span class="fu">UUIDfromName</span>(</span>
<span id="cb92-734"><a href="#cb92-734" aria-hidden="true" tabindex="-1"></a>      CALCOFI_NS,</span>
<span id="cb92-735"><a href="#cb92-735" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"cc:"</span>, cast_condition_id)),</span>
<span id="cb92-736"><a href="#cb92-736" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType    =</span> description,</span>
<span id="cb92-737"><a href="#cb92-737" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue   =</span> condition_value,</span>
<span id="cb92-738"><a href="#cb92-738" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit    =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(units) <span class="sc">|</span> units <span class="sc">==</span> <span class="st">""</span>, <span class="cn">NA_character_</span>, units),</span>
<span id="cb92-739"><a href="#cb92-739" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod  =</span> <span class="st">"https://calcofi.org/data/oceanographic-data/bottle-database/"</span>,</span>
<span id="cb92-740"><a href="#cb92-740" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> <span class="cn">NA_character_</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-741"><a href="#cb92-741" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-742"><a href="#cb92-742" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb92-743"><a href="#cb92-743" aria-hidden="true" tabindex="-1"></a>    eventID, occurrenceID, measurementID, measurementType, measurementTypeID,</span>
<span id="cb92-744"><a href="#cb92-744" aria-hidden="true" tabindex="-1"></a>    measurementValue,</span>
<span id="cb92-745"><a href="#cb92-745" aria-hidden="true" tabindex="-1"></a>    measurementUnit, measurementUnitID,</span>
<span id="cb92-746"><a href="#cb92-746" aria-hidden="true" tabindex="-1"></a>    measurementMethod, measurementRemarks)</span>
<span id="cb92-747"><a href="#cb92-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-748"><a href="#cb92-748" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"eMoF cast conditions: {nrow(d_emof_cast_cond)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-749"><a href="#cb92-749" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-750"><a href="#cb92-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-751"><a href="#cb92-751" aria-hidden="true" tabindex="-1"></a><span class="fu">### Combine All eMoF Records</span></span>
<span id="cb92-752"><a href="#cb92-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-755"><a href="#cb92-755" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-756"><a href="#cb92-756" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: combine-emof</span></span>
<span id="cb92-757"><a href="#cb92-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-758"><a href="#cb92-758" aria-hidden="true" tabindex="-1"></a>d_emof <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb92-759"><a href="#cb92-759" aria-hidden="true" tabindex="-1"></a>  d_emof_net,</span>
<span id="cb92-760"><a href="#cb92-760" aria-hidden="true" tabindex="-1"></a>  d_emof_stage <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>measurementValueID),</span>
<span id="cb92-761"><a href="#cb92-761" aria-hidden="true" tabindex="-1"></a>  d_emof_length <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>measurementValueID),</span>
<span id="cb92-762"><a href="#cb92-762" aria-hidden="true" tabindex="-1"></a>  d_emof_bottle,</span>
<span id="cb92-763"><a href="#cb92-763" aria-hidden="true" tabindex="-1"></a>  d_emof_cast_cond)</span>
<span id="cb92-764"><a href="#cb92-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-765"><a href="#cb92-765" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"eMoF counts by source:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-766"><a href="#cb92-766" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"  Net-level:       {nrow(d_emof_net)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-767"><a href="#cb92-767" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"  Stage abundance: {nrow(d_emof_stage)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-768"><a href="#cb92-768" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"  Body length:     {nrow(d_emof_length)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-769"><a href="#cb92-769" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"  Bottle meas:     {nrow(d_emof_bottle)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-770"><a href="#cb92-770" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"  Cast conditions: {nrow(d_emof_cast_cond)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-771"><a href="#cb92-771" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"  Total:           {nrow(d_emof)}"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-772"><a href="#cb92-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-773"><a href="#cb92-773" aria-hidden="true" tabindex="-1"></a><span class="co"># verify all eMoF records link to a valid eventID or occurrenceID</span></span>
<span id="cb92-774"><a href="#cb92-774" aria-hidden="true" tabindex="-1"></a>event_ids <span class="ot">&lt;-</span> d_event<span class="sc">$</span>eventID</span>
<span id="cb92-775"><a href="#cb92-775" aria-hidden="true" tabindex="-1"></a>occ_ids   <span class="ot">&lt;-</span> d_occurrence_out<span class="sc">$</span>occurrenceID</span>
<span id="cb92-776"><a href="#cb92-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-777"><a href="#cb92-777" aria-hidden="true" tabindex="-1"></a>emof_with_event <span class="ot">&lt;-</span> d_emof <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(eventID))</span>
<span id="cb92-778"><a href="#cb92-778" aria-hidden="true" tabindex="-1"></a>emof_with_occ   <span class="ot">&lt;-</span> d_emof <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(occurrenceID))</span>
<span id="cb92-779"><a href="#cb92-779" aria-hidden="true" tabindex="-1"></a>emof_orphan_event <span class="ot">&lt;-</span> emof_with_event <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>eventID <span class="sc">%in%</span> event_ids)</span>
<span id="cb92-780"><a href="#cb92-780" aria-hidden="true" tabindex="-1"></a>emof_orphan_occ   <span class="ot">&lt;-</span> emof_with_occ <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>occurrenceID <span class="sc">%in%</span> occ_ids)</span>
<span id="cb92-781"><a href="#cb92-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-782"><a href="#cb92-782" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(emof_orphan_event) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb92-783"><a href="#cb92-783" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="fu">glue</span>(<span class="st">"{nrow(emof_orphan_event)} eMoF records have invalid eventID"</span>))</span>
<span id="cb92-784"><a href="#cb92-784" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(emof_orphan_occ) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb92-785"><a href="#cb92-785" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="fu">glue</span>(<span class="st">"{nrow(emof_orphan_occ)} eMoF records have invalid occurrenceID"</span>))</span>
<span id="cb92-786"><a href="#cb92-786" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-787"><a href="#cb92-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-788"><a href="#cb92-788" aria-hidden="true" tabindex="-1"></a><span class="fu">## Write DarwinCore Archive Files</span></span>
<span id="cb92-789"><a href="#cb92-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-790"><a href="#cb92-790" aria-hidden="true" tabindex="-1"></a>Export the event core and extension files as CSV:</span>
<span id="cb92-791"><a href="#cb92-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-794"><a href="#cb92-794" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-795"><a href="#cb92-795" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: export-dwc</span></span>
<span id="cb92-796"><a href="#cb92-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-797"><a href="#cb92-797" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(dir_out, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb92-798"><a href="#cb92-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-799"><a href="#cb92-799" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d_event,          <span class="fu">file.path</span>(dir_out, <span class="st">"event.csv"</span>), <span class="at">na =</span> <span class="st">""</span>)</span>
<span id="cb92-800"><a href="#cb92-800" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d_occurrence_out, <span class="fu">file.path</span>(dir_out, <span class="st">"occurrence.csv"</span>), <span class="at">na =</span> <span class="st">""</span>)</span>
<span id="cb92-801"><a href="#cb92-801" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d_emof,           <span class="fu">file.path</span>(dir_out, <span class="st">"extendedMeasurementOrFact.csv"</span>), <span class="at">na =</span> <span class="st">""</span>)</span>
<span id="cb92-802"><a href="#cb92-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-803"><a href="#cb92-803" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Wrote CSV files to:"</span>, dir_out, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-804"><a href="#cb92-804" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-805"><a href="#cb92-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-806"><a href="#cb92-806" aria-hidden="true" tabindex="-1"></a><span class="fu">## Create meta.xml</span></span>
<span id="cb92-807"><a href="#cb92-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-808"><a href="#cb92-808" aria-hidden="true" tabindex="-1"></a>Generate <span class="in">`meta.xml`</span> by mapping CSV column names to DarwinCore term URIs:</span>
<span id="cb92-809"><a href="#cb92-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-812"><a href="#cb92-812" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-813"><a href="#cb92-813" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: create-meta-xml</span></span>
<span id="cb92-814"><a href="#cb92-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-815"><a href="#cb92-815" aria-hidden="true" tabindex="-1"></a><span class="co"># DwC term mappings ----</span></span>
<span id="cb92-816"><a href="#cb92-816" aria-hidden="true" tabindex="-1"></a>dwc_terms <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb92-817"><a href="#cb92-817" aria-hidden="true" tabindex="-1"></a>  <span class="at">event =</span> <span class="fu">list</span>(</span>
<span id="cb92-818"><a href="#cb92-818" aria-hidden="true" tabindex="-1"></a>    <span class="at">rowType =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/Event"</span>,</span>
<span id="cb92-819"><a href="#cb92-819" aria-hidden="true" tabindex="-1"></a>    <span class="at">idField =</span> <span class="st">"eventID"</span>,</span>
<span id="cb92-820"><a href="#cb92-820" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms =</span> <span class="fu">c</span>(</span>
<span id="cb92-821"><a href="#cb92-821" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventID                       =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventID"</span>,</span>
<span id="cb92-822"><a href="#cb92-822" aria-hidden="true" tabindex="-1"></a>      <span class="at">parentEventID                 =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/parentEventID"</span>,</span>
<span id="cb92-823"><a href="#cb92-823" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventType                     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventType"</span>,</span>
<span id="cb92-824"><a href="#cb92-824" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventDate                     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventDate"</span>,</span>
<span id="cb92-825"><a href="#cb92-825" aria-hidden="true" tabindex="-1"></a>      <span class="at">samplingProtocol              =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/samplingProtocol"</span>,</span>
<span id="cb92-826"><a href="#cb92-826" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeValue               =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/sampleSizeValue"</span>,</span>
<span id="cb92-827"><a href="#cb92-827" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeUnit                =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/sampleSizeUnit"</span>,</span>
<span id="cb92-828"><a href="#cb92-828" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventRemarks                  =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventRemarks"</span>,</span>
<span id="cb92-829"><a href="#cb92-829" aria-hidden="true" tabindex="-1"></a>      <span class="at">habitat                       =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/habitat"</span>,</span>
<span id="cb92-830"><a href="#cb92-830" aria-hidden="true" tabindex="-1"></a>      <span class="at">footprintWKT                  =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/footprintWKT"</span>,</span>
<span id="cb92-831"><a href="#cb92-831" aria-hidden="true" tabindex="-1"></a>      <span class="at">decimalLatitude               =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/decimalLatitude"</span>,</span>
<span id="cb92-832"><a href="#cb92-832" aria-hidden="true" tabindex="-1"></a>      <span class="at">decimalLongitude              =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/decimalLongitude"</span>,</span>
<span id="cb92-833"><a href="#cb92-833" aria-hidden="true" tabindex="-1"></a>      <span class="at">geodeticDatum                 =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/geodeticDatum"</span>,</span>
<span id="cb92-834"><a href="#cb92-834" aria-hidden="true" tabindex="-1"></a>      <span class="at">coordinateUncertaintyInMeters =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/coordinateUncertaintyInMeters"</span>,</span>
<span id="cb92-835"><a href="#cb92-835" aria-hidden="true" tabindex="-1"></a>      <span class="at">locationID                    =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/locationID"</span>,</span>
<span id="cb92-836"><a href="#cb92-836" aria-hidden="true" tabindex="-1"></a>      <span class="at">countryCode                   =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/countryCode"</span>,</span>
<span id="cb92-837"><a href="#cb92-837" aria-hidden="true" tabindex="-1"></a>      <span class="at">waterBody                     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/waterBody"</span>,</span>
<span id="cb92-838"><a href="#cb92-838" aria-hidden="true" tabindex="-1"></a>      <span class="at">datasetID                     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/datasetID"</span>)),</span>
<span id="cb92-839"><a href="#cb92-839" aria-hidden="true" tabindex="-1"></a>  <span class="at">occurrence =</span> <span class="fu">list</span>(</span>
<span id="cb92-840"><a href="#cb92-840" aria-hidden="true" tabindex="-1"></a>    <span class="at">rowType     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/Occurrence"</span>,</span>
<span id="cb92-841"><a href="#cb92-841" aria-hidden="true" tabindex="-1"></a>    <span class="at">idField     =</span> <span class="st">"occurrenceID"</span>,</span>
<span id="cb92-842"><a href="#cb92-842" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreIdField =</span> <span class="st">"eventID"</span>,</span>
<span id="cb92-843"><a href="#cb92-843" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms =</span> <span class="fu">c</span>(</span>
<span id="cb92-844"><a href="#cb92-844" aria-hidden="true" tabindex="-1"></a>      <span class="at">occurrenceID         =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceID"</span>,</span>
<span id="cb92-845"><a href="#cb92-845" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventID              =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventID"</span>,</span>
<span id="cb92-846"><a href="#cb92-846" aria-hidden="true" tabindex="-1"></a>      <span class="at">scientificName       =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/scientificName"</span>,</span>
<span id="cb92-847"><a href="#cb92-847" aria-hidden="true" tabindex="-1"></a>      <span class="at">scientificNameID     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/scientificNameID"</span>,</span>
<span id="cb92-848"><a href="#cb92-848" aria-hidden="true" tabindex="-1"></a>      <span class="at">kingdom              =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/kingdom"</span>,</span>
<span id="cb92-849"><a href="#cb92-849" aria-hidden="true" tabindex="-1"></a>      <span class="at">occurrenceStatus     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceStatus"</span>,</span>
<span id="cb92-850"><a href="#cb92-850" aria-hidden="true" tabindex="-1"></a>      <span class="at">organismQuantity     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/organismQuantity"</span>,</span>
<span id="cb92-851"><a href="#cb92-851" aria-hidden="true" tabindex="-1"></a>      <span class="at">organismQuantityType =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/organismQuantityType"</span>,</span>
<span id="cb92-852"><a href="#cb92-852" aria-hidden="true" tabindex="-1"></a>      <span class="at">lifeStage            =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/lifeStage"</span>,</span>
<span id="cb92-853"><a href="#cb92-853" aria-hidden="true" tabindex="-1"></a>      <span class="at">preparations         =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/preparations"</span>,</span>
<span id="cb92-854"><a href="#cb92-854" aria-hidden="true" tabindex="-1"></a>      <span class="at">basisOfRecord        =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/basisOfRecord"</span>,</span>
<span id="cb92-855"><a href="#cb92-855" aria-hidden="true" tabindex="-1"></a>      <span class="at">modified             =</span> <span class="st">"http://purl.org/dc/terms/modified"</span>)),</span>
<span id="cb92-856"><a href="#cb92-856" aria-hidden="true" tabindex="-1"></a>  <span class="at">extendedmeasurementorfact =</span> <span class="fu">list</span>(</span>
<span id="cb92-857"><a href="#cb92-857" aria-hidden="true" tabindex="-1"></a>    <span class="at">rowType     =</span> <span class="st">"http://rs.iobis.org/obis/terms/ExtendedMeasurementOrFact"</span>,</span>
<span id="cb92-858"><a href="#cb92-858" aria-hidden="true" tabindex="-1"></a>    <span class="at">idField     =</span> <span class="st">"measurementID"</span>,</span>
<span id="cb92-859"><a href="#cb92-859" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreIdField =</span> <span class="st">"eventID"</span>,</span>
<span id="cb92-860"><a href="#cb92-860" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms =</span> <span class="fu">c</span>(</span>
<span id="cb92-861"><a href="#cb92-861" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventID            =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventID"</span>,</span>
<span id="cb92-862"><a href="#cb92-862" aria-hidden="true" tabindex="-1"></a>      <span class="at">occurrenceID       =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceID"</span>,</span>
<span id="cb92-863"><a href="#cb92-863" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementID      =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementID"</span>,</span>
<span id="cb92-864"><a href="#cb92-864" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementType    =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementType"</span>,</span>
<span id="cb92-865"><a href="#cb92-865" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementTypeID  =</span> <span class="st">"http://rs.iobis.org/obis/terms/measurementTypeID"</span>,</span>
<span id="cb92-866"><a href="#cb92-866" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementValue   =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementValue"</span>,</span>
<span id="cb92-867"><a href="#cb92-867" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementUnit    =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementUnit"</span>,</span>
<span id="cb92-868"><a href="#cb92-868" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementUnitID  =</span> <span class="st">"http://rs.iobis.org/obis/terms/measurementUnitID"</span>,</span>
<span id="cb92-869"><a href="#cb92-869" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementMethod  =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementMethod"</span>,</span>
<span id="cb92-870"><a href="#cb92-870" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementRemarks =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementRemarks"</span>)))</span>
<span id="cb92-871"><a href="#cb92-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-872"><a href="#cb92-872" aria-hidden="true" tabindex="-1"></a><span class="co"># helper functions ----</span></span>
<span id="cb92-873"><a href="#cb92-873" aria-hidden="true" tabindex="-1"></a>create_field_elements <span class="ot">&lt;-</span> <span class="cf">function</span>(csv_file, term_map, <span class="at">coreid_field =</span> <span class="cn">NULL</span>) {</span>
<span id="cb92-874"><a href="#cb92-874" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">read_csv</span>(csv_file, <span class="at">n_max =</span> <span class="dv">0</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>))</span>
<span id="cb92-875"><a href="#cb92-875" aria-hidden="true" tabindex="-1"></a>  field_elements <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="fu">seq_along</span>(col_names), <span class="cf">function</span>(i) {</span>
<span id="cb92-876"><a href="#cb92-876" aria-hidden="true" tabindex="-1"></a>    col <span class="ot">&lt;-</span> col_names[i]</span>
<span id="cb92-877"><a href="#cb92-877" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(coreid_field) <span class="sc">&amp;&amp;</span> col <span class="sc">==</span> coreid_field) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb92-878"><a href="#cb92-878" aria-hidden="true" tabindex="-1"></a>    term <span class="ot">&lt;-</span> term_map<span class="sc">$</span>terms[[col]]</span>
<span id="cb92-879"><a href="#cb92-879" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(term)) {</span>
<span id="cb92-880"><a href="#cb92-880" aria-hidden="true" tabindex="-1"></a>      <span class="fu">glue</span>(<span class="st">'    &lt;field index="{i-1}" term="{term}"/&gt;'</span>)</span>
<span id="cb92-881"><a href="#cb92-881" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb92-882"><a href="#cb92-882" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Warning: Column '"</span>, col, <span class="st">"' in "</span>, csv_file, <span class="st">" has no DwC mapping."</span>)</span>
<span id="cb92-883"><a href="#cb92-883" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NULL</span></span>
<span id="cb92-884"><a href="#cb92-884" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb92-885"><a href="#cb92-885" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb92-886"><a href="#cb92-886" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="fu">compact</span>(field_elements), <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-887"><a href="#cb92-887" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-888"><a href="#cb92-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-889"><a href="#cb92-889" aria-hidden="true" tabindex="-1"></a>get_coreid_index <span class="ot">&lt;-</span> <span class="cf">function</span>(csv_file, coreid_field) {</span>
<span id="cb92-890"><a href="#cb92-890" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">read_csv</span>(csv_file, <span class="at">n_max =</span> <span class="dv">0</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>))</span>
<span id="cb92-891"><a href="#cb92-891" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coreid_field) <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb92-892"><a href="#cb92-892" aria-hidden="true" tabindex="-1"></a>    coreid_field <span class="ot">&lt;-</span> <span class="fu">intersect</span>(coreid_field, col_names)[<span class="dv">1</span>]</span>
<span id="cb92-893"><a href="#cb92-893" aria-hidden="true" tabindex="-1"></a>  <span class="fu">which</span>(col_names <span class="sc">==</span> coreid_field) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb92-894"><a href="#cb92-894" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-895"><a href="#cb92-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-896"><a href="#cb92-896" aria-hidden="true" tabindex="-1"></a><span class="co"># generate meta.xml ----</span></span>
<span id="cb92-897"><a href="#cb92-897" aria-hidden="true" tabindex="-1"></a>generate_meta_xml <span class="ot">&lt;-</span> <span class="cf">function</span>(dir_out) {</span>
<span id="cb92-898"><a href="#cb92-898" aria-hidden="true" tabindex="-1"></a>  event_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"event.csv"</span>)</span>
<span id="cb92-899"><a href="#cb92-899" aria-hidden="true" tabindex="-1"></a>  event_fields <span class="ot">&lt;-</span> <span class="fu">create_field_elements</span>(event_file, dwc_terms<span class="sc">$</span>event)</span>
<span id="cb92-900"><a href="#cb92-900" aria-hidden="true" tabindex="-1"></a>  event_id_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(</span>
<span id="cb92-901"><a href="#cb92-901" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(<span class="fu">read_csv</span>(event_file, <span class="at">n_max =</span> <span class="dv">0</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)) <span class="sc">==</span></span>
<span id="cb92-902"><a href="#cb92-902" aria-hidden="true" tabindex="-1"></a>      dwc_terms<span class="sc">$</span>event<span class="sc">$</span>idField) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb92-903"><a href="#cb92-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-904"><a href="#cb92-904" aria-hidden="true" tabindex="-1"></a>  occ_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"occurrence.csv"</span>)</span>
<span id="cb92-905"><a href="#cb92-905" aria-hidden="true" tabindex="-1"></a>  occ_fields <span class="ot">&lt;-</span> <span class="fu">create_field_elements</span>(</span>
<span id="cb92-906"><a href="#cb92-906" aria-hidden="true" tabindex="-1"></a>    occ_file, dwc_terms<span class="sc">$</span>occurrence,</span>
<span id="cb92-907"><a href="#cb92-907" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreid_field =</span> dwc_terms<span class="sc">$</span>occurrence<span class="sc">$</span>coreIdField)</span>
<span id="cb92-908"><a href="#cb92-908" aria-hidden="true" tabindex="-1"></a>  occ_coreid_idx <span class="ot">&lt;-</span> <span class="fu">get_coreid_index</span>(occ_file, dwc_terms<span class="sc">$</span>occurrence<span class="sc">$</span>coreIdField)</span>
<span id="cb92-909"><a href="#cb92-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-910"><a href="#cb92-910" aria-hidden="true" tabindex="-1"></a>  emof_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"extendedMeasurementOrFact.csv"</span>)</span>
<span id="cb92-911"><a href="#cb92-911" aria-hidden="true" tabindex="-1"></a>  emof_fields <span class="ot">&lt;-</span> <span class="fu">create_field_elements</span>(</span>
<span id="cb92-912"><a href="#cb92-912" aria-hidden="true" tabindex="-1"></a>    emof_file, dwc_terms<span class="sc">$</span>extendedmeasurementorfact,</span>
<span id="cb92-913"><a href="#cb92-913" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreid_field =</span> dwc_terms<span class="sc">$</span>extendedmeasurementorfact<span class="sc">$</span>coreIdField)</span>
<span id="cb92-914"><a href="#cb92-914" aria-hidden="true" tabindex="-1"></a>  emof_coreid_idx <span class="ot">&lt;-</span> <span class="fu">get_coreid_index</span>(</span>
<span id="cb92-915"><a href="#cb92-915" aria-hidden="true" tabindex="-1"></a>    emof_file, dwc_terms<span class="sc">$</span>extendedmeasurementorfact<span class="sc">$</span>coreIdField)</span>
<span id="cb92-916"><a href="#cb92-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-917"><a href="#cb92-917" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glue</span>(</span>
<span id="cb92-918"><a href="#cb92-918" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span>
<span id="cb92-919"><a href="#cb92-919" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;archive xmlns="http://rs.tdwg.org/dwc/text/"</span></span>
<span id="cb92-920"><a href="#cb92-920" aria-hidden="true" tabindex="-1"></a><span class="st">         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</span></span>
<span id="cb92-921"><a href="#cb92-921" aria-hidden="true" tabindex="-1"></a><span class="st">         xsi:schemaLocation="http://rs.tdwg.org/dwc/text/ http://rs.tdwg.org/dwc/text/tdwg_dwc_text.xsd"&gt;</span></span>
<span id="cb92-922"><a href="#cb92-922" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;core encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="</span><span class="sc">\\</span><span class="st">n"</span></span>
<span id="cb92-923"><a href="#cb92-923" aria-hidden="true" tabindex="-1"></a><span class="st">        fieldsEnclosedBy=</span><span class="sc">\'</span><span class="st">"</span><span class="sc">\'</span><span class="st"> ignoreHeaderLines="1" rowType="{dwc_terms$event$rowType}"&gt;</span></span>
<span id="cb92-924"><a href="#cb92-924" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;files&gt;</span></span>
<span id="cb92-925"><a href="#cb92-925" aria-hidden="true" tabindex="-1"></a><span class="st">      &lt;location&gt;event.csv&lt;/location&gt;</span></span>
<span id="cb92-926"><a href="#cb92-926" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/files&gt;</span></span>
<span id="cb92-927"><a href="#cb92-927" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;id index="{event_id_idx}" /&gt;</span></span>
<span id="cb92-928"><a href="#cb92-928" aria-hidden="true" tabindex="-1"></a><span class="st">{event_fields}</span></span>
<span id="cb92-929"><a href="#cb92-929" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;/core&gt;</span></span>
<span id="cb92-930"><a href="#cb92-930" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="</span><span class="sc">\\</span><span class="st">n"</span></span>
<span id="cb92-931"><a href="#cb92-931" aria-hidden="true" tabindex="-1"></a><span class="st">             fieldsEnclosedBy=</span><span class="sc">\'</span><span class="st">"</span><span class="sc">\'</span><span class="st"> ignoreHeaderLines="1" rowType="{dwc_terms$occurrence$rowType}"&gt;</span></span>
<span id="cb92-932"><a href="#cb92-932" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;files&gt;</span></span>
<span id="cb92-933"><a href="#cb92-933" aria-hidden="true" tabindex="-1"></a><span class="st">      &lt;location&gt;occurrence.csv&lt;/location&gt;</span></span>
<span id="cb92-934"><a href="#cb92-934" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/files&gt;</span></span>
<span id="cb92-935"><a href="#cb92-935" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;coreid index="{occ_coreid_idx}" /&gt;</span></span>
<span id="cb92-936"><a href="#cb92-936" aria-hidden="true" tabindex="-1"></a><span class="st">{occ_fields}</span></span>
<span id="cb92-937"><a href="#cb92-937" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;/extension&gt;</span></span>
<span id="cb92-938"><a href="#cb92-938" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="</span><span class="sc">\\</span><span class="st">n"</span></span>
<span id="cb92-939"><a href="#cb92-939" aria-hidden="true" tabindex="-1"></a><span class="st">             fieldsEnclosedBy=</span><span class="sc">\'</span><span class="st">"</span><span class="sc">\'</span><span class="st"> ignoreHeaderLines="1" rowType="{dwc_terms$extendedmeasurementorfact$rowType}"&gt;</span></span>
<span id="cb92-940"><a href="#cb92-940" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;files&gt;</span></span>
<span id="cb92-941"><a href="#cb92-941" aria-hidden="true" tabindex="-1"></a><span class="st">      &lt;location&gt;extendedMeasurementOrFact.csv&lt;/location&gt;</span></span>
<span id="cb92-942"><a href="#cb92-942" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/files&gt;</span></span>
<span id="cb92-943"><a href="#cb92-943" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;coreid index="{emof_coreid_idx}" /&gt;</span></span>
<span id="cb92-944"><a href="#cb92-944" aria-hidden="true" tabindex="-1"></a><span class="st">{emof_fields}</span></span>
<span id="cb92-945"><a href="#cb92-945" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;/extension&gt;</span></span>
<span id="cb92-946"><a href="#cb92-946" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/archive&gt;'</span>)</span>
<span id="cb92-947"><a href="#cb92-947" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-948"><a href="#cb92-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-949"><a href="#cb92-949" aria-hidden="true" tabindex="-1"></a>meta_xml <span class="ot">&lt;-</span> <span class="fu">generate_meta_xml</span>(dir_out)</span>
<span id="cb92-950"><a href="#cb92-950" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(meta_xml, <span class="fu">file.path</span>(dir_out, <span class="st">"meta.xml"</span>))</span>
<span id="cb92-951"><a href="#cb92-951" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Generated meta.xml</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-952"><a href="#cb92-952" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(meta_xml)</span>
<span id="cb92-953"><a href="#cb92-953" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-954"><a href="#cb92-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-955"><a href="#cb92-955" aria-hidden="true" tabindex="-1"></a><span class="fu">## Create EML Metadata</span></span>
<span id="cb92-956"><a href="#cb92-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-957"><a href="#cb92-957" aria-hidden="true" tabindex="-1"></a>Build EML document with geographic, temporal, and taxonomic coverage:</span>
<span id="cb92-958"><a href="#cb92-958" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-961"><a href="#cb92-961" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-962"><a href="#cb92-962" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: build-eml</span></span>
<span id="cb92-963"><a href="#cb92-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-964"><a href="#cb92-964" aria-hidden="true" tabindex="-1"></a><span class="co"># geographic coverage: union of net sites and cast positions ----</span></span>
<span id="cb92-965"><a href="#cb92-965" aria-hidden="true" tabindex="-1"></a>geo_net <span class="ot">&lt;-</span> tbl_site <span class="sc">|&gt;</span></span>
<span id="cb92-966"><a href="#cb92-966" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb92-967"><a href="#cb92-967" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon_min =</span> <span class="fu">min</span>(longitude, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-968"><a href="#cb92-968" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon_max =</span> <span class="fu">max</span>(longitude, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-969"><a href="#cb92-969" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat_min =</span> <span class="fu">min</span>(latitude,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-970"><a href="#cb92-970" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat_max =</span> <span class="fu">max</span>(latitude,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb92-971"><a href="#cb92-971" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb92-972"><a href="#cb92-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-973"><a href="#cb92-973" aria-hidden="true" tabindex="-1"></a>geo_cast <span class="ot">&lt;-</span> d_casts <span class="sc">|&gt;</span></span>
<span id="cb92-974"><a href="#cb92-974" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb92-975"><a href="#cb92-975" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon_min =</span> <span class="fu">min</span>(lon_dec, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-976"><a href="#cb92-976" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon_max =</span> <span class="fu">max</span>(lon_dec, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-977"><a href="#cb92-977" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat_min =</span> <span class="fu">min</span>(lat_dec, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-978"><a href="#cb92-978" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat_max =</span> <span class="fu">max</span>(lat_dec, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb92-979"><a href="#cb92-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-980"><a href="#cb92-980" aria-hidden="true" tabindex="-1"></a>geo_coverage <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb92-981"><a href="#cb92-981" aria-hidden="true" tabindex="-1"></a>  <span class="at">westBoundingCoordinate  =</span> <span class="fu">min</span>(geo_net<span class="sc">$</span>lon_min, geo_cast<span class="sc">$</span>lon_min, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-982"><a href="#cb92-982" aria-hidden="true" tabindex="-1"></a>  <span class="at">eastBoundingCoordinate  =</span> <span class="fu">max</span>(geo_net<span class="sc">$</span>lon_max, geo_cast<span class="sc">$</span>lon_max, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-983"><a href="#cb92-983" aria-hidden="true" tabindex="-1"></a>  <span class="at">southBoundingCoordinate =</span> <span class="fu">min</span>(geo_net<span class="sc">$</span>lat_min, geo_cast<span class="sc">$</span>lat_min, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-984"><a href="#cb92-984" aria-hidden="true" tabindex="-1"></a>  <span class="at">northBoundingCoordinate =</span> <span class="fu">max</span>(geo_net<span class="sc">$</span>lat_max, geo_cast<span class="sc">$</span>lat_max, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb92-985"><a href="#cb92-985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-986"><a href="#cb92-986" aria-hidden="true" tabindex="-1"></a><span class="co"># temporal coverage: union of tow and cast dates ----</span></span>
<span id="cb92-987"><a href="#cb92-987" aria-hidden="true" tabindex="-1"></a>temp_net <span class="ot">&lt;-</span> tbl_tow <span class="sc">|&gt;</span></span>
<span id="cb92-988"><a href="#cb92-988" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb92-989"><a href="#cb92-989" aria-hidden="true" tabindex="-1"></a>    <span class="at">tmin =</span> <span class="fu">min</span>(time_start,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-990"><a href="#cb92-990" aria-hidden="true" tabindex="-1"></a>    <span class="at">tmax =</span> <span class="fu">max</span>(time_start,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb92-991"><a href="#cb92-991" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb92-992"><a href="#cb92-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-993"><a href="#cb92-993" aria-hidden="true" tabindex="-1"></a>temp_cast <span class="ot">&lt;-</span> d_casts <span class="sc">|&gt;</span></span>
<span id="cb92-994"><a href="#cb92-994" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb92-995"><a href="#cb92-995" aria-hidden="true" tabindex="-1"></a>    <span class="at">tmin =</span> <span class="fu">min</span>(datetime_utc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb92-996"><a href="#cb92-996" aria-hidden="true" tabindex="-1"></a>    <span class="at">tmax =</span> <span class="fu">max</span>(datetime_utc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb92-997"><a href="#cb92-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-998"><a href="#cb92-998" aria-hidden="true" tabindex="-1"></a>temp_coverage <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb92-999"><a href="#cb92-999" aria-hidden="true" tabindex="-1"></a>  <span class="at">beginDate =</span> <span class="fu">as.character</span>(<span class="fu">as.Date</span>(<span class="fu">min</span>(temp_net<span class="sc">$</span>tmin, temp_cast<span class="sc">$</span>tmin, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))),</span>
<span id="cb92-1000"><a href="#cb92-1000" aria-hidden="true" tabindex="-1"></a>  <span class="at">endDate   =</span> <span class="fu">as.character</span>(<span class="fu">as.Date</span>(<span class="fu">max</span>(temp_net<span class="sc">$</span>tmax, temp_cast<span class="sc">$</span>tmax, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))))</span>
<span id="cb92-1001"><a href="#cb92-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1002"><a href="#cb92-1002" aria-hidden="true" tabindex="-1"></a><span class="co"># taxonomic coverage ----</span></span>
<span id="cb92-1003"><a href="#cb92-1003" aria-hidden="true" tabindex="-1"></a>d_taxa <span class="ot">&lt;-</span> tbl_taxon <span class="sc">|&gt;</span> <span class="fu">collect</span>()</span>
<span id="cb92-1004"><a href="#cb92-1004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1005"><a href="#cb92-1005" aria-hidden="true" tabindex="-1"></a>taxa_coverage <span class="ot">&lt;-</span> tbl_species <span class="sc">|&gt;</span></span>
<span id="cb92-1006"><a href="#cb92-1006" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb92-1007"><a href="#cb92-1007" aria-hidden="true" tabindex="-1"></a>    <span class="at">worms_id =</span> <span class="fu">case_when</span>(</span>
<span id="cb92-1008"><a href="#cb92-1008" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(worms_id) <span class="sc">|</span> worms_id <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="cn">NA_integer_</span>,</span>
<span id="cb92-1009"><a href="#cb92-1009" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> worms_id)) <span class="sc">|&gt;</span></span>
<span id="cb92-1010"><a href="#cb92-1010" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb92-1011"><a href="#cb92-1011" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(worms_id)) <span class="sc">|&gt;</span></span>
<span id="cb92-1012"><a href="#cb92-1012" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(species_id, worms_id, common_name) <span class="sc">|&gt;</span></span>
<span id="cb92-1013"><a href="#cb92-1013" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb92-1014"><a href="#cb92-1014" aria-hidden="true" tabindex="-1"></a>    d_taxa <span class="sc">|&gt;</span> <span class="fu">distinct</span>(taxonID, taxonRank, scientificName),</span>
<span id="cb92-1015"><a href="#cb92-1015" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">join_by</span>(worms_id <span class="sc">==</span> taxonID)) <span class="sc">|&gt;</span></span>
<span id="cb92-1016"><a href="#cb92-1016" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(worms_id, taxonRank, scientificName) <span class="sc">|&gt;</span></span>
<span id="cb92-1017"><a href="#cb92-1017" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb92-1018"><a href="#cb92-1018" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_id  =</span> <span class="fu">first</span>(species_id),</span>
<span id="cb92-1019"><a href="#cb92-1019" aria-hidden="true" tabindex="-1"></a>    <span class="at">common_name =</span> <span class="fu">paste</span>(<span class="fu">unique</span>(<span class="fu">na.omit</span>(common_name)), <span class="at">collapse =</span> <span class="st">", "</span>),</span>
<span id="cb92-1020"><a href="#cb92-1020" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups     =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-1021"><a href="#cb92-1021" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(species_id) <span class="sc">|&gt;</span></span>
<span id="cb92-1022"><a href="#cb92-1022" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(scientificName)) <span class="sc">|&gt;</span></span>
<span id="cb92-1023"><a href="#cb92-1023" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pmap</span>(<span class="cf">function</span>(species_id, taxonRank, scientificName, common_name, worms_id, ...) {</span>
<span id="cb92-1024"><a href="#cb92-1024" aria-hidden="true" tabindex="-1"></a>    item <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb92-1025"><a href="#cb92-1025" aria-hidden="true" tabindex="-1"></a>      <span class="at">id             =</span> <span class="fu">glue</span>(<span class="st">"calcofi_species_{species_id}"</span>),</span>
<span id="cb92-1026"><a href="#cb92-1026" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxonRankName  =</span> taxonRank,</span>
<span id="cb92-1027"><a href="#cb92-1027" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxonRankValue =</span> scientificName,</span>
<span id="cb92-1028"><a href="#cb92-1028" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxonId        =</span> <span class="fu">list</span>(</span>
<span id="cb92-1029"><a href="#cb92-1029" aria-hidden="true" tabindex="-1"></a>        <span class="at">provider =</span> <span class="st">"https://www.marinespecies.org"</span>,</span>
<span id="cb92-1030"><a href="#cb92-1030" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.character</span>(worms_id)))</span>
<span id="cb92-1031"><a href="#cb92-1031" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(common_name) <span class="sc">&amp;&amp;</span> common_name <span class="sc">!=</span> <span class="st">""</span>)</span>
<span id="cb92-1032"><a href="#cb92-1032" aria-hidden="true" tabindex="-1"></a>      item<span class="sc">$</span>commonName <span class="ot">&lt;-</span> common_name</span>
<span id="cb92-1033"><a href="#cb92-1033" aria-hidden="true" tabindex="-1"></a>    item</span>
<span id="cb92-1034"><a href="#cb92-1034" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb92-1035"><a href="#cb92-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1036"><a href="#cb92-1036" aria-hidden="true" tabindex="-1"></a><span class="co"># build EML document ----</span></span>
<span id="cb92-1037"><a href="#cb92-1037" aria-hidden="true" tabindex="-1"></a>my_eml <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb92-1038"><a href="#cb92-1038" aria-hidden="true" tabindex="-1"></a>  <span class="at">packageId =</span> dataset_id,</span>
<span id="cb92-1039"><a href="#cb92-1039" aria-hidden="true" tabindex="-1"></a>  <span class="at">system    =</span> <span class="st">"calcofi.io"</span>,</span>
<span id="cb92-1040"><a href="#cb92-1040" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset   =</span> <span class="fu">list</span>(</span>
<span id="cb92-1041"><a href="#cb92-1041" aria-hidden="true" tabindex="-1"></a>    <span class="at">title              =</span> dataset_title,</span>
<span id="cb92-1042"><a href="#cb92-1042" aria-hidden="true" tabindex="-1"></a>    <span class="at">intellectualRights =</span> intellectual_rights,</span>
<span id="cb92-1043"><a href="#cb92-1043" aria-hidden="true" tabindex="-1"></a>    <span class="at">creator =</span> <span class="fu">list</span>(</span>
<span id="cb92-1044"><a href="#cb92-1044" aria-hidden="true" tabindex="-1"></a>      <span class="at">individualName        =</span> <span class="fu">list</span>(<span class="at">givenName =</span> <span class="st">"Ed"</span>, <span class="at">surName =</span> <span class="st">"Weber"</span>),</span>
<span id="cb92-1045"><a href="#cb92-1045" aria-hidden="true" tabindex="-1"></a>      <span class="at">organizationName      =</span> <span class="st">"NOAA SWFSC"</span>,</span>
<span id="cb92-1046"><a href="#cb92-1046" aria-hidden="true" tabindex="-1"></a>      <span class="at">electronicMailAddress =</span> <span class="st">"ed.weber@noaa.gov"</span>,</span>
<span id="cb92-1047"><a href="#cb92-1047" aria-hidden="true" tabindex="-1"></a>      <span class="at">userId =</span> <span class="fu">list</span>(</span>
<span id="cb92-1048"><a href="#cb92-1048" aria-hidden="true" tabindex="-1"></a>        <span class="at">directory =</span> <span class="st">"https://orcid.org/"</span>,</span>
<span id="cb92-1049"><a href="#cb92-1049" aria-hidden="true" tabindex="-1"></a>        <span class="at">userId   =</span> <span class="st">"0000-0002-0942-434X"</span>)),</span>
<span id="cb92-1050"><a href="#cb92-1050" aria-hidden="true" tabindex="-1"></a>    <span class="at">abstract   =</span> dataset_abstract,</span>
<span id="cb92-1051"><a href="#cb92-1051" aria-hidden="true" tabindex="-1"></a>    <span class="at">keywordSet =</span> <span class="fu">list</span>(</span>
<span id="cb92-1052"><a href="#cb92-1052" aria-hidden="true" tabindex="-1"></a>      <span class="at">keyword          =</span> dataset_keywords,</span>
<span id="cb92-1053"><a href="#cb92-1053" aria-hidden="true" tabindex="-1"></a>      <span class="at">keywordThesaurus =</span> <span class="st">"GCMD Science Keywords"</span>),</span>
<span id="cb92-1054"><a href="#cb92-1054" aria-hidden="true" tabindex="-1"></a>    <span class="at">coverage =</span> <span class="fu">list</span>(</span>
<span id="cb92-1055"><a href="#cb92-1055" aria-hidden="true" tabindex="-1"></a>      <span class="at">geographicCoverage =</span> <span class="fu">list</span>(</span>
<span id="cb92-1056"><a href="#cb92-1056" aria-hidden="true" tabindex="-1"></a>        <span class="at">geographicDescription =</span> <span class="st">"California Current Large Marine Ecoregion"</span>,</span>
<span id="cb92-1057"><a href="#cb92-1057" aria-hidden="true" tabindex="-1"></a>        <span class="at">boundingCoordinates   =</span> geo_coverage),</span>
<span id="cb92-1058"><a href="#cb92-1058" aria-hidden="true" tabindex="-1"></a>      <span class="at">temporalCoverage =</span> <span class="fu">list</span>(</span>
<span id="cb92-1059"><a href="#cb92-1059" aria-hidden="true" tabindex="-1"></a>        <span class="at">rangeOfDates =</span> <span class="fu">list</span>(</span>
<span id="cb92-1060"><a href="#cb92-1060" aria-hidden="true" tabindex="-1"></a>          <span class="at">beginDate =</span> <span class="fu">list</span>(<span class="at">calendarDate =</span> temp_coverage<span class="sc">$</span>beginDate),</span>
<span id="cb92-1061"><a href="#cb92-1061" aria-hidden="true" tabindex="-1"></a>          <span class="at">endDate   =</span> <span class="fu">list</span>(<span class="at">calendarDate =</span> temp_coverage<span class="sc">$</span>endDate))),</span>
<span id="cb92-1062"><a href="#cb92-1062" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxonomicCoverage =</span> <span class="fu">list</span>(</span>
<span id="cb92-1063"><a href="#cb92-1063" aria-hidden="true" tabindex="-1"></a>        <span class="at">generalTaxonomicCoverage =</span> <span class="st">"Marine ichthyoplankton (fish eggs and larvae)"</span>,</span>
<span id="cb92-1064"><a href="#cb92-1064" aria-hidden="true" tabindex="-1"></a>        <span class="at">taxonomicClassification  =</span> taxa_coverage)),</span>
<span id="cb92-1065"><a href="#cb92-1065" aria-hidden="true" tabindex="-1"></a>    <span class="at">contact =</span> <span class="fu">list</span>(</span>
<span id="cb92-1066"><a href="#cb92-1066" aria-hidden="true" tabindex="-1"></a>      <span class="at">individualName        =</span> <span class="fu">list</span>(<span class="at">givenName =</span> <span class="st">"Ed"</span>, <span class="at">surName =</span> <span class="st">"Weber"</span>),</span>
<span id="cb92-1067"><a href="#cb92-1067" aria-hidden="true" tabindex="-1"></a>      <span class="at">electronicMailAddress =</span> <span class="st">"ed.weber@noaa.gov"</span>),</span>
<span id="cb92-1068"><a href="#cb92-1068" aria-hidden="true" tabindex="-1"></a>    <span class="at">methods =</span> <span class="fu">list</span>(</span>
<span id="cb92-1069"><a href="#cb92-1069" aria-hidden="true" tabindex="-1"></a>      <span class="at">methodStep =</span> <span class="fu">list</span>(</span>
<span id="cb92-1070"><a href="#cb92-1070" aria-hidden="true" tabindex="-1"></a>        <span class="at">description =</span> <span class="fu">list</span>(<span class="at">para =</span> sampling_methods_description)),</span>
<span id="cb92-1071"><a href="#cb92-1071" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampling =</span> <span class="fu">list</span>(</span>
<span id="cb92-1072"><a href="#cb92-1072" aria-hidden="true" tabindex="-1"></a>        <span class="at">studyExtent =</span> <span class="fu">list</span>(</span>
<span id="cb92-1073"><a href="#cb92-1073" aria-hidden="true" tabindex="-1"></a>          <span class="at">description =</span> <span class="fu">list</span>(<span class="at">para =</span> study_extent_description)),</span>
<span id="cb92-1074"><a href="#cb92-1074" aria-hidden="true" tabindex="-1"></a>        <span class="at">samplingDescription =</span> <span class="fu">list</span>(</span>
<span id="cb92-1075"><a href="#cb92-1075" aria-hidden="true" tabindex="-1"></a>          <span class="at">para =</span> sampling_description))),</span>
<span id="cb92-1076"><a href="#cb92-1076" aria-hidden="true" tabindex="-1"></a>    <span class="at">project =</span> <span class="fu">list</span>(</span>
<span id="cb92-1077"><a href="#cb92-1077" aria-hidden="true" tabindex="-1"></a>      <span class="at">title     =</span> dataset_title,</span>
<span id="cb92-1078"><a href="#cb92-1078" aria-hidden="true" tabindex="-1"></a>      <span class="at">personnel =</span> <span class="fu">list</span>(</span>
<span id="cb92-1079"><a href="#cb92-1079" aria-hidden="true" tabindex="-1"></a>        <span class="at">individualName =</span> <span class="fu">list</span>(<span class="at">givenName =</span> <span class="st">"Ed"</span>, <span class="at">surName =</span> <span class="st">"Weber"</span>),</span>
<span id="cb92-1080"><a href="#cb92-1080" aria-hidden="true" tabindex="-1"></a>        <span class="at">role           =</span> <span class="st">"Data Manager"</span>),</span>
<span id="cb92-1081"><a href="#cb92-1081" aria-hidden="true" tabindex="-1"></a>      <span class="at">funding =</span> <span class="fu">list</span>(<span class="at">para =</span> funding_information))))</span>
<span id="cb92-1082"><a href="#cb92-1082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1083"><a href="#cb92-1083" aria-hidden="true" tabindex="-1"></a>eml_xml <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"eml.xml"</span>)</span>
<span id="cb92-1084"><a href="#cb92-1084" aria-hidden="true" tabindex="-1"></a><span class="fu">write_eml</span>(my_eml, eml_xml)</span>
<span id="cb92-1085"><a href="#cb92-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1086"><a href="#cb92-1086" aria-hidden="true" tabindex="-1"></a><span class="co"># replace license placeholder with actual license xml</span></span>
<span id="cb92-1087"><a href="#cb92-1087" aria-hidden="true" tabindex="-1"></a><span class="fu">readLines</span>(eml_xml) <span class="sc">|&gt;</span></span>
<span id="cb92-1088"><a href="#cb92-1088" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str_replace</span>(<span class="fu">fixed</span>(<span class="fu">names</span>(license_xml)), license_xml) <span class="sc">|&gt;</span></span>
<span id="cb92-1089"><a href="#cb92-1089" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeLines</span>(eml_xml)</span>
<span id="cb92-1090"><a href="#cb92-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1091"><a href="#cb92-1091" aria-hidden="true" tabindex="-1"></a>validation_result <span class="ot">&lt;-</span> <span class="fu">eml_validate</span>(eml_xml)</span>
<span id="cb92-1092"><a href="#cb92-1092" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>validation_result) {</span>
<span id="cb92-1093"><a href="#cb92-1093" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"EML validation errors:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-1094"><a href="#cb92-1094" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">attr</span>(validation_result, <span class="st">"errors"</span>))</span>
<span id="cb92-1095"><a href="#cb92-1095" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"EML validation failed"</span>)</span>
<span id="cb92-1096"><a href="#cb92-1096" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb92-1097"><a href="#cb92-1097" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"EML is valid!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-1098"><a href="#cb92-1098" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-1099"><a href="#cb92-1099" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-1100"><a href="#cb92-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1101"><a href="#cb92-1101" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Quality Checks</span></span>
<span id="cb92-1102"><a href="#cb92-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1103"><a href="#cb92-1103" aria-hidden="true" tabindex="-1"></a>Validate event hierarchy, orphan records, and output summary statistics:</span>
<span id="cb92-1104"><a href="#cb92-1104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1107"><a href="#cb92-1107" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-1108"><a href="#cb92-1108" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check-data-quality</span></span>
<span id="cb92-1109"><a href="#cb92-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1110"><a href="#cb92-1110" aria-hidden="true" tabindex="-1"></a><span class="co"># check for missing WoRMS IDs</span></span>
<span id="cb92-1111"><a href="#cb92-1111" aria-hidden="true" tabindex="-1"></a>d_missing_worms <span class="ot">&lt;-</span> tbl_species <span class="sc">|&gt;</span></span>
<span id="cb92-1112"><a href="#cb92-1112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(worms_id) <span class="sc">|</span> worms_id <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb92-1113"><a href="#cb92-1113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(species_id, scientific_name) <span class="sc">|&gt;</span></span>
<span id="cb92-1114"><a href="#cb92-1114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb92-1115"><a href="#cb92-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1116"><a href="#cb92-1116" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(d_missing_worms) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb92-1117"><a href="#cb92-1117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"WARNING:"</span>, <span class="fu">nrow</span>(d_missing_worms), <span class="st">"species missing WoRMS IDs:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-1118"><a href="#cb92-1118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(d_missing_worms, <span class="at">n =</span> <span class="dv">20</span>)</span>
<span id="cb92-1119"><a href="#cb92-1119" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-1120"><a href="#cb92-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1121"><a href="#cb92-1121" aria-hidden="true" tabindex="-1"></a><span class="co"># summary statistics ----</span></span>
<span id="cb92-1122"><a href="#cb92-1122" aria-hidden="true" tabindex="-1"></a>n_cruises   <span class="ot">&lt;-</span> d_event <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"cruise"</span>)     <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb92-1123"><a href="#cb92-1123" aria-hidden="true" tabindex="-1"></a>n_nets      <span class="ot">&lt;-</span> d_event <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"net_sample"</span>) <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb92-1124"><a href="#cb92-1124" aria-hidden="true" tabindex="-1"></a>n_casts_out <span class="ot">&lt;-</span> d_event <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"ctd_cast"</span>)   <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb92-1125"><a href="#cb92-1125" aria-hidden="true" tabindex="-1"></a>n_occs      <span class="ot">&lt;-</span> <span class="fu">nrow</span>(d_occurrence_out)</span>
<span id="cb92-1126"><a href="#cb92-1126" aria-hidden="true" tabindex="-1"></a>n_species   <span class="ot">&lt;-</span> <span class="fu">n_distinct</span>(d_occurrence_out<span class="sc">$</span>scientificName)</span>
<span id="cb92-1127"><a href="#cb92-1127" aria-hidden="true" tabindex="-1"></a>n_emof      <span class="ot">&lt;-</span> <span class="fu">nrow</span>(d_emof)</span>
<span id="cb92-1128"><a href="#cb92-1128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1129"><a href="#cb92-1129" aria-hidden="true" tabindex="-1"></a><span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb92-1130"><a href="#cb92-1130" aria-hidden="true" tabindex="-1"></a><span class="st">=== Dataset Summary ===</span></span>
<span id="cb92-1131"><a href="#cb92-1131" aria-hidden="true" tabindex="-1"></a><span class="st">Total events:         {prettyNum(nrow(d_event), big.mark = ',')}</span></span>
<span id="cb92-1132"><a href="#cb92-1132" aria-hidden="true" tabindex="-1"></a><span class="st">  - Cruises:          {prettyNum(n_cruises, big.mark = ',')}</span></span>
<span id="cb92-1133"><a href="#cb92-1133" aria-hidden="true" tabindex="-1"></a><span class="st">  - Net samples:      {prettyNum(n_nets, big.mark = ',')}</span></span>
<span id="cb92-1134"><a href="#cb92-1134" aria-hidden="true" tabindex="-1"></a><span class="st">  - CTD casts:        {prettyNum(n_casts_out, big.mark = ',')}</span></span>
<span id="cb92-1135"><a href="#cb92-1135" aria-hidden="true" tabindex="-1"></a><span class="st">Total occurrences:    {prettyNum(n_occs, big.mark = ',')}</span></span>
<span id="cb92-1136"><a href="#cb92-1136" aria-hidden="true" tabindex="-1"></a><span class="st">Unique species:       {prettyNum(n_species, big.mark = ',')}</span></span>
<span id="cb92-1137"><a href="#cb92-1137" aria-hidden="true" tabindex="-1"></a><span class="st">Total eMoF records:   {prettyNum(n_emof, big.mark = ',')}"</span>)</span>
<span id="cb92-1138"><a href="#cb92-1138" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-1139"><a href="#cb92-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1140"><a href="#cb92-1140" aria-hidden="true" tabindex="-1"></a><span class="fu">## Package DarwinCore Archive</span></span>
<span id="cb92-1141"><a href="#cb92-1141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1142"><a href="#cb92-1142" aria-hidden="true" tabindex="-1"></a>Create the final DwC-A zip file:</span>
<span id="cb92-1143"><a href="#cb92-1143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1146"><a href="#cb92-1146" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-1147"><a href="#cb92-1147" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: create-dwc-archive</span></span>
<span id="cb92-1148"><a href="#cb92-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1149"><a href="#cb92-1149" aria-hidden="true" tabindex="-1"></a>zip_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(</span>
<span id="cb92-1150"><a href="#cb92-1150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dirname</span>(dir_out),</span>
<span id="cb92-1151"><a href="#cb92-1151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="st">"ichthyo_bottle_"</span>, <span class="fu">Sys.Date</span>(), <span class="st">".zip"</span>))</span>
<span id="cb92-1152"><a href="#cb92-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1153"><a href="#cb92-1153" aria-hidden="true" tabindex="-1"></a><span class="fu">zip</span>(</span>
<span id="cb92-1154"><a href="#cb92-1154" aria-hidden="true" tabindex="-1"></a>  zip_file,</span>
<span id="cb92-1155"><a href="#cb92-1155" aria-hidden="true" tabindex="-1"></a>  <span class="at">files =</span> <span class="fu">file.path</span>(</span>
<span id="cb92-1156"><a href="#cb92-1156" aria-hidden="true" tabindex="-1"></a>    dir_out,</span>
<span id="cb92-1157"><a href="#cb92-1157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"event.csv"</span>, <span class="st">"occurrence.csv"</span>, <span class="st">"extendedMeasurementOrFact.csv"</span>,</span>
<span id="cb92-1158"><a href="#cb92-1158" aria-hidden="true" tabindex="-1"></a>      <span class="st">"meta.xml"</span>, <span class="st">"eml.xml"</span>)),</span>
<span id="cb92-1159"><a href="#cb92-1159" aria-hidden="true" tabindex="-1"></a>  <span class="at">flags =</span> <span class="st">"-j"</span>)</span>
<span id="cb92-1160"><a href="#cb92-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1161"><a href="#cb92-1161" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Darwin Core Archive created:"</span>, zip_file, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-1162"><a href="#cb92-1162" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-1163"><a href="#cb92-1163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1164"><a href="#cb92-1164" aria-hidden="true" tabindex="-1"></a><span class="fu">## Validate with obistools</span></span>
<span id="cb92-1165"><a href="#cb92-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1168"><a href="#cb92-1168" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-1169"><a href="#cb92-1169" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: obistools-validate</span></span>
<span id="cb92-1170"><a href="#cb92-1170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1171"><a href="#cb92-1171" aria-hidden="true" tabindex="-1"></a><span class="co"># read back the CSVs</span></span>
<span id="cb92-1172"><a href="#cb92-1172" aria-hidden="true" tabindex="-1"></a>d_event_check <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(dir_out, <span class="st">"event.csv"</span>))</span>
<span id="cb92-1173"><a href="#cb92-1173" aria-hidden="true" tabindex="-1"></a>d_occ_check   <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(dir_out, <span class="st">"occurrence.csv"</span>))</span>
<span id="cb92-1174"><a href="#cb92-1174" aria-hidden="true" tabindex="-1"></a>d_emof_check  <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(dir_out, <span class="st">"extendedMeasurementOrFact.csv"</span>))</span>
<span id="cb92-1175"><a href="#cb92-1175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1176"><a href="#cb92-1176" aria-hidden="true" tabindex="-1"></a><span class="co"># event hierarchy check</span></span>
<span id="cb92-1177"><a href="#cb92-1177" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Event hierarchy check ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-1178"><a href="#cb92-1178" aria-hidden="true" tabindex="-1"></a>event_check <span class="ot">&lt;-</span> <span class="fu">check_eventids</span>(d_event_check)</span>
<span id="cb92-1179"><a href="#cb92-1179" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(event_check) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb92-1180"><a href="#cb92-1180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"PASS: all event parent-child relationships valid</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-1181"><a href="#cb92-1181" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb92-1182"><a href="#cb92-1182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"ISSUES found:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-1183"><a href="#cb92-1183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(event_check)</span>
<span id="cb92-1184"><a href="#cb92-1184" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-1185"><a href="#cb92-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1186"><a href="#cb92-1186" aria-hidden="true" tabindex="-1"></a><span class="co"># occurrence → event linkage</span></span>
<span id="cb92-1187"><a href="#cb92-1187" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== Occurrence-event linkage ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-1188"><a href="#cb92-1188" aria-hidden="true" tabindex="-1"></a>occ_check <span class="ot">&lt;-</span> <span class="fu">check_extension_eventids</span>(d_event_check, d_occ_check)</span>
<span id="cb92-1189"><a href="#cb92-1189" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(occ_check) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb92-1190"><a href="#cb92-1190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"PASS: all occurrences link to valid events</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-1191"><a href="#cb92-1191" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb92-1192"><a href="#cb92-1192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"ISSUES found:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-1193"><a href="#cb92-1193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(occ_check)</span>
<span id="cb92-1194"><a href="#cb92-1194" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-1195"><a href="#cb92-1195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1196"><a href="#cb92-1196" aria-hidden="true" tabindex="-1"></a><span class="co"># eMoF → event linkage</span></span>
<span id="cb92-1197"><a href="#cb92-1197" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== eMoF-event linkage ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-1198"><a href="#cb92-1198" aria-hidden="true" tabindex="-1"></a>emof_event_check <span class="ot">&lt;-</span> d_emof_check <span class="sc">|&gt;</span></span>
<span id="cb92-1199"><a href="#cb92-1199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(eventID)) <span class="sc">|&gt;</span></span>
<span id="cb92-1200"><a href="#cb92-1200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>eventID <span class="sc">%in%</span> d_event_check<span class="sc">$</span>eventID)</span>
<span id="cb92-1201"><a href="#cb92-1201" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(emof_event_check) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb92-1202"><a href="#cb92-1202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"PASS: all eMoF eventIDs link to valid events</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-1203"><a href="#cb92-1203" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb92-1204"><a href="#cb92-1204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">nrow</span>(emof_event_check), <span class="st">"eMoF records with invalid eventID</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-1205"><a href="#cb92-1205" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-1206"><a href="#cb92-1206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1207"><a href="#cb92-1207" aria-hidden="true" tabindex="-1"></a><span class="co"># eMoF → occurrence linkage</span></span>
<span id="cb92-1208"><a href="#cb92-1208" aria-hidden="true" tabindex="-1"></a>emof_occ_check <span class="ot">&lt;-</span> d_emof_check <span class="sc">|&gt;</span></span>
<span id="cb92-1209"><a href="#cb92-1209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(occurrenceID)) <span class="sc">|&gt;</span></span>
<span id="cb92-1210"><a href="#cb92-1210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>occurrenceID <span class="sc">%in%</span> d_occ_check<span class="sc">$</span>occurrenceID)</span>
<span id="cb92-1211"><a href="#cb92-1211" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(emof_occ_check) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb92-1212"><a href="#cb92-1212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"PASS: all eMoF occurrenceIDs link to valid occurrences</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-1213"><a href="#cb92-1213" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb92-1214"><a href="#cb92-1214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">nrow</span>(emof_occ_check), <span class="st">"eMoF records with invalid occurrenceID</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-1215"><a href="#cb92-1215" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-1216"><a href="#cb92-1216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1217"><a href="#cb92-1217" aria-hidden="true" tabindex="-1"></a><span class="co"># summary by event type</span></span>
<span id="cb92-1218"><a href="#cb92-1218" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== Events by type ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-1219"><a href="#cb92-1219" aria-hidden="true" tabindex="-1"></a>d_event_check <span class="sc">|&gt;</span> <span class="fu">count</span>(eventType) <span class="sc">|&gt;</span> <span class="fu">print</span>()</span>
<span id="cb92-1220"><a href="#cb92-1220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1221"><a href="#cb92-1221" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== eMoF by measurementType ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-1222"><a href="#cb92-1222" aria-hidden="true" tabindex="-1"></a>d_emof_check <span class="sc">|&gt;</span> <span class="fu">count</span>(measurementType, <span class="at">sort =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">50</span>)</span>
<span id="cb92-1223"><a href="#cb92-1223" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb92-1224"><a href="#cb92-1224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1225"><a href="#cb92-1225" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cleanup</span></span>
<span id="cb92-1226"><a href="#cb92-1226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1229"><a href="#cb92-1229" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb92-1230"><a href="#cb92-1230" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cleanup</span></span>
<span id="cb92-1231"><a href="#cb92-1231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-1232"><a href="#cb92-1232" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con, <span class="at">shutdown =</span> <span class="cn">TRUE</span>)</span>
<span id="cb92-1233"><a href="#cb92-1233" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Database connection closed.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-1234"><a href="#cb92-1234" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>