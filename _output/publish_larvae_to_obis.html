<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2026-01-08">

<title>Publish Larvae to OBIS</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="publish_larvae_to_obis_files/libs/clipboard/clipboard.min.js"></script>
<script src="publish_larvae_to_obis_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="publish_larvae_to_obis_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="publish_larvae_to_obis_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="publish_larvae_to_obis_files/libs/quarto-html/popper.min.js"></script>
<script src="publish_larvae_to_obis_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="publish_larvae_to_obis_files/libs/quarto-html/anchor.min.js"></script>
<link href="publish_larvae_to_obis_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="publish_larvae_to_obis_files/libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="publish_larvae_to_obis_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="publish_larvae_to_obis_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="publish_larvae_to_obis_files/libs/bootstrap/bootstrap-d6a003b94517c951b2d65075d42fb01b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="publish_larvae_to_obis_files/libs/quarto-diagram/mermaid.min.js"></script>
<script src="publish_larvae_to_obis_files/libs/quarto-diagram/mermaid-init.js"></script>
<link href="publish_larvae_to_obis_files/libs/quarto-diagram/mermaid.css" rel="stylesheet">
<link href="publish_larvae_to_obis_files/libs/htmltools-fill-0.5.9/fill.css" rel="stylesheet">
<script src="publish_larvae_to_obis_files/libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<script src="publish_larvae_to_obis_files/libs/viz-1.8.2/viz.js"></script>
<link href="publish_larvae_to_obis_files/libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="publish_larvae_to_obis_files/libs/grViz-binding-1.0.11/grViz.js"></script>


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#database-schema" id="toc-database-schema" class="nav-link active" data-scroll-target="#database-schema"><span class="header-section-number">1</span> Database Schema</a></li>
  <li><a href="#life-stage-reference" id="toc-life-stage-reference" class="nav-link" data-scroll-target="#life-stage-reference"><span class="header-section-number">2</span> Life Stage Reference</a></li>
  <li><a href="#conversion-design-decisions" id="toc-conversion-design-decisions" class="nav-link" data-scroll-target="#conversion-design-decisions"><span class="header-section-number">3</span> Conversion Design Decisions</a></li>
  <li><a href="#data-extraction-from-database" id="toc-data-extraction-from-database" class="nav-link" data-scroll-target="#data-extraction-from-database"><span class="header-section-number">4</span> Data Extraction from Database</a></li>
  <li><a href="#create-life-stage-vocabulary-lookup-tables" id="toc-create-life-stage-vocabulary-lookup-tables" class="nav-link" data-scroll-target="#create-life-stage-vocabulary-lookup-tables"><span class="header-section-number">5</span> Create Life Stage Vocabulary Lookup Tables</a></li>
  <li><a href="#create-event-hierarchy" id="toc-create-event-hierarchy" class="nav-link" data-scroll-target="#create-event-hierarchy"><span class="header-section-number">6</span> Create Event Hierarchy</a></li>
  <li><a href="#create-occurrence-records" id="toc-create-occurrence-records" class="nav-link" data-scroll-target="#create-occurrence-records"><span class="header-section-number">7</span> Create Occurrence Records</a></li>
  <li><a href="#create-extendedmeasurementorfact-extension" id="toc-create-extendedmeasurementorfact-extension" class="nav-link" data-scroll-target="#create-extendedmeasurementorfact-extension"><span class="header-section-number">8</span> Create ExtendedMeasurementOrFact Extension</a></li>
  <li><a href="#write-darwincore-archive-files" id="toc-write-darwincore-archive-files" class="nav-link" data-scroll-target="#write-darwincore-archive-files"><span class="header-section-number">9</span> Write DarwinCore Archive Files</a></li>
  <li><a href="#create-meta.xml-programmatically-by-cross-walking-csv-fields-to-dwc-terms" id="toc-create-meta.xml-programmatically-by-cross-walking-csv-fields-to-dwc-terms" class="nav-link" data-scroll-target="#create-meta.xml-programmatically-by-cross-walking-csv-fields-to-dwc-terms"><span class="header-section-number">10</span> Create meta.xml programmatically by cross-walking CSV fields to DwC terms</a></li>
  <li><a href="#create-eml-metadata" id="toc-create-eml-metadata" class="nav-link" data-scroll-target="#create-eml-metadata"><span class="header-section-number">11</span> Create EML Metadata</a></li>
  <li><a href="#data-quality-checks" id="toc-data-quality-checks" class="nav-link" data-scroll-target="#data-quality-checks"><span class="header-section-number">12</span> Data Quality Checks</a></li>
  <li><a href="#package-creation" id="toc-package-creation" class="nav-link" data-scroll-target="#package-creation"><span class="header-section-number">13</span> Package Creation</a></li>
  <li><a href="#check-csv" id="toc-check-csv" class="nav-link" data-scroll-target="#check-csv"><span class="header-section-number">14</span> Check CSV</a></li>
  <li><a href="#to-confirm-dataset-metadata" id="toc-to-confirm-dataset-metadata" class="nav-link" data-scroll-target="#to-confirm-dataset-metadata"><span class="header-section-number">15</span> To confirm: dataset metadata</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Publish Larvae to OBIS</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2026-01-08</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>This workflow converts CalCOFI ichthyoplankton (fish eggs and larvae) data to an OBIS-compliant DarwinCore Archive for publication. The archive follows the Event Core structure with Occurrence and ExtendedMeasurementOrFact (eMoF) extensions.</p>
<p><strong>References</strong>: <a href="https://manual.obis.org/">OBIS Manual</a> | <a href="https://dwc.tdwg.org/terms/">DarwinCore Terms</a> | <a href="https://calcofi.org/data/marine-ecosystem-data/fish-eggs-larvae/">CalCOFI Fish Eggs &amp; Larvae</a></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  CalCOFI <span class="sc">/</span> calcofi4db,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  DBI,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  dm,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  dplyr,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  DT,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  EML,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  glue,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  here,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  lubridate,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  purrr,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  readr,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  tibble,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  tidyr,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  uuid,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">quiet =</span> T</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">readr.show_col_types =</span> F)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset metadata</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>dataset_title <span class="ot">&lt;-</span> <span class="st">"CalCOFI Fish Larvae Tows"</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>dataset_abstract <span class="ot">&lt;-</span> <span class="st">"Fish larvae counts and standardized counts for eggs captured in CalCOFI icthyoplankton nets (primarily vertical [Calvet or Pairovet], oblique [bongo or ring nets], and surface tows [Manta nets]). Surface tows are normally standardized to count per 1,000 m^3 strained. Oblique tows are normally standardized to count per 10 m^2 of surface sampled."</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>dataset_keywords <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"atmosphere"</span>,</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"biology"</span>,</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"biosphere"</span>,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"calcofi"</span>,</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"earth science"</span>,</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"environment"</span>,</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">"latitude"</span>,</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"longitude"</span>,</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ocean"</span>,</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"time"</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>) <span class="co"># GCMD Science Keywords (source: https://catalog.data.gov/dataset/calcofi-larvae-counts-positive-tows)</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co"># dataset_uuid &lt;- UUIDgenerate() # Or use existing dataset UUID</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>country_code <span class="ot">&lt;-</span> <span class="st">"US"</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>water_body <span class="ot">&lt;-</span> <span class="st">"California Current"</span> <span class="co"># LME: http://marineregions.org/mrgid/8549</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>dataset_id <span class="ot">&lt;-</span> <span class="fu">glue</span>(</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  <span class="st">"calcofi.io_workflow_larvae_to_obis_{format(Sys.Date(), '%Y-%m-%d')}"</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>sampling_methods_description <span class="ot">&lt;-</span> <span class="st">"Standard CalCOFI ichthyoplankton tows. The standard oblique tow uses a bongo net (71 cm diameter, 0.505 mm mesh) or 1-m ring net (prior to 1978) retrieved at a constant wire angle (45 degrees) from 210 m depth to surface. Surface tows use a Manta net; vertical tows use CalVET/Pairovet nets. Flowmeters measure volume filtered. Samples are preserved in 5% formalin. In the lab, fish eggs and larvae are sorted, identified to lowest taxon possible, enumerated, and measured."</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>study_extent_description <span class="ot">&lt;-</span> <span class="st">"The study covers the California Current ecosystem, primarily off Southern California (standard lines 77-93) but historically extending from the border of Canada to the tip of Baja California. The time series for this dataset generally begins in 1951 and continues to the present, with quarterly cruises."</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>sampling_description <span class="ot">&lt;-</span> <span class="st">"Samples are collected at fixed stations along the CalCOFI grid. Oblique tows are standardized to counts per 10 m^2 of sea surface. Surface tows are standardized to counts per 1,000 m^3. Data includes raw counts (tallies) and standardized abundances."</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>funding_information <span class="ot">&lt;-</span> <span class="st">"CalCOFI is a partnership between the NOAA National Marine Fisheries Service (NMFS), Scripps Institution of Oceanography (SIO), and California Department of Fish and Wildlife (CDFW)."</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>dir_out <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/darwincore/larvae"</span>)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="co"># get database connection</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>schema <span class="ot">&lt;-</span> <span class="st">"dev"</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">get_db_con</span>(schema)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<section id="database-schema" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="database-schema"><span class="header-section-number">1</span> Database Schema</h2>
<p>The CalCOFI database organizes ichthyoplankton data hierarchically: cruises contain sites, sites contain tows, and tows contain net samples. Biological observations (eggs, larvae) link to net samples via <code>net_uuid</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># exclude experimental tables</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>tbls <span class="ot">&lt;-</span> <span class="fu">dbListTables</span>(con) <span class="sc">|&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sort</span>() <span class="sc">|&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setdiff</span>(</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"schema_version"</span>, <span class="st">"grid"</span>, <span class="st">"site_seg"</span>, <span class="st">"bottle"</span>, <span class="st">"cast"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># learn relations from database and draw</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>dm <span class="ot">&lt;-</span> <span class="fu">dm_from_con</span>(con, <span class="at">schema =</span> schema, <span class="at">table_names =</span> tbls, <span class="at">learn_keys =</span> T)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_draw</span>(dm, <span class="at">view_type =</span> <span class="st">"all"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="fig-dm_tbls" class="cell-output-display quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dm_tbls-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="grViz html-widget html-fill-item" id="htmlwidget-9fd50c8c04274af7dae3" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-9fd50c8c04274af7dae3">{"x":{"diagram":"#data_model\ndigraph {\ngraph [rankdir=LR tooltip=\"Data Model\" ]\n\nnode [margin=0 fontcolor = \"#444444\" ]\n\nedge [color = \"#555555\", arrowsize = 1, ]\n\npack=true\npackmode= \"node\"\n\n  \"cruise\" [id = \"cruise\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">cruise<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"cruise_uuid\"><U>cruise_uuid<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">date_ym<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"ship_key\">ship_key<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"egg\" [id = \"egg\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">egg<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid\">net_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"species_id\">species_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">tally<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid, species_id\"><U>net_uuid, species_id<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"egg_stage\" [id = \"egg_stage\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">egg_stage<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid\">net_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"species_id\">species_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">stage<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">tally<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid, species_id, stage\"><U>net_uuid, species_id, stage<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"larva\" [id = \"larva\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">larva<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid\">net_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"species_id\">species_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">tally<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid, species_id\"><U>net_uuid, species_id<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"larva_size\" [id = \"larva_size\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">larva_size<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid\">net_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"species_id\">species_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">length_mm<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">tally<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid, species_id, length_mm\"><U>net_uuid, species_id, length_mm<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"larva_stage\" [id = \"larva_stage\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">larva_stage<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid\">net_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"species_id\">species_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">stage<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">tally<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid, species_id, stage\"><U>net_uuid, species_id, stage<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"net\" [id = \"net\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">net<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid\"><U>net_uuid<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"tow_uuid\">tow_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">side<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">std_haul_factor<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">vol_sampled_m3<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">prop_sorted<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">smallplankton<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">totalplankton<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"ship\" [id = \"ship\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">ship<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"ship_key\"><U>ship_key<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">ship_name<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">ship_nodc<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"site\" [id = \"site\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">site<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"site_uuid\"><U>site_uuid<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"cruise_uuid\">cruise_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">orderocc<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">longitude<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">latitude<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">line<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">station<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">geom<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">grid_key<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"species\" [id = \"species\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">species<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"species_id\"><U>species_id<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">scientific_name<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">itis_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">worms_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">common_name<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"tow\" [id = \"tow\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">tow<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"tow_uuid\"><U>tow_uuid<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"site_uuid\">site_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"tow_type_key\">tow_type_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">tow_number<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">time_start<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"tow_type\" [id = \"tow_type\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">tow_type<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"tow_type_key\"><U>tow_type_key<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">description<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n\"site\":\"cruise_uuid\"->\"cruise\":\"cruise_uuid\" [id=\"site_1\"]\n\"egg\":\"net_uuid\"->\"net\":\"net_uuid\" [id=\"egg_1\"]\n\"egg_stage\":\"net_uuid\"->\"net\":\"net_uuid\" [id=\"egg_stage_1\"]\n\"larva\":\"net_uuid\"->\"net\":\"net_uuid\" [id=\"larva_1\"]\n\"larva_size\":\"net_uuid\"->\"net\":\"net_uuid\" [id=\"larva_size_1\"]\n\"larva_stage\":\"net_uuid\"->\"net\":\"net_uuid\" [id=\"larva_stage_1\"]\n\"cruise\":\"ship_key\"->\"ship\":\"ship_key\" [id=\"cruise_1\"]\n\"tow\":\"site_uuid\"->\"site\":\"site_uuid\" [id=\"tow_1\"]\n\"egg\":\"species_id\"->\"species\":\"species_id\" [id=\"egg_2\"]\n\"egg_stage\":\"species_id\"->\"species\":\"species_id\" [id=\"egg_stage_2\"]\n\"larva_size\":\"species_id\"->\"species\":\"species_id\" [id=\"larva_size_2\"]\n\"larva\":\"species_id\"->\"species\":\"species_id\" [id=\"larva_2\"]\n\"larva_stage\":\"species_id\"->\"species\":\"species_id\" [id=\"larva_stage_2\"]\n\"net\":\"tow_uuid\"->\"tow\":\"tow_uuid\" [id=\"net_1\"]\n\"tow\":\"tow_type_key\"->\"tow_type\":\"tow_type_key\" [id=\"tow_2\"]\n}","config":{"engine":null,"options":null}},"evals":[],"jsHooks":[]}</script>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dm_tbls-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Entity relationship diagram (ERD) of the CalCOFI database.
</figcaption>
</figure>
</div>
</div>
<div class="cell" data-file="diagrams/calcofi_erd.mmd" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-calcofi_erd" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-calcofi_erd-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-calcofi_erd">erDiagram
    net {
        string net_uuid PK
        string tow_uuid FK
        string side
        float std_haul_factor
        float vol_sampled_m3
        float prop_sorted
        float smallplankton
        float totalplankton
    }
    
    tow {
        string tow_uuid PK
        string site_uuid FK
        string tow_type_key FK
        int tow_number
        datetime time_start
    }
    
    site {
        string site_uuid PK
        string cruise_uuid FK
        string orderocc
        float longitude
        float latitude
        string line
        string station
    }
    
    cruise {
        string cruise_uuid PK
        string ship_key FK
        string date_ym
    }
    
    ship {
        string ship_key PK
        string ship_name
        string ship_nodc
    }
    
    tow_type {
        string tow_type_key PK
        string description
    }
    
    species {
        string species_id PK
        string scientific_name
        string itis_id
        string worms_id
        string common_name
    }
    
    larvastage {
        string net_uuid FK
        string species_id FK
        string stage
        int tally
    }
    
    egg {
        string net_uuid FK
        string species_id FK
        int tally
    }
    
    eggstage {
        string net_uuid FK
        string species_id FK
        string stage
        int tally
    }
    
    larva {
        string net_uuid FK
        string species_id FK
        int tally
    }
    
    larvasize {
        string net_uuid FK
        string species_id FK
        float length_mm
        int tally
    }

    %% Relationships
    net ||--o{ larvastage : "has"
    net ||--o{ egg : "has"
    net ||--o{ eggstage : "has"
    net ||--o{ larva : "has"
    net ||--o{ larvasize : "has"
    
    species ||--o{ larvastage : "identified_as"
    species ||--o{ egg : "identified_as"
    species ||--o{ eggstage : "identified_as"
    species ||--o{ larva : "identified_as"
    species ||--o{ larvasize : "identified_as"
    
    tow ||--o{ net : "uses"
    site ||--o{ tow : "conducted_at"
    cruise ||--o{ site : "visits"
    ship ||--o{ cruise : "operates"
    tow_type ||--o{ tow : "defines"</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-calcofi_erd-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Entity relationship diagram (ERD) of the CalCOFI database. Created from image above and prompt to <a href="https://claude.ai/">Claude</a>: ‘Generate an ERD mermaid diagram from the image.’
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="life-stage-reference" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="life-stage-reference"><span class="header-section-number">2</span> Life Stage Reference</h2>
<p>Egg development stages follow <a href="https://repository.library.noaa.gov/view/noaa/5695/noaa_5695_DS1.pdf">Moser &amp; Ahlstrom (1985)</a>. Larva stages include: yolk sac, preflexion, flexion, postflexion, and transformation.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Egg Stage Descriptions (Moser &amp; Ahlstrom, 1985)
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<section id="stage-i" class="level4" data-number="2.0.1">
<h4 data-number="2.0.1" class="anchored" data-anchor-id="stage-i"><span class="header-section-number">2.0.1</span> Stage I</h4>
<p>Cell division has not yet begun. In intact eggs the cytoplasm of the single cell appears as a clear hemisphere at one pole, easily dif- ferentiated from the yolk mass which is divided into granules. The cytoplasm may be displaced to other locations around the periphery of the yolk mass, but there is usually some accumulation at one pole, which allows the stage to be identified.</p>
</section>
<section id="stage-ii" class="level4" data-number="2.0.2">
<h4 data-number="2.0.2" class="anchored" data-anchor-id="stage-ii"><span class="header-section-number">2.0.2</span> Stage II</h4>
<p>This begins with the division of the single cell into two cells or blastomeres. The division is first noticeable when a furrow develops in the middle of the cytoplasmic cap. Small bubble-like structures (probably artifacts) are often visible along the furrow and help iden- tify it. The next cleavage plane is at right angles to the first, and subsequent synchronous divisions in both meridional and latitudinal planes produce a hemispherical mound of cells, termed the blasto- disc. After the 5th or 6th division, the blastodisc has a berry-like appearance, the so-called “mulberry stage,” and with subsequent divisions the blastomeres become increasingly smaller and more difficult to distinguish individually. During a certain phase of the early divisions the blastomeres are about the same size as the yolk granules. Ifthe blastodisc and yolk mass become disrupted during collection or preservation, the blastomeres may become distributed among the yolk granules. They may be distinguished from one another since they have different refractive indices and the blastomeres appear darker when viewed with transmitted light.</p>
</section>
<section id="stage-iii" class="level4" data-number="2.0.3">
<h4 data-number="2.0.3" class="anchored" data-anchor-id="stage-iii"><span class="header-section-number">2.0.3</span> Stage III</h4>
<p>Ahlstrom (1943) defined this stage in sardine eggs as beginning with the appearance of the segmentation cavity. The segmentation cavity of teleost eggs is the space formed between the blastodisc and the yolk mass during late cleavage. In most anchovy eggs in our collec- tions the blastodisc is shrunken and somewhat cup-shaped and con- sequently the segmentation cavity, which is a delicate structure, is obliterated. We have found it preferable to define the beginning of Stage ill on the basis of the appearance of the blastoderm, i.e., when it has the appearance of tissue rather than of a collection of individual cells. This stage marks the beginning of gastrulation. The margin of the blastodisc becomes slightly thickened and is termed the germ ring. At one region of the germ ring the thickening extends inward to form the embryonic shield, which defines the future axis of the embryo. Gastrulation proceeds by further proliferation and downward movement of cells in the region of the germ ring by a process known as epiboly. Simultaneously, proliferation and inward migration (em- boly) of cells from the margin of the embryonic shield produce the organ-forming cell layers of the primordial embryo. At the end of Stage III the germ ring is one-third down the yolk mass and the bilateral nature of the primordial embryo is apparent.</p>
</section>
<section id="stage-iv" class="level4" data-number="2.0.4">
<h4 data-number="2.0.4" class="anchored" data-anchor-id="stage-iv"><span class="header-section-number">2.0.4</span> Stage IV</h4>
<p>At the beginning of this stage the germ ring has enclosed one-third of the yolk mass and the embryo is beginning to form along the median region of the embryonic shield. At the end of this stage, defined by the germ ring enveloping two-thirds of the yolk, the head region of the embryo is becoming apparent.</p>
</section>
<section id="stage-v" class="level4" data-number="2.0.5">
<h4 data-number="2.0.5" class="anchored" data-anchor-id="stage-v"><span class="header-section-number">2.0.5</span> Stage V</h4>
<p>This stage begins with the germ ring two-thirds down the yolk and ends with the closure of the blastopore and the complete enclosure of the yolk by the cellular sheath of the embryo. The stage is charac- terized by rapid differentiation resulting in the formation of several somites in the midregion of the embryonic axis, development of the notochord which can be seen from a dorsal viewpoint, and differ- entiation of the optic vesicles from the brain.</p>
</section>
<section id="stage-vi" class="level4" data-number="2.0.6">
<h4 data-number="2.0.6" class="anchored" data-anchor-id="stage-vi"><span class="header-section-number">2.0.6</span> Stage VI</h4>
<p>This stage begins with the closure of the blastopore and ends when the tail starts to separate from the yolk mass. The embryonic sheath of cells is extremely thin and, in some samples, it may be difficult to determine the point of blastopore closure. In these cases the event can be estimated from the position of the caudal terminus of the embryonic axis, since it grows toward the pole with the edge of the cellular sheath. Initially the caudal region lies flat against the polar region of the yolk, then gradually thickens and becomes more round- ed at the tip until it is clearly separate from the yolk. During this stage the somites are apparent along the entire body axis (except at the caudal portion), the lens primordium appears in the eye, and the regions of the brain begin to differentiate.</p>
</section>
<section id="stage-vii" class="level4" data-number="2.0.7">
<h4 data-number="2.0.7" class="anchored" data-anchor-id="stage-vii"><span class="header-section-number">2.0.7</span> Stage VII</h4>
<p>At the beginning of this stage the tip of the tail free from the yolk is broadly rounded, then begins to narrow as it elongates. The noto- chord extends almost to the tip and the finfold is just becoming visi- ble. At the end of this stage the length of the free tail is one-half the length of the head. For this purpose, head length is considered the distance from the tip of the snout to the back of the cerebellum (see Fig. 2H). Relative tail length is the criterion for each remain- ing stage.</p>
</section>
<section id="stage-viii" class="level4" data-number="2.0.8">
<h4 data-number="2.0.8" class="anchored" data-anchor-id="stage-viii"><span class="header-section-number">2.0.8</span> Stage VIII</h4>
<p>This stage begins when the free tail length is l:,reater than one-half the head length and ends when tail length equals head length. The tail becomes pointed during this stage and begins to bend away from the axis of the body, to the right or left side. The curvature of the tail generally increases with development, but is subject to individual variability (Fig. 2). Judgement is required in compensating for curva- ture in estimating relative tail length; however, accuracy and preci- sion increase rapidly with practice.</p>
</section>
<section id="stage-ix" class="level4" data-number="2.0.9">
<h4 data-number="2.0.9" class="anchored" data-anchor-id="stage-ix"><span class="header-section-number">2.0.9</span> Stage IX</h4>
<p>This stage begins with the tail extending one-quarter the length of the yolk sac and ends when it reaches one-half the yolk sac length. The gut is now apparent along the ventral surface of the tail, and its terminal section passes through the fin fold which is now con- siderably wider than in the previous stage. The pectoral fin buds appear as lateral thickenings as do the otic vesicles.</p>
</section>
<section id="stage-x" class="level4" data-number="2.0.10">
<h4 data-number="2.0.10" class="anchored" data-anchor-id="stage-x"><span class="header-section-number">2.0.10</span> Stage X</h4>
<p>This stage starts when the tail is one-half the length of the yolk sac and ends when it reaches three-quarters of the yolk sac length.</p>
</section>
<section id="stage-xi" class="level4" data-number="2.0.11">
<h4 data-number="2.0.11" class="anchored" data-anchor-id="stage-xi"><span class="header-section-number">2.0.11</span> Stage XI</h4>
<p>This is the final stage before hatching and is defined by a tail length greater than three-quarters of the length of the yolk sac.</p>
</section>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Larva Stage Descriptions
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Developmental stages of fish larvae captured in CalCOFI ichthyoplankton nets:</p>
<ul>
<li><strong>YOLK</strong>: Yolk-sac larva - newly hatched, still absorbing yolk</li>
<li><strong>PREF</strong>: Preflexion larva - notochord straight, before flexion</li>
<li><strong>FLEX</strong>: Flexion larva - notochord flexing upward</li>
<li><strong>POST</strong>: Postflexion larva - notochord flexion complete</li>
<li><strong>TRNS</strong>: Transformation stage - transitioning to juvenile</li>
</ul>
</div>
</div>
</div>
</section>
<section id="conversion-design-decisions" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="conversion-design-decisions"><span class="header-section-number">3</span> Conversion Design Decisions</h2>
<p>Key design decisions for converting CalCOFI ichthyoplankton data to DarwinCore:</p>
<ol type="1">
<li><strong>Event hierarchy</strong>: cruise → site → tow → net (following OBIS sampling-event model)</li>
<li><strong>Occurrence consolidation</strong>: One occurrence per life stage (egg or larva) per species per net sample, rather than separate occurrences for each developmental stage</li>
<li><strong>ExtendedMeasurementOrFact (eMoF)</strong>: Stage-specific counts, body lengths, and sample-level measurements linked via <code>occurrenceID</code> or <code>eventID</code></li>
<li><strong>Vocabulary mappings</strong>: S11 for life stages, P06 for units, custom descriptive terms for CalCOFI-specific developmental stages</li>
<li><strong>Sample size</strong>: <code>vol_sampled_m3</code> stored as <code>sampleSizeValue</code> in Event core (not in eMoF)</li>
</ol>
</section>
<section id="data-extraction-from-database" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="data-extraction-from-database"><span class="header-section-number">4</span> Data Extraction from Database</h2>
<p>First, let’s extract all necessary tables from the database:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get simple lazy table references</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>tbl_ship <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"ship"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>tbl_cruise <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"cruise"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>tbl_site <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"site"</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>tbl_tow <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"tow"</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>tbl_tow_type <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"tow_type"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>tbl_net <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"net"</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>tbl_species <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"species"</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># biological observation tables</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>tbl_egg <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"egg"</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>tbl_egg_stage <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"egg_stage"</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>tbl_larva <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"larva"</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>tbl_larva_stage <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"larva_stage"</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>tbl_larva_size <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"larva_size"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="create-life-stage-vocabulary-lookup-tables" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="create-life-stage-vocabulary-lookup-tables"><span class="header-section-number">5</span> Create Life Stage Vocabulary Lookup Tables</h2>
<p>Define mappings for egg and larva developmental stages to descriptive terms:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Egg stage vocabulary mapping (Moser &amp; Ahlstrom, 1985)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>egg_stage_vocab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">stage =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">stage_description =</span> <span class="fu">c</span>(</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 1 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 2 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 3 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 4 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 5 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 6 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 7 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 8 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 9 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 10 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 11 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 12 of 11 (Moser &amp; Ahlstrom, 1985)"</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: needs revision</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 13 of 11 (Moser &amp; Ahlstrom, 1985)"</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: needs revision</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 14 of 11 (Moser &amp; Ahlstrom, 1985)"</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: needs revision</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 15 of 11 (Moser &amp; Ahlstrom, 1985)"</span> <span class="co"># </span><span class="al">TODO</span><span class="co">: needs revision</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Larva stage vocabulary mapping</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>larva_stage_vocab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">stage =</span> <span class="fu">c</span>(<span class="st">"YOLK"</span>, <span class="st">"PREF"</span>, <span class="st">"FLEX"</span>, <span class="st">"POST"</span>, <span class="st">"TRNS"</span>),</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">stage_description =</span> <span class="fu">c</span>(</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, yolk sac"</span>,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, preflexion"</span>,</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, flexion"</span>,</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, postflexion"</span>,</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, transformation"</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="co"># P06 Measurement Unit vocabulary (NERC)</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>measurement_unit_vocab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">measurementUnit =</span> <span class="fu">c</span>(</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"individuals"</span>,</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"millimeters"</span>,</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dimensionless"</span>,</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cubic meters"</span>,</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"grams"</span>,</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"proportion"</span>,</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"m^3"</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">measurementUnitID =</span> <span class="fu">c</span>(</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UXMM/"</span>,</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/MCUB/"</span>,</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UGRM/"</span>,</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>, <span class="co"># or UPCT?</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/MCUB/"</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="create-event-hierarchy" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="create-event-hierarchy"><span class="header-section-number">6</span> Create Event Hierarchy</h2>
<p>DarwinCore uses an event-based model. We’ll create a hierarchical event structure:</p>
<ul>
<li>cruise
<ul>
<li>site
<ul>
<li>tow
<ul>
<li>net</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<div class="cell" data-file="diagrams/larvae_event_hierarchy.mmd" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-larvae_event_hierarchy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-larvae_event_hierarchy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-larvae_event_hierarchy">graph TD
    A[Cruise Event] --&gt;|parentEventID| B[Site Event]
    B --&gt;|parentEventID| C[Tow Event]
    C --&gt;|parentEventID| D[Net Sample Event]
    D --&gt;|eventID| E[Occurrence Records]
    D --&gt;|eventID| F[MeasurementOrFact - Environmental]
    E --&gt;|occurrenceID| G[MeasurementOrFact - Size]
    
    A:::cruise
    B:::site
    C:::tow
    D:::net
    E:::occurrence
    F:::measurement
    G:::measurement
    
    classDef cruise fill:#e1f5ff,stroke:#0066cc,stroke-width:2px
    classDef site fill:#fff4e1,stroke:#ff9900,stroke-width:2px
    classDef tow fill:#ffe1f5,stroke:#cc0066,stroke-width:2px
    classDef net fill:#e1ffe1,stroke:#00cc66,stroke-width:2px
    classDef occurrence fill:#f0e1ff,stroke:#6600cc,stroke-width:2px
    classDef measurement fill:#ffe1e1,stroke:#cc0000,stroke-width:2px
    
    subgraph Event Core
        A
        B
        C
        D
    end
    
    subgraph Extensions
        E
        F
        G
    end</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-larvae_event_hierarchy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Event hierarchy for CalCOFI larvae data in DarwinCore Archive format with Extended Measurement or Fact.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Per <a href="https://docs.gbif.org/guide-publishing-survey-data/en/#simple-nested-datasets-with-project-level-information">3.3.2. Simple nested datasets with Project-level information – Guide for publishing biological survey and monitoring data to GBIF</a></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build complete event hierarchy</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>q_events <span class="ot">&lt;-</span> tbl_net <span class="sc">|&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_tow, <span class="at">by =</span> <span class="st">"tow_uuid"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_tow_type, <span class="at">by =</span> <span class="st">"tow_type_key"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_site, <span class="at">by =</span> <span class="st">"site_uuid"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_cruise, <span class="at">by =</span> <span class="st">"cruise_uuid"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_ship, <span class="at">by =</span> <span class="st">"ship_key"</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create event core at different levels ----</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>flds_to_iso8601 <span class="ot">&lt;-</span> <span class="cf">function</span>(flds, <span class="at">output =</span> <span class="st">"datetime"</span>) {</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># helper function to convert date/time fields to ISO 8601 format</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># per https://dwc.tdwg.org/terms/ eventDate: add 2007-03-01T13:00:00Z/2008-05-11T15:30:00Z (some time within the interval beginning 1 March 2007 at 1pm UTC and before 11 May 2008 at 3:30pm UTC)</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">length</span>(flds) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(output <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"datetime"</span>, <span class="st">"time"</span>))</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(flds) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> output <span class="sc">==</span> <span class="st">"datetime"</span>) {</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>      <span class="st">"to_char({flds}, 'YYYY-MM-DD</span><span class="sc">\"</span><span class="st">T</span><span class="sc">\"</span><span class="st">HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">')"</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(flds) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> output <span class="sc">==</span> <span class="st">"datetime"</span>) {</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>      <span class="st">"to_char({flds[1]}, 'YYYY-MM-DD</span><span class="sc">\"</span><span class="st">T</span><span class="sc">\"</span><span class="st">HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">') || '/' || </span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="st">         to_char({flds[2]}, 'YYYY-MM-DD</span><span class="sc">\"</span><span class="st">T</span><span class="sc">\"</span><span class="st">HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">')"</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(flds) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> output <span class="sc">==</span> <span class="st">"time"</span>) {</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>      <span class="st">"to_char({flds}, 'HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">')"</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(flds) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> output <span class="sc">==</span> <span class="st">"time"</span>) {</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>      <span class="st">"to_char({flds[1]}, 'HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">') || '/' || </span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="st">       to_char({flds[2]}, 'HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">')"</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.character</span>(s)</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a><span class="co"># * Cruise level events ----</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a><span class="co"># get min/max datetimes for cruises</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>q_cruise_event_date <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cruise_uuid) <span class="sc">|&gt;</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">dtime_min =</span> <span class="fu">min</span>(time_start, <span class="at">na.rm =</span> T),</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">dtime_max =</span> <span class="fu">max</span>(time_start, <span class="at">na.rm =</span> T),</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventDate =</span> <span class="fu">sql</span>(<span class="fu">flds_to_iso8601</span>(<span class="fu">c</span>(<span class="st">"dtime_min"</span>, <span class="st">"dtime_max"</span>)))</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(cruise_uuid, eventDate)</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>q_cruise_events <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(cruise_uuid, ship_name, ship_nodc, date_ym) <span class="sc">|&gt;</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> cruise_uuid,</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># parentEventID  = NA, # no parent for cruise level; NA generated with union_all</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks =</span> <span class="fu">paste</span>(<span class="st">"Cruise on"</span>, ship_name),</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="st">"Marine plankton survey cruise"</span>,</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeValue =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeUnit =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">habitat =</span> <span class="st">"marine"</span>,</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType =</span> <span class="st">"cruise"</span></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>    q_cruise_event_date,</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"cruise_uuid"</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>    eventID, <span class="co"># parentEventID,</span></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>    eventType,</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>    eventDate,</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>    samplingProtocol,</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>    eventRemarks,</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>    habitat</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Site level events</span></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>q_site_events <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>    site_uuid,</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>    cruise_uuid,</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>    longitude,</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>    latitude,</span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>    line,</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>    station,</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>    orderocc</span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> site_uuid,</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">parentEventID =</span> cruise_uuid,</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimalLatitude =</span> latitude,</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimalLongitude =</span> longitude,</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks =</span> <span class="fu">paste</span>(<span class="st">"CalCOFI station"</span>, station, <span class="st">"on line"</span>, line),</span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># per https://proj.org/en/stable/operations/projections/calcofi.html</span></span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">locationID =</span> <span class="fu">paste0</span>(line, <span class="st">"_"</span>, station),</span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType =</span> <span class="st">"site"</span>,</span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="st">"Marine plankton survey station"</span></span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>    parentEventID,</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>    eventType,</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>    samplingProtocol,</span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>    eventRemarks,</span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>    decimalLatitude,</span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>    decimalLongitude,</span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>    locationID</span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Tow level events</span></span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>q_tow_events <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(</span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>    tow_uuid,</span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>    site_uuid,</span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a>    tow_number,</span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a>    tow_type_key,</span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">tow_type_description =</span> description,</span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>    time_start</span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> tow_uuid,</span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">parentEventID =</span> site_uuid,</span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventDate =</span> <span class="fu">sql</span>(<span class="fu">flds_to_iso8601</span>(<span class="st">"time_start"</span>)),</span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks =</span> <span class="fu">paste</span>(<span class="st">"Tow"</span>, tow_number, <span class="st">"-"</span>, tow_type_description),</span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType =</span> <span class="st">"tow"</span>,</span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="fu">paste</span>(tow_type_key, <span class="st">":"</span>, tow_type_description)</span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a>    parentEventID,</span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a>    eventType,</span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a>    eventDate,</span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a>    samplingProtocol,</span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a>    eventRemarks</span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a><span class="co"># Net level events (sampling events)</span></span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a>q_net_events_allflds <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(</span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a>    net_uuid,</span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a>    tow_uuid,</span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a>    side,</span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a>    std_haul_factor,</span>
<span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a>    vol_sampled_m3,</span>
<span id="cb5-153"><a href="#cb5-153" aria-hidden="true" tabindex="-1"></a>    prop_sorted,</span>
<span id="cb5-154"><a href="#cb5-154" aria-hidden="true" tabindex="-1"></a>    smallplankton,</span>
<span id="cb5-155"><a href="#cb5-155" aria-hidden="true" tabindex="-1"></a>    totalplankton</span>
<span id="cb5-156"><a href="#cb5-156" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb5-157"><a href="#cb5-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-158"><a href="#cb5-158" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> net_uuid,</span>
<span id="cb5-159"><a href="#cb5-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">parentEventID =</span> tow_uuid,</span>
<span id="cb5-160"><a href="#cb5-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks =</span> <span class="fu">paste</span>(</span>
<span id="cb5-161"><a href="#cb5-161" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Net sample from side"</span>,</span>
<span id="cb5-162"><a href="#cb5-162" aria-hidden="true" tabindex="-1"></a>      side,</span>
<span id="cb5-163"><a href="#cb5-163" aria-hidden="true" tabindex="-1"></a>      <span class="st">"; only"</span>,</span>
<span id="cb5-164"><a href="#cb5-164" aria-hidden="true" tabindex="-1"></a>      prop_sorted,</span>
<span id="cb5-165"><a href="#cb5-165" aria-hidden="true" tabindex="-1"></a>      <span class="st">"proportion sorted of"</span>,</span>
<span id="cb5-166"><a href="#cb5-166" aria-hidden="true" tabindex="-1"></a>      vol_sampled_m3,</span>
<span id="cb5-167"><a href="#cb5-167" aria-hidden="true" tabindex="-1"></a>      <span class="st">"cubic meters sampled"</span></span>
<span id="cb5-168"><a href="#cb5-168" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb5-169"><a href="#cb5-169" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType =</span> <span class="st">"net_sample"</span>,</span>
<span id="cb5-170"><a href="#cb5-170" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="fu">paste</span>(<span class="st">"Plankton net tow -"</span>, side, <span class="st">"side"</span>),</span>
<span id="cb5-171"><a href="#cb5-171" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeValue =</span> vol_sampled_m3,</span>
<span id="cb5-172"><a href="#cb5-172" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeUnit =</span> <span class="st">"m^3"</span></span>
<span id="cb5-173"><a href="#cb5-173" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-174"><a href="#cb5-174" aria-hidden="true" tabindex="-1"></a>q_net_events <span class="ot">&lt;-</span> q_net_events_allflds <span class="sc">|&gt;</span></span>
<span id="cb5-175"><a href="#cb5-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb5-176"><a href="#cb5-176" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb5-177"><a href="#cb5-177" aria-hidden="true" tabindex="-1"></a>    parentEventID,</span>
<span id="cb5-178"><a href="#cb5-178" aria-hidden="true" tabindex="-1"></a>    eventType,</span>
<span id="cb5-179"><a href="#cb5-179" aria-hidden="true" tabindex="-1"></a>    samplingProtocol,</span>
<span id="cb5-180"><a href="#cb5-180" aria-hidden="true" tabindex="-1"></a>    eventRemarks,</span>
<span id="cb5-181"><a href="#cb5-181" aria-hidden="true" tabindex="-1"></a>    sampleSizeValue,</span>
<span id="cb5-182"><a href="#cb5-182" aria-hidden="true" tabindex="-1"></a>    sampleSizeUnit</span>
<span id="cb5-183"><a href="#cb5-183" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-184"><a href="#cb5-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-185"><a href="#cb5-185" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all event levels</span></span>
<span id="cb5-186"><a href="#cb5-186" aria-hidden="true" tabindex="-1"></a>db_version <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"schema_version"</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(version)</span>
<span id="cb5-187"><a href="#cb5-187" aria-hidden="true" tabindex="-1"></a><span class="co"># dataset_id &lt;- paste0(</span></span>
<span id="cb5-188"><a href="#cb5-188" aria-hidden="true" tabindex="-1"></a><span class="co">#   # "https://github.com/CalCOFI/calcofi4db/releases/tag/v",</span></span>
<span id="cb5-189"><a href="#cb5-189" aria-hidden="true" tabindex="-1"></a><span class="co">#   "calcofi_db.",</span></span>
<span id="cb5-190"><a href="#cb5-190" aria-hidden="true" tabindex="-1"></a><span class="co">#   db_version,</span></span>
<span id="cb5-191"><a href="#cb5-191" aria-hidden="true" tabindex="-1"></a><span class="co">#   "_larvae.",</span></span>
<span id="cb5-192"><a href="#cb5-192" aria-hidden="true" tabindex="-1"></a><span class="co">#   format(Sys.Date(), "%Y-%m-%d")</span></span>
<span id="cb5-193"><a href="#cb5-193" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb5-194"><a href="#cb5-194" aria-hidden="true" tabindex="-1"></a><span class="co"># "calcofi_db.1.1.0_larvae.2025-10-09"</span></span>
<span id="cb5-195"><a href="#cb5-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-196"><a href="#cb5-196" aria-hidden="true" tabindex="-1"></a>q_event_core <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb5-197"><a href="#cb5-197" aria-hidden="true" tabindex="-1"></a>  q_cruise_events <span class="sc">|&gt;</span></span>
<span id="cb5-198"><a href="#cb5-198" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-199"><a href="#cb5-199" aria-hidden="true" tabindex="-1"></a>      <span class="at">parentEventID =</span> <span class="fu">sql</span>(<span class="st">"NULL::uuid"</span>),</span>
<span id="cb5-200"><a href="#cb5-200" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeValue =</span> <span class="fu">sql</span>(<span class="st">"NULL::numeric"</span>),</span>
<span id="cb5-201"><a href="#cb5-201" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeUnit =</span> <span class="cn">NA_character_</span></span>
<span id="cb5-202"><a href="#cb5-202" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb5-203"><a href="#cb5-203" aria-hidden="true" tabindex="-1"></a>  q_site_events <span class="sc">|&gt;</span></span>
<span id="cb5-204"><a href="#cb5-204" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-205"><a href="#cb5-205" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeValue =</span> <span class="fu">sql</span>(<span class="st">"NULL::numeric"</span>),</span>
<span id="cb5-206"><a href="#cb5-206" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeUnit =</span> <span class="cn">NA_character_</span></span>
<span id="cb5-207"><a href="#cb5-207" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb5-208"><a href="#cb5-208" aria-hidden="true" tabindex="-1"></a>  q_tow_events <span class="sc">|&gt;</span></span>
<span id="cb5-209"><a href="#cb5-209" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-210"><a href="#cb5-210" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeValue =</span> <span class="fu">sql</span>(<span class="st">"NULL::numeric"</span>),</span>
<span id="cb5-211"><a href="#cb5-211" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeUnit =</span> <span class="cn">NA_character_</span></span>
<span id="cb5-212"><a href="#cb5-212" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb5-213"><a href="#cb5-213" aria-hidden="true" tabindex="-1"></a>  q_net_events</span>
<span id="cb5-214"><a href="#cb5-214" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb5-215"><a href="#cb5-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reduce</span>(union_all) <span class="sc">|&gt;</span></span>
<span id="cb5-216"><a href="#cb5-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-217"><a href="#cb5-217" aria-hidden="true" tabindex="-1"></a>    <span class="co"># basisOfRecord                 = "HumanObservation",</span></span>
<span id="cb5-218"><a href="#cb5-218" aria-hidden="true" tabindex="-1"></a>    <span class="at">geodeticDatum =</span> <span class="st">"WGS84"</span>,</span>
<span id="cb5-219"><a href="#cb5-219" aria-hidden="true" tabindex="-1"></a>    <span class="at">coordinateUncertaintyInMeters =</span> <span class="dv">1000</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: adjust based on accuracy of GPS/Loran/dead-reckoning over time</span></span>
<span id="cb5-220"><a href="#cb5-220" aria-hidden="true" tabindex="-1"></a>    <span class="at">countryCode =</span> country_code, <span class="co"># country_code &lt;- "US"</span></span>
<span id="cb5-221"><a href="#cb5-221" aria-hidden="true" tabindex="-1"></a>    <span class="at">waterBody =</span> water_body,</span>
<span id="cb5-222"><a href="#cb5-222" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasetID =</span> dataset_id</span>
<span id="cb5-223"><a href="#cb5-223" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-224"><a href="#cb5-224" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: datasetID: permalink to this qmd in calcofi4db release?</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="create-occurrence-records" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="create-occurrence-records"><span class="header-section-number">7</span> Create Occurrence Records</h2>
<p>Now let’s combine all biological observations into occurrence records:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create consolidated egg occurrences (one per species per net)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>q_egg_occurrences <span class="ot">&lt;-</span> tbl_egg <span class="sc">|&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_species, <span class="at">by =</span> <span class="st">"species_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID =</span> <span class="fu">sql</span>(<span class="st">"gen_random_uuid()"</span>),</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> net_uuid,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificName =</span> scientific_name,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificNameID =</span> <span class="fu">paste0</span>(<span class="st">"urn:lsid:marinespecies.org:taxname:"</span>, worms_id),</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">kingdom =</span> <span class="st">"Animalia"</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceStatus =</span> <span class="fu">ifelse</span>(tally <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"present"</span>, <span class="st">"absent"</span>),</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantity =</span> tally, <span class="co"># TOTAL count from egg table</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantityType =</span> <span class="st">"individuals"</span>,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">lifeStage =</span> <span class="st">"egg"</span>,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#lifeStage            = "https://vocab.nerc.ac.uk/collection/S11/current/S1122/",</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># lifeStageID          = "http://vocab.nerc.ac.uk/collection/S11/current/S1110/",</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">preparations =</span> <span class="st">"egg sample"</span>,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">basisOfRecord =</span> <span class="st">"HumanObservation"</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    occurrenceID,</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    species_id,</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    scientificName,</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    scientificNameID,</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    kingdom,</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    occurrenceStatus,</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    organismQuantity,</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    organismQuantityType,</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    lifeStage, <span class="co"># lifeStageID,</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    preparations,</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    basisOfRecord</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Create consolidated larva occurrences (one per species per net)</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>q_larva_occurrences <span class="ot">&lt;-</span> tbl_larva <span class="sc">|&gt;</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_species, <span class="at">by =</span> <span class="st">"species_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID =</span> <span class="fu">sql</span>(<span class="st">"gen_random_uuid()"</span>),</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> net_uuid,</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificName =</span> scientific_name,</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificNameID =</span> <span class="fu">paste0</span>(<span class="st">"urn:lsid:marinespecies.org:taxname:"</span>, worms_id),</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">kingdom =</span> <span class="st">"Animalia"</span>,</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceStatus =</span> <span class="fu">ifelse</span>(tally <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"present"</span>, <span class="st">"absent"</span>),</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantity =</span> tally, <span class="co"># TOTAL count from larva table</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantityType =</span> <span class="st">"individuals"</span>,</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">lifeStage =</span> <span class="st">"larva"</span>,</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># lifeStageID          = "http://vocab.nerc.ac.uk/collection/S11/current/S1133/",</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">preparations =</span> <span class="st">"larva sample"</span>,</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">basisOfRecord =</span> <span class="st">"HumanObservation"</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>    occurrenceID,</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    species_id,</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>    scientificName,</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>    scientificNameID,</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>    kingdom,</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>    occurrenceStatus,</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>    organismQuantity,</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>    organismQuantityType,</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    lifeStage, <span class="co"># lifeStageID,</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>    preparations,</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>    basisOfRecord</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine egg and larva occurrences</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>q_occurrence_extension <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>  q_egg_occurrences,</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>  q_larva_occurrences</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reduce</span>(union_all) <span class="sc">|&gt;</span></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add additional required/recommended fields</span></span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: identifiedBy, dateIdentified,identificationReferences</span></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># identifiedBy = "[NEED IDENTIFIER NAME]", # Prompt: Add taxonomist name</span></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dateIdentified = "[NEED IDENTIFICATION DATE]", # Prompt: Add identification date</span></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># identificationReferences = "[NEED REFERENCES]", # Prompt: Add identification guides used</span></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">modified =</span> <span class="fu">sql</span>(<span class="st">"CURRENT_DATE"</span>)</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove species_id (internal field used only for joins)</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>    occurrenceID,</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>    scientificName,</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>    scientificNameID,</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>    kingdom,</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>    occurrenceStatus,</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>    organismQuantity,</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>    organismQuantityType,</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>    lifeStage, <span class="co"># lifeStageID,</span></span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>    preparations,</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>    basisOfRecord,</span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>    modified</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="create-extendedmeasurementorfact-extension" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="create-extendedmeasurementorfact-extension"><span class="header-section-number">8</span> Create ExtendedMeasurementOrFact Extension</h2>
<p>Create eMoF records for three types of measurements:</p>
<ol type="1">
<li>Sample-level measurements (linked to eventID)</li>
<li>Stage-specific abundance (linked to occurrenceID)</li>
<li>Body length measurements (linked to occurrence ID)</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Sample-level measurements (eventID, occurrenceID = NA) ----</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>d_sample_measurements <span class="ot">&lt;-</span> q_net_events_allflds <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    std_haul_factor,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    prop_sorted,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    smallplankton,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    totalplankton</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> <span class="co"># vol_sampled_m3 moved to Event core</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(std_haul_factor, prop_sorted, smallplankton, totalplankton),</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"meas_type"</span>,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"measurementValue"</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(measurementValue)) <span class="sc">|&gt;</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID =</span> <span class="fu">UUIDgenerate</span>(<span class="at">n =</span> <span class="fu">n</span>()),</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType =</span> <span class="fu">case_when</span>(</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span> <span class="sc">~</span> <span class="st">"standardized haul factor"</span>,</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span> <span class="sc">~</span> <span class="st">"proportion of sample sorted"</span>,</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"smallplankton"</span> <span class="sc">~</span> <span class="st">"small plankton biomass"</span>,</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"totalplankton"</span> <span class="sc">~</span> <span class="st">"total plankton biomass"</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID =</span> <span class="fu">case_when</span>(</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span> <span class="sc">~</span> <span class="cn">NA_character_</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for standardization factor</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span> <span class="sc">~</span> <span class="cn">NA_character_</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for subsample fraction</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"smallplankton"</span> <span class="sc">~</span> <span class="cn">NA_character_</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for zooplankton biomass</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"totalplankton"</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    ), <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for zooplankton biomass</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit =</span> <span class="fu">case_when</span>(</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span> <span class="sc">~</span> <span class="st">"dimensionless"</span>,</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span> <span class="sc">~</span> <span class="st">"dimensionless"</span>,</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"smallplankton"</span>, <span class="st">"totalplankton"</span>) <span class="sc">~</span> <span class="st">"grams"</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> <span class="fu">case_when</span>(</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">"std_haul_factor"</span> <span class="sc">~</span> <span class="st">"Standardization factor accounting for water filtered; abundances expressed as per 10 m² (Smith 1977)"</span>,</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span> <span class="sc">~</span> <span class="st">"Fraction of total sample examined"</span>,</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    occurrenceID,</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>    measurementID,</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>    measurementType,</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>    measurementTypeID,</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>    measurementValue,</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>    measurementUnit,</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>    measurementUnitID,</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>    measurementMethod,</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>    measurementRemarks</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Stage-specific abundance (eventID = NA, occurrenceID) ----</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Egg stage abundances - need to join with egg occurrences to get occurrenceID</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>d_egg_stage_abundance <span class="ot">&lt;-</span> tbl_egg_stage <span class="sc">|&gt;</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>    egg_stage_vocab <span class="sc">|&gt;</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>      <span class="fu">copy_to</span>(</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>        con,</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>        <span class="at">df =</span> _,</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">"egg_stage_vocab_tmp"</span>,</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>        <span class="at">temporary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">overwrite =</span> T</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"stage"</span></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>    q_egg_occurrences <span class="sc">|&gt;</span></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>      <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="at">net_uuid =</span> eventID, species_id, occurrenceID),</span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"net_uuid"</span>, <span class="st">"species_id"</span>)</span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID =</span> <span class="fu">UUIDgenerate</span>(<span class="at">n =</span> <span class="fu">n</span>()),</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType =</span> <span class="st">"abundance by life stage"</span>,</span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID =</span> <span class="cn">NA_character_</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for "abundance" + "development stage"</span></span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue =</span> tally,</span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValueID =</span> <span class="cn">NA_character_</span>, <span class="co"># Could reference custom vocabulary for egg stages</span></span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit =</span> <span class="st">"individuals"</span>,</span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> stage_description</span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>    occurrenceID,</span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>    measurementID,</span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a>    measurementType,</span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>    measurementTypeID,</span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>    measurementValue,</span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>    measurementValueID,</span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>    <span class="co">#measurementUnit, measurementUnitID = measurementUnitID.y, measurementMethod,</span></span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>    measurementUnit,</span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a>    measurementUnitID,</span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>    measurementMethod,</span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a>    measurementRemarks</span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a><span class="co"># Larva stage abundances - need to join with larva occurrences to get occurrenceID</span></span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a>d_larva_stage_abundance <span class="ot">&lt;-</span> tbl_larva_stage <span class="sc">|&gt;</span></span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a>    larva_stage_vocab <span class="sc">|&gt;</span></span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a>      <span class="fu">copy_to</span>(</span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a>        con,</span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a>        <span class="at">df =</span> _,</span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">"larva_stage_vocab_tmp"</span>,</span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>        <span class="at">temporary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a>        <span class="at">overwrite =</span> T</span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"stage"</span></span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>    q_larva_occurrences <span class="sc">|&gt;</span></span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>      <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="at">net_uuid =</span> eventID, species_id, occurrenceID),</span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"net_uuid"</span>, <span class="st">"species_id"</span>)</span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID =</span> <span class="fu">UUIDgenerate</span>(<span class="at">n =</span> <span class="fu">n</span>()),</span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType =</span> <span class="st">"abundance by life stage"</span>,</span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID =</span> <span class="cn">NA_character_</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for "abundance" + "development stage"</span></span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue =</span> tally,</span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValueID =</span> <span class="cn">NA_character_</span>, <span class="co"># Could reference custom vocabulary for larva stages</span></span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit =</span> <span class="st">"individuals"</span>,</span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> stage_description</span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a>    occurrenceID,</span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a>    measurementID,</span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a>    measurementType,</span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a>    measurementTypeID,</span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a>    measurementValue,</span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a>    measurementValueID,</span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a>    measurementUnit,</span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true" tabindex="-1"></a>    measurementUnitID,</span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true" tabindex="-1"></a>    measurementMethod,</span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true" tabindex="-1"></a>    measurementRemarks</span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Body length measurements (eventID = NA, occurrenceID) ----</span></span>
<span id="cb7-155"><a href="#cb7-155" aria-hidden="true" tabindex="-1"></a>d_body_length <span class="ot">&lt;-</span> tbl_larva_size <span class="sc">|&gt;</span></span>
<span id="cb7-156"><a href="#cb7-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true" tabindex="-1"></a>    q_larva_occurrences <span class="sc">|&gt;</span></span>
<span id="cb7-159"><a href="#cb7-159" aria-hidden="true" tabindex="-1"></a>      <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-160"><a href="#cb7-160" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="at">net_uuid =</span> eventID, species_id, occurrenceID),</span>
<span id="cb7-161"><a href="#cb7-161" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"net_uuid"</span>, <span class="st">"species_id"</span>)</span>
<span id="cb7-162"><a href="#cb7-162" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb7-163"><a href="#cb7-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(length_mm)) <span class="sc">|&gt;</span></span>
<span id="cb7-164"><a href="#cb7-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-165"><a href="#cb7-165" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb7-166"><a href="#cb7-166" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID =</span> <span class="fu">UUIDgenerate</span>(<span class="at">n =</span> <span class="fu">n</span>()),</span>
<span id="cb7-167"><a href="#cb7-167" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType =</span> <span class="st">"body length"</span>,</span>
<span id="cb7-168"><a href="#cb7-168" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID =</span> <span class="cn">NA_character_</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for fish larvae body length (e.g., OBSINDLX)</span></span>
<span id="cb7-169"><a href="#cb7-169" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue =</span> length_mm,</span>
<span id="cb7-170"><a href="#cb7-170" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValueID =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb7-171"><a href="#cb7-171" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit =</span> <span class="st">"millimeters"</span>,</span>
<span id="cb7-172"><a href="#cb7-172" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb7-173"><a href="#cb7-173" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> <span class="fu">paste0</span>(<span class="st">"Count: "</span>, tally, <span class="st">"; Total length measurement"</span>)</span>
<span id="cb7-174"><a href="#cb7-174" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb7-175"><a href="#cb7-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-176"><a href="#cb7-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb7-177"><a href="#cb7-177" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb7-178"><a href="#cb7-178" aria-hidden="true" tabindex="-1"></a>    occurrenceID,</span>
<span id="cb7-179"><a href="#cb7-179" aria-hidden="true" tabindex="-1"></a>    measurementID,</span>
<span id="cb7-180"><a href="#cb7-180" aria-hidden="true" tabindex="-1"></a>    measurementType,</span>
<span id="cb7-181"><a href="#cb7-181" aria-hidden="true" tabindex="-1"></a>    measurementTypeID,</span>
<span id="cb7-182"><a href="#cb7-182" aria-hidden="true" tabindex="-1"></a>    measurementValue,</span>
<span id="cb7-183"><a href="#cb7-183" aria-hidden="true" tabindex="-1"></a>    measurementValueID,</span>
<span id="cb7-184"><a href="#cb7-184" aria-hidden="true" tabindex="-1"></a>    measurementUnit,</span>
<span id="cb7-185"><a href="#cb7-185" aria-hidden="true" tabindex="-1"></a>    measurementUnitID,</span>
<span id="cb7-186"><a href="#cb7-186" aria-hidden="true" tabindex="-1"></a>    measurementMethod,</span>
<span id="cb7-187"><a href="#cb7-187" aria-hidden="true" tabindex="-1"></a>    measurementRemarks</span>
<span id="cb7-188"><a href="#cb7-188" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-189"><a href="#cb7-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-190"><a href="#cb7-190" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all eMoF records ----</span></span>
<span id="cb7-191"><a href="#cb7-191" aria-hidden="true" tabindex="-1"></a>d_extendedmeasurementorfact_extension <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb7-192"><a href="#cb7-192" aria-hidden="true" tabindex="-1"></a>  d_sample_measurements,</span>
<span id="cb7-193"><a href="#cb7-193" aria-hidden="true" tabindex="-1"></a>  d_egg_stage_abundance,</span>
<span id="cb7-194"><a href="#cb7-194" aria-hidden="true" tabindex="-1"></a>  d_larva_stage_abundance,</span>
<span id="cb7-195"><a href="#cb7-195" aria-hidden="true" tabindex="-1"></a>  d_body_length</span>
<span id="cb7-196"><a href="#cb7-196" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-197"><a href="#cb7-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-198"><a href="#cb7-198" aria-hidden="true" tabindex="-1"></a><span class="co"># table(is.na(d_extendedmeasurementorfact_extension$occurrenceID))</span></span>
<span id="cb7-199"><a href="#cb7-199" aria-hidden="true" tabindex="-1"></a><span class="co">#   FALSE    TRUE</span></span>
<span id="cb7-200"><a href="#cb7-200" aria-hidden="true" tabindex="-1"></a><span class="co"># 367,218 243,598</span></span>
<span id="cb7-201"><a href="#cb7-201" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb7-202"><a href="#cb7-202" aria-hidden="true" tabindex="-1"></a><span class="co"># table(is.na(d_extendedmeasurementorfact_extension$eventID))</span></span>
<span id="cb7-203"><a href="#cb7-203" aria-hidden="true" tabindex="-1"></a><span class="co">#   FALSE    TRUE</span></span>
<span id="cb7-204"><a href="#cb7-204" aria-hidden="true" tabindex="-1"></a><span class="co"># 243,598 367,218</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="write-darwincore-archive-files" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="write-darwincore-archive-files"><span class="header-section-number">9</span> Write DarwinCore Archive Files</h2>
<p>Export the event core and extension files (occurrence, eMoF) as CSV files:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create output directory</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(dir_out, <span class="at">showWarnings =</span> F)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Write core and extension files</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(q_event_core <span class="sc">|&gt;</span> <span class="fu">collect</span>(), <span class="fu">file.path</span>(dir_out, <span class="st">"event.csv"</span>))</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  q_occurrence_extension <span class="sc">|&gt;</span> <span class="fu">collect</span>(),</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(dir_out, <span class="st">"occurrence.csv"</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  d_extendedmeasurementorfact_extension,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(dir_out, <span class="st">"extendedMeasurementOrFact.csv"</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="create-meta.xml-programmatically-by-cross-walking-csv-fields-to-dwc-terms" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="create-meta.xml-programmatically-by-cross-walking-csv-fields-to-dwc-terms"><span class="header-section-number">10</span> Create meta.xml programmatically by cross-walking CSV fields to DwC terms</h2>
<p>Generate <code>meta.xml</code> by mapping CSV column names to DarwinCore term URIs:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define DarwinCore term mappings for each file type</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>dwc_terms <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">event =</span> <span class="fu">list</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">rowType =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/Event"</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">idField =</span> <span class="st">"eventID"</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms =</span> <span class="fu">c</span>(</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventID"</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">parentEventID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/parentEventID"</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventType =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventType"</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventDate =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventDate"</span>,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventTime =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventTime"</span>,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">samplingProtocol =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/samplingProtocol"</span>,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeValue =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/sampleSizeValue"</span>,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeUnit =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/sampleSizeUnit"</span>,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventRemarks =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventRemarks"</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">habitat =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/habitat"</span>,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">decimalLatitude =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/decimalLatitude"</span>,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">decimalLongitude =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/decimalLongitude"</span>,</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">geodeticDatum =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/geodeticDatum"</span>,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">coordinateUncertaintyInMeters =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/coordinateUncertaintyInMeters"</span>,</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">locationID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/locationID"</span>,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">countryCode =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/countryCode"</span>,</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">waterBody =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/waterBody"</span>,</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">datasetID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/datasetID"</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># basisOfRecord                 = "http://rs.tdwg.org/dwc/terms/basisOfRecord"</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">occurrence =</span> <span class="fu">list</span>(</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">rowType =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/Occurrence"</span>,</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">idField =</span> <span class="st">"occurrenceID"</span>,</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreIdField =</span> <span class="st">"eventID"</span>,</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms =</span> <span class="fu">c</span>(</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">occurrenceID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceID"</span>,</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventID"</span>,</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">scientificName =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/scientificName"</span>,</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">scientificNameID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/scientificNameID"</span>,</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">kingdom =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/kingdom"</span>,</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">occurrenceStatus =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceStatus"</span>,</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">organismQuantity =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/organismQuantity"</span>,</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">organismQuantityType =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/organismQuantityType"</span>,</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">lifeStage =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/lifeStage"</span>,</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>      <span class="co"># lifeStageID          = "http://rs.tdwg.org/dwc/terms/lifeStageID",</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">preparations =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/preparations"</span>,</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">basisOfRecord =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/basisOfRecord"</span>,</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">modified =</span> <span class="st">"http://purl.org/dc/terms/modified"</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">extendedmeasurementorfact =</span> <span class="fu">list</span>(</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">rowType =</span> <span class="st">"http://rs.iobis.org/obis/terms/ExtendedMeasurementOrFact"</span>,</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">idField =</span> <span class="st">"measurementID"</span>,</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreIdField =</span> <span class="st">"eventID"</span>, <span class="co"># Primary linking field</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms =</span> <span class="fu">c</span>(</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventID"</span>,</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">occurrenceID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceID"</span>,</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementID"</span>,</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementType =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementType"</span>,</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementTypeID =</span> <span class="st">"http://rs.iobis.org/obis/terms/measurementTypeID"</span>,</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementValue =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementValue"</span>,</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementValueID =</span> <span class="st">"http://rs.iobis.org/obis/terms/measurementValueID"</span>,</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementUnit =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementUnit"</span>,</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementUnitID =</span> <span class="st">"http://rs.iobis.org/obis/terms/measurementUnitID"</span>,</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementMethod =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementMethod"</span>,</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementRemarks =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementRemarks"</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to create field elements for meta.xml</span></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>create_field_elements <span class="ot">&lt;-</span> <span class="cf">function</span>(csv_file, term_map, <span class="at">coreid_field =</span> <span class="cn">NULL</span>) {</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read column names from CSV</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">read_csv</span>(csv_file, <span class="at">n_max =</span> <span class="dv">0</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>))</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Map columns to DwC terms</span></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>  field_elements <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="fu">seq_along</span>(col_names), <span class="cf">function</span>(i) {</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>    col <span class="ot">&lt;-</span> col_names[i]</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skip coreid column if specified (it's defined separately in &lt;coreid&gt; element)</span></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(coreid_field) <span class="sc">&amp;&amp;</span> col <span class="sc">==</span> coreid_field) {</span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>    term <span class="ot">&lt;-</span> term_map<span class="sc">$</span>terms[[col]]</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(term)) {</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>      glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'    &lt;field index="{i-1}" term="{term}"/&gt;'</span>)</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Field exists in CSV but not in DwC mapping - skip or warn</span></span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Warning: Column '"</span>,</span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>        col,</span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>        <span class="st">"' in "</span>,</span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>        csv_file,</span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>        <span class="st">" has no DwC mapping and will be skipped in meta.xml."</span></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NULL</span></span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove NULL entries and combine</span></span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>  field_elements <span class="ot">&lt;-</span> <span class="fu">compact</span>(field_elements)</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(field_elements, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to determine coreID index</span></span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>get_coreid_index <span class="ot">&lt;-</span> <span class="cf">function</span>(csv_file, coreid_field) {</span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">read_csv</span>(csv_file, <span class="at">n_max =</span> <span class="dv">0</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>))</span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Handle multiple possible coreID fields (eventID or occurrenceID)</span></span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coreid_field) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find which one exists in the CSV</span></span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>    coreid_field <span class="ot">&lt;-</span> <span class="fu">intersect</span>(coreid_field, col_names)[<span class="dv">1</span>]</span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">which</span>(col_names <span class="sc">==</span> coreid_field) <span class="sc">-</span> <span class="dv">1</span> <span class="co"># 0-indexed</span></span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate meta.xml content</span></span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>generate_meta_xml <span class="ot">&lt;-</span> <span class="cf">function</span>(dir_out) {</span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Core (Event)</span></span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>  event_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"event.csv"</span>)</span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>  event_fields <span class="ot">&lt;-</span> <span class="fu">create_field_elements</span>(event_file, dwc_terms<span class="sc">$</span>event)</span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>  event_id_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(</span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(<span class="fu">read_csv</span>(event_file, <span class="at">n_max =</span> <span class="dv">0</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)) <span class="sc">==</span></span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a>      dwc_terms<span class="sc">$</span>event<span class="sc">$</span>idField</span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">-</span></span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span></span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extension: Occurrence</span></span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a>  occ_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"occurrence.csv"</span>)</span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>  occ_fields <span class="ot">&lt;-</span> <span class="fu">create_field_elements</span>(</span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a>    occ_file,</span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a>    dwc_terms<span class="sc">$</span>occurrence,</span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreid_field =</span> dwc_terms<span class="sc">$</span>occurrence<span class="sc">$</span>coreIdField</span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a>  occ_coreid_idx <span class="ot">&lt;-</span> <span class="fu">get_coreid_index</span>(occ_file, dwc_terms<span class="sc">$</span>occurrence<span class="sc">$</span>coreIdField)</span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extension: ExtendedMeasurementOrFact</span></span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a>  emof_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"extendedMeasurementOrFact.csv"</span>)</span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a>  emof_fields <span class="ot">&lt;-</span> <span class="fu">create_field_elements</span>(</span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a>    emof_file,</span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a>    dwc_terms<span class="sc">$</span>extendedmeasurementorfact,</span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreid_field =</span> dwc_terms<span class="sc">$</span>extendedmeasurementorfact<span class="sc">$</span>coreIdField</span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a>  emof_coreid_idx <span class="ot">&lt;-</span> <span class="fu">get_coreid_index</span>(</span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a>    emof_file,</span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a>    dwc_terms<span class="sc">$</span>extendedmeasurementorfact<span class="sc">$</span>coreIdField</span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build complete meta.xml</span></span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a>  meta_xml <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;archive xmlns="http://rs.tdwg.org/dwc/text/"</span></span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a><span class="st">         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</span></span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a><span class="st">         xsi:schemaLocation="http://rs.tdwg.org/dwc/text/ http://rs.tdwg.org/dwc/text/tdwg_dwc_text.xsd"&gt;</span></span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;core encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="</span><span class="sc">\\</span><span class="st">n"</span></span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a><span class="st">        fieldsEnclosedBy=</span><span class="sc">\'</span><span class="st">"</span><span class="sc">\'</span><span class="st"> ignoreHeaderLines="1" rowType="{dwc_terms$event$rowType}"&gt;</span></span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;files&gt;</span></span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a><span class="st">      &lt;location&gt;event.csv&lt;/location&gt;</span></span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/files&gt;</span></span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;id index="{event_id_idx}" /&gt;</span></span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a><span class="st">{event_fields}</span></span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;/core&gt;</span></span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="</span><span class="sc">\\</span><span class="st">n"</span></span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a><span class="st">             fieldsEnclosedBy=</span><span class="sc">\'</span><span class="st">"</span><span class="sc">\'</span><span class="st"> ignoreHeaderLines="1" rowType="{dwc_terms$occurrence$rowType}"&gt;</span></span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;files&gt;</span></span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a><span class="st">      &lt;location&gt;occurrence.csv&lt;/location&gt;</span></span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/files&gt;</span></span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;coreid index="{occ_coreid_idx}" /&gt;</span></span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a><span class="st">{occ_fields}</span></span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;/extension&gt;</span></span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="</span><span class="sc">\\</span><span class="st">n"</span></span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a><span class="st">             fieldsEnclosedBy=</span><span class="sc">\'</span><span class="st">"</span><span class="sc">\'</span><span class="st"> ignoreHeaderLines="1" rowType="{dwc_terms$extendedmeasurementorfact$rowType}"&gt;</span></span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;files&gt;</span></span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a><span class="st">      &lt;location&gt;extendedMeasurementOrFact.csv&lt;/location&gt;</span></span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/files&gt;</span></span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;coreid index="{emof_coreid_idx}" /&gt;</span></span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a><span class="st">{emof_fields}</span></span>
<span id="cb9-178"><a href="#cb9-178" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;/extension&gt;</span></span>
<span id="cb9-179"><a href="#cb9-179" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/archive&gt;'</span></span>
<span id="cb9-180"><a href="#cb9-180" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-181"><a href="#cb9-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-182"><a href="#cb9-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(meta_xml)</span>
<span id="cb9-183"><a href="#cb9-183" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-184"><a href="#cb9-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-185"><a href="#cb9-185" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate and write meta.xml</span></span>
<span id="cb9-186"><a href="#cb9-186" aria-hidden="true" tabindex="-1"></a>meta_xml <span class="ot">&lt;-</span> <span class="fu">generate_meta_xml</span>(dir_out)</span>
<span id="cb9-187"><a href="#cb9-187" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(meta_xml, <span class="fu">file.path</span>(dir_out, <span class="st">"meta.xml"</span>))</span>
<span id="cb9-188"><a href="#cb9-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-189"><a href="#cb9-189" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Generated meta.xml with field mappings:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Generated meta.xml with field mappings:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(meta_xml)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;archive xmlns="http://rs.tdwg.org/dwc/text/"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://rs.tdwg.org/dwc/text/ http://rs.tdwg.org/dwc/text/tdwg_dwc_text.xsd"&gt;
  &lt;core encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="\n"
        fieldsEnclosedBy='"' ignoreHeaderLines="1" rowType="http://rs.tdwg.org/dwc/terms/Event"&gt;
    &lt;files&gt;
      &lt;location&gt;event.csv&lt;/location&gt;
    &lt;/files&gt;
    &lt;id index="0" /&gt;
    &lt;field index="0" term="http://rs.tdwg.org/dwc/terms/eventID"/&gt;
    &lt;field index="1" term="http://rs.tdwg.org/dwc/terms/eventType"/&gt;
    &lt;field index="2" term="http://rs.tdwg.org/dwc/terms/eventDate"/&gt;
    &lt;field index="3" term="http://rs.tdwg.org/dwc/terms/samplingProtocol"/&gt;
    &lt;field index="4" term="http://rs.tdwg.org/dwc/terms/eventRemarks"/&gt;
    &lt;field index="5" term="http://rs.tdwg.org/dwc/terms/habitat"/&gt;
    &lt;field index="6" term="http://rs.tdwg.org/dwc/terms/parentEventID"/&gt;
    &lt;field index="7" term="http://rs.tdwg.org/dwc/terms/sampleSizeValue"/&gt;
    &lt;field index="8" term="http://rs.tdwg.org/dwc/terms/sampleSizeUnit"/&gt;
    &lt;field index="9" term="http://rs.tdwg.org/dwc/terms/decimalLatitude"/&gt;
    &lt;field index="10" term="http://rs.tdwg.org/dwc/terms/decimalLongitude"/&gt;
    &lt;field index="11" term="http://rs.tdwg.org/dwc/terms/locationID"/&gt;
    &lt;field index="12" term="http://rs.tdwg.org/dwc/terms/geodeticDatum"/&gt;
    &lt;field index="13" term="http://rs.tdwg.org/dwc/terms/coordinateUncertaintyInMeters"/&gt;
    &lt;field index="14" term="http://rs.tdwg.org/dwc/terms/countryCode"/&gt;
    &lt;field index="15" term="http://rs.tdwg.org/dwc/terms/waterBody"/&gt;
    &lt;field index="16" term="http://rs.tdwg.org/dwc/terms/datasetID"/&gt;
  &lt;/core&gt;
  &lt;extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="\n"
             fieldsEnclosedBy='"' ignoreHeaderLines="1" rowType="http://rs.tdwg.org/dwc/terms/Occurrence"&gt;
    &lt;files&gt;
      &lt;location&gt;occurrence.csv&lt;/location&gt;
    &lt;/files&gt;
    &lt;coreid index="1" /&gt;
    &lt;field index="0" term="http://rs.tdwg.org/dwc/terms/occurrenceID"/&gt;
    &lt;field index="2" term="http://rs.tdwg.org/dwc/terms/scientificName"/&gt;
    &lt;field index="3" term="http://rs.tdwg.org/dwc/terms/scientificNameID"/&gt;
    &lt;field index="4" term="http://rs.tdwg.org/dwc/terms/kingdom"/&gt;
    &lt;field index="5" term="http://rs.tdwg.org/dwc/terms/occurrenceStatus"/&gt;
    &lt;field index="6" term="http://rs.tdwg.org/dwc/terms/organismQuantity"/&gt;
    &lt;field index="7" term="http://rs.tdwg.org/dwc/terms/organismQuantityType"/&gt;
    &lt;field index="8" term="http://rs.tdwg.org/dwc/terms/lifeStage"/&gt;
    &lt;field index="9" term="http://rs.tdwg.org/dwc/terms/preparations"/&gt;
    &lt;field index="10" term="http://rs.tdwg.org/dwc/terms/basisOfRecord"/&gt;
    &lt;field index="11" term="http://purl.org/dc/terms/modified"/&gt;
  &lt;/extension&gt;
  &lt;extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="\n"
             fieldsEnclosedBy='"' ignoreHeaderLines="1" rowType="http://rs.iobis.org/obis/terms/ExtendedMeasurementOrFact"&gt;
    &lt;files&gt;
      &lt;location&gt;extendedMeasurementOrFact.csv&lt;/location&gt;
    &lt;/files&gt;
    &lt;coreid index="0" /&gt;
    &lt;field index="1" term="http://rs.tdwg.org/dwc/terms/occurrenceID"/&gt;
    &lt;field index="2" term="http://rs.tdwg.org/dwc/terms/measurementID"/&gt;
    &lt;field index="3" term="http://rs.tdwg.org/dwc/terms/measurementType"/&gt;
    &lt;field index="4" term="http://rs.iobis.org/obis/terms/measurementTypeID"/&gt;
    &lt;field index="5" term="http://rs.tdwg.org/dwc/terms/measurementValue"/&gt;
    &lt;field index="6" term="http://rs.tdwg.org/dwc/terms/measurementUnit"/&gt;
    &lt;field index="7" term="http://rs.iobis.org/obis/terms/measurementUnitID"/&gt;
    &lt;field index="8" term="http://rs.tdwg.org/dwc/terms/measurementMethod"/&gt;
    &lt;field index="9" term="http://rs.tdwg.org/dwc/terms/measurementRemarks"/&gt;
    &lt;field index="10" term="http://rs.iobis.org/obis/terms/measurementValueID"/&gt;
  &lt;/extension&gt;
&lt;/archive&gt;</code></pre>
</div>
</div>
</section>
<section id="create-eml-metadata" class="level2" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="create-eml-metadata"><span class="header-section-number">11</span> Create EML Metadata</h2>
<p>Build EML (Ecological Metadata Language) document with geographic, temporal, and taxonomic coverage:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Geographic coverage</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>geo_coverage <span class="ot">&lt;-</span> tbl_site <span class="sc">|&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">westBoundingCoordinate =</span> <span class="fu">min</span>(longitude, <span class="at">na.rm =</span> T),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">eastBoundingCoordinate =</span> <span class="fu">max</span>(longitude, <span class="at">na.rm =</span> T),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">northBoundingCoordinate =</span> <span class="fu">max</span>(latitude, <span class="at">na.rm =</span> T),</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">southBoundingCoordinate =</span> <span class="fu">min</span>(latitude, <span class="at">na.rm =</span> T)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Temporal coverage</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>temp_coverage <span class="ot">&lt;-</span> tbl_tow <span class="sc">|&gt;</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">beginDate =</span> <span class="fu">min</span>(time_start, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">endDate =</span> <span class="fu">max</span>(time_start, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"name"</span>,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"value"</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> <span class="fu">as.Date</span>(value)</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">deframe</span>() <span class="sc">|&gt;</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.list</span>()</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Taxonomic coverage</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(duckdb)</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="st">"https://file.calcofi.io/data/calcofi.duckdb"</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>tmp_db <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">tempdir</span>(), <span class="st">"calcofi.duckdb"</span>)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>con_dk <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(duckdb<span class="sc">::</span><span class="fu">duckdb</span>(), <span class="at">dbdir =</span> tmp_db, <span class="at">read_only =</span> F)</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="co"># attach remote duckdb database</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="fu">dbSendQuery</span>(con_dk, glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"ATTACH DATABASE '{db}' AS cc;"</span>))</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="co"># dbListTables(con)</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a><span class="co">#  [1] "bottle"         "cast"           "cruise"         "egg"            "egg_stage"      "grid"</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a><span class="co">#  [7] "larva"          "larva_size"     "larva_stage"    "net"            "schema_version" "ship"</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a><span class="co"># [13] "site"           "site_seg"       "species"        "taxa_rank"      "taxonomy"       "tow"</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a><span class="co"># [19] "tow_type"</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>d_taxa <span class="ot">&lt;-</span> <span class="fu">dbReadTable</span>(con_dk, <span class="fu">Id</span>(<span class="at">schema =</span> <span class="st">"cc"</span>, <span class="at">table =</span> <span class="st">"taxonomy"</span>))</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>taxa_coverage <span class="ot">&lt;-</span> tbl_species <span class="sc">|&gt;</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(worms_id)) <span class="sc">|&gt;</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(species_id, worms_id, common_name) <span class="sc">|&gt;</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>    d_taxa <span class="sc">|&gt;</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>        taxonID,</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>        taxonRank,</span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>        scientificName</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">join_by</span>(worms_id <span class="sc">==</span> taxonID)</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># De-duplicate in case multiple local species map to same WoRMS ID</span></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(worms_id, taxonRank, scientificName) <span class="sc">|&gt;</span></span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_id =</span> <span class="fu">first</span>(species_id),</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">common_name =</span> <span class="fu">paste</span>(<span class="fu">unique</span>(<span class="fu">na.omit</span>(common_name)), <span class="at">collapse =</span> <span class="st">", "</span>),</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(species_id) <span class="sc">|&gt;</span></span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pmap</span>(<span class="cf">function</span>(</span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>    species_id,</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>    taxonRank,</span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>    scientificName,</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>    common_name,</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>    worms_id,</span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>  ) {</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>    item <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">id =</span> <span class="fu">glue</span>(<span class="st">"calcofi_species_{species_id}"</span>),</span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxonRankName =</span> taxonRank,</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxonRankValue =</span> scientificName,</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxonId =</span> <span class="fu">list</span>(</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>        <span class="at">provider =</span> <span class="st">"https://www.marinespecies.org"</span>,</span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.character</span>(worms_id)</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(common_name) <span class="sc">&amp;&amp;</span> common_name <span class="sc">!=</span> <span class="st">""</span>) {</span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>      item<span class="sc">$</span>commonName <span class="ot">&lt;-</span> common_name</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(item)</span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a><span class="co"># Create EML document</span></span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>my_eml <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a>  <span class="at">packageId =</span> dataset_id,</span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a>  <span class="at">system =</span> <span class="st">"calcofi.io"</span>,</span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="fu">list</span>(</span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> dataset_title,</span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">creator =</span> <span class="fu">list</span>(</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>      <span class="at">individualName =</span> <span class="fu">list</span>(</span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>        <span class="at">givenName =</span> <span class="st">"Ed"</span>,</span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a>        <span class="at">surName =</span> <span class="st">"Weber"</span></span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a>      <span class="at">organizationName =</span> <span class="st">"NOAA SWFSC"</span>,</span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a>      <span class="at">electronicMailAddress =</span> <span class="st">"ed.weber@noaa.gov"</span>,</span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a>      <span class="at">userId =</span> <span class="fu">list</span>(</span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a>        <span class="at">directory =</span> <span class="st">"https://orcid.org/"</span>,</span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a>        <span class="at">userId =</span> <span class="st">"0000-0002-0942-434X"</span></span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">abstract =</span> dataset_abstract,</span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">keywordSet =</span> <span class="fu">list</span>(</span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a>      <span class="at">keyword =</span> dataset_keywords,</span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a>      <span class="at">keywordThesaurus =</span> <span class="st">"GCMD Science Keywords"</span></span>
<span id="cb13-112"><a href="#cb13-112" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb13-113"><a href="#cb13-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">coverage =</span> <span class="fu">list</span>(</span>
<span id="cb13-114"><a href="#cb13-114" aria-hidden="true" tabindex="-1"></a>      <span class="at">geographicCoverage =</span> <span class="fu">list</span>(</span>
<span id="cb13-115"><a href="#cb13-115" aria-hidden="true" tabindex="-1"></a>        <span class="at">geographicDescription =</span> <span class="st">"California Current Large Marine Ecoregion"</span>,</span>
<span id="cb13-116"><a href="#cb13-116" aria-hidden="true" tabindex="-1"></a>        <span class="at">boundingCoordinates =</span> geo_coverage</span>
<span id="cb13-117"><a href="#cb13-117" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb13-118"><a href="#cb13-118" aria-hidden="true" tabindex="-1"></a>      <span class="at">temporalCoverage =</span> <span class="fu">list</span>(</span>
<span id="cb13-119"><a href="#cb13-119" aria-hidden="true" tabindex="-1"></a>        <span class="at">rangeOfDates =</span> <span class="fu">list</span>(</span>
<span id="cb13-120"><a href="#cb13-120" aria-hidden="true" tabindex="-1"></a>          <span class="at">beginDate =</span> <span class="fu">list</span>(</span>
<span id="cb13-121"><a href="#cb13-121" aria-hidden="true" tabindex="-1"></a>            <span class="at">calendarDate =</span> <span class="fu">as.character</span>(temp_coverage<span class="sc">$</span>beginDate)</span>
<span id="cb13-122"><a href="#cb13-122" aria-hidden="true" tabindex="-1"></a>          ),</span>
<span id="cb13-123"><a href="#cb13-123" aria-hidden="true" tabindex="-1"></a>          <span class="at">endDate =</span> <span class="fu">list</span>(<span class="at">calendarDate =</span> <span class="fu">as.character</span>(temp_coverage<span class="sc">$</span>endDate))</span>
<span id="cb13-124"><a href="#cb13-124" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-125"><a href="#cb13-125" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb13-126"><a href="#cb13-126" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxonomicCoverage =</span> <span class="fu">list</span>(</span>
<span id="cb13-127"><a href="#cb13-127" aria-hidden="true" tabindex="-1"></a>        <span class="at">generalTaxonomicCoverage =</span> <span class="st">"Marine ichthyoplankton and fish eggs"</span>,</span>
<span id="cb13-128"><a href="#cb13-128" aria-hidden="true" tabindex="-1"></a>        <span class="at">taxonomicClassification =</span> taxa_coverage</span>
<span id="cb13-129"><a href="#cb13-129" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb13-130"><a href="#cb13-130" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb13-131"><a href="#cb13-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">contact =</span> <span class="fu">list</span>(</span>
<span id="cb13-132"><a href="#cb13-132" aria-hidden="true" tabindex="-1"></a>      <span class="at">individualName =</span> <span class="fu">list</span>(</span>
<span id="cb13-133"><a href="#cb13-133" aria-hidden="true" tabindex="-1"></a>        <span class="at">givenName =</span> <span class="st">"Ed"</span>,</span>
<span id="cb13-134"><a href="#cb13-134" aria-hidden="true" tabindex="-1"></a>        <span class="at">surName =</span> <span class="st">"Weber"</span></span>
<span id="cb13-135"><a href="#cb13-135" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb13-136"><a href="#cb13-136" aria-hidden="true" tabindex="-1"></a>      <span class="at">electronicMailAddress =</span> <span class="st">"ed.weber@noaa.gov"</span></span>
<span id="cb13-137"><a href="#cb13-137" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb13-138"><a href="#cb13-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">methods =</span> <span class="fu">list</span>(</span>
<span id="cb13-139"><a href="#cb13-139" aria-hidden="true" tabindex="-1"></a>      <span class="at">methodStep =</span> <span class="fu">list</span>(</span>
<span id="cb13-140"><a href="#cb13-140" aria-hidden="true" tabindex="-1"></a>        <span class="at">description =</span> <span class="fu">list</span>(</span>
<span id="cb13-141"><a href="#cb13-141" aria-hidden="true" tabindex="-1"></a>          <span class="at">para =</span> sampling_methods_description</span>
<span id="cb13-142"><a href="#cb13-142" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-143"><a href="#cb13-143" aria-hidden="true" tabindex="-1"></a>      ), <span class="co"># </span><span class="al">TODO</span><span class="co">: sampling methods</span></span>
<span id="cb13-144"><a href="#cb13-144" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampling =</span> <span class="fu">list</span>(</span>
<span id="cb13-145"><a href="#cb13-145" aria-hidden="true" tabindex="-1"></a>        <span class="at">studyExtent =</span> <span class="fu">list</span>(</span>
<span id="cb13-146"><a href="#cb13-146" aria-hidden="true" tabindex="-1"></a>          <span class="at">description =</span> <span class="fu">list</span>(</span>
<span id="cb13-147"><a href="#cb13-147" aria-hidden="true" tabindex="-1"></a>            <span class="at">para =</span> study_extent_description</span>
<span id="cb13-148"><a href="#cb13-148" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb13-149"><a href="#cb13-149" aria-hidden="true" tabindex="-1"></a>        ), <span class="co"># </span><span class="al">TODO</span><span class="co">: study extent</span></span>
<span id="cb13-150"><a href="#cb13-150" aria-hidden="true" tabindex="-1"></a>        <span class="at">samplingDescription =</span> <span class="fu">list</span>(</span>
<span id="cb13-151"><a href="#cb13-151" aria-hidden="true" tabindex="-1"></a>          <span class="at">para =</span> sampling_description</span>
<span id="cb13-152"><a href="#cb13-152" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-153"><a href="#cb13-153" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb13-154"><a href="#cb13-154" aria-hidden="true" tabindex="-1"></a>    ), <span class="co"># </span><span class="al">TODO</span><span class="co">: sampling</span></span>
<span id="cb13-155"><a href="#cb13-155" aria-hidden="true" tabindex="-1"></a>    <span class="at">project =</span> <span class="fu">list</span>(</span>
<span id="cb13-156"><a href="#cb13-156" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> dataset_title, <span class="co"># </span><span class="al">TODO</span><span class="co">: project title?</span></span>
<span id="cb13-157"><a href="#cb13-157" aria-hidden="true" tabindex="-1"></a>      <span class="at">personnel =</span> <span class="fu">list</span>(</span>
<span id="cb13-158"><a href="#cb13-158" aria-hidden="true" tabindex="-1"></a>        <span class="at">individualName =</span> <span class="fu">list</span>(</span>
<span id="cb13-159"><a href="#cb13-159" aria-hidden="true" tabindex="-1"></a>          <span class="at">givenName =</span> <span class="st">"Ed"</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: PI?</span></span>
<span id="cb13-160"><a href="#cb13-160" aria-hidden="true" tabindex="-1"></a>          <span class="at">surName =</span> <span class="st">"Weber"</span></span>
<span id="cb13-161"><a href="#cb13-161" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb13-162"><a href="#cb13-162" aria-hidden="true" tabindex="-1"></a>        <span class="at">role =</span> <span class="st">"Principal Investigator"</span></span>
<span id="cb13-163"><a href="#cb13-163" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb13-164"><a href="#cb13-164" aria-hidden="true" tabindex="-1"></a>      <span class="at">funding =</span> <span class="fu">list</span>(</span>
<span id="cb13-165"><a href="#cb13-165" aria-hidden="true" tabindex="-1"></a>        <span class="at">para =</span> funding_information</span>
<span id="cb13-166"><a href="#cb13-166" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb13-167"><a href="#cb13-167" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-168"><a href="#cb13-168" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-169"><a href="#cb13-169" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-170"><a href="#cb13-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-171"><a href="#cb13-171" aria-hidden="true" tabindex="-1"></a>eml_xml <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{dir_out}/eml.xml"</span>)</span>
<span id="cb13-172"><a href="#cb13-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-173"><a href="#cb13-173" aria-hidden="true" tabindex="-1"></a><span class="co"># my_eml &lt;- EML::read_eml(eml_xml)</span></span>
<span id="cb13-174"><a href="#cb13-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-175"><a href="#cb13-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Validate EML before writing</span></span>
<span id="cb13-176"><a href="#cb13-176" aria-hidden="true" tabindex="-1"></a>validation_result <span class="ot">&lt;-</span> <span class="fu">eml_validate</span>(my_eml)</span>
<span id="cb13-177"><a href="#cb13-177" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>validation_result) {</span>
<span id="cb13-178"><a href="#cb13-178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"EML validation errors:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb13-179"><a href="#cb13-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">attr</span>(validation_result, <span class="st">"errors"</span>))</span>
<span id="cb13-180"><a href="#cb13-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>()</span>
<span id="cb13-181"><a href="#cb13-181" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb13-182"><a href="#cb13-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"EML is valid!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb13-183"><a href="#cb13-183" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>EML is valid!</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Write EML</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write_eml</span>(my_eml, eml_xml)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># browseURL(eml_xml)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="data-quality-checks" class="level2" data-number="12">
<h2 data-number="12" class="anchored" data-anchor-id="data-quality-checks"><span class="header-section-number">12</span> Data Quality Checks</h2>
<p>Validate data quality: check for missing WoRMS IDs, orphan records, and output summary statistics:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for missing WoRMS IDs</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>d_missing_worms <span class="ot">&lt;-</span> tbl_species <span class="sc">|&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(worms_id)) <span class="sc">|&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(species_id, scientific_name) <span class="sc">|&gt;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(d_missing_worms) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"WARNING: The following species are missing WoRMS IDs:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(d_missing_worms)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="sc">\n</span><span class="st">Please add WoRMS AphiaIDs for these species before finalizing the dataset.</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for orphan records</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>d_orphan_occurrences <span class="ot">&lt;-</span> q_occurrence_extension <span class="sc">|&gt;</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anti_join</span>(q_event_core, <span class="at">by =</span> <span class="st">"eventID"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(d_orphan_occurrences) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="sc">\n</span><span class="st">WARNING: Found"</span>,</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nrow</span>(d_orphan_occurrences),</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"occurrence records without matching events.</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>n_events <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>n_events <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"net_sample"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(n)</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>n_cruises <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"cruise"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(n)</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>n_sites <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"site"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(n)</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>n_tows <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"tow"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(n)</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>n_nets <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"net_sample"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(n)</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>n_occs <span class="ot">&lt;-</span> q_occurrence_extension <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>n_species <span class="ot">&lt;-</span> q_occurrence_extension <span class="sc">|&gt;</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(scientificName) <span class="sc">|&gt;</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(n)</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>n_measures <span class="ot">&lt;-</span> d_extendedmeasurementorfact_extension <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a><span class="fu">glue</span>(</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>  <span class="st">"</span></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a><span class="st">  === Dataset Summary ===</span></span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a><span class="st">  Total events:        {prettyNum(n_events, big.mark = ',')}</span></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a><span class="st">  - Cruises:           {prettyNum(n_cruises, big.mark = ',')}</span></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a><span class="st">  - Sites:             {prettyNum(n_sites, big.mark = ',')}</span></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a><span class="st">  - Tows:              {prettyNum(n_tows, big.mark = ',')}</span></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a><span class="st">  - Net samples:       {prettyNum(n_nets, big.mark = ',')}</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a><span class="st">  Total occurrences:   {prettyNum(n_occs, big.mark = ',')}</span></span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a><span class="st">  Total species:       {prettyNum(n_species, big.mark = ',')}</span></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a><span class="st">  Total measurements:  {prettyNum(n_measures, big.mark = ',')}"</span></span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>=== Dataset Summary ===
Total events:        76,512
- Cruises:           676
- Sites:             57,914
- Tows:              75,434
- Net samples:       76,512
Total occurrences:   463,655
Total species:       899
Total measurements:  610,816</code></pre>
</div>
</div>
</section>
<section id="package-creation" class="level2" data-number="13">
<h2 data-number="13" class="anchored" data-anchor-id="package-creation"><span class="header-section-number">13</span> Package Creation</h2>
<p>Create the final DarwinCore Archive as a zip file containing all CSV files, meta.xml, and eml.xml:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DwC-A zip file</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>zip_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="fu">paste0</span>(<span class="st">"../larvae_"</span>, <span class="fu">Sys.Date</span>(), <span class="st">".zip"</span>))</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">zip</span>(</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  zip_file,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">files =</span> <span class="fu">file.path</span>(</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    dir_out,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">"event.csv"</span>,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">"occurrence.csv"</span>,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">"extendedMeasurementOrFact.csv"</span>,</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">"meta.xml"</span>,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">"eml.xml"</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">flags =</span> <span class="st">"-j"</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>) <span class="co"># exclude parent folders</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Darwin Core Archive created:"</span>, zip_file, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Darwin Core Archive created: /Users/bbest/Github/CalCOFI/workflows/data/darwincore/larvae/../larvae_2026-01-08.zip </code></pre>
</div>
</div>
</section>
<section id="check-csv" class="level2" data-number="14">
<h2 data-number="14" class="anchored" data-anchor-id="check-csv"><span class="header-section-number">14</span> Check CSV</h2>
<p>Verify the exported CSV files and inspect measurement types and units:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>d_event <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">glue</span>(<span class="st">"{dir_out}/event.csv"</span>))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>d_occurrence <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">glue</span>(<span class="st">"{dir_out}/occurrence.csv"</span>))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>d_emof <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">glue</span>(<span class="st">"{dir_out}/extendedMeasurementOrFact.csv"</span>))</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co"># d_event</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co"># d_occurrence</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># d_emof</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co"># d_emof |&gt; select(measurementType, measurementUnit) |&gt; table(useNA = "ifany")</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">#                              measurementUnit</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># measurementType               dimensionless  grams individuals millimeters</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co">#   abundance by life stage                 0      0      125347           0</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   body length                             0      0           0      241871</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co">#   proportion of sample sorted         76512      0           0           0</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   small plankton biomass                  0  45287           0           0</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   standardized haul factor            76512      0           0           0</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   total plankton biomass                  0  45287           0           0</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="to-confirm-dataset-metadata" class="level2" data-number="15">
<h2 data-number="15" class="anchored" data-anchor-id="to-confirm-dataset-metadata"><span class="header-section-number">15</span> To confirm: dataset metadata</h2>
<p>Please confirm the following seem reasonable to you:</p>
<ul class="task-list">
<li><p><label><input type="checkbox">Dataset ID<br>
<code>dataset_id</code>: calcofi.io_workflow_larvae_to_obis_2026-01-08<br>
See: <a href="https://manual.obis.org/examples.html" class="uri">https://manual.obis.org/examples.html</a> -&gt; <code>datasetID</code>: <a href="https://marineinfo.org/id/dataset/6403" class="uri">https://marineinfo.org/id/dataset/6403</a></label></p></li>
<li><p><label><input type="checkbox">Dataset title<br>
<code>dataset_title</code>: CalCOFI Fish Larvae Tows<br>
</label></p></li>
<li><p><label><input type="checkbox">Dataset abstract (200-500 words describing the dataset)<br>
<code>dataset_abstract</code>: Fish larvae counts and standardized counts for eggs captured in CalCOFI icthyoplankton nets (primarily vertical [Calvet or Pairovet], oblique [bongo or ring nets], and surface tows [Manta nets]). Surface tows are normally standardized to count per 1,000 m^3 strained. Oblique tows are normally standardized to count per 10 m^2 of surface sampled.</label></p></li>
<li><p><label><input type="checkbox">Keywords (3-5 relevant keywords)<br>
<code>dataset_keywords</code>: atmosphere, biology, biosphere, calcofi, earth science, environment, latitude, longitude, ocean, time<br>
</label></p></li>
<li><p><label><input type="checkbox">Country code (ISO 3166-1 alpha-2)<br>
<code>country_code</code>: US<br>
</label></p></li>
<li><p><label><input type="checkbox">Water body name<br>
<code>water_body</code>: California Current<br>
</label></p></li>
<li><p><label><input type="checkbox">Sampling Methods Description<br>
<code>sampling_methods_description</code>: Standard CalCOFI ichthyoplankton tows. The standard oblique tow uses a bongo net (71 cm diameter, 0.505 mm mesh) or 1-m ring net (prior to 1978) retrieved at a constant wire angle (45 degrees) from 210 m depth to surface. Surface tows use a Manta net; vertical tows use CalVET/Pairovet nets. Flowmeters measure volume filtered. Samples are preserved in 5% formalin. In the lab, fish eggs and larvae are sorted, identified to lowest taxon possible, enumerated, and measured.<br>
</label></p></li>
<li><p><label><input type="checkbox">Study Extent Description<br>
<code>study_extent_description</code>: The study covers the California Current ecosystem, primarily off Southern California (standard lines 77-93) but historically extending from the border of Canada to the tip of Baja California. The time series for this dataset generally begins in 1951 and continues to the present, with quarterly cruises.<br>
</label></p></li>
<li><p><label><input type="checkbox">Sampling Description<br>
<code>sampling_description</code>: Samples are collected at fixed stations along the CalCOFI grid. Oblique tows are standardized to counts per 10 m^2 of sea surface. Surface tows are standardized to counts per 1,000 m^3. Data includes raw counts (tallies) and standardized abundances.<br>
</label></p></li>
<li><p><label><input type="checkbox">Funding Information<br>
<code>funding_information</code>: CalCOFI is a partnership between the NOAA National Marine Fisheries Service (NMFS), Scripps Institution of Oceanography (SIO), and California Department of Fish and Wildlife (CDFW).<br>
</label></p></li>
</ul>
<!-- 
## Other Checklist Items

### Personnel Information

- [ ] Dataset creator name and ORCID
- [ ] Creator organization
- [ ] Creator email
- [ ] Dataset contact name and email
- [ ] Principal investigator name

### Project Information

- [ ] Project title
- [ ] Funding information (agency and grant numbers)

### Methodology
- [ ] Detailed sampling methods description
- [ ] Study extent description
- [ ] Sampling design and protocols
- [ ] Measurement methods for environmental variables
- [ ] Size measurement methods for larvae
- [ ] Taxonomist name(s) who identified specimens
- [ ] Identification date(s)
- [ ] Identification references used

### Geographic Information
- [ ] Geographic description of the study area
- [ ] GPS accuracy (coordinate uncertainty in meters)

## Done

- [x] drop `lifeStageID` (does not exist) and make **eMoF** like ["Lifestage" in 16 Dataset Examples: ENV-DATA | The OBIS Manual](https://manual.obis.org/examples.html#:~:text=TripNR3242TripStationNR16781MidasTripActionID105598occurenceIDTA_105598_(Pseudo%2D)pediastrum_5-,Lifestage,-http%3A//vocab.nerc):

  - `measurementType`: "Lifestage"
  - `measurementTypeID`: "http://vocab.nerc.ac.uk/collection/P01/current/LSTAGE01/"
  - `measurementValue`: "adult" 
  - `measurementValueID`: "http://vocab.nerc.ac.uk/collection/S11/current/S1116/"
  - `measurementUnit`:  
  - `measurementUnitID`: 
  - `measurementDeterminedBy`: "Flanders Marine Institute"
  - `measurementMethod`: "identified and counted by image analysis and normalised to a unit volume of water body, validated by human"
-->
<!-- -->

</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Publish Larvae to OBIS"</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>This workflow converts CalCOFI ichthyoplankton (fish eggs and larvae) data to an OBIS-compliant DarwinCore Archive for publication. The archive follows the Event Core structure with Occurrence and ExtendedMeasurementOrFact (eMoF) extensions.</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>**References**: <span class="co">[</span><span class="ot">OBIS Manual</span><span class="co">](https://manual.obis.org/)</span> | <span class="co">[</span><span class="ot">DarwinCore Terms</span><span class="co">](https://dwc.tdwg.org/terms/)</span> | <span class="co">[</span><span class="ot">CalCOFI Fish Eggs &amp; Larvae</span><span class="co">](https://calcofi.org/data/marine-ecosystem-data/fish-eggs-larvae/)</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  CalCOFI <span class="sc">/</span> calcofi4db,</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  DBI,</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  dm,</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  dplyr,</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  DT,</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  EML,</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  glue,</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  here,</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>  lubridate,</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>  purrr,</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  readr,</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>  tibble,</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>  tidyr,</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>  uuid,</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">quiet =</span> T</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">readr.show_col_types =</span> F)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset metadata</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>dataset_title <span class="ot">&lt;-</span> <span class="st">"CalCOFI Fish Larvae Tows"</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>dataset_abstract <span class="ot">&lt;-</span> <span class="st">"Fish larvae counts and standardized counts for eggs captured in CalCOFI icthyoplankton nets (primarily vertical [Calvet or Pairovet], oblique [bongo or ring nets], and surface tows [Manta nets]). Surface tows are normally standardized to count per 1,000 m^3 strained. Oblique tows are normally standardized to count per 10 m^2 of surface sampled."</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>dataset_keywords <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>  <span class="st">"atmosphere"</span>,</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>  <span class="st">"biology"</span>,</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>  <span class="st">"biosphere"</span>,</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>  <span class="st">"calcofi"</span>,</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>  <span class="st">"earth science"</span>,</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>  <span class="st">"environment"</span>,</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>  <span class="st">"latitude"</span>,</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>  <span class="st">"longitude"</span>,</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ocean"</span>,</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>  <span class="st">"time"</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>) <span class="co"># GCMD Science Keywords (source: https://catalog.data.gov/dataset/calcofi-larvae-counts-positive-tows)</span></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a><span class="co"># dataset_uuid &lt;- UUIDgenerate() # Or use existing dataset UUID</span></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>country_code <span class="ot">&lt;-</span> <span class="st">"US"</span></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>water_body <span class="ot">&lt;-</span> <span class="st">"California Current"</span> <span class="co"># LME: http://marineregions.org/mrgid/8549</span></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>dataset_id <span class="ot">&lt;-</span> <span class="fu">glue</span>(</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>  <span class="st">"calcofi.io_workflow_larvae_to_obis_{format(Sys.Date(), '%Y-%m-%d')}"</span></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>sampling_methods_description <span class="ot">&lt;-</span> <span class="st">"Standard CalCOFI ichthyoplankton tows. The standard oblique tow uses a bongo net (71 cm diameter, 0.505 mm mesh) or 1-m ring net (prior to 1978) retrieved at a constant wire angle (45 degrees) from 210 m depth to surface. Surface tows use a Manta net; vertical tows use CalVET/Pairovet nets. Flowmeters measure volume filtered. Samples are preserved in 5% formalin. In the lab, fish eggs and larvae are sorted, identified to lowest taxon possible, enumerated, and measured."</span></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>study_extent_description <span class="ot">&lt;-</span> <span class="st">"The study covers the California Current ecosystem, primarily off Southern California (standard lines 77-93) but historically extending from the border of Canada to the tip of Baja California. The time series for this dataset generally begins in 1951 and continues to the present, with quarterly cruises."</span></span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>sampling_description <span class="ot">&lt;-</span> <span class="st">"Samples are collected at fixed stations along the CalCOFI grid. Oblique tows are standardized to counts per 10 m^2 of sea surface. Surface tows are standardized to counts per 1,000 m^3. Data includes raw counts (tallies) and standardized abundances."</span></span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>funding_information <span class="ot">&lt;-</span> <span class="st">"CalCOFI is a partnership between the NOAA National Marine Fisheries Service (NMFS), Scripps Institution of Oceanography (SIO), and California Department of Fish and Wildlife (CDFW)."</span></span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>dir_out <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/darwincore/larvae"</span>)</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a><span class="co"># get database connection</span></span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>schema <span class="ot">&lt;-</span> <span class="st">"dev"</span></span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">get_db_con</span>(schema)</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a><span class="fu">## Database Schema</span></span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>The CalCOFI database organizes ichthyoplankton data hierarchically: cruises contain sites, sites contain tows, and tows contain net samples. Biological observations (eggs, larvae) link to net samples via <span class="in">`net_uuid`</span>.</span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-dm_tbls</span></span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Entity relationship diagram (ERD) of the CalCOFI database."</span></span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a><span class="co"># exclude experimental tables</span></span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>tbls <span class="ot">&lt;-</span> <span class="fu">dbListTables</span>(con) <span class="sc">|&gt;</span></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sort</span>() <span class="sc">|&gt;</span></span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setdiff</span>(</span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"schema_version"</span>, <span class="st">"grid"</span>, <span class="st">"site_seg"</span>, <span class="st">"bottle"</span>, <span class="st">"cast"</span>)</span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a><span class="co"># learn relations from database and draw</span></span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>dm <span class="ot">&lt;-</span> <span class="fu">dm_from_con</span>(con, <span class="at">schema =</span> schema, <span class="at">table_names =</span> tbls, <span class="at">learn_keys =</span> T)</span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_draw</span>(dm, <span class="at">view_type =</span> <span class="st">"all"</span>)</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>%%| label: fig-calcofi_erd</span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>%%| fig-cap: <span class="ot">"</span><span class="st">Entity relationship diagram (ERD) of the CalCOFI database. Created from image above and prompt to [Claude](https://claude.ai/): 'Generate an ERD mermaid diagram from the image.'</span><span class="ot">"</span></span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a>%%| file: diagrams/calcofi_erd.mmd</span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a><span class="fu">## Life Stage Reference</span></span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a>Egg development stages follow <span class="co">[</span><span class="ot">Moser &amp; Ahlstrom (1985)</span><span class="co">](https://repository.library.noaa.gov/view/noaa/5695/noaa_5695_DS1.pdf)</span>. Larva stages include: yolk sac, preflexion, flexion, postflexion, and transformation.</span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a><span class="fu">## Egg Stage Descriptions (Moser &amp; Ahlstrom, 1985)</span></span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage I</span></span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a>Cell division has not yet begun. In intact eggs the cytoplasm of the</span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a>single cell appears as a clear hemisphere at one pole, easily dif-</span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a>ferentiated from the yolk mass which is divided into granules. The</span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a>cytoplasm may be displaced to other locations around the periphery</span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a>of the yolk mass, but there is usually some accumulation at one pole,</span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a>which allows the stage to be identified.</span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage II</span></span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a>This begins with the division of the single cell into two cells or</span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a>blastomeres. The division is first noticeable when a furrow develops</span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a>in the middle of the cytoplasmic cap. Small bubble-like structures</span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a>(probably artifacts) are often visible along the furrow and help iden-</span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a>tify it. The next cleavage plane is at right angles to the first, and</span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a>subsequent synchronous divisions in both meridional and latitudinal</span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a>planes produce a hemispherical mound of cells, termed the blasto-</span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a>disc. After the 5th or 6th division, the blastodisc has a berry-like</span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a>appearance, the so-called "mulberry stage," and with subsequent</span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a>divisions the blastomeres become increasingly smaller and more</span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a>difficult to distinguish individually. During a certain phase of the</span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a>early divisions the blastomeres are about the same size as the yolk</span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a>granules. Ifthe blastodisc and yolk mass become disrupted during</span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a>collection or preservation, the blastomeres may become distributed</span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a>among the yolk granules. They may be distinguished from one</span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a>another since they have different refractive indices and the</span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a>blastomeres appear darker when viewed with transmitted light.</span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage III</span></span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a>Ahlstrom (1943) defined this stage in sardine eggs as beginning with</span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a>the appearance of the segmentation cavity. The segmentation cavity</span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a>of teleost eggs is the space formed between the blastodisc and the</span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a>yolk mass during late cleavage. In most anchovy eggs in our collec-</span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a>tions the blastodisc is shrunken and somewhat cup-shaped and con-</span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a>sequently the segmentation cavity, which is a delicate structure, is</span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true" tabindex="-1"></a>obliterated. We have found it preferable to define the beginning of</span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true" tabindex="-1"></a>Stage ill on the basis of the appearance of the blastoderm, i.e., when</span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true" tabindex="-1"></a>it has the appearance of tissue rather than of a collection of individual</span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true" tabindex="-1"></a>cells. This stage marks the beginning of gastrulation. The margin</span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true" tabindex="-1"></a>of the blastodisc becomes slightly thickened and is termed the germ</span>
<span id="cb21-147"><a href="#cb21-147" aria-hidden="true" tabindex="-1"></a>ring. At one region of the germ ring the thickening extends inward</span>
<span id="cb21-148"><a href="#cb21-148" aria-hidden="true" tabindex="-1"></a>to form the embryonic shield, which defines the future axis of the</span>
<span id="cb21-149"><a href="#cb21-149" aria-hidden="true" tabindex="-1"></a>embryo. Gastrulation proceeds by further proliferation and downward</span>
<span id="cb21-150"><a href="#cb21-150" aria-hidden="true" tabindex="-1"></a>movement of cells in the region of the germ ring by a process known</span>
<span id="cb21-151"><a href="#cb21-151" aria-hidden="true" tabindex="-1"></a>as epiboly. Simultaneously, proliferation and inward migration (em-</span>
<span id="cb21-152"><a href="#cb21-152" aria-hidden="true" tabindex="-1"></a>boly) of cells from the margin of the embryonic shield produce the</span>
<span id="cb21-153"><a href="#cb21-153" aria-hidden="true" tabindex="-1"></a>organ-forming cell layers of the primordial embryo. At the end of</span>
<span id="cb21-154"><a href="#cb21-154" aria-hidden="true" tabindex="-1"></a>Stage III the germ ring is one-third down the yolk mass and the</span>
<span id="cb21-155"><a href="#cb21-155" aria-hidden="true" tabindex="-1"></a>bilateral nature of the primordial embryo is apparent.</span>
<span id="cb21-156"><a href="#cb21-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-157"><a href="#cb21-157" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage IV</span></span>
<span id="cb21-158"><a href="#cb21-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-159"><a href="#cb21-159" aria-hidden="true" tabindex="-1"></a>At the beginning of this stage the germ ring has enclosed one-third</span>
<span id="cb21-160"><a href="#cb21-160" aria-hidden="true" tabindex="-1"></a>of the yolk mass and the embryo is beginning to form along the</span>
<span id="cb21-161"><a href="#cb21-161" aria-hidden="true" tabindex="-1"></a>median region of the embryonic shield. At the end of this stage,</span>
<span id="cb21-162"><a href="#cb21-162" aria-hidden="true" tabindex="-1"></a>defined by the germ ring enveloping two-thirds of the yolk, the head</span>
<span id="cb21-163"><a href="#cb21-163" aria-hidden="true" tabindex="-1"></a>region of the embryo is becoming apparent.</span>
<span id="cb21-164"><a href="#cb21-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-165"><a href="#cb21-165" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage V</span></span>
<span id="cb21-166"><a href="#cb21-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-167"><a href="#cb21-167" aria-hidden="true" tabindex="-1"></a>This stage begins with the germ ring two-thirds down the yolk and</span>
<span id="cb21-168"><a href="#cb21-168" aria-hidden="true" tabindex="-1"></a>ends with the closure of the blastopore and the complete enclosure</span>
<span id="cb21-169"><a href="#cb21-169" aria-hidden="true" tabindex="-1"></a>of the yolk by the cellular sheath of the embryo. The stage is charac-</span>
<span id="cb21-170"><a href="#cb21-170" aria-hidden="true" tabindex="-1"></a>terized by rapid differentiation resulting in the formation of several</span>
<span id="cb21-171"><a href="#cb21-171" aria-hidden="true" tabindex="-1"></a>somites in the midregion of the embryonic axis, development of the</span>
<span id="cb21-172"><a href="#cb21-172" aria-hidden="true" tabindex="-1"></a>notochord which can be seen from a dorsal viewpoint, and differ-</span>
<span id="cb21-173"><a href="#cb21-173" aria-hidden="true" tabindex="-1"></a>entiation of the optic vesicles from the brain.</span>
<span id="cb21-174"><a href="#cb21-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-175"><a href="#cb21-175" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage VI</span></span>
<span id="cb21-176"><a href="#cb21-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-177"><a href="#cb21-177" aria-hidden="true" tabindex="-1"></a>This stage begins with the closure of the blastopore and ends when</span>
<span id="cb21-178"><a href="#cb21-178" aria-hidden="true" tabindex="-1"></a>the tail starts to separate from the yolk mass. The embryonic sheath</span>
<span id="cb21-179"><a href="#cb21-179" aria-hidden="true" tabindex="-1"></a>of cells is extremely thin and, in some samples, it may be difficult</span>
<span id="cb21-180"><a href="#cb21-180" aria-hidden="true" tabindex="-1"></a>to determine the point of blastopore closure. In these cases the event</span>
<span id="cb21-181"><a href="#cb21-181" aria-hidden="true" tabindex="-1"></a>can be estimated from the position of the caudal terminus of the</span>
<span id="cb21-182"><a href="#cb21-182" aria-hidden="true" tabindex="-1"></a>embryonic axis, since it grows toward the pole with the edge of the</span>
<span id="cb21-183"><a href="#cb21-183" aria-hidden="true" tabindex="-1"></a>cellular sheath. Initially the caudal region lies flat against the polar</span>
<span id="cb21-184"><a href="#cb21-184" aria-hidden="true" tabindex="-1"></a>region of the yolk, then gradually thickens and becomes more round-</span>
<span id="cb21-185"><a href="#cb21-185" aria-hidden="true" tabindex="-1"></a>ed at the tip until it is clearly separate from the yolk. During this</span>
<span id="cb21-186"><a href="#cb21-186" aria-hidden="true" tabindex="-1"></a>stage the somites are apparent along the entire body axis (except</span>
<span id="cb21-187"><a href="#cb21-187" aria-hidden="true" tabindex="-1"></a>at the caudal portion), the lens primordium appears in the eye, and</span>
<span id="cb21-188"><a href="#cb21-188" aria-hidden="true" tabindex="-1"></a>the regions of the brain begin to differentiate.</span>
<span id="cb21-189"><a href="#cb21-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-190"><a href="#cb21-190" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage VII</span></span>
<span id="cb21-191"><a href="#cb21-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-192"><a href="#cb21-192" aria-hidden="true" tabindex="-1"></a>At the beginning of this stage the tip of the tail free from the yolk</span>
<span id="cb21-193"><a href="#cb21-193" aria-hidden="true" tabindex="-1"></a>is broadly rounded, then begins to narrow as it elongates. The noto-</span>
<span id="cb21-194"><a href="#cb21-194" aria-hidden="true" tabindex="-1"></a>chord extends almost to the tip and the finfold is just becoming visi-</span>
<span id="cb21-195"><a href="#cb21-195" aria-hidden="true" tabindex="-1"></a>ble. At the end of this stage the length of the free tail is one-half</span>
<span id="cb21-196"><a href="#cb21-196" aria-hidden="true" tabindex="-1"></a>the length of the head. For this purpose, head length is considered</span>
<span id="cb21-197"><a href="#cb21-197" aria-hidden="true" tabindex="-1"></a>the distance from the tip of the snout to the back of the cerebellum</span>
<span id="cb21-198"><a href="#cb21-198" aria-hidden="true" tabindex="-1"></a>(see Fig. 2H). Relative tail length is the criterion for each remain-</span>
<span id="cb21-199"><a href="#cb21-199" aria-hidden="true" tabindex="-1"></a>ing stage.</span>
<span id="cb21-200"><a href="#cb21-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-201"><a href="#cb21-201" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage VIII</span></span>
<span id="cb21-202"><a href="#cb21-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-203"><a href="#cb21-203" aria-hidden="true" tabindex="-1"></a>This stage begins when the free tail length is l:,reater than one-half</span>
<span id="cb21-204"><a href="#cb21-204" aria-hidden="true" tabindex="-1"></a>the head length and ends when tail length equals head length. The</span>
<span id="cb21-205"><a href="#cb21-205" aria-hidden="true" tabindex="-1"></a>tail becomes pointed during this stage and begins to bend away from</span>
<span id="cb21-206"><a href="#cb21-206" aria-hidden="true" tabindex="-1"></a>the axis of the body, to the right or left side. The curvature of the</span>
<span id="cb21-207"><a href="#cb21-207" aria-hidden="true" tabindex="-1"></a>tail generally increases with development, but is subject to individual</span>
<span id="cb21-208"><a href="#cb21-208" aria-hidden="true" tabindex="-1"></a>variability (Fig. 2). Judgement is required in compensating for curva-</span>
<span id="cb21-209"><a href="#cb21-209" aria-hidden="true" tabindex="-1"></a>ture in estimating relative tail length; however, accuracy and preci-</span>
<span id="cb21-210"><a href="#cb21-210" aria-hidden="true" tabindex="-1"></a>sion increase rapidly with practice.</span>
<span id="cb21-211"><a href="#cb21-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-212"><a href="#cb21-212" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage IX</span></span>
<span id="cb21-213"><a href="#cb21-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-214"><a href="#cb21-214" aria-hidden="true" tabindex="-1"></a>This stage begins with the tail extending one-quarter the length of</span>
<span id="cb21-215"><a href="#cb21-215" aria-hidden="true" tabindex="-1"></a>the yolk sac and ends when it reaches one-half the yolk sac length.</span>
<span id="cb21-216"><a href="#cb21-216" aria-hidden="true" tabindex="-1"></a>The gut is now apparent along the ventral surface of the tail, and</span>
<span id="cb21-217"><a href="#cb21-217" aria-hidden="true" tabindex="-1"></a>its terminal section passes through the fin fold which is now con-</span>
<span id="cb21-218"><a href="#cb21-218" aria-hidden="true" tabindex="-1"></a>siderably wider than in the previous stage. The pectoral fin buds</span>
<span id="cb21-219"><a href="#cb21-219" aria-hidden="true" tabindex="-1"></a>appear as lateral thickenings as do the otic vesicles.</span>
<span id="cb21-220"><a href="#cb21-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-221"><a href="#cb21-221" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage X</span></span>
<span id="cb21-222"><a href="#cb21-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-223"><a href="#cb21-223" aria-hidden="true" tabindex="-1"></a>This stage starts when the tail is one-half the length of the yolk sac</span>
<span id="cb21-224"><a href="#cb21-224" aria-hidden="true" tabindex="-1"></a>and ends when it reaches three-quarters of the yolk sac length.</span>
<span id="cb21-225"><a href="#cb21-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-226"><a href="#cb21-226" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage XI</span></span>
<span id="cb21-227"><a href="#cb21-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-228"><a href="#cb21-228" aria-hidden="true" tabindex="-1"></a>This is the final stage before hatching and is defined by a tail length</span>
<span id="cb21-229"><a href="#cb21-229" aria-hidden="true" tabindex="-1"></a>greater than three-quarters of the length of the yolk sac.</span>
<span id="cb21-230"><a href="#cb21-230" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb21-231"><a href="#cb21-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-232"><a href="#cb21-232" aria-hidden="true" tabindex="-1"></a>::: {.callout-note collapse="true"}</span>
<span id="cb21-233"><a href="#cb21-233" aria-hidden="true" tabindex="-1"></a><span class="fu">## Larva Stage Descriptions</span></span>
<span id="cb21-234"><a href="#cb21-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-235"><a href="#cb21-235" aria-hidden="true" tabindex="-1"></a>Developmental stages of fish larvae captured in CalCOFI ichthyoplankton nets:</span>
<span id="cb21-236"><a href="#cb21-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-237"><a href="#cb21-237" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**YOLK**: Yolk-sac larva - newly hatched, still absorbing yolk</span>
<span id="cb21-238"><a href="#cb21-238" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**PREF**: Preflexion larva - notochord straight, before flexion</span>
<span id="cb21-239"><a href="#cb21-239" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**FLEX**: Flexion larva - notochord flexing upward</span>
<span id="cb21-240"><a href="#cb21-240" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**POST**: Postflexion larva - notochord flexion complete</span>
<span id="cb21-241"><a href="#cb21-241" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**TRNS**: Transformation stage - transitioning to juvenile</span>
<span id="cb21-242"><a href="#cb21-242" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb21-243"><a href="#cb21-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-244"><a href="#cb21-244" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conversion Design Decisions</span></span>
<span id="cb21-245"><a href="#cb21-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-246"><a href="#cb21-246" aria-hidden="true" tabindex="-1"></a>Key design decisions for converting CalCOFI ichthyoplankton data to DarwinCore:</span>
<span id="cb21-247"><a href="#cb21-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-248"><a href="#cb21-248" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Event hierarchy**: cruise → site → tow → net (following OBIS sampling-event model)</span>
<span id="cb21-249"><a href="#cb21-249" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Occurrence consolidation**: One occurrence per life stage (egg or larva) per species per net sample, rather than separate occurrences for each developmental stage</span>
<span id="cb21-250"><a href="#cb21-250" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**ExtendedMeasurementOrFact (eMoF)**: Stage-specific counts, body lengths, and sample-level measurements linked via <span class="in">`occurrenceID`</span> or <span class="in">`eventID`</span></span>
<span id="cb21-251"><a href="#cb21-251" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Vocabulary mappings**: S11 for life stages, P06 for units, custom descriptive terms for CalCOFI-specific developmental stages</span>
<span id="cb21-252"><a href="#cb21-252" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Sample size**: <span class="in">`vol_sampled_m3`</span> stored as <span class="in">`sampleSizeValue`</span> in Event core (not in eMoF)</span>
<span id="cb21-253"><a href="#cb21-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-254"><a href="#cb21-254" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Extraction from Database</span></span>
<span id="cb21-255"><a href="#cb21-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-256"><a href="#cb21-256" aria-hidden="true" tabindex="-1"></a>First, let's extract all necessary tables from the database:</span>
<span id="cb21-257"><a href="#cb21-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-260"><a href="#cb21-260" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-261"><a href="#cb21-261" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: extract-tables</span></span>
<span id="cb21-262"><a href="#cb21-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-263"><a href="#cb21-263" aria-hidden="true" tabindex="-1"></a><span class="co"># Get simple lazy table references</span></span>
<span id="cb21-264"><a href="#cb21-264" aria-hidden="true" tabindex="-1"></a>tbl_ship <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"ship"</span>)</span>
<span id="cb21-265"><a href="#cb21-265" aria-hidden="true" tabindex="-1"></a>tbl_cruise <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"cruise"</span>)</span>
<span id="cb21-266"><a href="#cb21-266" aria-hidden="true" tabindex="-1"></a>tbl_site <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"site"</span>)</span>
<span id="cb21-267"><a href="#cb21-267" aria-hidden="true" tabindex="-1"></a>tbl_tow <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"tow"</span>)</span>
<span id="cb21-268"><a href="#cb21-268" aria-hidden="true" tabindex="-1"></a>tbl_tow_type <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"tow_type"</span>)</span>
<span id="cb21-269"><a href="#cb21-269" aria-hidden="true" tabindex="-1"></a>tbl_net <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"net"</span>)</span>
<span id="cb21-270"><a href="#cb21-270" aria-hidden="true" tabindex="-1"></a>tbl_species <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"species"</span>)</span>
<span id="cb21-271"><a href="#cb21-271" aria-hidden="true" tabindex="-1"></a><span class="co"># biological observation tables</span></span>
<span id="cb21-272"><a href="#cb21-272" aria-hidden="true" tabindex="-1"></a>tbl_egg <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"egg"</span>)</span>
<span id="cb21-273"><a href="#cb21-273" aria-hidden="true" tabindex="-1"></a>tbl_egg_stage <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"egg_stage"</span>)</span>
<span id="cb21-274"><a href="#cb21-274" aria-hidden="true" tabindex="-1"></a>tbl_larva <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"larva"</span>)</span>
<span id="cb21-275"><a href="#cb21-275" aria-hidden="true" tabindex="-1"></a>tbl_larva_stage <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"larva_stage"</span>)</span>
<span id="cb21-276"><a href="#cb21-276" aria-hidden="true" tabindex="-1"></a>tbl_larva_size <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"larva_size"</span>)</span>
<span id="cb21-277"><a href="#cb21-277" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-278"><a href="#cb21-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-279"><a href="#cb21-279" aria-hidden="true" tabindex="-1"></a><span class="fu">## Create Life Stage Vocabulary Lookup Tables</span></span>
<span id="cb21-280"><a href="#cb21-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-281"><a href="#cb21-281" aria-hidden="true" tabindex="-1"></a>Define mappings for egg and larva developmental stages to descriptive terms:</span>
<span id="cb21-282"><a href="#cb21-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-285"><a href="#cb21-285" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-286"><a href="#cb21-286" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: vocabulary-lookups</span></span>
<span id="cb21-287"><a href="#cb21-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-288"><a href="#cb21-288" aria-hidden="true" tabindex="-1"></a><span class="co"># Egg stage vocabulary mapping (Moser &amp; Ahlstrom, 1985)</span></span>
<span id="cb21-289"><a href="#cb21-289" aria-hidden="true" tabindex="-1"></a>egg_stage_vocab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb21-290"><a href="#cb21-290" aria-hidden="true" tabindex="-1"></a>  <span class="at">stage =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>,</span>
<span id="cb21-291"><a href="#cb21-291" aria-hidden="true" tabindex="-1"></a>  <span class="at">stage_description =</span> <span class="fu">c</span>(</span>
<span id="cb21-292"><a href="#cb21-292" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 1 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb21-293"><a href="#cb21-293" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 2 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb21-294"><a href="#cb21-294" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 3 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb21-295"><a href="#cb21-295" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 4 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb21-296"><a href="#cb21-296" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 5 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb21-297"><a href="#cb21-297" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 6 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb21-298"><a href="#cb21-298" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 7 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb21-299"><a href="#cb21-299" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 8 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb21-300"><a href="#cb21-300" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 9 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb21-301"><a href="#cb21-301" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 10 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb21-302"><a href="#cb21-302" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 11 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb21-303"><a href="#cb21-303" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 12 of 11 (Moser &amp; Ahlstrom, 1985)"</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: needs revision</span></span>
<span id="cb21-304"><a href="#cb21-304" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 13 of 11 (Moser &amp; Ahlstrom, 1985)"</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: needs revision</span></span>
<span id="cb21-305"><a href="#cb21-305" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 14 of 11 (Moser &amp; Ahlstrom, 1985)"</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: needs revision</span></span>
<span id="cb21-306"><a href="#cb21-306" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 15 of 11 (Moser &amp; Ahlstrom, 1985)"</span> <span class="co"># </span><span class="al">TODO</span><span class="co">: needs revision</span></span>
<span id="cb21-307"><a href="#cb21-307" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-308"><a href="#cb21-308" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-309"><a href="#cb21-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-310"><a href="#cb21-310" aria-hidden="true" tabindex="-1"></a><span class="co"># Larva stage vocabulary mapping</span></span>
<span id="cb21-311"><a href="#cb21-311" aria-hidden="true" tabindex="-1"></a>larva_stage_vocab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb21-312"><a href="#cb21-312" aria-hidden="true" tabindex="-1"></a>  <span class="at">stage =</span> <span class="fu">c</span>(<span class="st">"YOLK"</span>, <span class="st">"PREF"</span>, <span class="st">"FLEX"</span>, <span class="st">"POST"</span>, <span class="st">"TRNS"</span>),</span>
<span id="cb21-313"><a href="#cb21-313" aria-hidden="true" tabindex="-1"></a>  <span class="at">stage_description =</span> <span class="fu">c</span>(</span>
<span id="cb21-314"><a href="#cb21-314" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, yolk sac"</span>,</span>
<span id="cb21-315"><a href="#cb21-315" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, preflexion"</span>,</span>
<span id="cb21-316"><a href="#cb21-316" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, flexion"</span>,</span>
<span id="cb21-317"><a href="#cb21-317" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, postflexion"</span>,</span>
<span id="cb21-318"><a href="#cb21-318" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, transformation"</span></span>
<span id="cb21-319"><a href="#cb21-319" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-320"><a href="#cb21-320" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-321"><a href="#cb21-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-322"><a href="#cb21-322" aria-hidden="true" tabindex="-1"></a><span class="co"># P06 Measurement Unit vocabulary (NERC)</span></span>
<span id="cb21-323"><a href="#cb21-323" aria-hidden="true" tabindex="-1"></a>measurement_unit_vocab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb21-324"><a href="#cb21-324" aria-hidden="true" tabindex="-1"></a>  <span class="at">measurementUnit =</span> <span class="fu">c</span>(</span>
<span id="cb21-325"><a href="#cb21-325" aria-hidden="true" tabindex="-1"></a>    <span class="st">"individuals"</span>,</span>
<span id="cb21-326"><a href="#cb21-326" aria-hidden="true" tabindex="-1"></a>    <span class="st">"millimeters"</span>,</span>
<span id="cb21-327"><a href="#cb21-327" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dimensionless"</span>,</span>
<span id="cb21-328"><a href="#cb21-328" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cubic meters"</span>,</span>
<span id="cb21-329"><a href="#cb21-329" aria-hidden="true" tabindex="-1"></a>    <span class="st">"grams"</span>,</span>
<span id="cb21-330"><a href="#cb21-330" aria-hidden="true" tabindex="-1"></a>    <span class="st">"proportion"</span>,</span>
<span id="cb21-331"><a href="#cb21-331" aria-hidden="true" tabindex="-1"></a>    <span class="st">"m^3"</span></span>
<span id="cb21-332"><a href="#cb21-332" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb21-333"><a href="#cb21-333" aria-hidden="true" tabindex="-1"></a>  <span class="at">measurementUnitID =</span> <span class="fu">c</span>(</span>
<span id="cb21-334"><a href="#cb21-334" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,</span>
<span id="cb21-335"><a href="#cb21-335" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UXMM/"</span>,</span>
<span id="cb21-336"><a href="#cb21-336" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,</span>
<span id="cb21-337"><a href="#cb21-337" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/MCUB/"</span>,</span>
<span id="cb21-338"><a href="#cb21-338" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UGRM/"</span>,</span>
<span id="cb21-339"><a href="#cb21-339" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>, <span class="co"># or UPCT?</span></span>
<span id="cb21-340"><a href="#cb21-340" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/MCUB/"</span></span>
<span id="cb21-341"><a href="#cb21-341" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-342"><a href="#cb21-342" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-343"><a href="#cb21-343" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-344"><a href="#cb21-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-345"><a href="#cb21-345" aria-hidden="true" tabindex="-1"></a><span class="fu">## Create Event Hierarchy</span></span>
<span id="cb21-346"><a href="#cb21-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-347"><a href="#cb21-347" aria-hidden="true" tabindex="-1"></a>DarwinCore uses an event-based model. We'll create a hierarchical event structure:</span>
<span id="cb21-348"><a href="#cb21-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-349"><a href="#cb21-349" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>cruise</span>
<span id="cb21-350"><a href="#cb21-350" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>site</span>
<span id="cb21-351"><a href="#cb21-351" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>tow</span>
<span id="cb21-352"><a href="#cb21-352" aria-hidden="true" tabindex="-1"></a><span class="ss">      - </span>net</span>
<span id="cb21-353"><a href="#cb21-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-356"><a href="#cb21-356" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb21-357"><a href="#cb21-357" aria-hidden="true" tabindex="-1"></a>%%| label: fig-larvae_event_hierarchy</span>
<span id="cb21-358"><a href="#cb21-358" aria-hidden="true" tabindex="-1"></a>%%| fig-cap: <span class="ot">"</span><span class="st">Event hierarchy for CalCOFI larvae data in DarwinCore Archive format with Extended Measurement or Fact.</span><span class="ot">"</span></span>
<span id="cb21-359"><a href="#cb21-359" aria-hidden="true" tabindex="-1"></a>%%| file: diagrams/larvae_event_hierarchy.mmd</span>
<span id="cb21-360"><a href="#cb21-360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-361"><a href="#cb21-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-362"><a href="#cb21-362" aria-hidden="true" tabindex="-1"></a>Per <span class="co">[</span><span class="ot">3.3.2. Simple nested datasets with Project-level information – Guide for publishing biological survey and monitoring data to GBIF</span><span class="co">](https://docs.gbif.org/guide-publishing-survey-data/en/#simple-nested-datasets-with-project-level-information)</span></span>
<span id="cb21-363"><a href="#cb21-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-366"><a href="#cb21-366" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-367"><a href="#cb21-367" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: build-event-hierarchy</span></span>
<span id="cb21-368"><a href="#cb21-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-369"><a href="#cb21-369" aria-hidden="true" tabindex="-1"></a><span class="co"># Build complete event hierarchy</span></span>
<span id="cb21-370"><a href="#cb21-370" aria-hidden="true" tabindex="-1"></a>q_events <span class="ot">&lt;-</span> tbl_net <span class="sc">|&gt;</span></span>
<span id="cb21-371"><a href="#cb21-371" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_tow, <span class="at">by =</span> <span class="st">"tow_uuid"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-372"><a href="#cb21-372" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_tow_type, <span class="at">by =</span> <span class="st">"tow_type_key"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-373"><a href="#cb21-373" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_site, <span class="at">by =</span> <span class="st">"site_uuid"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-374"><a href="#cb21-374" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_cruise, <span class="at">by =</span> <span class="st">"cruise_uuid"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-375"><a href="#cb21-375" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_ship, <span class="at">by =</span> <span class="st">"ship_key"</span>)</span>
<span id="cb21-376"><a href="#cb21-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-377"><a href="#cb21-377" aria-hidden="true" tabindex="-1"></a><span class="co"># Create event core at different levels ----</span></span>
<span id="cb21-378"><a href="#cb21-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-379"><a href="#cb21-379" aria-hidden="true" tabindex="-1"></a>flds_to_iso8601 <span class="ot">&lt;-</span> <span class="cf">function</span>(flds, <span class="at">output =</span> <span class="st">"datetime"</span>) {</span>
<span id="cb21-380"><a href="#cb21-380" aria-hidden="true" tabindex="-1"></a>  <span class="co"># helper function to convert date/time fields to ISO 8601 format</span></span>
<span id="cb21-381"><a href="#cb21-381" aria-hidden="true" tabindex="-1"></a>  <span class="co"># per https://dwc.tdwg.org/terms/ eventDate: add 2007-03-01T13:00:00Z/2008-05-11T15:30:00Z (some time within the interval beginning 1 March 2007 at 1pm UTC and before 11 May 2008 at 3:30pm UTC)</span></span>
<span id="cb21-382"><a href="#cb21-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-383"><a href="#cb21-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">length</span>(flds) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb21-384"><a href="#cb21-384" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(output <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"datetime"</span>, <span class="st">"time"</span>))</span>
<span id="cb21-385"><a href="#cb21-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-386"><a href="#cb21-386" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(flds) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> output <span class="sc">==</span> <span class="st">"datetime"</span>) {</span>
<span id="cb21-387"><a href="#cb21-387" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb21-388"><a href="#cb21-388" aria-hidden="true" tabindex="-1"></a>      <span class="st">"to_char({flds}, 'YYYY-MM-DD</span><span class="sc">\"</span><span class="st">T</span><span class="sc">\"</span><span class="st">HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">')"</span></span>
<span id="cb21-389"><a href="#cb21-389" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-390"><a href="#cb21-390" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-391"><a href="#cb21-391" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(flds) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> output <span class="sc">==</span> <span class="st">"datetime"</span>) {</span>
<span id="cb21-392"><a href="#cb21-392" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb21-393"><a href="#cb21-393" aria-hidden="true" tabindex="-1"></a>      <span class="st">"to_char({flds[1]}, 'YYYY-MM-DD</span><span class="sc">\"</span><span class="st">T</span><span class="sc">\"</span><span class="st">HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">') || '/' || </span></span>
<span id="cb21-394"><a href="#cb21-394" aria-hidden="true" tabindex="-1"></a><span class="st">         to_char({flds[2]}, 'YYYY-MM-DD</span><span class="sc">\"</span><span class="st">T</span><span class="sc">\"</span><span class="st">HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">')"</span></span>
<span id="cb21-395"><a href="#cb21-395" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-396"><a href="#cb21-396" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-397"><a href="#cb21-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-398"><a href="#cb21-398" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(flds) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> output <span class="sc">==</span> <span class="st">"time"</span>) {</span>
<span id="cb21-399"><a href="#cb21-399" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb21-400"><a href="#cb21-400" aria-hidden="true" tabindex="-1"></a>      <span class="st">"to_char({flds}, 'HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">')"</span></span>
<span id="cb21-401"><a href="#cb21-401" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-402"><a href="#cb21-402" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-403"><a href="#cb21-403" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(flds) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> output <span class="sc">==</span> <span class="st">"time"</span>) {</span>
<span id="cb21-404"><a href="#cb21-404" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb21-405"><a href="#cb21-405" aria-hidden="true" tabindex="-1"></a>      <span class="st">"to_char({flds[1]}, 'HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">') || '/' || </span></span>
<span id="cb21-406"><a href="#cb21-406" aria-hidden="true" tabindex="-1"></a><span class="st">       to_char({flds[2]}, 'HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">')"</span></span>
<span id="cb21-407"><a href="#cb21-407" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-408"><a href="#cb21-408" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-409"><a href="#cb21-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-410"><a href="#cb21-410" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.character</span>(s)</span>
<span id="cb21-411"><a href="#cb21-411" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-412"><a href="#cb21-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-413"><a href="#cb21-413" aria-hidden="true" tabindex="-1"></a><span class="co"># * Cruise level events ----</span></span>
<span id="cb21-414"><a href="#cb21-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-415"><a href="#cb21-415" aria-hidden="true" tabindex="-1"></a><span class="co"># get min/max datetimes for cruises</span></span>
<span id="cb21-416"><a href="#cb21-416" aria-hidden="true" tabindex="-1"></a>q_cruise_event_date <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb21-417"><a href="#cb21-417" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cruise_uuid) <span class="sc">|&gt;</span></span>
<span id="cb21-418"><a href="#cb21-418" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb21-419"><a href="#cb21-419" aria-hidden="true" tabindex="-1"></a>    <span class="at">dtime_min =</span> <span class="fu">min</span>(time_start, <span class="at">na.rm =</span> T),</span>
<span id="cb21-420"><a href="#cb21-420" aria-hidden="true" tabindex="-1"></a>    <span class="at">dtime_max =</span> <span class="fu">max</span>(time_start, <span class="at">na.rm =</span> T),</span>
<span id="cb21-421"><a href="#cb21-421" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb21-422"><a href="#cb21-422" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-423"><a href="#cb21-423" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-424"><a href="#cb21-424" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventDate =</span> <span class="fu">sql</span>(<span class="fu">flds_to_iso8601</span>(<span class="fu">c</span>(<span class="st">"dtime_min"</span>, <span class="st">"dtime_max"</span>)))</span>
<span id="cb21-425"><a href="#cb21-425" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-426"><a href="#cb21-426" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(cruise_uuid, eventDate)</span>
<span id="cb21-427"><a href="#cb21-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-428"><a href="#cb21-428" aria-hidden="true" tabindex="-1"></a>q_cruise_events <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb21-429"><a href="#cb21-429" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(cruise_uuid, ship_name, ship_nodc, date_ym) <span class="sc">|&gt;</span></span>
<span id="cb21-430"><a href="#cb21-430" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-431"><a href="#cb21-431" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> cruise_uuid,</span>
<span id="cb21-432"><a href="#cb21-432" aria-hidden="true" tabindex="-1"></a>    <span class="co"># parentEventID  = NA, # no parent for cruise level; NA generated with union_all</span></span>
<span id="cb21-433"><a href="#cb21-433" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks =</span> <span class="fu">paste</span>(<span class="st">"Cruise on"</span>, ship_name),</span>
<span id="cb21-434"><a href="#cb21-434" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="st">"Marine plankton survey cruise"</span>,</span>
<span id="cb21-435"><a href="#cb21-435" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeValue =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb21-436"><a href="#cb21-436" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeUnit =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb21-437"><a href="#cb21-437" aria-hidden="true" tabindex="-1"></a>    <span class="at">habitat =</span> <span class="st">"marine"</span>,</span>
<span id="cb21-438"><a href="#cb21-438" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType =</span> <span class="st">"cruise"</span></span>
<span id="cb21-439"><a href="#cb21-439" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-440"><a href="#cb21-440" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb21-441"><a href="#cb21-441" aria-hidden="true" tabindex="-1"></a>    q_cruise_event_date,</span>
<span id="cb21-442"><a href="#cb21-442" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"cruise_uuid"</span></span>
<span id="cb21-443"><a href="#cb21-443" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-444"><a href="#cb21-444" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb21-445"><a href="#cb21-445" aria-hidden="true" tabindex="-1"></a>    eventID, <span class="co"># parentEventID,</span></span>
<span id="cb21-446"><a href="#cb21-446" aria-hidden="true" tabindex="-1"></a>    eventType,</span>
<span id="cb21-447"><a href="#cb21-447" aria-hidden="true" tabindex="-1"></a>    eventDate,</span>
<span id="cb21-448"><a href="#cb21-448" aria-hidden="true" tabindex="-1"></a>    samplingProtocol,</span>
<span id="cb21-449"><a href="#cb21-449" aria-hidden="true" tabindex="-1"></a>    eventRemarks,</span>
<span id="cb21-450"><a href="#cb21-450" aria-hidden="true" tabindex="-1"></a>    habitat</span>
<span id="cb21-451"><a href="#cb21-451" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-452"><a href="#cb21-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-453"><a href="#cb21-453" aria-hidden="true" tabindex="-1"></a><span class="co"># Site level events</span></span>
<span id="cb21-454"><a href="#cb21-454" aria-hidden="true" tabindex="-1"></a>q_site_events <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb21-455"><a href="#cb21-455" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(</span>
<span id="cb21-456"><a href="#cb21-456" aria-hidden="true" tabindex="-1"></a>    site_uuid,</span>
<span id="cb21-457"><a href="#cb21-457" aria-hidden="true" tabindex="-1"></a>    cruise_uuid,</span>
<span id="cb21-458"><a href="#cb21-458" aria-hidden="true" tabindex="-1"></a>    longitude,</span>
<span id="cb21-459"><a href="#cb21-459" aria-hidden="true" tabindex="-1"></a>    latitude,</span>
<span id="cb21-460"><a href="#cb21-460" aria-hidden="true" tabindex="-1"></a>    line,</span>
<span id="cb21-461"><a href="#cb21-461" aria-hidden="true" tabindex="-1"></a>    station,</span>
<span id="cb21-462"><a href="#cb21-462" aria-hidden="true" tabindex="-1"></a>    orderocc</span>
<span id="cb21-463"><a href="#cb21-463" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-464"><a href="#cb21-464" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-465"><a href="#cb21-465" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> site_uuid,</span>
<span id="cb21-466"><a href="#cb21-466" aria-hidden="true" tabindex="-1"></a>    <span class="at">parentEventID =</span> cruise_uuid,</span>
<span id="cb21-467"><a href="#cb21-467" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimalLatitude =</span> latitude,</span>
<span id="cb21-468"><a href="#cb21-468" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimalLongitude =</span> longitude,</span>
<span id="cb21-469"><a href="#cb21-469" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks =</span> <span class="fu">paste</span>(<span class="st">"CalCOFI station"</span>, station, <span class="st">"on line"</span>, line),</span>
<span id="cb21-470"><a href="#cb21-470" aria-hidden="true" tabindex="-1"></a>    <span class="co"># per https://proj.org/en/stable/operations/projections/calcofi.html</span></span>
<span id="cb21-471"><a href="#cb21-471" aria-hidden="true" tabindex="-1"></a>    <span class="at">locationID =</span> <span class="fu">paste0</span>(line, <span class="st">"_"</span>, station),</span>
<span id="cb21-472"><a href="#cb21-472" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType =</span> <span class="st">"site"</span>,</span>
<span id="cb21-473"><a href="#cb21-473" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="st">"Marine plankton survey station"</span></span>
<span id="cb21-474"><a href="#cb21-474" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-475"><a href="#cb21-475" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb21-476"><a href="#cb21-476" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb21-477"><a href="#cb21-477" aria-hidden="true" tabindex="-1"></a>    parentEventID,</span>
<span id="cb21-478"><a href="#cb21-478" aria-hidden="true" tabindex="-1"></a>    eventType,</span>
<span id="cb21-479"><a href="#cb21-479" aria-hidden="true" tabindex="-1"></a>    samplingProtocol,</span>
<span id="cb21-480"><a href="#cb21-480" aria-hidden="true" tabindex="-1"></a>    eventRemarks,</span>
<span id="cb21-481"><a href="#cb21-481" aria-hidden="true" tabindex="-1"></a>    decimalLatitude,</span>
<span id="cb21-482"><a href="#cb21-482" aria-hidden="true" tabindex="-1"></a>    decimalLongitude,</span>
<span id="cb21-483"><a href="#cb21-483" aria-hidden="true" tabindex="-1"></a>    locationID</span>
<span id="cb21-484"><a href="#cb21-484" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-485"><a href="#cb21-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-486"><a href="#cb21-486" aria-hidden="true" tabindex="-1"></a><span class="co"># Tow level events</span></span>
<span id="cb21-487"><a href="#cb21-487" aria-hidden="true" tabindex="-1"></a>q_tow_events <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb21-488"><a href="#cb21-488" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(</span>
<span id="cb21-489"><a href="#cb21-489" aria-hidden="true" tabindex="-1"></a>    tow_uuid,</span>
<span id="cb21-490"><a href="#cb21-490" aria-hidden="true" tabindex="-1"></a>    site_uuid,</span>
<span id="cb21-491"><a href="#cb21-491" aria-hidden="true" tabindex="-1"></a>    tow_number,</span>
<span id="cb21-492"><a href="#cb21-492" aria-hidden="true" tabindex="-1"></a>    tow_type_key,</span>
<span id="cb21-493"><a href="#cb21-493" aria-hidden="true" tabindex="-1"></a>    <span class="at">tow_type_description =</span> description,</span>
<span id="cb21-494"><a href="#cb21-494" aria-hidden="true" tabindex="-1"></a>    time_start</span>
<span id="cb21-495"><a href="#cb21-495" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-496"><a href="#cb21-496" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-497"><a href="#cb21-497" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> tow_uuid,</span>
<span id="cb21-498"><a href="#cb21-498" aria-hidden="true" tabindex="-1"></a>    <span class="at">parentEventID =</span> site_uuid,</span>
<span id="cb21-499"><a href="#cb21-499" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventDate =</span> <span class="fu">sql</span>(<span class="fu">flds_to_iso8601</span>(<span class="st">"time_start"</span>)),</span>
<span id="cb21-500"><a href="#cb21-500" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks =</span> <span class="fu">paste</span>(<span class="st">"Tow"</span>, tow_number, <span class="st">"-"</span>, tow_type_description),</span>
<span id="cb21-501"><a href="#cb21-501" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType =</span> <span class="st">"tow"</span>,</span>
<span id="cb21-502"><a href="#cb21-502" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="fu">paste</span>(tow_type_key, <span class="st">":"</span>, tow_type_description)</span>
<span id="cb21-503"><a href="#cb21-503" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-504"><a href="#cb21-504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb21-505"><a href="#cb21-505" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb21-506"><a href="#cb21-506" aria-hidden="true" tabindex="-1"></a>    parentEventID,</span>
<span id="cb21-507"><a href="#cb21-507" aria-hidden="true" tabindex="-1"></a>    eventType,</span>
<span id="cb21-508"><a href="#cb21-508" aria-hidden="true" tabindex="-1"></a>    eventDate,</span>
<span id="cb21-509"><a href="#cb21-509" aria-hidden="true" tabindex="-1"></a>    samplingProtocol,</span>
<span id="cb21-510"><a href="#cb21-510" aria-hidden="true" tabindex="-1"></a>    eventRemarks</span>
<span id="cb21-511"><a href="#cb21-511" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-512"><a href="#cb21-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-513"><a href="#cb21-513" aria-hidden="true" tabindex="-1"></a><span class="co"># Net level events (sampling events)</span></span>
<span id="cb21-514"><a href="#cb21-514" aria-hidden="true" tabindex="-1"></a>q_net_events_allflds <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb21-515"><a href="#cb21-515" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(</span>
<span id="cb21-516"><a href="#cb21-516" aria-hidden="true" tabindex="-1"></a>    net_uuid,</span>
<span id="cb21-517"><a href="#cb21-517" aria-hidden="true" tabindex="-1"></a>    tow_uuid,</span>
<span id="cb21-518"><a href="#cb21-518" aria-hidden="true" tabindex="-1"></a>    side,</span>
<span id="cb21-519"><a href="#cb21-519" aria-hidden="true" tabindex="-1"></a>    std_haul_factor,</span>
<span id="cb21-520"><a href="#cb21-520" aria-hidden="true" tabindex="-1"></a>    vol_sampled_m3,</span>
<span id="cb21-521"><a href="#cb21-521" aria-hidden="true" tabindex="-1"></a>    prop_sorted,</span>
<span id="cb21-522"><a href="#cb21-522" aria-hidden="true" tabindex="-1"></a>    smallplankton,</span>
<span id="cb21-523"><a href="#cb21-523" aria-hidden="true" tabindex="-1"></a>    totalplankton</span>
<span id="cb21-524"><a href="#cb21-524" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-525"><a href="#cb21-525" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-526"><a href="#cb21-526" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> net_uuid,</span>
<span id="cb21-527"><a href="#cb21-527" aria-hidden="true" tabindex="-1"></a>    <span class="at">parentEventID =</span> tow_uuid,</span>
<span id="cb21-528"><a href="#cb21-528" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks =</span> <span class="fu">paste</span>(</span>
<span id="cb21-529"><a href="#cb21-529" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Net sample from side"</span>,</span>
<span id="cb21-530"><a href="#cb21-530" aria-hidden="true" tabindex="-1"></a>      side,</span>
<span id="cb21-531"><a href="#cb21-531" aria-hidden="true" tabindex="-1"></a>      <span class="st">"; only"</span>,</span>
<span id="cb21-532"><a href="#cb21-532" aria-hidden="true" tabindex="-1"></a>      prop_sorted,</span>
<span id="cb21-533"><a href="#cb21-533" aria-hidden="true" tabindex="-1"></a>      <span class="st">"proportion sorted of"</span>,</span>
<span id="cb21-534"><a href="#cb21-534" aria-hidden="true" tabindex="-1"></a>      vol_sampled_m3,</span>
<span id="cb21-535"><a href="#cb21-535" aria-hidden="true" tabindex="-1"></a>      <span class="st">"cubic meters sampled"</span></span>
<span id="cb21-536"><a href="#cb21-536" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb21-537"><a href="#cb21-537" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType =</span> <span class="st">"net_sample"</span>,</span>
<span id="cb21-538"><a href="#cb21-538" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="fu">paste</span>(<span class="st">"Plankton net tow -"</span>, side, <span class="st">"side"</span>),</span>
<span id="cb21-539"><a href="#cb21-539" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeValue =</span> vol_sampled_m3,</span>
<span id="cb21-540"><a href="#cb21-540" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeUnit =</span> <span class="st">"m^3"</span></span>
<span id="cb21-541"><a href="#cb21-541" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-542"><a href="#cb21-542" aria-hidden="true" tabindex="-1"></a>q_net_events <span class="ot">&lt;-</span> q_net_events_allflds <span class="sc">|&gt;</span></span>
<span id="cb21-543"><a href="#cb21-543" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb21-544"><a href="#cb21-544" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb21-545"><a href="#cb21-545" aria-hidden="true" tabindex="-1"></a>    parentEventID,</span>
<span id="cb21-546"><a href="#cb21-546" aria-hidden="true" tabindex="-1"></a>    eventType,</span>
<span id="cb21-547"><a href="#cb21-547" aria-hidden="true" tabindex="-1"></a>    samplingProtocol,</span>
<span id="cb21-548"><a href="#cb21-548" aria-hidden="true" tabindex="-1"></a>    eventRemarks,</span>
<span id="cb21-549"><a href="#cb21-549" aria-hidden="true" tabindex="-1"></a>    sampleSizeValue,</span>
<span id="cb21-550"><a href="#cb21-550" aria-hidden="true" tabindex="-1"></a>    sampleSizeUnit</span>
<span id="cb21-551"><a href="#cb21-551" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-552"><a href="#cb21-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-553"><a href="#cb21-553" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all event levels</span></span>
<span id="cb21-554"><a href="#cb21-554" aria-hidden="true" tabindex="-1"></a>db_version <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"schema_version"</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(version)</span>
<span id="cb21-555"><a href="#cb21-555" aria-hidden="true" tabindex="-1"></a><span class="co"># dataset_id &lt;- paste0(</span></span>
<span id="cb21-556"><a href="#cb21-556" aria-hidden="true" tabindex="-1"></a><span class="co">#   # "https://github.com/CalCOFI/calcofi4db/releases/tag/v",</span></span>
<span id="cb21-557"><a href="#cb21-557" aria-hidden="true" tabindex="-1"></a><span class="co">#   "calcofi_db.",</span></span>
<span id="cb21-558"><a href="#cb21-558" aria-hidden="true" tabindex="-1"></a><span class="co">#   db_version,</span></span>
<span id="cb21-559"><a href="#cb21-559" aria-hidden="true" tabindex="-1"></a><span class="co">#   "_larvae.",</span></span>
<span id="cb21-560"><a href="#cb21-560" aria-hidden="true" tabindex="-1"></a><span class="co">#   format(Sys.Date(), "%Y-%m-%d")</span></span>
<span id="cb21-561"><a href="#cb21-561" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb21-562"><a href="#cb21-562" aria-hidden="true" tabindex="-1"></a><span class="co"># "calcofi_db.1.1.0_larvae.2025-10-09"</span></span>
<span id="cb21-563"><a href="#cb21-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-564"><a href="#cb21-564" aria-hidden="true" tabindex="-1"></a>q_event_core <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb21-565"><a href="#cb21-565" aria-hidden="true" tabindex="-1"></a>  q_cruise_events <span class="sc">|&gt;</span></span>
<span id="cb21-566"><a href="#cb21-566" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb21-567"><a href="#cb21-567" aria-hidden="true" tabindex="-1"></a>      <span class="at">parentEventID =</span> <span class="fu">sql</span>(<span class="st">"NULL::uuid"</span>),</span>
<span id="cb21-568"><a href="#cb21-568" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeValue =</span> <span class="fu">sql</span>(<span class="st">"NULL::numeric"</span>),</span>
<span id="cb21-569"><a href="#cb21-569" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeUnit =</span> <span class="cn">NA_character_</span></span>
<span id="cb21-570"><a href="#cb21-570" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb21-571"><a href="#cb21-571" aria-hidden="true" tabindex="-1"></a>  q_site_events <span class="sc">|&gt;</span></span>
<span id="cb21-572"><a href="#cb21-572" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb21-573"><a href="#cb21-573" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeValue =</span> <span class="fu">sql</span>(<span class="st">"NULL::numeric"</span>),</span>
<span id="cb21-574"><a href="#cb21-574" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeUnit =</span> <span class="cn">NA_character_</span></span>
<span id="cb21-575"><a href="#cb21-575" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb21-576"><a href="#cb21-576" aria-hidden="true" tabindex="-1"></a>  q_tow_events <span class="sc">|&gt;</span></span>
<span id="cb21-577"><a href="#cb21-577" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb21-578"><a href="#cb21-578" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeValue =</span> <span class="fu">sql</span>(<span class="st">"NULL::numeric"</span>),</span>
<span id="cb21-579"><a href="#cb21-579" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeUnit =</span> <span class="cn">NA_character_</span></span>
<span id="cb21-580"><a href="#cb21-580" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb21-581"><a href="#cb21-581" aria-hidden="true" tabindex="-1"></a>  q_net_events</span>
<span id="cb21-582"><a href="#cb21-582" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb21-583"><a href="#cb21-583" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reduce</span>(union_all) <span class="sc">|&gt;</span></span>
<span id="cb21-584"><a href="#cb21-584" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-585"><a href="#cb21-585" aria-hidden="true" tabindex="-1"></a>    <span class="co"># basisOfRecord                 = "HumanObservation",</span></span>
<span id="cb21-586"><a href="#cb21-586" aria-hidden="true" tabindex="-1"></a>    <span class="at">geodeticDatum =</span> <span class="st">"WGS84"</span>,</span>
<span id="cb21-587"><a href="#cb21-587" aria-hidden="true" tabindex="-1"></a>    <span class="at">coordinateUncertaintyInMeters =</span> <span class="dv">1000</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: adjust based on accuracy of GPS/Loran/dead-reckoning over time</span></span>
<span id="cb21-588"><a href="#cb21-588" aria-hidden="true" tabindex="-1"></a>    <span class="at">countryCode =</span> country_code, <span class="co"># country_code &lt;- "US"</span></span>
<span id="cb21-589"><a href="#cb21-589" aria-hidden="true" tabindex="-1"></a>    <span class="at">waterBody =</span> water_body,</span>
<span id="cb21-590"><a href="#cb21-590" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasetID =</span> dataset_id</span>
<span id="cb21-591"><a href="#cb21-591" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-592"><a href="#cb21-592" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: datasetID: permalink to this qmd in calcofi4db release?</span></span>
<span id="cb21-593"><a href="#cb21-593" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-594"><a href="#cb21-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-595"><a href="#cb21-595" aria-hidden="true" tabindex="-1"></a><span class="fu">## Create Occurrence Records</span></span>
<span id="cb21-596"><a href="#cb21-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-597"><a href="#cb21-597" aria-hidden="true" tabindex="-1"></a>Now let's combine all biological observations into occurrence records:</span>
<span id="cb21-598"><a href="#cb21-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-601"><a href="#cb21-601" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-602"><a href="#cb21-602" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: build-occurrences</span></span>
<span id="cb21-603"><a href="#cb21-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-604"><a href="#cb21-604" aria-hidden="true" tabindex="-1"></a><span class="co"># Create consolidated egg occurrences (one per species per net)</span></span>
<span id="cb21-605"><a href="#cb21-605" aria-hidden="true" tabindex="-1"></a>q_egg_occurrences <span class="ot">&lt;-</span> tbl_egg <span class="sc">|&gt;</span></span>
<span id="cb21-606"><a href="#cb21-606" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_species, <span class="at">by =</span> <span class="st">"species_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-607"><a href="#cb21-607" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-608"><a href="#cb21-608" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID =</span> <span class="fu">sql</span>(<span class="st">"gen_random_uuid()"</span>),</span>
<span id="cb21-609"><a href="#cb21-609" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> net_uuid,</span>
<span id="cb21-610"><a href="#cb21-610" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificName =</span> scientific_name,</span>
<span id="cb21-611"><a href="#cb21-611" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificNameID =</span> <span class="fu">paste0</span>(<span class="st">"urn:lsid:marinespecies.org:taxname:"</span>, worms_id),</span>
<span id="cb21-612"><a href="#cb21-612" aria-hidden="true" tabindex="-1"></a>    <span class="at">kingdom =</span> <span class="st">"Animalia"</span>,</span>
<span id="cb21-613"><a href="#cb21-613" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceStatus =</span> <span class="fu">ifelse</span>(tally <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"present"</span>, <span class="st">"absent"</span>),</span>
<span id="cb21-614"><a href="#cb21-614" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantity =</span> tally, <span class="co"># TOTAL count from egg table</span></span>
<span id="cb21-615"><a href="#cb21-615" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantityType =</span> <span class="st">"individuals"</span>,</span>
<span id="cb21-616"><a href="#cb21-616" aria-hidden="true" tabindex="-1"></a>    <span class="at">lifeStage =</span> <span class="st">"egg"</span>,</span>
<span id="cb21-617"><a href="#cb21-617" aria-hidden="true" tabindex="-1"></a>    <span class="co">#lifeStage            = "https://vocab.nerc.ac.uk/collection/S11/current/S1122/",</span></span>
<span id="cb21-618"><a href="#cb21-618" aria-hidden="true" tabindex="-1"></a>    <span class="co"># lifeStageID          = "http://vocab.nerc.ac.uk/collection/S11/current/S1110/",</span></span>
<span id="cb21-619"><a href="#cb21-619" aria-hidden="true" tabindex="-1"></a>    <span class="at">preparations =</span> <span class="st">"egg sample"</span>,</span>
<span id="cb21-620"><a href="#cb21-620" aria-hidden="true" tabindex="-1"></a>    <span class="at">basisOfRecord =</span> <span class="st">"HumanObservation"</span></span>
<span id="cb21-621"><a href="#cb21-621" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-622"><a href="#cb21-622" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb21-623"><a href="#cb21-623" aria-hidden="true" tabindex="-1"></a>    occurrenceID,</span>
<span id="cb21-624"><a href="#cb21-624" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb21-625"><a href="#cb21-625" aria-hidden="true" tabindex="-1"></a>    species_id,</span>
<span id="cb21-626"><a href="#cb21-626" aria-hidden="true" tabindex="-1"></a>    scientificName,</span>
<span id="cb21-627"><a href="#cb21-627" aria-hidden="true" tabindex="-1"></a>    scientificNameID,</span>
<span id="cb21-628"><a href="#cb21-628" aria-hidden="true" tabindex="-1"></a>    kingdom,</span>
<span id="cb21-629"><a href="#cb21-629" aria-hidden="true" tabindex="-1"></a>    occurrenceStatus,</span>
<span id="cb21-630"><a href="#cb21-630" aria-hidden="true" tabindex="-1"></a>    organismQuantity,</span>
<span id="cb21-631"><a href="#cb21-631" aria-hidden="true" tabindex="-1"></a>    organismQuantityType,</span>
<span id="cb21-632"><a href="#cb21-632" aria-hidden="true" tabindex="-1"></a>    lifeStage, <span class="co"># lifeStageID,</span></span>
<span id="cb21-633"><a href="#cb21-633" aria-hidden="true" tabindex="-1"></a>    preparations,</span>
<span id="cb21-634"><a href="#cb21-634" aria-hidden="true" tabindex="-1"></a>    basisOfRecord</span>
<span id="cb21-635"><a href="#cb21-635" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-636"><a href="#cb21-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-637"><a href="#cb21-637" aria-hidden="true" tabindex="-1"></a><span class="co"># Create consolidated larva occurrences (one per species per net)</span></span>
<span id="cb21-638"><a href="#cb21-638" aria-hidden="true" tabindex="-1"></a>q_larva_occurrences <span class="ot">&lt;-</span> tbl_larva <span class="sc">|&gt;</span></span>
<span id="cb21-639"><a href="#cb21-639" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_species, <span class="at">by =</span> <span class="st">"species_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-640"><a href="#cb21-640" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-641"><a href="#cb21-641" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID =</span> <span class="fu">sql</span>(<span class="st">"gen_random_uuid()"</span>),</span>
<span id="cb21-642"><a href="#cb21-642" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> net_uuid,</span>
<span id="cb21-643"><a href="#cb21-643" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificName =</span> scientific_name,</span>
<span id="cb21-644"><a href="#cb21-644" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificNameID =</span> <span class="fu">paste0</span>(<span class="st">"urn:lsid:marinespecies.org:taxname:"</span>, worms_id),</span>
<span id="cb21-645"><a href="#cb21-645" aria-hidden="true" tabindex="-1"></a>    <span class="at">kingdom =</span> <span class="st">"Animalia"</span>,</span>
<span id="cb21-646"><a href="#cb21-646" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceStatus =</span> <span class="fu">ifelse</span>(tally <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"present"</span>, <span class="st">"absent"</span>),</span>
<span id="cb21-647"><a href="#cb21-647" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantity =</span> tally, <span class="co"># TOTAL count from larva table</span></span>
<span id="cb21-648"><a href="#cb21-648" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantityType =</span> <span class="st">"individuals"</span>,</span>
<span id="cb21-649"><a href="#cb21-649" aria-hidden="true" tabindex="-1"></a>    <span class="at">lifeStage =</span> <span class="st">"larva"</span>,</span>
<span id="cb21-650"><a href="#cb21-650" aria-hidden="true" tabindex="-1"></a>    <span class="co"># lifeStageID          = "http://vocab.nerc.ac.uk/collection/S11/current/S1133/",</span></span>
<span id="cb21-651"><a href="#cb21-651" aria-hidden="true" tabindex="-1"></a>    <span class="at">preparations =</span> <span class="st">"larva sample"</span>,</span>
<span id="cb21-652"><a href="#cb21-652" aria-hidden="true" tabindex="-1"></a>    <span class="at">basisOfRecord =</span> <span class="st">"HumanObservation"</span></span>
<span id="cb21-653"><a href="#cb21-653" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-654"><a href="#cb21-654" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb21-655"><a href="#cb21-655" aria-hidden="true" tabindex="-1"></a>    occurrenceID,</span>
<span id="cb21-656"><a href="#cb21-656" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb21-657"><a href="#cb21-657" aria-hidden="true" tabindex="-1"></a>    species_id,</span>
<span id="cb21-658"><a href="#cb21-658" aria-hidden="true" tabindex="-1"></a>    scientificName,</span>
<span id="cb21-659"><a href="#cb21-659" aria-hidden="true" tabindex="-1"></a>    scientificNameID,</span>
<span id="cb21-660"><a href="#cb21-660" aria-hidden="true" tabindex="-1"></a>    kingdom,</span>
<span id="cb21-661"><a href="#cb21-661" aria-hidden="true" tabindex="-1"></a>    occurrenceStatus,</span>
<span id="cb21-662"><a href="#cb21-662" aria-hidden="true" tabindex="-1"></a>    organismQuantity,</span>
<span id="cb21-663"><a href="#cb21-663" aria-hidden="true" tabindex="-1"></a>    organismQuantityType,</span>
<span id="cb21-664"><a href="#cb21-664" aria-hidden="true" tabindex="-1"></a>    lifeStage, <span class="co"># lifeStageID,</span></span>
<span id="cb21-665"><a href="#cb21-665" aria-hidden="true" tabindex="-1"></a>    preparations,</span>
<span id="cb21-666"><a href="#cb21-666" aria-hidden="true" tabindex="-1"></a>    basisOfRecord</span>
<span id="cb21-667"><a href="#cb21-667" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-668"><a href="#cb21-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-669"><a href="#cb21-669" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine egg and larva occurrences</span></span>
<span id="cb21-670"><a href="#cb21-670" aria-hidden="true" tabindex="-1"></a>q_occurrence_extension <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb21-671"><a href="#cb21-671" aria-hidden="true" tabindex="-1"></a>  q_egg_occurrences,</span>
<span id="cb21-672"><a href="#cb21-672" aria-hidden="true" tabindex="-1"></a>  q_larva_occurrences</span>
<span id="cb21-673"><a href="#cb21-673" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb21-674"><a href="#cb21-674" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reduce</span>(union_all) <span class="sc">|&gt;</span></span>
<span id="cb21-675"><a href="#cb21-675" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add additional required/recommended fields</span></span>
<span id="cb21-676"><a href="#cb21-676" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-677"><a href="#cb21-677" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: identifiedBy, dateIdentified,identificationReferences</span></span>
<span id="cb21-678"><a href="#cb21-678" aria-hidden="true" tabindex="-1"></a>    <span class="co"># identifiedBy = "[NEED IDENTIFIER NAME]", # Prompt: Add taxonomist name</span></span>
<span id="cb21-679"><a href="#cb21-679" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dateIdentified = "[NEED IDENTIFICATION DATE]", # Prompt: Add identification date</span></span>
<span id="cb21-680"><a href="#cb21-680" aria-hidden="true" tabindex="-1"></a>    <span class="co"># identificationReferences = "[NEED REFERENCES]", # Prompt: Add identification guides used</span></span>
<span id="cb21-681"><a href="#cb21-681" aria-hidden="true" tabindex="-1"></a>    <span class="at">modified =</span> <span class="fu">sql</span>(<span class="st">"CURRENT_DATE"</span>)</span>
<span id="cb21-682"><a href="#cb21-682" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-683"><a href="#cb21-683" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove species_id (internal field used only for joins)</span></span>
<span id="cb21-684"><a href="#cb21-684" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb21-685"><a href="#cb21-685" aria-hidden="true" tabindex="-1"></a>    occurrenceID,</span>
<span id="cb21-686"><a href="#cb21-686" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb21-687"><a href="#cb21-687" aria-hidden="true" tabindex="-1"></a>    scientificName,</span>
<span id="cb21-688"><a href="#cb21-688" aria-hidden="true" tabindex="-1"></a>    scientificNameID,</span>
<span id="cb21-689"><a href="#cb21-689" aria-hidden="true" tabindex="-1"></a>    kingdom,</span>
<span id="cb21-690"><a href="#cb21-690" aria-hidden="true" tabindex="-1"></a>    occurrenceStatus,</span>
<span id="cb21-691"><a href="#cb21-691" aria-hidden="true" tabindex="-1"></a>    organismQuantity,</span>
<span id="cb21-692"><a href="#cb21-692" aria-hidden="true" tabindex="-1"></a>    organismQuantityType,</span>
<span id="cb21-693"><a href="#cb21-693" aria-hidden="true" tabindex="-1"></a>    lifeStage, <span class="co"># lifeStageID,</span></span>
<span id="cb21-694"><a href="#cb21-694" aria-hidden="true" tabindex="-1"></a>    preparations,</span>
<span id="cb21-695"><a href="#cb21-695" aria-hidden="true" tabindex="-1"></a>    basisOfRecord,</span>
<span id="cb21-696"><a href="#cb21-696" aria-hidden="true" tabindex="-1"></a>    modified</span>
<span id="cb21-697"><a href="#cb21-697" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-698"><a href="#cb21-698" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-699"><a href="#cb21-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-700"><a href="#cb21-700" aria-hidden="true" tabindex="-1"></a><span class="fu">## Create ExtendedMeasurementOrFact Extension</span></span>
<span id="cb21-701"><a href="#cb21-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-702"><a href="#cb21-702" aria-hidden="true" tabindex="-1"></a>Create eMoF records for three types of measurements:</span>
<span id="cb21-703"><a href="#cb21-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-704"><a href="#cb21-704" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Sample-level measurements (linked to eventID)</span>
<span id="cb21-705"><a href="#cb21-705" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Stage-specific abundance (linked to occurrenceID)</span>
<span id="cb21-706"><a href="#cb21-706" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Body length measurements (linked to occurrence ID)</span>
<span id="cb21-707"><a href="#cb21-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-710"><a href="#cb21-710" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-711"><a href="#cb21-711" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: build-emof</span></span>
<span id="cb21-712"><a href="#cb21-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-713"><a href="#cb21-713" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Sample-level measurements (eventID, occurrenceID = NA) ----</span></span>
<span id="cb21-714"><a href="#cb21-714" aria-hidden="true" tabindex="-1"></a>d_sample_measurements <span class="ot">&lt;-</span> q_net_events_allflds <span class="sc">|&gt;</span></span>
<span id="cb21-715"><a href="#cb21-715" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb21-716"><a href="#cb21-716" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb21-717"><a href="#cb21-717" aria-hidden="true" tabindex="-1"></a>    std_haul_factor,</span>
<span id="cb21-718"><a href="#cb21-718" aria-hidden="true" tabindex="-1"></a>    prop_sorted,</span>
<span id="cb21-719"><a href="#cb21-719" aria-hidden="true" tabindex="-1"></a>    smallplankton,</span>
<span id="cb21-720"><a href="#cb21-720" aria-hidden="true" tabindex="-1"></a>    totalplankton</span>
<span id="cb21-721"><a href="#cb21-721" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> <span class="co"># vol_sampled_m3 moved to Event core</span></span>
<span id="cb21-722"><a href="#cb21-722" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb21-723"><a href="#cb21-723" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb21-724"><a href="#cb21-724" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(std_haul_factor, prop_sorted, smallplankton, totalplankton),</span>
<span id="cb21-725"><a href="#cb21-725" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"meas_type"</span>,</span>
<span id="cb21-726"><a href="#cb21-726" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"measurementValue"</span></span>
<span id="cb21-727"><a href="#cb21-727" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-728"><a href="#cb21-728" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(measurementValue)) <span class="sc">|&gt;</span></span>
<span id="cb21-729"><a href="#cb21-729" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-730"><a href="#cb21-730" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID =</span> <span class="fu">UUIDgenerate</span>(<span class="at">n =</span> <span class="fu">n</span>()),</span>
<span id="cb21-731"><a href="#cb21-731" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb21-732"><a href="#cb21-732" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType =</span> <span class="fu">case_when</span>(</span>
<span id="cb21-733"><a href="#cb21-733" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span> <span class="sc">~</span> <span class="st">"standardized haul factor"</span>,</span>
<span id="cb21-734"><a href="#cb21-734" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span> <span class="sc">~</span> <span class="st">"proportion of sample sorted"</span>,</span>
<span id="cb21-735"><a href="#cb21-735" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"smallplankton"</span> <span class="sc">~</span> <span class="st">"small plankton biomass"</span>,</span>
<span id="cb21-736"><a href="#cb21-736" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"totalplankton"</span> <span class="sc">~</span> <span class="st">"total plankton biomass"</span></span>
<span id="cb21-737"><a href="#cb21-737" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb21-738"><a href="#cb21-738" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID =</span> <span class="fu">case_when</span>(</span>
<span id="cb21-739"><a href="#cb21-739" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span> <span class="sc">~</span> <span class="cn">NA_character_</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for standardization factor</span></span>
<span id="cb21-740"><a href="#cb21-740" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span> <span class="sc">~</span> <span class="cn">NA_character_</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for subsample fraction</span></span>
<span id="cb21-741"><a href="#cb21-741" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"smallplankton"</span> <span class="sc">~</span> <span class="cn">NA_character_</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for zooplankton biomass</span></span>
<span id="cb21-742"><a href="#cb21-742" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"totalplankton"</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb21-743"><a href="#cb21-743" aria-hidden="true" tabindex="-1"></a>    ), <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for zooplankton biomass</span></span>
<span id="cb21-744"><a href="#cb21-744" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit =</span> <span class="fu">case_when</span>(</span>
<span id="cb21-745"><a href="#cb21-745" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span> <span class="sc">~</span> <span class="st">"dimensionless"</span>,</span>
<span id="cb21-746"><a href="#cb21-746" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span> <span class="sc">~</span> <span class="st">"dimensionless"</span>,</span>
<span id="cb21-747"><a href="#cb21-747" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"smallplankton"</span>, <span class="st">"totalplankton"</span>) <span class="sc">~</span> <span class="st">"grams"</span></span>
<span id="cb21-748"><a href="#cb21-748" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb21-749"><a href="#cb21-749" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb21-750"><a href="#cb21-750" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> <span class="fu">case_when</span>(</span>
<span id="cb21-751"><a href="#cb21-751" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span></span>
<span id="cb21-752"><a href="#cb21-752" aria-hidden="true" tabindex="-1"></a>        <span class="st">"std_haul_factor"</span> <span class="sc">~</span> <span class="st">"Standardization factor accounting for water filtered; abundances expressed as per 10 m² (Smith 1977)"</span>,</span>
<span id="cb21-753"><a href="#cb21-753" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span> <span class="sc">~</span> <span class="st">"Fraction of total sample examined"</span>,</span>
<span id="cb21-754"><a href="#cb21-754" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb21-755"><a href="#cb21-755" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-756"><a href="#cb21-756" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-757"><a href="#cb21-757" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-758"><a href="#cb21-758" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb21-759"><a href="#cb21-759" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb21-760"><a href="#cb21-760" aria-hidden="true" tabindex="-1"></a>    occurrenceID,</span>
<span id="cb21-761"><a href="#cb21-761" aria-hidden="true" tabindex="-1"></a>    measurementID,</span>
<span id="cb21-762"><a href="#cb21-762" aria-hidden="true" tabindex="-1"></a>    measurementType,</span>
<span id="cb21-763"><a href="#cb21-763" aria-hidden="true" tabindex="-1"></a>    measurementTypeID,</span>
<span id="cb21-764"><a href="#cb21-764" aria-hidden="true" tabindex="-1"></a>    measurementValue,</span>
<span id="cb21-765"><a href="#cb21-765" aria-hidden="true" tabindex="-1"></a>    measurementUnit,</span>
<span id="cb21-766"><a href="#cb21-766" aria-hidden="true" tabindex="-1"></a>    measurementUnitID,</span>
<span id="cb21-767"><a href="#cb21-767" aria-hidden="true" tabindex="-1"></a>    measurementMethod,</span>
<span id="cb21-768"><a href="#cb21-768" aria-hidden="true" tabindex="-1"></a>    measurementRemarks</span>
<span id="cb21-769"><a href="#cb21-769" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-770"><a href="#cb21-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-771"><a href="#cb21-771" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Stage-specific abundance (eventID = NA, occurrenceID) ----</span></span>
<span id="cb21-772"><a href="#cb21-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-773"><a href="#cb21-773" aria-hidden="true" tabindex="-1"></a><span class="co"># Egg stage abundances - need to join with egg occurrences to get occurrenceID</span></span>
<span id="cb21-774"><a href="#cb21-774" aria-hidden="true" tabindex="-1"></a>d_egg_stage_abundance <span class="ot">&lt;-</span> tbl_egg_stage <span class="sc">|&gt;</span></span>
<span id="cb21-775"><a href="#cb21-775" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb21-776"><a href="#cb21-776" aria-hidden="true" tabindex="-1"></a>    egg_stage_vocab <span class="sc">|&gt;</span></span>
<span id="cb21-777"><a href="#cb21-777" aria-hidden="true" tabindex="-1"></a>      <span class="fu">copy_to</span>(</span>
<span id="cb21-778"><a href="#cb21-778" aria-hidden="true" tabindex="-1"></a>        con,</span>
<span id="cb21-779"><a href="#cb21-779" aria-hidden="true" tabindex="-1"></a>        <span class="at">df =</span> _,</span>
<span id="cb21-780"><a href="#cb21-780" aria-hidden="true" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">"egg_stage_vocab_tmp"</span>,</span>
<span id="cb21-781"><a href="#cb21-781" aria-hidden="true" tabindex="-1"></a>        <span class="at">temporary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb21-782"><a href="#cb21-782" aria-hidden="true" tabindex="-1"></a>        <span class="at">overwrite =</span> T</span>
<span id="cb21-783"><a href="#cb21-783" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb21-784"><a href="#cb21-784" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"stage"</span></span>
<span id="cb21-785"><a href="#cb21-785" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-786"><a href="#cb21-786" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb21-787"><a href="#cb21-787" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb21-788"><a href="#cb21-788" aria-hidden="true" tabindex="-1"></a>    q_egg_occurrences <span class="sc">|&gt;</span></span>
<span id="cb21-789"><a href="#cb21-789" aria-hidden="true" tabindex="-1"></a>      <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb21-790"><a href="#cb21-790" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="at">net_uuid =</span> eventID, species_id, occurrenceID),</span>
<span id="cb21-791"><a href="#cb21-791" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"net_uuid"</span>, <span class="st">"species_id"</span>)</span>
<span id="cb21-792"><a href="#cb21-792" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-793"><a href="#cb21-793" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-794"><a href="#cb21-794" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb21-795"><a href="#cb21-795" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID =</span> <span class="fu">UUIDgenerate</span>(<span class="at">n =</span> <span class="fu">n</span>()),</span>
<span id="cb21-796"><a href="#cb21-796" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType =</span> <span class="st">"abundance by life stage"</span>,</span>
<span id="cb21-797"><a href="#cb21-797" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID =</span> <span class="cn">NA_character_</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for "abundance" + "development stage"</span></span>
<span id="cb21-798"><a href="#cb21-798" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue =</span> tally,</span>
<span id="cb21-799"><a href="#cb21-799" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValueID =</span> <span class="cn">NA_character_</span>, <span class="co"># Could reference custom vocabulary for egg stages</span></span>
<span id="cb21-800"><a href="#cb21-800" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit =</span> <span class="st">"individuals"</span>,</span>
<span id="cb21-801"><a href="#cb21-801" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb21-802"><a href="#cb21-802" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> stage_description</span>
<span id="cb21-803"><a href="#cb21-803" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-804"><a href="#cb21-804" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-805"><a href="#cb21-805" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb21-806"><a href="#cb21-806" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb21-807"><a href="#cb21-807" aria-hidden="true" tabindex="-1"></a>    occurrenceID,</span>
<span id="cb21-808"><a href="#cb21-808" aria-hidden="true" tabindex="-1"></a>    measurementID,</span>
<span id="cb21-809"><a href="#cb21-809" aria-hidden="true" tabindex="-1"></a>    measurementType,</span>
<span id="cb21-810"><a href="#cb21-810" aria-hidden="true" tabindex="-1"></a>    measurementTypeID,</span>
<span id="cb21-811"><a href="#cb21-811" aria-hidden="true" tabindex="-1"></a>    measurementValue,</span>
<span id="cb21-812"><a href="#cb21-812" aria-hidden="true" tabindex="-1"></a>    measurementValueID,</span>
<span id="cb21-813"><a href="#cb21-813" aria-hidden="true" tabindex="-1"></a>    <span class="co">#measurementUnit, measurementUnitID = measurementUnitID.y, measurementMethod,</span></span>
<span id="cb21-814"><a href="#cb21-814" aria-hidden="true" tabindex="-1"></a>    measurementUnit,</span>
<span id="cb21-815"><a href="#cb21-815" aria-hidden="true" tabindex="-1"></a>    measurementUnitID,</span>
<span id="cb21-816"><a href="#cb21-816" aria-hidden="true" tabindex="-1"></a>    measurementMethod,</span>
<span id="cb21-817"><a href="#cb21-817" aria-hidden="true" tabindex="-1"></a>    measurementRemarks</span>
<span id="cb21-818"><a href="#cb21-818" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-819"><a href="#cb21-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-820"><a href="#cb21-820" aria-hidden="true" tabindex="-1"></a><span class="co"># Larva stage abundances - need to join with larva occurrences to get occurrenceID</span></span>
<span id="cb21-821"><a href="#cb21-821" aria-hidden="true" tabindex="-1"></a>d_larva_stage_abundance <span class="ot">&lt;-</span> tbl_larva_stage <span class="sc">|&gt;</span></span>
<span id="cb21-822"><a href="#cb21-822" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb21-823"><a href="#cb21-823" aria-hidden="true" tabindex="-1"></a>    larva_stage_vocab <span class="sc">|&gt;</span></span>
<span id="cb21-824"><a href="#cb21-824" aria-hidden="true" tabindex="-1"></a>      <span class="fu">copy_to</span>(</span>
<span id="cb21-825"><a href="#cb21-825" aria-hidden="true" tabindex="-1"></a>        con,</span>
<span id="cb21-826"><a href="#cb21-826" aria-hidden="true" tabindex="-1"></a>        <span class="at">df =</span> _,</span>
<span id="cb21-827"><a href="#cb21-827" aria-hidden="true" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">"larva_stage_vocab_tmp"</span>,</span>
<span id="cb21-828"><a href="#cb21-828" aria-hidden="true" tabindex="-1"></a>        <span class="at">temporary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb21-829"><a href="#cb21-829" aria-hidden="true" tabindex="-1"></a>        <span class="at">overwrite =</span> T</span>
<span id="cb21-830"><a href="#cb21-830" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb21-831"><a href="#cb21-831" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"stage"</span></span>
<span id="cb21-832"><a href="#cb21-832" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-833"><a href="#cb21-833" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb21-834"><a href="#cb21-834" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb21-835"><a href="#cb21-835" aria-hidden="true" tabindex="-1"></a>    q_larva_occurrences <span class="sc">|&gt;</span></span>
<span id="cb21-836"><a href="#cb21-836" aria-hidden="true" tabindex="-1"></a>      <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb21-837"><a href="#cb21-837" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="at">net_uuid =</span> eventID, species_id, occurrenceID),</span>
<span id="cb21-838"><a href="#cb21-838" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"net_uuid"</span>, <span class="st">"species_id"</span>)</span>
<span id="cb21-839"><a href="#cb21-839" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-840"><a href="#cb21-840" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-841"><a href="#cb21-841" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb21-842"><a href="#cb21-842" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID =</span> <span class="fu">UUIDgenerate</span>(<span class="at">n =</span> <span class="fu">n</span>()),</span>
<span id="cb21-843"><a href="#cb21-843" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType =</span> <span class="st">"abundance by life stage"</span>,</span>
<span id="cb21-844"><a href="#cb21-844" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID =</span> <span class="cn">NA_character_</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for "abundance" + "development stage"</span></span>
<span id="cb21-845"><a href="#cb21-845" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue =</span> tally,</span>
<span id="cb21-846"><a href="#cb21-846" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValueID =</span> <span class="cn">NA_character_</span>, <span class="co"># Could reference custom vocabulary for larva stages</span></span>
<span id="cb21-847"><a href="#cb21-847" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit =</span> <span class="st">"individuals"</span>,</span>
<span id="cb21-848"><a href="#cb21-848" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb21-849"><a href="#cb21-849" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> stage_description</span>
<span id="cb21-850"><a href="#cb21-850" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-851"><a href="#cb21-851" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-852"><a href="#cb21-852" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb21-853"><a href="#cb21-853" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb21-854"><a href="#cb21-854" aria-hidden="true" tabindex="-1"></a>    occurrenceID,</span>
<span id="cb21-855"><a href="#cb21-855" aria-hidden="true" tabindex="-1"></a>    measurementID,</span>
<span id="cb21-856"><a href="#cb21-856" aria-hidden="true" tabindex="-1"></a>    measurementType,</span>
<span id="cb21-857"><a href="#cb21-857" aria-hidden="true" tabindex="-1"></a>    measurementTypeID,</span>
<span id="cb21-858"><a href="#cb21-858" aria-hidden="true" tabindex="-1"></a>    measurementValue,</span>
<span id="cb21-859"><a href="#cb21-859" aria-hidden="true" tabindex="-1"></a>    measurementValueID,</span>
<span id="cb21-860"><a href="#cb21-860" aria-hidden="true" tabindex="-1"></a>    measurementUnit,</span>
<span id="cb21-861"><a href="#cb21-861" aria-hidden="true" tabindex="-1"></a>    measurementUnitID,</span>
<span id="cb21-862"><a href="#cb21-862" aria-hidden="true" tabindex="-1"></a>    measurementMethod,</span>
<span id="cb21-863"><a href="#cb21-863" aria-hidden="true" tabindex="-1"></a>    measurementRemarks</span>
<span id="cb21-864"><a href="#cb21-864" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-865"><a href="#cb21-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-866"><a href="#cb21-866" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Body length measurements (eventID = NA, occurrenceID) ----</span></span>
<span id="cb21-867"><a href="#cb21-867" aria-hidden="true" tabindex="-1"></a>d_body_length <span class="ot">&lt;-</span> tbl_larva_size <span class="sc">|&gt;</span></span>
<span id="cb21-868"><a href="#cb21-868" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb21-869"><a href="#cb21-869" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb21-870"><a href="#cb21-870" aria-hidden="true" tabindex="-1"></a>    q_larva_occurrences <span class="sc">|&gt;</span></span>
<span id="cb21-871"><a href="#cb21-871" aria-hidden="true" tabindex="-1"></a>      <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb21-872"><a href="#cb21-872" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="at">net_uuid =</span> eventID, species_id, occurrenceID),</span>
<span id="cb21-873"><a href="#cb21-873" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"net_uuid"</span>, <span class="st">"species_id"</span>)</span>
<span id="cb21-874"><a href="#cb21-874" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-875"><a href="#cb21-875" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(length_mm)) <span class="sc">|&gt;</span></span>
<span id="cb21-876"><a href="#cb21-876" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-877"><a href="#cb21-877" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb21-878"><a href="#cb21-878" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID =</span> <span class="fu">UUIDgenerate</span>(<span class="at">n =</span> <span class="fu">n</span>()),</span>
<span id="cb21-879"><a href="#cb21-879" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType =</span> <span class="st">"body length"</span>,</span>
<span id="cb21-880"><a href="#cb21-880" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID =</span> <span class="cn">NA_character_</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for fish larvae body length (e.g., OBSINDLX)</span></span>
<span id="cb21-881"><a href="#cb21-881" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue =</span> length_mm,</span>
<span id="cb21-882"><a href="#cb21-882" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValueID =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb21-883"><a href="#cb21-883" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit =</span> <span class="st">"millimeters"</span>,</span>
<span id="cb21-884"><a href="#cb21-884" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb21-885"><a href="#cb21-885" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> <span class="fu">paste0</span>(<span class="st">"Count: "</span>, tally, <span class="st">"; Total length measurement"</span>)</span>
<span id="cb21-886"><a href="#cb21-886" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-887"><a href="#cb21-887" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-888"><a href="#cb21-888" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb21-889"><a href="#cb21-889" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb21-890"><a href="#cb21-890" aria-hidden="true" tabindex="-1"></a>    occurrenceID,</span>
<span id="cb21-891"><a href="#cb21-891" aria-hidden="true" tabindex="-1"></a>    measurementID,</span>
<span id="cb21-892"><a href="#cb21-892" aria-hidden="true" tabindex="-1"></a>    measurementType,</span>
<span id="cb21-893"><a href="#cb21-893" aria-hidden="true" tabindex="-1"></a>    measurementTypeID,</span>
<span id="cb21-894"><a href="#cb21-894" aria-hidden="true" tabindex="-1"></a>    measurementValue,</span>
<span id="cb21-895"><a href="#cb21-895" aria-hidden="true" tabindex="-1"></a>    measurementValueID,</span>
<span id="cb21-896"><a href="#cb21-896" aria-hidden="true" tabindex="-1"></a>    measurementUnit,</span>
<span id="cb21-897"><a href="#cb21-897" aria-hidden="true" tabindex="-1"></a>    measurementUnitID,</span>
<span id="cb21-898"><a href="#cb21-898" aria-hidden="true" tabindex="-1"></a>    measurementMethod,</span>
<span id="cb21-899"><a href="#cb21-899" aria-hidden="true" tabindex="-1"></a>    measurementRemarks</span>
<span id="cb21-900"><a href="#cb21-900" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-901"><a href="#cb21-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-902"><a href="#cb21-902" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all eMoF records ----</span></span>
<span id="cb21-903"><a href="#cb21-903" aria-hidden="true" tabindex="-1"></a>d_extendedmeasurementorfact_extension <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb21-904"><a href="#cb21-904" aria-hidden="true" tabindex="-1"></a>  d_sample_measurements,</span>
<span id="cb21-905"><a href="#cb21-905" aria-hidden="true" tabindex="-1"></a>  d_egg_stage_abundance,</span>
<span id="cb21-906"><a href="#cb21-906" aria-hidden="true" tabindex="-1"></a>  d_larva_stage_abundance,</span>
<span id="cb21-907"><a href="#cb21-907" aria-hidden="true" tabindex="-1"></a>  d_body_length</span>
<span id="cb21-908"><a href="#cb21-908" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-909"><a href="#cb21-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-910"><a href="#cb21-910" aria-hidden="true" tabindex="-1"></a><span class="co"># table(is.na(d_extendedmeasurementorfact_extension$occurrenceID))</span></span>
<span id="cb21-911"><a href="#cb21-911" aria-hidden="true" tabindex="-1"></a><span class="co">#   FALSE    TRUE</span></span>
<span id="cb21-912"><a href="#cb21-912" aria-hidden="true" tabindex="-1"></a><span class="co"># 367,218 243,598</span></span>
<span id="cb21-913"><a href="#cb21-913" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb21-914"><a href="#cb21-914" aria-hidden="true" tabindex="-1"></a><span class="co"># table(is.na(d_extendedmeasurementorfact_extension$eventID))</span></span>
<span id="cb21-915"><a href="#cb21-915" aria-hidden="true" tabindex="-1"></a><span class="co">#   FALSE    TRUE</span></span>
<span id="cb21-916"><a href="#cb21-916" aria-hidden="true" tabindex="-1"></a><span class="co"># 243,598 367,218</span></span>
<span id="cb21-917"><a href="#cb21-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-918"><a href="#cb21-918" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-919"><a href="#cb21-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-920"><a href="#cb21-920" aria-hidden="true" tabindex="-1"></a><span class="fu">## Write DarwinCore Archive Files</span></span>
<span id="cb21-921"><a href="#cb21-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-922"><a href="#cb21-922" aria-hidden="true" tabindex="-1"></a>Export the event core and extension files (occurrence, eMoF) as CSV files:</span>
<span id="cb21-923"><a href="#cb21-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-926"><a href="#cb21-926" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-927"><a href="#cb21-927" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: export-dwc</span></span>
<span id="cb21-928"><a href="#cb21-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-929"><a href="#cb21-929" aria-hidden="true" tabindex="-1"></a><span class="co"># Create output directory</span></span>
<span id="cb21-930"><a href="#cb21-930" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(dir_out, <span class="at">showWarnings =</span> F)</span>
<span id="cb21-931"><a href="#cb21-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-932"><a href="#cb21-932" aria-hidden="true" tabindex="-1"></a><span class="co"># Write core and extension files</span></span>
<span id="cb21-933"><a href="#cb21-933" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(q_event_core <span class="sc">|&gt;</span> <span class="fu">collect</span>(), <span class="fu">file.path</span>(dir_out, <span class="st">"event.csv"</span>))</span>
<span id="cb21-934"><a href="#cb21-934" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(</span>
<span id="cb21-935"><a href="#cb21-935" aria-hidden="true" tabindex="-1"></a>  q_occurrence_extension <span class="sc">|&gt;</span> <span class="fu">collect</span>(),</span>
<span id="cb21-936"><a href="#cb21-936" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(dir_out, <span class="st">"occurrence.csv"</span>)</span>
<span id="cb21-937"><a href="#cb21-937" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-938"><a href="#cb21-938" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(</span>
<span id="cb21-939"><a href="#cb21-939" aria-hidden="true" tabindex="-1"></a>  d_extendedmeasurementorfact_extension,</span>
<span id="cb21-940"><a href="#cb21-940" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(dir_out, <span class="st">"extendedMeasurementOrFact.csv"</span>)</span>
<span id="cb21-941"><a href="#cb21-941" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-942"><a href="#cb21-942" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-943"><a href="#cb21-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-944"><a href="#cb21-944" aria-hidden="true" tabindex="-1"></a><span class="fu">## Create meta.xml programmatically by cross-walking CSV fields to DwC terms</span></span>
<span id="cb21-945"><a href="#cb21-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-946"><a href="#cb21-946" aria-hidden="true" tabindex="-1"></a>Generate <span class="in">`meta.xml`</span> by mapping CSV column names to DarwinCore term URIs:</span>
<span id="cb21-947"><a href="#cb21-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-950"><a href="#cb21-950" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-951"><a href="#cb21-951" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: create-meta-xml</span></span>
<span id="cb21-952"><a href="#cb21-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-953"><a href="#cb21-953" aria-hidden="true" tabindex="-1"></a><span class="co"># Define DarwinCore term mappings for each file type</span></span>
<span id="cb21-954"><a href="#cb21-954" aria-hidden="true" tabindex="-1"></a>dwc_terms <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb21-955"><a href="#cb21-955" aria-hidden="true" tabindex="-1"></a>  <span class="at">event =</span> <span class="fu">list</span>(</span>
<span id="cb21-956"><a href="#cb21-956" aria-hidden="true" tabindex="-1"></a>    <span class="at">rowType =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/Event"</span>,</span>
<span id="cb21-957"><a href="#cb21-957" aria-hidden="true" tabindex="-1"></a>    <span class="at">idField =</span> <span class="st">"eventID"</span>,</span>
<span id="cb21-958"><a href="#cb21-958" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms =</span> <span class="fu">c</span>(</span>
<span id="cb21-959"><a href="#cb21-959" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventID"</span>,</span>
<span id="cb21-960"><a href="#cb21-960" aria-hidden="true" tabindex="-1"></a>      <span class="at">parentEventID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/parentEventID"</span>,</span>
<span id="cb21-961"><a href="#cb21-961" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventType =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventType"</span>,</span>
<span id="cb21-962"><a href="#cb21-962" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventDate =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventDate"</span>,</span>
<span id="cb21-963"><a href="#cb21-963" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventTime =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventTime"</span>,</span>
<span id="cb21-964"><a href="#cb21-964" aria-hidden="true" tabindex="-1"></a>      <span class="at">samplingProtocol =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/samplingProtocol"</span>,</span>
<span id="cb21-965"><a href="#cb21-965" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeValue =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/sampleSizeValue"</span>,</span>
<span id="cb21-966"><a href="#cb21-966" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeUnit =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/sampleSizeUnit"</span>,</span>
<span id="cb21-967"><a href="#cb21-967" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventRemarks =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventRemarks"</span>,</span>
<span id="cb21-968"><a href="#cb21-968" aria-hidden="true" tabindex="-1"></a>      <span class="at">habitat =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/habitat"</span>,</span>
<span id="cb21-969"><a href="#cb21-969" aria-hidden="true" tabindex="-1"></a>      <span class="at">decimalLatitude =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/decimalLatitude"</span>,</span>
<span id="cb21-970"><a href="#cb21-970" aria-hidden="true" tabindex="-1"></a>      <span class="at">decimalLongitude =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/decimalLongitude"</span>,</span>
<span id="cb21-971"><a href="#cb21-971" aria-hidden="true" tabindex="-1"></a>      <span class="at">geodeticDatum =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/geodeticDatum"</span>,</span>
<span id="cb21-972"><a href="#cb21-972" aria-hidden="true" tabindex="-1"></a>      <span class="at">coordinateUncertaintyInMeters =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/coordinateUncertaintyInMeters"</span>,</span>
<span id="cb21-973"><a href="#cb21-973" aria-hidden="true" tabindex="-1"></a>      <span class="at">locationID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/locationID"</span>,</span>
<span id="cb21-974"><a href="#cb21-974" aria-hidden="true" tabindex="-1"></a>      <span class="at">countryCode =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/countryCode"</span>,</span>
<span id="cb21-975"><a href="#cb21-975" aria-hidden="true" tabindex="-1"></a>      <span class="at">waterBody =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/waterBody"</span>,</span>
<span id="cb21-976"><a href="#cb21-976" aria-hidden="true" tabindex="-1"></a>      <span class="at">datasetID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/datasetID"</span></span>
<span id="cb21-977"><a href="#cb21-977" aria-hidden="true" tabindex="-1"></a>      <span class="co"># basisOfRecord                 = "http://rs.tdwg.org/dwc/terms/basisOfRecord"</span></span>
<span id="cb21-978"><a href="#cb21-978" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-979"><a href="#cb21-979" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb21-980"><a href="#cb21-980" aria-hidden="true" tabindex="-1"></a>  <span class="at">occurrence =</span> <span class="fu">list</span>(</span>
<span id="cb21-981"><a href="#cb21-981" aria-hidden="true" tabindex="-1"></a>    <span class="at">rowType =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/Occurrence"</span>,</span>
<span id="cb21-982"><a href="#cb21-982" aria-hidden="true" tabindex="-1"></a>    <span class="at">idField =</span> <span class="st">"occurrenceID"</span>,</span>
<span id="cb21-983"><a href="#cb21-983" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreIdField =</span> <span class="st">"eventID"</span>,</span>
<span id="cb21-984"><a href="#cb21-984" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms =</span> <span class="fu">c</span>(</span>
<span id="cb21-985"><a href="#cb21-985" aria-hidden="true" tabindex="-1"></a>      <span class="at">occurrenceID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceID"</span>,</span>
<span id="cb21-986"><a href="#cb21-986" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventID"</span>,</span>
<span id="cb21-987"><a href="#cb21-987" aria-hidden="true" tabindex="-1"></a>      <span class="at">scientificName =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/scientificName"</span>,</span>
<span id="cb21-988"><a href="#cb21-988" aria-hidden="true" tabindex="-1"></a>      <span class="at">scientificNameID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/scientificNameID"</span>,</span>
<span id="cb21-989"><a href="#cb21-989" aria-hidden="true" tabindex="-1"></a>      <span class="at">kingdom =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/kingdom"</span>,</span>
<span id="cb21-990"><a href="#cb21-990" aria-hidden="true" tabindex="-1"></a>      <span class="at">occurrenceStatus =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceStatus"</span>,</span>
<span id="cb21-991"><a href="#cb21-991" aria-hidden="true" tabindex="-1"></a>      <span class="at">organismQuantity =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/organismQuantity"</span>,</span>
<span id="cb21-992"><a href="#cb21-992" aria-hidden="true" tabindex="-1"></a>      <span class="at">organismQuantityType =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/organismQuantityType"</span>,</span>
<span id="cb21-993"><a href="#cb21-993" aria-hidden="true" tabindex="-1"></a>      <span class="at">lifeStage =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/lifeStage"</span>,</span>
<span id="cb21-994"><a href="#cb21-994" aria-hidden="true" tabindex="-1"></a>      <span class="co"># lifeStageID          = "http://rs.tdwg.org/dwc/terms/lifeStageID",</span></span>
<span id="cb21-995"><a href="#cb21-995" aria-hidden="true" tabindex="-1"></a>      <span class="at">preparations =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/preparations"</span>,</span>
<span id="cb21-996"><a href="#cb21-996" aria-hidden="true" tabindex="-1"></a>      <span class="at">basisOfRecord =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/basisOfRecord"</span>,</span>
<span id="cb21-997"><a href="#cb21-997" aria-hidden="true" tabindex="-1"></a>      <span class="at">modified =</span> <span class="st">"http://purl.org/dc/terms/modified"</span></span>
<span id="cb21-998"><a href="#cb21-998" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-999"><a href="#cb21-999" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb21-1000"><a href="#cb21-1000" aria-hidden="true" tabindex="-1"></a>  <span class="at">extendedmeasurementorfact =</span> <span class="fu">list</span>(</span>
<span id="cb21-1001"><a href="#cb21-1001" aria-hidden="true" tabindex="-1"></a>    <span class="at">rowType =</span> <span class="st">"http://rs.iobis.org/obis/terms/ExtendedMeasurementOrFact"</span>,</span>
<span id="cb21-1002"><a href="#cb21-1002" aria-hidden="true" tabindex="-1"></a>    <span class="at">idField =</span> <span class="st">"measurementID"</span>,</span>
<span id="cb21-1003"><a href="#cb21-1003" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreIdField =</span> <span class="st">"eventID"</span>, <span class="co"># Primary linking field</span></span>
<span id="cb21-1004"><a href="#cb21-1004" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms =</span> <span class="fu">c</span>(</span>
<span id="cb21-1005"><a href="#cb21-1005" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventID"</span>,</span>
<span id="cb21-1006"><a href="#cb21-1006" aria-hidden="true" tabindex="-1"></a>      <span class="at">occurrenceID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceID"</span>,</span>
<span id="cb21-1007"><a href="#cb21-1007" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementID =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementID"</span>,</span>
<span id="cb21-1008"><a href="#cb21-1008" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementType =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementType"</span>,</span>
<span id="cb21-1009"><a href="#cb21-1009" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementTypeID =</span> <span class="st">"http://rs.iobis.org/obis/terms/measurementTypeID"</span>,</span>
<span id="cb21-1010"><a href="#cb21-1010" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementValue =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementValue"</span>,</span>
<span id="cb21-1011"><a href="#cb21-1011" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementValueID =</span> <span class="st">"http://rs.iobis.org/obis/terms/measurementValueID"</span>,</span>
<span id="cb21-1012"><a href="#cb21-1012" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementUnit =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementUnit"</span>,</span>
<span id="cb21-1013"><a href="#cb21-1013" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementUnitID =</span> <span class="st">"http://rs.iobis.org/obis/terms/measurementUnitID"</span>,</span>
<span id="cb21-1014"><a href="#cb21-1014" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementMethod =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementMethod"</span>,</span>
<span id="cb21-1015"><a href="#cb21-1015" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementRemarks =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementRemarks"</span></span>
<span id="cb21-1016"><a href="#cb21-1016" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-1017"><a href="#cb21-1017" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-1018"><a href="#cb21-1018" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-1019"><a href="#cb21-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1020"><a href="#cb21-1020" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to create field elements for meta.xml</span></span>
<span id="cb21-1021"><a href="#cb21-1021" aria-hidden="true" tabindex="-1"></a>create_field_elements <span class="ot">&lt;-</span> <span class="cf">function</span>(csv_file, term_map, <span class="at">coreid_field =</span> <span class="cn">NULL</span>) {</span>
<span id="cb21-1022"><a href="#cb21-1022" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read column names from CSV</span></span>
<span id="cb21-1023"><a href="#cb21-1023" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">read_csv</span>(csv_file, <span class="at">n_max =</span> <span class="dv">0</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>))</span>
<span id="cb21-1024"><a href="#cb21-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1025"><a href="#cb21-1025" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Map columns to DwC terms</span></span>
<span id="cb21-1026"><a href="#cb21-1026" aria-hidden="true" tabindex="-1"></a>  field_elements <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="fu">seq_along</span>(col_names), <span class="cf">function</span>(i) {</span>
<span id="cb21-1027"><a href="#cb21-1027" aria-hidden="true" tabindex="-1"></a>    col <span class="ot">&lt;-</span> col_names[i]</span>
<span id="cb21-1028"><a href="#cb21-1028" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1029"><a href="#cb21-1029" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skip coreid column if specified (it's defined separately in &lt;coreid&gt; element)</span></span>
<span id="cb21-1030"><a href="#cb21-1030" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(coreid_field) <span class="sc">&amp;&amp;</span> col <span class="sc">==</span> coreid_field) {</span>
<span id="cb21-1031"><a href="#cb21-1031" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb21-1032"><a href="#cb21-1032" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-1033"><a href="#cb21-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1034"><a href="#cb21-1034" aria-hidden="true" tabindex="-1"></a>    term <span class="ot">&lt;-</span> term_map<span class="sc">$</span>terms[[col]]</span>
<span id="cb21-1035"><a href="#cb21-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1036"><a href="#cb21-1036" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(term)) {</span>
<span id="cb21-1037"><a href="#cb21-1037" aria-hidden="true" tabindex="-1"></a>      glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'    &lt;field index="{i-1}" term="{term}"/&gt;'</span>)</span>
<span id="cb21-1038"><a href="#cb21-1038" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb21-1039"><a href="#cb21-1039" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Field exists in CSV but not in DwC mapping - skip or warn</span></span>
<span id="cb21-1040"><a href="#cb21-1040" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(</span>
<span id="cb21-1041"><a href="#cb21-1041" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Warning: Column '"</span>,</span>
<span id="cb21-1042"><a href="#cb21-1042" aria-hidden="true" tabindex="-1"></a>        col,</span>
<span id="cb21-1043"><a href="#cb21-1043" aria-hidden="true" tabindex="-1"></a>        <span class="st">"' in "</span>,</span>
<span id="cb21-1044"><a href="#cb21-1044" aria-hidden="true" tabindex="-1"></a>        csv_file,</span>
<span id="cb21-1045"><a href="#cb21-1045" aria-hidden="true" tabindex="-1"></a>        <span class="st">" has no DwC mapping and will be skipped in meta.xml."</span></span>
<span id="cb21-1046"><a href="#cb21-1046" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb21-1047"><a href="#cb21-1047" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NULL</span></span>
<span id="cb21-1048"><a href="#cb21-1048" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-1049"><a href="#cb21-1049" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb21-1050"><a href="#cb21-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1051"><a href="#cb21-1051" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove NULL entries and combine</span></span>
<span id="cb21-1052"><a href="#cb21-1052" aria-hidden="true" tabindex="-1"></a>  field_elements <span class="ot">&lt;-</span> <span class="fu">compact</span>(field_elements)</span>
<span id="cb21-1053"><a href="#cb21-1053" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(field_elements, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-1054"><a href="#cb21-1054" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-1055"><a href="#cb21-1055" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1056"><a href="#cb21-1056" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to determine coreID index</span></span>
<span id="cb21-1057"><a href="#cb21-1057" aria-hidden="true" tabindex="-1"></a>get_coreid_index <span class="ot">&lt;-</span> <span class="cf">function</span>(csv_file, coreid_field) {</span>
<span id="cb21-1058"><a href="#cb21-1058" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">read_csv</span>(csv_file, <span class="at">n_max =</span> <span class="dv">0</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>))</span>
<span id="cb21-1059"><a href="#cb21-1059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1060"><a href="#cb21-1060" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Handle multiple possible coreID fields (eventID or occurrenceID)</span></span>
<span id="cb21-1061"><a href="#cb21-1061" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coreid_field) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb21-1062"><a href="#cb21-1062" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find which one exists in the CSV</span></span>
<span id="cb21-1063"><a href="#cb21-1063" aria-hidden="true" tabindex="-1"></a>    coreid_field <span class="ot">&lt;-</span> <span class="fu">intersect</span>(coreid_field, col_names)[<span class="dv">1</span>]</span>
<span id="cb21-1064"><a href="#cb21-1064" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-1065"><a href="#cb21-1065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1066"><a href="#cb21-1066" aria-hidden="true" tabindex="-1"></a>  <span class="fu">which</span>(col_names <span class="sc">==</span> coreid_field) <span class="sc">-</span> <span class="dv">1</span> <span class="co"># 0-indexed</span></span>
<span id="cb21-1067"><a href="#cb21-1067" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-1068"><a href="#cb21-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1069"><a href="#cb21-1069" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate meta.xml content</span></span>
<span id="cb21-1070"><a href="#cb21-1070" aria-hidden="true" tabindex="-1"></a>generate_meta_xml <span class="ot">&lt;-</span> <span class="cf">function</span>(dir_out) {</span>
<span id="cb21-1071"><a href="#cb21-1071" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Core (Event)</span></span>
<span id="cb21-1072"><a href="#cb21-1072" aria-hidden="true" tabindex="-1"></a>  event_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"event.csv"</span>)</span>
<span id="cb21-1073"><a href="#cb21-1073" aria-hidden="true" tabindex="-1"></a>  event_fields <span class="ot">&lt;-</span> <span class="fu">create_field_elements</span>(event_file, dwc_terms<span class="sc">$</span>event)</span>
<span id="cb21-1074"><a href="#cb21-1074" aria-hidden="true" tabindex="-1"></a>  event_id_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(</span>
<span id="cb21-1075"><a href="#cb21-1075" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(<span class="fu">read_csv</span>(event_file, <span class="at">n_max =</span> <span class="dv">0</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)) <span class="sc">==</span></span>
<span id="cb21-1076"><a href="#cb21-1076" aria-hidden="true" tabindex="-1"></a>      dwc_terms<span class="sc">$</span>event<span class="sc">$</span>idField</span>
<span id="cb21-1077"><a href="#cb21-1077" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">-</span></span>
<span id="cb21-1078"><a href="#cb21-1078" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span></span>
<span id="cb21-1079"><a href="#cb21-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1080"><a href="#cb21-1080" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extension: Occurrence</span></span>
<span id="cb21-1081"><a href="#cb21-1081" aria-hidden="true" tabindex="-1"></a>  occ_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"occurrence.csv"</span>)</span>
<span id="cb21-1082"><a href="#cb21-1082" aria-hidden="true" tabindex="-1"></a>  occ_fields <span class="ot">&lt;-</span> <span class="fu">create_field_elements</span>(</span>
<span id="cb21-1083"><a href="#cb21-1083" aria-hidden="true" tabindex="-1"></a>    occ_file,</span>
<span id="cb21-1084"><a href="#cb21-1084" aria-hidden="true" tabindex="-1"></a>    dwc_terms<span class="sc">$</span>occurrence,</span>
<span id="cb21-1085"><a href="#cb21-1085" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreid_field =</span> dwc_terms<span class="sc">$</span>occurrence<span class="sc">$</span>coreIdField</span>
<span id="cb21-1086"><a href="#cb21-1086" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-1087"><a href="#cb21-1087" aria-hidden="true" tabindex="-1"></a>  occ_coreid_idx <span class="ot">&lt;-</span> <span class="fu">get_coreid_index</span>(occ_file, dwc_terms<span class="sc">$</span>occurrence<span class="sc">$</span>coreIdField)</span>
<span id="cb21-1088"><a href="#cb21-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1089"><a href="#cb21-1089" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extension: ExtendedMeasurementOrFact</span></span>
<span id="cb21-1090"><a href="#cb21-1090" aria-hidden="true" tabindex="-1"></a>  emof_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"extendedMeasurementOrFact.csv"</span>)</span>
<span id="cb21-1091"><a href="#cb21-1091" aria-hidden="true" tabindex="-1"></a>  emof_fields <span class="ot">&lt;-</span> <span class="fu">create_field_elements</span>(</span>
<span id="cb21-1092"><a href="#cb21-1092" aria-hidden="true" tabindex="-1"></a>    emof_file,</span>
<span id="cb21-1093"><a href="#cb21-1093" aria-hidden="true" tabindex="-1"></a>    dwc_terms<span class="sc">$</span>extendedmeasurementorfact,</span>
<span id="cb21-1094"><a href="#cb21-1094" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreid_field =</span> dwc_terms<span class="sc">$</span>extendedmeasurementorfact<span class="sc">$</span>coreIdField</span>
<span id="cb21-1095"><a href="#cb21-1095" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-1096"><a href="#cb21-1096" aria-hidden="true" tabindex="-1"></a>  emof_coreid_idx <span class="ot">&lt;-</span> <span class="fu">get_coreid_index</span>(</span>
<span id="cb21-1097"><a href="#cb21-1097" aria-hidden="true" tabindex="-1"></a>    emof_file,</span>
<span id="cb21-1098"><a href="#cb21-1098" aria-hidden="true" tabindex="-1"></a>    dwc_terms<span class="sc">$</span>extendedmeasurementorfact<span class="sc">$</span>coreIdField</span>
<span id="cb21-1099"><a href="#cb21-1099" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-1100"><a href="#cb21-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1101"><a href="#cb21-1101" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build complete meta.xml</span></span>
<span id="cb21-1102"><a href="#cb21-1102" aria-hidden="true" tabindex="-1"></a>  meta_xml <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb21-1103"><a href="#cb21-1103" aria-hidden="true" tabindex="-1"></a>    <span class="st">'&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span>
<span id="cb21-1104"><a href="#cb21-1104" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;archive xmlns="http://rs.tdwg.org/dwc/text/"</span></span>
<span id="cb21-1105"><a href="#cb21-1105" aria-hidden="true" tabindex="-1"></a><span class="st">         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</span></span>
<span id="cb21-1106"><a href="#cb21-1106" aria-hidden="true" tabindex="-1"></a><span class="st">         xsi:schemaLocation="http://rs.tdwg.org/dwc/text/ http://rs.tdwg.org/dwc/text/tdwg_dwc_text.xsd"&gt;</span></span>
<span id="cb21-1107"><a href="#cb21-1107" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;core encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="</span><span class="sc">\\</span><span class="st">n"</span></span>
<span id="cb21-1108"><a href="#cb21-1108" aria-hidden="true" tabindex="-1"></a><span class="st">        fieldsEnclosedBy=</span><span class="sc">\'</span><span class="st">"</span><span class="sc">\'</span><span class="st"> ignoreHeaderLines="1" rowType="{dwc_terms$event$rowType}"&gt;</span></span>
<span id="cb21-1109"><a href="#cb21-1109" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;files&gt;</span></span>
<span id="cb21-1110"><a href="#cb21-1110" aria-hidden="true" tabindex="-1"></a><span class="st">      &lt;location&gt;event.csv&lt;/location&gt;</span></span>
<span id="cb21-1111"><a href="#cb21-1111" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/files&gt;</span></span>
<span id="cb21-1112"><a href="#cb21-1112" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;id index="{event_id_idx}" /&gt;</span></span>
<span id="cb21-1113"><a href="#cb21-1113" aria-hidden="true" tabindex="-1"></a><span class="st">{event_fields}</span></span>
<span id="cb21-1114"><a href="#cb21-1114" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;/core&gt;</span></span>
<span id="cb21-1115"><a href="#cb21-1115" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="</span><span class="sc">\\</span><span class="st">n"</span></span>
<span id="cb21-1116"><a href="#cb21-1116" aria-hidden="true" tabindex="-1"></a><span class="st">             fieldsEnclosedBy=</span><span class="sc">\'</span><span class="st">"</span><span class="sc">\'</span><span class="st"> ignoreHeaderLines="1" rowType="{dwc_terms$occurrence$rowType}"&gt;</span></span>
<span id="cb21-1117"><a href="#cb21-1117" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;files&gt;</span></span>
<span id="cb21-1118"><a href="#cb21-1118" aria-hidden="true" tabindex="-1"></a><span class="st">      &lt;location&gt;occurrence.csv&lt;/location&gt;</span></span>
<span id="cb21-1119"><a href="#cb21-1119" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/files&gt;</span></span>
<span id="cb21-1120"><a href="#cb21-1120" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;coreid index="{occ_coreid_idx}" /&gt;</span></span>
<span id="cb21-1121"><a href="#cb21-1121" aria-hidden="true" tabindex="-1"></a><span class="st">{occ_fields}</span></span>
<span id="cb21-1122"><a href="#cb21-1122" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;/extension&gt;</span></span>
<span id="cb21-1123"><a href="#cb21-1123" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="</span><span class="sc">\\</span><span class="st">n"</span></span>
<span id="cb21-1124"><a href="#cb21-1124" aria-hidden="true" tabindex="-1"></a><span class="st">             fieldsEnclosedBy=</span><span class="sc">\'</span><span class="st">"</span><span class="sc">\'</span><span class="st"> ignoreHeaderLines="1" rowType="{dwc_terms$extendedmeasurementorfact$rowType}"&gt;</span></span>
<span id="cb21-1125"><a href="#cb21-1125" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;files&gt;</span></span>
<span id="cb21-1126"><a href="#cb21-1126" aria-hidden="true" tabindex="-1"></a><span class="st">      &lt;location&gt;extendedMeasurementOrFact.csv&lt;/location&gt;</span></span>
<span id="cb21-1127"><a href="#cb21-1127" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/files&gt;</span></span>
<span id="cb21-1128"><a href="#cb21-1128" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;coreid index="{emof_coreid_idx}" /&gt;</span></span>
<span id="cb21-1129"><a href="#cb21-1129" aria-hidden="true" tabindex="-1"></a><span class="st">{emof_fields}</span></span>
<span id="cb21-1130"><a href="#cb21-1130" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;/extension&gt;</span></span>
<span id="cb21-1131"><a href="#cb21-1131" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/archive&gt;'</span></span>
<span id="cb21-1132"><a href="#cb21-1132" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-1133"><a href="#cb21-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1134"><a href="#cb21-1134" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(meta_xml)</span>
<span id="cb21-1135"><a href="#cb21-1135" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-1136"><a href="#cb21-1136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1137"><a href="#cb21-1137" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate and write meta.xml</span></span>
<span id="cb21-1138"><a href="#cb21-1138" aria-hidden="true" tabindex="-1"></a>meta_xml <span class="ot">&lt;-</span> <span class="fu">generate_meta_xml</span>(dir_out)</span>
<span id="cb21-1139"><a href="#cb21-1139" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(meta_xml, <span class="fu">file.path</span>(dir_out, <span class="st">"meta.xml"</span>))</span>
<span id="cb21-1140"><a href="#cb21-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1141"><a href="#cb21-1141" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Generated meta.xml with field mappings:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-1142"><a href="#cb21-1142" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(meta_xml)</span>
<span id="cb21-1143"><a href="#cb21-1143" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1144"><a href="#cb21-1144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1145"><a href="#cb21-1145" aria-hidden="true" tabindex="-1"></a><span class="fu">## Create EML Metadata</span></span>
<span id="cb21-1146"><a href="#cb21-1146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1147"><a href="#cb21-1147" aria-hidden="true" tabindex="-1"></a>Build EML (Ecological Metadata Language) document with geographic, temporal, and taxonomic coverage:</span>
<span id="cb21-1148"><a href="#cb21-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1151"><a href="#cb21-1151" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-1152"><a href="#cb21-1152" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: build-eml</span></span>
<span id="cb21-1153"><a href="#cb21-1153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1154"><a href="#cb21-1154" aria-hidden="true" tabindex="-1"></a><span class="co"># Geographic coverage</span></span>
<span id="cb21-1155"><a href="#cb21-1155" aria-hidden="true" tabindex="-1"></a>geo_coverage <span class="ot">&lt;-</span> tbl_site <span class="sc">|&gt;</span></span>
<span id="cb21-1156"><a href="#cb21-1156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb21-1157"><a href="#cb21-1157" aria-hidden="true" tabindex="-1"></a>    <span class="at">westBoundingCoordinate =</span> <span class="fu">min</span>(longitude, <span class="at">na.rm =</span> T),</span>
<span id="cb21-1158"><a href="#cb21-1158" aria-hidden="true" tabindex="-1"></a>    <span class="at">eastBoundingCoordinate =</span> <span class="fu">max</span>(longitude, <span class="at">na.rm =</span> T),</span>
<span id="cb21-1159"><a href="#cb21-1159" aria-hidden="true" tabindex="-1"></a>    <span class="at">northBoundingCoordinate =</span> <span class="fu">max</span>(latitude, <span class="at">na.rm =</span> T),</span>
<span id="cb21-1160"><a href="#cb21-1160" aria-hidden="true" tabindex="-1"></a>    <span class="at">southBoundingCoordinate =</span> <span class="fu">min</span>(latitude, <span class="at">na.rm =</span> T)</span>
<span id="cb21-1161"><a href="#cb21-1161" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-1162"><a href="#cb21-1162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb21-1163"><a href="#cb21-1163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1164"><a href="#cb21-1164" aria-hidden="true" tabindex="-1"></a><span class="co"># Temporal coverage</span></span>
<span id="cb21-1165"><a href="#cb21-1165" aria-hidden="true" tabindex="-1"></a>temp_coverage <span class="ot">&lt;-</span> tbl_tow <span class="sc">|&gt;</span></span>
<span id="cb21-1166"><a href="#cb21-1166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb21-1167"><a href="#cb21-1167" aria-hidden="true" tabindex="-1"></a>    <span class="at">beginDate =</span> <span class="fu">min</span>(time_start, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-1168"><a href="#cb21-1168" aria-hidden="true" tabindex="-1"></a>    <span class="at">endDate =</span> <span class="fu">max</span>(time_start, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-1169"><a href="#cb21-1169" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-1170"><a href="#cb21-1170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb21-1171"><a href="#cb21-1171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb21-1172"><a href="#cb21-1172" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb21-1173"><a href="#cb21-1173" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"name"</span>,</span>
<span id="cb21-1174"><a href="#cb21-1174" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"value"</span></span>
<span id="cb21-1175"><a href="#cb21-1175" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-1176"><a href="#cb21-1176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-1177"><a href="#cb21-1177" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> <span class="fu">as.Date</span>(value)</span>
<span id="cb21-1178"><a href="#cb21-1178" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-1179"><a href="#cb21-1179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">deframe</span>() <span class="sc">|&gt;</span></span>
<span id="cb21-1180"><a href="#cb21-1180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.list</span>()</span>
<span id="cb21-1181"><a href="#cb21-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1182"><a href="#cb21-1182" aria-hidden="true" tabindex="-1"></a><span class="co"># Taxonomic coverage</span></span>
<span id="cb21-1183"><a href="#cb21-1183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1184"><a href="#cb21-1184" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(duckdb)</span>
<span id="cb21-1185"><a href="#cb21-1185" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="st">"https://file.calcofi.io/data/calcofi.duckdb"</span></span>
<span id="cb21-1186"><a href="#cb21-1186" aria-hidden="true" tabindex="-1"></a>tmp_db <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">tempdir</span>(), <span class="st">"calcofi.duckdb"</span>)</span>
<span id="cb21-1187"><a href="#cb21-1187" aria-hidden="true" tabindex="-1"></a>con_dk <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(duckdb<span class="sc">::</span><span class="fu">duckdb</span>(), <span class="at">dbdir =</span> tmp_db, <span class="at">read_only =</span> F)</span>
<span id="cb21-1188"><a href="#cb21-1188" aria-hidden="true" tabindex="-1"></a><span class="co"># attach remote duckdb database</span></span>
<span id="cb21-1189"><a href="#cb21-1189" aria-hidden="true" tabindex="-1"></a><span class="fu">dbSendQuery</span>(con_dk, glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"ATTACH DATABASE '{db}' AS cc;"</span>))</span>
<span id="cb21-1190"><a href="#cb21-1190" aria-hidden="true" tabindex="-1"></a><span class="co"># dbListTables(con)</span></span>
<span id="cb21-1191"><a href="#cb21-1191" aria-hidden="true" tabindex="-1"></a><span class="co">#  [1] "bottle"         "cast"           "cruise"         "egg"            "egg_stage"      "grid"</span></span>
<span id="cb21-1192"><a href="#cb21-1192" aria-hidden="true" tabindex="-1"></a><span class="co">#  [7] "larva"          "larva_size"     "larva_stage"    "net"            "schema_version" "ship"</span></span>
<span id="cb21-1193"><a href="#cb21-1193" aria-hidden="true" tabindex="-1"></a><span class="co"># [13] "site"           "site_seg"       "species"        "taxa_rank"      "taxonomy"       "tow"</span></span>
<span id="cb21-1194"><a href="#cb21-1194" aria-hidden="true" tabindex="-1"></a><span class="co"># [19] "tow_type"</span></span>
<span id="cb21-1195"><a href="#cb21-1195" aria-hidden="true" tabindex="-1"></a>d_taxa <span class="ot">&lt;-</span> <span class="fu">dbReadTable</span>(con_dk, <span class="fu">Id</span>(<span class="at">schema =</span> <span class="st">"cc"</span>, <span class="at">table =</span> <span class="st">"taxonomy"</span>))</span>
<span id="cb21-1196"><a href="#cb21-1196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1197"><a href="#cb21-1197" aria-hidden="true" tabindex="-1"></a>taxa_coverage <span class="ot">&lt;-</span> tbl_species <span class="sc">|&gt;</span></span>
<span id="cb21-1198"><a href="#cb21-1198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(worms_id)) <span class="sc">|&gt;</span></span>
<span id="cb21-1199"><a href="#cb21-1199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(species_id, worms_id, common_name) <span class="sc">|&gt;</span></span>
<span id="cb21-1200"><a href="#cb21-1200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb21-1201"><a href="#cb21-1201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb21-1202"><a href="#cb21-1202" aria-hidden="true" tabindex="-1"></a>    d_taxa <span class="sc">|&gt;</span></span>
<span id="cb21-1203"><a href="#cb21-1203" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(</span>
<span id="cb21-1204"><a href="#cb21-1204" aria-hidden="true" tabindex="-1"></a>        taxonID,</span>
<span id="cb21-1205"><a href="#cb21-1205" aria-hidden="true" tabindex="-1"></a>        taxonRank,</span>
<span id="cb21-1206"><a href="#cb21-1206" aria-hidden="true" tabindex="-1"></a>        scientificName</span>
<span id="cb21-1207"><a href="#cb21-1207" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb21-1208"><a href="#cb21-1208" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">join_by</span>(worms_id <span class="sc">==</span> taxonID)</span>
<span id="cb21-1209"><a href="#cb21-1209" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-1210"><a href="#cb21-1210" aria-hidden="true" tabindex="-1"></a>  <span class="co"># De-duplicate in case multiple local species map to same WoRMS ID</span></span>
<span id="cb21-1211"><a href="#cb21-1211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(worms_id, taxonRank, scientificName) <span class="sc">|&gt;</span></span>
<span id="cb21-1212"><a href="#cb21-1212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb21-1213"><a href="#cb21-1213" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_id =</span> <span class="fu">first</span>(species_id),</span>
<span id="cb21-1214"><a href="#cb21-1214" aria-hidden="true" tabindex="-1"></a>    <span class="at">common_name =</span> <span class="fu">paste</span>(<span class="fu">unique</span>(<span class="fu">na.omit</span>(common_name)), <span class="at">collapse =</span> <span class="st">", "</span>),</span>
<span id="cb21-1215"><a href="#cb21-1215" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb21-1216"><a href="#cb21-1216" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb21-1217"><a href="#cb21-1217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(species_id) <span class="sc">|&gt;</span></span>
<span id="cb21-1218"><a href="#cb21-1218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pmap</span>(<span class="cf">function</span>(</span>
<span id="cb21-1219"><a href="#cb21-1219" aria-hidden="true" tabindex="-1"></a>    species_id,</span>
<span id="cb21-1220"><a href="#cb21-1220" aria-hidden="true" tabindex="-1"></a>    taxonRank,</span>
<span id="cb21-1221"><a href="#cb21-1221" aria-hidden="true" tabindex="-1"></a>    scientificName,</span>
<span id="cb21-1222"><a href="#cb21-1222" aria-hidden="true" tabindex="-1"></a>    common_name,</span>
<span id="cb21-1223"><a href="#cb21-1223" aria-hidden="true" tabindex="-1"></a>    worms_id,</span>
<span id="cb21-1224"><a href="#cb21-1224" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb21-1225"><a href="#cb21-1225" aria-hidden="true" tabindex="-1"></a>  ) {</span>
<span id="cb21-1226"><a href="#cb21-1226" aria-hidden="true" tabindex="-1"></a>    item <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb21-1227"><a href="#cb21-1227" aria-hidden="true" tabindex="-1"></a>      <span class="at">id =</span> <span class="fu">glue</span>(<span class="st">"calcofi_species_{species_id}"</span>),</span>
<span id="cb21-1228"><a href="#cb21-1228" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxonRankName =</span> taxonRank,</span>
<span id="cb21-1229"><a href="#cb21-1229" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxonRankValue =</span> scientificName,</span>
<span id="cb21-1230"><a href="#cb21-1230" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxonId =</span> <span class="fu">list</span>(</span>
<span id="cb21-1231"><a href="#cb21-1231" aria-hidden="true" tabindex="-1"></a>        <span class="at">provider =</span> <span class="st">"https://www.marinespecies.org"</span>,</span>
<span id="cb21-1232"><a href="#cb21-1232" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.character</span>(worms_id)</span>
<span id="cb21-1233"><a href="#cb21-1233" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb21-1234"><a href="#cb21-1234" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-1235"><a href="#cb21-1235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1236"><a href="#cb21-1236" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(common_name) <span class="sc">&amp;&amp;</span> common_name <span class="sc">!=</span> <span class="st">""</span>) {</span>
<span id="cb21-1237"><a href="#cb21-1237" aria-hidden="true" tabindex="-1"></a>      item<span class="sc">$</span>commonName <span class="ot">&lt;-</span> common_name</span>
<span id="cb21-1238"><a href="#cb21-1238" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-1239"><a href="#cb21-1239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1240"><a href="#cb21-1240" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(item)</span>
<span id="cb21-1241"><a href="#cb21-1241" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb21-1242"><a href="#cb21-1242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1243"><a href="#cb21-1243" aria-hidden="true" tabindex="-1"></a><span class="co"># Create EML document</span></span>
<span id="cb21-1244"><a href="#cb21-1244" aria-hidden="true" tabindex="-1"></a>my_eml <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb21-1245"><a href="#cb21-1245" aria-hidden="true" tabindex="-1"></a>  <span class="at">packageId =</span> dataset_id,</span>
<span id="cb21-1246"><a href="#cb21-1246" aria-hidden="true" tabindex="-1"></a>  <span class="at">system =</span> <span class="st">"calcofi.io"</span>,</span>
<span id="cb21-1247"><a href="#cb21-1247" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="fu">list</span>(</span>
<span id="cb21-1248"><a href="#cb21-1248" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> dataset_title,</span>
<span id="cb21-1249"><a href="#cb21-1249" aria-hidden="true" tabindex="-1"></a>    <span class="at">creator =</span> <span class="fu">list</span>(</span>
<span id="cb21-1250"><a href="#cb21-1250" aria-hidden="true" tabindex="-1"></a>      <span class="at">individualName =</span> <span class="fu">list</span>(</span>
<span id="cb21-1251"><a href="#cb21-1251" aria-hidden="true" tabindex="-1"></a>        <span class="at">givenName =</span> <span class="st">"Ed"</span>,</span>
<span id="cb21-1252"><a href="#cb21-1252" aria-hidden="true" tabindex="-1"></a>        <span class="at">surName =</span> <span class="st">"Weber"</span></span>
<span id="cb21-1253"><a href="#cb21-1253" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb21-1254"><a href="#cb21-1254" aria-hidden="true" tabindex="-1"></a>      <span class="at">organizationName =</span> <span class="st">"NOAA SWFSC"</span>,</span>
<span id="cb21-1255"><a href="#cb21-1255" aria-hidden="true" tabindex="-1"></a>      <span class="at">electronicMailAddress =</span> <span class="st">"ed.weber@noaa.gov"</span>,</span>
<span id="cb21-1256"><a href="#cb21-1256" aria-hidden="true" tabindex="-1"></a>      <span class="at">userId =</span> <span class="fu">list</span>(</span>
<span id="cb21-1257"><a href="#cb21-1257" aria-hidden="true" tabindex="-1"></a>        <span class="at">directory =</span> <span class="st">"https://orcid.org/"</span>,</span>
<span id="cb21-1258"><a href="#cb21-1258" aria-hidden="true" tabindex="-1"></a>        <span class="at">userId =</span> <span class="st">"0000-0002-0942-434X"</span></span>
<span id="cb21-1259"><a href="#cb21-1259" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb21-1260"><a href="#cb21-1260" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb21-1261"><a href="#cb21-1261" aria-hidden="true" tabindex="-1"></a>    <span class="at">abstract =</span> dataset_abstract,</span>
<span id="cb21-1262"><a href="#cb21-1262" aria-hidden="true" tabindex="-1"></a>    <span class="at">keywordSet =</span> <span class="fu">list</span>(</span>
<span id="cb21-1263"><a href="#cb21-1263" aria-hidden="true" tabindex="-1"></a>      <span class="at">keyword =</span> dataset_keywords,</span>
<span id="cb21-1264"><a href="#cb21-1264" aria-hidden="true" tabindex="-1"></a>      <span class="at">keywordThesaurus =</span> <span class="st">"GCMD Science Keywords"</span></span>
<span id="cb21-1265"><a href="#cb21-1265" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb21-1266"><a href="#cb21-1266" aria-hidden="true" tabindex="-1"></a>    <span class="at">coverage =</span> <span class="fu">list</span>(</span>
<span id="cb21-1267"><a href="#cb21-1267" aria-hidden="true" tabindex="-1"></a>      <span class="at">geographicCoverage =</span> <span class="fu">list</span>(</span>
<span id="cb21-1268"><a href="#cb21-1268" aria-hidden="true" tabindex="-1"></a>        <span class="at">geographicDescription =</span> <span class="st">"California Current Large Marine Ecoregion"</span>,</span>
<span id="cb21-1269"><a href="#cb21-1269" aria-hidden="true" tabindex="-1"></a>        <span class="at">boundingCoordinates =</span> geo_coverage</span>
<span id="cb21-1270"><a href="#cb21-1270" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb21-1271"><a href="#cb21-1271" aria-hidden="true" tabindex="-1"></a>      <span class="at">temporalCoverage =</span> <span class="fu">list</span>(</span>
<span id="cb21-1272"><a href="#cb21-1272" aria-hidden="true" tabindex="-1"></a>        <span class="at">rangeOfDates =</span> <span class="fu">list</span>(</span>
<span id="cb21-1273"><a href="#cb21-1273" aria-hidden="true" tabindex="-1"></a>          <span class="at">beginDate =</span> <span class="fu">list</span>(</span>
<span id="cb21-1274"><a href="#cb21-1274" aria-hidden="true" tabindex="-1"></a>            <span class="at">calendarDate =</span> <span class="fu">as.character</span>(temp_coverage<span class="sc">$</span>beginDate)</span>
<span id="cb21-1275"><a href="#cb21-1275" aria-hidden="true" tabindex="-1"></a>          ),</span>
<span id="cb21-1276"><a href="#cb21-1276" aria-hidden="true" tabindex="-1"></a>          <span class="at">endDate =</span> <span class="fu">list</span>(<span class="at">calendarDate =</span> <span class="fu">as.character</span>(temp_coverage<span class="sc">$</span>endDate))</span>
<span id="cb21-1277"><a href="#cb21-1277" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-1278"><a href="#cb21-1278" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb21-1279"><a href="#cb21-1279" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxonomicCoverage =</span> <span class="fu">list</span>(</span>
<span id="cb21-1280"><a href="#cb21-1280" aria-hidden="true" tabindex="-1"></a>        <span class="at">generalTaxonomicCoverage =</span> <span class="st">"Marine ichthyoplankton and fish eggs"</span>,</span>
<span id="cb21-1281"><a href="#cb21-1281" aria-hidden="true" tabindex="-1"></a>        <span class="at">taxonomicClassification =</span> taxa_coverage</span>
<span id="cb21-1282"><a href="#cb21-1282" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb21-1283"><a href="#cb21-1283" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb21-1284"><a href="#cb21-1284" aria-hidden="true" tabindex="-1"></a>    <span class="at">contact =</span> <span class="fu">list</span>(</span>
<span id="cb21-1285"><a href="#cb21-1285" aria-hidden="true" tabindex="-1"></a>      <span class="at">individualName =</span> <span class="fu">list</span>(</span>
<span id="cb21-1286"><a href="#cb21-1286" aria-hidden="true" tabindex="-1"></a>        <span class="at">givenName =</span> <span class="st">"Ed"</span>,</span>
<span id="cb21-1287"><a href="#cb21-1287" aria-hidden="true" tabindex="-1"></a>        <span class="at">surName =</span> <span class="st">"Weber"</span></span>
<span id="cb21-1288"><a href="#cb21-1288" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb21-1289"><a href="#cb21-1289" aria-hidden="true" tabindex="-1"></a>      <span class="at">electronicMailAddress =</span> <span class="st">"ed.weber@noaa.gov"</span></span>
<span id="cb21-1290"><a href="#cb21-1290" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb21-1291"><a href="#cb21-1291" aria-hidden="true" tabindex="-1"></a>    <span class="at">methods =</span> <span class="fu">list</span>(</span>
<span id="cb21-1292"><a href="#cb21-1292" aria-hidden="true" tabindex="-1"></a>      <span class="at">methodStep =</span> <span class="fu">list</span>(</span>
<span id="cb21-1293"><a href="#cb21-1293" aria-hidden="true" tabindex="-1"></a>        <span class="at">description =</span> <span class="fu">list</span>(</span>
<span id="cb21-1294"><a href="#cb21-1294" aria-hidden="true" tabindex="-1"></a>          <span class="at">para =</span> sampling_methods_description</span>
<span id="cb21-1295"><a href="#cb21-1295" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-1296"><a href="#cb21-1296" aria-hidden="true" tabindex="-1"></a>      ), <span class="co"># </span><span class="al">TODO</span><span class="co">: sampling methods</span></span>
<span id="cb21-1297"><a href="#cb21-1297" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampling =</span> <span class="fu">list</span>(</span>
<span id="cb21-1298"><a href="#cb21-1298" aria-hidden="true" tabindex="-1"></a>        <span class="at">studyExtent =</span> <span class="fu">list</span>(</span>
<span id="cb21-1299"><a href="#cb21-1299" aria-hidden="true" tabindex="-1"></a>          <span class="at">description =</span> <span class="fu">list</span>(</span>
<span id="cb21-1300"><a href="#cb21-1300" aria-hidden="true" tabindex="-1"></a>            <span class="at">para =</span> study_extent_description</span>
<span id="cb21-1301"><a href="#cb21-1301" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb21-1302"><a href="#cb21-1302" aria-hidden="true" tabindex="-1"></a>        ), <span class="co"># </span><span class="al">TODO</span><span class="co">: study extent</span></span>
<span id="cb21-1303"><a href="#cb21-1303" aria-hidden="true" tabindex="-1"></a>        <span class="at">samplingDescription =</span> <span class="fu">list</span>(</span>
<span id="cb21-1304"><a href="#cb21-1304" aria-hidden="true" tabindex="-1"></a>          <span class="at">para =</span> sampling_description</span>
<span id="cb21-1305"><a href="#cb21-1305" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-1306"><a href="#cb21-1306" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb21-1307"><a href="#cb21-1307" aria-hidden="true" tabindex="-1"></a>    ), <span class="co"># </span><span class="al">TODO</span><span class="co">: sampling</span></span>
<span id="cb21-1308"><a href="#cb21-1308" aria-hidden="true" tabindex="-1"></a>    <span class="at">project =</span> <span class="fu">list</span>(</span>
<span id="cb21-1309"><a href="#cb21-1309" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> dataset_title, <span class="co"># </span><span class="al">TODO</span><span class="co">: project title?</span></span>
<span id="cb21-1310"><a href="#cb21-1310" aria-hidden="true" tabindex="-1"></a>      <span class="at">personnel =</span> <span class="fu">list</span>(</span>
<span id="cb21-1311"><a href="#cb21-1311" aria-hidden="true" tabindex="-1"></a>        <span class="at">individualName =</span> <span class="fu">list</span>(</span>
<span id="cb21-1312"><a href="#cb21-1312" aria-hidden="true" tabindex="-1"></a>          <span class="at">givenName =</span> <span class="st">"Ed"</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: PI?</span></span>
<span id="cb21-1313"><a href="#cb21-1313" aria-hidden="true" tabindex="-1"></a>          <span class="at">surName =</span> <span class="st">"Weber"</span></span>
<span id="cb21-1314"><a href="#cb21-1314" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb21-1315"><a href="#cb21-1315" aria-hidden="true" tabindex="-1"></a>        <span class="at">role =</span> <span class="st">"Principal Investigator"</span></span>
<span id="cb21-1316"><a href="#cb21-1316" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb21-1317"><a href="#cb21-1317" aria-hidden="true" tabindex="-1"></a>      <span class="at">funding =</span> <span class="fu">list</span>(</span>
<span id="cb21-1318"><a href="#cb21-1318" aria-hidden="true" tabindex="-1"></a>        <span class="at">para =</span> funding_information</span>
<span id="cb21-1319"><a href="#cb21-1319" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb21-1320"><a href="#cb21-1320" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-1321"><a href="#cb21-1321" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-1322"><a href="#cb21-1322" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-1323"><a href="#cb21-1323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1324"><a href="#cb21-1324" aria-hidden="true" tabindex="-1"></a>eml_xml <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{dir_out}/eml.xml"</span>)</span>
<span id="cb21-1325"><a href="#cb21-1325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1326"><a href="#cb21-1326" aria-hidden="true" tabindex="-1"></a><span class="co"># my_eml &lt;- EML::read_eml(eml_xml)</span></span>
<span id="cb21-1327"><a href="#cb21-1327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1328"><a href="#cb21-1328" aria-hidden="true" tabindex="-1"></a><span class="co"># Validate EML before writing</span></span>
<span id="cb21-1329"><a href="#cb21-1329" aria-hidden="true" tabindex="-1"></a>validation_result <span class="ot">&lt;-</span> <span class="fu">eml_validate</span>(my_eml)</span>
<span id="cb21-1330"><a href="#cb21-1330" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>validation_result) {</span>
<span id="cb21-1331"><a href="#cb21-1331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"EML validation errors:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-1332"><a href="#cb21-1332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">attr</span>(validation_result, <span class="st">"errors"</span>))</span>
<span id="cb21-1333"><a href="#cb21-1333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>()</span>
<span id="cb21-1334"><a href="#cb21-1334" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb21-1335"><a href="#cb21-1335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"EML is valid!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-1336"><a href="#cb21-1336" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-1337"><a href="#cb21-1337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1338"><a href="#cb21-1338" aria-hidden="true" tabindex="-1"></a><span class="co"># Write EML</span></span>
<span id="cb21-1339"><a href="#cb21-1339" aria-hidden="true" tabindex="-1"></a><span class="fu">write_eml</span>(my_eml, eml_xml)</span>
<span id="cb21-1340"><a href="#cb21-1340" aria-hidden="true" tabindex="-1"></a><span class="co"># browseURL(eml_xml)</span></span>
<span id="cb21-1341"><a href="#cb21-1341" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1342"><a href="#cb21-1342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1343"><a href="#cb21-1343" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Quality Checks</span></span>
<span id="cb21-1344"><a href="#cb21-1344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1345"><a href="#cb21-1345" aria-hidden="true" tabindex="-1"></a>Validate data quality: check for missing WoRMS IDs, orphan records, and output summary statistics:</span>
<span id="cb21-1346"><a href="#cb21-1346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1349"><a href="#cb21-1349" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-1350"><a href="#cb21-1350" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check-data-quality</span></span>
<span id="cb21-1351"><a href="#cb21-1351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1352"><a href="#cb21-1352" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for missing WoRMS IDs</span></span>
<span id="cb21-1353"><a href="#cb21-1353" aria-hidden="true" tabindex="-1"></a>d_missing_worms <span class="ot">&lt;-</span> tbl_species <span class="sc">|&gt;</span></span>
<span id="cb21-1354"><a href="#cb21-1354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(worms_id)) <span class="sc">|&gt;</span></span>
<span id="cb21-1355"><a href="#cb21-1355" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(species_id, scientific_name) <span class="sc">|&gt;</span></span>
<span id="cb21-1356"><a href="#cb21-1356" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb21-1357"><a href="#cb21-1357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1358"><a href="#cb21-1358" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(d_missing_worms) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb21-1359"><a href="#cb21-1359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"WARNING: The following species are missing WoRMS IDs:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-1360"><a href="#cb21-1360" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(d_missing_worms)</span>
<span id="cb21-1361"><a href="#cb21-1361" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(</span>
<span id="cb21-1362"><a href="#cb21-1362" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="sc">\n</span><span class="st">Please add WoRMS AphiaIDs for these species before finalizing the dataset.</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb21-1363"><a href="#cb21-1363" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-1364"><a href="#cb21-1364" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-1365"><a href="#cb21-1365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1366"><a href="#cb21-1366" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for orphan records</span></span>
<span id="cb21-1367"><a href="#cb21-1367" aria-hidden="true" tabindex="-1"></a>d_orphan_occurrences <span class="ot">&lt;-</span> q_occurrence_extension <span class="sc">|&gt;</span></span>
<span id="cb21-1368"><a href="#cb21-1368" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anti_join</span>(q_event_core, <span class="at">by =</span> <span class="st">"eventID"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-1369"><a href="#cb21-1369" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb21-1370"><a href="#cb21-1370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1371"><a href="#cb21-1371" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(d_orphan_occurrences) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb21-1372"><a href="#cb21-1372" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(</span>
<span id="cb21-1373"><a href="#cb21-1373" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="sc">\n</span><span class="st">WARNING: Found"</span>,</span>
<span id="cb21-1374"><a href="#cb21-1374" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nrow</span>(d_orphan_occurrences),</span>
<span id="cb21-1375"><a href="#cb21-1375" aria-hidden="true" tabindex="-1"></a>    <span class="st">"occurrence records without matching events.</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb21-1376"><a href="#cb21-1376" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-1377"><a href="#cb21-1377" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-1378"><a href="#cb21-1378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1379"><a href="#cb21-1379" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics</span></span>
<span id="cb21-1380"><a href="#cb21-1380" aria-hidden="true" tabindex="-1"></a>n_events <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb21-1381"><a href="#cb21-1381" aria-hidden="true" tabindex="-1"></a>n_events <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span></span>
<span id="cb21-1382"><a href="#cb21-1382" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"net_sample"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-1383"><a href="#cb21-1383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb21-1384"><a href="#cb21-1384" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(n)</span>
<span id="cb21-1385"><a href="#cb21-1385" aria-hidden="true" tabindex="-1"></a>n_cruises <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span></span>
<span id="cb21-1386"><a href="#cb21-1386" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"cruise"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-1387"><a href="#cb21-1387" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb21-1388"><a href="#cb21-1388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(n)</span>
<span id="cb21-1389"><a href="#cb21-1389" aria-hidden="true" tabindex="-1"></a>n_sites <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span></span>
<span id="cb21-1390"><a href="#cb21-1390" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"site"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-1391"><a href="#cb21-1391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb21-1392"><a href="#cb21-1392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(n)</span>
<span id="cb21-1393"><a href="#cb21-1393" aria-hidden="true" tabindex="-1"></a>n_tows <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span></span>
<span id="cb21-1394"><a href="#cb21-1394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"tow"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-1395"><a href="#cb21-1395" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb21-1396"><a href="#cb21-1396" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(n)</span>
<span id="cb21-1397"><a href="#cb21-1397" aria-hidden="true" tabindex="-1"></a>n_nets <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span></span>
<span id="cb21-1398"><a href="#cb21-1398" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"net_sample"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-1399"><a href="#cb21-1399" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb21-1400"><a href="#cb21-1400" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(n)</span>
<span id="cb21-1401"><a href="#cb21-1401" aria-hidden="true" tabindex="-1"></a>n_occs <span class="ot">&lt;-</span> q_occurrence_extension <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb21-1402"><a href="#cb21-1402" aria-hidden="true" tabindex="-1"></a>n_species <span class="ot">&lt;-</span> q_occurrence_extension <span class="sc">|&gt;</span></span>
<span id="cb21-1403"><a href="#cb21-1403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(scientificName) <span class="sc">|&gt;</span></span>
<span id="cb21-1404"><a href="#cb21-1404" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb21-1405"><a href="#cb21-1405" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(n)</span>
<span id="cb21-1406"><a href="#cb21-1406" aria-hidden="true" tabindex="-1"></a>n_measures <span class="ot">&lt;-</span> d_extendedmeasurementorfact_extension <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb21-1407"><a href="#cb21-1407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1408"><a href="#cb21-1408" aria-hidden="true" tabindex="-1"></a><span class="fu">glue</span>(</span>
<span id="cb21-1409"><a href="#cb21-1409" aria-hidden="true" tabindex="-1"></a>  <span class="st">"</span></span>
<span id="cb21-1410"><a href="#cb21-1410" aria-hidden="true" tabindex="-1"></a><span class="st">  === Dataset Summary ===</span></span>
<span id="cb21-1411"><a href="#cb21-1411" aria-hidden="true" tabindex="-1"></a><span class="st">  Total events:        {prettyNum(n_events, big.mark = ',')}</span></span>
<span id="cb21-1412"><a href="#cb21-1412" aria-hidden="true" tabindex="-1"></a><span class="st">  - Cruises:           {prettyNum(n_cruises, big.mark = ',')}</span></span>
<span id="cb21-1413"><a href="#cb21-1413" aria-hidden="true" tabindex="-1"></a><span class="st">  - Sites:             {prettyNum(n_sites, big.mark = ',')}</span></span>
<span id="cb21-1414"><a href="#cb21-1414" aria-hidden="true" tabindex="-1"></a><span class="st">  - Tows:              {prettyNum(n_tows, big.mark = ',')}</span></span>
<span id="cb21-1415"><a href="#cb21-1415" aria-hidden="true" tabindex="-1"></a><span class="st">  - Net samples:       {prettyNum(n_nets, big.mark = ',')}</span></span>
<span id="cb21-1416"><a href="#cb21-1416" aria-hidden="true" tabindex="-1"></a><span class="st">  Total occurrences:   {prettyNum(n_occs, big.mark = ',')}</span></span>
<span id="cb21-1417"><a href="#cb21-1417" aria-hidden="true" tabindex="-1"></a><span class="st">  Total species:       {prettyNum(n_species, big.mark = ',')}</span></span>
<span id="cb21-1418"><a href="#cb21-1418" aria-hidden="true" tabindex="-1"></a><span class="st">  Total measurements:  {prettyNum(n_measures, big.mark = ',')}"</span></span>
<span id="cb21-1419"><a href="#cb21-1419" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-1420"><a href="#cb21-1420" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1421"><a href="#cb21-1421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1422"><a href="#cb21-1422" aria-hidden="true" tabindex="-1"></a><span class="fu">## Package Creation</span></span>
<span id="cb21-1423"><a href="#cb21-1423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1424"><a href="#cb21-1424" aria-hidden="true" tabindex="-1"></a>Create the final DarwinCore Archive as a zip file containing all CSV files, meta.xml, and eml.xml:</span>
<span id="cb21-1425"><a href="#cb21-1425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1428"><a href="#cb21-1428" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-1429"><a href="#cb21-1429" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: create-dwc-archive</span></span>
<span id="cb21-1430"><a href="#cb21-1430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1431"><a href="#cb21-1431" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DwC-A zip file</span></span>
<span id="cb21-1432"><a href="#cb21-1432" aria-hidden="true" tabindex="-1"></a>zip_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="fu">paste0</span>(<span class="st">"../larvae_"</span>, <span class="fu">Sys.Date</span>(), <span class="st">".zip"</span>))</span>
<span id="cb21-1433"><a href="#cb21-1433" aria-hidden="true" tabindex="-1"></a><span class="fu">zip</span>(</span>
<span id="cb21-1434"><a href="#cb21-1434" aria-hidden="true" tabindex="-1"></a>  zip_file,</span>
<span id="cb21-1435"><a href="#cb21-1435" aria-hidden="true" tabindex="-1"></a>  <span class="at">files =</span> <span class="fu">file.path</span>(</span>
<span id="cb21-1436"><a href="#cb21-1436" aria-hidden="true" tabindex="-1"></a>    dir_out,</span>
<span id="cb21-1437"><a href="#cb21-1437" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(</span>
<span id="cb21-1438"><a href="#cb21-1438" aria-hidden="true" tabindex="-1"></a>      <span class="st">"event.csv"</span>,</span>
<span id="cb21-1439"><a href="#cb21-1439" aria-hidden="true" tabindex="-1"></a>      <span class="st">"occurrence.csv"</span>,</span>
<span id="cb21-1440"><a href="#cb21-1440" aria-hidden="true" tabindex="-1"></a>      <span class="st">"extendedMeasurementOrFact.csv"</span>,</span>
<span id="cb21-1441"><a href="#cb21-1441" aria-hidden="true" tabindex="-1"></a>      <span class="st">"meta.xml"</span>,</span>
<span id="cb21-1442"><a href="#cb21-1442" aria-hidden="true" tabindex="-1"></a>      <span class="st">"eml.xml"</span></span>
<span id="cb21-1443"><a href="#cb21-1443" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-1444"><a href="#cb21-1444" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb21-1445"><a href="#cb21-1445" aria-hidden="true" tabindex="-1"></a>  <span class="at">flags =</span> <span class="st">"-j"</span></span>
<span id="cb21-1446"><a href="#cb21-1446" aria-hidden="true" tabindex="-1"></a>) <span class="co"># exclude parent folders</span></span>
<span id="cb21-1447"><a href="#cb21-1447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1448"><a href="#cb21-1448" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Darwin Core Archive created:"</span>, zip_file, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-1449"><a href="#cb21-1449" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1450"><a href="#cb21-1450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1451"><a href="#cb21-1451" aria-hidden="true" tabindex="-1"></a><span class="fu">## Check CSV</span></span>
<span id="cb21-1452"><a href="#cb21-1452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1453"><a href="#cb21-1453" aria-hidden="true" tabindex="-1"></a>Verify the exported CSV files and inspect measurement types and units:</span>
<span id="cb21-1454"><a href="#cb21-1454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1457"><a href="#cb21-1457" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-1458"><a href="#cb21-1458" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check-csv</span></span>
<span id="cb21-1459"><a href="#cb21-1459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1460"><a href="#cb21-1460" aria-hidden="true" tabindex="-1"></a>d_event <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">glue</span>(<span class="st">"{dir_out}/event.csv"</span>))</span>
<span id="cb21-1461"><a href="#cb21-1461" aria-hidden="true" tabindex="-1"></a>d_occurrence <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">glue</span>(<span class="st">"{dir_out}/occurrence.csv"</span>))</span>
<span id="cb21-1462"><a href="#cb21-1462" aria-hidden="true" tabindex="-1"></a>d_emof <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">glue</span>(<span class="st">"{dir_out}/extendedMeasurementOrFact.csv"</span>))</span>
<span id="cb21-1463"><a href="#cb21-1463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1464"><a href="#cb21-1464" aria-hidden="true" tabindex="-1"></a><span class="co"># d_event</span></span>
<span id="cb21-1465"><a href="#cb21-1465" aria-hidden="true" tabindex="-1"></a><span class="co"># d_occurrence</span></span>
<span id="cb21-1466"><a href="#cb21-1466" aria-hidden="true" tabindex="-1"></a><span class="co"># d_emof</span></span>
<span id="cb21-1467"><a href="#cb21-1467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1468"><a href="#cb21-1468" aria-hidden="true" tabindex="-1"></a><span class="co"># d_emof |&gt; select(measurementType, measurementUnit) |&gt; table(useNA = "ifany")</span></span>
<span id="cb21-1469"><a href="#cb21-1469" aria-hidden="true" tabindex="-1"></a><span class="co">#                              measurementUnit</span></span>
<span id="cb21-1470"><a href="#cb21-1470" aria-hidden="true" tabindex="-1"></a><span class="co"># measurementType               dimensionless  grams individuals millimeters</span></span>
<span id="cb21-1471"><a href="#cb21-1471" aria-hidden="true" tabindex="-1"></a><span class="co">#   abundance by life stage                 0      0      125347           0</span></span>
<span id="cb21-1472"><a href="#cb21-1472" aria-hidden="true" tabindex="-1"></a><span class="co">#   body length                             0      0           0      241871</span></span>
<span id="cb21-1473"><a href="#cb21-1473" aria-hidden="true" tabindex="-1"></a><span class="co">#   proportion of sample sorted         76512      0           0           0</span></span>
<span id="cb21-1474"><a href="#cb21-1474" aria-hidden="true" tabindex="-1"></a><span class="co">#   small plankton biomass                  0  45287           0           0</span></span>
<span id="cb21-1475"><a href="#cb21-1475" aria-hidden="true" tabindex="-1"></a><span class="co">#   standardized haul factor            76512      0           0           0</span></span>
<span id="cb21-1476"><a href="#cb21-1476" aria-hidden="true" tabindex="-1"></a><span class="co">#   total plankton biomass                  0  45287           0           0</span></span>
<span id="cb21-1477"><a href="#cb21-1477" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1478"><a href="#cb21-1478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1479"><a href="#cb21-1479" aria-hidden="true" tabindex="-1"></a><span class="fu">## To confirm: dataset metadata</span></span>
<span id="cb21-1480"><a href="#cb21-1480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1481"><a href="#cb21-1481" aria-hidden="true" tabindex="-1"></a>Please confirm the following seem reasonable to you:</span>
<span id="cb21-1482"><a href="#cb21-1482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1483"><a href="#cb21-1483" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Dataset ID \</span>
<span id="cb21-1484"><a href="#cb21-1484" aria-hidden="true" tabindex="-1"></a>  <span class="in">`dataset_id`</span>: <span class="in">`r dataset_id`</span> \</span>
<span id="cb21-1485"><a href="#cb21-1485" aria-hidden="true" tabindex="-1"></a>  See: <span class="ot">&lt;https://manual.obis.org/examples.html&gt;</span> -&gt; <span class="in">`datasetID`</span>: <span class="ot">&lt;https://marineinfo.org/id/dataset/6403&gt;</span></span>
<span id="cb21-1486"><a href="#cb21-1486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1487"><a href="#cb21-1487" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Dataset title \</span>
<span id="cb21-1488"><a href="#cb21-1488" aria-hidden="true" tabindex="-1"></a>  <span class="in">`dataset_title`</span>: <span class="in">`r dataset_title`</span>\</span>
<span id="cb21-1489"><a href="#cb21-1489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1490"><a href="#cb21-1490" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Dataset abstract (200-500 words describing the dataset) \</span>
<span id="cb21-1491"><a href="#cb21-1491" aria-hidden="true" tabindex="-1"></a>  <span class="in">`dataset_abstract`</span>: <span class="in">`r dataset_abstract`</span></span>
<span id="cb21-1492"><a href="#cb21-1492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1493"><a href="#cb21-1493" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Keywords (3-5 relevant keywords) \</span>
<span id="cb21-1494"><a href="#cb21-1494" aria-hidden="true" tabindex="-1"></a>  <span class="in">`dataset_keywords`</span>: <span class="in">`r dataset_keywords`</span>\</span>
<span id="cb21-1495"><a href="#cb21-1495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1496"><a href="#cb21-1496" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Country code (ISO 3166-1 alpha-2) \</span>
<span id="cb21-1497"><a href="#cb21-1497" aria-hidden="true" tabindex="-1"></a>  <span class="in">`country_code`</span>: <span class="in">`r country_code`</span>\</span>
<span id="cb21-1498"><a href="#cb21-1498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1499"><a href="#cb21-1499" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Water body name \</span>
<span id="cb21-1500"><a href="#cb21-1500" aria-hidden="true" tabindex="-1"></a>  <span class="in">`water_body`</span>: <span class="in">`r water_body`</span>\</span>
<span id="cb21-1501"><a href="#cb21-1501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1502"><a href="#cb21-1502" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Sampling Methods Description\</span>
<span id="cb21-1503"><a href="#cb21-1503" aria-hidden="true" tabindex="-1"></a>  <span class="in">`sampling_methods_description`</span>: <span class="in">`r sampling_methods_description`</span>\</span>
<span id="cb21-1504"><a href="#cb21-1504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1505"><a href="#cb21-1505" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Study Extent Description \</span>
<span id="cb21-1506"><a href="#cb21-1506" aria-hidden="true" tabindex="-1"></a>  <span class="in">`study_extent_description`</span>: <span class="in">`r study_extent_description`</span>\</span>
<span id="cb21-1507"><a href="#cb21-1507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1508"><a href="#cb21-1508" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Sampling Description \</span>
<span id="cb21-1509"><a href="#cb21-1509" aria-hidden="true" tabindex="-1"></a>  <span class="in">`sampling_description`</span>: <span class="in">`r sampling_description`</span>\</span>
<span id="cb21-1510"><a href="#cb21-1510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1511"><a href="#cb21-1511" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Funding Information \</span>
<span id="cb21-1512"><a href="#cb21-1512" aria-hidden="true" tabindex="-1"></a>  <span class="in">`funding_information`</span>: <span class="in">`r funding_information`</span>\</span>
<span id="cb21-1513"><a href="#cb21-1513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1514"><a href="#cb21-1514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1515"><a href="#cb21-1515" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span></span>
<span id="cb21-1516"><a href="#cb21-1516" aria-hidden="true" tabindex="-1"></a><span class="co">## Other Checklist Items</span></span>
<span id="cb21-1517"><a href="#cb21-1517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1518"><a href="#cb21-1518" aria-hidden="true" tabindex="-1"></a><span class="al">###</span><span class="co"> Personnel Information</span></span>
<span id="cb21-1519"><a href="#cb21-1519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1520"><a href="#cb21-1520" aria-hidden="true" tabindex="-1"></a><span class="co">- [ ] Dataset creator name and ORCID</span></span>
<span id="cb21-1521"><a href="#cb21-1521" aria-hidden="true" tabindex="-1"></a><span class="co">- [ ] Creator organization</span></span>
<span id="cb21-1522"><a href="#cb21-1522" aria-hidden="true" tabindex="-1"></a><span class="co">- [ ] Creator email</span></span>
<span id="cb21-1523"><a href="#cb21-1523" aria-hidden="true" tabindex="-1"></a><span class="co">- [ ] Dataset contact name and email</span></span>
<span id="cb21-1524"><a href="#cb21-1524" aria-hidden="true" tabindex="-1"></a><span class="co">- [ ] Principal investigator name</span></span>
<span id="cb21-1525"><a href="#cb21-1525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1526"><a href="#cb21-1526" aria-hidden="true" tabindex="-1"></a><span class="al">###</span><span class="co"> Project Information</span></span>
<span id="cb21-1527"><a href="#cb21-1527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1528"><a href="#cb21-1528" aria-hidden="true" tabindex="-1"></a><span class="co">- [ ] Project title</span></span>
<span id="cb21-1529"><a href="#cb21-1529" aria-hidden="true" tabindex="-1"></a><span class="co">- [ ] Funding information (agency and grant numbers)</span></span>
<span id="cb21-1530"><a href="#cb21-1530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1531"><a href="#cb21-1531" aria-hidden="true" tabindex="-1"></a><span class="al">###</span><span class="co"> Methodology</span></span>
<span id="cb21-1532"><a href="#cb21-1532" aria-hidden="true" tabindex="-1"></a><span class="co">- [ ] Detailed sampling methods description</span></span>
<span id="cb21-1533"><a href="#cb21-1533" aria-hidden="true" tabindex="-1"></a><span class="co">- [ ] Study extent description</span></span>
<span id="cb21-1534"><a href="#cb21-1534" aria-hidden="true" tabindex="-1"></a><span class="co">- [ ] Sampling design and protocols</span></span>
<span id="cb21-1535"><a href="#cb21-1535" aria-hidden="true" tabindex="-1"></a><span class="co">- [ ] Measurement methods for environmental variables</span></span>
<span id="cb21-1536"><a href="#cb21-1536" aria-hidden="true" tabindex="-1"></a><span class="co">- [ ] Size measurement methods for larvae</span></span>
<span id="cb21-1537"><a href="#cb21-1537" aria-hidden="true" tabindex="-1"></a><span class="co">- [ ] Taxonomist name(s) who identified specimens</span></span>
<span id="cb21-1538"><a href="#cb21-1538" aria-hidden="true" tabindex="-1"></a><span class="co">- [ ] Identification date(s)</span></span>
<span id="cb21-1539"><a href="#cb21-1539" aria-hidden="true" tabindex="-1"></a><span class="co">- [ ] Identification references used</span></span>
<span id="cb21-1540"><a href="#cb21-1540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1541"><a href="#cb21-1541" aria-hidden="true" tabindex="-1"></a><span class="al">###</span><span class="co"> Geographic Information</span></span>
<span id="cb21-1542"><a href="#cb21-1542" aria-hidden="true" tabindex="-1"></a><span class="co">- [ ] Geographic description of the study area</span></span>
<span id="cb21-1543"><a href="#cb21-1543" aria-hidden="true" tabindex="-1"></a><span class="co">- [ ] GPS accuracy (coordinate uncertainty in meters)</span></span>
<span id="cb21-1544"><a href="#cb21-1544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1545"><a href="#cb21-1545" aria-hidden="true" tabindex="-1"></a><span class="co">## Done</span></span>
<span id="cb21-1546"><a href="#cb21-1546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1547"><a href="#cb21-1547" aria-hidden="true" tabindex="-1"></a><span class="co">- [x] drop `lifeStageID` (does not exist) and make **eMoF** like ["Lifestage" in 16 Dataset Examples: ENV-DATA | The OBIS Manual](https://manual.obis.org/examples.html#:~:text=TripNR3242TripStationNR16781MidasTripActionID105598occurenceIDTA_105598_(Pseudo%2D)pediastrum_5-,Lifestage,-http%3A//vocab.nerc):</span></span>
<span id="cb21-1548"><a href="#cb21-1548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1549"><a href="#cb21-1549" aria-hidden="true" tabindex="-1"></a><span class="co">  - `measurementType`: "Lifestage"</span></span>
<span id="cb21-1550"><a href="#cb21-1550" aria-hidden="true" tabindex="-1"></a><span class="co">  - `measurementTypeID`: "http://vocab.nerc.ac.uk/collection/P01/current/LSTAGE01/"</span></span>
<span id="cb21-1551"><a href="#cb21-1551" aria-hidden="true" tabindex="-1"></a><span class="co">  - `measurementValue`: "adult" </span></span>
<span id="cb21-1552"><a href="#cb21-1552" aria-hidden="true" tabindex="-1"></a><span class="co">  - `measurementValueID`: "http://vocab.nerc.ac.uk/collection/S11/current/S1116/"</span></span>
<span id="cb21-1553"><a href="#cb21-1553" aria-hidden="true" tabindex="-1"></a><span class="co">  - `measurementUnit`:  </span></span>
<span id="cb21-1554"><a href="#cb21-1554" aria-hidden="true" tabindex="-1"></a><span class="co">  - `measurementUnitID`: </span></span>
<span id="cb21-1555"><a href="#cb21-1555" aria-hidden="true" tabindex="-1"></a><span class="co">  - `measurementDeterminedBy`: "Flanders Marine Institute"</span></span>
<span id="cb21-1556"><a href="#cb21-1556" aria-hidden="true" tabindex="-1"></a><span class="co">  - `measurementMethod`: "identified and counted by image analysis and normalised to a unit volume of water body, validated by human"</span></span>
<span id="cb21-1557"><a href="#cb21-1557" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>