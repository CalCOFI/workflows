<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-11-11">

<title>Publish Larvae to OBIS</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="publish_larvae_to_obis_files/libs/clipboard/clipboard.min.js"></script>
<script src="publish_larvae_to_obis_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="publish_larvae_to_obis_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="publish_larvae_to_obis_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="publish_larvae_to_obis_files/libs/quarto-html/popper.min.js"></script>
<script src="publish_larvae_to_obis_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="publish_larvae_to_obis_files/libs/quarto-html/anchor.min.js"></script>
<link href="publish_larvae_to_obis_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="publish_larvae_to_obis_files/libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="publish_larvae_to_obis_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="publish_larvae_to_obis_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="publish_larvae_to_obis_files/libs/bootstrap/bootstrap-d6a003b94517c951b2d65075d42fb01b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="publish_larvae_to_obis_files/libs/quarto-diagram/mermaid.min.js"></script>
<script src="publish_larvae_to_obis_files/libs/quarto-diagram/mermaid-init.js"></script>
<link href="publish_larvae_to_obis_files/libs/quarto-diagram/mermaid.css" rel="stylesheet">
<link href="publish_larvae_to_obis_files/libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="publish_larvae_to_obis_files/libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<script src="publish_larvae_to_obis_files/libs/viz-1.8.2/viz.js"></script>
<link href="publish_larvae_to_obis_files/libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="publish_larvae_to_obis_files/libs/grViz-binding-1.0.11/grViz.js"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#goals" id="toc-goals" class="nav-link active" data-scroll-target="#goals"><span class="header-section-number">1</span> Goals</a>
  <ul class="collapse">
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">1.1</span> References</a></li>
  </ul></li>
  <li><a href="#show-database-tables" id="toc-show-database-tables" class="nav-link" data-scroll-target="#show-database-tables"><span class="header-section-number">2</span> Show Database Tables</a></li>
  <li><a href="#evaluate-merging-egg-and-larva-stage-tables" id="toc-evaluate-merging-egg-and-larva-stage-tables" class="nav-link" data-scroll-target="#evaluate-merging-egg-and-larva-stage-tables"><span class="header-section-number">3</span> Evaluate Merging Egg and Larva Stage Tables</a>
  <ul class="collapse">
  <li><a href="#egg-stages" id="toc-egg-stages" class="nav-link" data-scroll-target="#egg-stages"><span class="header-section-number">3.1</span> Egg Stages</a></li>
  <li><a href="#larva-stages" id="toc-larva-stages" class="nav-link" data-scroll-target="#larva-stages"><span class="header-section-number">3.2</span> Larva Stages</a></li>
  <li><a href="#dwclifestage" id="toc-dwclifestage" class="nav-link" data-scroll-target="#dwclifestage"><span class="header-section-number">3.3</span> dwc:lifeStage</a></li>
  <li><a href="#other-dataset-ices-eggs-and-larvae-obis" id="toc-other-dataset-ices-eggs-and-larvae-obis" class="nav-link" data-scroll-target="#other-dataset-ices-eggs-and-larvae-obis"><span class="header-section-number">3.4</span> other dataset: ICES Eggs and larvae | OBIS</a></li>
  <li><a href="#lifestage-s11---bodc-parameter-semantic-model-life-cycle-stages" id="toc-lifestage-s11---bodc-parameter-semantic-model-life-cycle-stages" class="nav-link" data-scroll-target="#lifestage-s11---bodc-parameter-semantic-model-life-cycle-stages"><span class="header-section-number">3.5</span> Lifestage S11 - BODC Parameter Semantic Model Life Cycle Stages</a></li>
  </ul></li>
  <li><a href="#prompt-claude-to-merge-egg-and-larva-tables" id="toc-prompt-claude-to-merge-egg-and-larva-tables" class="nav-link" data-scroll-target="#prompt-claude-to-merge-egg-and-larva-tables"><span class="header-section-number">4</span> Prompt Claude to merge egg and larva tables</a>
  <ul class="collapse">
  <li><a href="#current-state-analysis" id="toc-current-state-analysis" class="nav-link" data-scroll-target="#current-state-analysis"><span class="header-section-number">4.1</span> Current State Analysis</a></li>
  <li><a href="#recommended-strategy-consolidated-occurrence-with-emof-extension" id="toc-recommended-strategy-consolidated-occurrence-with-emof-extension" class="nav-link" data-scroll-target="#recommended-strategy-consolidated-occurrence-with-emof-extension"><span class="header-section-number">4.2</span> Recommended Strategy: Consolidated Occurrence with eMoF Extension</a></li>
  <li><a href="#part-1-fix-current-gbif-ipt-error" id="toc-part-1-fix-current-gbif-ipt-error" class="nav-link" data-scroll-target="#part-1-fix-current-gbif-ipt-error"><span class="header-section-number">4.3</span> Part 1: Fix Current GBIF IPT Error</a></li>
  <li><a href="#part-2-revised-data-structure-for-egglarva-merging" id="toc-part-2-revised-data-structure-for-egglarva-merging" class="nav-link" data-scroll-target="#part-2-revised-data-structure-for-egglarva-merging"><span class="header-section-number">4.4</span> Part 2: Revised Data Structure for Egg/Larva Merging</a></li>
  <li><a href="#part-3-life-stage-vocabulary-mapping" id="toc-part-3-life-stage-vocabulary-mapping" class="nav-link" data-scroll-target="#part-3-life-stage-vocabulary-mapping"><span class="header-section-number">4.5</span> Part 3: Life Stage Vocabulary Mapping</a></li>
  <li><a href="#part-4-data-aggregation-logic" id="toc-part-4-data-aggregation-logic" class="nav-link" data-scroll-target="#part-4-data-aggregation-logic"><span class="header-section-number">4.6</span> Part 4: Data Aggregation Logic</a></li>
  <li><a href="#part-5-required-vocabulary-uris" id="toc-part-5-required-vocabulary-uris" class="nav-link" data-scroll-target="#part-5-required-vocabulary-uris"><span class="header-section-number">4.7</span> Part 5: Required Vocabulary URIs</a></li>
  <li><a href="#part-6-implementation-changes-in-publish_larvae_to_obis.qmd" id="toc-part-6-implementation-changes-in-publish_larvae_to_obis.qmd" class="nav-link" data-scroll-target="#part-6-implementation-changes-in-publish_larvae_to_obis.qmd"><span class="header-section-number">4.8</span> Part 6: Implementation Changes in publish_larvae_to_obis.qmd</a></li>
  <li><a href="#expected-outcome" id="toc-expected-outcome" class="nav-link" data-scroll-target="#expected-outcome"><span class="header-section-number">4.9</span> Expected Outcome</a></li>
  <li><a href="#part-1-fix-gbif-ipt-error-use-proper-emof-format" id="toc-part-1-fix-gbif-ipt-error-use-proper-emof-format" class="nav-link" data-scroll-target="#part-1-fix-gbif-ipt-error-use-proper-emof-format"><span class="header-section-number">4.10</span> Part 1: Fix GBIF IPT Error &amp; Use Proper eMoF Format</a></li>
  <li><a href="#part-2-move-volume-sampled-to-event-core" id="toc-part-2-move-volume-sampled-to-event-core" class="nav-link" data-scroll-target="#part-2-move-volume-sampled-to-event-core"><span class="header-section-number">4.11</span> Part 2: Move Volume Sampled to Event Core</a></li>
  <li><a href="#part-3-restructured-occurrence-records" id="toc-part-3-restructured-occurrence-records" class="nav-link" data-scroll-target="#part-3-restructured-occurrence-records"><span class="header-section-number">4.12</span> Part 3: Restructured Occurrence Records</a></li>
  <li><a href="#part-4-extendedmeasurementorfact-structure" id="toc-part-4-extendedmeasurementorfact-structure" class="nav-link" data-scroll-target="#part-4-extendedmeasurementorfact-structure"><span class="header-section-number">4.13</span> Part 4: ExtendedMeasurementOrFact Structure</a></li>
  <li><a href="#part-5-life-stage-vocabulary-mapping" id="toc-part-5-life-stage-vocabulary-mapping" class="nav-link" data-scroll-target="#part-5-life-stage-vocabulary-mapping"><span class="header-section-number">4.14</span> Part 5: Life Stage Vocabulary Mapping</a></li>
  <li><a href="#part-6-required-p01-code-research" id="toc-part-6-required-p01-code-research" class="nav-link" data-scroll-target="#part-6-required-p01-code-research"><span class="header-section-number">4.15</span> Part 6: Required P01 Code Research</a></li>
  <li><a href="#part-7-implementation-changes-in-publish_larvae_to_obis.qmd" id="toc-part-7-implementation-changes-in-publish_larvae_to_obis.qmd" class="nav-link" data-scroll-target="#part-7-implementation-changes-in-publish_larvae_to_obis.qmd"><span class="header-section-number">4.16</span> Part 7: Implementation Changes in publish_larvae_to_obis.qmd</a></li>
  <li><a href="#part-8-expected-data-structure-changes" id="toc-part-8-expected-data-structure-changes" class="nav-link" data-scroll-target="#part-8-expected-data-structure-changes"><span class="header-section-number">4.17</span> Part 8: Expected Data Structure Changes</a></li>
  <li><a href="#summary-of-changes-to-publish_larvae_to_obis.qmd" id="toc-summary-of-changes-to-publish_larvae_to_obis.qmd" class="nav-link" data-scroll-target="#summary-of-changes-to-publish_larvae_to_obis.qmd"><span class="header-section-number">4.18</span> Summary of Changes to publish_larvae_to_obis.qmd</a></li>
  </ul></li>
  <li><a href="#prompt-claude-to-generate-darwincore" id="toc-prompt-claude-to-generate-darwincore" class="nav-link" data-scroll-target="#prompt-claude-to-generate-darwincore"><span class="header-section-number">5</span> Prompt Claude to Generate DarwinCore</a></li>
  <li><a href="#data-extraction-from-database" id="toc-data-extraction-from-database" class="nav-link" data-scroll-target="#data-extraction-from-database"><span class="header-section-number">6</span> Data Extraction from Database</a></li>
  <li><a href="#create-life-stage-vocabulary-lookup-tables" id="toc-create-life-stage-vocabulary-lookup-tables" class="nav-link" data-scroll-target="#create-life-stage-vocabulary-lookup-tables"><span class="header-section-number">7</span> Create Life Stage Vocabulary Lookup Tables</a></li>
  <li><a href="#create-event-hierarchy" id="toc-create-event-hierarchy" class="nav-link" data-scroll-target="#create-event-hierarchy"><span class="header-section-number">8</span> Create Event Hierarchy</a></li>
  <li><a href="#create-occurrence-records" id="toc-create-occurrence-records" class="nav-link" data-scroll-target="#create-occurrence-records"><span class="header-section-number">9</span> Create Occurrence Records</a></li>
  <li><a href="#create-extendedmeasurementorfact-extension" id="toc-create-extendedmeasurementorfact-extension" class="nav-link" data-scroll-target="#create-extendedmeasurementorfact-extension"><span class="header-section-number">10</span> Create ExtendedMeasurementOrFact Extension</a></li>
  <li><a href="#write-darwincore-archive-files" id="toc-write-darwincore-archive-files" class="nav-link" data-scroll-target="#write-darwincore-archive-files"><span class="header-section-number">11</span> Write DarwinCore Archive Files</a></li>
  <li><a href="#create-meta.xml-programmatically-by-cross-walking-csv-fields-to-dwc-terms" id="toc-create-meta.xml-programmatically-by-cross-walking-csv-fields-to-dwc-terms" class="nav-link" data-scroll-target="#create-meta.xml-programmatically-by-cross-walking-csv-fields-to-dwc-terms"><span class="header-section-number">12</span> Create meta.xml programmatically by cross-walking CSV fields to DwC terms</a></li>
  <li><a href="#create-eml-metadata" id="toc-create-eml-metadata" class="nav-link" data-scroll-target="#create-eml-metadata"><span class="header-section-number">13</span> Create EML Metadata</a></li>
  <li><a href="#data-quality-checks" id="toc-data-quality-checks" class="nav-link" data-scroll-target="#data-quality-checks"><span class="header-section-number">14</span> Data Quality Checks</a></li>
  <li><a href="#package-creation" id="toc-package-creation" class="nav-link" data-scroll-target="#package-creation"><span class="header-section-number">15</span> Package Creation</a></li>
  <li><a href="#check-csv" id="toc-check-csv" class="nav-link" data-scroll-target="#check-csv"><span class="header-section-number">16</span> Check CSV</a></li>
  <li><a href="#history-of-loading-into-ipt" id="toc-history-of-loading-into-ipt" class="nav-link" data-scroll-target="#history-of-loading-into-ipt"><span class="header-section-number">17</span> History of loading into IPT</a>
  <ul class="collapse">
  <li><a href="#second-attempt-after-aligning-to-obis-extendedmeasurementorfact" id="toc-second-attempt-after-aligning-to-obis-extendedmeasurementorfact" class="nav-link" data-scroll-target="#second-attempt-after-aligning-to-obis-extendedmeasurementorfact"><span class="header-section-number">17.1</span> 2025-11-11: Second attempt after aligning to OBIS extendedMeasurementOrFact</a></li>
  <li><a href="#first-attempt-to-load-into-gbif-ipt-as-sampling-evet-dataset" id="toc-first-attempt-to-load-into-gbif-ipt-as-sampling-evet-dataset" class="nav-link" data-scroll-target="#first-attempt-to-load-into-gbif-ipt-as-sampling-evet-dataset"><span class="header-section-number">17.2</span> 2025-11-10: First attempt to load into GBIF IPT as “Sampling evet” dataset</a></li>
  </ul></li>
  <li><a href="#questions" id="toc-questions" class="nav-link" data-scroll-target="#questions"><span class="header-section-number">18</span> Questions</a></li>
  <li><a href="#required-information-prompts" id="toc-required-information-prompts" class="nav-link" data-scroll-target="#required-information-prompts"><span class="header-section-number">19</span> Required Information Prompts</a>
  <ul class="collapse">
  <li><a href="#dataset-information" id="toc-dataset-information" class="nav-link" data-scroll-target="#dataset-information"><span class="header-section-number">19.1</span> Dataset Information</a></li>
  <li><a href="#personnel-information" id="toc-personnel-information" class="nav-link" data-scroll-target="#personnel-information"><span class="header-section-number">19.2</span> Personnel Information</a></li>
  <li><a href="#project-information" id="toc-project-information" class="nav-link" data-scroll-target="#project-information"><span class="header-section-number">19.3</span> Project Information</a></li>
  <li><a href="#methodology" id="toc-methodology" class="nav-link" data-scroll-target="#methodology"><span class="header-section-number">19.4</span> Methodology</a></li>
  <li><a href="#geographic-information" id="toc-geographic-information" class="nav-link" data-scroll-target="#geographic-information"><span class="header-section-number">19.5</span> Geographic Information</a></li>
  </ul></li>
  <li><a href="#todo" id="toc-todo" class="nav-link" data-scroll-target="#todo"><span class="header-section-number">20</span> TODO</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Publish Larvae to OBIS</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2025-11-11</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="goals" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="goals"><span class="header-section-number">1</span> Goals</h2>
<ul>
<li>Create a DarwinCore Archive (DwC-A) for CalCOFI ichthyoplankton (fish eggs and larvae) data to publish to OBIS.</li>
<li>Use the existing CalCOFI database schema and connection.</li>
<li>Ensure compliance with DarwinCore standards, including event hierarchy and extensions.</li>
</ul>
<section id="references" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="references"><span class="header-section-number">1.1</span> References</h3>
<p>DarwinCore:</p>
<ul>
<li><a href="https://manual.obis.org/">The OBIS Manual</a>
<ul>
<li><a href="https://manual.obis.org/data_format.html#extendedmeasurementorfact-extension-emof">7.2 ExtendedMeasurementOrFact Extension (eMoF) | The OBIS Manual</a> <img src="https://manual.obis.org/images/EventCoreSchema.png" class="img-fluid"></li>
<li><a href="https://manual.obis.org/ipt">20.2 IPT: Integrated Publishing Toolkit | The OBIS Manual</a></li>
</ul></li>
<li><a href="https://dwc.tdwg.org/terms/">Darwin Core Quick Reference Guide</a></li>
<li><a href="https://docs.gbif.org/guide-publishing-survey-data/en/">Guide for publishing biological survey and monitoring data to GBIF</a></li>
<li><a href="https://docs.gbif.org/survey-monitoring-quick-start/en/">Survey and Monitoring Data Quick-Start Guide: A how-to for updating a Darwin Core dataset using the Humboldt Extension</a></li>
<li><a href="https://ipt.gbif.org/manual/en/ipt/latest/best-practices-sampling-event-planned-additions">Best Practices in Publishing Sampling-event data - planned additions and notes for revision :: GBIF IPT User Manual</a></li>
</ul>
<p>CalCOFI:</p>
<ul>
<li><a href="https://calcofi.org/data/marine-ecosystem-data/fish-eggs-larvae/">CalCOFI.org: Fish Eggs &amp; Larvae</a>
<ul>
<li><a href="https://coastwatch.pfeg.noaa.gov/erddap/search/index.html?page=1&amp;itemsPerPage=1000&amp;searchFor=CalCOFI">ERDDAP: CoastWatch - Search ‘CalCOFI’</a>
<ul>
<li><a href="https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html">CalCOFI info</a></li>
</ul></li>
<li><a href="https://portal.edirepository.org/nis/mapbrowse?scope=edi&amp;identifier=109&amp;revision=4">EDI: CALCOFI fish larvae at 66 standard stations, 1966 - ongoing</a></li>
</ul></li>
</ul>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">:</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># commit</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># - [x] use lazy loading of tbl, so skip `|&gt; collect()`</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - [x] %&gt;% to |&gt;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - [x] invert events hierarchy: net -&gt; tow (-&gt; tow_type) -&gt; site -&gt; cruise -&gt; ship</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - [x] use UUID, ie drop prefix `urn:uuid:` for eventID, occurrenceID, measurementID</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># - [ ] Consider merging larva, larvastage, and larvasize into one occurrence table, since all sharing net_uuid, species_id</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  CalCOFI<span class="sc">/</span>calcofi4db, </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  DBI, dm, dplyr, DT, EML, glue, here, lubridate, purrr, readr, tibble, tidyr, uuid,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">quiet =</span> T)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">readr.show_col_types =</span> F)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset metadata - PROMPTS FOR REQUIRED INFORMATION</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>dataset_title    <span class="ot">&lt;-</span> <span class="st">"CalCOFI Fish Larvae Tows"</span> <span class="co"># Prompt: Enter dataset title</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>dataset_abstract <span class="ot">&lt;-</span> <span class="st">"Fish larvae counts and standardized counts for eggs captured in CalCOFI icthyoplankton nets (primarily vertical [Calvet or Pairovet], oblique [bongo or ring nets], and surface tows [Manta nets]) . Surface tows are normally standardized to count per 1,000 m3 strained. Oblique tows are normally standardized to count per 10 m2 of surface sampled."</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>dataset_keywords <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"atmosphere"</span>, <span class="st">"biology"</span>, <span class="st">"biosphere"</span>, <span class="st">"calcofi"</span>, <span class="st">"earth science"</span>, <span class="st">"environment"</span>, <span class="st">"latitude"</span>, <span class="st">"longitude"</span>, <span class="st">"ocean"</span>, <span class="st">"time"</span>) <span class="co"># GCMD Science Keywords (source: https://catalog.data.gov/dataset/calcofi-larvae-counts-positive-tows)</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># dataset_uuid &lt;- UUIDgenerate() # Or use existing dataset UUID</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>dir_out <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/darwincore/larvae"</span>)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># get database connection</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>schema <span class="ot">&lt;-</span> <span class="st">"dev"</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>con    <span class="ot">&lt;-</span> <span class="fu">get_db_con</span>(schema)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
</section>
<section id="show-database-tables" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="show-database-tables"><span class="header-section-number">2</span> Show Database Tables</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># exclude experimental tables</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>tbls <span class="ot">&lt;-</span> <span class="fu">dbListTables</span>(con) <span class="sc">|&gt;</span> </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sort</span>() <span class="sc">|&gt;</span> </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setdiff</span>(</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"schema_version"</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">"grid"</span>, <span class="st">"site_seg"</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">"bottle"</span>, <span class="st">"cast"</span>))</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># learn relations from database and draw</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>dm <span class="ot">&lt;-</span> <span class="fu">dm_from_con</span>(con, <span class="at">schema =</span> schema, <span class="at">table_names =</span> tbls, <span class="at">learn_keys  =</span> T)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_draw</span>(dm, <span class="at">view_type =</span> <span class="st">"all"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="fig-dm_tbls" class="cell-output-display quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dm_tbls-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="grViz html-widget html-fill-item" id="htmlwidget-babd383380e451866ff3" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-babd383380e451866ff3">{"x":{"diagram":"#data_model\ndigraph {\ngraph [rankdir=LR tooltip=\"Data Model\" ]\n\nnode [margin=0 fontcolor = \"#444444\" ]\n\nedge [color = \"#555555\", arrowsize = 1, ]\n\npack=true\npackmode= \"node\"\n\n  \"cruise\" [id = \"cruise\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">cruise<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"cruise_uuid\"><U>cruise_uuid<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">date_ym<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"ship_key\">ship_key<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"egg\" [id = \"egg\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">egg<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid\">net_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"species_id\">species_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">tally<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid, species_id\"><U>net_uuid, species_id<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"egg_stage\" [id = \"egg_stage\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">egg_stage<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid\">net_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"species_id\">species_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">stage<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">tally<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid, species_id, stage\"><U>net_uuid, species_id, stage<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"larva\" [id = \"larva\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">larva<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid\">net_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"species_id\">species_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">tally<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid, species_id\"><U>net_uuid, species_id<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"larva_size\" [id = \"larva_size\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">larva_size<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid\">net_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"species_id\">species_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">length_mm<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">tally<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid, species_id, length_mm\"><U>net_uuid, species_id, length_mm<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"larva_stage\" [id = \"larva_stage\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">larva_stage<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid\">net_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"species_id\">species_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">stage<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">tally<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid, species_id, stage\"><U>net_uuid, species_id, stage<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"net\" [id = \"net\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">net<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"net_uuid\"><U>net_uuid<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"tow_uuid\">tow_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">side<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">std_haul_factor<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">vol_sampled_m3<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">prop_sorted<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">smallplankton<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">totalplankton<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"ship\" [id = \"ship\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">ship<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"ship_key\"><U>ship_key<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">ship_name<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">ship_nodc<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"site\" [id = \"site\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">site<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"site_uuid\"><U>site_uuid<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"cruise_uuid\">cruise_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">orderocc<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">longitude<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">latitude<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">line<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">station<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">geom<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">grid_key<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"species\" [id = \"species\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">species<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"species_id\"><U>species_id<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">scientific_name<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">itis_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">worms_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">common_name<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"tow\" [id = \"tow\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">tow<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"tow_uuid\"><U>tow_uuid<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"site_uuid\">site_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"tow_type_key\">tow_type_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">tow_number<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">time_start<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"tow_type\" [id = \"tow_type\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">tow_type<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"tow_type_key\"><U>tow_type_key<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\">description<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n\"site\":\"cruise_uuid\"->\"cruise\":\"cruise_uuid\" [id=\"site_1\"]\n\"egg\":\"net_uuid\"->\"net\":\"net_uuid\" [id=\"egg_1\"]\n\"egg_stage\":\"net_uuid\"->\"net\":\"net_uuid\" [id=\"egg_stage_1\"]\n\"larva\":\"net_uuid\"->\"net\":\"net_uuid\" [id=\"larva_1\"]\n\"larva_size\":\"net_uuid\"->\"net\":\"net_uuid\" [id=\"larva_size_1\"]\n\"larva_stage\":\"net_uuid\"->\"net\":\"net_uuid\" [id=\"larva_stage_1\"]\n\"cruise\":\"ship_key\"->\"ship\":\"ship_key\" [id=\"cruise_1\"]\n\"tow\":\"site_uuid\"->\"site\":\"site_uuid\" [id=\"tow_1\"]\n\"egg\":\"species_id\"->\"species\":\"species_id\" [id=\"egg_2\"]\n\"egg_stage\":\"species_id\"->\"species\":\"species_id\" [id=\"egg_stage_2\"]\n\"larva_size\":\"species_id\"->\"species\":\"species_id\" [id=\"larva_size_2\"]\n\"larva\":\"species_id\"->\"species\":\"species_id\" [id=\"larva_2\"]\n\"larva_stage\":\"species_id\"->\"species\":\"species_id\" [id=\"larva_stage_2\"]\n\"net\":\"tow_uuid\"->\"tow\":\"tow_uuid\" [id=\"net_1\"]\n\"tow\":\"tow_type_key\"->\"tow_type\":\"tow_type_key\" [id=\"tow_2\"]\n}","config":{"engine":null,"options":null}},"evals":[],"jsHooks":[]}</script>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dm_tbls-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Entity relationship diagram (ERD) of the CalCOFI database. Created using the data models <code>dm</code> R package function <a href="https://krlmlr.github.io/dm/reference/dm_draw.html"><code>dm_draw()</code></a>.
</figcaption>
</figure>
</div>
</div>
<div class="cell" data-file="diagrams/calcofi_erd.mmd" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-calcofi_erd" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-calcofi_erd-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-calcofi_erd">erDiagram
    net {
        string net_uuid PK
        string tow_uuid FK
        string side
        float std_haul_factor
        float vol_sampled_m3
        float prop_sorted
        float smallplankton
        float totalplankton
    }
    
    tow {
        string tow_uuid PK
        string site_uuid FK
        string tow_type_key FK
        int tow_number
        datetime time_start
    }
    
    site {
        string site_uuid PK
        string cruise_uuid FK
        string orderocc
        float longitude
        float latitude
        string line
        string station
    }
    
    cruise {
        string cruise_uuid PK
        string ship_key FK
        string date_ym
    }
    
    ship {
        string ship_key PK
        string ship_name
        string ship_nodc
    }
    
    tow_type {
        string tow_type_key PK
        string description
    }
    
    species {
        string species_id PK
        string scientific_name
        string itis_id
        string worms_id
        string common_name
    }
    
    larvastage {
        string net_uuid FK
        string species_id FK
        string stage
        int tally
    }
    
    egg {
        string net_uuid FK
        string species_id FK
        int tally
    }
    
    eggstage {
        string net_uuid FK
        string species_id FK
        string stage
        int tally
    }
    
    larva {
        string net_uuid FK
        string species_id FK
        int tally
    }
    
    larvasize {
        string net_uuid FK
        string species_id FK
        float length_mm
        int tally
    }

    %% Relationships
    net ||--o{ larvastage : "has"
    net ||--o{ egg : "has"
    net ||--o{ eggstage : "has"
    net ||--o{ larva : "has"
    net ||--o{ larvasize : "has"
    
    species ||--o{ larvastage : "identified_as"
    species ||--o{ egg : "identified_as"
    species ||--o{ eggstage : "identified_as"
    species ||--o{ larva : "identified_as"
    species ||--o{ larvasize : "identified_as"
    
    tow ||--o{ net : "uses"
    site ||--o{ tow : "conducted_at"
    cruise ||--o{ site : "visits"
    ship ||--o{ cruise : "operates"
    tow_type ||--o{ tow : "defines"</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-calcofi_erd-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Entity relationship diagram (ERD) of the CalCOFI database. Created from image above and prompt to <a href="https://claude.ai/">Claude</a>: ‘Generate an ERD mermaid diagram from the image.’
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="evaluate-merging-egg-and-larva-stage-tables" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="evaluate-merging-egg-and-larva-stage-tables"><span class="header-section-number">3</span> Evaluate Merging Egg and Larva Stage Tables</h2>
<section id="egg-stages" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="egg-stages"><span class="header-section-number">3.1</span> Egg Stages</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tbl</span>(con, <span class="st">"egg_stage"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(stage) <span class="sc">|&gt;</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(stage)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 15 × 2
   stage       n
   &lt;int&gt; &lt;int64&gt;
 1     1     346
 2     2    1684
 3     3    1703
 4     4    1279
 5     5    1685
 6     6    2693
 7     7    1995
 8     8    1644
 9     9    2247
10    10    2156
11    11    1746
12    12     727
13    13      41
14    14       6
15    15      16</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#    stage       n</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">#    &lt;int&gt; &lt;int64&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">#  1     1     346</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">#  2     2    1684</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">#  3     3    1703</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">#  4     4    1279</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">#  5     5    1685</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">#  6     6    2693</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">#  7     7    1995</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">#  8     8    1644</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">#  9     9    2247</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 10    10    2156</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 11    11    1746</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 12    12     727</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 13    13      41</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 14    14       6</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 15    15      16</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: ask Ed Weber what stages 12 through 15 mean?</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><a href="https://coastwatch.pfeg.noaa.gov/erddap/info/erdCalCOFIeggstg/index.html#:~:text=NC_GLOBAL-,summary,-String">ERDDAP - Information about CalCOFI NOAA Fish Egg Stages, from NOAA SWFSC</a>:</p>
<blockquote class="blockquote">
<p>Egg morphological developmental stage for eggs of selected species captured in CalCOFI icthyoplankton nets. Sequential developmental stages are described by Moser and Ahlstrom (1985; see the info url references section). –</p>
</blockquote>
<p>https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html:</p>
<blockquote class="blockquote">
<ul>
<li>Moser, H. G. and E. H. Ahlstrom. 1985. Staging anchovy eggs. An egg production method for estimating spawning biomass of pelagic fish: implication to the northern anchovy (Engraulis mordax). P. 37-41 in R. Lasker, ed.&nbsp;U.S. Dep. Commer. Tech. Rep.&nbsp;NMFS 36. (<a href="https://repository.library.noaa.gov/view/noaa/5695/noaa_5695_DS1.pdf">PDF</a>)</li>
</ul>
</blockquote>
<section id="stage-i" class="level4" data-number="3.1.1">
<h4 data-number="3.1.1" class="anchored" data-anchor-id="stage-i"><span class="header-section-number">3.1.1</span> Stage I</h4>
<p>Cell division has not yet begun. In intact eggs the cytoplasm of the single cell appears as a clear hemisphere at one pole, easily dif- ferentiated from the yolk mass which is divided into granules. The cytoplasm may be displaced to other locations around the periphery of the yolk mass, but there is usually some accumulation at one pole, which allows the stage to be identified.</p>
</section>
<section id="stage-ii" class="level4" data-number="3.1.2">
<h4 data-number="3.1.2" class="anchored" data-anchor-id="stage-ii"><span class="header-section-number">3.1.2</span> Stage II</h4>
<p>This begins with the division of the single cell into two cells or blastomeres. The division is first noticeable when a furrow develops in the middle of the cytoplasmic cap. Small bubble-like structures (probably artifacts) are often visible along the furrow and help iden- tify it. The next cleavage plane is at right angles to the first, and subsequent synchronous divisions in both meridional and latitudinal planes produce a hemispherical mound of cells, termed the blasto- disc. After the 5th or 6th division, the blastodisc has a berry-like appearance, the so-called “mulberry stage,” and with subsequent divisions the blastomeres become increasingly smaller and more difficult to distinguish individually. During a certain phase of the early divisions the blastomeres are about the same size as the yolk granules. Ifthe blastodisc and yolk mass become disrupted during collection or preservation, the blastomeres may become distributed among the yolk granules. They may be distinguished from one another since they have different refractive indices and the blastomeres appear darker when viewed with transmitted light.</p>
</section>
<section id="stage-iii" class="level4" data-number="3.1.3">
<h4 data-number="3.1.3" class="anchored" data-anchor-id="stage-iii"><span class="header-section-number">3.1.3</span> Stage III</h4>
<p>Ahlstrom (1943) defined this stage in sardine eggs as beginning with the appearance of the segmentation cavity. The segmentation cavity of teleost eggs is the space formed between the blastodisc and the yolk mass during late cleavage. In most anchovy eggs in our collec- tions the blastodisc is shrunken and somewhat cup-shaped and con- sequently the segmentation cavity, which is a delicate structure, is obliterated. We have found it preferable to define the beginning of Stage ill on the basis of the appearance of the blastoderm, i.e., when it has the appearance of tissue rather than of a collection of individual cells. This stage marks the beginning of gastrulation. The margin of the blastodisc becomes slightly thickened and is termed the germ ring. At one region of the germ ring the thickening extends inward to form the embryonic shield, which defines the future axis of the embryo. Gastrulation proceeds by further proliferation and downward movement of cells in the region of the germ ring by a process known as epiboly. Simultaneously, proliferation and inward migration (em- boly) of cells from the margin of the embryonic shield produce the organ-forming cell layers of the primordial embryo. At the end of Stage III the germ ring is one-third down the yolk mass and the bilateral nature of the primordial embryo is apparent.</p>
</section>
<section id="stage-iv" class="level4" data-number="3.1.4">
<h4 data-number="3.1.4" class="anchored" data-anchor-id="stage-iv"><span class="header-section-number">3.1.4</span> Stage IV</h4>
<p>At the beginning of this stage the germ ring has enclosed one-third of the yolk mass and the embryo is beginning to form along the median region of the embryonic shield. At the end of this stage, defined by the germ ring enveloping two-thirds of the yolk, the head region of the embryo is becoming apparent.</p>
</section>
<section id="stage-v" class="level4" data-number="3.1.5">
<h4 data-number="3.1.5" class="anchored" data-anchor-id="stage-v"><span class="header-section-number">3.1.5</span> Stage V</h4>
<p>This stage begins with the germ ring two-thirds down the yolk and ends with the closure of the blastopore and the complete enclosure of the yolk by the cellular sheath of the embryo. The stage is charac- terized by rapid differentiation resulting in the formation of several somites in the midregion of the embryonic axis, development of the notochord which can be seen from a dorsal viewpoint, and differ- entiation of the optic vesicles from the brain.</p>
</section>
<section id="stage-vi" class="level4" data-number="3.1.6">
<h4 data-number="3.1.6" class="anchored" data-anchor-id="stage-vi"><span class="header-section-number">3.1.6</span> Stage VI</h4>
<p>This stage begins with the closure of the blastopore and ends when the tail starts to separate from the yolk mass. The embryonic sheath of cells is extremely thin and, in some samples, it may be difficult to determine the point of blastopore closure. In these cases the event can be estimated from the position of the caudal terminus of the embryonic axis, since it grows toward the pole with the edge of the cellular sheath. Initially the caudal region lies flat against the polar region of the yolk, then gradually thickens and becomes more round- ed at the tip until it is clearly separate from the yolk. During this stage the somites are apparent along the entire body axis (except at the caudal portion), the lens primordium appears in the eye, and the regions of the brain begin to differentiate.</p>
</section>
<section id="stage-vii" class="level4" data-number="3.1.7">
<h4 data-number="3.1.7" class="anchored" data-anchor-id="stage-vii"><span class="header-section-number">3.1.7</span> Stage VII</h4>
<p>At the beginning of this stage the tip of the tail free from the yolk is broadly rounded, then begins to narrow as it elongates. The noto- chord extends almost to the tip and the finfold is just becoming visi- ble. At the end of this stage the length of the free tail is one-half the length of the head. For this purpose, head length is considered the distance from the tip of the snout to the back of the cerebellum (see Fig. 2H). Relative tail length is the criterion for each remain- ing stage.</p>
</section>
<section id="stage-viii" class="level4" data-number="3.1.8">
<h4 data-number="3.1.8" class="anchored" data-anchor-id="stage-viii"><span class="header-section-number">3.1.8</span> Stage VIII</h4>
<p>This stage begins when the free tail length is l:,reater than one-half the head length and ends when tail length equals head length. The tail becomes pointed during this stage and begins to bend away from the axis of the body, to the right or left side. The curvature of the tail generally increases with development, but is subject to individual variability (Fig. 2). Judgement is required in compensating for curva- ture in estimating relative tail length; however, accuracy and preci- sion increase rapidly with practice.</p>
</section>
<section id="stage-ix" class="level4" data-number="3.1.9">
<h4 data-number="3.1.9" class="anchored" data-anchor-id="stage-ix"><span class="header-section-number">3.1.9</span> Stage IX</h4>
<p>This stage begins with the tail extending one-quarter the length of the yolk sac and ends when it reaches one-half the yolk sac length. The gut is now apparent along the ventral surface of the tail, and its terminal section passes through the fin fold which is now con- siderably wider than in the previous stage. The pectoral fin buds appear as lateral thickenings as do the otic vesicles.</p>
</section>
<section id="stage-x" class="level4" data-number="3.1.10">
<h4 data-number="3.1.10" class="anchored" data-anchor-id="stage-x"><span class="header-section-number">3.1.10</span> Stage X</h4>
<p>This stage starts when the tail is one-half the length of the yolk sac and ends when it reaches three-quarters of the yolk sac length.</p>
</section>
<section id="stage-xi" class="level4" data-number="3.1.11">
<h4 data-number="3.1.11" class="anchored" data-anchor-id="stage-xi"><span class="header-section-number">3.1.11</span> Stage XI</h4>
<p>This is the final stage before hatching and is defined by a tail length greater than three-quarters of the length of the yolk sac.</p>
</section>
</section>
<section id="larva-stages" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="larva-stages"><span class="header-section-number">3.2</span> Larva Stages</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tbl</span>(con, <span class="st">"larva_stage"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(stage) <span class="sc">|&gt;</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
  stage       n
  &lt;chr&gt; &lt;int64&gt;
1 FLEX    18882
2 POST    22446
3 PREF    56913
4 YOLK     5384
5 TRNS     1754</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 FLEX    18882</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 POST    22446</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 PREF    56913</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 YOLK     5384</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 TRNS     1754</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<ul>
<li><p><a href="https://coastwatch.pfeg.noaa.gov/erddap/info/erdCalCOFIlrvstg/index.html#:~:text=NC_GLOBAL-,summary,-String">ERDDAP - Information about CalCOFI NOAA Fish Larvae Stages, from NOAA SWFSC</a>:</p>
<blockquote class="blockquote">
<p>Developmental stages (yolk sac, preflexion, flexion, postflexion, or transformation) of selected fish larvae captured in CalCOFI icthyoplankton nets.</p>
</blockquote></li>
</ul>
</section>
<section id="dwclifestage" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="dwclifestage"><span class="header-section-number">3.3</span> dwc:lifeStage</h3>
<ul>
<li><p><a href="https://dwc.tdwg.org/list/#dwc_lifeStage">dwc:lifeStage (n_concepts: 39) Darwin Core List of Terms - Darwin Core</a></p></li>
<li><p><a href="https://registry.gbif.org/vocabulary/LifeStage">LifeStage | GBIF Registry Vocabulary</a> (n_concepts: 39) &gt; A vocabulary to capture the broad stages that an organism passes through during its life cycle. This vocabulary was assembled based on the observed terms commonly used by the open data community, including those from citizen scientists.</p>
<ul>
<li><p><a href="https://registry.gbif.org/vocabulary/LifeStage/concept/Egg"><strong>Egg</strong></a> (n_children: 0) &gt; The egg is the organic vessel containing the zygote in which an embryo develops until it can survive on its own, at which point the animal hatches</p></li>
<li><p><a href="https://registry.gbif.org/vocabulary/LifeStage/concept/Larva"><strong>Larva</strong></a> (n_children: 11) &gt; A larva is a distinct juvenile form many animals undergo before metamorphosis into adults. Larvae often have different body structures from the adult form, and may also have different habitats and feeding behaviors.</p></li>
</ul></li>
</ul>
</section>
<section id="other-dataset-ices-eggs-and-larvae-obis" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="other-dataset-ices-eggs-and-larvae-obis"><span class="header-section-number">3.4</span> other dataset: ICES Eggs and larvae | OBIS</h3>
<ul>
<li><p><a href="https://obis.org/dataset/66fe7e4b-ddcc-44aa-8378-c7c7482c2844">ICES Eggs and larvae | OBIS</a></p></li>
<li><p><a href="https://www.ices.dk/data/data-portals/Pages/Eggs-and-larvae.aspx">Eggs and larvae | ICES</a></p></li>
<li><p><a href="https://registry.gbif.org/vocabulary/LifeStage/concepts">Vocabularies/ LifeStage / concepts | GBIF Registry</a></p></li>
<li><p><a href="https://vocab.nerc.ac.uk/collection/S11/current/">BODC parameter semantic model biological entity development stage terms | NERC Vocabulary Server</a></p></li>
<li><p><a href="https://www.fisheries.noaa.gov/west-coast/science-data/frequently-asked-questions-about-ichthyoplankton">Frequently Asked Questions About Ichthyoplankton | NOAA Fisheries</a></p></li>
<li><p><a href="https://vocab.nerc.ac.uk/collection/P02/current/ZATX/">Zooplankton taxonomy-related abundance per unit volume of the water column | NVS</a></p></li>
<li><p><a href="https://manual.obis.org/vocabulary.html">14 Controlled vocabulary for eMoF | The OBIS Manual</a></p>
<ul>
<li><a href="https://mof.obis.org/">MoF viewer</a></li>
</ul></li>
<li><p><a href="https://vocab.nerc.ac.uk/collection/P01/current/Z830M00T/">P01 concept: Abundance of Fish (WoRMS 11676) [Stage: egg] per unit volume of the water body by optical microscopy | NVS</a></p>
<ul>
<li><a href="https://www.marinespecies.org/aphia.php?p=taxdetails&amp;id=11676">Pisces (11676; unaccepted Superclass) | WoRMS</a></li>
</ul></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://manual.obis.org/images/P01_wheel.png" class="img-fluid figure-img"></p>
<figcaption>VThe P01 wheel, demonstrating how P01 elements are represented by other NVS collections | Vocabulary - OBIS Manual</figcaption>
</figure>
</div>
</section>
<section id="lifestage-s11---bodc-parameter-semantic-model-life-cycle-stages" class="level3" data-number="3.5">
<h3 data-number="3.5" class="anchored" data-anchor-id="lifestage-s11---bodc-parameter-semantic-model-life-cycle-stages"><span class="header-section-number">3.5</span> Lifestage S11 - BODC Parameter Semantic Model Life Cycle Stages</h3>
<p>https://github.com/nvs-vocabs/S11</p>
<p>A controlled vocabulary for terms used in the BODC parameter semantic model to specify the development stage (life cycle stage) of a biological entity</p>
<p>Terms and mappings available from: http://vocab.nerc.ac.uk/collection/S11/current/</p>
<p>Search interface: https://www.bodc.ac.uk/resources/vocabularies/vocabulary_search/S11/</p>
<section id="request-for-new-terms-and-ways-to-contribute" class="level4" data-number="3.5.1">
<h4 data-number="3.5.1" class="anchored" data-anchor-id="request-for-new-terms-and-ways-to-contribute"><span class="header-section-number">3.5.1</span> Request for new terms and ways to contribute</h4>
<ul>
<li>Request for new S11 terms can be made using this <a href="https://docs.google.com/forms/d/e/1FAIpQLSe-ZTKJZmNT5FmyPRFsPsNt2hpB_gb6MAmm7Zp-7GSMpn5NFA/viewform?usp=pp_url&amp;entry.1396013310=S11">form</a></li>
</ul>
<p>Reporting errors or suggestions for improving content can be submitted as <a href="https://github.com/nvs-vocabs/S11/issues/new">regular issues</a> in this repository or emailed to vocab.services-at-bodc.ac.uk.</p>
</section>
</section>
</section>
<section id="prompt-claude-to-merge-egg-and-larva-tables" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="prompt-claude-to-merge-egg-and-larva-tables"><span class="header-section-number">4</span> Prompt Claude to merge egg and larva tables</h2>
<p>PROMPT (plan mode): Help me figure out a strategy for sensibly merging egg, egg_stage, larva, larva_stage into a DarwinCore archive that accounts for total count (ie <code>tally</code>), stage (combining egg and larva <code>stage</code>), and size (<code>length_mm</code>) by <code>net_uuid</code>. Also incorporate recommended vocabularies, per: - https://manual.obis.org/vocabulary.html - https://ipt.gbif.org/manual/en/ipt/latest/best-practices-sampling-event-data</p>
<p>Claude’s Plan: Strategy for Merging Egg/Larva Data into DarwinCore Archive</p>
<section id="current-state-analysis" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="current-state-analysis"><span class="header-section-number">4.1</span> Current State Analysis</h3>
<p>Your existing implementation creates <strong>separate occurrence records</strong> for each stage:</p>
<ul>
<li><code>egg</code> → lifeStage: “egg”</li>
<li><code>egg_stage</code> → lifeStage: “egg_1”, “egg_2”, etc.</li>
<li><code>larva</code> → lifeStage: “larva”</li>
<li><code>larva_stage</code> → lifeStage: “larva_FLEX”, “larva_POST”, etc.</li>
<li><code>larva_size</code> → lifeStage: “larva” (size in remarks)</li>
</ul>
<p>This creates 5 separate occurrence records for a single species in one net sample.</p>
</section>
<section id="recommended-strategy-consolidated-occurrence-with-emof-extension" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="recommended-strategy-consolidated-occurrence-with-emof-extension"><span class="header-section-number">4.2</span> Recommended Strategy: Consolidated Occurrence with eMoF Extension</h3>
<p>Following OBIS/GBIF best practices, I recommend <strong>consolidating to fewer occurrences</strong> and using the <strong>ExtendedMeasurementOrFact (eMoF)</strong> extension for detailed measurements:</p>
<p><strong>Approach: Two occurrences per species per net_uuid</strong></p>
<ul>
<li><strong>One “egg” occurrence</strong> (if eggs present)</li>
<li><strong>One “larva” occurrence</strong> (if larvae present)</li>
</ul>
<p><strong>Implementation Details:</strong></p>
<p><strong>1. Occurrence Extension:</strong></p>
<ul>
<li><code>occurrenceID</code>: UUID per life stage (egg or larva)</li>
<li>`eventID: Links to net_uuid</li>
<li>`lifeStage: Use S11 vocabulary terms:
<ul>
<li>`“egg” → http://vocab.nerc.ac.uk/collection/S11/current/S1110/</li>
<li>“larva” → http://vocab.nerc.ac.uk/collection/S11/current/S1133/</li>
</ul></li>
<li><code>organismQuantity</code>: <strong>TOTAL count</strong> (sum across all stages/sizes)</li>
<li><code>organismQuantityType</code>: “individuals”</li>
</ul>
<p><strong>2. MeasurementOrFact Extension for Stage Details:</strong></p>
<ul>
<li><code>occurrenceID</code>: Links to parent occurrence</li>
<li><code>measurementType</code>: “life stage abundance”</li>
<li><code>measurementTypeID</code>: P01 code for abundance by life stage</li>
<li><code>measurementValue</code>: tally for specific stage</li>
<li><code>measurementValueID</code>: S11 code for specific stage (e.g., “FLEX”, “POST”, “egg stage 5”)</li>
<li><code>measurementUnit</code>: “individuals”</li>
<li><code>measurementUnitID</code>: P06 code</li>
</ul>
<p><strong>3. MeasurementOrFact Extension for Size:</strong></p>
<ul>
<li><code>occurrenceID</code>: Links to larva occurrence</li>
<li><code>measurementType</code>: “body length”</li>
<li><code>measurementTypeID</code>: P01 code for body length (search P01 for appropriate term)</li>
<li><code>measurementValue</code>: length_mm value</li>
<li><code>measurementUnit</code>: “millimeters”</li>
<li><code>measurementUnitID</code>: http://vocab.nerc.ac.uk/collection/P06/current/UXMM/</li>
<li><code>measurementRemarks</code>: Include tally if multiple individuals at same length</li>
</ul>
<p><strong>Key Changes Required:</strong></p>
<ol type="1">
<li><strong>Aggregate totals</strong> by net_uuid + species_id + major life stage (egg vs larva)</li>
<li><strong>Map stage vocabularies</strong> to S11 terms (needs vocabulary mapping table)</li>
<li><strong>Expand eMoF records</strong> for each stage detail instead of separate occurrences</li>
<li><strong>Add vocabulary URIs</strong> for measurementTypeID, measurementValueID, measurementUnitID</li>
<li><strong>Update meta.xml</strong> to properly define eMoF extension relationships</li>
</ol>
<p><strong>Benefits:</strong></p>
<p>✓ Follows OBIS/GBIF best practices ✓ Uses standardized vocabularies (S11, P01, P06) ✓ Reduces occurrence record count by ~5x ✓ Preserves all granular stage and size information ✓ Better separates taxonomy (occurrence) from measurements (eMoF) ✓ Makes data more queryable and comparable across datasets</p>
<p><strong>Questions to Resolve:</strong></p>
<ol type="1">
<li>Should we create separate occurrences for egg vs larva, or merge into one occurrence per species?</li>
</ol>
<p>Answer: Yes, keep separate occurrences for egg and larva.</p>
<ol start="2" type="1">
<li>How should we map egg stages (1-15) and larva stages (YOLK, PREF, FLEX, POST, TRNS) to S11 vocabulary? Map egg stages to S11 terms for egg development stages (if available) or create custom mappings. Map larva stages to corresponding S11 terms.</li>
</ol>
<p>Answer: Use S11 terms as prefix, ie “egg” or “larva”, and custom suffixes:</p>
<ul>
<li><p>Egg stages: “egg, stage 1 of 11 (Moser &amp; Ahlstrom, 1985)”, “egg, stage 2 of 11 (Moser &amp; Ahlstrom, 1985)”, …, “egg, stage 12 of 12 (Moser &amp; Ahlstrom, 1985)”, …, “egg, stage 15 of 12 (Moser &amp; Ahlstrom, 1985)” (admittedly stages 12 to 15 are unclear and will need revision later)</p></li>
<li><p>Larva stages: “larva, yolk sac”; “larva, preflexion”, “larva, flexion”; “larva, postflexion”; or “larva, transformation”</p></li>
</ul>
<ol start="3" type="1">
<li>For larva_size records with the same length_mm but different tallies - should we sum them or keep separate eMoF records?</li>
</ol>
<p>Always use the <code>larva.tally</code> and <code>egg.tally</code> as the overall count for the occurrence record. For <code>larva_size</code>, create separate eMoF records for each unique length_mm with its corresponding tally.</p>
<ol start="4" type="1">
<li>Also help debug GBIF IPT response from loading the existing dataset package as zip generated by <span class="citation" data-cites="publish_larvae_to_obis.qmd">@publish_larvae_to_obis.qmd</span> as a “Sampling event” in DarwinCore: “Skipped mapped term http://rs.tdwg.org/dwc/terms/eventID, which is unknown to extension http://rs.tdwg.org/dwc/terms/MeasurementOrFact”. I thought that eventID was required in both core and extension, but given the <a href="https://ipt.gbif.org/manual/en/ipt/latest/best-practices-sampling-event-data#brackish-water-invertebrates-survey">Example: Brackish water invertebrates survey – Best Practices in Publishing Sampling-event data :: GBIF IPT User Manual</a> perhaps it should be called “EventID” instead of “eventID”?</li>
</ol>
<p>Comprehensive Strategy for DarwinCore Archive Implementation</p>
</section>
<section id="part-1-fix-current-gbif-ipt-error" class="level3" data-number="4.3">
<h3 data-number="4.3" class="anchored" data-anchor-id="part-1-fix-current-gbif-ipt-error"><span class="header-section-number">4.3</span> Part 1: Fix Current GBIF IPT Error</h3>
<p>Problem Identified: The <code>meta.xml:54-55</code> incorrectly defines eventID as BOTH:</p>
<ul>
<li><code>&lt;coreid index="0" /&gt;</code> (line 54) - the linking column</li>
<li><code>&lt;field index="0" term="...eventID"/&gt;</code> (line 55) - a data field</li>
</ul>
<p><strong>Solution</strong>: Remove line 55 from meta.xml. The coreid column should NOT be duplicated as a field definition. The corrected MeasurementOrFact extension should be:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode xml code-with-copy"><code class="sourceCode xml"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">extension</span> <span class="er">...</span><span class="ot"> rowType=</span><span class="st">"http://rs.tdwg.org/dwc/terms/MeasurementOrFact"</span>&gt;</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">coreid</span><span class="ot"> index=</span><span class="st">"0"</span> /&gt;</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">&lt;!-- Remove: &lt;field index="0" term="...eventID"/&gt; --&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">field</span><span class="ot"> index=</span><span class="st">"1"</span><span class="ot"> term=</span><span class="st">"http://rs.tdwg.org/dwc/terms/measurementType"</span>/&gt;</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">field</span><span class="ot"> index=</span><span class="st">"2"</span><span class="ot"> term=</span><span class="st">"http://rs.tdwg.org/dwc/terms/measurementValue"</span>/&gt;</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">field</span><span class="ot"> index=</span><span class="st">"7"</span><span class="ot"> term=</span><span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceID"</span>/&gt;</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">extension</span>&gt;</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Note: eventID (column 0) remains as coreid; occurrenceID (column 7) stays as a regular field for biological measurements.</p>
</section>
<section id="part-2-revised-data-structure-for-egglarva-merging" class="level3" data-number="4.4">
<h3 data-number="4.4" class="anchored" data-anchor-id="part-2-revised-data-structure-for-egglarva-merging"><span class="header-section-number">4.4</span> Part 2: Revised Data Structure for Egg/Larva Merging</h3>
<p>Based on your specifications:</p>
<p><strong>Occurrence Extension Structure</strong></p>
<p><strong>One occurrence per major life stage per species per net_uuid:</strong></p>
<ol type="1">
<li><strong>Egg occurrence</strong> (if eggs present):</li>
</ol>
<ul>
<li><code>occurrenceID</code>: UUID</li>
<li><code>eventID</code>: net_uuid</li>
<li><code>scientificName</code>: species name</li>
<li><code>lifeStage</code>: “egg” (with S11 URI)</li>
<li><code>organismQuantity</code>: <strong>egg.tally</strong> (total across all stages)</li>
<li><code>organismQuantityType</code>: “individuals”</li>
</ul>
<ol start="2" type="1">
<li><strong>Larva occurrence</strong> (if larvae present):</li>
</ol>
<ul>
<li><code>occurrenceID</code>: UUID</li>
<li><code>eventID</code>: net_uuid</li>
<li><code>scientificName</code>: species name</li>
<li><code>lifeStage</code>: “larva” (with S11 URI)</li>
<li><code>organismQuantity</code>: larva.tally (total across all stages)</li>
<li><code>organismQuantityType</code>: “individuals”</li>
</ul>
<p><strong>MeasurementOrFact Extension Structure</strong></p>
<p><strong>Three types of measurements:</strong></p>
<p><strong>1. Environmental measurements</strong> (link to eventID):</p>
<ul>
<li><code>eventID</code>: net_uuid</li>
<li><code>occurrenceID</code>: NA</li>
<li>Measurements: std_haul_factor, vol_sampled_m3, prop_sorted, smallplankton, totalplankton</li>
</ul>
<p><strong>2. Stage-specific counts</strong> (link to occurrenceID):</p>
<ul>
<li><code>eventID</code>: NA</li>
<li><code>occurrenceID</code>: links to egg or larva occurrence</li>
<li><code>measurementType</code>: “abundance by life stage”</li>
<li><code>measurementTypeID</code>: P01 code (TBD - search P01 for appropriate term)</li>
<li><code>measurementValue</code>: tally for specific stage</li>
<li><code>measurementValueID</code>: Custom life stage term (see vocabulary mapping below)</li>
<li><code>measurementUnit</code>: “individuals”</li>
<li><code>measurementUnitID</code>: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/</li>
</ul>
<p><strong>3. Size measurements</strong>2 (link to occurrenceID):</p>
<ul>
<li><code>eventID</code>: NA</li>
<li><code>occurrenceID</code>: links to larva occurrence</li>
<li><code>measurementType</code>: “body length”</li>
<li><code>measurementTypeID</code>: P01 code for body length</li>
<li><code>measurementValue</code>: length_mm</li>
<li><code>measurementUnit</code>: “millimeters”</li>
<li><code>measurementUnitID</code>: http://vocab.nerc.ac.uk/collection/P06/current/UXMM/</li>
<li><code>measurementRemarks</code>: Include tally value</li>
</ul>
</section>
<section id="part-3-life-stage-vocabulary-mapping" class="level3" data-number="4.5">
<h3 data-number="4.5" class="anchored" data-anchor-id="part-3-life-stage-vocabulary-mapping"><span class="header-section-number">4.5</span> Part 3: Life Stage Vocabulary Mapping</h3>
<p>Per your specifications, use S11 URI prefix with custom suffixes:</p>
<p><strong>Egg Stages (from egg_stage table)</strong>:</p>
<ul>
<li>Stage 1: “egg, stage 1 of 11 (Moser &amp; Ahlstrom, 1985)”</li>
<li>Stage 2: “egg, stage 2 of 11 (Moser &amp; Ahlstrom, 1985)” …</li>
<li>Stage 11: “egg, stage 11 of 11 (Moser &amp; Ahlstrom, 1985)”</li>
<li>Stage 12: “egg, stage 12 of 11 (Moser &amp; Ahlstrom, 1985)” [needs revision]</li>
<li>Stage 13: “egg, stage 13 of 11 (Moser &amp; Ahlstrom, 1985)” [needs revision]</li>
<li>Stage 14: “egg, stage 14 of 11 (Moser &amp; Ahlstrom, 1985)” [needs revision]</li>
<li>Stage 15: “egg, stage 15 of 11 (Moser &amp; Ahlstrom, 1985)” [needs revision]</li>
</ul>
<p><strong>S11 base URI</strong>: http://vocab.nerc.ac.uk/collection/S11/current/S1110/ (egg)</p>
<p><strong>Larva Stages (from larva_stage table)</strong>:</p>
<ul>
<li>YOLK: “larva, yolk sac”</li>
<li>PREF: “larva, preflexion”</li>
<li>FLEX: “larva, flexion”</li>
<li>POST: “larva, postflexion”</li>
<li>TRNS: “larva, transformation”</li>
</ul>
<p><strong>S11 base URI</strong>: http://vocab.nerc.ac.uk/collection/S11/current/S1133/ (larva)</p>
</section>
<section id="part-4-data-aggregation-logic" class="level3" data-number="4.6">
<h3 data-number="4.6" class="anchored" data-anchor-id="part-4-data-aggregation-logic"><span class="header-section-number">4.6</span> Part 4: Data Aggregation Logic</h3>
<p>SQL aggregation strategy:</p>
<ol type="1">
<li><strong>Create egg occurrences</strong>:</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  net_uuid,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  species_id,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">SUM</span>(tally) <span class="kw">as</span> total_tally  <span class="co">-- sum from egg table</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> egg</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> net_uuid, species_id</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ol start="2" type="1">
<li><strong>Create larva occurrences</strong>:</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  net_uuid,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  species_id,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">SUM</span>(tally) <span class="kw">as</span> total_tally  <span class="co">-- sum from larva table</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> larva</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> net_uuid, species_id</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ol start="3" type="1">
<li><strong>Create stage-specific eMoF records</strong>:</li>
</ol>
<ul>
<li>Join egg_stage → egg occurrence</li>
<li>Join larva_stage → larva occurrence</li>
<li>Each stage row becomes one eMoF measurement</li>
</ul>
<ol start="4" type="1">
<li><strong>Create size eMoF records</strong>:</li>
</ol>
<ul>
<li>Join larva_size → larva occurrence</li>
<li>Each unique length_mm becomes one eMoF measurement</li>
<li>Include tally in measurementRemarks</li>
</ul>
</section>
<section id="part-5-required-vocabulary-uris" class="level3" data-number="4.7">
<h3 data-number="4.7" class="anchored" data-anchor-id="part-5-required-vocabulary-uris"><span class="header-section-number">4.7</span> Part 5: Required Vocabulary URIs</h3>
<p>To add to the implementation:</p>
<ol type="1">
<li>lifeStage URIs:</li>
</ol>
<ul>
<li>Egg: http://vocab.nerc.ac.uk/collection/S11/current/S1110/</li>
<li>Larva: http://vocab.nerc.ac.uk/collection/S11/current/S1133/</li>
</ul>
<ol start="2" type="1">
<li><strong>measurementTypeID</strong> (P01 codes to research):</li>
</ol>
<ul>
<li>Abundance by life stage: [search P01 collection]</li>
<li>Body length: [search P01 collection for fish larvae length]</li>
</ul>
<ol start="3" type="1">
<li><strong>measurementUnitID</strong>:</li>
</ol>
<ul>
<li>Individuals: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/</li>
<li>Millimeters: http://vocab.nerc.ac.uk/collection/P06/current/UXMM/</li>
<li>Dimensionless: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/</li>
<li>Cubic meters: http://vocab.nerc.ac.uk/collection/P06/current/MCUB/</li>
<li>Grams: http://vocab.nerc.ac.uk/collection/P06/current/UGRM/</li>
<li>Proportion: http://vocab.nerc.ac.uk/collection/P06/current/UPCT/ (or dimensionless)</li>
</ul>
</section>
<section id="part-6-implementation-changes-in-publish_larvae_to_obis.qmd" class="level3" data-number="4.8">
<h3 data-number="4.8" class="anchored" data-anchor-id="part-6-implementation-changes-in-publish_larvae_to_obis.qmd"><span class="header-section-number">4.8</span> Part 6: Implementation Changes in publish_larvae_to_obis.qmd</h3>
<p>Key modifications needed:</p>
<ol type="1">
<li><strong>Aggregate occurrence data</strong> from 5 tables → 2 types (egg, larva)</li>
<li><strong>Update lifeStage field</strong> to use only “egg” or “larva” (not stage-specific)</li>
<li><strong>Expand eMoF records</strong> to include stage-specific counts</li>
<li><strong>Add vocabulary URI fields</strong>: lifeStageID, measurementTypeID, measurementValueID, measurementUnitID</li>
<li><strong>Fix meta.xml</strong> by removing duplicate eventID field definition</li>
<li><strong>Create stage vocabulary lookup table</strong> for mapping numeric/text stages to descriptive terms</li>
</ol>
</section>
<section id="expected-outcome" class="level3" data-number="4.9">
<h3 data-number="4.9" class="anchored" data-anchor-id="expected-outcome"><span class="header-section-number">4.9</span> Expected Outcome</h3>
<ul>
<li><p><strong>Occurrence reduction</strong>: From ~867k occurrence records → ~491k occurrence records (combining 5 tables into 2 life stages)</p></li>
<li><p><strong>eMoF expansion</strong>: From ~19k eMoF records → ~395k eMoF records (adding stage and size details) Benefits:</p></li>
</ul>
<p>✓ Follows OBIS/GBIF best practices ✓ Fixes GBIF IPT validation error ✓ Uses standardized vocabularies (S11, P01, P06) ✓ Preserves all granular data through eMoF ✓ Cleaner separation of taxonomy and measurements ✓ More queryable and comparable data structure</p>
<p>PROMPT: Instead of using MeasurementOrFact, be sure to explicitly use OBIS ExtendedMeasurementOrFact (eMoF) by for instance renaming output table to extendedMeasurementOrFact.csv and allowing occurrenceID to relate to individual occurrence records. Be sure to process https://manual.obis.org/format_emof.html and think hard before proceeding with plan and edits. Incorporate <code>vol_sampled_m3</code> as <code>sampleSizeValue</code> with <code>sampleSizeUnit</code> = “m^3”. Research good options to incorporate <strong>proportion sorted</strong> <code>prop_sorted</code> and if possible <strong>standard haul factor</strong> (<code>std_haul_factor</code>).</p>
<p>https://web.archive.org/web/20250417074825if_/https://calcofi.org/downloads/publications/atlases/CalCOFI_Atlas_28.pdf</p>
<p>DISTRIBUTIONAL ATLAS OF FISH LARVAE IN THE CALIFORNIA CURRENT REGION: NORTHERN ANCHOVY, Engraulis mordax GIRARD, 1966 THROUGH 1979 by Roger Hewitt</p>
<blockquote class="blockquote">
<p>Samples are standardized by adjusting to a standard unit of sea surface area. The standard unit is 10 m<sup>2</sup> and the adjustment (<strong>standard haul factor</strong>) is calculated as the ratio of a standard volume of water filtered per unit depth and the total volume of water filtered over the total depth. Thus:</p>
</blockquote>
<p><span class="math display">\[
SHF = ((10 m^3) / m) / (v/d) = 10 d
\]</span></p>
<blockquote class="blockquote">
<p>where <span class="math inline">\(v\)</span> is the volume of water filtered, determined by flowmeter, and <span class="math inline">\(d\)</span> is the depth fished, determined by the amount of wire out times the cosine of the average angle of stray from the vertical.</p>
<p>Sample counts were adjusted for fractioning (minimum aliquot was 25%) and standardized to each other. The charts are thus in units of the number of larvae under 10 m<sup>2</sup> of sea surface.</p>
</blockquote>
<p>[ <code>occurrence.csv: organismQuantity | organismQuantityType: "individuals"</code>]</p>
<p>Comprehensive Strategy for DarwinCore Archive with OBIS ExtendedMeasurementOrFact</p>
</section>
<section id="part-1-fix-gbif-ipt-error-use-proper-emof-format" class="level3" data-number="4.10">
<h3 data-number="4.10" class="anchored" data-anchor-id="part-1-fix-gbif-ipt-error-use-proper-emof-format"><span class="header-section-number">4.10</span> Part 1: Fix GBIF IPT Error &amp; Use Proper eMoF Format</h3>
<p>Critical Changes:</p>
<ol type="1">
<li><strong>Rename file</strong>: measurementorfact.csv → extendedMeasurementOrFact.csv</li>
<li><strong>Update rowType URI</strong> in meta.xml from:</li>
</ol>
<pre><code>rowType="http://rs.tdwg.org/dwc/terms/MeasurementOrFact"</code></pre>
<p>to:</p>
<pre><code>rowType="http://rs.gbif.org/terms/1.0/ExtendedMeasurementOrFact"</code></pre>
<p>or the OBIS schema URI:</p>
<pre><code>rowType="https://rs.gbif.org/extension/obis/extended_measurement_or_fact.xml"</code></pre>
<ol start="3" type="1">
<li><strong>Remove duplicate eventID field definition</strong> from meta.xml:</li>
</ol>
<ul>
<li>Keep: <code>&lt;coreid index="0" /&gt;</code> (links extension to core)</li>
<li>Remove: <code>&lt;field index="0" term="...eventID"/&gt;</code> (duplicates the coreid)</li>
</ul>
<ol start="4" type="1">
<li><strong>Retain occurrenceID field</strong> (index 7) to enable biological measurement linking</li>
</ol>
</section>
<section id="part-2-move-volume-sampled-to-event-core" class="level3" data-number="4.11">
<h3 data-number="4.11" class="anchored" data-anchor-id="part-2-move-volume-sampled-to-event-core"><span class="header-section-number">4.11</span> Part 2: Move Volume Sampled to Event Core</h3>
<p><strong>Change: vol_sampled_m3 from eMoF → Event core</strong></p>
<p>Add to event.csv and event section of meta.xml:</p>
<ul>
<li><code>sampleSizeValue</code>: value from net.vol_sampled_m3</li>
<li><code>sampleSizeUnit</code>: “m^3” (or “cubic meters”)</li>
</ul>
<p><strong>Rationale</strong>: Volume sampled is a fundamental sample attribute, not a measurement derived from the sample. OBIS best practices support placing this in the Event core.</p>
</section>
<section id="part-3-restructured-occurrence-records" class="level3" data-number="4.12">
<h3 data-number="4.12" class="anchored" data-anchor-id="part-3-restructured-occurrence-records"><span class="header-section-number">4.12</span> Part 3: Restructured Occurrence Records</h3>
<p><strong>Create TWO occurrences per species per net_uuid</strong>:</p>
<p><strong>Egg Occurrence (when eggs present)</strong>:</p>
<pre><code>occurrenceID: UUID
eventID: net_uuid
scientificName: species name from species table
scientificNameID: urn:lsid:marinespecies.org:taxname:{worms_id}
kingdom: Animalia
lifeStage: "egg"
lifeStageID: http://vocab.nerc.ac.uk/collection/S11/current/S1110/
organismQuantity: egg.tally (TOTAL across all stages)
organismQuantityType: "individuals"
occurrenceStatus: "present"
basisOfRecord: "HumanObservation"</code></pre>
<p><strong>Larva Occurrence (when larvae present)</strong>:</p>
<pre><code>occurrenceID: UUID
eventID: net_uuid
scientificName: species name from species table
scientificNameID: urn:lsid:marinespecies.org:taxname:{worms_id}
kingdom: Animalia
lifeStage: "larva"
lifeStageID: http://vocab.nerc.ac.uk/collection/S11/current/S1133/
organismQuantity: larva.tally (TOTAL across all stages)
organismQuantityType: "individuals"
occurrenceStatus: "present"
basisOfRecord: "HumanObservation"</code></pre>
<p><strong>Key change</strong>: Use aggregated totals from egg/larva tables, not stage-specific tables.</p>
</section>
<section id="part-4-extendedmeasurementorfact-structure" class="level3" data-number="4.13">
<h3 data-number="4.13" class="anchored" data-anchor-id="part-4-extendedmeasurementorfact-structure"><span class="header-section-number">4.13</span> Part 4: ExtendedMeasurementOrFact Structure</h3>
<p><strong>Three measurement categories</strong>:</p>
<ol type="1">
<li><strong>Sample-Level Measurements</strong> (link to eventID)</li>
</ol>
<p>A. <strong>Proportion Sorted</strong>:</p>
<pre><code>eventID: net_uuid
occurrenceID: [blank/NA]
measurementID: UUID
measurementType: "proportion of sample sorted"
measurementTypeID: [P01 code - TBD, search for "subsample fraction" or "sorting proportion"]
measurementValue: net.prop_sorted (e.g., "1" or "0.5")
measurementUnit: "dimensionless" or "proportion"
measurementUnitID: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/
measurementRemarks: "Fraction of total sample examined"</code></pre>
<p>B. <strong>Standard Haul Factor</strong>:</p>
<pre><code>eventID: net_uuid
occurrenceID: [blank/NA]
measurementID: UUID
measurementType: "standardized haul factor"
measurementTypeID: [P01 code - TBD, search for "catch standardization" or "sampling effort coefficient"]
measurementValue: net.std_haul_factor (e.g., "3.14")
measurementUnit: "dimensionless"
measurementUnitID: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/
measurementMethod: "https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"
measurementRemarks: "Standardization factor accounting for water filtered; abundances expressed as per 10 m² (Smith 1977)"</code></pre>
<p>C. <strong>Plankton Biomass</strong>:</p>
<pre><code>eventID: net_uuid
occurrenceID: [blank/NA]
measurementID: UUID
measurementType: "small plankton biomass" / "total plankton biomass"
measurementTypeID: [P01 code for biomass]
measurementValue: net.smallplankton / net.totalplankton
measurementUnit: "grams"
measurementUnitID: http://vocab.nerc.ac.uk/collection/P06/current/UGRM/</code></pre>
<ol start="2" type="1">
<li><strong>Stage-Specific Abundance</strong> (link to occurrenceID)</li>
</ol>
<p><strong>Egg stages</strong>:</p>
<pre><code>eventID: [blank/NA]
occurrenceID: egg occurrence UUID
measurementID: UUID
measurementType: "abundance by life stage"
measurementTypeID: [P01 code - search for "abundance" + "development stage"]
measurementValue: egg_stage.tally
measurementValueID: [custom vocabulary URI - see below]
measurementUnit: "individuals"
measurementUnitID: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/
measurementRemarks: "egg, stage {N} of 11 (Moser &amp; Ahlstrom, 1985)"</code></pre>
<p><strong>Larva stages</strong>:</p>
<pre><code>eventID: [blank/NA]
occurrenceID: larva occurrence UUID
measurementID: UUID
measurementType: "abundance by life stage"
measurementTypeID: [P01 code]
measurementValue: larva_stage.tally
measurementValueID: [custom vocabulary URI]
measurementUnit: "individuals"
measurementUnitID: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/
measurementRemarks: Life stage mapping (see Part 5)</code></pre>
<ol start="3" type="1">
<li><strong>Body Length Measurements</strong> (link to occurrenceID)</li>
</ol>
<pre><code>eventID: [blank/NA]
occurrenceID: larva occurrence UUID
measurementID: UUID
measurementType: "body length"
measurementTypeID: [P01 code for fish larvae length - e.g., OBSINDLX or similar]
measurementValue: larva_size.length_mm
measurementUnit: "millimeters"
measurementUnitID: http://vocab.nerc.ac.uk/collection/P06/current/UXMM/
measurementMethod: "https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"
measurementRemarks: "Count: {larva_size.tally}; Total length measurement"</code></pre>
</section>
<section id="part-5-life-stage-vocabulary-mapping" class="level3" data-number="4.14">
<h3 data-number="4.14" class="anchored" data-anchor-id="part-5-life-stage-vocabulary-mapping"><span class="header-section-number">4.14</span> Part 5: Life Stage Vocabulary Mapping</h3>
<p>Custom terms based on S11 vocabulary:</p>
<p><strong>Egg Stages (egg_stage.stage values 1-15)</strong>:</p>
<ul>
<li>Stage 1: “egg, stage 1 of 11 (Moser &amp; Ahlstrom, 1985)”</li>
<li>Stage 2: “egg, stage 2 of 11 (Moser &amp; Ahlstrom, 1985)”</li>
<li>…</li>
<li>Stage 11: “egg, stage 11 of 11 (Moser &amp; Ahlstrom, 1985)”</li>
<li>Stage 12-15: “egg, stage {N} of 12 (Moser &amp; Ahlstrom, 1985)” [pending revision]</li>
</ul>
<p>Base vocabulary: S11/S1110 (egg)</p>
<p><strong>Larva Stages</strong> (larva_stage.stage values):</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>stage</th>
<th>measurementRemarks</th>
<th>Custom term</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>YOLK</td>
<td>larva, yolk sac</td>
<td>Yolk-sac larva</td>
</tr>
<tr class="even">
<td>PREF</td>
<td>larva, preflexion</td>
<td>Preflexion larva</td>
</tr>
<tr class="odd">
<td>FLEX</td>
<td>larva, flexion</td>
<td>Flexion larva</td>
</tr>
<tr class="even">
<td>POST</td>
<td>larva, postflexion</td>
<td>Postflexion larva</td>
</tr>
<tr class="odd">
<td>TRNS</td>
<td>larva, transformation</td>
<td>Transformation stage larva</td>
</tr>
</tbody>
</table>
<p><strong>Base vocabulary</strong>: S11/S1133 (larva)</p>
<p><strong>Implementation</strong>: Create lookup table mapping stage codes to full descriptive terms.</p>
</section>
<section id="part-6-required-p01-code-research" class="level3" data-number="4.15">
<h3 data-number="4.15" class="anchored" data-anchor-id="part-6-required-p01-code-research"><span class="header-section-number">4.15</span> Part 6: Required P01 Code Research</h3>
<p>To complete before implementation, search P01 vocabulary for:</p>
<ol type="1">
<li>Proportion sorted:</li>
</ol>
<ul>
<li>Search terms: “subsample”, “fraction sorted”, “aliquot”</li>
<li>Alternative: Create custom term if no exact match</li>
</ul>
<ol type="1">
<li>Standard haul factor:</li>
</ol>
<ul>
<li>Search terms: “standardization”, “catch per unit effort”, “sampling effort coefficient”</li>
<li>Possibly related to CPUE codes</li>
</ul>
<ol type="1">
<li>Abundance by life stage:</li>
</ol>
<ul>
<li>Search terms: “abundance”, “count”, “life stage”, “development stage”</li>
<li>May need fish-specific or zooplankton codes</li>
</ul>
<ol type="1">
<li>Body length:</li>
</ol>
<ul>
<li>Search terms: “body length”, “total length”, “fish larvae”, “Actinopterygii”</li>
<li>Example code: OBSINDLX (commonly used for fish length)</li>
</ul>
<p><strong>P01 Search Tool</strong>: https://vocab.seadatanet.org/p01-facet-search</p>
</section>
<section id="part-7-implementation-changes-in-publish_larvae_to_obis.qmd" class="level3" data-number="4.16">
<h3 data-number="4.16" class="anchored" data-anchor-id="part-7-implementation-changes-in-publish_larvae_to_obis.qmd"><span class="header-section-number">4.16</span> Part 7: Implementation Changes in publish_larvae_to_obis.qmd</h3>
<p>Major code modifications:</p>
<ol type="1">
<li>Event Core: Add sampleSizeValue and sampleSizeUnit columns</li>
<li>Occurrence Extension:</li>
</ol>
<ul>
<li>Aggregate by (net_uuid, species_id, major life stage)</li>
<li>Reduce from 5 source tables to 2 occurrence types</li>
<li>Add lifeStageID field</li>
</ul>
<ol type="1">
<li>eMoF Extension:</li>
</ol>
<ul>
<li>Rename file to extendedMeasurementOrFact.csv</li>
<li>Remove vol_sampled_m3 (moved to Event)</li>
<li>Add prop_sorted and std_haul_factor as event-level measurements</li>
<li>Expand to include stage-specific abundances (egg_stage, larva_stage)</li>
<li>Include all larva_size measurements</li>
<li>Add all vocabulary ID fields: measurementTypeID, measurementValueID, measurementUnitID</li>
</ul>
<ol type="1">
<li>meta.xml:</li>
</ol>
<ul>
<li>Update eMoF rowType URI</li>
<li>Remove duplicate eventID field definition</li>
<li>Add sampleSizeValue/Unit to Event core mapping</li>
<li>Add vocabulary ID fields to eMoF mapping</li>
</ul>
</section>
<section id="part-8-expected-data-structure-changes" class="level3" data-number="4.17">
<h3 data-number="4.17" class="anchored" data-anchor-id="part-8-expected-data-structure-changes"><span class="header-section-number">4.17</span> Part 8: Expected Data Structure Changes</h3>
<p>Current structure:</p>
<ul>
<li>Occurrences: ~867k records (5 types per species/net)</li>
<li>eMoF: ~19k records (mostly environmental)</li>
</ul>
<p>New structure:</p>
<ul>
<li>Occurrences: ~491k records (2 types per species/net)</li>
<li>eMoF: ~395k records (environmental + stage counts + sizes)</li>
</ul>
<p><strong>Benefits</strong>:</p>
<p>✓ OBIS-compliant eMoF format ✓ Fixes GBIF IPT validation error ✓ Uses standardized vocabularies (S11, P01, P06) ✓ Preserves all data granularity ✓ Clearer semantic separation (taxonomy vs.&nbsp;measurements) ✓ More queryable for biological analyses ✓ Follows best practices for sampling-event datasets</p>
<p>Perfect! I’ve completed all the implementation tasks for merging the egg and larva data into a proper OBIS-compliant DarwinCore archive. Here’s a summary of all the changes made:</p>
</section>
<section id="summary-of-changes-to-publish_larvae_to_obis.qmd" class="level3" data-number="4.18">
<h3 data-number="4.18" class="anchored" data-anchor-id="summary-of-changes-to-publish_larvae_to_obis.qmd"><span class="header-section-number">4.18</span> Summary of Changes to publish_larvae_to_obis.qmd</h3>
<p>✅ Completed Implementation</p>
<ol type="1">
<li><strong>Event Core Updates</strong> <em>(lines 1082-1085)</em></li>
</ol>
<ul>
<li>Changed <code>sampleSizeUnit</code> from “cubic meters” to “m^3” per OBIS standards</li>
<li><code>vol_sampled_m3</code> now populates <code>sampleSizeValue</code> in Event core (removed from eMoF)</li>
</ul>
<ol start="2" type="1">
<li><strong>Life Stage Vocabulary Lookup Tables</strong> <em>(lines 948-1001 - NEW SECTION)</em></li>
</ol>
<ul>
<li>Created egg_stage_vocab: Maps stages 1-15 to descriptive terms following Moser &amp; Ahlstrom (1985)</li>
<li>Created larva_stage_vocab: Maps YOLK, PREF, FLEX, POST, TRNS to descriptive terms</li>
<li>Created measurement_unit_vocab: Maps units to P06 vocabulary URIs</li>
</ul>
<ol start="3" type="1">
<li><strong>Consolidated Occurrence Records</strong> <em>(lines 1129-1188)</em></li>
</ol>
<ul>
<li><strong>BEFORE</strong>: 5 separate occurrence types (egg, egg_stage, larva, larva_stage, larva_size)</li>
<li><strong>AFTER</strong>: 2 occurrence types per species per net (egg, larva)</li>
<li>Added <code>lifeStageID</code> field with S11 vocabulary URIs:
<ul>
<li>Egg: http://vocab.nerc.ac.uk/collection/S11/current/S1110/</li>
<li>Larva: http://vocab.nerc.ac.uk/collection/S11/current/S1133/</li>
</ul></li>
<li>Uses total counts from <code>egg.tally</code> and <code>larva.tally</code> for <code>organismQuantity</code></li>
</ul>
<ol start="4" type="1">
<li><strong>Completely Rewritten ExtendedMeasurementOrFact Extension</strong> <em>(lines 1245-1371)</em></li>
</ol>
<p>Created three measurement categories:</p>
<p><strong>A. Sample-level measurements</strong> (linked to eventID):</p>
<ul>
<li>std_haul_factor: Standardization factor</li>
<li>prop_sorted: Proportion of sample examined</li>
<li>smallplankton &amp; totalplankton: Biomass measurements</li>
<li>Includes measurementTypeID and measurementUnitID fields (with TODOs for P01 codes)</li>
</ul>
<p><strong>B. Stage-specific abundance</strong> (linked to occurrenceID):</p>
<ul>
<li>Egg stage abundances from egg_stage table</li>
<li>Larva stage abundances from larva_stage table</li>
<li>Uses descriptive stage terms in measurementRemarks</li>
<li>Includes measurementValueID for vocabulary references</li>
</ul>
<p><strong>C. Body length measurements</strong> (linked to occurrenceID):</p>
<ul>
<li>From larva_size table</li>
<li>Includes tally count in measurementRemarks</li>
</ul>
<p><strong>5. File Naming Updates</strong></p>
<ul>
<li>Output file renamed: measurementorfact.csv → extendedMeasurementOrFact.csv (line 1384)</li>
<li>Updated zip file creation (line 1702)</li>
<li>Updated data quality checks (line 1677)</li>
</ul>
<p><strong>6. Meta.xml Generation Updates</strong> <em>(lines 1393-1545)</em></p>
<ul>
<li>Updated rowType URI to: http://rs.gbif.org/terms/1.0/ExtendedMeasurementOrFact <em>(line 1437)</em></li>
<li>Added vocabulary ID field mappings:
<ul>
<li>measurementTypeID, measurementValueID, measurementUnitID</li>
<li>lifeStageID</li>
</ul></li>
<li><strong>Fixed GBIF IPT error</strong>: Modified create_field_elements() to skip coreid column (prevents duplicate eventID field definition)</li>
<li>Updated all filename references from measurementorfact to extendedMeasurementOrFact</li>
</ul>
<p><strong>📊 Expected Outcome</strong></p>
<p><strong>Current structure</strong> (before):</p>
<ul>
<li>Occurrences: ~867k records (5 types per species/net)</li>
<li>eMoF: ~19k records (mostly environmental)</li>
</ul>
<p><strong>New structure</strong> (after):</p>
<ul>
<li>Occurrences: ~491k records (2 types per species/net) - <strong>~43% reduction</strong></li>
<li>eMoF: ~395k records (environmental + stage counts + sizes) - <strong>~20x increase</strong></li>
</ul>
<p><strong>✨ Benefits</strong></p>
<p>✅ OBIS-compliant ExtendedMeasurementOrFact format ✅ Fixes GBIF IPT validation error (“eventID unknown to extension”) ✅ Uses standardized vocabularies (S11, P06) ✅ P01 codes ready to be added (TODOs marked in code) ✅ Preserves all granular data (stages, sizes) through eMoF ✅ Cleaner semantic separation (taxonomy vs.&nbsp;measurements) ✅ More queryable and comparable data structure ✅ Follows best practices for sampling-event datasets</p>
<p><strong>📝 Remaining TODOs in Code</strong></p>
<p>The following P01 vocabulary codes need to be researched and added:</p>
<ol type="1">
<li>Standard haul factor</li>
<li>Proportion sorted / subsample fraction</li>
<li>Zooplankton biomass</li>
<li>Abundance by life stage / development stage</li>
<li>Fish larvae body length</li>
</ol>
<p><strong>P01 Search Tool</strong>: https://vocab.seadatanet.org/p01-facet-search All changes are complete and ready for testing! The code should now generate a fully OBIS-compliant DarwinCore archive with proper ExtendedMeasurementOrFact extension.</p>
</section>
</section>
<section id="prompt-claude-to-generate-darwincore" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="prompt-claude-to-generate-darwincore"><span class="header-section-number">5</span> Prompt Claude to Generate DarwinCore</h2>
<p>PROMPT: Using the ERD above, create a Quarto document with chunks of R code and tidyverse style use of the database connection object <code>con</code> to generate a DarwinCore package using the <code>species.worms_id</code> (aka WoRMS AphiaID) to populate the species identifiers. Combine biological observation where possible, otherwise compose as seperate datasets, given the different biological observations: egg, eggstage, larva, larvasize, larvastage. Generate DarwinCore with as much of the extended information (i.e., <code>event</code>, <code>occurrence</code>, and <code>measurementOrFact</code> ) as possible. Compose Ecological Metadata Language (EML) metadata for the DarwinCore package, including the <code>dataset</code> and <code>creator</code> elements. Include prompts where more information is needed.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># knitr::opts_chunk$set(eval = F)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="data-extraction-from-database" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="data-extraction-from-database"><span class="header-section-number">6</span> Data Extraction from Database</h2>
<p>First, let’s extract all necessary tables from the database:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get simple lazy table references</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>tbl_ship        <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"ship"</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>tbl_cruise      <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"cruise"</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>tbl_site        <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"site"</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>tbl_tow         <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"tow"</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>tbl_tow_type    <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"tow_type"</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>tbl_net         <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"net"</span>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>tbl_species     <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"species"</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co"># biological observation tables</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>tbl_egg         <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"egg"</span>)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>tbl_egg_stage   <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"egg_stage"</span>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>tbl_larva       <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"larva"</span>)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>tbl_larva_stage <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"larva_stage"</span>)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>tbl_larva_size  <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"larva_size"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="create-life-stage-vocabulary-lookup-tables" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="create-life-stage-vocabulary-lookup-tables"><span class="header-section-number">7</span> Create Life Stage Vocabulary Lookup Tables</h2>
<p>Define mappings for egg and larva developmental stages to descriptive terms:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Egg stage vocabulary mapping (Moser &amp; Ahlstrom, 1985)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>egg_stage_vocab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">stage =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">stage_description =</span> <span class="fu">c</span>(</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 1 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 2 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 3 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 4 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 5 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 6 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 7 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 8 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 9 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 10 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 11 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 12 of 12 (Moser &amp; Ahlstrom, 1985)"</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: needs revision</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 13 of 12 (Moser &amp; Ahlstrom, 1985)"</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: needs revision</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 14 of 12 (Moser &amp; Ahlstrom, 1985)"</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: needs revision</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 15 of 12 (Moser &amp; Ahlstrom, 1985)"</span>  <span class="co"># </span><span class="al">TODO</span><span class="co">: needs revision</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Larva stage vocabulary mapping</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>larva_stage_vocab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">stage =</span> <span class="fu">c</span>(<span class="st">"YOLK"</span>, <span class="st">"PREF"</span>, <span class="st">"FLEX"</span>, <span class="st">"POST"</span>, <span class="st">"TRNS"</span>),</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">stage_description =</span> <span class="fu">c</span>(</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, yolk sac"</span>,</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, preflexion"</span>,</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, flexion"</span>,</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, postflexion"</span>,</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, transformation"</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a><span class="co"># P06 Measurement Unit vocabulary (NERC)</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>measurement_unit_vocab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">measurementUnit =</span> <span class="fu">c</span>(</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"individuals"</span>, <span class="st">"millimeters"</span>, <span class="st">"dimensionless"</span>, <span class="st">"cubic meters"</span>,</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"grams"</span>, <span class="st">"proportion"</span>, <span class="st">"m^3"</span>),</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">measurementUnitID =</span> <span class="fu">c</span>(</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UXMM/"</span>,</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/MCUB/"</span>,</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UGRM/"</span>,</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,  <span class="co"># or UPCT?</span></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/MCUB/"</span></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>  ))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="create-event-hierarchy" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="create-event-hierarchy"><span class="header-section-number">8</span> Create Event Hierarchy</h2>
<p>DarwinCore uses an event-based model. We’ll create a hierarchical event structure:</p>
<ul>
<li>cruise
<ul>
<li>site
<ul>
<li>tow
<ul>
<li>net</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<div class="cell" data-file="diagrams/larvae_event_hierarchy.mmd" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-larvae_event_hierarchy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-larvae_event_hierarchy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-larvae_event_hierarchy">graph TD
    A[Cruise Event] --&gt;|parentEventID| B[Site Event]
    B --&gt;|parentEventID| C[Tow Event]
    C --&gt;|parentEventID| D[Net Sample Event]
    D --&gt;|eventID| E[Occurrence Records]
    D --&gt;|eventID| F[MeasurementOrFact - Environmental]
    E --&gt;|occurrenceID| G[MeasurementOrFact - Size]
    
    A:::cruise
    B:::site
    C:::tow
    D:::net
    E:::occurrence
    F:::measurement
    G:::measurement
    
    classDef cruise fill:#e1f5ff,stroke:#0066cc,stroke-width:2px
    classDef site fill:#fff4e1,stroke:#ff9900,stroke-width:2px
    classDef tow fill:#ffe1f5,stroke:#cc0066,stroke-width:2px
    classDef net fill:#e1ffe1,stroke:#00cc66,stroke-width:2px
    classDef occurrence fill:#f0e1ff,stroke:#6600cc,stroke-width:2px
    classDef measurement fill:#ffe1e1,stroke:#cc0000,stroke-width:2px
    
    subgraph Event Core
        A
        B
        C
        D
    end
    
    subgraph Extensions
        E
        F
        G
    end</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-larvae_event_hierarchy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Event hierarchy for CalCOFI larvae data in DarwinCore Archive format with Extended Measurement or Fact.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Per <a href="https://docs.gbif.org/guide-publishing-survey-data/en/#simple-nested-datasets-with-project-level-information">3.3.2. Simple nested datasets with Project-level information – Guide for publishing biological survey and monitoring data to GBIF</a></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build complete event hierarchy</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>q_events <span class="ot">&lt;-</span> tbl_net <span class="sc">|&gt;</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_tow,      <span class="at">by =</span> <span class="st">"tow_uuid"</span>) <span class="sc">|&gt;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_tow_type, <span class="at">by =</span> <span class="st">"tow_type_key"</span>) <span class="sc">|&gt;</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_site,     <span class="at">by =</span> <span class="st">"site_uuid"</span>) <span class="sc">|&gt;</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_cruise,   <span class="at">by =</span> <span class="st">"cruise_uuid"</span>) <span class="sc">|&gt;</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_ship,     <span class="at">by =</span> <span class="st">"ship_key"</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create event core at different levels ----</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>flds_to_iso8601 <span class="ot">&lt;-</span>  <span class="cf">function</span>(flds, <span class="at">output =</span> <span class="st">"datetime"</span>) {</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># helper function to convert date/time fields to ISO 8601 format</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># per https://dwc.tdwg.org/terms/ eventDate: add 2007-03-01T13:00:00Z/2008-05-11T15:30:00Z (some time within the interval beginning 1 March 2007 at 1pm UTC and before 11 May 2008 at 3:30pm UTC)</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">length</span>(flds) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(output <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"datetime"</span>, <span class="st">"time"</span>))</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(flds) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> output <span class="sc">==</span> <span class="st">"datetime"</span>)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>      s <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"to_char({flds}, 'YYYY-MM-DD</span><span class="sc">\"</span><span class="st">T</span><span class="sc">\"</span><span class="st">HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">')"</span>)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(flds) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> output <span class="sc">==</span> <span class="st">"datetime"</span>)</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>      s <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"to_char({flds[1]}, 'YYYY-MM-DD</span><span class="sc">\"</span><span class="st">T</span><span class="sc">\"</span><span class="st">HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">') || '/' || </span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a><span class="st">         to_char({flds[2]}, 'YYYY-MM-DD</span><span class="sc">\"</span><span class="st">T</span><span class="sc">\"</span><span class="st">HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">')"</span>)</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(flds) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> output <span class="sc">==</span> <span class="st">"time"</span>)</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>      <span class="st">"to_char({flds}, 'HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">')"</span>)</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(flds) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> output <span class="sc">==</span> <span class="st">"time"</span>)</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>      <span class="st">"to_char({flds[1]}, 'HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">') || '/' || </span></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a><span class="st">       to_char({flds[2]}, 'HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">')"</span>)</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.character</span>(s)</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a><span class="co"># * Cruise level events ----</span></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a><span class="co"># get min/max datetimes for cruises</span></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>q_cruise_event_date <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cruise_uuid) <span class="sc">|&gt;</span></span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">dtime_min =</span> <span class="fu">min</span>(time_start, <span class="at">na.rm =</span> T),</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">dtime_max =</span> <span class="fu">max</span>(time_start, <span class="at">na.rm =</span> T),</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventDate =</span> <span class="fu">sql</span>(<span class="fu">flds_to_iso8601</span>(<span class="fu">c</span>(<span class="st">"dtime_min"</span>, <span class="st">"dtime_max"</span>))) ) <span class="sc">|&gt;</span> </span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(cruise_uuid, eventDate)</span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>q_cruise_events <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(cruise_uuid, ship_name, ship_nodc, date_ym) <span class="sc">|&gt;</span></span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID          =</span> cruise_uuid,</span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># parentEventID  = NA, # no parent for cruise level; NA generated with union_all</span></span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks     =</span> <span class="fu">paste</span>(<span class="st">"Cruise on"</span>, ship_name),</span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="st">"Marine plankton survey cruise"</span>,</span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeValue  =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeUnit   =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">habitat          =</span> <span class="st">"marine"</span>,</span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType        =</span> <span class="st">"cruise"</span>) <span class="sc">|&gt;</span></span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a>    q_cruise_event_date,</span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"cruise_uuid"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a>    eventID, <span class="co"># parentEventID, </span></span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a>    eventType, </span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a>    eventDate, samplingProtocol, eventRemarks, habitat)</span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Site level events</span></span>
<span id="cb26-70"><a href="#cb26-70" aria-hidden="true" tabindex="-1"></a>q_site_events <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb26-71"><a href="#cb26-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(site_uuid, cruise_uuid, longitude, latitude, line, station, orderocc) <span class="sc">|&gt;</span></span>
<span id="cb26-72"><a href="#cb26-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-73"><a href="#cb26-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID          =</span> site_uuid,</span>
<span id="cb26-74"><a href="#cb26-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">parentEventID    =</span> cruise_uuid,</span>
<span id="cb26-75"><a href="#cb26-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimalLatitude  =</span> latitude,</span>
<span id="cb26-76"><a href="#cb26-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimalLongitude =</span> longitude,</span>
<span id="cb26-77"><a href="#cb26-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks     =</span> <span class="fu">paste</span>(<span class="st">"CalCOFI station"</span>, station, <span class="st">"on line"</span>, line),</span>
<span id="cb26-78"><a href="#cb26-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># per https://proj.org/en/stable/operations/projections/calcofi.html</span></span>
<span id="cb26-79"><a href="#cb26-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">locationID       =</span> <span class="fu">paste0</span>(line, <span class="st">"_"</span>, station),</span>
<span id="cb26-80"><a href="#cb26-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType        =</span> <span class="st">"site"</span>,</span>
<span id="cb26-81"><a href="#cb26-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="st">"Marine plankton survey station"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb26-82"><a href="#cb26-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb26-83"><a href="#cb26-83" aria-hidden="true" tabindex="-1"></a>    eventID, parentEventID, eventType, </span>
<span id="cb26-84"><a href="#cb26-84" aria-hidden="true" tabindex="-1"></a>    samplingProtocol, eventRemarks, decimalLatitude, decimalLongitude, locationID)</span>
<span id="cb26-85"><a href="#cb26-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-86"><a href="#cb26-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Tow level events</span></span>
<span id="cb26-87"><a href="#cb26-87" aria-hidden="true" tabindex="-1"></a>q_tow_events <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb26-88"><a href="#cb26-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(</span>
<span id="cb26-89"><a href="#cb26-89" aria-hidden="true" tabindex="-1"></a>    tow_uuid, site_uuid, </span>
<span id="cb26-90"><a href="#cb26-90" aria-hidden="true" tabindex="-1"></a>    tow_number, tow_type_key, <span class="at">tow_type_description =</span> description, </span>
<span id="cb26-91"><a href="#cb26-91" aria-hidden="true" tabindex="-1"></a>    time_start) <span class="sc">|&gt;</span></span>
<span id="cb26-92"><a href="#cb26-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-93"><a href="#cb26-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID          =</span> tow_uuid,</span>
<span id="cb26-94"><a href="#cb26-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">parentEventID    =</span> site_uuid,</span>
<span id="cb26-95"><a href="#cb26-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventDate        =</span> <span class="fu">sql</span>(<span class="fu">flds_to_iso8601</span>(<span class="st">"time_start"</span>)),</span>
<span id="cb26-96"><a href="#cb26-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks     =</span> <span class="fu">paste</span>(<span class="st">"Tow"</span>, tow_number, <span class="st">"-"</span>, tow_type_description),</span>
<span id="cb26-97"><a href="#cb26-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType        =</span> <span class="st">"tow"</span>,</span>
<span id="cb26-98"><a href="#cb26-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="fu">paste</span>(tow_type_key, <span class="st">":"</span>, tow_type_description)) <span class="sc">|&gt;</span> </span>
<span id="cb26-99"><a href="#cb26-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb26-100"><a href="#cb26-100" aria-hidden="true" tabindex="-1"></a>    eventID, parentEventID, eventType,</span>
<span id="cb26-101"><a href="#cb26-101" aria-hidden="true" tabindex="-1"></a>    eventDate,</span>
<span id="cb26-102"><a href="#cb26-102" aria-hidden="true" tabindex="-1"></a>    samplingProtocol, eventRemarks)</span>
<span id="cb26-103"><a href="#cb26-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-104"><a href="#cb26-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Net level events (sampling events)</span></span>
<span id="cb26-105"><a href="#cb26-105" aria-hidden="true" tabindex="-1"></a>q_net_events_allflds <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb26-106"><a href="#cb26-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(</span>
<span id="cb26-107"><a href="#cb26-107" aria-hidden="true" tabindex="-1"></a>    net_uuid, tow_uuid, side, std_haul_factor, vol_sampled_m3, </span>
<span id="cb26-108"><a href="#cb26-108" aria-hidden="true" tabindex="-1"></a>    prop_sorted, smallplankton, totalplankton) <span class="sc">|&gt;</span></span>
<span id="cb26-109"><a href="#cb26-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-110"><a href="#cb26-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID          =</span> net_uuid,</span>
<span id="cb26-111"><a href="#cb26-111" aria-hidden="true" tabindex="-1"></a>    <span class="at">parentEventID    =</span> tow_uuid,</span>
<span id="cb26-112"><a href="#cb26-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks     =</span> <span class="fu">paste</span>(</span>
<span id="cb26-113"><a href="#cb26-113" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Net sample from side"</span>, side, <span class="st">"; only"</span>, prop_sorted, <span class="st">"proportion sorted of"</span>,</span>
<span id="cb26-114"><a href="#cb26-114" aria-hidden="true" tabindex="-1"></a>      vol_sampled_m3, <span class="st">"cubic meters sampled"</span>),</span>
<span id="cb26-115"><a href="#cb26-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType        =</span> <span class="st">"net_sample"</span>,</span>
<span id="cb26-116"><a href="#cb26-116" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="fu">paste</span>(<span class="st">"Plankton net tow -"</span>, side, <span class="st">"side"</span>),</span>
<span id="cb26-117"><a href="#cb26-117" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeValue  =</span> vol_sampled_m3,</span>
<span id="cb26-118"><a href="#cb26-118" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeUnit   =</span> <span class="st">"m^3"</span>)</span>
<span id="cb26-119"><a href="#cb26-119" aria-hidden="true" tabindex="-1"></a>q_net_events <span class="ot">&lt;-</span> q_net_events_allflds <span class="sc">|&gt;</span> </span>
<span id="cb26-120"><a href="#cb26-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb26-121"><a href="#cb26-121" aria-hidden="true" tabindex="-1"></a>    eventID, parentEventID, eventType, </span>
<span id="cb26-122"><a href="#cb26-122" aria-hidden="true" tabindex="-1"></a>    samplingProtocol, eventRemarks, sampleSizeValue, sampleSizeUnit)</span>
<span id="cb26-123"><a href="#cb26-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-124"><a href="#cb26-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all event levels</span></span>
<span id="cb26-125"><a href="#cb26-125" aria-hidden="true" tabindex="-1"></a>db_version <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"schema_version"</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(version)</span>
<span id="cb26-126"><a href="#cb26-126" aria-hidden="true" tabindex="-1"></a>dataset_id <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb26-127"><a href="#cb26-127" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "https://github.com/CalCOFI/calcofi4db/releases/tag/v", </span></span>
<span id="cb26-128"><a href="#cb26-128" aria-hidden="true" tabindex="-1"></a>  <span class="st">"calcofi_db."</span>, db_version,</span>
<span id="cb26-129"><a href="#cb26-129" aria-hidden="true" tabindex="-1"></a>  <span class="st">"_larvae."</span>, <span class="fu">format</span>(<span class="fu">Sys.Date</span>(), <span class="st">"%Y-%m-%d"</span>))</span>
<span id="cb26-130"><a href="#cb26-130" aria-hidden="true" tabindex="-1"></a><span class="co"># "calcofi_db.1.1.0_larvae.2025-10-09"</span></span>
<span id="cb26-131"><a href="#cb26-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-132"><a href="#cb26-132" aria-hidden="true" tabindex="-1"></a>q_event_core <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb26-133"><a href="#cb26-133" aria-hidden="true" tabindex="-1"></a>  q_cruise_events <span class="sc">|&gt;</span> </span>
<span id="cb26-134"><a href="#cb26-134" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb26-135"><a href="#cb26-135" aria-hidden="true" tabindex="-1"></a>      <span class="at">parentEventID   =</span> <span class="fu">sql</span>(<span class="st">"NULL::uuid"</span>),</span>
<span id="cb26-136"><a href="#cb26-136" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeValue =</span> <span class="fu">sql</span>(<span class="st">"NULL::numeric"</span>),</span>
<span id="cb26-137"><a href="#cb26-137" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeUnit  =</span> <span class="cn">NA_character_</span>),</span>
<span id="cb26-138"><a href="#cb26-138" aria-hidden="true" tabindex="-1"></a>  q_site_events <span class="sc">|&gt;</span> </span>
<span id="cb26-139"><a href="#cb26-139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb26-140"><a href="#cb26-140" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeValue =</span> <span class="fu">sql</span>(<span class="st">"NULL::numeric"</span>),</span>
<span id="cb26-141"><a href="#cb26-141" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeUnit  =</span> <span class="cn">NA_character_</span>),</span>
<span id="cb26-142"><a href="#cb26-142" aria-hidden="true" tabindex="-1"></a>  q_tow_events <span class="sc">|&gt;</span> </span>
<span id="cb26-143"><a href="#cb26-143" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb26-144"><a href="#cb26-144" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeValue =</span> <span class="fu">sql</span>(<span class="st">"NULL::numeric"</span>),</span>
<span id="cb26-145"><a href="#cb26-145" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeUnit  =</span> <span class="cn">NA_character_</span>),</span>
<span id="cb26-146"><a href="#cb26-146" aria-hidden="true" tabindex="-1"></a>  q_net_events) <span class="sc">|&gt;</span> </span>
<span id="cb26-147"><a href="#cb26-147" aria-hidden="true" tabindex="-1"></a>    <span class="fu">reduce</span>(union_all) <span class="sc">|&gt;</span> </span>
<span id="cb26-148"><a href="#cb26-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-149"><a href="#cb26-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># basisOfRecord                 = "HumanObservation",</span></span>
<span id="cb26-150"><a href="#cb26-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">geodeticDatum                 =</span> <span class="st">"WGS84"</span>,</span>
<span id="cb26-151"><a href="#cb26-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">coordinateUncertaintyInMeters =</span> <span class="dv">1000</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: adjust based on accuracy of GPS/Loran/dead-reckoning over time</span></span>
<span id="cb26-152"><a href="#cb26-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">countryCode                   =</span> <span class="st">"US"</span>,</span>
<span id="cb26-153"><a href="#cb26-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">waterBody                     =</span> <span class="st">"California Current"</span>,  <span class="co"># LME: http://marineregions.org/mrgid/8549</span></span>
<span id="cb26-154"><a href="#cb26-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasetID                     =</span> dataset_id)</span>
<span id="cb26-155"><a href="#cb26-155" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: datasetID: permalink to this qmd in calcofi4db release?</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="create-occurrence-records" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="create-occurrence-records"><span class="header-section-number">9</span> Create Occurrence Records</h2>
<p>Now let’s combine all biological observations into occurrence records:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create consolidated egg occurrences (one per species per net)</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>q_egg_occurrences <span class="ot">&lt;-</span> tbl_egg <span class="sc">|&gt;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_species, <span class="at">by =</span> <span class="st">"species_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID         =</span> <span class="fu">sql</span>(<span class="st">"gen_random_uuid()"</span>),</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID              =</span> net_uuid,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificName       =</span> scientific_name,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificNameID     =</span> <span class="fu">paste0</span>(<span class="st">"urn:lsid:marinespecies.org:taxname:"</span>, worms_id),</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">kingdom              =</span> <span class="st">"Animalia"</span>,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceStatus     =</span> <span class="fu">ifelse</span>(tally <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"present"</span>, <span class="st">"absent"</span>),</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantity     =</span> tally,  <span class="co"># TOTAL count from egg table</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantityType =</span> <span class="st">"individuals"</span>,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">lifeStage            =</span> <span class="st">"egg"</span>,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#lifeStage            = "https://vocab.nerc.ac.uk/collection/S11/current/S1122/",</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># lifeStageID          = "http://vocab.nerc.ac.uk/collection/S11/current/S1110/",</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">preparations         =</span> <span class="st">"egg sample"</span>,</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">basisOfRecord        =</span> <span class="st">"HumanObservation"</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    occurrenceID, eventID,</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    species_id,</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    scientificName, scientificNameID,</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    kingdom, occurrenceStatus, organismQuantity, organismQuantityType,</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    lifeStage, <span class="co"># lifeStageID, </span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>    preparations, basisOfRecord)</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Create consolidated larva occurrences (one per species per net)</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>q_larva_occurrences <span class="ot">&lt;-</span> tbl_larva <span class="sc">|&gt;</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_species, <span class="at">by =</span> <span class="st">"species_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID         =</span> <span class="fu">sql</span>(<span class="st">"gen_random_uuid()"</span>),</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID              =</span> net_uuid,</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificName       =</span> scientific_name,</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificNameID     =</span> <span class="fu">paste0</span>(<span class="st">"urn:lsid:marinespecies.org:taxname:"</span>, worms_id),</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">kingdom              =</span> <span class="st">"Animalia"</span>,</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceStatus     =</span> <span class="fu">ifelse</span>(tally <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"present"</span>, <span class="st">"absent"</span>),</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantity     =</span> tally,  <span class="co"># TOTAL count from larva table</span></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantityType =</span> <span class="st">"individuals"</span>,</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">lifeStage            =</span> <span class="st">"larva"</span>,</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># lifeStageID          = "http://vocab.nerc.ac.uk/collection/S11/current/S1133/",</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">preparations         =</span> <span class="st">"larva sample"</span>,</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">basisOfRecord        =</span> <span class="st">"HumanObservation"</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>    occurrenceID, eventID,</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>    species_id,</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>    scientificName, scientificNameID,</span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>    kingdom, occurrenceStatus, organismQuantity, organismQuantityType,</span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>    lifeStage, <span class="co"># lifeStageID, </span></span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>    preparations, basisOfRecord)</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine egg and larva occurrences</span></span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>q_occurrence_extension <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>  q_egg_occurrences,</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>  q_larva_occurrences) <span class="sc">|&gt;</span></span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reduce</span>(union_all) <span class="sc">|&gt;</span></span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add additional required/recommended fields</span></span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: identifiedBy, dateIdentified,identificationReferences</span></span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># identifiedBy = "[NEED IDENTIFIER NAME]", # Prompt: Add taxonomist name</span></span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dateIdentified = "[NEED IDENTIFICATION DATE]", # Prompt: Add identification date</span></span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># identificationReferences = "[NEED REFERENCES]", # Prompt: Add identification guides used</span></span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">modified =</span> <span class="fu">sql</span>(<span class="st">"CURRENT_DATE"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove species_id (internal field used only for joins)</span></span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a>    occurrenceID, eventID,</span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a>    scientificName, scientificNameID,</span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a>    kingdom, occurrenceStatus, organismQuantity, organismQuantityType,</span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a>    lifeStage, <span class="co"># lifeStageID, </span></span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true" tabindex="-1"></a>    preparations, basisOfRecord, modified)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="create-extendedmeasurementorfact-extension" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="create-extendedmeasurementorfact-extension"><span class="header-section-number">10</span> Create ExtendedMeasurementOrFact Extension</h2>
<p>Create eMoF records for three types of measurements: 1. Sample-level measurements (linked to eventID) 2. Stage-specific abundance (linked to occurrenceID) 3. Body length measurements (linked to occurrence ID)</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Sample-level measurements (eventID, occurrenceID = NA) ----</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>d_sample_measurements <span class="ot">&lt;-</span> q_net_events_allflds <span class="sc">|&gt;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    std_haul_factor, prop_sorted, smallplankton, totalplankton) <span class="sc">|&gt;</span>  <span class="co"># vol_sampled_m3 moved to Event core</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(std_haul_factor, prop_sorted, smallplankton, totalplankton),</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to  =</span> <span class="st">"meas_type"</span>,</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"measurementValue"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(measurementValue)) <span class="sc">|&gt;</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID      =</span> <span class="fu">UUIDgenerate</span>(<span class="at">n =</span> <span class="fu">n</span>()),</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID       =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType    =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span> <span class="sc">~</span> <span class="st">"standardized haul factor"</span>,</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span>     <span class="sc">~</span> <span class="st">"proportion of sample sorted"</span>,</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"smallplankton"</span>   <span class="sc">~</span> <span class="st">"small plankton biomass"</span>,</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"totalplankton"</span>   <span class="sc">~</span> <span class="st">"total plankton biomass"</span>),</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID  =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span> <span class="sc">~</span> <span class="cn">NA_character_</span>,  <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for standardization factor</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span>     <span class="sc">~</span> <span class="cn">NA_character_</span>,  <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for subsample fraction</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"smallplankton"</span>   <span class="sc">~</span> <span class="cn">NA_character_</span>,  <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for zooplankton biomass</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"totalplankton"</span>   <span class="sc">~</span> <span class="cn">NA_character_</span>), <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for zooplankton biomass</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit    =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span> <span class="sc">~</span> <span class="st">"dimensionless"</span>,</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span>     <span class="sc">~</span> <span class="st">"dimensionless"</span>,</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"smallplankton"</span>, <span class="st">"totalplankton"</span>) <span class="sc">~</span> <span class="st">"grams"</span>),</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod  =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> <span class="fu">case_when</span>(</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span> <span class="sc">~</span> <span class="st">"Standardization factor accounting for water filtered; abundances expressed as per 10 m² (Smith 1977)"</span>,</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span>     <span class="sc">~</span> <span class="st">"Fraction of total sample examined"</span>,</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span>)) <span class="sc">|&gt;</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>    eventID, occurrenceID, measurementID,</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>    measurementType, measurementTypeID, measurementValue,</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>    measurementUnit, measurementUnitID, measurementMethod, measurementRemarks)</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Stage-specific abundance (eventID = NA, occurrenceID) ----</span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Egg stage abundances - need to join with egg occurrences to get occurrenceID</span></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>d_egg_stage_abundance <span class="ot">&lt;-</span> tbl_egg_stage <span class="sc">|&gt;</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>    egg_stage_vocab <span class="sc">|&gt;</span> </span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">copy_to</span>(con, <span class="at">df =</span> _, <span class="at">name =</span> <span class="st">"egg_stage_vocab_tmp"</span>, <span class="at">temporary =</span> <span class="cn">TRUE</span>, <span class="at">overwrite =</span> T), <span class="at">by =</span> <span class="st">"stage"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>    q_egg_occurrences <span class="sc">|&gt;</span> <span class="fu">collect</span>() <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="at">net_uuid =</span> eventID, species_id, occurrenceID),</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"net_uuid"</span>, <span class="st">"species_id"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID            =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID      =</span> <span class="fu">UUIDgenerate</span>(<span class="at">n =</span> <span class="fu">n</span>()),</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType    =</span> <span class="st">"abundance by life stage"</span>,</span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID  =</span> <span class="cn">NA_character_</span>,  <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for "abundance" + "development stage"</span></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue   =</span> tally,</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValueID =</span> <span class="cn">NA_character_</span>,  <span class="co"># Could reference custom vocabulary for egg stages</span></span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit    =</span> <span class="st">"individuals"</span>,</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod  =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> stage_description) <span class="sc">|&gt;</span></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>    eventID, occurrenceID, measurementID,</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>    measurementType, measurementTypeID, measurementValue, measurementValueID,</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">#measurementUnit, measurementUnitID = measurementUnitID.y, measurementMethod, </span></span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>    measurementUnit, measurementUnitID, measurementMethod, measurementRemarks)</span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Larva stage abundances - need to join with larva occurrences to get occurrenceID</span></span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>d_larva_stage_abundance <span class="ot">&lt;-</span> tbl_larva_stage <span class="sc">|&gt;</span></span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(larva_stage_vocab <span class="sc">|&gt;</span> <span class="fu">copy_to</span>(con, <span class="at">df =</span> _, <span class="at">name =</span> <span class="st">"larva_stage_vocab_tmp"</span>, <span class="at">temporary =</span> <span class="cn">TRUE</span>, <span class="at">overwrite =</span> T), <span class="at">by =</span> <span class="st">"stage"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>    q_larva_occurrences <span class="sc">|&gt;</span> <span class="fu">collect</span>() <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="at">net_uuid =</span> eventID, species_id, occurrenceID),</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"net_uuid"</span>, <span class="st">"species_id"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID            =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID      =</span> <span class="fu">UUIDgenerate</span>(<span class="at">n =</span> <span class="fu">n</span>()),</span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType    =</span> <span class="st">"abundance by life stage"</span>,</span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID  =</span> <span class="cn">NA_character_</span>,  <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for "abundance" + "development stage"</span></span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue   =</span> tally,</span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValueID =</span> <span class="cn">NA_character_</span>,  <span class="co"># Could reference custom vocabulary for larva stages</span></span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit    =</span> <span class="st">"individuals"</span>,</span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod  =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> stage_description) <span class="sc">|&gt;</span></span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a>    eventID, occurrenceID, measurementID,</span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a>    measurementType, measurementTypeID, measurementValue, measurementValueID,</span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a>    measurementUnit, measurementUnitID, measurementMethod, measurementRemarks)</span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Body length measurements (eventID = NA, occurrenceID) ----</span></span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a>d_body_length <span class="ot">&lt;-</span> tbl_larva_size <span class="sc">|&gt;</span></span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a>    q_larva_occurrences <span class="sc">|&gt;</span> <span class="fu">collect</span>() <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="at">net_uuid =</span> eventID, species_id, occurrenceID),</span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"net_uuid"</span>, <span class="st">"species_id"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(length_mm)) <span class="sc">|&gt;</span></span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID            =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID      =</span> <span class="fu">UUIDgenerate</span>(<span class="at">n =</span> <span class="fu">n</span>()),</span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType    =</span> <span class="st">"body length"</span>,</span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID  =</span> <span class="cn">NA_character_</span>,  <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for fish larvae body length (e.g., OBSINDLX)</span></span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue   =</span> length_mm,</span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValueID =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit    =</span> <span class="st">"millimeters"</span>,</span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod  =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> <span class="fu">paste0</span>(<span class="st">"Count: "</span>, tally, <span class="st">"; Total length measurement"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a>    eventID, occurrenceID, measurementID,</span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a>    measurementType, measurementTypeID, measurementValue, measurementValueID,</span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a>    measurementUnit, measurementUnitID, measurementMethod, measurementRemarks)</span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all eMoF records ----</span></span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a>d_extendedmeasurementorfact_extension <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a>  d_sample_measurements,</span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a>  d_egg_stage_abundance,</span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a>  d_larva_stage_abundance,</span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a>  d_body_length)</span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a><span class="co"># table(is.na(d_extendedmeasurementorfact_extension$occurrenceID))</span></span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a><span class="co">#   FALSE    TRUE </span></span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a><span class="co"># 367,218 243,598</span></span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a><span class="co"># table(is.na(d_extendedmeasurementorfact_extension$eventID))</span></span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a><span class="co">#   FALSE    TRUE </span></span>
<span id="cb28-127"><a href="#cb28-127" aria-hidden="true" tabindex="-1"></a><span class="co"># 243,598 367,218</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="write-darwincore-archive-files" class="level2" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="write-darwincore-archive-files"><span class="header-section-number">11</span> Write DarwinCore Archive Files</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create output directory</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(dir_out, <span class="at">showWarnings =</span> F)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Write core and extension files</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(q_event_core           <span class="sc">|&gt;</span> <span class="fu">collect</span>(), <span class="fu">file.path</span>(dir_out, <span class="st">"event.csv"</span>))</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(q_occurrence_extension <span class="sc">|&gt;</span> <span class="fu">collect</span>(), <span class="fu">file.path</span>(dir_out, <span class="st">"occurrence.csv"</span>))</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d_extendedmeasurementorfact_extension, <span class="fu">file.path</span>(dir_out, <span class="st">"extendedMeasurementOrFact.csv"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="create-meta.xml-programmatically-by-cross-walking-csv-fields-to-dwc-terms" class="level2" data-number="12">
<h2 data-number="12" class="anchored" data-anchor-id="create-meta.xml-programmatically-by-cross-walking-csv-fields-to-dwc-terms"><span class="header-section-number">12</span> Create meta.xml programmatically by cross-walking CSV fields to DwC terms</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define DarwinCore term mappings for each file type</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>dwc_terms <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">event =</span> <span class="fu">list</span>(</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">rowType =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/Event"</span>,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">idField =</span> <span class="st">"eventID"</span>,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms   =</span> <span class="fu">c</span>(</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventID                       =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventID"</span>,</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">parentEventID                 =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/parentEventID"</span>,</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventType                     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventType"</span>,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventDate                     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventDate"</span>,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventTime                     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventTime"</span>,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">samplingProtocol              =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/samplingProtocol"</span>,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeValue               =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/sampleSizeValue"</span>,</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeUnit                =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/sampleSizeUnit"</span>,</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventRemarks                  =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventRemarks"</span>,</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">habitat                       =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/habitat"</span>,</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">decimalLatitude               =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/decimalLatitude"</span>,</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">decimalLongitude              =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/decimalLongitude"</span>,</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">geodeticDatum                 =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/geodeticDatum"</span>,</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">coordinateUncertaintyInMeters =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/coordinateUncertaintyInMeters"</span>,</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">locationID                    =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/locationID"</span>,</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">countryCode                   =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/countryCode"</span>,</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">waterBody                     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/waterBody"</span>,</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">datasetID                     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/datasetID"</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># basisOfRecord                 = "http://rs.tdwg.org/dwc/terms/basisOfRecord" </span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>      )),</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">occurrence =</span> <span class="fu">list</span>(</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">rowType     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/Occurrence"</span>,</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">idField     =</span> <span class="st">"occurrenceID"</span>,</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreIdField =</span> <span class="st">"eventID"</span>,</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms       =</span> <span class="fu">c</span>(</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">occurrenceID         =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceID"</span>,</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventID              =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventID"</span>,</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">scientificName       =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/scientificName"</span>,</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">scientificNameID     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/scientificNameID"</span>,</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">kingdom              =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/kingdom"</span>,</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">occurrenceStatus     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceStatus"</span>,</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">organismQuantity     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/organismQuantity"</span>,</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">organismQuantityType =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/organismQuantityType"</span>,</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">lifeStage            =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/lifeStage"</span>,</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>      <span class="co"># lifeStageID          = "http://rs.tdwg.org/dwc/terms/lifeStageID",</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">preparations         =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/preparations"</span>,</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">basisOfRecord        =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/basisOfRecord"</span>,</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">modified             =</span> <span class="st">"http://purl.org/dc/terms/modified"</span> )),</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">extendedmeasurementorfact =</span> <span class="fu">list</span>(</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">rowType     =</span> <span class="st">"http://rs.iobis.org/obis/terms/ExtendedMeasurementOrFact"</span>,</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">idField     =</span> <span class="st">"measurementID"</span>,</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreIdField =</span> <span class="st">"eventID"</span>,  <span class="co"># Primary linking field</span></span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms       =</span> <span class="fu">c</span>(</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventID              =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventID"</span>,</span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">occurrenceID         =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceID"</span>,</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementID        =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementID"</span>,</span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementType      =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementType"</span>,</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementTypeID    =</span> <span class="st">"http://rs.iobis.org/obis/terms/measurementTypeID"</span>,</span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementValue     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementValue"</span>,</span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementValueID   =</span> <span class="st">"http://rs.iobis.org/obis/terms/measurementValueID"</span>,</span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementUnit      =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementUnit"</span>,</span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementUnitID    =</span> <span class="st">"http://rs.iobis.org/obis/terms/measurementUnitID"</span>,</span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementMethod    =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementMethod"</span>,</span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementRemarks   =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementRemarks"</span> )))</span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to create field elements for meta.xml</span></span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>create_field_elements <span class="ot">&lt;-</span> <span class="cf">function</span>(csv_file, term_map, <span class="at">coreid_field =</span> <span class="cn">NULL</span>) {</span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read column names from CSV</span></span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">read_csv</span>(csv_file, <span class="at">n_max =</span> <span class="dv">0</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>))</span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Map columns to DwC terms</span></span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>  field_elements <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="fu">seq_along</span>(col_names), <span class="cf">function</span>(i) {</span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>    col <span class="ot">&lt;-</span> col_names[i]</span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skip coreid column if specified (it's defined separately in &lt;coreid&gt; element)</span></span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(coreid_field) <span class="sc">&amp;&amp;</span> col <span class="sc">==</span> coreid_field) {</span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a>    term <span class="ot">&lt;-</span> term_map<span class="sc">$</span>terms[[col]]</span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(term)) {</span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a>      glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'    &lt;field index="{i-1}" term="{term}"/&gt;'</span>)</span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Field exists in CSV but not in DwC mapping - skip or warn</span></span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Warning: Column '"</span>, col, <span class="st">"' in "</span>, csv_file, <span class="st">" has no DwC mapping and will be skipped in meta.xml."</span>)</span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NULL</span></span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove NULL entries and combine</span></span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a>  field_elements <span class="ot">&lt;-</span> <span class="fu">compact</span>(field_elements)</span>
<span id="cb30-89"><a href="#cb30-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(field_elements, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb30-90"><a href="#cb30-90" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-91"><a href="#cb30-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-92"><a href="#cb30-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to determine coreID index</span></span>
<span id="cb30-93"><a href="#cb30-93" aria-hidden="true" tabindex="-1"></a>get_coreid_index <span class="ot">&lt;-</span> <span class="cf">function</span>(csv_file, coreid_field) {</span>
<span id="cb30-94"><a href="#cb30-94" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">read_csv</span>(csv_file, <span class="at">n_max =</span> <span class="dv">0</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>))</span>
<span id="cb30-95"><a href="#cb30-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-96"><a href="#cb30-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Handle multiple possible coreID fields (eventID or occurrenceID)</span></span>
<span id="cb30-97"><a href="#cb30-97" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coreid_field) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb30-98"><a href="#cb30-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find which one exists in the CSV</span></span>
<span id="cb30-99"><a href="#cb30-99" aria-hidden="true" tabindex="-1"></a>    coreid_field <span class="ot">&lt;-</span> <span class="fu">intersect</span>(coreid_field, col_names)[<span class="dv">1</span>]</span>
<span id="cb30-100"><a href="#cb30-100" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-101"><a href="#cb30-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-102"><a href="#cb30-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">which</span>(col_names <span class="sc">==</span> coreid_field) <span class="sc">-</span> <span class="dv">1</span>  <span class="co"># 0-indexed</span></span>
<span id="cb30-103"><a href="#cb30-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-104"><a href="#cb30-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-105"><a href="#cb30-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate meta.xml content</span></span>
<span id="cb30-106"><a href="#cb30-106" aria-hidden="true" tabindex="-1"></a>generate_meta_xml <span class="ot">&lt;-</span> <span class="cf">function</span>(dir_out) {</span>
<span id="cb30-107"><a href="#cb30-107" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Core (Event)</span></span>
<span id="cb30-108"><a href="#cb30-108" aria-hidden="true" tabindex="-1"></a>  event_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"event.csv"</span>)</span>
<span id="cb30-109"><a href="#cb30-109" aria-hidden="true" tabindex="-1"></a>  event_fields <span class="ot">&lt;-</span> <span class="fu">create_field_elements</span>(event_file, dwc_terms<span class="sc">$</span>event)</span>
<span id="cb30-110"><a href="#cb30-110" aria-hidden="true" tabindex="-1"></a>  event_id_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(<span class="fu">read_csv</span>(event_file, <span class="at">n_max =</span> <span class="dv">0</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)) <span class="sc">==</span></span>
<span id="cb30-111"><a href="#cb30-111" aria-hidden="true" tabindex="-1"></a>                          dwc_terms<span class="sc">$</span>event<span class="sc">$</span>idField) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb30-112"><a href="#cb30-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-113"><a href="#cb30-113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extension: Occurrence</span></span>
<span id="cb30-114"><a href="#cb30-114" aria-hidden="true" tabindex="-1"></a>  occ_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"occurrence.csv"</span>)</span>
<span id="cb30-115"><a href="#cb30-115" aria-hidden="true" tabindex="-1"></a>  occ_fields <span class="ot">&lt;-</span> <span class="fu">create_field_elements</span>(occ_file, dwc_terms<span class="sc">$</span>occurrence, <span class="at">coreid_field =</span> dwc_terms<span class="sc">$</span>occurrence<span class="sc">$</span>coreIdField)</span>
<span id="cb30-116"><a href="#cb30-116" aria-hidden="true" tabindex="-1"></a>  occ_coreid_idx <span class="ot">&lt;-</span> <span class="fu">get_coreid_index</span>(occ_file, dwc_terms<span class="sc">$</span>occurrence<span class="sc">$</span>coreIdField)</span>
<span id="cb30-117"><a href="#cb30-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-118"><a href="#cb30-118" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extension: ExtendedMeasurementOrFact</span></span>
<span id="cb30-119"><a href="#cb30-119" aria-hidden="true" tabindex="-1"></a>  emof_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"extendedMeasurementOrFact.csv"</span>)</span>
<span id="cb30-120"><a href="#cb30-120" aria-hidden="true" tabindex="-1"></a>  emof_fields <span class="ot">&lt;-</span> <span class="fu">create_field_elements</span>(emof_file, dwc_terms<span class="sc">$</span>extendedmeasurementorfact, <span class="at">coreid_field =</span> dwc_terms<span class="sc">$</span>extendedmeasurementorfact<span class="sc">$</span>coreIdField)</span>
<span id="cb30-121"><a href="#cb30-121" aria-hidden="true" tabindex="-1"></a>  emof_coreid_idx <span class="ot">&lt;-</span> <span class="fu">get_coreid_index</span>(emof_file, dwc_terms<span class="sc">$</span>extendedmeasurementorfact<span class="sc">$</span>coreIdField)</span>
<span id="cb30-122"><a href="#cb30-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-123"><a href="#cb30-123" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build complete meta.xml</span></span>
<span id="cb30-124"><a href="#cb30-124" aria-hidden="true" tabindex="-1"></a>  meta_xml <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span>
<span id="cb30-125"><a href="#cb30-125" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;archive xmlns="http://rs.tdwg.org/dwc/text/"</span></span>
<span id="cb30-126"><a href="#cb30-126" aria-hidden="true" tabindex="-1"></a><span class="st">         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</span></span>
<span id="cb30-127"><a href="#cb30-127" aria-hidden="true" tabindex="-1"></a><span class="st">         xsi:schemaLocation="http://rs.tdwg.org/dwc/text/ http://rs.tdwg.org/dwc/text/tdwg_dwc_text.xsd"&gt;</span></span>
<span id="cb30-128"><a href="#cb30-128" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;core encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="</span><span class="sc">\\</span><span class="st">n"</span></span>
<span id="cb30-129"><a href="#cb30-129" aria-hidden="true" tabindex="-1"></a><span class="st">        fieldsEnclosedBy=</span><span class="sc">\'</span><span class="st">"</span><span class="sc">\'</span><span class="st"> ignoreHeaderLines="1" rowType="{dwc_terms$event$rowType}"&gt;</span></span>
<span id="cb30-130"><a href="#cb30-130" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;files&gt;</span></span>
<span id="cb30-131"><a href="#cb30-131" aria-hidden="true" tabindex="-1"></a><span class="st">      &lt;location&gt;event.csv&lt;/location&gt;</span></span>
<span id="cb30-132"><a href="#cb30-132" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/files&gt;</span></span>
<span id="cb30-133"><a href="#cb30-133" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;id index="{event_id_idx}" /&gt;</span></span>
<span id="cb30-134"><a href="#cb30-134" aria-hidden="true" tabindex="-1"></a><span class="st">{event_fields}</span></span>
<span id="cb30-135"><a href="#cb30-135" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;/core&gt;</span></span>
<span id="cb30-136"><a href="#cb30-136" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="</span><span class="sc">\\</span><span class="st">n"</span></span>
<span id="cb30-137"><a href="#cb30-137" aria-hidden="true" tabindex="-1"></a><span class="st">             fieldsEnclosedBy=</span><span class="sc">\'</span><span class="st">"</span><span class="sc">\'</span><span class="st"> ignoreHeaderLines="1" rowType="{dwc_terms$occurrence$rowType}"&gt;</span></span>
<span id="cb30-138"><a href="#cb30-138" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;files&gt;</span></span>
<span id="cb30-139"><a href="#cb30-139" aria-hidden="true" tabindex="-1"></a><span class="st">      &lt;location&gt;occurrence.csv&lt;/location&gt;</span></span>
<span id="cb30-140"><a href="#cb30-140" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/files&gt;</span></span>
<span id="cb30-141"><a href="#cb30-141" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;coreid index="{occ_coreid_idx}" /&gt;</span></span>
<span id="cb30-142"><a href="#cb30-142" aria-hidden="true" tabindex="-1"></a><span class="st">{occ_fields}</span></span>
<span id="cb30-143"><a href="#cb30-143" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;/extension&gt;</span></span>
<span id="cb30-144"><a href="#cb30-144" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="</span><span class="sc">\\</span><span class="st">n"</span></span>
<span id="cb30-145"><a href="#cb30-145" aria-hidden="true" tabindex="-1"></a><span class="st">             fieldsEnclosedBy=</span><span class="sc">\'</span><span class="st">"</span><span class="sc">\'</span><span class="st"> ignoreHeaderLines="1" rowType="{dwc_terms$extendedmeasurementorfact$rowType}"&gt;</span></span>
<span id="cb30-146"><a href="#cb30-146" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;files&gt;</span></span>
<span id="cb30-147"><a href="#cb30-147" aria-hidden="true" tabindex="-1"></a><span class="st">      &lt;location&gt;extendedMeasurementOrFact.csv&lt;/location&gt;</span></span>
<span id="cb30-148"><a href="#cb30-148" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/files&gt;</span></span>
<span id="cb30-149"><a href="#cb30-149" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;coreid index="{emof_coreid_idx}" /&gt;</span></span>
<span id="cb30-150"><a href="#cb30-150" aria-hidden="true" tabindex="-1"></a><span class="st">{emof_fields}</span></span>
<span id="cb30-151"><a href="#cb30-151" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;/extension&gt;</span></span>
<span id="cb30-152"><a href="#cb30-152" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/archive&gt;'</span>)</span>
<span id="cb30-153"><a href="#cb30-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-154"><a href="#cb30-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(meta_xml)</span>
<span id="cb30-155"><a href="#cb30-155" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-156"><a href="#cb30-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-157"><a href="#cb30-157" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate and write meta.xml</span></span>
<span id="cb30-158"><a href="#cb30-158" aria-hidden="true" tabindex="-1"></a>meta_xml <span class="ot">&lt;-</span> <span class="fu">generate_meta_xml</span>(dir_out)</span>
<span id="cb30-159"><a href="#cb30-159" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(meta_xml, <span class="fu">file.path</span>(dir_out, <span class="st">"meta.xml"</span>))</span>
<span id="cb30-160"><a href="#cb30-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-161"><a href="#cb30-161" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Generated meta.xml with field mappings:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Generated meta.xml with field mappings:</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(meta_xml)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;archive xmlns="http://rs.tdwg.org/dwc/text/"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://rs.tdwg.org/dwc/text/ http://rs.tdwg.org/dwc/text/tdwg_dwc_text.xsd"&gt;
  &lt;core encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="\n"
        fieldsEnclosedBy='"' ignoreHeaderLines="1" rowType="http://rs.tdwg.org/dwc/terms/Event"&gt;
    &lt;files&gt;
      &lt;location&gt;event.csv&lt;/location&gt;
    &lt;/files&gt;
    &lt;id index="0" /&gt;
    &lt;field index="0" term="http://rs.tdwg.org/dwc/terms/eventID"/&gt;
    &lt;field index="1" term="http://rs.tdwg.org/dwc/terms/eventType"/&gt;
    &lt;field index="2" term="http://rs.tdwg.org/dwc/terms/eventDate"/&gt;
    &lt;field index="3" term="http://rs.tdwg.org/dwc/terms/samplingProtocol"/&gt;
    &lt;field index="4" term="http://rs.tdwg.org/dwc/terms/eventRemarks"/&gt;
    &lt;field index="5" term="http://rs.tdwg.org/dwc/terms/habitat"/&gt;
    &lt;field index="6" term="http://rs.tdwg.org/dwc/terms/parentEventID"/&gt;
    &lt;field index="7" term="http://rs.tdwg.org/dwc/terms/sampleSizeValue"/&gt;
    &lt;field index="8" term="http://rs.tdwg.org/dwc/terms/sampleSizeUnit"/&gt;
    &lt;field index="9" term="http://rs.tdwg.org/dwc/terms/decimalLatitude"/&gt;
    &lt;field index="10" term="http://rs.tdwg.org/dwc/terms/decimalLongitude"/&gt;
    &lt;field index="11" term="http://rs.tdwg.org/dwc/terms/locationID"/&gt;
    &lt;field index="12" term="http://rs.tdwg.org/dwc/terms/geodeticDatum"/&gt;
    &lt;field index="13" term="http://rs.tdwg.org/dwc/terms/coordinateUncertaintyInMeters"/&gt;
    &lt;field index="14" term="http://rs.tdwg.org/dwc/terms/countryCode"/&gt;
    &lt;field index="15" term="http://rs.tdwg.org/dwc/terms/waterBody"/&gt;
    &lt;field index="16" term="http://rs.tdwg.org/dwc/terms/datasetID"/&gt;
  &lt;/core&gt;
  &lt;extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="\n"
             fieldsEnclosedBy='"' ignoreHeaderLines="1" rowType="http://rs.tdwg.org/dwc/terms/Occurrence"&gt;
    &lt;files&gt;
      &lt;location&gt;occurrence.csv&lt;/location&gt;
    &lt;/files&gt;
    &lt;coreid index="1" /&gt;
    &lt;field index="0" term="http://rs.tdwg.org/dwc/terms/occurrenceID"/&gt;
    &lt;field index="2" term="http://rs.tdwg.org/dwc/terms/scientificName"/&gt;
    &lt;field index="3" term="http://rs.tdwg.org/dwc/terms/scientificNameID"/&gt;
    &lt;field index="4" term="http://rs.tdwg.org/dwc/terms/kingdom"/&gt;
    &lt;field index="5" term="http://rs.tdwg.org/dwc/terms/occurrenceStatus"/&gt;
    &lt;field index="6" term="http://rs.tdwg.org/dwc/terms/organismQuantity"/&gt;
    &lt;field index="7" term="http://rs.tdwg.org/dwc/terms/organismQuantityType"/&gt;
    &lt;field index="8" term="http://rs.tdwg.org/dwc/terms/lifeStage"/&gt;
    &lt;field index="9" term="http://rs.tdwg.org/dwc/terms/preparations"/&gt;
    &lt;field index="10" term="http://rs.tdwg.org/dwc/terms/basisOfRecord"/&gt;
    &lt;field index="11" term="http://purl.org/dc/terms/modified"/&gt;
  &lt;/extension&gt;
  &lt;extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="\n"
             fieldsEnclosedBy='"' ignoreHeaderLines="1" rowType="http://rs.iobis.org/obis/terms/ExtendedMeasurementOrFact"&gt;
    &lt;files&gt;
      &lt;location&gt;extendedMeasurementOrFact.csv&lt;/location&gt;
    &lt;/files&gt;
    &lt;coreid index="0" /&gt;
    &lt;field index="1" term="http://rs.tdwg.org/dwc/terms/occurrenceID"/&gt;
    &lt;field index="2" term="http://rs.tdwg.org/dwc/terms/measurementID"/&gt;
    &lt;field index="3" term="http://rs.tdwg.org/dwc/terms/measurementType"/&gt;
    &lt;field index="4" term="http://rs.iobis.org/obis/terms/measurementTypeID"/&gt;
    &lt;field index="5" term="http://rs.tdwg.org/dwc/terms/measurementValue"/&gt;
    &lt;field index="6" term="http://rs.tdwg.org/dwc/terms/measurementUnit"/&gt;
    &lt;field index="7" term="http://rs.iobis.org/obis/terms/measurementUnitID"/&gt;
    &lt;field index="8" term="http://rs.tdwg.org/dwc/terms/measurementMethod"/&gt;
    &lt;field index="9" term="http://rs.tdwg.org/dwc/terms/measurementRemarks"/&gt;
    &lt;field index="10" term="http://rs.iobis.org/obis/terms/measurementValueID"/&gt;
  &lt;/extension&gt;
&lt;/archive&gt;</code></pre>
</div>
</div>
</section>
<section id="create-eml-metadata" class="level2" data-number="13">
<h2 data-number="13" class="anchored" data-anchor-id="create-eml-metadata"><span class="header-section-number">13</span> Create EML Metadata</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Geographic coverage</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>geo_coverage <span class="ot">&lt;-</span> tbl_site <span class="sc">|&gt;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">westBoundingCoordinate  =</span> <span class="fu">min</span>(longitude, <span class="at">na.rm =</span> T),</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">eastBoundingCoordinate  =</span> <span class="fu">max</span>(longitude, <span class="at">na.rm =</span> T),</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">northBoundingCoordinate =</span> <span class="fu">max</span>(latitude,  <span class="at">na.rm =</span> T),</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">southBoundingCoordinate =</span> <span class="fu">min</span>(latitude,  <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span> </span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Temporal coverage</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>temp_coverage <span class="ot">&lt;-</span> tbl_tow <span class="sc">|&gt;</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">beginDate =</span> <span class="fu">min</span>(time_start, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">endDate   =</span> <span class="fu">max</span>(time_start, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Taxonomic coverage</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>taxa_coverage <span class="ot">&lt;-</span> tbl_species <span class="sc">|&gt;</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(worms_id)) <span class="sc">|&gt;</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">scientificName =</span> scientific_name) <span class="sc">|&gt;</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span> </span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.list</span>()</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Create EML document</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>my_eml <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">packageId =</span> dataset_id,</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">system    =</span> <span class="st">"calcofi_db.{version}_{dataset}.{render-date}"</span>,</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="fu">list</span>(</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">title   =</span> dataset_title,</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">creator =</span> <span class="fu">list</span>(</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">individualName =</span> <span class="fu">list</span>(</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">givenName =</span> <span class="st">"Ed"</span>,</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">surName   =</span> <span class="st">"Weber"</span>),</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">organizationName      =</span> <span class="st">"NOAA SWFSC"</span>,</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">electronicMailAddress =</span> <span class="st">"ed.weber@noaa.gov"</span>,</span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">userId =</span> <span class="fu">list</span>(</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">directory =</span> <span class="st">"https://orcid.org/"</span>,</span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">userId =</span> <span class="st">"0000-0002-0942-434X"</span>) ),</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">abstract =</span> dataset_abstract,</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">keywordSet =</span> <span class="fu">list</span>(</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">keyword          =</span> dataset_keywords,</span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">keywordThesaurus =</span> <span class="st">"GCMD Science Keywords"</span>),</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">coverage =</span> <span class="fu">list</span>(</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">geographicCoverage =</span> <span class="fu">list</span>(</span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>        <span class="at">geographicDescription =</span> <span class="st">"California Current Large Marine Ecoregion"</span>,</span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">boundingCoordinates   =</span> geo_coverage),</span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">temporalCoverage =</span> <span class="fu">list</span>(</span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">rangeOfDates =</span> <span class="fu">list</span>(</span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>          <span class="at">beginDate =</span> <span class="fu">list</span>(<span class="at">calendarDate =</span> <span class="fu">as.character</span>(temp_coverage<span class="sc">$</span>beginDate)),</span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>          <span class="at">endDate   =</span> <span class="fu">list</span>(<span class="at">calendarDate =</span> <span class="fu">as.character</span>(temp_coverage<span class="sc">$</span>endDate)) )),</span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxonomicCoverage =</span> <span class="fu">list</span>(</span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">generalTaxonomicCoverage =</span> <span class="st">"Marine ichthyoplankton and fish eggs"</span>,</span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>        <span class="at">taxonomicClassification =</span> taxa_coverage )),</span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">contact =</span> <span class="fu">list</span>(</span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">individualName =</span> <span class="fu">list</span>(</span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a>        <span class="at">givenName =</span> <span class="st">"Ed"</span>,</span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a>        <span class="at">surName   =</span> <span class="st">"Weber"</span>),</span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a>      <span class="at">electronicMailAddress =</span> <span class="st">"ed.weber@noaa.gov"</span>),</span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">methods =</span> <span class="fu">list</span>(</span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">methodStep =</span> <span class="fu">list</span>(</span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">description =</span> <span class="fu">list</span>(</span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a>          <span class="at">para =</span> <span class="st">"[SAMPLING METHODS DESCRIPTION]"</span> )), <span class="co"># </span><span class="al">TODO</span><span class="co">: sampling methods</span></span>
<span id="cb34-63"><a href="#cb34-63" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampling =</span> <span class="fu">list</span>(</span>
<span id="cb34-64"><a href="#cb34-64" aria-hidden="true" tabindex="-1"></a>        <span class="at">studyExtent =</span> <span class="fu">list</span>(</span>
<span id="cb34-65"><a href="#cb34-65" aria-hidden="true" tabindex="-1"></a>          <span class="at">description =</span> <span class="fu">list</span>(</span>
<span id="cb34-66"><a href="#cb34-66" aria-hidden="true" tabindex="-1"></a>            <span class="at">para =</span> <span class="st">"[STUDY EXTENT DESCRIPTION]"</span>)),    <span class="co"># </span><span class="al">TODO</span><span class="co">: study extent</span></span>
<span id="cb34-67"><a href="#cb34-67" aria-hidden="true" tabindex="-1"></a>        <span class="at">samplingDescription =</span> <span class="fu">list</span>(</span>
<span id="cb34-68"><a href="#cb34-68" aria-hidden="true" tabindex="-1"></a>          <span class="at">para =</span> <span class="st">"[SAMPLING DESCRIPTION]"</span> ))),        <span class="co"># </span><span class="al">TODO</span><span class="co">: sampling</span></span>
<span id="cb34-69"><a href="#cb34-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">project =</span> <span class="fu">list</span>(</span>
<span id="cb34-70"><a href="#cb34-70" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> dataset_title,                          <span class="co"># </span><span class="al">TODO</span><span class="co">: project title?</span></span>
<span id="cb34-71"><a href="#cb34-71" aria-hidden="true" tabindex="-1"></a>      <span class="at">personnel =</span> <span class="fu">list</span>(</span>
<span id="cb34-72"><a href="#cb34-72" aria-hidden="true" tabindex="-1"></a>        <span class="at">individualName =</span> <span class="fu">list</span>(</span>
<span id="cb34-73"><a href="#cb34-73" aria-hidden="true" tabindex="-1"></a>          <span class="at">givenName =</span> <span class="st">"Ed"</span>,                           <span class="co"># </span><span class="al">TODO</span><span class="co">: PI?</span></span>
<span id="cb34-74"><a href="#cb34-74" aria-hidden="true" tabindex="-1"></a>          <span class="at">surName   =</span> <span class="st">"Weber"</span> ),</span>
<span id="cb34-75"><a href="#cb34-75" aria-hidden="true" tabindex="-1"></a>        <span class="at">role =</span> <span class="st">"Principal Investigator"</span>),</span>
<span id="cb34-76"><a href="#cb34-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">funding =</span> <span class="fu">list</span>(</span>
<span id="cb34-77"><a href="#cb34-77" aria-hidden="true" tabindex="-1"></a>        <span class="at">para =</span> <span class="st">"[FUNDING INFORMATION]"</span> ))))          <span class="co"># </span><span class="al">TODO</span><span class="co">: Funding</span></span>
<span id="cb34-78"><a href="#cb34-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-79"><a href="#cb34-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Write EML</span></span>
<span id="cb34-80"><a href="#cb34-80" aria-hidden="true" tabindex="-1"></a><span class="fu">write_eml</span>(my_eml, <span class="fu">file.path</span>(dir_out, <span class="st">"eml.xml"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="data-quality-checks" class="level2" data-number="14">
<h2 data-number="14" class="anchored" data-anchor-id="data-quality-checks"><span class="header-section-number">14</span> Data Quality Checks</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for missing WoRMS IDs</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>d_missing_worms <span class="ot">&lt;-</span> tbl_species <span class="sc">|&gt;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(worms_id)) <span class="sc">|&gt;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(species_id, scientific_name) <span class="sc">|&gt;</span> </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(d_missing_worms) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"WARNING: The following species are missing WoRMS IDs:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(d_missing_worms)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Please add WoRMS AphiaIDs for these species before finalizing the dataset.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for orphan records</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>d_orphan_occurrences <span class="ot">&lt;-</span> q_occurrence_extension <span class="sc">|&gt;</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anti_join</span>(q_event_core, <span class="at">by =</span> <span class="st">"eventID"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(d_orphan_occurrences) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">WARNING: Found"</span>, <span class="fu">nrow</span>(d_orphan_occurrences), <span class="st">"occurrence records without matching events.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>n_events   <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>n_events   <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"net_sample"</span>) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>n_cruises  <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"cruise"</span>)     <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>n_sites    <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"site"</span>)       <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>n_tows     <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"tow"</span>)        <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>n_nets     <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"net_sample"</span>) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>n_occs     <span class="ot">&lt;-</span> q_occurrence_extension <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>n_species  <span class="ot">&lt;-</span> q_occurrence_extension <span class="sc">|&gt;</span> <span class="fu">distinct</span>(scientificName) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>n_measures <span class="ot">&lt;-</span> d_extendedmeasurementorfact_extension <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a><span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a><span class="st">  === Dataset Summary ===</span></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a><span class="st">  Total events:        {prettyNum(n_events, big.mark = ',')}</span></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a><span class="st">  - Cruises:           {prettyNum(n_cruises, big.mark = ',')}</span></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a><span class="st">  - Sites:             {prettyNum(n_sites, big.mark = ',')}</span></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a><span class="st">  - Tows:              {prettyNum(n_tows, big.mark = ',')}</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a><span class="st">  - Net samples:       {prettyNum(n_nets, big.mark = ',')}</span></span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a><span class="st">  Total occurrences:   {prettyNum(n_occs, big.mark = ',')}</span></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a><span class="st">  Total species:       {prettyNum(n_species, big.mark = ',')}</span></span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a><span class="st">  Total measurements:  {prettyNum(n_measures, big.mark = ',')}"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>=== Dataset Summary ===
Total events:        76,512
- Cruises:           676
- Sites:             57,914
- Tows:              75,434
- Net samples:       76,512
Total occurrences:   463,655
Total species:       899
Total measurements:  610,816</code></pre>
</div>
</div>
</section>
<section id="package-creation" class="level2" data-number="15">
<h2 data-number="15" class="anchored" data-anchor-id="package-creation"><span class="header-section-number">15</span> Package Creation</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DwC-A zip file</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>zip_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="fu">paste0</span>(<span class="st">"../larvae_"</span>, <span class="fu">Sys.Date</span>(), <span class="st">".zip"</span>))</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">zip</span>(zip_file,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">files =</span> <span class="fu">file.path</span>(</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>      dir_out, <span class="fu">c</span>(</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"event.csv"</span>, <span class="st">"occurrence.csv"</span>,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"extendedMeasurementOrFact.csv"</span>, <span class="st">"meta.xml"</span>, <span class="st">"eml.xml"</span>)),</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">flags =</span> <span class="st">"-j"</span>) <span class="co"># exclude parent folders</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Darwin Core Archive created:"</span>, zip_file, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Darwin Core Archive created: /Users/bbest/Github/CalCOFI/workflows/data/darwincore/larvae/../larvae_2025-11-11.zip </code></pre>
</div>
</div>
</section>
<section id="check-csv" class="level2" data-number="16">
<h2 data-number="16" class="anchored" data-anchor-id="check-csv"><span class="header-section-number">16</span> Check CSV</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>d_event      <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(dir_out, <span class="st">"event.csv"</span>))</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>d_occurrence <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(dir_out, <span class="st">"occurrence.csv"</span>))</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>d_emof       <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(dir_out, <span class="st">"extendedMeasurementOrFact.csv"</span>))</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>d_event</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 210,536 × 17
   eventID             eventType eventDate samplingProtocol eventRemarks habitat
   &lt;chr&gt;               &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;            &lt;chr&gt;        &lt;chr&gt;  
 1 26a5e398-02eb-ef11… cruise    1998-06-… Marine plankton… Cruise on R… marine 
 2 29a3e398-02eb-ef11… cruise    1951-08-… Marine plankton… Cruise on C… marine 
 3 66a3e398-02eb-ef11… cruise    1953-06-… Marine plankton… Cruise on P… marine 
 4 60a4e398-02eb-ef11… cruise    1969-02-… Marine plankton… Cruise on A… marine 
 5 5ca3e398-02eb-ef11… cruise    1953-04-… Marine plankton… Cruise on H… marine 
 6 6aa3e398-02eb-ef11… cruise    1953-08-… Marine plankton… Cruise on C… marine 
 7 f1a3e398-02eb-ef11… cruise    1959-01-… Marine plankton… Cruise on S… marine 
 8 63a3e398-02eb-ef11… cruise    1953-06-… Marine plankton… Cruise on C… marine 
 9 05a4e398-02eb-ef11… cruise    1959-08-… Marine plankton… Cruise on B… marine 
10 61a4e398-02eb-ef11… cruise    1969-02-… Marine plankton… Cruise on D… marine 
# ℹ 210,526 more rows
# ℹ 11 more variables: parentEventID &lt;chr&gt;, sampleSizeValue &lt;dbl&gt;,
#   sampleSizeUnit &lt;chr&gt;, decimalLatitude &lt;dbl&gt;, decimalLongitude &lt;dbl&gt;,
#   locationID &lt;chr&gt;, geodeticDatum &lt;chr&gt;, coordinateUncertaintyInMeters &lt;dbl&gt;,
#   countryCode &lt;chr&gt;, waterBody &lt;chr&gt;, datasetID &lt;chr&gt;</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>d_occurrence</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 463,655 × 12
   occurrenceID eventID scientificName scientificNameID kingdom occurrenceStatus
   &lt;chr&gt;        &lt;chr&gt;   &lt;chr&gt;          &lt;chr&gt;            &lt;chr&gt;   &lt;chr&gt;           
 1 320f76e6-cf… eb8733… Teleostei      urn:lsid:marine… Animal… present         
 2 d34ab1a4-94… eb8733… Merluccius pr… urn:lsid:marine… Animal… present         
 3 5102c9a8-45… ec8733… Teleostei      urn:lsid:marine… Animal… present         
 4 c7cafab4-19… ef8733… Teleostei      urn:lsid:marine… Animal… present         
 5 f973a95d-02… f38733… Teleostei      urn:lsid:marine… Animal… present         
 6 cae6b4e2-4a… f48733… Teleostei      urn:lsid:marine… Animal… present         
 7 71244590-52… f58733… Teleostei      urn:lsid:marine… Animal… present         
 8 9f7b49f4-ea… f78733… Teleostei      urn:lsid:marine… Animal… present         
 9 c52c0e7f-7d… f98733… Teleostei      urn:lsid:marine… Animal… present         
10 4016e579-3c… fb8733… Teleostei      urn:lsid:marine… Animal… present         
# ℹ 463,645 more rows
# ℹ 6 more variables: organismQuantity &lt;dbl&gt;, organismQuantityType &lt;chr&gt;,
#   lifeStage &lt;chr&gt;, preparations &lt;chr&gt;, basisOfRecord &lt;chr&gt;, modified &lt;date&gt;</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>d_emof</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 610,816 × 11
   eventID          occurrenceID measurementID measurementType measurementTypeID
   &lt;chr&gt;            &lt;chr&gt;        &lt;chr&gt;         &lt;chr&gt;           &lt;lgl&gt;            
 1 b23147f2-02eb-e… &lt;NA&gt;         590c000f-12b… standardized h… NA               
 2 b23147f2-02eb-e… &lt;NA&gt;         48e93866-e73… proportion of … NA               
 3 b23147f2-02eb-e… &lt;NA&gt;         d2351970-896… small plankton… NA               
 4 b23147f2-02eb-e… &lt;NA&gt;         0e53d969-d81… total plankton… NA               
 5 35303af2-02eb-e… &lt;NA&gt;         5b9aa52e-7d2… standardized h… NA               
 6 35303af2-02eb-e… &lt;NA&gt;         e182fa63-73a… proportion of … NA               
 7 db8440f2-02eb-e… &lt;NA&gt;         7800ad75-53c… standardized h… NA               
 8 db8440f2-02eb-e… &lt;NA&gt;         e73cafa0-399… proportion of … NA               
 9 db8440f2-02eb-e… &lt;NA&gt;         ebbf3924-405… small plankton… NA               
10 db8440f2-02eb-e… &lt;NA&gt;         afb1184b-1de… total plankton… NA               
# ℹ 610,806 more rows
# ℹ 6 more variables: measurementValue &lt;dbl&gt;, measurementUnit &lt;chr&gt;,
#   measurementUnitID &lt;chr&gt;, measurementMethod &lt;chr&gt;, measurementRemarks &lt;chr&gt;,
#   measurementValueID &lt;lgl&gt;</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>d_emof <span class="sc">|&gt;</span> <span class="fu">select</span>(measurementType, measurementUnit) <span class="sc">|&gt;</span> <span class="fu">table</span>(<span class="at">useNA =</span> <span class="st">"ifany"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                             measurementUnit
measurementType               dimensionless  grams individuals millimeters
  abundance by life stage                 0      0      125347           0
  body length                             0      0           0      241871
  proportion of sample sorted         76512      0           0           0
  small plankton biomass                  0  45287           0           0
  standardized haul factor            76512      0           0           0
  total plankton biomass                  0  45287           0           0</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">#                              measurementUnit</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># measurementType               dimensionless  grams individuals millimeters</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   abundance by life stage                 0      0      125347           0</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   body length                             0      0           0      241871</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   proportion of sample sorted         76512      0           0           0</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   small plankton biomass                  0  45287           0           0</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   standardized haul factor            76512      0           0           0</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   total plankton biomass                  0  45287           0           0</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="history-of-loading-into-ipt" class="level2" data-number="17">
<h2 data-number="17" class="anchored" data-anchor-id="history-of-loading-into-ipt"><span class="header-section-number">17</span> History of loading into IPT</h2>
<section id="second-attempt-after-aligning-to-obis-extendedmeasurementorfact" class="level3" data-number="17.1">
<h3 data-number="17.1" class="anchored" data-anchor-id="second-attempt-after-aligning-to-obis-extendedmeasurementorfact"><span class="header-section-number">17.1</span> 2025-11-11: Second attempt after aligning to OBIS extendedMeasurementOrFact</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./figures/ipt-load-messages_2025-11-11.png" class="img-fluid figure-img"></p>
<figcaption>Messages from loading into IPT as “Sampling evet” on 2025-11-11</figcaption>
</figure>
</div>
</section>
<section id="first-attempt-to-load-into-gbif-ipt-as-sampling-evet-dataset" class="level3" data-number="17.2">
<h3 data-number="17.2" class="anchored" data-anchor-id="first-attempt-to-load-into-gbif-ipt-as-sampling-evet-dataset"><span class="header-section-number">17.2</span> 2025-11-10: First attempt to load into GBIF IPT as “Sampling evet” dataset</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./figures/ipt-load-messages_2025-11-10.png" class="img-fluid figure-img"></p>
<figcaption>Messages from loading into IPT as “Sampling evet” on 2025-11-10</figcaption>
</figure>
</div>
<blockquote class="blockquote">
<ul>
<li>Skipped mapped term http://rs.tdwg.org/dwc/terms/occurrencelD, which is unknown to extension http://rs.tdwg.org/dwc/terms/MeasurementOrFact</li>
<li>Skipped mapped term http://rs.tdwg.org/dwc/terms/eventID, which is unknown to extension http://rs.tdwg.org/dwc/terms/MeasurementOrFact</li>
</ul>
</blockquote>
<ul>
<li>🤔 But <code>EventID</code> (vs <code>eventID</code>?) clearly is supposed to link <code>measurementorfact</code> to <code>event</code> to <code>occurrence</code>, per <a href="https://ipt.gbif.org/manual/en/ipt/latest/best-practices-sampling-event-data#brackish-water-invertebrates-survey">Example: Brackish water invertebrates survey – Best Practices in Publishing Sampling-event data :: GBIF IPT User Manual</a>.</li>
<li>TODO: try renaming <code>eventID</code> to <code>EventID</code> in all 3 files and re-uploading to IPT.
<ul>
<li>Prompt: Help debug GBIF IPT response to loading a Sampling event DarwinCore dataset package from zip generated by <span class="citation" data-cites="publish_larvae_to_obis.qmd">@publish_larvae_to_obis.qmd</span>: “Skipped mapped term http://rs.tdwg.org/dwc/terms/eventID, which is unknown to extension http://rs.tdwg.org/dwc/terms/MeasurementOrFact”</li>
</ul></li>
</ul>
</section>
</section>
<section id="questions" class="level2" data-number="18">
<h2 data-number="18" class="anchored" data-anchor-id="questions"><span class="header-section-number">18</span> Questions</h2>
<ul>
<li><code>datasetID</code>: https://manual.obis.org/examples.html -&gt; datasetID: https://marineinfo.org/id/dataset/6403</li>
</ul>
</section>
<section id="required-information-prompts" class="level2" data-number="19">
<h2 data-number="19" class="anchored" data-anchor-id="required-information-prompts"><span class="header-section-number">19</span> Required Information Prompts</h2>
<p>Please provide the following information to complete the DarwinCore package:</p>
<section id="dataset-information" class="level3" data-number="19.1">
<h3 data-number="19.1" class="anchored" data-anchor-id="dataset-information"><span class="header-section-number">19.1</span> Dataset Information</h3>
<ul class="task-list">
<li><label><input type="checkbox">Dataset title</label></li>
<li><label><input type="checkbox">Dataset abstract (200-500 words describing the dataset)</label></li>
<li><label><input type="checkbox">Keywords (3-5 relevant keywords)</label></li>
<li><label><input type="checkbox">Country code (ISO 3166-1 alpha-2)</label></li>
<li><label><input type="checkbox">Water body name</label></li>
</ul>
</section>
<section id="personnel-information" class="level3" data-number="19.2">
<h3 data-number="19.2" class="anchored" data-anchor-id="personnel-information"><span class="header-section-number">19.2</span> Personnel Information</h3>
<ul class="task-list">
<li><label><input type="checkbox">Dataset creator name and ORCID</label></li>
<li><label><input type="checkbox">Creator organization</label></li>
<li><label><input type="checkbox">Creator email</label></li>
<li><label><input type="checkbox">Dataset contact name and email</label></li>
<li><label><input type="checkbox">Principal investigator name</label></li>
</ul>
</section>
<section id="project-information" class="level3" data-number="19.3">
<h3 data-number="19.3" class="anchored" data-anchor-id="project-information"><span class="header-section-number">19.3</span> Project Information</h3>
<ul class="task-list">
<li><label><input type="checkbox">Project title</label></li>
<li><label><input type="checkbox">Funding information (agency and grant numbers)</label></li>
</ul>
</section>
<section id="methodology" class="level3" data-number="19.4">
<h3 data-number="19.4" class="anchored" data-anchor-id="methodology"><span class="header-section-number">19.4</span> Methodology</h3>
<ul class="task-list">
<li><label><input type="checkbox">Detailed sampling methods description</label></li>
<li><label><input type="checkbox">Study extent description</label></li>
<li><label><input type="checkbox">Sampling design and protocols</label></li>
<li><label><input type="checkbox">Measurement methods for environmental variables</label></li>
<li><label><input type="checkbox">Size measurement methods for larvae</label></li>
<li><label><input type="checkbox">Taxonomist name(s) who identified specimens</label></li>
<li><label><input type="checkbox">Identification date(s)</label></li>
<li><label><input type="checkbox">Identification references used</label></li>
</ul>
</section>
<section id="geographic-information" class="level3" data-number="19.5">
<h3 data-number="19.5" class="anchored" data-anchor-id="geographic-information"><span class="header-section-number">19.5</span> Geographic Information</h3>
<ul class="task-list">
<li><label><input type="checkbox">Geographic description of the study area</label></li>
<li><label><input type="checkbox">GPS accuracy (coordinate uncertainty in meters)</label></li>
</ul>
<p>Once this information is provided, update the placeholders marked with [NEED …] in the code above.</p>
</section>
</section>
<section id="todo" class="level2" data-number="20">
<h2 data-number="20" class="anchored" data-anchor-id="todo"><span class="header-section-number">20</span> TODO</h2>
<ul class="task-list">
<li><p><label><input type="checkbox">drop <code>lifeStageID</code> (does not exist) and make <strong>eMoF</strong> like <a href="https://manual.obis.org/examples.html#:~:text=TripNR3242TripStationNR16781MidasTripActionID105598occurenceIDTA_105598_(Pseudo%2D)pediastrum_5-,Lifestage,-http%3A//vocab.nerc">“Lifestage” in 16 Dataset Examples: ENV-DATA | The OBIS Manual</a>:</label></p>
<ul>
<li><code>measurementType</code>: “Lifestage”</li>
<li><code>measurementTypeID</code>: “http://vocab.nerc.ac.uk/collection/P01/current/LSTAGE01/”</li>
<li><code>measurementValue</code>: “adult”</li>
<li><code>measurementValueID</code>: “http://vocab.nerc.ac.uk/collection/S11/current/S1116/”</li>
<li><code>measurementUnit</code>:<br>
</li>
<li><code>measurementUnitID</code>:</li>
<li><code>measurementDeterminedBy</code>: “Flanders Marine Institute”</li>
<li><code>measurementMethod</code>: “identified and counted by image analysis and normalised to a unit volume of water body, validated by human”</li>
</ul></li>
</ul>
<!-- -->

</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb48" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Publish Larvae to OBIS"</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="fu">## Goals</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Create a DarwinCore Archive (DwC-A) for CalCOFI ichthyoplankton (fish eggs and larvae) data to publish to OBIS.</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Use the existing CalCOFI database schema and connection.</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Ensure compliance with DarwinCore standards, including event hierarchy and extensions.</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="fu">### References</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>DarwinCore:</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">The OBIS Manual</span><span class="co">](https://manual.obis.org/)</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="co">[</span><span class="ot">7.2 ExtendedMeasurementOrFact Extension (eMoF) | The OBIS Manual</span><span class="co">](https://manual.obis.org/data_format.html#extendedmeasurementorfact-extension-emof)</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>  <span class="al">![](https://manual.obis.org/images/EventCoreSchema.png)</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="co">[</span><span class="ot">20.2 IPT: Integrated Publishing Toolkit | The OBIS Manual</span><span class="co">](https://manual.obis.org/ipt)</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Darwin Core Quick Reference Guide</span><span class="co">](https://dwc.tdwg.org/terms/)</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Guide for publishing biological survey and monitoring data to GBIF</span><span class="co">](https://docs.gbif.org/guide-publishing-survey-data/en/)</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Survey and Monitoring Data Quick-Start Guide: A how-to for updating a Darwin Core dataset using the Humboldt Extension</span><span class="co">](https://docs.gbif.org/survey-monitoring-quick-start/en/)</span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Best Practices in Publishing Sampling-event data - planned additions and notes for revision :: GBIF IPT User Manual</span><span class="co">](https://ipt.gbif.org/manual/en/ipt/latest/best-practices-sampling-event-planned-additions)</span></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>CalCOFI:</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">CalCOFI.org: Fish Eggs &amp; Larvae </span><span class="co">](https://calcofi.org/data/marine-ecosystem-data/fish-eggs-larvae/)</span></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="co">[</span><span class="ot">ERDDAP: CoastWatch - Search 'CalCOFI'</span><span class="co">](https://coastwatch.pfeg.noaa.gov/erddap/search/index.html?page=1&amp;itemsPerPage=1000&amp;searchFor=CalCOFI)</span></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span><span class="co">[</span><span class="ot">CalCOFI info</span><span class="co">](https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html)</span></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="co">[</span><span class="ot">EDI: CALCOFI fish larvae at 66 standard stations, 1966 - ongoing</span><span class="co">](https://portal.edirepository.org/nis/mapbrowse?scope=edi&amp;identifier=109&amp;revision=4)</span></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">:</span></span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a><span class="co"># commit</span></span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a><span class="co"># - [x] use lazy loading of tbl, so skip `|&gt; collect()`</span></span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a><span class="co"># - [x] %&gt;% to |&gt;</span></span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a><span class="co"># - [x] invert events hierarchy: net -&gt; tow (-&gt; tow_type) -&gt; site -&gt; cruise -&gt; ship</span></span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a><span class="co"># - [x] use UUID, ie drop prefix `urn:uuid:` for eventID, occurrenceID, measurementID</span></span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a><span class="co"># - [ ] Consider merging larva, larvastage, and larvasize into one occurrence table, since all sharing net_uuid, species_id</span></span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a>  CalCOFI<span class="sc">/</span>calcofi4db, </span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a>  DBI, dm, dplyr, DT, EML, glue, here, lubridate, purrr, readr, tibble, tidyr, uuid,</span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">quiet =</span> T)</span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">readr.show_col_types =</span> F)</span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset metadata - PROMPTS FOR REQUIRED INFORMATION</span></span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a>dataset_title    <span class="ot">&lt;-</span> <span class="st">"CalCOFI Fish Larvae Tows"</span> <span class="co"># Prompt: Enter dataset title</span></span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a>dataset_abstract <span class="ot">&lt;-</span> <span class="st">"Fish larvae counts and standardized counts for eggs captured in CalCOFI icthyoplankton nets (primarily vertical [Calvet or Pairovet], oblique [bongo or ring nets], and surface tows [Manta nets]) . Surface tows are normally standardized to count per 1,000 m3 strained. Oblique tows are normally standardized to count per 10 m2 of surface sampled."</span></span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a>dataset_keywords <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a>  <span class="st">"atmosphere"</span>, <span class="st">"biology"</span>, <span class="st">"biosphere"</span>, <span class="st">"calcofi"</span>, <span class="st">"earth science"</span>, <span class="st">"environment"</span>, <span class="st">"latitude"</span>, <span class="st">"longitude"</span>, <span class="st">"ocean"</span>, <span class="st">"time"</span>) <span class="co"># GCMD Science Keywords (source: https://catalog.data.gov/dataset/calcofi-larvae-counts-positive-tows)</span></span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true" tabindex="-1"></a><span class="co"># dataset_uuid &lt;- UUIDgenerate() # Or use existing dataset UUID</span></span>
<span id="cb48-59"><a href="#cb48-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-60"><a href="#cb48-60" aria-hidden="true" tabindex="-1"></a>dir_out <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/darwincore/larvae"</span>)</span>
<span id="cb48-61"><a href="#cb48-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-62"><a href="#cb48-62" aria-hidden="true" tabindex="-1"></a><span class="co"># get database connection</span></span>
<span id="cb48-63"><a href="#cb48-63" aria-hidden="true" tabindex="-1"></a>schema <span class="ot">&lt;-</span> <span class="st">"dev"</span></span>
<span id="cb48-64"><a href="#cb48-64" aria-hidden="true" tabindex="-1"></a>con    <span class="ot">&lt;-</span> <span class="fu">get_db_con</span>(schema)</span>
<span id="cb48-65"><a href="#cb48-65" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-66"><a href="#cb48-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-67"><a href="#cb48-67" aria-hidden="true" tabindex="-1"></a><span class="fu">## Show Database Tables</span></span>
<span id="cb48-68"><a href="#cb48-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-71"><a href="#cb48-71" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-72"><a href="#cb48-72" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-dm_tbls</span></span>
<span id="cb48-73"><a href="#cb48-73" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Entity relationship diagram (ERD) of the CalCOFI database. Created using the data models `dm` R package function [`dm_draw()`](https://krlmlr.github.io/dm/reference/dm_draw.html)."</span></span>
<span id="cb48-74"><a href="#cb48-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-75"><a href="#cb48-75" aria-hidden="true" tabindex="-1"></a><span class="co"># exclude experimental tables</span></span>
<span id="cb48-76"><a href="#cb48-76" aria-hidden="true" tabindex="-1"></a>tbls <span class="ot">&lt;-</span> <span class="fu">dbListTables</span>(con) <span class="sc">|&gt;</span> </span>
<span id="cb48-77"><a href="#cb48-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sort</span>() <span class="sc">|&gt;</span> </span>
<span id="cb48-78"><a href="#cb48-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setdiff</span>(</span>
<span id="cb48-79"><a href="#cb48-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"schema_version"</span>,</span>
<span id="cb48-80"><a href="#cb48-80" aria-hidden="true" tabindex="-1"></a>      <span class="st">"grid"</span>, <span class="st">"site_seg"</span>,</span>
<span id="cb48-81"><a href="#cb48-81" aria-hidden="true" tabindex="-1"></a>      <span class="st">"bottle"</span>, <span class="st">"cast"</span>))</span>
<span id="cb48-82"><a href="#cb48-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-83"><a href="#cb48-83" aria-hidden="true" tabindex="-1"></a><span class="co"># learn relations from database and draw</span></span>
<span id="cb48-84"><a href="#cb48-84" aria-hidden="true" tabindex="-1"></a>dm <span class="ot">&lt;-</span> <span class="fu">dm_from_con</span>(con, <span class="at">schema =</span> schema, <span class="at">table_names =</span> tbls, <span class="at">learn_keys  =</span> T)</span>
<span id="cb48-85"><a href="#cb48-85" aria-hidden="true" tabindex="-1"></a><span class="fu">dm_draw</span>(dm, <span class="at">view_type =</span> <span class="st">"all"</span>)</span>
<span id="cb48-86"><a href="#cb48-86" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-87"><a href="#cb48-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-90"><a href="#cb48-90" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb48-91"><a href="#cb48-91" aria-hidden="true" tabindex="-1"></a>%%| label: fig-calcofi_erd</span>
<span id="cb48-92"><a href="#cb48-92" aria-hidden="true" tabindex="-1"></a>%%| fig-cap: <span class="ot">"</span><span class="st">Entity relationship diagram (ERD) of the CalCOFI database. Created from image above and prompt to [Claude](https://claude.ai/): 'Generate an ERD mermaid diagram from the image.'</span><span class="ot">"</span></span>
<span id="cb48-93"><a href="#cb48-93" aria-hidden="true" tabindex="-1"></a>%%| file: diagrams/calcofi_erd.mmd</span>
<span id="cb48-94"><a href="#cb48-94" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-95"><a href="#cb48-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-96"><a href="#cb48-96" aria-hidden="true" tabindex="-1"></a><span class="fu">## Evaluate Merging Egg and Larva Stage Tables</span></span>
<span id="cb48-97"><a href="#cb48-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-98"><a href="#cb48-98" aria-hidden="true" tabindex="-1"></a><span class="fu">### Egg Stages</span></span>
<span id="cb48-99"><a href="#cb48-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-102"><a href="#cb48-102" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-103"><a href="#cb48-103" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: egg_stage.stage</span></span>
<span id="cb48-104"><a href="#cb48-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-105"><a href="#cb48-105" aria-hidden="true" tabindex="-1"></a><span class="fu">tbl</span>(con, <span class="st">"egg_stage"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb48-106"><a href="#cb48-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(stage) <span class="sc">|&gt;</span> </span>
<span id="cb48-107"><a href="#cb48-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb48-108"><a href="#cb48-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span> </span>
<span id="cb48-109"><a href="#cb48-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(stage)</span>
<span id="cb48-110"><a href="#cb48-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-111"><a href="#cb48-111" aria-hidden="true" tabindex="-1"></a><span class="co">#    stage       n</span></span>
<span id="cb48-112"><a href="#cb48-112" aria-hidden="true" tabindex="-1"></a><span class="co">#    &lt;int&gt; &lt;int64&gt;</span></span>
<span id="cb48-113"><a href="#cb48-113" aria-hidden="true" tabindex="-1"></a><span class="co">#  1     1     346</span></span>
<span id="cb48-114"><a href="#cb48-114" aria-hidden="true" tabindex="-1"></a><span class="co">#  2     2    1684</span></span>
<span id="cb48-115"><a href="#cb48-115" aria-hidden="true" tabindex="-1"></a><span class="co">#  3     3    1703</span></span>
<span id="cb48-116"><a href="#cb48-116" aria-hidden="true" tabindex="-1"></a><span class="co">#  4     4    1279</span></span>
<span id="cb48-117"><a href="#cb48-117" aria-hidden="true" tabindex="-1"></a><span class="co">#  5     5    1685</span></span>
<span id="cb48-118"><a href="#cb48-118" aria-hidden="true" tabindex="-1"></a><span class="co">#  6     6    2693</span></span>
<span id="cb48-119"><a href="#cb48-119" aria-hidden="true" tabindex="-1"></a><span class="co">#  7     7    1995</span></span>
<span id="cb48-120"><a href="#cb48-120" aria-hidden="true" tabindex="-1"></a><span class="co">#  8     8    1644</span></span>
<span id="cb48-121"><a href="#cb48-121" aria-hidden="true" tabindex="-1"></a><span class="co">#  9     9    2247</span></span>
<span id="cb48-122"><a href="#cb48-122" aria-hidden="true" tabindex="-1"></a><span class="co"># 10    10    2156</span></span>
<span id="cb48-123"><a href="#cb48-123" aria-hidden="true" tabindex="-1"></a><span class="co"># 11    11    1746</span></span>
<span id="cb48-124"><a href="#cb48-124" aria-hidden="true" tabindex="-1"></a><span class="co"># 12    12     727</span></span>
<span id="cb48-125"><a href="#cb48-125" aria-hidden="true" tabindex="-1"></a><span class="co"># 13    13      41</span></span>
<span id="cb48-126"><a href="#cb48-126" aria-hidden="true" tabindex="-1"></a><span class="co"># 14    14       6</span></span>
<span id="cb48-127"><a href="#cb48-127" aria-hidden="true" tabindex="-1"></a><span class="co"># 15    15      16</span></span>
<span id="cb48-128"><a href="#cb48-128" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: ask Ed Weber what stages 12 through 15 mean?</span></span>
<span id="cb48-129"><a href="#cb48-129" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-130"><a href="#cb48-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-131"><a href="#cb48-131" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">ERDDAP - Information about CalCOFI NOAA Fish Egg Stages, from NOAA SWFSC</span><span class="co">](https://coastwatch.pfeg.noaa.gov/erddap/info/erdCalCOFIeggstg/index.html#:~:text=NC_GLOBAL-,summary,-String)</span>:</span>
<span id="cb48-132"><a href="#cb48-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-133"><a href="#cb48-133" aria-hidden="true" tabindex="-1"></a>  <span class="at">&gt; Egg morphological developmental stage for eggs of selected species captured in CalCOFI icthyoplankton nets. Sequential developmental stages are described by Moser and Ahlstrom (1985; see the info url references section). -- </span></span>
<span id="cb48-134"><a href="#cb48-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-135"><a href="#cb48-135" aria-hidden="true" tabindex="-1"></a>https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html:</span>
<span id="cb48-136"><a href="#cb48-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-137"><a href="#cb48-137" aria-hidden="true" tabindex="-1"></a>  <span class="at">&gt; - Moser, H. G. and E. H. Ahlstrom. 1985. Staging anchovy eggs. An egg production method for estimating spawning biomass of pelagic fish: implication to the northern anchovy (Engraulis mordax). P. 37-41 in R. Lasker, ed. U.S. Dep. Commer. Tech. Rep. NMFS 36.  (</span><span class="co">[</span><span class="ot">PDF</span><span class="co">](https://repository.library.noaa.gov/view/noaa/5695/noaa_5695_DS1.pdf)</span><span class="at">)</span></span>
<span id="cb48-138"><a href="#cb48-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-139"><a href="#cb48-139" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage I</span></span>
<span id="cb48-140"><a href="#cb48-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-141"><a href="#cb48-141" aria-hidden="true" tabindex="-1"></a>Cell division has not yet begun. In intact eggs the cytoplasm of the</span>
<span id="cb48-142"><a href="#cb48-142" aria-hidden="true" tabindex="-1"></a>single cell appears as a clear hemisphere at one pole, easily dif-</span>
<span id="cb48-143"><a href="#cb48-143" aria-hidden="true" tabindex="-1"></a>ferentiated from the yolk mass which is divided into granules. The</span>
<span id="cb48-144"><a href="#cb48-144" aria-hidden="true" tabindex="-1"></a>cytoplasm may be displaced to other locations around the periphery</span>
<span id="cb48-145"><a href="#cb48-145" aria-hidden="true" tabindex="-1"></a>of the yolk mass, but there is usually some accumulation at one pole,</span>
<span id="cb48-146"><a href="#cb48-146" aria-hidden="true" tabindex="-1"></a>which allows the stage to be identified.</span>
<span id="cb48-147"><a href="#cb48-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-148"><a href="#cb48-148" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage II</span></span>
<span id="cb48-149"><a href="#cb48-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-150"><a href="#cb48-150" aria-hidden="true" tabindex="-1"></a>This begins with the division of the single cell into two cells or</span>
<span id="cb48-151"><a href="#cb48-151" aria-hidden="true" tabindex="-1"></a>blastomeres. The division is first noticeable when a furrow develops</span>
<span id="cb48-152"><a href="#cb48-152" aria-hidden="true" tabindex="-1"></a>in the middle of the cytoplasmic cap. Small bubble-like structures</span>
<span id="cb48-153"><a href="#cb48-153" aria-hidden="true" tabindex="-1"></a>(probably artifacts) are often visible along the furrow and help iden-</span>
<span id="cb48-154"><a href="#cb48-154" aria-hidden="true" tabindex="-1"></a>tify it. The next cleavage plane is at right angles to the first, and</span>
<span id="cb48-155"><a href="#cb48-155" aria-hidden="true" tabindex="-1"></a>subsequent synchronous divisions in both meridional and latitudinal</span>
<span id="cb48-156"><a href="#cb48-156" aria-hidden="true" tabindex="-1"></a>planes produce a hemispherical mound of cells, termed the blasto-</span>
<span id="cb48-157"><a href="#cb48-157" aria-hidden="true" tabindex="-1"></a>disc. After the 5th or 6th division, the blastodisc has a berry-like</span>
<span id="cb48-158"><a href="#cb48-158" aria-hidden="true" tabindex="-1"></a>appearance, the so-called "mulberry stage," and with subsequent</span>
<span id="cb48-159"><a href="#cb48-159" aria-hidden="true" tabindex="-1"></a>divisions the blastomeres become increasingly smaller and more</span>
<span id="cb48-160"><a href="#cb48-160" aria-hidden="true" tabindex="-1"></a>difficult to distinguish individually. During a certain phase of the</span>
<span id="cb48-161"><a href="#cb48-161" aria-hidden="true" tabindex="-1"></a>early divisions the blastomeres are about the same size as the yolk</span>
<span id="cb48-162"><a href="#cb48-162" aria-hidden="true" tabindex="-1"></a>granules. Ifthe blastodisc and yolk mass become disrupted during</span>
<span id="cb48-163"><a href="#cb48-163" aria-hidden="true" tabindex="-1"></a>collection or preservation, the blastomeres may become distributed</span>
<span id="cb48-164"><a href="#cb48-164" aria-hidden="true" tabindex="-1"></a>among the yolk granules. They may be distinguished from one</span>
<span id="cb48-165"><a href="#cb48-165" aria-hidden="true" tabindex="-1"></a>another since they have different refractive indices and the</span>
<span id="cb48-166"><a href="#cb48-166" aria-hidden="true" tabindex="-1"></a>blastomeres appear darker when viewed with transmitted light.</span>
<span id="cb48-167"><a href="#cb48-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-168"><a href="#cb48-168" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage III</span></span>
<span id="cb48-169"><a href="#cb48-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-170"><a href="#cb48-170" aria-hidden="true" tabindex="-1"></a>Ahlstrom (1943) defined this stage in sardine eggs as beginning with</span>
<span id="cb48-171"><a href="#cb48-171" aria-hidden="true" tabindex="-1"></a>the appearance of the segmentation cavity. The segmentation cavity</span>
<span id="cb48-172"><a href="#cb48-172" aria-hidden="true" tabindex="-1"></a>of teleost eggs is the space formed between the blastodisc and the</span>
<span id="cb48-173"><a href="#cb48-173" aria-hidden="true" tabindex="-1"></a>yolk mass during late cleavage. In most anchovy eggs in our collec-</span>
<span id="cb48-174"><a href="#cb48-174" aria-hidden="true" tabindex="-1"></a>tions the blastodisc is shrunken and somewhat cup-shaped and con-</span>
<span id="cb48-175"><a href="#cb48-175" aria-hidden="true" tabindex="-1"></a>sequently the segmentation cavity, which is a delicate structure, is</span>
<span id="cb48-176"><a href="#cb48-176" aria-hidden="true" tabindex="-1"></a>obliterated. We have found it preferable to define the beginning of</span>
<span id="cb48-177"><a href="#cb48-177" aria-hidden="true" tabindex="-1"></a>Stage ill on the basis of the appearance of the blastoderm, i.e., when</span>
<span id="cb48-178"><a href="#cb48-178" aria-hidden="true" tabindex="-1"></a>it has the appearance of tissue rather than of a collection of individual</span>
<span id="cb48-179"><a href="#cb48-179" aria-hidden="true" tabindex="-1"></a>cells. This stage marks the beginning of gastrulation. The margin</span>
<span id="cb48-180"><a href="#cb48-180" aria-hidden="true" tabindex="-1"></a>of the blastodisc becomes slightly thickened and is termed the germ</span>
<span id="cb48-181"><a href="#cb48-181" aria-hidden="true" tabindex="-1"></a>ring. At one region of the germ ring the thickening extends inward</span>
<span id="cb48-182"><a href="#cb48-182" aria-hidden="true" tabindex="-1"></a>to form the embryonic shield, which defines the future axis of the</span>
<span id="cb48-183"><a href="#cb48-183" aria-hidden="true" tabindex="-1"></a>embryo. Gastrulation proceeds by further proliferation and downward</span>
<span id="cb48-184"><a href="#cb48-184" aria-hidden="true" tabindex="-1"></a>movement of cells in the region of the germ ring by a process known</span>
<span id="cb48-185"><a href="#cb48-185" aria-hidden="true" tabindex="-1"></a>as epiboly. Simultaneously, proliferation and inward migration (em-</span>
<span id="cb48-186"><a href="#cb48-186" aria-hidden="true" tabindex="-1"></a>boly) of cells from the margin of the embryonic shield produce the</span>
<span id="cb48-187"><a href="#cb48-187" aria-hidden="true" tabindex="-1"></a>organ-forming cell layers of the primordial embryo. At the end of</span>
<span id="cb48-188"><a href="#cb48-188" aria-hidden="true" tabindex="-1"></a>Stage III the germ ring is one-third down the yolk mass and the</span>
<span id="cb48-189"><a href="#cb48-189" aria-hidden="true" tabindex="-1"></a>bilateral nature of the primordial embryo is apparent.</span>
<span id="cb48-190"><a href="#cb48-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-191"><a href="#cb48-191" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage IV</span></span>
<span id="cb48-192"><a href="#cb48-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-193"><a href="#cb48-193" aria-hidden="true" tabindex="-1"></a>At the beginning of this stage the germ ring has enclosed one-third</span>
<span id="cb48-194"><a href="#cb48-194" aria-hidden="true" tabindex="-1"></a>of the yolk mass and the embryo is beginning to form along the</span>
<span id="cb48-195"><a href="#cb48-195" aria-hidden="true" tabindex="-1"></a>median region of the embryonic shield. At the end of this stage,</span>
<span id="cb48-196"><a href="#cb48-196" aria-hidden="true" tabindex="-1"></a>defined by the germ ring enveloping two-thirds of the yolk, the head</span>
<span id="cb48-197"><a href="#cb48-197" aria-hidden="true" tabindex="-1"></a>region of the embryo is becoming apparent.</span>
<span id="cb48-198"><a href="#cb48-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-199"><a href="#cb48-199" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage V</span></span>
<span id="cb48-200"><a href="#cb48-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-201"><a href="#cb48-201" aria-hidden="true" tabindex="-1"></a>This stage begins with the germ ring two-thirds down the yolk and</span>
<span id="cb48-202"><a href="#cb48-202" aria-hidden="true" tabindex="-1"></a>ends with the closure of the blastopore and the complete enclosure</span>
<span id="cb48-203"><a href="#cb48-203" aria-hidden="true" tabindex="-1"></a>of the yolk by the cellular sheath of the embryo. The stage is charac-</span>
<span id="cb48-204"><a href="#cb48-204" aria-hidden="true" tabindex="-1"></a>terized by rapid differentiation resulting in the formation of several</span>
<span id="cb48-205"><a href="#cb48-205" aria-hidden="true" tabindex="-1"></a>somites in the midregion of the embryonic axis, development of the</span>
<span id="cb48-206"><a href="#cb48-206" aria-hidden="true" tabindex="-1"></a>notochord which can be seen from a dorsal viewpoint, and differ-</span>
<span id="cb48-207"><a href="#cb48-207" aria-hidden="true" tabindex="-1"></a>entiation of the optic vesicles from the brain.</span>
<span id="cb48-208"><a href="#cb48-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-209"><a href="#cb48-209" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage VI</span></span>
<span id="cb48-210"><a href="#cb48-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-211"><a href="#cb48-211" aria-hidden="true" tabindex="-1"></a>This stage begins with the closure of the blastopore and ends when</span>
<span id="cb48-212"><a href="#cb48-212" aria-hidden="true" tabindex="-1"></a>the tail starts to separate from the yolk mass. The embryonic sheath</span>
<span id="cb48-213"><a href="#cb48-213" aria-hidden="true" tabindex="-1"></a>of cells is extremely thin and, in some samples, it may be difficult</span>
<span id="cb48-214"><a href="#cb48-214" aria-hidden="true" tabindex="-1"></a>to determine the point of blastopore closure. In these cases the event</span>
<span id="cb48-215"><a href="#cb48-215" aria-hidden="true" tabindex="-1"></a>can be estimated from the position of the caudal terminus of the</span>
<span id="cb48-216"><a href="#cb48-216" aria-hidden="true" tabindex="-1"></a>embryonic axis, since it grows toward the pole with the edge of the</span>
<span id="cb48-217"><a href="#cb48-217" aria-hidden="true" tabindex="-1"></a>cellular sheath. Initially the caudal region lies flat against the polar</span>
<span id="cb48-218"><a href="#cb48-218" aria-hidden="true" tabindex="-1"></a>region of the yolk, then gradually thickens and becomes more round-</span>
<span id="cb48-219"><a href="#cb48-219" aria-hidden="true" tabindex="-1"></a>ed at the tip until it is clearly separate from the yolk. During this</span>
<span id="cb48-220"><a href="#cb48-220" aria-hidden="true" tabindex="-1"></a>stage the somites are apparent along the entire body axis (except</span>
<span id="cb48-221"><a href="#cb48-221" aria-hidden="true" tabindex="-1"></a>at the caudal portion), the lens primordium appears in the eye, and</span>
<span id="cb48-222"><a href="#cb48-222" aria-hidden="true" tabindex="-1"></a>the regions of the brain begin to differentiate.</span>
<span id="cb48-223"><a href="#cb48-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-224"><a href="#cb48-224" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage VII</span></span>
<span id="cb48-225"><a href="#cb48-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-226"><a href="#cb48-226" aria-hidden="true" tabindex="-1"></a>At the beginning of this stage the tip of the tail free from the yolk</span>
<span id="cb48-227"><a href="#cb48-227" aria-hidden="true" tabindex="-1"></a>is broadly rounded, then begins to narrow as it elongates. The noto-</span>
<span id="cb48-228"><a href="#cb48-228" aria-hidden="true" tabindex="-1"></a>chord extends almost to the tip and the finfold is just becoming visi-</span>
<span id="cb48-229"><a href="#cb48-229" aria-hidden="true" tabindex="-1"></a>ble. At the end of this stage the length of the free tail is one-half</span>
<span id="cb48-230"><a href="#cb48-230" aria-hidden="true" tabindex="-1"></a>the length of the head. For this purpose, head length is considered</span>
<span id="cb48-231"><a href="#cb48-231" aria-hidden="true" tabindex="-1"></a>the distance from the tip of the snout to the back of the cerebellum</span>
<span id="cb48-232"><a href="#cb48-232" aria-hidden="true" tabindex="-1"></a>(see Fig. 2H). Relative tail length is the criterion for each remain-</span>
<span id="cb48-233"><a href="#cb48-233" aria-hidden="true" tabindex="-1"></a>ing stage.</span>
<span id="cb48-234"><a href="#cb48-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-235"><a href="#cb48-235" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage VIII</span></span>
<span id="cb48-236"><a href="#cb48-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-237"><a href="#cb48-237" aria-hidden="true" tabindex="-1"></a>This stage begins when the free tail length is l:,reater than one-half</span>
<span id="cb48-238"><a href="#cb48-238" aria-hidden="true" tabindex="-1"></a>the head length and ends when tail length equals head length. The</span>
<span id="cb48-239"><a href="#cb48-239" aria-hidden="true" tabindex="-1"></a>tail becomes pointed during this stage and begins to bend away from</span>
<span id="cb48-240"><a href="#cb48-240" aria-hidden="true" tabindex="-1"></a>the axis of the body, to the right or left side. The curvature of the</span>
<span id="cb48-241"><a href="#cb48-241" aria-hidden="true" tabindex="-1"></a>tail generally increases with development, but is subject to individual</span>
<span id="cb48-242"><a href="#cb48-242" aria-hidden="true" tabindex="-1"></a>variability (Fig. 2). Judgement is required in compensating for curva-</span>
<span id="cb48-243"><a href="#cb48-243" aria-hidden="true" tabindex="-1"></a>ture in estimating relative tail length; however, accuracy and preci-</span>
<span id="cb48-244"><a href="#cb48-244" aria-hidden="true" tabindex="-1"></a>sion increase rapidly with practice.</span>
<span id="cb48-245"><a href="#cb48-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-246"><a href="#cb48-246" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage IX</span></span>
<span id="cb48-247"><a href="#cb48-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-248"><a href="#cb48-248" aria-hidden="true" tabindex="-1"></a>This stage begins with the tail extending one-quarter the length of</span>
<span id="cb48-249"><a href="#cb48-249" aria-hidden="true" tabindex="-1"></a>the yolk sac and ends when it reaches one-half the yolk sac length.</span>
<span id="cb48-250"><a href="#cb48-250" aria-hidden="true" tabindex="-1"></a>The gut is now apparent along the ventral surface of the tail, and</span>
<span id="cb48-251"><a href="#cb48-251" aria-hidden="true" tabindex="-1"></a>its terminal section passes through the fin fold which is now con-</span>
<span id="cb48-252"><a href="#cb48-252" aria-hidden="true" tabindex="-1"></a>siderably wider than in the previous stage. The pectoral fin buds</span>
<span id="cb48-253"><a href="#cb48-253" aria-hidden="true" tabindex="-1"></a>appear as lateral thickenings as do the otic vesicles.</span>
<span id="cb48-254"><a href="#cb48-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-255"><a href="#cb48-255" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage X</span></span>
<span id="cb48-256"><a href="#cb48-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-257"><a href="#cb48-257" aria-hidden="true" tabindex="-1"></a>This stage starts when the tail is one-half the length of the yolk sac</span>
<span id="cb48-258"><a href="#cb48-258" aria-hidden="true" tabindex="-1"></a>and ends when it reaches three-quarters of the yolk sac length.</span>
<span id="cb48-259"><a href="#cb48-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-260"><a href="#cb48-260" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Stage XI</span></span>
<span id="cb48-261"><a href="#cb48-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-262"><a href="#cb48-262" aria-hidden="true" tabindex="-1"></a>This is the final stage before hatching and is defined by a tail length</span>
<span id="cb48-263"><a href="#cb48-263" aria-hidden="true" tabindex="-1"></a>greater than three-quarters of the length of the yolk sac.</span>
<span id="cb48-264"><a href="#cb48-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-265"><a href="#cb48-265" aria-hidden="true" tabindex="-1"></a><span class="fu">### Larva Stages</span></span>
<span id="cb48-266"><a href="#cb48-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-269"><a href="#cb48-269" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-270"><a href="#cb48-270" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: larva_stage.stage</span></span>
<span id="cb48-271"><a href="#cb48-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-272"><a href="#cb48-272" aria-hidden="true" tabindex="-1"></a><span class="fu">tbl</span>(con, <span class="st">"larva_stage"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb48-273"><a href="#cb48-273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(stage) <span class="sc">|&gt;</span> </span>
<span id="cb48-274"><a href="#cb48-274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb48-275"><a href="#cb48-275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb48-276"><a href="#cb48-276" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 FLEX    18882</span></span>
<span id="cb48-277"><a href="#cb48-277" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 POST    22446</span></span>
<span id="cb48-278"><a href="#cb48-278" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 PREF    56913</span></span>
<span id="cb48-279"><a href="#cb48-279" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 YOLK     5384</span></span>
<span id="cb48-280"><a href="#cb48-280" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 TRNS     1754</span></span>
<span id="cb48-281"><a href="#cb48-281" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-282"><a href="#cb48-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-283"><a href="#cb48-283" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">ERDDAP - Information about CalCOFI NOAA Fish Larvae Stages, from NOAA SWFSC</span><span class="co">](https://coastwatch.pfeg.noaa.gov/erddap/info/erdCalCOFIlrvstg/index.html#:~:text=NC_GLOBAL-,summary,-String)</span>:</span>
<span id="cb48-284"><a href="#cb48-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-285"><a href="#cb48-285" aria-hidden="true" tabindex="-1"></a><span class="at">  &gt; Developmental stages (yolk sac, preflexion, flexion, postflexion, or transformation) of selected fish larvae captured in CalCOFI icthyoplankton nets.</span></span>
<span id="cb48-286"><a href="#cb48-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-287"><a href="#cb48-287" aria-hidden="true" tabindex="-1"></a><span class="fu">### dwc:lifeStage</span></span>
<span id="cb48-288"><a href="#cb48-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-289"><a href="#cb48-289" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">dwc:lifeStage (n_concepts: 39) Darwin Core List of Terms - Darwin Core</span><span class="co">](https://dwc.tdwg.org/list/#dwc_lifeStage)</span></span>
<span id="cb48-290"><a href="#cb48-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-291"><a href="#cb48-291" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">LifeStage | GBIF Registry Vocabulary</span><span class="co">](https://registry.gbif.org/vocabulary/LifeStage)</span> (n_concepts: 39)</span>
<span id="cb48-292"><a href="#cb48-292" aria-hidden="true" tabindex="-1"></a><span class="at">  &gt; A vocabulary to capture the broad stages that an organism passes through during its life cycle. This vocabulary was assembled based on the observed terms commonly used by the open data community, including those from citizen scientists.</span></span>
<span id="cb48-293"><a href="#cb48-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-294"><a href="#cb48-294" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="co">[</span><span class="ot">**Egg**</span><span class="co">](https://registry.gbif.org/vocabulary/LifeStage/concept/Egg)</span> (n_children: 0)</span>
<span id="cb48-295"><a href="#cb48-295" aria-hidden="true" tabindex="-1"></a><span class="at">    &gt; The egg is the organic vessel containing the zygote in which an embryo develops until it can survive on its own, at which point the animal hatches</span></span>
<span id="cb48-296"><a href="#cb48-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-297"><a href="#cb48-297" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="co">[</span><span class="ot">**Larva**</span><span class="co">](https://registry.gbif.org/vocabulary/LifeStage/concept/Larva)</span> (n_children: 11)</span>
<span id="cb48-298"><a href="#cb48-298" aria-hidden="true" tabindex="-1"></a><span class="at">    &gt; A larva is a distinct juvenile form many animals undergo before metamorphosis into adults. Larvae often have different body structures from the adult form, and may also have different habitats and feeding behaviors.</span></span>
<span id="cb48-299"><a href="#cb48-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-300"><a href="#cb48-300" aria-hidden="true" tabindex="-1"></a><span class="fu">### other dataset: ICES Eggs and larvae | OBIS</span></span>
<span id="cb48-301"><a href="#cb48-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-302"><a href="#cb48-302" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">ICES Eggs and larvae | OBIS</span><span class="co">](https://obis.org/dataset/66fe7e4b-ddcc-44aa-8378-c7c7482c2844)</span></span>
<span id="cb48-303"><a href="#cb48-303" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Eggs and larvae | ICES</span><span class="co">](https://www.ices.dk/data/data-portals/Pages/Eggs-and-larvae.aspx)</span></span>
<span id="cb48-304"><a href="#cb48-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-305"><a href="#cb48-305" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Vocabularies/ LifeStage / concepts | GBIF Registry</span><span class="co">](https://registry.gbif.org/vocabulary/LifeStage/concepts)</span></span>
<span id="cb48-306"><a href="#cb48-306" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">BODC parameter semantic model biological entity development stage terms | NERC Vocabulary Server</span><span class="co">](https://vocab.nerc.ac.uk/collection/S11/current/)</span></span>
<span id="cb48-307"><a href="#cb48-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-308"><a href="#cb48-308" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Frequently Asked Questions About Ichthyoplankton | NOAA Fisheries</span><span class="co">](https://www.fisheries.noaa.gov/west-coast/science-data/frequently-asked-questions-about-ichthyoplankton)</span></span>
<span id="cb48-309"><a href="#cb48-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-310"><a href="#cb48-310" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Zooplankton taxonomy-related abundance per unit volume of the water column | NVS</span><span class="co">](https://vocab.nerc.ac.uk/collection/P02/current/ZATX/)</span></span>
<span id="cb48-311"><a href="#cb48-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-312"><a href="#cb48-312" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">14 Controlled vocabulary for eMoF | The OBIS Manual</span><span class="co">](https://manual.obis.org/vocabulary.html)</span></span>
<span id="cb48-313"><a href="#cb48-313" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="co">[</span><span class="ot">MoF viewer</span><span class="co">](https://mof.obis.org/)</span></span>
<span id="cb48-314"><a href="#cb48-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-315"><a href="#cb48-315" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">P01 concept: Abundance of Fish (WoRMS 11676) [Stage: egg] per unit volume of the water body by optical microscopy | NVS</span><span class="co">](https://vocab.nerc.ac.uk/collection/P01/current/Z830M00T/)</span></span>
<span id="cb48-316"><a href="#cb48-316" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="co">[</span><span class="ot">Pisces (11676; unaccepted Superclass) | WoRMS</span><span class="co">](https://www.marinespecies.org/aphia.php?p=taxdetails&amp;id=11676)</span></span>
<span id="cb48-317"><a href="#cb48-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-318"><a href="#cb48-318" aria-hidden="true" tabindex="-1"></a><span class="al">![VThe P01 wheel, demonstrating how P01 elements are represented by other NVS collections | Vocabulary - OBIS Manual](https://manual.obis.org/images/P01_wheel.png)</span></span>
<span id="cb48-319"><a href="#cb48-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-320"><a href="#cb48-320" aria-hidden="true" tabindex="-1"></a><span class="fu">### Lifestage   S11 - BODC Parameter Semantic Model Life Cycle Stages</span></span>
<span id="cb48-321"><a href="#cb48-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-322"><a href="#cb48-322" aria-hidden="true" tabindex="-1"></a>https://github.com/nvs-vocabs/S11</span>
<span id="cb48-323"><a href="#cb48-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-324"><a href="#cb48-324" aria-hidden="true" tabindex="-1"></a>A controlled vocabulary for terms used in the BODC parameter semantic model to specify the development stage (life cycle stage) of a biological entity</span>
<span id="cb48-325"><a href="#cb48-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-326"><a href="#cb48-326" aria-hidden="true" tabindex="-1"></a>Terms and mappings available from: http://vocab.nerc.ac.uk/collection/S11/current/</span>
<span id="cb48-327"><a href="#cb48-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-328"><a href="#cb48-328" aria-hidden="true" tabindex="-1"></a>Search interface: https://www.bodc.ac.uk/resources/vocabularies/vocabulary_search/S11/</span>
<span id="cb48-329"><a href="#cb48-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-330"><a href="#cb48-330" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Request for new terms and ways to contribute</span></span>
<span id="cb48-331"><a href="#cb48-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-332"><a href="#cb48-332" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Request for new S11 terms can be made using this <span class="co">[</span><span class="ot">form</span><span class="co">](https://docs.google.com/forms/d/e/1FAIpQLSe-ZTKJZmNT5FmyPRFsPsNt2hpB_gb6MAmm7Zp-7GSMpn5NFA/viewform?usp=pp_url&amp;entry.1396013310=S11)</span></span>
<span id="cb48-333"><a href="#cb48-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-334"><a href="#cb48-334" aria-hidden="true" tabindex="-1"></a>Reporting errors or suggestions for improving content can be submitted as <span class="co">[</span><span class="ot">regular issues</span><span class="co">](https://github.com/nvs-vocabs/S11/issues/new)</span> in this repository or emailed to vocab.services-at-bodc.ac.uk.</span>
<span id="cb48-335"><a href="#cb48-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-336"><a href="#cb48-336" aria-hidden="true" tabindex="-1"></a><span class="fu">## Prompt Claude to merge egg and larva tables</span></span>
<span id="cb48-337"><a href="#cb48-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-338"><a href="#cb48-338" aria-hidden="true" tabindex="-1"></a>PROMPT (plan mode): Help me figure out a strategy for sensibly merging egg, egg_stage, larva, larva_stage into a DarwinCore archive that accounts for total count (ie <span class="in">`tally`</span>), stage (combining egg and larva <span class="in">`stage`</span>), and size (<span class="in">`length_mm`</span>) by <span class="in">`net_uuid`</span>. Also incorporate recommended vocabularies, per:</span>
<span id="cb48-339"><a href="#cb48-339" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>https://manual.obis.org/vocabulary.html</span>
<span id="cb48-340"><a href="#cb48-340" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>https://ipt.gbif.org/manual/en/ipt/latest/best-practices-sampling-event-data</span>
<span id="cb48-341"><a href="#cb48-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-342"><a href="#cb48-342" aria-hidden="true" tabindex="-1"></a>Claude’s Plan: Strategy for Merging Egg/Larva Data into DarwinCore Archive</span>
<span id="cb48-343"><a href="#cb48-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-344"><a href="#cb48-344" aria-hidden="true" tabindex="-1"></a><span class="fu">### Current State Analysis</span></span>
<span id="cb48-345"><a href="#cb48-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-346"><a href="#cb48-346" aria-hidden="true" tabindex="-1"></a>Your existing implementation creates **separate occurrence records** for each stage:</span>
<span id="cb48-347"><a href="#cb48-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-348"><a href="#cb48-348" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`egg`</span> → lifeStage: "egg"</span>
<span id="cb48-349"><a href="#cb48-349" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`egg_stage`</span> → lifeStage: "egg_1", "egg_2", etc.</span>
<span id="cb48-350"><a href="#cb48-350" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`larva`</span> → lifeStage: "larva"</span>
<span id="cb48-351"><a href="#cb48-351" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`larva_stage`</span> → lifeStage: "larva_FLEX", "larva_POST", etc.</span>
<span id="cb48-352"><a href="#cb48-352" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`larva_size`</span> → lifeStage: "larva" (size in remarks)</span>
<span id="cb48-353"><a href="#cb48-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-354"><a href="#cb48-354" aria-hidden="true" tabindex="-1"></a>This creates 5 separate occurrence records for a single species in one net sample.</span>
<span id="cb48-355"><a href="#cb48-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-356"><a href="#cb48-356" aria-hidden="true" tabindex="-1"></a><span class="fu">### Recommended Strategy: Consolidated Occurrence with eMoF Extension</span></span>
<span id="cb48-357"><a href="#cb48-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-358"><a href="#cb48-358" aria-hidden="true" tabindex="-1"></a>Following OBIS/GBIF best practices, I recommend **consolidating to fewer occurrences** and using the **ExtendedMeasurementOrFact (eMoF)** extension for detailed measurements:</span>
<span id="cb48-359"><a href="#cb48-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-360"><a href="#cb48-360" aria-hidden="true" tabindex="-1"></a>**Approach: Two occurrences per species per net_uuid**</span>
<span id="cb48-361"><a href="#cb48-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-362"><a href="#cb48-362" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**One "egg" occurrence** (if eggs present)</span>
<span id="cb48-363"><a href="#cb48-363" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**One "larva" occurrence** (if larvae present)</span>
<span id="cb48-364"><a href="#cb48-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-365"><a href="#cb48-365" aria-hidden="true" tabindex="-1"></a>**Implementation Details:**</span>
<span id="cb48-366"><a href="#cb48-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-367"><a href="#cb48-367" aria-hidden="true" tabindex="-1"></a>**1. Occurrence Extension:**</span>
<span id="cb48-368"><a href="#cb48-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-369"><a href="#cb48-369" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`occurrenceID`</span>: UUID per life stage (egg or larva)</span>
<span id="cb48-370"><a href="#cb48-370" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>`eventID: Links to net_uuid</span>
<span id="cb48-371"><a href="#cb48-371" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>`lifeStage: Use S11 vocabulary terms:</span>
<span id="cb48-372"><a href="#cb48-372" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>`"egg" → http://vocab.nerc.ac.uk/collection/S11/current/S1110/</span>
<span id="cb48-373"><a href="#cb48-373" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>"larva" → http://vocab.nerc.ac.uk/collection/S11/current/S1133/</span>
<span id="cb48-374"><a href="#cb48-374" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`organismQuantity`</span>: **TOTAL count** (sum across all stages/sizes)</span>
<span id="cb48-375"><a href="#cb48-375" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`organismQuantityType`</span>: "individuals"</span>
<span id="cb48-376"><a href="#cb48-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-377"><a href="#cb48-377" aria-hidden="true" tabindex="-1"></a>**2. MeasurementOrFact Extension for Stage Details:**</span>
<span id="cb48-378"><a href="#cb48-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-379"><a href="#cb48-379" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`occurrenceID`</span>: Links to parent occurrence</span>
<span id="cb48-380"><a href="#cb48-380" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementType`</span>: "life stage abundance"</span>
<span id="cb48-381"><a href="#cb48-381" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementTypeID`</span>: P01 code for abundance by life stage</span>
<span id="cb48-382"><a href="#cb48-382" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementValue`</span>: tally for specific stage</span>
<span id="cb48-383"><a href="#cb48-383" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementValueID`</span>: S11 code for specific stage (e.g., "FLEX", "POST", "egg stage 5")</span>
<span id="cb48-384"><a href="#cb48-384" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementUnit`</span>: "individuals"</span>
<span id="cb48-385"><a href="#cb48-385" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementUnitID`</span>: P06 code</span>
<span id="cb48-386"><a href="#cb48-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-387"><a href="#cb48-387" aria-hidden="true" tabindex="-1"></a>**3. MeasurementOrFact Extension for Size:**</span>
<span id="cb48-388"><a href="#cb48-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-389"><a href="#cb48-389" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`occurrenceID`</span>: Links to larva occurrence</span>
<span id="cb48-390"><a href="#cb48-390" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementType`</span>: "body length"</span>
<span id="cb48-391"><a href="#cb48-391" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementTypeID`</span>: P01 code for body length (search P01 for appropriate term)</span>
<span id="cb48-392"><a href="#cb48-392" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementValue`</span>: length_mm value</span>
<span id="cb48-393"><a href="#cb48-393" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementUnit`</span>: "millimeters"</span>
<span id="cb48-394"><a href="#cb48-394" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementUnitID`</span>: http://vocab.nerc.ac.uk/collection/P06/current/UXMM/</span>
<span id="cb48-395"><a href="#cb48-395" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementRemarks`</span>: Include tally if multiple individuals at same length</span>
<span id="cb48-396"><a href="#cb48-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-397"><a href="#cb48-397" aria-hidden="true" tabindex="-1"></a>**Key Changes Required:**</span>
<span id="cb48-398"><a href="#cb48-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-399"><a href="#cb48-399" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Aggregate totals** by net_uuid + species_id + major life stage (egg vs larva)</span>
<span id="cb48-400"><a href="#cb48-400" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Map stage vocabularies** to S11 terms (needs vocabulary mapping table)</span>
<span id="cb48-401"><a href="#cb48-401" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Expand eMoF records** for each stage detail instead of separate occurrences</span>
<span id="cb48-402"><a href="#cb48-402" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Add vocabulary URIs** for measurementTypeID, measurementValueID, measurementUnitID</span>
<span id="cb48-403"><a href="#cb48-403" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Update meta.xml** to properly define eMoF extension relationships</span>
<span id="cb48-404"><a href="#cb48-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-405"><a href="#cb48-405" aria-hidden="true" tabindex="-1"></a>**Benefits:**</span>
<span id="cb48-406"><a href="#cb48-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-407"><a href="#cb48-407" aria-hidden="true" tabindex="-1"></a>✓ Follows OBIS/GBIF best practices</span>
<span id="cb48-408"><a href="#cb48-408" aria-hidden="true" tabindex="-1"></a>✓ Uses standardized vocabularies (S11, P01, P06)</span>
<span id="cb48-409"><a href="#cb48-409" aria-hidden="true" tabindex="-1"></a>✓ Reduces occurrence record count by ~5x</span>
<span id="cb48-410"><a href="#cb48-410" aria-hidden="true" tabindex="-1"></a>✓ Preserves all granular stage and size information</span>
<span id="cb48-411"><a href="#cb48-411" aria-hidden="true" tabindex="-1"></a>✓ Better separates taxonomy (occurrence) from measurements (eMoF)</span>
<span id="cb48-412"><a href="#cb48-412" aria-hidden="true" tabindex="-1"></a>✓ Makes data more queryable and comparable across datasets</span>
<span id="cb48-413"><a href="#cb48-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-414"><a href="#cb48-414" aria-hidden="true" tabindex="-1"></a>**Questions to Resolve:**</span>
<span id="cb48-415"><a href="#cb48-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-416"><a href="#cb48-416" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Should we create separate occurrences for egg vs larva, or merge into one occurrence per species?</span>
<span id="cb48-417"><a href="#cb48-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-418"><a href="#cb48-418" aria-hidden="true" tabindex="-1"></a>Answer: Yes, keep separate occurrences for egg and larva.</span>
<span id="cb48-419"><a href="#cb48-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-420"><a href="#cb48-420" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>How should we map egg stages (1-15) and larva stages (YOLK, PREF, FLEX, POST, TRNS) to S11 vocabulary?</span>
<span id="cb48-421"><a href="#cb48-421" aria-hidden="true" tabindex="-1"></a>Map egg stages to S11 terms for egg development stages (if available) or create custom mappings. Map larva stages to corresponding S11 terms.</span>
<span id="cb48-422"><a href="#cb48-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-423"><a href="#cb48-423" aria-hidden="true" tabindex="-1"></a>Answer: Use S11 terms as prefix, ie "egg" or "larva", and custom suffixes:</span>
<span id="cb48-424"><a href="#cb48-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-425"><a href="#cb48-425" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Egg stages: "egg, stage 1 of 11 (Moser &amp; Ahlstrom, 1985)", "egg, stage 2 of 11 (Moser &amp; Ahlstrom, 1985)", ..., "egg, stage 12 of 12 (Moser &amp; Ahlstrom, 1985)", ..., "egg, stage 15 of 12 (Moser &amp; Ahlstrom, 1985)" (admittedly stages 12 to 15 are unclear and will need revision later)</span>
<span id="cb48-426"><a href="#cb48-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-427"><a href="#cb48-427" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Larva stages: "larva, yolk sac"; "larva, preflexion", "larva, flexion"; "larva, postflexion"; or "larva, transformation"</span>
<span id="cb48-428"><a href="#cb48-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-429"><a href="#cb48-429" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>For larva_size records with the same length_mm but different tallies - should we sum them or keep separate eMoF records?</span>
<span id="cb48-430"><a href="#cb48-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-431"><a href="#cb48-431" aria-hidden="true" tabindex="-1"></a>Always use the <span class="in">`larva.tally`</span> and <span class="in">`egg.tally`</span> as the overall count for the occurrence record. For <span class="in">`larva_size`</span>, create separate eMoF records for each unique length_mm with its corresponding tally.</span>
<span id="cb48-432"><a href="#cb48-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-433"><a href="#cb48-433" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Also help debug GBIF IPT response from loading the existing dataset package as zip generated by @publish_larvae_to_obis.qmd as a "Sampling event" in DarwinCore: "Skipped mapped term http://rs.tdwg.org/dwc/terms/eventID, which is unknown to extension http://rs.tdwg.org/dwc/terms/MeasurementOrFact". I thought that eventID was required in both core and extension, but given the <span class="co">[</span><span class="ot">Example: Brackish water invertebrates survey -- Best Practices in Publishing Sampling-event data :: GBIF IPT User Manual</span><span class="co">](https://ipt.gbif.org/manual/en/ipt/latest/best-practices-sampling-event-data#brackish-water-invertebrates-survey)</span> perhaps it should be called "EventID" instead of "eventID"?</span>
<span id="cb48-434"><a href="#cb48-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-435"><a href="#cb48-435" aria-hidden="true" tabindex="-1"></a>Comprehensive Strategy for DarwinCore Archive Implementation</span>
<span id="cb48-436"><a href="#cb48-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-437"><a href="#cb48-437" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 1: Fix Current GBIF IPT Error</span></span>
<span id="cb48-438"><a href="#cb48-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-439"><a href="#cb48-439" aria-hidden="true" tabindex="-1"></a>Problem Identified: The <span class="in">`meta.xml:54-55`</span> incorrectly defines eventID as BOTH:</span>
<span id="cb48-440"><a href="#cb48-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-441"><a href="#cb48-441" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`&lt;coreid index="0" /&gt;`</span> (line 54) - the linking column</span>
<span id="cb48-442"><a href="#cb48-442" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`&lt;field index="0" term="...eventID"/&gt;`</span> (line 55) - a data field</span>
<span id="cb48-443"><a href="#cb48-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-444"><a href="#cb48-444" aria-hidden="true" tabindex="-1"></a>**Solution**: Remove line 55 from meta.xml. The coreid column should NOT be duplicated as a field definition. The corrected MeasurementOrFact extension should be:</span>
<span id="cb48-445"><a href="#cb48-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-446"><a href="#cb48-446" aria-hidden="true" tabindex="-1"></a><span class="in">```xml</span></span>
<span id="cb48-447"><a href="#cb48-447" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">extension</span> <span class="er">...</span><span class="ot"> rowType=</span><span class="st">"http://rs.tdwg.org/dwc/terms/MeasurementOrFact"</span>&gt;</span>
<span id="cb48-448"><a href="#cb48-448" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">coreid</span><span class="ot"> index=</span><span class="st">"0"</span> /&gt;</span>
<span id="cb48-449"><a href="#cb48-449" aria-hidden="true" tabindex="-1"></a>  <span class="co">&lt;!-- Remove: &lt;field index="0" term="...eventID"/&gt; --&gt;</span></span>
<span id="cb48-450"><a href="#cb48-450" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">field</span><span class="ot"> index=</span><span class="st">"1"</span><span class="ot"> term=</span><span class="st">"http://rs.tdwg.org/dwc/terms/measurementType"</span>/&gt;</span>
<span id="cb48-451"><a href="#cb48-451" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">field</span><span class="ot"> index=</span><span class="st">"2"</span><span class="ot"> term=</span><span class="st">"http://rs.tdwg.org/dwc/terms/measurementValue"</span>/&gt;</span>
<span id="cb48-452"><a href="#cb48-452" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb48-453"><a href="#cb48-453" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">field</span><span class="ot"> index=</span><span class="st">"7"</span><span class="ot"> term=</span><span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceID"</span>/&gt;</span>
<span id="cb48-454"><a href="#cb48-454" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">extension</span>&gt;</span>
<span id="cb48-455"><a href="#cb48-455" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-456"><a href="#cb48-456" aria-hidden="true" tabindex="-1"></a>Note: eventID (column 0) remains as coreid; occurrenceID (column 7) stays as a regular field for biological measurements.</span>
<span id="cb48-457"><a href="#cb48-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-458"><a href="#cb48-458" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 2: Revised Data Structure for Egg/Larva Merging</span></span>
<span id="cb48-459"><a href="#cb48-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-460"><a href="#cb48-460" aria-hidden="true" tabindex="-1"></a>Based on your specifications:</span>
<span id="cb48-461"><a href="#cb48-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-462"><a href="#cb48-462" aria-hidden="true" tabindex="-1"></a>**Occurrence Extension Structure**</span>
<span id="cb48-463"><a href="#cb48-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-464"><a href="#cb48-464" aria-hidden="true" tabindex="-1"></a>**One occurrence per major life stage per species per net_uuid:**</span>
<span id="cb48-465"><a href="#cb48-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-466"><a href="#cb48-466" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Egg occurrence** (if eggs present):</span>
<span id="cb48-467"><a href="#cb48-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-468"><a href="#cb48-468" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`occurrenceID`</span>: UUID</span>
<span id="cb48-469"><a href="#cb48-469" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`eventID`</span>: net_uuid</span>
<span id="cb48-470"><a href="#cb48-470" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`scientificName`</span>: species name</span>
<span id="cb48-471"><a href="#cb48-471" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`lifeStage`</span>: "egg" (with S11 URI)</span>
<span id="cb48-472"><a href="#cb48-472" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`organismQuantity`</span>: **egg.tally** (total across all stages)</span>
<span id="cb48-473"><a href="#cb48-473" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`organismQuantityType`</span>: "individuals"</span>
<span id="cb48-474"><a href="#cb48-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-475"><a href="#cb48-475" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Larva occurrence** (if larvae present):</span>
<span id="cb48-476"><a href="#cb48-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-477"><a href="#cb48-477" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`occurrenceID`</span>: UUID</span>
<span id="cb48-478"><a href="#cb48-478" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`eventID`</span>: net_uuid</span>
<span id="cb48-479"><a href="#cb48-479" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`scientificName`</span>: species name</span>
<span id="cb48-480"><a href="#cb48-480" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`lifeStage`</span>: "larva" (with S11 URI)</span>
<span id="cb48-481"><a href="#cb48-481" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`organismQuantity`</span>: larva.tally (total across all stages)</span>
<span id="cb48-482"><a href="#cb48-482" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`organismQuantityType`</span>: "individuals"</span>
<span id="cb48-483"><a href="#cb48-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-484"><a href="#cb48-484" aria-hidden="true" tabindex="-1"></a>**MeasurementOrFact Extension Structure**</span>
<span id="cb48-485"><a href="#cb48-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-486"><a href="#cb48-486" aria-hidden="true" tabindex="-1"></a>**Three types of measurements:**</span>
<span id="cb48-487"><a href="#cb48-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-488"><a href="#cb48-488" aria-hidden="true" tabindex="-1"></a>**1. Environmental measurements** (link to eventID):</span>
<span id="cb48-489"><a href="#cb48-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-490"><a href="#cb48-490" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`eventID`</span>: net_uuid</span>
<span id="cb48-491"><a href="#cb48-491" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`occurrenceID`</span>: NA</span>
<span id="cb48-492"><a href="#cb48-492" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Measurements: std_haul_factor, vol_sampled_m3, prop_sorted, smallplankton, totalplankton</span>
<span id="cb48-493"><a href="#cb48-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-494"><a href="#cb48-494" aria-hidden="true" tabindex="-1"></a>**2. Stage-specific counts** (link to occurrenceID):</span>
<span id="cb48-495"><a href="#cb48-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-496"><a href="#cb48-496" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`eventID`</span>: NA</span>
<span id="cb48-497"><a href="#cb48-497" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`occurrenceID`</span>: links to egg or larva occurrence</span>
<span id="cb48-498"><a href="#cb48-498" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementType`</span>: "abundance by life stage"</span>
<span id="cb48-499"><a href="#cb48-499" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementTypeID`</span>: P01 code (TBD - search P01 for appropriate term)</span>
<span id="cb48-500"><a href="#cb48-500" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementValue`</span>: tally for specific stage</span>
<span id="cb48-501"><a href="#cb48-501" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementValueID`</span>: Custom life stage term (see vocabulary mapping below)</span>
<span id="cb48-502"><a href="#cb48-502" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementUnit`</span>: "individuals"</span>
<span id="cb48-503"><a href="#cb48-503" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementUnitID`</span>: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/</span>
<span id="cb48-504"><a href="#cb48-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-505"><a href="#cb48-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-506"><a href="#cb48-506" aria-hidden="true" tabindex="-1"></a>**3. Size measurements**2 (link to occurrenceID):</span>
<span id="cb48-507"><a href="#cb48-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-508"><a href="#cb48-508" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`eventID`</span>: NA</span>
<span id="cb48-509"><a href="#cb48-509" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`occurrenceID`</span>: links to larva occurrence</span>
<span id="cb48-510"><a href="#cb48-510" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementType`</span>: "body length"</span>
<span id="cb48-511"><a href="#cb48-511" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementTypeID`</span>: P01 code for body length</span>
<span id="cb48-512"><a href="#cb48-512" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementValue`</span>: length_mm</span>
<span id="cb48-513"><a href="#cb48-513" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementUnit`</span>: "millimeters"</span>
<span id="cb48-514"><a href="#cb48-514" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementUnitID`</span>: http://vocab.nerc.ac.uk/collection/P06/current/UXMM/</span>
<span id="cb48-515"><a href="#cb48-515" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`measurementRemarks`</span>: Include tally value</span>
<span id="cb48-516"><a href="#cb48-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-517"><a href="#cb48-517" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 3: Life Stage Vocabulary Mapping</span></span>
<span id="cb48-518"><a href="#cb48-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-519"><a href="#cb48-519" aria-hidden="true" tabindex="-1"></a>Per your specifications, use S11 URI prefix with custom suffixes:</span>
<span id="cb48-520"><a href="#cb48-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-521"><a href="#cb48-521" aria-hidden="true" tabindex="-1"></a>**Egg Stages (from egg_stage table)**:</span>
<span id="cb48-522"><a href="#cb48-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-523"><a href="#cb48-523" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Stage 1: "egg, stage 1 of 11 (Moser &amp; Ahlstrom, 1985)"</span>
<span id="cb48-524"><a href="#cb48-524" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Stage 2: "egg, stage 2 of 11 (Moser &amp; Ahlstrom, 1985)"</span>
<span id="cb48-525"><a href="#cb48-525" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb48-526"><a href="#cb48-526" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Stage 11: "egg, stage 11 of 11 (Moser &amp; Ahlstrom, 1985)"</span>
<span id="cb48-527"><a href="#cb48-527" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Stage 12: "egg, stage 12 of 11 (Moser &amp; Ahlstrom, 1985)" <span class="co">[</span><span class="ot">needs revision</span><span class="co">]</span></span>
<span id="cb48-528"><a href="#cb48-528" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Stage 13: "egg, stage 13 of 11 (Moser &amp; Ahlstrom, 1985)" <span class="co">[</span><span class="ot">needs revision</span><span class="co">]</span></span>
<span id="cb48-529"><a href="#cb48-529" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Stage 14: "egg, stage 14 of 11 (Moser &amp; Ahlstrom, 1985)" <span class="co">[</span><span class="ot">needs revision</span><span class="co">]</span></span>
<span id="cb48-530"><a href="#cb48-530" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Stage 15: "egg, stage 15 of 11 (Moser &amp; Ahlstrom, 1985)" <span class="co">[</span><span class="ot">needs revision</span><span class="co">]</span></span>
<span id="cb48-531"><a href="#cb48-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-532"><a href="#cb48-532" aria-hidden="true" tabindex="-1"></a>**S11 base URI**: http://vocab.nerc.ac.uk/collection/S11/current/S1110/ (egg)</span>
<span id="cb48-533"><a href="#cb48-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-534"><a href="#cb48-534" aria-hidden="true" tabindex="-1"></a>**Larva Stages (from larva_stage table)**:</span>
<span id="cb48-535"><a href="#cb48-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-536"><a href="#cb48-536" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>YOLK: "larva, yolk sac"</span>
<span id="cb48-537"><a href="#cb48-537" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>PREF: "larva, preflexion"</span>
<span id="cb48-538"><a href="#cb48-538" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>FLEX: "larva, flexion"</span>
<span id="cb48-539"><a href="#cb48-539" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>POST: "larva, postflexion"</span>
<span id="cb48-540"><a href="#cb48-540" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>TRNS: "larva, transformation"</span>
<span id="cb48-541"><a href="#cb48-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-542"><a href="#cb48-542" aria-hidden="true" tabindex="-1"></a>**S11 base URI**: http://vocab.nerc.ac.uk/collection/S11/current/S1133/ (larva)</span>
<span id="cb48-543"><a href="#cb48-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-544"><a href="#cb48-544" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 4: Data Aggregation Logic</span></span>
<span id="cb48-545"><a href="#cb48-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-546"><a href="#cb48-546" aria-hidden="true" tabindex="-1"></a>SQL aggregation strategy:</span>
<span id="cb48-547"><a href="#cb48-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-548"><a href="#cb48-548" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Create egg occurrences**:</span>
<span id="cb48-549"><a href="#cb48-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-550"><a href="#cb48-550" aria-hidden="true" tabindex="-1"></a><span class="in">```sql</span></span>
<span id="cb48-551"><a href="#cb48-551" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb48-552"><a href="#cb48-552" aria-hidden="true" tabindex="-1"></a>  net_uuid,</span>
<span id="cb48-553"><a href="#cb48-553" aria-hidden="true" tabindex="-1"></a>  species_id,</span>
<span id="cb48-554"><a href="#cb48-554" aria-hidden="true" tabindex="-1"></a>  <span class="fu">SUM</span>(tally) <span class="kw">as</span> total_tally  <span class="co">-- sum from egg table</span></span>
<span id="cb48-555"><a href="#cb48-555" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> egg</span>
<span id="cb48-556"><a href="#cb48-556" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> net_uuid, species_id</span>
<span id="cb48-557"><a href="#cb48-557" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-558"><a href="#cb48-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-559"><a href="#cb48-559" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Create larva occurrences**:</span>
<span id="cb48-560"><a href="#cb48-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-561"><a href="#cb48-561" aria-hidden="true" tabindex="-1"></a><span class="in">```sql</span></span>
<span id="cb48-562"><a href="#cb48-562" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb48-563"><a href="#cb48-563" aria-hidden="true" tabindex="-1"></a>  net_uuid,</span>
<span id="cb48-564"><a href="#cb48-564" aria-hidden="true" tabindex="-1"></a>  species_id,</span>
<span id="cb48-565"><a href="#cb48-565" aria-hidden="true" tabindex="-1"></a>  <span class="fu">SUM</span>(tally) <span class="kw">as</span> total_tally  <span class="co">-- sum from larva table</span></span>
<span id="cb48-566"><a href="#cb48-566" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> larva</span>
<span id="cb48-567"><a href="#cb48-567" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> net_uuid, species_id</span>
<span id="cb48-568"><a href="#cb48-568" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-569"><a href="#cb48-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-570"><a href="#cb48-570" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Create stage-specific eMoF records**:</span>
<span id="cb48-571"><a href="#cb48-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-572"><a href="#cb48-572" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Join egg_stage → egg occurrence</span>
<span id="cb48-573"><a href="#cb48-573" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Join larva_stage → larva occurrence</span>
<span id="cb48-574"><a href="#cb48-574" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Each stage row becomes one eMoF measurement</span>
<span id="cb48-575"><a href="#cb48-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-576"><a href="#cb48-576" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Create size eMoF records**:</span>
<span id="cb48-577"><a href="#cb48-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-578"><a href="#cb48-578" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Join larva_size → larva occurrence</span>
<span id="cb48-579"><a href="#cb48-579" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Each unique length_mm becomes one eMoF measurement</span>
<span id="cb48-580"><a href="#cb48-580" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Include tally in measurementRemarks</span>
<span id="cb48-581"><a href="#cb48-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-582"><a href="#cb48-582" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 5: Required Vocabulary URIs</span></span>
<span id="cb48-583"><a href="#cb48-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-584"><a href="#cb48-584" aria-hidden="true" tabindex="-1"></a>To add to the implementation:</span>
<span id="cb48-585"><a href="#cb48-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-586"><a href="#cb48-586" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>lifeStage URIs:</span>
<span id="cb48-587"><a href="#cb48-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-588"><a href="#cb48-588" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Egg: http://vocab.nerc.ac.uk/collection/S11/current/S1110/</span>
<span id="cb48-589"><a href="#cb48-589" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Larva: http://vocab.nerc.ac.uk/collection/S11/current/S1133/</span>
<span id="cb48-590"><a href="#cb48-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-591"><a href="#cb48-591" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**measurementTypeID** (P01 codes to research):</span>
<span id="cb48-592"><a href="#cb48-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-593"><a href="#cb48-593" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Abundance by life stage: <span class="co">[</span><span class="ot">search P01 collection</span><span class="co">]</span></span>
<span id="cb48-594"><a href="#cb48-594" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Body length: <span class="co">[</span><span class="ot">search P01 collection for fish larvae length</span><span class="co">]</span></span>
<span id="cb48-595"><a href="#cb48-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-596"><a href="#cb48-596" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**measurementUnitID**:</span>
<span id="cb48-597"><a href="#cb48-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-598"><a href="#cb48-598" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Individuals: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/</span>
<span id="cb48-599"><a href="#cb48-599" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Millimeters: http://vocab.nerc.ac.uk/collection/P06/current/UXMM/</span>
<span id="cb48-600"><a href="#cb48-600" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Dimensionless: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/</span>
<span id="cb48-601"><a href="#cb48-601" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Cubic meters: http://vocab.nerc.ac.uk/collection/P06/current/MCUB/</span>
<span id="cb48-602"><a href="#cb48-602" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Grams: http://vocab.nerc.ac.uk/collection/P06/current/UGRM/</span>
<span id="cb48-603"><a href="#cb48-603" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Proportion: http://vocab.nerc.ac.uk/collection/P06/current/UPCT/ (or dimensionless)</span>
<span id="cb48-604"><a href="#cb48-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-605"><a href="#cb48-605" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 6: Implementation Changes in publish_larvae_to_obis.qmd</span></span>
<span id="cb48-606"><a href="#cb48-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-607"><a href="#cb48-607" aria-hidden="true" tabindex="-1"></a>Key modifications needed:</span>
<span id="cb48-608"><a href="#cb48-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-609"><a href="#cb48-609" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Aggregate occurrence data** from 5 tables → 2 types (egg, larva)</span>
<span id="cb48-610"><a href="#cb48-610" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Update lifeStage field** to use only "egg" or "larva" (not stage-specific)</span>
<span id="cb48-611"><a href="#cb48-611" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Expand eMoF records** to include stage-specific counts</span>
<span id="cb48-612"><a href="#cb48-612" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Add vocabulary URI fields**: lifeStageID, measurementTypeID, measurementValueID, measurementUnitID</span>
<span id="cb48-613"><a href="#cb48-613" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Fix meta.xml** by removing duplicate eventID field definition</span>
<span id="cb48-614"><a href="#cb48-614" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Create stage vocabulary lookup table** for mapping numeric/text stages to descriptive terms</span>
<span id="cb48-615"><a href="#cb48-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-616"><a href="#cb48-616" aria-hidden="true" tabindex="-1"></a><span class="fu">### Expected Outcome</span></span>
<span id="cb48-617"><a href="#cb48-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-618"><a href="#cb48-618" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Occurrence reduction**: From ~867k occurrence records → ~491k occurrence records (combining 5 tables into 2 life stages)</span>
<span id="cb48-619"><a href="#cb48-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-620"><a href="#cb48-620" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**eMoF expansion**: From ~19k eMoF records → ~395k eMoF records (adding stage and size details) Benefits:</span>
<span id="cb48-621"><a href="#cb48-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-622"><a href="#cb48-622" aria-hidden="true" tabindex="-1"></a>✓ Follows OBIS/GBIF best practices</span>
<span id="cb48-623"><a href="#cb48-623" aria-hidden="true" tabindex="-1"></a>✓ Fixes GBIF IPT validation error</span>
<span id="cb48-624"><a href="#cb48-624" aria-hidden="true" tabindex="-1"></a>✓ Uses standardized vocabularies (S11, P01, P06)</span>
<span id="cb48-625"><a href="#cb48-625" aria-hidden="true" tabindex="-1"></a>✓ Preserves all granular data through eMoF</span>
<span id="cb48-626"><a href="#cb48-626" aria-hidden="true" tabindex="-1"></a>✓ Cleaner separation of taxonomy and measurements</span>
<span id="cb48-627"><a href="#cb48-627" aria-hidden="true" tabindex="-1"></a>✓ More queryable and comparable data structure</span>
<span id="cb48-628"><a href="#cb48-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-629"><a href="#cb48-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-630"><a href="#cb48-630" aria-hidden="true" tabindex="-1"></a>PROMPT: Instead of using MeasurementOrFact, be sure to explicitly use OBIS ExtendedMeasurementOrFact (eMoF) by for instance renaming output table to extendedMeasurementOrFact.csv and allowing occurrenceID to relate to individual occurrence records. Be sure to process https://manual.obis.org/format_emof.html and think hard before proceeding with plan and edits. Incorporate <span class="in">`vol_sampled_m3`</span> as <span class="in">`sampleSizeValue`</span> with <span class="in">`sampleSizeUnit`</span> = "m^3". Research good options to incorporate **proportion sorted** `prop_sorted` and if possible **standard haul factor** (<span class="in">`std_haul_factor`</span>).</span>
<span id="cb48-631"><a href="#cb48-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-632"><a href="#cb48-632" aria-hidden="true" tabindex="-1"></a>https://web.archive.org/web/20250417074825if_/https://calcofi.org/downloads/publications/atlases/CalCOFI_Atlas_28.pdf</span>
<span id="cb48-633"><a href="#cb48-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-634"><a href="#cb48-634" aria-hidden="true" tabindex="-1"></a>DISTRIBUTIONAL ATLAS OF FISH LARVAE IN THE CALIFORNIA CURRENT REGION:</span>
<span id="cb48-635"><a href="#cb48-635" aria-hidden="true" tabindex="-1"></a>NORTHERN ANCHOVY, Engraulis mordax GIRARD,</span>
<span id="cb48-636"><a href="#cb48-636" aria-hidden="true" tabindex="-1"></a>1966 THROUGH 1979</span>
<span id="cb48-637"><a href="#cb48-637" aria-hidden="true" tabindex="-1"></a>by Roger Hewitt</span>
<span id="cb48-638"><a href="#cb48-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-639"><a href="#cb48-639" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Samples are standardized by adjusting to a standard unit of sea surface area. The standard unit is 10 m^2^ and the adjustment (**standard haul factor**) is calculated as the ratio of a standard volume of water filtered per unit depth and the total volume of water filtered over the total depth. Thus:</span></span>
<span id="cb48-640"><a href="#cb48-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-641"><a href="#cb48-641" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-642"><a href="#cb48-642" aria-hidden="true" tabindex="-1"></a>SHF = ((10 m^3) / m) / (v/d) = 10 d</span>
<span id="cb48-643"><a href="#cb48-643" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb48-644"><a href="#cb48-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-645"><a href="#cb48-645" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; where $v$ is the volume of water filtered, determined by flowmeter, and $d$ is the depth fished, determined by the amount of wire out times the cosine of the average angle of stray from the vertical.</span></span>
<span id="cb48-646"><a href="#cb48-646" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; </span></span>
<span id="cb48-647"><a href="#cb48-647" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Sample counts were adjusted for fractioning (minimum aliquot was 25%) and standardized to each other. The charts are thus in units of the number of larvae under 10 m^2^ of sea surface.</span></span>
<span id="cb48-648"><a href="#cb48-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-649"><a href="#cb48-649" aria-hidden="true" tabindex="-1"></a>[ </span>
<span id="cb48-650"><a href="#cb48-650" aria-hidden="true" tabindex="-1"></a><span class="in">`occurrence.csv: organismQuantity | organismQuantityType: "individuals"`</span></span>
<span id="cb48-651"><a href="#cb48-651" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb48-652"><a href="#cb48-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-653"><a href="#cb48-653" aria-hidden="true" tabindex="-1"></a>Comprehensive Strategy for DarwinCore Archive with OBIS ExtendedMeasurementOrFact</span>
<span id="cb48-654"><a href="#cb48-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-655"><a href="#cb48-655" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 1: Fix GBIF IPT Error &amp; Use Proper eMoF Format</span></span>
<span id="cb48-656"><a href="#cb48-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-657"><a href="#cb48-657" aria-hidden="true" tabindex="-1"></a>Critical Changes:</span>
<span id="cb48-658"><a href="#cb48-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-659"><a href="#cb48-659" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Rename file**: measurementorfact.csv → extendedMeasurementOrFact.csv</span>
<span id="cb48-660"><a href="#cb48-660" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Update rowType URI** in meta.xml from:</span>
<span id="cb48-661"><a href="#cb48-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-662"><a href="#cb48-662" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-663"><a href="#cb48-663" aria-hidden="true" tabindex="-1"></a><span class="in">rowType="http://rs.tdwg.org/dwc/terms/MeasurementOrFact"</span></span>
<span id="cb48-664"><a href="#cb48-664" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-665"><a href="#cb48-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-666"><a href="#cb48-666" aria-hidden="true" tabindex="-1"></a>to:</span>
<span id="cb48-667"><a href="#cb48-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-668"><a href="#cb48-668" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-669"><a href="#cb48-669" aria-hidden="true" tabindex="-1"></a><span class="in">rowType="http://rs.gbif.org/terms/1.0/ExtendedMeasurementOrFact"</span></span>
<span id="cb48-670"><a href="#cb48-670" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-671"><a href="#cb48-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-672"><a href="#cb48-672" aria-hidden="true" tabindex="-1"></a>or the OBIS schema URI:</span>
<span id="cb48-673"><a href="#cb48-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-674"><a href="#cb48-674" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-675"><a href="#cb48-675" aria-hidden="true" tabindex="-1"></a><span class="in">rowType="https://rs.gbif.org/extension/obis/extended_measurement_or_fact.xml"</span></span>
<span id="cb48-676"><a href="#cb48-676" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-677"><a href="#cb48-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-678"><a href="#cb48-678" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Remove duplicate eventID field definition** from meta.xml:</span>
<span id="cb48-679"><a href="#cb48-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-680"><a href="#cb48-680" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Keep: <span class="in">`&lt;coreid index="0" /&gt;`</span> (links extension to core)</span>
<span id="cb48-681"><a href="#cb48-681" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Remove: <span class="in">`&lt;field index="0" term="...eventID"/&gt;`</span> (duplicates the coreid)</span>
<span id="cb48-682"><a href="#cb48-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-683"><a href="#cb48-683" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Retain occurrenceID field** (index 7) to enable biological measurement linking</span>
<span id="cb48-684"><a href="#cb48-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-685"><a href="#cb48-685" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 2: Move Volume Sampled to Event Core</span></span>
<span id="cb48-686"><a href="#cb48-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-687"><a href="#cb48-687" aria-hidden="true" tabindex="-1"></a>**Change: vol_sampled_m3 from eMoF → Event core** </span>
<span id="cb48-688"><a href="#cb48-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-689"><a href="#cb48-689" aria-hidden="true" tabindex="-1"></a>Add to event.csv and event section of meta.xml:</span>
<span id="cb48-690"><a href="#cb48-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-691"><a href="#cb48-691" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`sampleSizeValue`</span>: value from net.vol_sampled_m3</span>
<span id="cb48-692"><a href="#cb48-692" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`sampleSizeUnit`</span>: "m^3" (or "cubic meters")</span>
<span id="cb48-693"><a href="#cb48-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-694"><a href="#cb48-694" aria-hidden="true" tabindex="-1"></a>**Rationale**: Volume sampled is a fundamental sample attribute, not a measurement derived from the sample. OBIS best practices support placing this in the Event core.</span>
<span id="cb48-695"><a href="#cb48-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-696"><a href="#cb48-696" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 3: Restructured Occurrence Records</span></span>
<span id="cb48-697"><a href="#cb48-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-698"><a href="#cb48-698" aria-hidden="true" tabindex="-1"></a>**Create TWO occurrences per species per net_uuid**:</span>
<span id="cb48-699"><a href="#cb48-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-700"><a href="#cb48-700" aria-hidden="true" tabindex="-1"></a>**Egg Occurrence (when eggs present)**:</span>
<span id="cb48-701"><a href="#cb48-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-702"><a href="#cb48-702" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-703"><a href="#cb48-703" aria-hidden="true" tabindex="-1"></a><span class="in">occurrenceID: UUID</span></span>
<span id="cb48-704"><a href="#cb48-704" aria-hidden="true" tabindex="-1"></a><span class="in">eventID: net_uuid</span></span>
<span id="cb48-705"><a href="#cb48-705" aria-hidden="true" tabindex="-1"></a><span class="in">scientificName: species name from species table</span></span>
<span id="cb48-706"><a href="#cb48-706" aria-hidden="true" tabindex="-1"></a><span class="in">scientificNameID: urn:lsid:marinespecies.org:taxname:{worms_id}</span></span>
<span id="cb48-707"><a href="#cb48-707" aria-hidden="true" tabindex="-1"></a><span class="in">kingdom: Animalia</span></span>
<span id="cb48-708"><a href="#cb48-708" aria-hidden="true" tabindex="-1"></a><span class="in">lifeStage: "egg"</span></span>
<span id="cb48-709"><a href="#cb48-709" aria-hidden="true" tabindex="-1"></a><span class="in">lifeStageID: http://vocab.nerc.ac.uk/collection/S11/current/S1110/</span></span>
<span id="cb48-710"><a href="#cb48-710" aria-hidden="true" tabindex="-1"></a><span class="in">organismQuantity: egg.tally (TOTAL across all stages)</span></span>
<span id="cb48-711"><a href="#cb48-711" aria-hidden="true" tabindex="-1"></a><span class="in">organismQuantityType: "individuals"</span></span>
<span id="cb48-712"><a href="#cb48-712" aria-hidden="true" tabindex="-1"></a><span class="in">occurrenceStatus: "present"</span></span>
<span id="cb48-713"><a href="#cb48-713" aria-hidden="true" tabindex="-1"></a><span class="in">basisOfRecord: "HumanObservation"</span></span>
<span id="cb48-714"><a href="#cb48-714" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-715"><a href="#cb48-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-716"><a href="#cb48-716" aria-hidden="true" tabindex="-1"></a>**Larva Occurrence (when larvae present)**:</span>
<span id="cb48-717"><a href="#cb48-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-718"><a href="#cb48-718" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-719"><a href="#cb48-719" aria-hidden="true" tabindex="-1"></a><span class="in">occurrenceID: UUID</span></span>
<span id="cb48-720"><a href="#cb48-720" aria-hidden="true" tabindex="-1"></a><span class="in">eventID: net_uuid</span></span>
<span id="cb48-721"><a href="#cb48-721" aria-hidden="true" tabindex="-1"></a><span class="in">scientificName: species name from species table</span></span>
<span id="cb48-722"><a href="#cb48-722" aria-hidden="true" tabindex="-1"></a><span class="in">scientificNameID: urn:lsid:marinespecies.org:taxname:{worms_id}</span></span>
<span id="cb48-723"><a href="#cb48-723" aria-hidden="true" tabindex="-1"></a><span class="in">kingdom: Animalia</span></span>
<span id="cb48-724"><a href="#cb48-724" aria-hidden="true" tabindex="-1"></a><span class="in">lifeStage: "larva"</span></span>
<span id="cb48-725"><a href="#cb48-725" aria-hidden="true" tabindex="-1"></a><span class="in">lifeStageID: http://vocab.nerc.ac.uk/collection/S11/current/S1133/</span></span>
<span id="cb48-726"><a href="#cb48-726" aria-hidden="true" tabindex="-1"></a><span class="in">organismQuantity: larva.tally (TOTAL across all stages)</span></span>
<span id="cb48-727"><a href="#cb48-727" aria-hidden="true" tabindex="-1"></a><span class="in">organismQuantityType: "individuals"</span></span>
<span id="cb48-728"><a href="#cb48-728" aria-hidden="true" tabindex="-1"></a><span class="in">occurrenceStatus: "present"</span></span>
<span id="cb48-729"><a href="#cb48-729" aria-hidden="true" tabindex="-1"></a><span class="in">basisOfRecord: "HumanObservation"</span></span>
<span id="cb48-730"><a href="#cb48-730" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-731"><a href="#cb48-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-732"><a href="#cb48-732" aria-hidden="true" tabindex="-1"></a>**Key change**: Use aggregated totals from egg/larva tables, not stage-specific tables.</span>
<span id="cb48-733"><a href="#cb48-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-734"><a href="#cb48-734" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 4: ExtendedMeasurementOrFact Structure</span></span>
<span id="cb48-735"><a href="#cb48-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-736"><a href="#cb48-736" aria-hidden="true" tabindex="-1"></a>**Three measurement categories**:</span>
<span id="cb48-737"><a href="#cb48-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-738"><a href="#cb48-738" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Sample-Level Measurements** (link to eventID)</span>
<span id="cb48-739"><a href="#cb48-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-740"><a href="#cb48-740" aria-hidden="true" tabindex="-1"></a>A. **Proportion Sorted**:</span>
<span id="cb48-741"><a href="#cb48-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-742"><a href="#cb48-742" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-743"><a href="#cb48-743" aria-hidden="true" tabindex="-1"></a><span class="in">eventID: net_uuid</span></span>
<span id="cb48-744"><a href="#cb48-744" aria-hidden="true" tabindex="-1"></a><span class="in">occurrenceID: [blank/NA]</span></span>
<span id="cb48-745"><a href="#cb48-745" aria-hidden="true" tabindex="-1"></a><span class="in">measurementID: UUID</span></span>
<span id="cb48-746"><a href="#cb48-746" aria-hidden="true" tabindex="-1"></a><span class="in">measurementType: "proportion of sample sorted"</span></span>
<span id="cb48-747"><a href="#cb48-747" aria-hidden="true" tabindex="-1"></a><span class="in">measurementTypeID: [P01 code - TBD, search for "subsample fraction" or "sorting proportion"]</span></span>
<span id="cb48-748"><a href="#cb48-748" aria-hidden="true" tabindex="-1"></a><span class="in">measurementValue: net.prop_sorted (e.g., "1" or "0.5")</span></span>
<span id="cb48-749"><a href="#cb48-749" aria-hidden="true" tabindex="-1"></a><span class="in">measurementUnit: "dimensionless" or "proportion"</span></span>
<span id="cb48-750"><a href="#cb48-750" aria-hidden="true" tabindex="-1"></a><span class="in">measurementUnitID: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/</span></span>
<span id="cb48-751"><a href="#cb48-751" aria-hidden="true" tabindex="-1"></a><span class="in">measurementRemarks: "Fraction of total sample examined"</span></span>
<span id="cb48-752"><a href="#cb48-752" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-753"><a href="#cb48-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-754"><a href="#cb48-754" aria-hidden="true" tabindex="-1"></a>B. **Standard Haul Factor**:</span>
<span id="cb48-755"><a href="#cb48-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-756"><a href="#cb48-756" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-757"><a href="#cb48-757" aria-hidden="true" tabindex="-1"></a><span class="in">eventID: net_uuid</span></span>
<span id="cb48-758"><a href="#cb48-758" aria-hidden="true" tabindex="-1"></a><span class="in">occurrenceID: [blank/NA]</span></span>
<span id="cb48-759"><a href="#cb48-759" aria-hidden="true" tabindex="-1"></a><span class="in">measurementID: UUID</span></span>
<span id="cb48-760"><a href="#cb48-760" aria-hidden="true" tabindex="-1"></a><span class="in">measurementType: "standardized haul factor"</span></span>
<span id="cb48-761"><a href="#cb48-761" aria-hidden="true" tabindex="-1"></a><span class="in">measurementTypeID: [P01 code - TBD, search for "catch standardization" or "sampling effort coefficient"]</span></span>
<span id="cb48-762"><a href="#cb48-762" aria-hidden="true" tabindex="-1"></a><span class="in">measurementValue: net.std_haul_factor (e.g., "3.14")</span></span>
<span id="cb48-763"><a href="#cb48-763" aria-hidden="true" tabindex="-1"></a><span class="in">measurementUnit: "dimensionless"</span></span>
<span id="cb48-764"><a href="#cb48-764" aria-hidden="true" tabindex="-1"></a><span class="in">measurementUnitID: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/</span></span>
<span id="cb48-765"><a href="#cb48-765" aria-hidden="true" tabindex="-1"></a><span class="in">measurementMethod: "https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span></span>
<span id="cb48-766"><a href="#cb48-766" aria-hidden="true" tabindex="-1"></a><span class="in">measurementRemarks: "Standardization factor accounting for water filtered; abundances expressed as per 10 m² (Smith 1977)"</span></span>
<span id="cb48-767"><a href="#cb48-767" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-768"><a href="#cb48-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-769"><a href="#cb48-769" aria-hidden="true" tabindex="-1"></a>C. **Plankton Biomass**:</span>
<span id="cb48-770"><a href="#cb48-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-771"><a href="#cb48-771" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-772"><a href="#cb48-772" aria-hidden="true" tabindex="-1"></a><span class="in">eventID: net_uuid</span></span>
<span id="cb48-773"><a href="#cb48-773" aria-hidden="true" tabindex="-1"></a><span class="in">occurrenceID: [blank/NA]</span></span>
<span id="cb48-774"><a href="#cb48-774" aria-hidden="true" tabindex="-1"></a><span class="in">measurementID: UUID</span></span>
<span id="cb48-775"><a href="#cb48-775" aria-hidden="true" tabindex="-1"></a><span class="in">measurementType: "small plankton biomass" / "total plankton biomass"</span></span>
<span id="cb48-776"><a href="#cb48-776" aria-hidden="true" tabindex="-1"></a><span class="in">measurementTypeID: [P01 code for biomass]</span></span>
<span id="cb48-777"><a href="#cb48-777" aria-hidden="true" tabindex="-1"></a><span class="in">measurementValue: net.smallplankton / net.totalplankton</span></span>
<span id="cb48-778"><a href="#cb48-778" aria-hidden="true" tabindex="-1"></a><span class="in">measurementUnit: "grams"</span></span>
<span id="cb48-779"><a href="#cb48-779" aria-hidden="true" tabindex="-1"></a><span class="in">measurementUnitID: http://vocab.nerc.ac.uk/collection/P06/current/UGRM/</span></span>
<span id="cb48-780"><a href="#cb48-780" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-781"><a href="#cb48-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-782"><a href="#cb48-782" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Stage-Specific Abundance** (link to occurrenceID)</span>
<span id="cb48-783"><a href="#cb48-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-784"><a href="#cb48-784" aria-hidden="true" tabindex="-1"></a>**Egg stages**:</span>
<span id="cb48-785"><a href="#cb48-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-786"><a href="#cb48-786" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-787"><a href="#cb48-787" aria-hidden="true" tabindex="-1"></a><span class="in">eventID: [blank/NA]</span></span>
<span id="cb48-788"><a href="#cb48-788" aria-hidden="true" tabindex="-1"></a><span class="in">occurrenceID: egg occurrence UUID</span></span>
<span id="cb48-789"><a href="#cb48-789" aria-hidden="true" tabindex="-1"></a><span class="in">measurementID: UUID</span></span>
<span id="cb48-790"><a href="#cb48-790" aria-hidden="true" tabindex="-1"></a><span class="in">measurementType: "abundance by life stage"</span></span>
<span id="cb48-791"><a href="#cb48-791" aria-hidden="true" tabindex="-1"></a><span class="in">measurementTypeID: [P01 code - search for "abundance" + "development stage"]</span></span>
<span id="cb48-792"><a href="#cb48-792" aria-hidden="true" tabindex="-1"></a><span class="in">measurementValue: egg_stage.tally</span></span>
<span id="cb48-793"><a href="#cb48-793" aria-hidden="true" tabindex="-1"></a><span class="in">measurementValueID: [custom vocabulary URI - see below]</span></span>
<span id="cb48-794"><a href="#cb48-794" aria-hidden="true" tabindex="-1"></a><span class="in">measurementUnit: "individuals"</span></span>
<span id="cb48-795"><a href="#cb48-795" aria-hidden="true" tabindex="-1"></a><span class="in">measurementUnitID: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/</span></span>
<span id="cb48-796"><a href="#cb48-796" aria-hidden="true" tabindex="-1"></a><span class="in">measurementRemarks: "egg, stage {N} of 11 (Moser &amp; Ahlstrom, 1985)"</span></span>
<span id="cb48-797"><a href="#cb48-797" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-798"><a href="#cb48-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-799"><a href="#cb48-799" aria-hidden="true" tabindex="-1"></a>**Larva stages**:</span>
<span id="cb48-800"><a href="#cb48-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-801"><a href="#cb48-801" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-802"><a href="#cb48-802" aria-hidden="true" tabindex="-1"></a><span class="in">eventID: [blank/NA]</span></span>
<span id="cb48-803"><a href="#cb48-803" aria-hidden="true" tabindex="-1"></a><span class="in">occurrenceID: larva occurrence UUID</span></span>
<span id="cb48-804"><a href="#cb48-804" aria-hidden="true" tabindex="-1"></a><span class="in">measurementID: UUID</span></span>
<span id="cb48-805"><a href="#cb48-805" aria-hidden="true" tabindex="-1"></a><span class="in">measurementType: "abundance by life stage"</span></span>
<span id="cb48-806"><a href="#cb48-806" aria-hidden="true" tabindex="-1"></a><span class="in">measurementTypeID: [P01 code]</span></span>
<span id="cb48-807"><a href="#cb48-807" aria-hidden="true" tabindex="-1"></a><span class="in">measurementValue: larva_stage.tally</span></span>
<span id="cb48-808"><a href="#cb48-808" aria-hidden="true" tabindex="-1"></a><span class="in">measurementValueID: [custom vocabulary URI]</span></span>
<span id="cb48-809"><a href="#cb48-809" aria-hidden="true" tabindex="-1"></a><span class="in">measurementUnit: "individuals"</span></span>
<span id="cb48-810"><a href="#cb48-810" aria-hidden="true" tabindex="-1"></a><span class="in">measurementUnitID: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/</span></span>
<span id="cb48-811"><a href="#cb48-811" aria-hidden="true" tabindex="-1"></a><span class="in">measurementRemarks: Life stage mapping (see Part 5)</span></span>
<span id="cb48-812"><a href="#cb48-812" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-813"><a href="#cb48-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-814"><a href="#cb48-814" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Body Length Measurements** (link to occurrenceID)</span>
<span id="cb48-815"><a href="#cb48-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-816"><a href="#cb48-816" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-817"><a href="#cb48-817" aria-hidden="true" tabindex="-1"></a><span class="in">eventID: [blank/NA]</span></span>
<span id="cb48-818"><a href="#cb48-818" aria-hidden="true" tabindex="-1"></a><span class="in">occurrenceID: larva occurrence UUID</span></span>
<span id="cb48-819"><a href="#cb48-819" aria-hidden="true" tabindex="-1"></a><span class="in">measurementID: UUID</span></span>
<span id="cb48-820"><a href="#cb48-820" aria-hidden="true" tabindex="-1"></a><span class="in">measurementType: "body length"</span></span>
<span id="cb48-821"><a href="#cb48-821" aria-hidden="true" tabindex="-1"></a><span class="in">measurementTypeID: [P01 code for fish larvae length - e.g., OBSINDLX or similar]</span></span>
<span id="cb48-822"><a href="#cb48-822" aria-hidden="true" tabindex="-1"></a><span class="in">measurementValue: larva_size.length_mm</span></span>
<span id="cb48-823"><a href="#cb48-823" aria-hidden="true" tabindex="-1"></a><span class="in">measurementUnit: "millimeters"</span></span>
<span id="cb48-824"><a href="#cb48-824" aria-hidden="true" tabindex="-1"></a><span class="in">measurementUnitID: http://vocab.nerc.ac.uk/collection/P06/current/UXMM/</span></span>
<span id="cb48-825"><a href="#cb48-825" aria-hidden="true" tabindex="-1"></a><span class="in">measurementMethod: "https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span></span>
<span id="cb48-826"><a href="#cb48-826" aria-hidden="true" tabindex="-1"></a><span class="in">measurementRemarks: "Count: {larva_size.tally}; Total length measurement"</span></span>
<span id="cb48-827"><a href="#cb48-827" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-828"><a href="#cb48-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-829"><a href="#cb48-829" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 5: Life Stage Vocabulary Mapping</span></span>
<span id="cb48-830"><a href="#cb48-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-831"><a href="#cb48-831" aria-hidden="true" tabindex="-1"></a>Custom terms based on S11 vocabulary:</span>
<span id="cb48-832"><a href="#cb48-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-833"><a href="#cb48-833" aria-hidden="true" tabindex="-1"></a>**Egg Stages (egg_stage.stage values 1-15)**:</span>
<span id="cb48-834"><a href="#cb48-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-835"><a href="#cb48-835" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Stage 1: "egg, stage 1 of 11 (Moser &amp; Ahlstrom, 1985)"</span>
<span id="cb48-836"><a href="#cb48-836" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Stage 2: "egg, stage 2 of 11 (Moser &amp; Ahlstrom, 1985)"</span>
<span id="cb48-837"><a href="#cb48-837" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>...</span>
<span id="cb48-838"><a href="#cb48-838" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Stage 11: "egg, stage 11 of 11 (Moser &amp; Ahlstrom, 1985)"</span>
<span id="cb48-839"><a href="#cb48-839" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Stage 12-15: "egg, stage {N} of 12 (Moser &amp; Ahlstrom, 1985)" <span class="co">[</span><span class="ot">pending revision</span><span class="co">]</span></span>
<span id="cb48-840"><a href="#cb48-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-841"><a href="#cb48-841" aria-hidden="true" tabindex="-1"></a>Base vocabulary: S11/S1110 (egg)</span>
<span id="cb48-842"><a href="#cb48-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-843"><a href="#cb48-843" aria-hidden="true" tabindex="-1"></a>**Larva Stages** (larva_stage.stage values):</span>
<span id="cb48-844"><a href="#cb48-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-845"><a href="#cb48-845" aria-hidden="true" tabindex="-1"></a>stage | measurementRemarks | Custom term</span>
<span id="cb48-846"><a href="#cb48-846" aria-hidden="true" tabindex="-1"></a>------|--------------------|------------</span>
<span id="cb48-847"><a href="#cb48-847" aria-hidden="true" tabindex="-1"></a>YOLK    | larva, yolk sac   | Yolk-sac larva</span>
<span id="cb48-848"><a href="#cb48-848" aria-hidden="true" tabindex="-1"></a>PREF    | larva, preflexion | Preflexion larva</span>
<span id="cb48-849"><a href="#cb48-849" aria-hidden="true" tabindex="-1"></a>FLEX    | larva, flexion    | Flexion larva</span>
<span id="cb48-850"><a href="#cb48-850" aria-hidden="true" tabindex="-1"></a>POST    | larva, postflexion    | Postflexion larva</span>
<span id="cb48-851"><a href="#cb48-851" aria-hidden="true" tabindex="-1"></a>TRNS    | larva, transformation | Transformation stage larva</span>
<span id="cb48-852"><a href="#cb48-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-853"><a href="#cb48-853" aria-hidden="true" tabindex="-1"></a>**Base vocabulary**: S11/S1133 (larva)</span>
<span id="cb48-854"><a href="#cb48-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-855"><a href="#cb48-855" aria-hidden="true" tabindex="-1"></a>**Implementation**: Create lookup table mapping stage codes to full descriptive terms.</span>
<span id="cb48-856"><a href="#cb48-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-857"><a href="#cb48-857" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 6: Required P01 Code Research</span></span>
<span id="cb48-858"><a href="#cb48-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-859"><a href="#cb48-859" aria-hidden="true" tabindex="-1"></a>To complete before implementation, search P01 vocabulary for:</span>
<span id="cb48-860"><a href="#cb48-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-861"><a href="#cb48-861" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Proportion sorted:</span>
<span id="cb48-862"><a href="#cb48-862" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Search terms: "subsample", "fraction sorted", "aliquot"</span>
<span id="cb48-863"><a href="#cb48-863" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Alternative: Create custom term if no exact match</span>
<span id="cb48-864"><a href="#cb48-864" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Standard haul factor:</span>
<span id="cb48-865"><a href="#cb48-865" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Search terms: "standardization", "catch per unit effort", "sampling effort coefficient"</span>
<span id="cb48-866"><a href="#cb48-866" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Possibly related to CPUE codes</span>
<span id="cb48-867"><a href="#cb48-867" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Abundance by life stage:</span>
<span id="cb48-868"><a href="#cb48-868" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Search terms: "abundance", "count", "life stage", "development stage"</span>
<span id="cb48-869"><a href="#cb48-869" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>May need fish-specific or zooplankton codes</span>
<span id="cb48-870"><a href="#cb48-870" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Body length:</span>
<span id="cb48-871"><a href="#cb48-871" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Search terms: "body length", "total length", "fish larvae", "Actinopterygii"</span>
<span id="cb48-872"><a href="#cb48-872" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Example code: OBSINDLX (commonly used for fish length)</span>
<span id="cb48-873"><a href="#cb48-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-874"><a href="#cb48-874" aria-hidden="true" tabindex="-1"></a>**P01 Search Tool**: https://vocab.seadatanet.org/p01-facet-search</span>
<span id="cb48-875"><a href="#cb48-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-876"><a href="#cb48-876" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 7: Implementation Changes in publish_larvae_to_obis.qmd</span></span>
<span id="cb48-877"><a href="#cb48-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-878"><a href="#cb48-878" aria-hidden="true" tabindex="-1"></a>Major code modifications:</span>
<span id="cb48-879"><a href="#cb48-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-880"><a href="#cb48-880" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Event Core: Add sampleSizeValue and sampleSizeUnit columns</span>
<span id="cb48-881"><a href="#cb48-881" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Occurrence Extension:</span>
<span id="cb48-882"><a href="#cb48-882" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Aggregate by (net_uuid, species_id, major life stage)</span>
<span id="cb48-883"><a href="#cb48-883" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Reduce from 5 source tables to 2 occurrence types</span>
<span id="cb48-884"><a href="#cb48-884" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Add lifeStageID field</span>
<span id="cb48-885"><a href="#cb48-885" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>eMoF Extension:</span>
<span id="cb48-886"><a href="#cb48-886" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Rename file to extendedMeasurementOrFact.csv</span>
<span id="cb48-887"><a href="#cb48-887" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Remove vol_sampled_m3 (moved to Event)</span>
<span id="cb48-888"><a href="#cb48-888" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Add prop_sorted and std_haul_factor as event-level measurements</span>
<span id="cb48-889"><a href="#cb48-889" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Expand to include stage-specific abundances (egg_stage, larva_stage)</span>
<span id="cb48-890"><a href="#cb48-890" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Include all larva_size measurements</span>
<span id="cb48-891"><a href="#cb48-891" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Add all vocabulary ID fields: measurementTypeID, measurementValueID, measurementUnitID</span>
<span id="cb48-892"><a href="#cb48-892" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>meta.xml:</span>
<span id="cb48-893"><a href="#cb48-893" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Update eMoF rowType URI</span>
<span id="cb48-894"><a href="#cb48-894" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Remove duplicate eventID field definition</span>
<span id="cb48-895"><a href="#cb48-895" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Add sampleSizeValue/Unit to Event core mapping</span>
<span id="cb48-896"><a href="#cb48-896" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Add vocabulary ID fields to eMoF mapping</span>
<span id="cb48-897"><a href="#cb48-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-898"><a href="#cb48-898" aria-hidden="true" tabindex="-1"></a><span class="fu">### Part 8: Expected Data Structure Changes</span></span>
<span id="cb48-899"><a href="#cb48-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-900"><a href="#cb48-900" aria-hidden="true" tabindex="-1"></a>Current structure:</span>
<span id="cb48-901"><a href="#cb48-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-902"><a href="#cb48-902" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Occurrences: ~867k records (5 types per species/net)</span>
<span id="cb48-903"><a href="#cb48-903" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>eMoF: ~19k records (mostly environmental)</span>
<span id="cb48-904"><a href="#cb48-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-905"><a href="#cb48-905" aria-hidden="true" tabindex="-1"></a>New structure:</span>
<span id="cb48-906"><a href="#cb48-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-907"><a href="#cb48-907" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Occurrences: ~491k records (2 types per species/net)</span>
<span id="cb48-908"><a href="#cb48-908" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>eMoF: ~395k records (environmental + stage counts + sizes)</span>
<span id="cb48-909"><a href="#cb48-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-910"><a href="#cb48-910" aria-hidden="true" tabindex="-1"></a>**Benefits**:</span>
<span id="cb48-911"><a href="#cb48-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-912"><a href="#cb48-912" aria-hidden="true" tabindex="-1"></a>✓ OBIS-compliant eMoF format </span>
<span id="cb48-913"><a href="#cb48-913" aria-hidden="true" tabindex="-1"></a>✓ Fixes GBIF IPT validation error</span>
<span id="cb48-914"><a href="#cb48-914" aria-hidden="true" tabindex="-1"></a>✓ Uses standardized vocabularies (S11, P01, P06) </span>
<span id="cb48-915"><a href="#cb48-915" aria-hidden="true" tabindex="-1"></a>✓ Preserves all data granularity</span>
<span id="cb48-916"><a href="#cb48-916" aria-hidden="true" tabindex="-1"></a>✓ Clearer semantic separation (taxonomy vs. measurements)</span>
<span id="cb48-917"><a href="#cb48-917" aria-hidden="true" tabindex="-1"></a>✓ More queryable for biological analyses ✓ Follows best practices for sampling-event datasets</span>
<span id="cb48-918"><a href="#cb48-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-919"><a href="#cb48-919" aria-hidden="true" tabindex="-1"></a>Perfect! I've completed all the implementation tasks for merging the egg and larva data into a proper OBIS-compliant DarwinCore archive. Here's a summary of all the changes made:</span>
<span id="cb48-920"><a href="#cb48-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-921"><a href="#cb48-921" aria-hidden="true" tabindex="-1"></a><span class="fu">### Summary of Changes to publish_larvae_to_obis.qmd</span></span>
<span id="cb48-922"><a href="#cb48-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-923"><a href="#cb48-923" aria-hidden="true" tabindex="-1"></a>✅ Completed Implementation</span>
<span id="cb48-924"><a href="#cb48-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-925"><a href="#cb48-925" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Event Core Updates** _(lines 1082-1085)_</span>
<span id="cb48-926"><a href="#cb48-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-927"><a href="#cb48-927" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Changed <span class="in">`sampleSizeUnit`</span> from "cubic meters" to "m^3" per OBIS standards</span>
<span id="cb48-928"><a href="#cb48-928" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`vol_sampled_m3`</span> now populates <span class="in">`sampleSizeValue`</span> in Event core (removed from eMoF)</span>
<span id="cb48-929"><a href="#cb48-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-930"><a href="#cb48-930" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Life Stage Vocabulary Lookup Tables** _(lines 948-1001 - NEW SECTION)_</span>
<span id="cb48-931"><a href="#cb48-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-932"><a href="#cb48-932" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Created egg_stage_vocab: Maps stages 1-15 to descriptive terms following Moser &amp; Ahlstrom (1985)</span>
<span id="cb48-933"><a href="#cb48-933" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Created larva_stage_vocab: Maps YOLK, PREF, FLEX, POST, TRNS to descriptive terms</span>
<span id="cb48-934"><a href="#cb48-934" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Created measurement_unit_vocab: Maps units to P06 vocabulary URIs</span>
<span id="cb48-935"><a href="#cb48-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-936"><a href="#cb48-936" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Consolidated Occurrence Records** _(lines 1129-1188)_</span>
<span id="cb48-937"><a href="#cb48-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-938"><a href="#cb48-938" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**BEFORE**: 5 separate occurrence types (egg, egg_stage, larva, larva_stage, larva_size)</span>
<span id="cb48-939"><a href="#cb48-939" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**AFTER**: 2 occurrence types per species per net (egg, larva)</span>
<span id="cb48-940"><a href="#cb48-940" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Added <span class="in">`lifeStageID`</span> field with S11 vocabulary URIs:</span>
<span id="cb48-941"><a href="#cb48-941" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Egg: http://vocab.nerc.ac.uk/collection/S11/current/S1110/</span>
<span id="cb48-942"><a href="#cb48-942" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Larva: http://vocab.nerc.ac.uk/collection/S11/current/S1133/</span>
<span id="cb48-943"><a href="#cb48-943" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Uses total counts from <span class="in">`egg.tally`</span> and <span class="in">`larva.tally`</span> for <span class="in">`organismQuantity`</span></span>
<span id="cb48-944"><a href="#cb48-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-945"><a href="#cb48-945" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Completely Rewritten ExtendedMeasurementOrFact Extension** _(lines 1245-1371)_</span>
<span id="cb48-946"><a href="#cb48-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-947"><a href="#cb48-947" aria-hidden="true" tabindex="-1"></a>Created three measurement categories: </span>
<span id="cb48-948"><a href="#cb48-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-949"><a href="#cb48-949" aria-hidden="true" tabindex="-1"></a>**A. Sample-level measurements** (linked to eventID):</span>
<span id="cb48-950"><a href="#cb48-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-951"><a href="#cb48-951" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>std_haul_factor: Standardization factor</span>
<span id="cb48-952"><a href="#cb48-952" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>prop_sorted: Proportion of sample examined</span>
<span id="cb48-953"><a href="#cb48-953" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>smallplankton &amp; totalplankton: Biomass measurements</span>
<span id="cb48-954"><a href="#cb48-954" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Includes measurementTypeID and measurementUnitID fields (with TODOs for P01 codes)</span>
<span id="cb48-955"><a href="#cb48-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-956"><a href="#cb48-956" aria-hidden="true" tabindex="-1"></a>**B. Stage-specific abundance** (linked to occurrenceID):</span>
<span id="cb48-957"><a href="#cb48-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-958"><a href="#cb48-958" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Egg stage abundances from egg_stage table</span>
<span id="cb48-959"><a href="#cb48-959" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Larva stage abundances from larva_stage table</span>
<span id="cb48-960"><a href="#cb48-960" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Uses descriptive stage terms in measurementRemarks</span>
<span id="cb48-961"><a href="#cb48-961" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Includes measurementValueID for vocabulary references</span>
<span id="cb48-962"><a href="#cb48-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-963"><a href="#cb48-963" aria-hidden="true" tabindex="-1"></a>**C. Body length measurements** (linked to occurrenceID):</span>
<span id="cb48-964"><a href="#cb48-964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-965"><a href="#cb48-965" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>From larva_size table</span>
<span id="cb48-966"><a href="#cb48-966" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Includes tally count in measurementRemarks</span>
<span id="cb48-967"><a href="#cb48-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-968"><a href="#cb48-968" aria-hidden="true" tabindex="-1"></a>**5. File Naming Updates**</span>
<span id="cb48-969"><a href="#cb48-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-970"><a href="#cb48-970" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Output file renamed: measurementorfact.csv → extendedMeasurementOrFact.csv (line 1384)</span>
<span id="cb48-971"><a href="#cb48-971" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Updated zip file creation (line 1702)</span>
<span id="cb48-972"><a href="#cb48-972" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Updated data quality checks (line 1677)</span>
<span id="cb48-973"><a href="#cb48-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-974"><a href="#cb48-974" aria-hidden="true" tabindex="-1"></a>**6. Meta.xml Generation Updates** _(lines 1393-1545)_</span>
<span id="cb48-975"><a href="#cb48-975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-976"><a href="#cb48-976" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Updated rowType URI to: http://rs.gbif.org/terms/1.0/ExtendedMeasurementOrFact _(line 1437)_</span>
<span id="cb48-977"><a href="#cb48-977" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Added vocabulary ID field mappings:</span>
<span id="cb48-978"><a href="#cb48-978" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>measurementTypeID, measurementValueID, measurementUnitID</span>
<span id="cb48-979"><a href="#cb48-979" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>lifeStageID</span>
<span id="cb48-980"><a href="#cb48-980" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Fixed GBIF IPT error**: Modified create_field_elements() to skip coreid column (prevents duplicate eventID field definition)</span>
<span id="cb48-981"><a href="#cb48-981" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Updated all filename references from measurementorfact to extendedMeasurementOrFact</span>
<span id="cb48-982"><a href="#cb48-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-983"><a href="#cb48-983" aria-hidden="true" tabindex="-1"></a>**📊 Expected Outcome**</span>
<span id="cb48-984"><a href="#cb48-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-985"><a href="#cb48-985" aria-hidden="true" tabindex="-1"></a>**Current structure** (before):</span>
<span id="cb48-986"><a href="#cb48-986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-987"><a href="#cb48-987" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Occurrences: ~867k records (5 types per species/net)</span>
<span id="cb48-988"><a href="#cb48-988" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>eMoF: ~19k records (mostly environmental)</span>
<span id="cb48-989"><a href="#cb48-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-990"><a href="#cb48-990" aria-hidden="true" tabindex="-1"></a>**New structure** (after):</span>
<span id="cb48-991"><a href="#cb48-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-992"><a href="#cb48-992" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Occurrences: ~491k records (2 types per species/net) - **~43% reduction**</span>
<span id="cb48-993"><a href="#cb48-993" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>eMoF: ~395k records (environmental + stage counts + sizes) - **~20x increase**</span>
<span id="cb48-994"><a href="#cb48-994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-995"><a href="#cb48-995" aria-hidden="true" tabindex="-1"></a>**✨ Benefits**</span>
<span id="cb48-996"><a href="#cb48-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-997"><a href="#cb48-997" aria-hidden="true" tabindex="-1"></a>✅ OBIS-compliant ExtendedMeasurementOrFact format</span>
<span id="cb48-998"><a href="#cb48-998" aria-hidden="true" tabindex="-1"></a>✅ Fixes GBIF IPT validation error ("eventID unknown to extension")</span>
<span id="cb48-999"><a href="#cb48-999" aria-hidden="true" tabindex="-1"></a>✅ Uses standardized vocabularies (S11, P06)</span>
<span id="cb48-1000"><a href="#cb48-1000" aria-hidden="true" tabindex="-1"></a>✅ P01 codes ready to be added (TODOs marked in code)</span>
<span id="cb48-1001"><a href="#cb48-1001" aria-hidden="true" tabindex="-1"></a>✅ Preserves all granular data (stages, sizes) through eMoF</span>
<span id="cb48-1002"><a href="#cb48-1002" aria-hidden="true" tabindex="-1"></a>✅ Cleaner semantic separation (taxonomy vs. measurements)</span>
<span id="cb48-1003"><a href="#cb48-1003" aria-hidden="true" tabindex="-1"></a>✅ More queryable and comparable data structure</span>
<span id="cb48-1004"><a href="#cb48-1004" aria-hidden="true" tabindex="-1"></a>✅ Follows best practices for sampling-event datasets</span>
<span id="cb48-1005"><a href="#cb48-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1006"><a href="#cb48-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1007"><a href="#cb48-1007" aria-hidden="true" tabindex="-1"></a>**📝 Remaining TODOs in Code**</span>
<span id="cb48-1008"><a href="#cb48-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1009"><a href="#cb48-1009" aria-hidden="true" tabindex="-1"></a>The following P01 vocabulary codes need to be researched and added:</span>
<span id="cb48-1010"><a href="#cb48-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1011"><a href="#cb48-1011" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Standard haul factor</span>
<span id="cb48-1012"><a href="#cb48-1012" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Proportion sorted / subsample fraction</span>
<span id="cb48-1013"><a href="#cb48-1013" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Zooplankton biomass</span>
<span id="cb48-1014"><a href="#cb48-1014" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Abundance by life stage / development stage</span>
<span id="cb48-1015"><a href="#cb48-1015" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Fish larvae body length</span>
<span id="cb48-1016"><a href="#cb48-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1017"><a href="#cb48-1017" aria-hidden="true" tabindex="-1"></a>**P01 Search Tool**: https://vocab.seadatanet.org/p01-facet-search All changes are complete and ready for testing! The code should now generate a fully OBIS-compliant DarwinCore archive with proper ExtendedMeasurementOrFact extension.</span>
<span id="cb48-1018"><a href="#cb48-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1019"><a href="#cb48-1019" aria-hidden="true" tabindex="-1"></a><span class="fu">## Prompt Claude to Generate DarwinCore</span></span>
<span id="cb48-1020"><a href="#cb48-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1021"><a href="#cb48-1021" aria-hidden="true" tabindex="-1"></a>PROMPT: Using the ERD above, create a Quarto document with chunks of R code and tidyverse style use of the database connection object <span class="in">`con`</span> to generate a DarwinCore package using the <span class="in">`species.worms_id`</span> (aka WoRMS AphiaID) to populate the species identifiers. Combine biological observation where possible, otherwise compose as seperate datasets, given the different biological observations: egg, eggstage, larva, larvasize, larvastage. Generate DarwinCore with as much of the extended information (i.e.,  <span class="in">`event`</span>, <span class="in">`occurrence`</span>, and <span class="in">`measurementOrFact`</span> ) as possible.</span>
<span id="cb48-1022"><a href="#cb48-1022" aria-hidden="true" tabindex="-1"></a>Compose Ecological Metadata Language (EML) metadata for the DarwinCore package, including the <span class="in">`dataset`</span> and <span class="in">`creator`</span> elements. Include prompts where more</span>
<span id="cb48-1023"><a href="#cb48-1023" aria-hidden="true" tabindex="-1"></a>information is needed.</span>
<span id="cb48-1024"><a href="#cb48-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1027"><a href="#cb48-1027" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-1028"><a href="#cb48-1028" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: stop_eval</span></span>
<span id="cb48-1029"><a href="#cb48-1029" aria-hidden="true" tabindex="-1"></a><span class="co"># knitr::opts_chunk$set(eval = F)</span></span>
<span id="cb48-1030"><a href="#cb48-1030" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-1031"><a href="#cb48-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1032"><a href="#cb48-1032" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Extraction from Database</span></span>
<span id="cb48-1033"><a href="#cb48-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1034"><a href="#cb48-1034" aria-hidden="true" tabindex="-1"></a>First, let's extract all necessary tables from the database:</span>
<span id="cb48-1035"><a href="#cb48-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1038"><a href="#cb48-1038" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-1039"><a href="#cb48-1039" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: extract-tables</span></span>
<span id="cb48-1040"><a href="#cb48-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1041"><a href="#cb48-1041" aria-hidden="true" tabindex="-1"></a><span class="co"># Get simple lazy table references</span></span>
<span id="cb48-1042"><a href="#cb48-1042" aria-hidden="true" tabindex="-1"></a>tbl_ship        <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"ship"</span>)</span>
<span id="cb48-1043"><a href="#cb48-1043" aria-hidden="true" tabindex="-1"></a>tbl_cruise      <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"cruise"</span>)</span>
<span id="cb48-1044"><a href="#cb48-1044" aria-hidden="true" tabindex="-1"></a>tbl_site        <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"site"</span>)</span>
<span id="cb48-1045"><a href="#cb48-1045" aria-hidden="true" tabindex="-1"></a>tbl_tow         <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"tow"</span>)</span>
<span id="cb48-1046"><a href="#cb48-1046" aria-hidden="true" tabindex="-1"></a>tbl_tow_type    <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"tow_type"</span>)</span>
<span id="cb48-1047"><a href="#cb48-1047" aria-hidden="true" tabindex="-1"></a>tbl_net         <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"net"</span>)</span>
<span id="cb48-1048"><a href="#cb48-1048" aria-hidden="true" tabindex="-1"></a>tbl_species     <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"species"</span>)</span>
<span id="cb48-1049"><a href="#cb48-1049" aria-hidden="true" tabindex="-1"></a><span class="co"># biological observation tables</span></span>
<span id="cb48-1050"><a href="#cb48-1050" aria-hidden="true" tabindex="-1"></a>tbl_egg         <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"egg"</span>)</span>
<span id="cb48-1051"><a href="#cb48-1051" aria-hidden="true" tabindex="-1"></a>tbl_egg_stage   <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"egg_stage"</span>)</span>
<span id="cb48-1052"><a href="#cb48-1052" aria-hidden="true" tabindex="-1"></a>tbl_larva       <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"larva"</span>)</span>
<span id="cb48-1053"><a href="#cb48-1053" aria-hidden="true" tabindex="-1"></a>tbl_larva_stage <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"larva_stage"</span>)</span>
<span id="cb48-1054"><a href="#cb48-1054" aria-hidden="true" tabindex="-1"></a>tbl_larva_size  <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"larva_size"</span>)</span>
<span id="cb48-1055"><a href="#cb48-1055" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-1056"><a href="#cb48-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1057"><a href="#cb48-1057" aria-hidden="true" tabindex="-1"></a><span class="fu">## Create Life Stage Vocabulary Lookup Tables</span></span>
<span id="cb48-1058"><a href="#cb48-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1059"><a href="#cb48-1059" aria-hidden="true" tabindex="-1"></a>Define mappings for egg and larva developmental stages to descriptive terms:</span>
<span id="cb48-1060"><a href="#cb48-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1063"><a href="#cb48-1063" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-1064"><a href="#cb48-1064" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: vocabulary-lookups</span></span>
<span id="cb48-1065"><a href="#cb48-1065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1066"><a href="#cb48-1066" aria-hidden="true" tabindex="-1"></a><span class="co"># Egg stage vocabulary mapping (Moser &amp; Ahlstrom, 1985)</span></span>
<span id="cb48-1067"><a href="#cb48-1067" aria-hidden="true" tabindex="-1"></a>egg_stage_vocab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb48-1068"><a href="#cb48-1068" aria-hidden="true" tabindex="-1"></a>  <span class="at">stage =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>,</span>
<span id="cb48-1069"><a href="#cb48-1069" aria-hidden="true" tabindex="-1"></a>  <span class="at">stage_description =</span> <span class="fu">c</span>(</span>
<span id="cb48-1070"><a href="#cb48-1070" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 1 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb48-1071"><a href="#cb48-1071" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 2 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb48-1072"><a href="#cb48-1072" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 3 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb48-1073"><a href="#cb48-1073" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 4 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb48-1074"><a href="#cb48-1074" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 5 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb48-1075"><a href="#cb48-1075" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 6 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb48-1076"><a href="#cb48-1076" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 7 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb48-1077"><a href="#cb48-1077" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 8 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb48-1078"><a href="#cb48-1078" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 9 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb48-1079"><a href="#cb48-1079" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 10 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb48-1080"><a href="#cb48-1080" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 11 of 11 (Moser &amp; Ahlstrom, 1985)"</span>,</span>
<span id="cb48-1081"><a href="#cb48-1081" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 12 of 12 (Moser &amp; Ahlstrom, 1985)"</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: needs revision</span></span>
<span id="cb48-1082"><a href="#cb48-1082" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 13 of 12 (Moser &amp; Ahlstrom, 1985)"</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: needs revision</span></span>
<span id="cb48-1083"><a href="#cb48-1083" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 14 of 12 (Moser &amp; Ahlstrom, 1985)"</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: needs revision</span></span>
<span id="cb48-1084"><a href="#cb48-1084" aria-hidden="true" tabindex="-1"></a>    <span class="st">"egg, stage 15 of 12 (Moser &amp; Ahlstrom, 1985)"</span>  <span class="co"># </span><span class="al">TODO</span><span class="co">: needs revision</span></span>
<span id="cb48-1085"><a href="#cb48-1085" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb48-1086"><a href="#cb48-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1087"><a href="#cb48-1087" aria-hidden="true" tabindex="-1"></a><span class="co"># Larva stage vocabulary mapping</span></span>
<span id="cb48-1088"><a href="#cb48-1088" aria-hidden="true" tabindex="-1"></a>larva_stage_vocab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb48-1089"><a href="#cb48-1089" aria-hidden="true" tabindex="-1"></a>  <span class="at">stage =</span> <span class="fu">c</span>(<span class="st">"YOLK"</span>, <span class="st">"PREF"</span>, <span class="st">"FLEX"</span>, <span class="st">"POST"</span>, <span class="st">"TRNS"</span>),</span>
<span id="cb48-1090"><a href="#cb48-1090" aria-hidden="true" tabindex="-1"></a>  <span class="at">stage_description =</span> <span class="fu">c</span>(</span>
<span id="cb48-1091"><a href="#cb48-1091" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, yolk sac"</span>,</span>
<span id="cb48-1092"><a href="#cb48-1092" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, preflexion"</span>,</span>
<span id="cb48-1093"><a href="#cb48-1093" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, flexion"</span>,</span>
<span id="cb48-1094"><a href="#cb48-1094" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, postflexion"</span>,</span>
<span id="cb48-1095"><a href="#cb48-1095" aria-hidden="true" tabindex="-1"></a>    <span class="st">"larva, transformation"</span></span>
<span id="cb48-1096"><a href="#cb48-1096" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb48-1097"><a href="#cb48-1097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1098"><a href="#cb48-1098" aria-hidden="true" tabindex="-1"></a><span class="co"># P06 Measurement Unit vocabulary (NERC)</span></span>
<span id="cb48-1099"><a href="#cb48-1099" aria-hidden="true" tabindex="-1"></a>measurement_unit_vocab <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb48-1100"><a href="#cb48-1100" aria-hidden="true" tabindex="-1"></a>  <span class="at">measurementUnit =</span> <span class="fu">c</span>(</span>
<span id="cb48-1101"><a href="#cb48-1101" aria-hidden="true" tabindex="-1"></a>    <span class="st">"individuals"</span>, <span class="st">"millimeters"</span>, <span class="st">"dimensionless"</span>, <span class="st">"cubic meters"</span>,</span>
<span id="cb48-1102"><a href="#cb48-1102" aria-hidden="true" tabindex="-1"></a>    <span class="st">"grams"</span>, <span class="st">"proportion"</span>, <span class="st">"m^3"</span>),</span>
<span id="cb48-1103"><a href="#cb48-1103" aria-hidden="true" tabindex="-1"></a>  <span class="at">measurementUnitID =</span> <span class="fu">c</span>(</span>
<span id="cb48-1104"><a href="#cb48-1104" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,</span>
<span id="cb48-1105"><a href="#cb48-1105" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UXMM/"</span>,</span>
<span id="cb48-1106"><a href="#cb48-1106" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,</span>
<span id="cb48-1107"><a href="#cb48-1107" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/MCUB/"</span>,</span>
<span id="cb48-1108"><a href="#cb48-1108" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UGRM/"</span>,</span>
<span id="cb48-1109"><a href="#cb48-1109" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,  <span class="co"># or UPCT?</span></span>
<span id="cb48-1110"><a href="#cb48-1110" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/MCUB/"</span></span>
<span id="cb48-1111"><a href="#cb48-1111" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb48-1112"><a href="#cb48-1112" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-1113"><a href="#cb48-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1114"><a href="#cb48-1114" aria-hidden="true" tabindex="-1"></a><span class="fu">## Create Event Hierarchy</span></span>
<span id="cb48-1115"><a href="#cb48-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1116"><a href="#cb48-1116" aria-hidden="true" tabindex="-1"></a>DarwinCore uses an event-based model. We'll create a hierarchical event structure:</span>
<span id="cb48-1117"><a href="#cb48-1117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1118"><a href="#cb48-1118" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>cruise</span>
<span id="cb48-1119"><a href="#cb48-1119" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>site</span>
<span id="cb48-1120"><a href="#cb48-1120" aria-hidden="true" tabindex="-1"></a><span class="ss">    - </span>tow</span>
<span id="cb48-1121"><a href="#cb48-1121" aria-hidden="true" tabindex="-1"></a><span class="ss">      - </span>net</span>
<span id="cb48-1122"><a href="#cb48-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1125"><a href="#cb48-1125" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb48-1126"><a href="#cb48-1126" aria-hidden="true" tabindex="-1"></a>%%| label: fig-larvae_event_hierarchy</span>
<span id="cb48-1127"><a href="#cb48-1127" aria-hidden="true" tabindex="-1"></a>%%| fig-cap: <span class="ot">"</span><span class="st">Event hierarchy for CalCOFI larvae data in DarwinCore Archive format with Extended Measurement or Fact.</span><span class="ot">"</span></span>
<span id="cb48-1128"><a href="#cb48-1128" aria-hidden="true" tabindex="-1"></a>%%| file: diagrams/larvae_event_hierarchy.mmd</span>
<span id="cb48-1129"><a href="#cb48-1129" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-1130"><a href="#cb48-1130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1131"><a href="#cb48-1131" aria-hidden="true" tabindex="-1"></a>Per <span class="co">[</span><span class="ot">3.3.2. Simple nested datasets with Project-level information – Guide for publishing biological survey and monitoring data to GBIF</span><span class="co">](https://docs.gbif.org/guide-publishing-survey-data/en/#simple-nested-datasets-with-project-level-information)</span></span>
<span id="cb48-1132"><a href="#cb48-1132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1135"><a href="#cb48-1135" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-1136"><a href="#cb48-1136" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: build-event-hierarchy</span></span>
<span id="cb48-1137"><a href="#cb48-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1138"><a href="#cb48-1138" aria-hidden="true" tabindex="-1"></a><span class="co"># Build complete event hierarchy</span></span>
<span id="cb48-1139"><a href="#cb48-1139" aria-hidden="true" tabindex="-1"></a>q_events <span class="ot">&lt;-</span> tbl_net <span class="sc">|&gt;</span> </span>
<span id="cb48-1140"><a href="#cb48-1140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_tow,      <span class="at">by =</span> <span class="st">"tow_uuid"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-1141"><a href="#cb48-1141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_tow_type, <span class="at">by =</span> <span class="st">"tow_type_key"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-1142"><a href="#cb48-1142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_site,     <span class="at">by =</span> <span class="st">"site_uuid"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-1143"><a href="#cb48-1143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_cruise,   <span class="at">by =</span> <span class="st">"cruise_uuid"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-1144"><a href="#cb48-1144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_ship,     <span class="at">by =</span> <span class="st">"ship_key"</span>)</span>
<span id="cb48-1145"><a href="#cb48-1145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1146"><a href="#cb48-1146" aria-hidden="true" tabindex="-1"></a><span class="co"># Create event core at different levels ----</span></span>
<span id="cb48-1147"><a href="#cb48-1147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1148"><a href="#cb48-1148" aria-hidden="true" tabindex="-1"></a>flds_to_iso8601 <span class="ot">&lt;-</span>  <span class="cf">function</span>(flds, <span class="at">output =</span> <span class="st">"datetime"</span>) {</span>
<span id="cb48-1149"><a href="#cb48-1149" aria-hidden="true" tabindex="-1"></a>  <span class="co"># helper function to convert date/time fields to ISO 8601 format</span></span>
<span id="cb48-1150"><a href="#cb48-1150" aria-hidden="true" tabindex="-1"></a>  <span class="co"># per https://dwc.tdwg.org/terms/ eventDate: add 2007-03-01T13:00:00Z/2008-05-11T15:30:00Z (some time within the interval beginning 1 March 2007 at 1pm UTC and before 11 May 2008 at 3:30pm UTC)</span></span>
<span id="cb48-1151"><a href="#cb48-1151" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-1152"><a href="#cb48-1152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">length</span>(flds) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb48-1153"><a href="#cb48-1153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(output <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"datetime"</span>, <span class="st">"time"</span>))</span>
<span id="cb48-1154"><a href="#cb48-1154" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-1155"><a href="#cb48-1155" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(flds) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> output <span class="sc">==</span> <span class="st">"datetime"</span>)</span>
<span id="cb48-1156"><a href="#cb48-1156" aria-hidden="true" tabindex="-1"></a>      s <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb48-1157"><a href="#cb48-1157" aria-hidden="true" tabindex="-1"></a>        <span class="st">"to_char({flds}, 'YYYY-MM-DD</span><span class="sc">\"</span><span class="st">T</span><span class="sc">\"</span><span class="st">HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">')"</span>)</span>
<span id="cb48-1158"><a href="#cb48-1158" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(flds) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> output <span class="sc">==</span> <span class="st">"datetime"</span>)</span>
<span id="cb48-1159"><a href="#cb48-1159" aria-hidden="true" tabindex="-1"></a>      s <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb48-1160"><a href="#cb48-1160" aria-hidden="true" tabindex="-1"></a>        <span class="st">"to_char({flds[1]}, 'YYYY-MM-DD</span><span class="sc">\"</span><span class="st">T</span><span class="sc">\"</span><span class="st">HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">') || '/' || </span></span>
<span id="cb48-1161"><a href="#cb48-1161" aria-hidden="true" tabindex="-1"></a><span class="st">         to_char({flds[2]}, 'YYYY-MM-DD</span><span class="sc">\"</span><span class="st">T</span><span class="sc">\"</span><span class="st">HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">')"</span>)</span>
<span id="cb48-1162"><a href="#cb48-1162" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-1163"><a href="#cb48-1163" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(flds) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> output <span class="sc">==</span> <span class="st">"time"</span>)</span>
<span id="cb48-1164"><a href="#cb48-1164" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb48-1165"><a href="#cb48-1165" aria-hidden="true" tabindex="-1"></a>      <span class="st">"to_char({flds}, 'HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">')"</span>)</span>
<span id="cb48-1166"><a href="#cb48-1166" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(flds) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> output <span class="sc">==</span> <span class="st">"time"</span>)</span>
<span id="cb48-1167"><a href="#cb48-1167" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb48-1168"><a href="#cb48-1168" aria-hidden="true" tabindex="-1"></a>      <span class="st">"to_char({flds[1]}, 'HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">') || '/' || </span></span>
<span id="cb48-1169"><a href="#cb48-1169" aria-hidden="true" tabindex="-1"></a><span class="st">       to_char({flds[2]}, 'HH24:MI:SS</span><span class="sc">\"</span><span class="st">Z</span><span class="sc">\"</span><span class="st">')"</span>)</span>
<span id="cb48-1170"><a href="#cb48-1170" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-1171"><a href="#cb48-1171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.character</span>(s)</span>
<span id="cb48-1172"><a href="#cb48-1172" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-1173"><a href="#cb48-1173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1174"><a href="#cb48-1174" aria-hidden="true" tabindex="-1"></a><span class="co"># * Cruise level events ----</span></span>
<span id="cb48-1175"><a href="#cb48-1175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1176"><a href="#cb48-1176" aria-hidden="true" tabindex="-1"></a><span class="co"># get min/max datetimes for cruises</span></span>
<span id="cb48-1177"><a href="#cb48-1177" aria-hidden="true" tabindex="-1"></a>q_cruise_event_date <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb48-1178"><a href="#cb48-1178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cruise_uuid) <span class="sc">|&gt;</span></span>
<span id="cb48-1179"><a href="#cb48-1179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb48-1180"><a href="#cb48-1180" aria-hidden="true" tabindex="-1"></a>    <span class="at">dtime_min =</span> <span class="fu">min</span>(time_start, <span class="at">na.rm =</span> T),</span>
<span id="cb48-1181"><a href="#cb48-1181" aria-hidden="true" tabindex="-1"></a>    <span class="at">dtime_max =</span> <span class="fu">max</span>(time_start, <span class="at">na.rm =</span> T),</span>
<span id="cb48-1182"><a href="#cb48-1182" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-1183"><a href="#cb48-1183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-1184"><a href="#cb48-1184" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventDate =</span> <span class="fu">sql</span>(<span class="fu">flds_to_iso8601</span>(<span class="fu">c</span>(<span class="st">"dtime_min"</span>, <span class="st">"dtime_max"</span>))) ) <span class="sc">|&gt;</span> </span>
<span id="cb48-1185"><a href="#cb48-1185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(cruise_uuid, eventDate)</span>
<span id="cb48-1186"><a href="#cb48-1186" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-1187"><a href="#cb48-1187" aria-hidden="true" tabindex="-1"></a>q_cruise_events <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb48-1188"><a href="#cb48-1188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(cruise_uuid, ship_name, ship_nodc, date_ym) <span class="sc">|&gt;</span></span>
<span id="cb48-1189"><a href="#cb48-1189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-1190"><a href="#cb48-1190" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID          =</span> cruise_uuid,</span>
<span id="cb48-1191"><a href="#cb48-1191" aria-hidden="true" tabindex="-1"></a>    <span class="co"># parentEventID  = NA, # no parent for cruise level; NA generated with union_all</span></span>
<span id="cb48-1192"><a href="#cb48-1192" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks     =</span> <span class="fu">paste</span>(<span class="st">"Cruise on"</span>, ship_name),</span>
<span id="cb48-1193"><a href="#cb48-1193" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="st">"Marine plankton survey cruise"</span>,</span>
<span id="cb48-1194"><a href="#cb48-1194" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeValue  =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb48-1195"><a href="#cb48-1195" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeUnit   =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb48-1196"><a href="#cb48-1196" aria-hidden="true" tabindex="-1"></a>    <span class="at">habitat          =</span> <span class="st">"marine"</span>,</span>
<span id="cb48-1197"><a href="#cb48-1197" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType        =</span> <span class="st">"cruise"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-1198"><a href="#cb48-1198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb48-1199"><a href="#cb48-1199" aria-hidden="true" tabindex="-1"></a>    q_cruise_event_date,</span>
<span id="cb48-1200"><a href="#cb48-1200" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"cruise_uuid"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb48-1201"><a href="#cb48-1201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb48-1202"><a href="#cb48-1202" aria-hidden="true" tabindex="-1"></a>    eventID, <span class="co"># parentEventID, </span></span>
<span id="cb48-1203"><a href="#cb48-1203" aria-hidden="true" tabindex="-1"></a>    eventType, </span>
<span id="cb48-1204"><a href="#cb48-1204" aria-hidden="true" tabindex="-1"></a>    eventDate, samplingProtocol, eventRemarks, habitat)</span>
<span id="cb48-1205"><a href="#cb48-1205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1206"><a href="#cb48-1206" aria-hidden="true" tabindex="-1"></a><span class="co"># Site level events</span></span>
<span id="cb48-1207"><a href="#cb48-1207" aria-hidden="true" tabindex="-1"></a>q_site_events <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb48-1208"><a href="#cb48-1208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(site_uuid, cruise_uuid, longitude, latitude, line, station, orderocc) <span class="sc">|&gt;</span></span>
<span id="cb48-1209"><a href="#cb48-1209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-1210"><a href="#cb48-1210" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID          =</span> site_uuid,</span>
<span id="cb48-1211"><a href="#cb48-1211" aria-hidden="true" tabindex="-1"></a>    <span class="at">parentEventID    =</span> cruise_uuid,</span>
<span id="cb48-1212"><a href="#cb48-1212" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimalLatitude  =</span> latitude,</span>
<span id="cb48-1213"><a href="#cb48-1213" aria-hidden="true" tabindex="-1"></a>    <span class="at">decimalLongitude =</span> longitude,</span>
<span id="cb48-1214"><a href="#cb48-1214" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks     =</span> <span class="fu">paste</span>(<span class="st">"CalCOFI station"</span>, station, <span class="st">"on line"</span>, line),</span>
<span id="cb48-1215"><a href="#cb48-1215" aria-hidden="true" tabindex="-1"></a>    <span class="co"># per https://proj.org/en/stable/operations/projections/calcofi.html</span></span>
<span id="cb48-1216"><a href="#cb48-1216" aria-hidden="true" tabindex="-1"></a>    <span class="at">locationID       =</span> <span class="fu">paste0</span>(line, <span class="st">"_"</span>, station),</span>
<span id="cb48-1217"><a href="#cb48-1217" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType        =</span> <span class="st">"site"</span>,</span>
<span id="cb48-1218"><a href="#cb48-1218" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="st">"Marine plankton survey station"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb48-1219"><a href="#cb48-1219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb48-1220"><a href="#cb48-1220" aria-hidden="true" tabindex="-1"></a>    eventID, parentEventID, eventType, </span>
<span id="cb48-1221"><a href="#cb48-1221" aria-hidden="true" tabindex="-1"></a>    samplingProtocol, eventRemarks, decimalLatitude, decimalLongitude, locationID)</span>
<span id="cb48-1222"><a href="#cb48-1222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1223"><a href="#cb48-1223" aria-hidden="true" tabindex="-1"></a><span class="co"># Tow level events</span></span>
<span id="cb48-1224"><a href="#cb48-1224" aria-hidden="true" tabindex="-1"></a>q_tow_events <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb48-1225"><a href="#cb48-1225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(</span>
<span id="cb48-1226"><a href="#cb48-1226" aria-hidden="true" tabindex="-1"></a>    tow_uuid, site_uuid, </span>
<span id="cb48-1227"><a href="#cb48-1227" aria-hidden="true" tabindex="-1"></a>    tow_number, tow_type_key, <span class="at">tow_type_description =</span> description, </span>
<span id="cb48-1228"><a href="#cb48-1228" aria-hidden="true" tabindex="-1"></a>    time_start) <span class="sc">|&gt;</span></span>
<span id="cb48-1229"><a href="#cb48-1229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-1230"><a href="#cb48-1230" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID          =</span> tow_uuid,</span>
<span id="cb48-1231"><a href="#cb48-1231" aria-hidden="true" tabindex="-1"></a>    <span class="at">parentEventID    =</span> site_uuid,</span>
<span id="cb48-1232"><a href="#cb48-1232" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventDate        =</span> <span class="fu">sql</span>(<span class="fu">flds_to_iso8601</span>(<span class="st">"time_start"</span>)),</span>
<span id="cb48-1233"><a href="#cb48-1233" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks     =</span> <span class="fu">paste</span>(<span class="st">"Tow"</span>, tow_number, <span class="st">"-"</span>, tow_type_description),</span>
<span id="cb48-1234"><a href="#cb48-1234" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType        =</span> <span class="st">"tow"</span>,</span>
<span id="cb48-1235"><a href="#cb48-1235" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="fu">paste</span>(tow_type_key, <span class="st">":"</span>, tow_type_description)) <span class="sc">|&gt;</span> </span>
<span id="cb48-1236"><a href="#cb48-1236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb48-1237"><a href="#cb48-1237" aria-hidden="true" tabindex="-1"></a>    eventID, parentEventID, eventType,</span>
<span id="cb48-1238"><a href="#cb48-1238" aria-hidden="true" tabindex="-1"></a>    eventDate,</span>
<span id="cb48-1239"><a href="#cb48-1239" aria-hidden="true" tabindex="-1"></a>    samplingProtocol, eventRemarks)</span>
<span id="cb48-1240"><a href="#cb48-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1241"><a href="#cb48-1241" aria-hidden="true" tabindex="-1"></a><span class="co"># Net level events (sampling events)</span></span>
<span id="cb48-1242"><a href="#cb48-1242" aria-hidden="true" tabindex="-1"></a>q_net_events_allflds <span class="ot">&lt;-</span> q_events <span class="sc">|&gt;</span></span>
<span id="cb48-1243"><a href="#cb48-1243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(</span>
<span id="cb48-1244"><a href="#cb48-1244" aria-hidden="true" tabindex="-1"></a>    net_uuid, tow_uuid, side, std_haul_factor, vol_sampled_m3, </span>
<span id="cb48-1245"><a href="#cb48-1245" aria-hidden="true" tabindex="-1"></a>    prop_sorted, smallplankton, totalplankton) <span class="sc">|&gt;</span></span>
<span id="cb48-1246"><a href="#cb48-1246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-1247"><a href="#cb48-1247" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID          =</span> net_uuid,</span>
<span id="cb48-1248"><a href="#cb48-1248" aria-hidden="true" tabindex="-1"></a>    <span class="at">parentEventID    =</span> tow_uuid,</span>
<span id="cb48-1249"><a href="#cb48-1249" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventRemarks     =</span> <span class="fu">paste</span>(</span>
<span id="cb48-1250"><a href="#cb48-1250" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Net sample from side"</span>, side, <span class="st">"; only"</span>, prop_sorted, <span class="st">"proportion sorted of"</span>,</span>
<span id="cb48-1251"><a href="#cb48-1251" aria-hidden="true" tabindex="-1"></a>      vol_sampled_m3, <span class="st">"cubic meters sampled"</span>),</span>
<span id="cb48-1252"><a href="#cb48-1252" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventType        =</span> <span class="st">"net_sample"</span>,</span>
<span id="cb48-1253"><a href="#cb48-1253" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplingProtocol =</span> <span class="fu">paste</span>(<span class="st">"Plankton net tow -"</span>, side, <span class="st">"side"</span>),</span>
<span id="cb48-1254"><a href="#cb48-1254" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeValue  =</span> vol_sampled_m3,</span>
<span id="cb48-1255"><a href="#cb48-1255" aria-hidden="true" tabindex="-1"></a>    <span class="at">sampleSizeUnit   =</span> <span class="st">"m^3"</span>)</span>
<span id="cb48-1256"><a href="#cb48-1256" aria-hidden="true" tabindex="-1"></a>q_net_events <span class="ot">&lt;-</span> q_net_events_allflds <span class="sc">|&gt;</span> </span>
<span id="cb48-1257"><a href="#cb48-1257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb48-1258"><a href="#cb48-1258" aria-hidden="true" tabindex="-1"></a>    eventID, parentEventID, eventType, </span>
<span id="cb48-1259"><a href="#cb48-1259" aria-hidden="true" tabindex="-1"></a>    samplingProtocol, eventRemarks, sampleSizeValue, sampleSizeUnit)</span>
<span id="cb48-1260"><a href="#cb48-1260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1261"><a href="#cb48-1261" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all event levels</span></span>
<span id="cb48-1262"><a href="#cb48-1262" aria-hidden="true" tabindex="-1"></a>db_version <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"schema_version"</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(version)</span>
<span id="cb48-1263"><a href="#cb48-1263" aria-hidden="true" tabindex="-1"></a>dataset_id <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb48-1264"><a href="#cb48-1264" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "https://github.com/CalCOFI/calcofi4db/releases/tag/v", </span></span>
<span id="cb48-1265"><a href="#cb48-1265" aria-hidden="true" tabindex="-1"></a>  <span class="st">"calcofi_db."</span>, db_version,</span>
<span id="cb48-1266"><a href="#cb48-1266" aria-hidden="true" tabindex="-1"></a>  <span class="st">"_larvae."</span>, <span class="fu">format</span>(<span class="fu">Sys.Date</span>(), <span class="st">"%Y-%m-%d"</span>))</span>
<span id="cb48-1267"><a href="#cb48-1267" aria-hidden="true" tabindex="-1"></a><span class="co"># "calcofi_db.1.1.0_larvae.2025-10-09"</span></span>
<span id="cb48-1268"><a href="#cb48-1268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1269"><a href="#cb48-1269" aria-hidden="true" tabindex="-1"></a>q_event_core <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb48-1270"><a href="#cb48-1270" aria-hidden="true" tabindex="-1"></a>  q_cruise_events <span class="sc">|&gt;</span> </span>
<span id="cb48-1271"><a href="#cb48-1271" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb48-1272"><a href="#cb48-1272" aria-hidden="true" tabindex="-1"></a>      <span class="at">parentEventID   =</span> <span class="fu">sql</span>(<span class="st">"NULL::uuid"</span>),</span>
<span id="cb48-1273"><a href="#cb48-1273" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeValue =</span> <span class="fu">sql</span>(<span class="st">"NULL::numeric"</span>),</span>
<span id="cb48-1274"><a href="#cb48-1274" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeUnit  =</span> <span class="cn">NA_character_</span>),</span>
<span id="cb48-1275"><a href="#cb48-1275" aria-hidden="true" tabindex="-1"></a>  q_site_events <span class="sc">|&gt;</span> </span>
<span id="cb48-1276"><a href="#cb48-1276" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb48-1277"><a href="#cb48-1277" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeValue =</span> <span class="fu">sql</span>(<span class="st">"NULL::numeric"</span>),</span>
<span id="cb48-1278"><a href="#cb48-1278" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeUnit  =</span> <span class="cn">NA_character_</span>),</span>
<span id="cb48-1279"><a href="#cb48-1279" aria-hidden="true" tabindex="-1"></a>  q_tow_events <span class="sc">|&gt;</span> </span>
<span id="cb48-1280"><a href="#cb48-1280" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb48-1281"><a href="#cb48-1281" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeValue =</span> <span class="fu">sql</span>(<span class="st">"NULL::numeric"</span>),</span>
<span id="cb48-1282"><a href="#cb48-1282" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeUnit  =</span> <span class="cn">NA_character_</span>),</span>
<span id="cb48-1283"><a href="#cb48-1283" aria-hidden="true" tabindex="-1"></a>  q_net_events) <span class="sc">|&gt;</span> </span>
<span id="cb48-1284"><a href="#cb48-1284" aria-hidden="true" tabindex="-1"></a>    <span class="fu">reduce</span>(union_all) <span class="sc">|&gt;</span> </span>
<span id="cb48-1285"><a href="#cb48-1285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-1286"><a href="#cb48-1286" aria-hidden="true" tabindex="-1"></a>    <span class="co"># basisOfRecord                 = "HumanObservation",</span></span>
<span id="cb48-1287"><a href="#cb48-1287" aria-hidden="true" tabindex="-1"></a>    <span class="at">geodeticDatum                 =</span> <span class="st">"WGS84"</span>,</span>
<span id="cb48-1288"><a href="#cb48-1288" aria-hidden="true" tabindex="-1"></a>    <span class="at">coordinateUncertaintyInMeters =</span> <span class="dv">1000</span>, <span class="co"># </span><span class="al">TODO</span><span class="co">: adjust based on accuracy of GPS/Loran/dead-reckoning over time</span></span>
<span id="cb48-1289"><a href="#cb48-1289" aria-hidden="true" tabindex="-1"></a>    <span class="at">countryCode                   =</span> <span class="st">"US"</span>,</span>
<span id="cb48-1290"><a href="#cb48-1290" aria-hidden="true" tabindex="-1"></a>    <span class="at">waterBody                     =</span> <span class="st">"California Current"</span>,  <span class="co"># LME: http://marineregions.org/mrgid/8549</span></span>
<span id="cb48-1291"><a href="#cb48-1291" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasetID                     =</span> dataset_id)</span>
<span id="cb48-1292"><a href="#cb48-1292" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: datasetID: permalink to this qmd in calcofi4db release?</span></span>
<span id="cb48-1293"><a href="#cb48-1293" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-1294"><a href="#cb48-1294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1295"><a href="#cb48-1295" aria-hidden="true" tabindex="-1"></a><span class="fu">## Create Occurrence Records</span></span>
<span id="cb48-1296"><a href="#cb48-1296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1297"><a href="#cb48-1297" aria-hidden="true" tabindex="-1"></a>Now let's combine all biological observations into occurrence records:</span>
<span id="cb48-1298"><a href="#cb48-1298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1301"><a href="#cb48-1301" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-1302"><a href="#cb48-1302" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: build-occurrences</span></span>
<span id="cb48-1303"><a href="#cb48-1303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1304"><a href="#cb48-1304" aria-hidden="true" tabindex="-1"></a><span class="co"># Create consolidated egg occurrences (one per species per net)</span></span>
<span id="cb48-1305"><a href="#cb48-1305" aria-hidden="true" tabindex="-1"></a>q_egg_occurrences <span class="ot">&lt;-</span> tbl_egg <span class="sc">|&gt;</span></span>
<span id="cb48-1306"><a href="#cb48-1306" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_species, <span class="at">by =</span> <span class="st">"species_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-1307"><a href="#cb48-1307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-1308"><a href="#cb48-1308" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID         =</span> <span class="fu">sql</span>(<span class="st">"gen_random_uuid()"</span>),</span>
<span id="cb48-1309"><a href="#cb48-1309" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID              =</span> net_uuid,</span>
<span id="cb48-1310"><a href="#cb48-1310" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificName       =</span> scientific_name,</span>
<span id="cb48-1311"><a href="#cb48-1311" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificNameID     =</span> <span class="fu">paste0</span>(<span class="st">"urn:lsid:marinespecies.org:taxname:"</span>, worms_id),</span>
<span id="cb48-1312"><a href="#cb48-1312" aria-hidden="true" tabindex="-1"></a>    <span class="at">kingdom              =</span> <span class="st">"Animalia"</span>,</span>
<span id="cb48-1313"><a href="#cb48-1313" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceStatus     =</span> <span class="fu">ifelse</span>(tally <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"present"</span>, <span class="st">"absent"</span>),</span>
<span id="cb48-1314"><a href="#cb48-1314" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantity     =</span> tally,  <span class="co"># TOTAL count from egg table</span></span>
<span id="cb48-1315"><a href="#cb48-1315" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantityType =</span> <span class="st">"individuals"</span>,</span>
<span id="cb48-1316"><a href="#cb48-1316" aria-hidden="true" tabindex="-1"></a>    <span class="at">lifeStage            =</span> <span class="st">"egg"</span>,</span>
<span id="cb48-1317"><a href="#cb48-1317" aria-hidden="true" tabindex="-1"></a>    <span class="co">#lifeStage            = "https://vocab.nerc.ac.uk/collection/S11/current/S1122/",</span></span>
<span id="cb48-1318"><a href="#cb48-1318" aria-hidden="true" tabindex="-1"></a>    <span class="co"># lifeStageID          = "http://vocab.nerc.ac.uk/collection/S11/current/S1110/",</span></span>
<span id="cb48-1319"><a href="#cb48-1319" aria-hidden="true" tabindex="-1"></a>    <span class="at">preparations         =</span> <span class="st">"egg sample"</span>,</span>
<span id="cb48-1320"><a href="#cb48-1320" aria-hidden="true" tabindex="-1"></a>    <span class="at">basisOfRecord        =</span> <span class="st">"HumanObservation"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-1321"><a href="#cb48-1321" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb48-1322"><a href="#cb48-1322" aria-hidden="true" tabindex="-1"></a>    occurrenceID, eventID,</span>
<span id="cb48-1323"><a href="#cb48-1323" aria-hidden="true" tabindex="-1"></a>    species_id,</span>
<span id="cb48-1324"><a href="#cb48-1324" aria-hidden="true" tabindex="-1"></a>    scientificName, scientificNameID,</span>
<span id="cb48-1325"><a href="#cb48-1325" aria-hidden="true" tabindex="-1"></a>    kingdom, occurrenceStatus, organismQuantity, organismQuantityType,</span>
<span id="cb48-1326"><a href="#cb48-1326" aria-hidden="true" tabindex="-1"></a>    lifeStage, <span class="co"># lifeStageID, </span></span>
<span id="cb48-1327"><a href="#cb48-1327" aria-hidden="true" tabindex="-1"></a>    preparations, basisOfRecord)</span>
<span id="cb48-1328"><a href="#cb48-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1329"><a href="#cb48-1329" aria-hidden="true" tabindex="-1"></a><span class="co"># Create consolidated larva occurrences (one per species per net)</span></span>
<span id="cb48-1330"><a href="#cb48-1330" aria-hidden="true" tabindex="-1"></a>q_larva_occurrences <span class="ot">&lt;-</span> tbl_larva <span class="sc">|&gt;</span></span>
<span id="cb48-1331"><a href="#cb48-1331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tbl_species, <span class="at">by =</span> <span class="st">"species_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-1332"><a href="#cb48-1332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-1333"><a href="#cb48-1333" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID         =</span> <span class="fu">sql</span>(<span class="st">"gen_random_uuid()"</span>),</span>
<span id="cb48-1334"><a href="#cb48-1334" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID              =</span> net_uuid,</span>
<span id="cb48-1335"><a href="#cb48-1335" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificName       =</span> scientific_name,</span>
<span id="cb48-1336"><a href="#cb48-1336" aria-hidden="true" tabindex="-1"></a>    <span class="at">scientificNameID     =</span> <span class="fu">paste0</span>(<span class="st">"urn:lsid:marinespecies.org:taxname:"</span>, worms_id),</span>
<span id="cb48-1337"><a href="#cb48-1337" aria-hidden="true" tabindex="-1"></a>    <span class="at">kingdom              =</span> <span class="st">"Animalia"</span>,</span>
<span id="cb48-1338"><a href="#cb48-1338" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceStatus     =</span> <span class="fu">ifelse</span>(tally <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"present"</span>, <span class="st">"absent"</span>),</span>
<span id="cb48-1339"><a href="#cb48-1339" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantity     =</span> tally,  <span class="co"># TOTAL count from larva table</span></span>
<span id="cb48-1340"><a href="#cb48-1340" aria-hidden="true" tabindex="-1"></a>    <span class="at">organismQuantityType =</span> <span class="st">"individuals"</span>,</span>
<span id="cb48-1341"><a href="#cb48-1341" aria-hidden="true" tabindex="-1"></a>    <span class="at">lifeStage            =</span> <span class="st">"larva"</span>,</span>
<span id="cb48-1342"><a href="#cb48-1342" aria-hidden="true" tabindex="-1"></a>    <span class="co"># lifeStageID          = "http://vocab.nerc.ac.uk/collection/S11/current/S1133/",</span></span>
<span id="cb48-1343"><a href="#cb48-1343" aria-hidden="true" tabindex="-1"></a>    <span class="at">preparations         =</span> <span class="st">"larva sample"</span>,</span>
<span id="cb48-1344"><a href="#cb48-1344" aria-hidden="true" tabindex="-1"></a>    <span class="at">basisOfRecord        =</span> <span class="st">"HumanObservation"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-1345"><a href="#cb48-1345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb48-1346"><a href="#cb48-1346" aria-hidden="true" tabindex="-1"></a>    occurrenceID, eventID,</span>
<span id="cb48-1347"><a href="#cb48-1347" aria-hidden="true" tabindex="-1"></a>    species_id,</span>
<span id="cb48-1348"><a href="#cb48-1348" aria-hidden="true" tabindex="-1"></a>    scientificName, scientificNameID,</span>
<span id="cb48-1349"><a href="#cb48-1349" aria-hidden="true" tabindex="-1"></a>    kingdom, occurrenceStatus, organismQuantity, organismQuantityType,</span>
<span id="cb48-1350"><a href="#cb48-1350" aria-hidden="true" tabindex="-1"></a>    lifeStage, <span class="co"># lifeStageID, </span></span>
<span id="cb48-1351"><a href="#cb48-1351" aria-hidden="true" tabindex="-1"></a>    preparations, basisOfRecord)</span>
<span id="cb48-1352"><a href="#cb48-1352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1353"><a href="#cb48-1353" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine egg and larva occurrences</span></span>
<span id="cb48-1354"><a href="#cb48-1354" aria-hidden="true" tabindex="-1"></a>q_occurrence_extension <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb48-1355"><a href="#cb48-1355" aria-hidden="true" tabindex="-1"></a>  q_egg_occurrences,</span>
<span id="cb48-1356"><a href="#cb48-1356" aria-hidden="true" tabindex="-1"></a>  q_larva_occurrences) <span class="sc">|&gt;</span></span>
<span id="cb48-1357"><a href="#cb48-1357" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reduce</span>(union_all) <span class="sc">|&gt;</span></span>
<span id="cb48-1358"><a href="#cb48-1358" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add additional required/recommended fields</span></span>
<span id="cb48-1359"><a href="#cb48-1359" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-1360"><a href="#cb48-1360" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: identifiedBy, dateIdentified,identificationReferences</span></span>
<span id="cb48-1361"><a href="#cb48-1361" aria-hidden="true" tabindex="-1"></a>    <span class="co"># identifiedBy = "[NEED IDENTIFIER NAME]", # Prompt: Add taxonomist name</span></span>
<span id="cb48-1362"><a href="#cb48-1362" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dateIdentified = "[NEED IDENTIFICATION DATE]", # Prompt: Add identification date</span></span>
<span id="cb48-1363"><a href="#cb48-1363" aria-hidden="true" tabindex="-1"></a>    <span class="co"># identificationReferences = "[NEED REFERENCES]", # Prompt: Add identification guides used</span></span>
<span id="cb48-1364"><a href="#cb48-1364" aria-hidden="true" tabindex="-1"></a>    <span class="at">modified =</span> <span class="fu">sql</span>(<span class="st">"CURRENT_DATE"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb48-1365"><a href="#cb48-1365" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove species_id (internal field used only for joins)</span></span>
<span id="cb48-1366"><a href="#cb48-1366" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb48-1367"><a href="#cb48-1367" aria-hidden="true" tabindex="-1"></a>    occurrenceID, eventID,</span>
<span id="cb48-1368"><a href="#cb48-1368" aria-hidden="true" tabindex="-1"></a>    scientificName, scientificNameID,</span>
<span id="cb48-1369"><a href="#cb48-1369" aria-hidden="true" tabindex="-1"></a>    kingdom, occurrenceStatus, organismQuantity, organismQuantityType,</span>
<span id="cb48-1370"><a href="#cb48-1370" aria-hidden="true" tabindex="-1"></a>    lifeStage, <span class="co"># lifeStageID, </span></span>
<span id="cb48-1371"><a href="#cb48-1371" aria-hidden="true" tabindex="-1"></a>    preparations, basisOfRecord, modified)</span>
<span id="cb48-1372"><a href="#cb48-1372" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-1373"><a href="#cb48-1373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1374"><a href="#cb48-1374" aria-hidden="true" tabindex="-1"></a><span class="fu">## Create ExtendedMeasurementOrFact Extension</span></span>
<span id="cb48-1375"><a href="#cb48-1375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1376"><a href="#cb48-1376" aria-hidden="true" tabindex="-1"></a>Create eMoF records for three types of measurements:</span>
<span id="cb48-1377"><a href="#cb48-1377" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Sample-level measurements (linked to eventID)</span>
<span id="cb48-1378"><a href="#cb48-1378" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Stage-specific abundance (linked to occurrenceID)</span>
<span id="cb48-1379"><a href="#cb48-1379" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Body length measurements (linked to occurrence ID)</span>
<span id="cb48-1380"><a href="#cb48-1380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1383"><a href="#cb48-1383" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-1384"><a href="#cb48-1384" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: build-emof</span></span>
<span id="cb48-1385"><a href="#cb48-1385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1386"><a href="#cb48-1386" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Sample-level measurements (eventID, occurrenceID = NA) ----</span></span>
<span id="cb48-1387"><a href="#cb48-1387" aria-hidden="true" tabindex="-1"></a>d_sample_measurements <span class="ot">&lt;-</span> q_net_events_allflds <span class="sc">|&gt;</span></span>
<span id="cb48-1388"><a href="#cb48-1388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb48-1389"><a href="#cb48-1389" aria-hidden="true" tabindex="-1"></a>    eventID,</span>
<span id="cb48-1390"><a href="#cb48-1390" aria-hidden="true" tabindex="-1"></a>    std_haul_factor, prop_sorted, smallplankton, totalplankton) <span class="sc">|&gt;</span>  <span class="co"># vol_sampled_m3 moved to Event core</span></span>
<span id="cb48-1391"><a href="#cb48-1391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb48-1392"><a href="#cb48-1392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb48-1393"><a href="#cb48-1393" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(std_haul_factor, prop_sorted, smallplankton, totalplankton),</span>
<span id="cb48-1394"><a href="#cb48-1394" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to  =</span> <span class="st">"meas_type"</span>,</span>
<span id="cb48-1395"><a href="#cb48-1395" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"measurementValue"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-1396"><a href="#cb48-1396" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(measurementValue)) <span class="sc">|&gt;</span></span>
<span id="cb48-1397"><a href="#cb48-1397" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-1398"><a href="#cb48-1398" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID      =</span> <span class="fu">UUIDgenerate</span>(<span class="at">n =</span> <span class="fu">n</span>()),</span>
<span id="cb48-1399"><a href="#cb48-1399" aria-hidden="true" tabindex="-1"></a>    <span class="at">occurrenceID       =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb48-1400"><a href="#cb48-1400" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType    =</span> <span class="fu">case_when</span>(</span>
<span id="cb48-1401"><a href="#cb48-1401" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span> <span class="sc">~</span> <span class="st">"standardized haul factor"</span>,</span>
<span id="cb48-1402"><a href="#cb48-1402" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span>     <span class="sc">~</span> <span class="st">"proportion of sample sorted"</span>,</span>
<span id="cb48-1403"><a href="#cb48-1403" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"smallplankton"</span>   <span class="sc">~</span> <span class="st">"small plankton biomass"</span>,</span>
<span id="cb48-1404"><a href="#cb48-1404" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"totalplankton"</span>   <span class="sc">~</span> <span class="st">"total plankton biomass"</span>),</span>
<span id="cb48-1405"><a href="#cb48-1405" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID  =</span> <span class="fu">case_when</span>(</span>
<span id="cb48-1406"><a href="#cb48-1406" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span> <span class="sc">~</span> <span class="cn">NA_character_</span>,  <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for standardization factor</span></span>
<span id="cb48-1407"><a href="#cb48-1407" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span>     <span class="sc">~</span> <span class="cn">NA_character_</span>,  <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for subsample fraction</span></span>
<span id="cb48-1408"><a href="#cb48-1408" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"smallplankton"</span>   <span class="sc">~</span> <span class="cn">NA_character_</span>,  <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for zooplankton biomass</span></span>
<span id="cb48-1409"><a href="#cb48-1409" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"totalplankton"</span>   <span class="sc">~</span> <span class="cn">NA_character_</span>), <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for zooplankton biomass</span></span>
<span id="cb48-1410"><a href="#cb48-1410" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit    =</span> <span class="fu">case_when</span>(</span>
<span id="cb48-1411"><a href="#cb48-1411" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span> <span class="sc">~</span> <span class="st">"dimensionless"</span>,</span>
<span id="cb48-1412"><a href="#cb48-1412" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span>     <span class="sc">~</span> <span class="st">"dimensionless"</span>,</span>
<span id="cb48-1413"><a href="#cb48-1413" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"smallplankton"</span>, <span class="st">"totalplankton"</span>) <span class="sc">~</span> <span class="st">"grams"</span>),</span>
<span id="cb48-1414"><a href="#cb48-1414" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod  =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb48-1415"><a href="#cb48-1415" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> <span class="fu">case_when</span>(</span>
<span id="cb48-1416"><a href="#cb48-1416" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"std_haul_factor"</span> <span class="sc">~</span> <span class="st">"Standardization factor accounting for water filtered; abundances expressed as per 10 m² (Smith 1977)"</span>,</span>
<span id="cb48-1417"><a href="#cb48-1417" aria-hidden="true" tabindex="-1"></a>      meas_type <span class="sc">==</span> <span class="st">"prop_sorted"</span>     <span class="sc">~</span> <span class="st">"Fraction of total sample examined"</span>,</span>
<span id="cb48-1418"><a href="#cb48-1418" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span>)) <span class="sc">|&gt;</span></span>
<span id="cb48-1419"><a href="#cb48-1419" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-1420"><a href="#cb48-1420" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb48-1421"><a href="#cb48-1421" aria-hidden="true" tabindex="-1"></a>    eventID, occurrenceID, measurementID,</span>
<span id="cb48-1422"><a href="#cb48-1422" aria-hidden="true" tabindex="-1"></a>    measurementType, measurementTypeID, measurementValue,</span>
<span id="cb48-1423"><a href="#cb48-1423" aria-hidden="true" tabindex="-1"></a>    measurementUnit, measurementUnitID, measurementMethod, measurementRemarks)</span>
<span id="cb48-1424"><a href="#cb48-1424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1425"><a href="#cb48-1425" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Stage-specific abundance (eventID = NA, occurrenceID) ----</span></span>
<span id="cb48-1426"><a href="#cb48-1426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1427"><a href="#cb48-1427" aria-hidden="true" tabindex="-1"></a><span class="co"># Egg stage abundances - need to join with egg occurrences to get occurrenceID</span></span>
<span id="cb48-1428"><a href="#cb48-1428" aria-hidden="true" tabindex="-1"></a>d_egg_stage_abundance <span class="ot">&lt;-</span> tbl_egg_stage <span class="sc">|&gt;</span></span>
<span id="cb48-1429"><a href="#cb48-1429" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb48-1430"><a href="#cb48-1430" aria-hidden="true" tabindex="-1"></a>    egg_stage_vocab <span class="sc">|&gt;</span> </span>
<span id="cb48-1431"><a href="#cb48-1431" aria-hidden="true" tabindex="-1"></a>      <span class="fu">copy_to</span>(con, <span class="at">df =</span> _, <span class="at">name =</span> <span class="st">"egg_stage_vocab_tmp"</span>, <span class="at">temporary =</span> <span class="cn">TRUE</span>, <span class="at">overwrite =</span> T), <span class="at">by =</span> <span class="st">"stage"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-1432"><a href="#cb48-1432" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb48-1433"><a href="#cb48-1433" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb48-1434"><a href="#cb48-1434" aria-hidden="true" tabindex="-1"></a>    q_egg_occurrences <span class="sc">|&gt;</span> <span class="fu">collect</span>() <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="at">net_uuid =</span> eventID, species_id, occurrenceID),</span>
<span id="cb48-1435"><a href="#cb48-1435" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"net_uuid"</span>, <span class="st">"species_id"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb48-1436"><a href="#cb48-1436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-1437"><a href="#cb48-1437" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID            =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb48-1438"><a href="#cb48-1438" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID      =</span> <span class="fu">UUIDgenerate</span>(<span class="at">n =</span> <span class="fu">n</span>()),</span>
<span id="cb48-1439"><a href="#cb48-1439" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType    =</span> <span class="st">"abundance by life stage"</span>,</span>
<span id="cb48-1440"><a href="#cb48-1440" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID  =</span> <span class="cn">NA_character_</span>,  <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for "abundance" + "development stage"</span></span>
<span id="cb48-1441"><a href="#cb48-1441" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue   =</span> tally,</span>
<span id="cb48-1442"><a href="#cb48-1442" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValueID =</span> <span class="cn">NA_character_</span>,  <span class="co"># Could reference custom vocabulary for egg stages</span></span>
<span id="cb48-1443"><a href="#cb48-1443" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit    =</span> <span class="st">"individuals"</span>,</span>
<span id="cb48-1444"><a href="#cb48-1444" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod  =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb48-1445"><a href="#cb48-1445" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> stage_description) <span class="sc">|&gt;</span></span>
<span id="cb48-1446"><a href="#cb48-1446" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-1447"><a href="#cb48-1447" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb48-1448"><a href="#cb48-1448" aria-hidden="true" tabindex="-1"></a>    eventID, occurrenceID, measurementID,</span>
<span id="cb48-1449"><a href="#cb48-1449" aria-hidden="true" tabindex="-1"></a>    measurementType, measurementTypeID, measurementValue, measurementValueID,</span>
<span id="cb48-1450"><a href="#cb48-1450" aria-hidden="true" tabindex="-1"></a>    <span class="co">#measurementUnit, measurementUnitID = measurementUnitID.y, measurementMethod, </span></span>
<span id="cb48-1451"><a href="#cb48-1451" aria-hidden="true" tabindex="-1"></a>    measurementUnit, measurementUnitID, measurementMethod, measurementRemarks)</span>
<span id="cb48-1452"><a href="#cb48-1452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1453"><a href="#cb48-1453" aria-hidden="true" tabindex="-1"></a><span class="co"># Larva stage abundances - need to join with larva occurrences to get occurrenceID</span></span>
<span id="cb48-1454"><a href="#cb48-1454" aria-hidden="true" tabindex="-1"></a>d_larva_stage_abundance <span class="ot">&lt;-</span> tbl_larva_stage <span class="sc">|&gt;</span></span>
<span id="cb48-1455"><a href="#cb48-1455" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(larva_stage_vocab <span class="sc">|&gt;</span> <span class="fu">copy_to</span>(con, <span class="at">df =</span> _, <span class="at">name =</span> <span class="st">"larva_stage_vocab_tmp"</span>, <span class="at">temporary =</span> <span class="cn">TRUE</span>, <span class="at">overwrite =</span> T), <span class="at">by =</span> <span class="st">"stage"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-1456"><a href="#cb48-1456" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb48-1457"><a href="#cb48-1457" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb48-1458"><a href="#cb48-1458" aria-hidden="true" tabindex="-1"></a>    q_larva_occurrences <span class="sc">|&gt;</span> <span class="fu">collect</span>() <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="at">net_uuid =</span> eventID, species_id, occurrenceID),</span>
<span id="cb48-1459"><a href="#cb48-1459" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"net_uuid"</span>, <span class="st">"species_id"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb48-1460"><a href="#cb48-1460" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-1461"><a href="#cb48-1461" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID            =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb48-1462"><a href="#cb48-1462" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID      =</span> <span class="fu">UUIDgenerate</span>(<span class="at">n =</span> <span class="fu">n</span>()),</span>
<span id="cb48-1463"><a href="#cb48-1463" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType    =</span> <span class="st">"abundance by life stage"</span>,</span>
<span id="cb48-1464"><a href="#cb48-1464" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID  =</span> <span class="cn">NA_character_</span>,  <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for "abundance" + "development stage"</span></span>
<span id="cb48-1465"><a href="#cb48-1465" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue   =</span> tally,</span>
<span id="cb48-1466"><a href="#cb48-1466" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValueID =</span> <span class="cn">NA_character_</span>,  <span class="co"># Could reference custom vocabulary for larva stages</span></span>
<span id="cb48-1467"><a href="#cb48-1467" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit    =</span> <span class="st">"individuals"</span>,</span>
<span id="cb48-1468"><a href="#cb48-1468" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod  =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb48-1469"><a href="#cb48-1469" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> stage_description) <span class="sc">|&gt;</span></span>
<span id="cb48-1470"><a href="#cb48-1470" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-1471"><a href="#cb48-1471" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb48-1472"><a href="#cb48-1472" aria-hidden="true" tabindex="-1"></a>    eventID, occurrenceID, measurementID,</span>
<span id="cb48-1473"><a href="#cb48-1473" aria-hidden="true" tabindex="-1"></a>    measurementType, measurementTypeID, measurementValue, measurementValueID,</span>
<span id="cb48-1474"><a href="#cb48-1474" aria-hidden="true" tabindex="-1"></a>    measurementUnit, measurementUnitID, measurementMethod, measurementRemarks)</span>
<span id="cb48-1475"><a href="#cb48-1475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1476"><a href="#cb48-1476" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Body length measurements (eventID = NA, occurrenceID) ----</span></span>
<span id="cb48-1477"><a href="#cb48-1477" aria-hidden="true" tabindex="-1"></a>d_body_length <span class="ot">&lt;-</span> tbl_larva_size <span class="sc">|&gt;</span></span>
<span id="cb48-1478"><a href="#cb48-1478" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb48-1479"><a href="#cb48-1479" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb48-1480"><a href="#cb48-1480" aria-hidden="true" tabindex="-1"></a>    q_larva_occurrences <span class="sc">|&gt;</span> <span class="fu">collect</span>() <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="at">net_uuid =</span> eventID, species_id, occurrenceID),</span>
<span id="cb48-1481"><a href="#cb48-1481" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"net_uuid"</span>, <span class="st">"species_id"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb48-1482"><a href="#cb48-1482" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(length_mm)) <span class="sc">|&gt;</span></span>
<span id="cb48-1483"><a href="#cb48-1483" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-1484"><a href="#cb48-1484" aria-hidden="true" tabindex="-1"></a>    <span class="at">eventID            =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb48-1485"><a href="#cb48-1485" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementID      =</span> <span class="fu">UUIDgenerate</span>(<span class="at">n =</span> <span class="fu">n</span>()),</span>
<span id="cb48-1486"><a href="#cb48-1486" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementType    =</span> <span class="st">"body length"</span>,</span>
<span id="cb48-1487"><a href="#cb48-1487" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementTypeID  =</span> <span class="cn">NA_character_</span>,  <span class="co"># </span><span class="al">TODO</span><span class="co">: search P01 for fish larvae body length (e.g., OBSINDLX)</span></span>
<span id="cb48-1488"><a href="#cb48-1488" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValue   =</span> length_mm,</span>
<span id="cb48-1489"><a href="#cb48-1489" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementValueID =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb48-1490"><a href="#cb48-1490" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementUnit    =</span> <span class="st">"millimeters"</span>,</span>
<span id="cb48-1491"><a href="#cb48-1491" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementMethod  =</span> <span class="st">"https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"</span>,</span>
<span id="cb48-1492"><a href="#cb48-1492" aria-hidden="true" tabindex="-1"></a>    <span class="at">measurementRemarks =</span> <span class="fu">paste0</span>(<span class="st">"Count: "</span>, tally, <span class="st">"; Total length measurement"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb48-1493"><a href="#cb48-1493" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(measurement_unit_vocab, <span class="at">by =</span> <span class="st">"measurementUnit"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-1494"><a href="#cb48-1494" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb48-1495"><a href="#cb48-1495" aria-hidden="true" tabindex="-1"></a>    eventID, occurrenceID, measurementID,</span>
<span id="cb48-1496"><a href="#cb48-1496" aria-hidden="true" tabindex="-1"></a>    measurementType, measurementTypeID, measurementValue, measurementValueID,</span>
<span id="cb48-1497"><a href="#cb48-1497" aria-hidden="true" tabindex="-1"></a>    measurementUnit, measurementUnitID, measurementMethod, measurementRemarks)</span>
<span id="cb48-1498"><a href="#cb48-1498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1499"><a href="#cb48-1499" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all eMoF records ----</span></span>
<span id="cb48-1500"><a href="#cb48-1500" aria-hidden="true" tabindex="-1"></a>d_extendedmeasurementorfact_extension <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb48-1501"><a href="#cb48-1501" aria-hidden="true" tabindex="-1"></a>  d_sample_measurements,</span>
<span id="cb48-1502"><a href="#cb48-1502" aria-hidden="true" tabindex="-1"></a>  d_egg_stage_abundance,</span>
<span id="cb48-1503"><a href="#cb48-1503" aria-hidden="true" tabindex="-1"></a>  d_larva_stage_abundance,</span>
<span id="cb48-1504"><a href="#cb48-1504" aria-hidden="true" tabindex="-1"></a>  d_body_length)</span>
<span id="cb48-1505"><a href="#cb48-1505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1506"><a href="#cb48-1506" aria-hidden="true" tabindex="-1"></a><span class="co"># table(is.na(d_extendedmeasurementorfact_extension$occurrenceID))</span></span>
<span id="cb48-1507"><a href="#cb48-1507" aria-hidden="true" tabindex="-1"></a><span class="co">#   FALSE    TRUE </span></span>
<span id="cb48-1508"><a href="#cb48-1508" aria-hidden="true" tabindex="-1"></a><span class="co"># 367,218 243,598</span></span>
<span id="cb48-1509"><a href="#cb48-1509" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb48-1510"><a href="#cb48-1510" aria-hidden="true" tabindex="-1"></a><span class="co"># table(is.na(d_extendedmeasurementorfact_extension$eventID))</span></span>
<span id="cb48-1511"><a href="#cb48-1511" aria-hidden="true" tabindex="-1"></a><span class="co">#   FALSE    TRUE </span></span>
<span id="cb48-1512"><a href="#cb48-1512" aria-hidden="true" tabindex="-1"></a><span class="co"># 243,598 367,218</span></span>
<span id="cb48-1513"><a href="#cb48-1513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1514"><a href="#cb48-1514" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-1515"><a href="#cb48-1515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1516"><a href="#cb48-1516" aria-hidden="true" tabindex="-1"></a><span class="fu">## Write DarwinCore Archive Files</span></span>
<span id="cb48-1517"><a href="#cb48-1517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1520"><a href="#cb48-1520" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-1521"><a href="#cb48-1521" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: export-dwc</span></span>
<span id="cb48-1522"><a href="#cb48-1522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1523"><a href="#cb48-1523" aria-hidden="true" tabindex="-1"></a><span class="co"># Create output directory</span></span>
<span id="cb48-1524"><a href="#cb48-1524" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(dir_out, <span class="at">showWarnings =</span> F)</span>
<span id="cb48-1525"><a href="#cb48-1525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1526"><a href="#cb48-1526" aria-hidden="true" tabindex="-1"></a><span class="co"># Write core and extension files</span></span>
<span id="cb48-1527"><a href="#cb48-1527" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(q_event_core           <span class="sc">|&gt;</span> <span class="fu">collect</span>(), <span class="fu">file.path</span>(dir_out, <span class="st">"event.csv"</span>))</span>
<span id="cb48-1528"><a href="#cb48-1528" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(q_occurrence_extension <span class="sc">|&gt;</span> <span class="fu">collect</span>(), <span class="fu">file.path</span>(dir_out, <span class="st">"occurrence.csv"</span>))</span>
<span id="cb48-1529"><a href="#cb48-1529" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d_extendedmeasurementorfact_extension, <span class="fu">file.path</span>(dir_out, <span class="st">"extendedMeasurementOrFact.csv"</span>))</span>
<span id="cb48-1530"><a href="#cb48-1530" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-1531"><a href="#cb48-1531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1532"><a href="#cb48-1532" aria-hidden="true" tabindex="-1"></a><span class="fu">## Create meta.xml programmatically by cross-walking CSV fields to DwC terms</span></span>
<span id="cb48-1533"><a href="#cb48-1533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1536"><a href="#cb48-1536" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-1537"><a href="#cb48-1537" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: create-meta-xml</span></span>
<span id="cb48-1538"><a href="#cb48-1538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1539"><a href="#cb48-1539" aria-hidden="true" tabindex="-1"></a><span class="co"># Define DarwinCore term mappings for each file type</span></span>
<span id="cb48-1540"><a href="#cb48-1540" aria-hidden="true" tabindex="-1"></a>dwc_terms <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb48-1541"><a href="#cb48-1541" aria-hidden="true" tabindex="-1"></a>  <span class="at">event =</span> <span class="fu">list</span>(</span>
<span id="cb48-1542"><a href="#cb48-1542" aria-hidden="true" tabindex="-1"></a>    <span class="at">rowType =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/Event"</span>,</span>
<span id="cb48-1543"><a href="#cb48-1543" aria-hidden="true" tabindex="-1"></a>    <span class="at">idField =</span> <span class="st">"eventID"</span>,</span>
<span id="cb48-1544"><a href="#cb48-1544" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms   =</span> <span class="fu">c</span>(</span>
<span id="cb48-1545"><a href="#cb48-1545" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventID                       =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventID"</span>,</span>
<span id="cb48-1546"><a href="#cb48-1546" aria-hidden="true" tabindex="-1"></a>      <span class="at">parentEventID                 =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/parentEventID"</span>,</span>
<span id="cb48-1547"><a href="#cb48-1547" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventType                     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventType"</span>,</span>
<span id="cb48-1548"><a href="#cb48-1548" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventDate                     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventDate"</span>,</span>
<span id="cb48-1549"><a href="#cb48-1549" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventTime                     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventTime"</span>,</span>
<span id="cb48-1550"><a href="#cb48-1550" aria-hidden="true" tabindex="-1"></a>      <span class="at">samplingProtocol              =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/samplingProtocol"</span>,</span>
<span id="cb48-1551"><a href="#cb48-1551" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeValue               =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/sampleSizeValue"</span>,</span>
<span id="cb48-1552"><a href="#cb48-1552" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampleSizeUnit                =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/sampleSizeUnit"</span>,</span>
<span id="cb48-1553"><a href="#cb48-1553" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventRemarks                  =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventRemarks"</span>,</span>
<span id="cb48-1554"><a href="#cb48-1554" aria-hidden="true" tabindex="-1"></a>      <span class="at">habitat                       =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/habitat"</span>,</span>
<span id="cb48-1555"><a href="#cb48-1555" aria-hidden="true" tabindex="-1"></a>      <span class="at">decimalLatitude               =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/decimalLatitude"</span>,</span>
<span id="cb48-1556"><a href="#cb48-1556" aria-hidden="true" tabindex="-1"></a>      <span class="at">decimalLongitude              =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/decimalLongitude"</span>,</span>
<span id="cb48-1557"><a href="#cb48-1557" aria-hidden="true" tabindex="-1"></a>      <span class="at">geodeticDatum                 =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/geodeticDatum"</span>,</span>
<span id="cb48-1558"><a href="#cb48-1558" aria-hidden="true" tabindex="-1"></a>      <span class="at">coordinateUncertaintyInMeters =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/coordinateUncertaintyInMeters"</span>,</span>
<span id="cb48-1559"><a href="#cb48-1559" aria-hidden="true" tabindex="-1"></a>      <span class="at">locationID                    =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/locationID"</span>,</span>
<span id="cb48-1560"><a href="#cb48-1560" aria-hidden="true" tabindex="-1"></a>      <span class="at">countryCode                   =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/countryCode"</span>,</span>
<span id="cb48-1561"><a href="#cb48-1561" aria-hidden="true" tabindex="-1"></a>      <span class="at">waterBody                     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/waterBody"</span>,</span>
<span id="cb48-1562"><a href="#cb48-1562" aria-hidden="true" tabindex="-1"></a>      <span class="at">datasetID                     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/datasetID"</span></span>
<span id="cb48-1563"><a href="#cb48-1563" aria-hidden="true" tabindex="-1"></a>      <span class="co"># basisOfRecord                 = "http://rs.tdwg.org/dwc/terms/basisOfRecord" </span></span>
<span id="cb48-1564"><a href="#cb48-1564" aria-hidden="true" tabindex="-1"></a>      )),</span>
<span id="cb48-1565"><a href="#cb48-1565" aria-hidden="true" tabindex="-1"></a>  <span class="at">occurrence =</span> <span class="fu">list</span>(</span>
<span id="cb48-1566"><a href="#cb48-1566" aria-hidden="true" tabindex="-1"></a>    <span class="at">rowType     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/Occurrence"</span>,</span>
<span id="cb48-1567"><a href="#cb48-1567" aria-hidden="true" tabindex="-1"></a>    <span class="at">idField     =</span> <span class="st">"occurrenceID"</span>,</span>
<span id="cb48-1568"><a href="#cb48-1568" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreIdField =</span> <span class="st">"eventID"</span>,</span>
<span id="cb48-1569"><a href="#cb48-1569" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms       =</span> <span class="fu">c</span>(</span>
<span id="cb48-1570"><a href="#cb48-1570" aria-hidden="true" tabindex="-1"></a>      <span class="at">occurrenceID         =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceID"</span>,</span>
<span id="cb48-1571"><a href="#cb48-1571" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventID              =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventID"</span>,</span>
<span id="cb48-1572"><a href="#cb48-1572" aria-hidden="true" tabindex="-1"></a>      <span class="at">scientificName       =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/scientificName"</span>,</span>
<span id="cb48-1573"><a href="#cb48-1573" aria-hidden="true" tabindex="-1"></a>      <span class="at">scientificNameID     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/scientificNameID"</span>,</span>
<span id="cb48-1574"><a href="#cb48-1574" aria-hidden="true" tabindex="-1"></a>      <span class="at">kingdom              =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/kingdom"</span>,</span>
<span id="cb48-1575"><a href="#cb48-1575" aria-hidden="true" tabindex="-1"></a>      <span class="at">occurrenceStatus     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceStatus"</span>,</span>
<span id="cb48-1576"><a href="#cb48-1576" aria-hidden="true" tabindex="-1"></a>      <span class="at">organismQuantity     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/organismQuantity"</span>,</span>
<span id="cb48-1577"><a href="#cb48-1577" aria-hidden="true" tabindex="-1"></a>      <span class="at">organismQuantityType =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/organismQuantityType"</span>,</span>
<span id="cb48-1578"><a href="#cb48-1578" aria-hidden="true" tabindex="-1"></a>      <span class="at">lifeStage            =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/lifeStage"</span>,</span>
<span id="cb48-1579"><a href="#cb48-1579" aria-hidden="true" tabindex="-1"></a>      <span class="co"># lifeStageID          = "http://rs.tdwg.org/dwc/terms/lifeStageID",</span></span>
<span id="cb48-1580"><a href="#cb48-1580" aria-hidden="true" tabindex="-1"></a>      <span class="at">preparations         =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/preparations"</span>,</span>
<span id="cb48-1581"><a href="#cb48-1581" aria-hidden="true" tabindex="-1"></a>      <span class="at">basisOfRecord        =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/basisOfRecord"</span>,</span>
<span id="cb48-1582"><a href="#cb48-1582" aria-hidden="true" tabindex="-1"></a>      <span class="at">modified             =</span> <span class="st">"http://purl.org/dc/terms/modified"</span> )),</span>
<span id="cb48-1583"><a href="#cb48-1583" aria-hidden="true" tabindex="-1"></a>  <span class="at">extendedmeasurementorfact =</span> <span class="fu">list</span>(</span>
<span id="cb48-1584"><a href="#cb48-1584" aria-hidden="true" tabindex="-1"></a>    <span class="at">rowType     =</span> <span class="st">"http://rs.iobis.org/obis/terms/ExtendedMeasurementOrFact"</span>,</span>
<span id="cb48-1585"><a href="#cb48-1585" aria-hidden="true" tabindex="-1"></a>    <span class="at">idField     =</span> <span class="st">"measurementID"</span>,</span>
<span id="cb48-1586"><a href="#cb48-1586" aria-hidden="true" tabindex="-1"></a>    <span class="at">coreIdField =</span> <span class="st">"eventID"</span>,  <span class="co"># Primary linking field</span></span>
<span id="cb48-1587"><a href="#cb48-1587" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms       =</span> <span class="fu">c</span>(</span>
<span id="cb48-1588"><a href="#cb48-1588" aria-hidden="true" tabindex="-1"></a>      <span class="at">eventID              =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/eventID"</span>,</span>
<span id="cb48-1589"><a href="#cb48-1589" aria-hidden="true" tabindex="-1"></a>      <span class="at">occurrenceID         =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/occurrenceID"</span>,</span>
<span id="cb48-1590"><a href="#cb48-1590" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementID        =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementID"</span>,</span>
<span id="cb48-1591"><a href="#cb48-1591" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementType      =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementType"</span>,</span>
<span id="cb48-1592"><a href="#cb48-1592" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementTypeID    =</span> <span class="st">"http://rs.iobis.org/obis/terms/measurementTypeID"</span>,</span>
<span id="cb48-1593"><a href="#cb48-1593" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementValue     =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementValue"</span>,</span>
<span id="cb48-1594"><a href="#cb48-1594" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementValueID   =</span> <span class="st">"http://rs.iobis.org/obis/terms/measurementValueID"</span>,</span>
<span id="cb48-1595"><a href="#cb48-1595" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementUnit      =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementUnit"</span>,</span>
<span id="cb48-1596"><a href="#cb48-1596" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementUnitID    =</span> <span class="st">"http://rs.iobis.org/obis/terms/measurementUnitID"</span>,</span>
<span id="cb48-1597"><a href="#cb48-1597" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementMethod    =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementMethod"</span>,</span>
<span id="cb48-1598"><a href="#cb48-1598" aria-hidden="true" tabindex="-1"></a>      <span class="at">measurementRemarks   =</span> <span class="st">"http://rs.tdwg.org/dwc/terms/measurementRemarks"</span> )))</span>
<span id="cb48-1599"><a href="#cb48-1599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1600"><a href="#cb48-1600" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to create field elements for meta.xml</span></span>
<span id="cb48-1601"><a href="#cb48-1601" aria-hidden="true" tabindex="-1"></a>create_field_elements <span class="ot">&lt;-</span> <span class="cf">function</span>(csv_file, term_map, <span class="at">coreid_field =</span> <span class="cn">NULL</span>) {</span>
<span id="cb48-1602"><a href="#cb48-1602" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read column names from CSV</span></span>
<span id="cb48-1603"><a href="#cb48-1603" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">read_csv</span>(csv_file, <span class="at">n_max =</span> <span class="dv">0</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>))</span>
<span id="cb48-1604"><a href="#cb48-1604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1605"><a href="#cb48-1605" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Map columns to DwC terms</span></span>
<span id="cb48-1606"><a href="#cb48-1606" aria-hidden="true" tabindex="-1"></a>  field_elements <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="fu">seq_along</span>(col_names), <span class="cf">function</span>(i) {</span>
<span id="cb48-1607"><a href="#cb48-1607" aria-hidden="true" tabindex="-1"></a>    col <span class="ot">&lt;-</span> col_names[i]</span>
<span id="cb48-1608"><a href="#cb48-1608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1609"><a href="#cb48-1609" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skip coreid column if specified (it's defined separately in &lt;coreid&gt; element)</span></span>
<span id="cb48-1610"><a href="#cb48-1610" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(coreid_field) <span class="sc">&amp;&amp;</span> col <span class="sc">==</span> coreid_field) {</span>
<span id="cb48-1611"><a href="#cb48-1611" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb48-1612"><a href="#cb48-1612" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb48-1613"><a href="#cb48-1613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1614"><a href="#cb48-1614" aria-hidden="true" tabindex="-1"></a>    term <span class="ot">&lt;-</span> term_map<span class="sc">$</span>terms[[col]]</span>
<span id="cb48-1615"><a href="#cb48-1615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1616"><a href="#cb48-1616" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(term)) {</span>
<span id="cb48-1617"><a href="#cb48-1617" aria-hidden="true" tabindex="-1"></a>      glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'    &lt;field index="{i-1}" term="{term}"/&gt;'</span>)</span>
<span id="cb48-1618"><a href="#cb48-1618" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb48-1619"><a href="#cb48-1619" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Field exists in CSV but not in DwC mapping - skip or warn</span></span>
<span id="cb48-1620"><a href="#cb48-1620" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Warning: Column '"</span>, col, <span class="st">"' in "</span>, csv_file, <span class="st">" has no DwC mapping and will be skipped in meta.xml."</span>)</span>
<span id="cb48-1621"><a href="#cb48-1621" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NULL</span></span>
<span id="cb48-1622"><a href="#cb48-1622" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb48-1623"><a href="#cb48-1623" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb48-1624"><a href="#cb48-1624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1625"><a href="#cb48-1625" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove NULL entries and combine</span></span>
<span id="cb48-1626"><a href="#cb48-1626" aria-hidden="true" tabindex="-1"></a>  field_elements <span class="ot">&lt;-</span> <span class="fu">compact</span>(field_elements)</span>
<span id="cb48-1627"><a href="#cb48-1627" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(field_elements, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb48-1628"><a href="#cb48-1628" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-1629"><a href="#cb48-1629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1630"><a href="#cb48-1630" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to determine coreID index</span></span>
<span id="cb48-1631"><a href="#cb48-1631" aria-hidden="true" tabindex="-1"></a>get_coreid_index <span class="ot">&lt;-</span> <span class="cf">function</span>(csv_file, coreid_field) {</span>
<span id="cb48-1632"><a href="#cb48-1632" aria-hidden="true" tabindex="-1"></a>  col_names <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">read_csv</span>(csv_file, <span class="at">n_max =</span> <span class="dv">0</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>))</span>
<span id="cb48-1633"><a href="#cb48-1633" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-1634"><a href="#cb48-1634" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Handle multiple possible coreID fields (eventID or occurrenceID)</span></span>
<span id="cb48-1635"><a href="#cb48-1635" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coreid_field) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb48-1636"><a href="#cb48-1636" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find which one exists in the CSV</span></span>
<span id="cb48-1637"><a href="#cb48-1637" aria-hidden="true" tabindex="-1"></a>    coreid_field <span class="ot">&lt;-</span> <span class="fu">intersect</span>(coreid_field, col_names)[<span class="dv">1</span>]</span>
<span id="cb48-1638"><a href="#cb48-1638" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb48-1639"><a href="#cb48-1639" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-1640"><a href="#cb48-1640" aria-hidden="true" tabindex="-1"></a>  <span class="fu">which</span>(col_names <span class="sc">==</span> coreid_field) <span class="sc">-</span> <span class="dv">1</span>  <span class="co"># 0-indexed</span></span>
<span id="cb48-1641"><a href="#cb48-1641" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-1642"><a href="#cb48-1642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1643"><a href="#cb48-1643" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate meta.xml content</span></span>
<span id="cb48-1644"><a href="#cb48-1644" aria-hidden="true" tabindex="-1"></a>generate_meta_xml <span class="ot">&lt;-</span> <span class="cf">function</span>(dir_out) {</span>
<span id="cb48-1645"><a href="#cb48-1645" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Core (Event)</span></span>
<span id="cb48-1646"><a href="#cb48-1646" aria-hidden="true" tabindex="-1"></a>  event_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"event.csv"</span>)</span>
<span id="cb48-1647"><a href="#cb48-1647" aria-hidden="true" tabindex="-1"></a>  event_fields <span class="ot">&lt;-</span> <span class="fu">create_field_elements</span>(event_file, dwc_terms<span class="sc">$</span>event)</span>
<span id="cb48-1648"><a href="#cb48-1648" aria-hidden="true" tabindex="-1"></a>  event_id_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">names</span>(<span class="fu">read_csv</span>(event_file, <span class="at">n_max =</span> <span class="dv">0</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)) <span class="sc">==</span></span>
<span id="cb48-1649"><a href="#cb48-1649" aria-hidden="true" tabindex="-1"></a>                          dwc_terms<span class="sc">$</span>event<span class="sc">$</span>idField) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb48-1650"><a href="#cb48-1650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1651"><a href="#cb48-1651" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extension: Occurrence</span></span>
<span id="cb48-1652"><a href="#cb48-1652" aria-hidden="true" tabindex="-1"></a>  occ_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"occurrence.csv"</span>)</span>
<span id="cb48-1653"><a href="#cb48-1653" aria-hidden="true" tabindex="-1"></a>  occ_fields <span class="ot">&lt;-</span> <span class="fu">create_field_elements</span>(occ_file, dwc_terms<span class="sc">$</span>occurrence, <span class="at">coreid_field =</span> dwc_terms<span class="sc">$</span>occurrence<span class="sc">$</span>coreIdField)</span>
<span id="cb48-1654"><a href="#cb48-1654" aria-hidden="true" tabindex="-1"></a>  occ_coreid_idx <span class="ot">&lt;-</span> <span class="fu">get_coreid_index</span>(occ_file, dwc_terms<span class="sc">$</span>occurrence<span class="sc">$</span>coreIdField)</span>
<span id="cb48-1655"><a href="#cb48-1655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1656"><a href="#cb48-1656" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extension: ExtendedMeasurementOrFact</span></span>
<span id="cb48-1657"><a href="#cb48-1657" aria-hidden="true" tabindex="-1"></a>  emof_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="st">"extendedMeasurementOrFact.csv"</span>)</span>
<span id="cb48-1658"><a href="#cb48-1658" aria-hidden="true" tabindex="-1"></a>  emof_fields <span class="ot">&lt;-</span> <span class="fu">create_field_elements</span>(emof_file, dwc_terms<span class="sc">$</span>extendedmeasurementorfact, <span class="at">coreid_field =</span> dwc_terms<span class="sc">$</span>extendedmeasurementorfact<span class="sc">$</span>coreIdField)</span>
<span id="cb48-1659"><a href="#cb48-1659" aria-hidden="true" tabindex="-1"></a>  emof_coreid_idx <span class="ot">&lt;-</span> <span class="fu">get_coreid_index</span>(emof_file, dwc_terms<span class="sc">$</span>extendedmeasurementorfact<span class="sc">$</span>coreIdField)</span>
<span id="cb48-1660"><a href="#cb48-1660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1661"><a href="#cb48-1661" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build complete meta.xml</span></span>
<span id="cb48-1662"><a href="#cb48-1662" aria-hidden="true" tabindex="-1"></a>  meta_xml <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">'&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span>
<span id="cb48-1663"><a href="#cb48-1663" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;archive xmlns="http://rs.tdwg.org/dwc/text/"</span></span>
<span id="cb48-1664"><a href="#cb48-1664" aria-hidden="true" tabindex="-1"></a><span class="st">         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</span></span>
<span id="cb48-1665"><a href="#cb48-1665" aria-hidden="true" tabindex="-1"></a><span class="st">         xsi:schemaLocation="http://rs.tdwg.org/dwc/text/ http://rs.tdwg.org/dwc/text/tdwg_dwc_text.xsd"&gt;</span></span>
<span id="cb48-1666"><a href="#cb48-1666" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;core encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="</span><span class="sc">\\</span><span class="st">n"</span></span>
<span id="cb48-1667"><a href="#cb48-1667" aria-hidden="true" tabindex="-1"></a><span class="st">        fieldsEnclosedBy=</span><span class="sc">\'</span><span class="st">"</span><span class="sc">\'</span><span class="st"> ignoreHeaderLines="1" rowType="{dwc_terms$event$rowType}"&gt;</span></span>
<span id="cb48-1668"><a href="#cb48-1668" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;files&gt;</span></span>
<span id="cb48-1669"><a href="#cb48-1669" aria-hidden="true" tabindex="-1"></a><span class="st">      &lt;location&gt;event.csv&lt;/location&gt;</span></span>
<span id="cb48-1670"><a href="#cb48-1670" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/files&gt;</span></span>
<span id="cb48-1671"><a href="#cb48-1671" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;id index="{event_id_idx}" /&gt;</span></span>
<span id="cb48-1672"><a href="#cb48-1672" aria-hidden="true" tabindex="-1"></a><span class="st">{event_fields}</span></span>
<span id="cb48-1673"><a href="#cb48-1673" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;/core&gt;</span></span>
<span id="cb48-1674"><a href="#cb48-1674" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="</span><span class="sc">\\</span><span class="st">n"</span></span>
<span id="cb48-1675"><a href="#cb48-1675" aria-hidden="true" tabindex="-1"></a><span class="st">             fieldsEnclosedBy=</span><span class="sc">\'</span><span class="st">"</span><span class="sc">\'</span><span class="st"> ignoreHeaderLines="1" rowType="{dwc_terms$occurrence$rowType}"&gt;</span></span>
<span id="cb48-1676"><a href="#cb48-1676" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;files&gt;</span></span>
<span id="cb48-1677"><a href="#cb48-1677" aria-hidden="true" tabindex="-1"></a><span class="st">      &lt;location&gt;occurrence.csv&lt;/location&gt;</span></span>
<span id="cb48-1678"><a href="#cb48-1678" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/files&gt;</span></span>
<span id="cb48-1679"><a href="#cb48-1679" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;coreid index="{occ_coreid_idx}" /&gt;</span></span>
<span id="cb48-1680"><a href="#cb48-1680" aria-hidden="true" tabindex="-1"></a><span class="st">{occ_fields}</span></span>
<span id="cb48-1681"><a href="#cb48-1681" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;/extension&gt;</span></span>
<span id="cb48-1682"><a href="#cb48-1682" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="</span><span class="sc">\\</span><span class="st">n"</span></span>
<span id="cb48-1683"><a href="#cb48-1683" aria-hidden="true" tabindex="-1"></a><span class="st">             fieldsEnclosedBy=</span><span class="sc">\'</span><span class="st">"</span><span class="sc">\'</span><span class="st"> ignoreHeaderLines="1" rowType="{dwc_terms$extendedmeasurementorfact$rowType}"&gt;</span></span>
<span id="cb48-1684"><a href="#cb48-1684" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;files&gt;</span></span>
<span id="cb48-1685"><a href="#cb48-1685" aria-hidden="true" tabindex="-1"></a><span class="st">      &lt;location&gt;extendedMeasurementOrFact.csv&lt;/location&gt;</span></span>
<span id="cb48-1686"><a href="#cb48-1686" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;/files&gt;</span></span>
<span id="cb48-1687"><a href="#cb48-1687" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;coreid index="{emof_coreid_idx}" /&gt;</span></span>
<span id="cb48-1688"><a href="#cb48-1688" aria-hidden="true" tabindex="-1"></a><span class="st">{emof_fields}</span></span>
<span id="cb48-1689"><a href="#cb48-1689" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;/extension&gt;</span></span>
<span id="cb48-1690"><a href="#cb48-1690" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/archive&gt;'</span>)</span>
<span id="cb48-1691"><a href="#cb48-1691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1692"><a href="#cb48-1692" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(meta_xml)</span>
<span id="cb48-1693"><a href="#cb48-1693" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-1694"><a href="#cb48-1694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1695"><a href="#cb48-1695" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate and write meta.xml</span></span>
<span id="cb48-1696"><a href="#cb48-1696" aria-hidden="true" tabindex="-1"></a>meta_xml <span class="ot">&lt;-</span> <span class="fu">generate_meta_xml</span>(dir_out)</span>
<span id="cb48-1697"><a href="#cb48-1697" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(meta_xml, <span class="fu">file.path</span>(dir_out, <span class="st">"meta.xml"</span>))</span>
<span id="cb48-1698"><a href="#cb48-1698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1699"><a href="#cb48-1699" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Generated meta.xml with field mappings:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb48-1700"><a href="#cb48-1700" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(meta_xml)</span>
<span id="cb48-1701"><a href="#cb48-1701" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-1702"><a href="#cb48-1702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1703"><a href="#cb48-1703" aria-hidden="true" tabindex="-1"></a><span class="fu">## Create EML Metadata</span></span>
<span id="cb48-1704"><a href="#cb48-1704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1707"><a href="#cb48-1707" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-1708"><a href="#cb48-1708" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: build-eml</span></span>
<span id="cb48-1709"><a href="#cb48-1709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1710"><a href="#cb48-1710" aria-hidden="true" tabindex="-1"></a><span class="co"># Geographic coverage</span></span>
<span id="cb48-1711"><a href="#cb48-1711" aria-hidden="true" tabindex="-1"></a>geo_coverage <span class="ot">&lt;-</span> tbl_site <span class="sc">|&gt;</span></span>
<span id="cb48-1712"><a href="#cb48-1712" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb48-1713"><a href="#cb48-1713" aria-hidden="true" tabindex="-1"></a>    <span class="at">westBoundingCoordinate  =</span> <span class="fu">min</span>(longitude, <span class="at">na.rm =</span> T),</span>
<span id="cb48-1714"><a href="#cb48-1714" aria-hidden="true" tabindex="-1"></a>    <span class="at">eastBoundingCoordinate  =</span> <span class="fu">max</span>(longitude, <span class="at">na.rm =</span> T),</span>
<span id="cb48-1715"><a href="#cb48-1715" aria-hidden="true" tabindex="-1"></a>    <span class="at">northBoundingCoordinate =</span> <span class="fu">max</span>(latitude,  <span class="at">na.rm =</span> T),</span>
<span id="cb48-1716"><a href="#cb48-1716" aria-hidden="true" tabindex="-1"></a>    <span class="at">southBoundingCoordinate =</span> <span class="fu">min</span>(latitude,  <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span> </span>
<span id="cb48-1717"><a href="#cb48-1717" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb48-1718"><a href="#cb48-1718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1719"><a href="#cb48-1719" aria-hidden="true" tabindex="-1"></a><span class="co"># Temporal coverage</span></span>
<span id="cb48-1720"><a href="#cb48-1720" aria-hidden="true" tabindex="-1"></a>temp_coverage <span class="ot">&lt;-</span> tbl_tow <span class="sc">|&gt;</span></span>
<span id="cb48-1721"><a href="#cb48-1721" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb48-1722"><a href="#cb48-1722" aria-hidden="true" tabindex="-1"></a>    <span class="at">beginDate =</span> <span class="fu">min</span>(time_start, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb48-1723"><a href="#cb48-1723" aria-hidden="true" tabindex="-1"></a>    <span class="at">endDate   =</span> <span class="fu">max</span>(time_start, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb48-1724"><a href="#cb48-1724" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb48-1725"><a href="#cb48-1725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1726"><a href="#cb48-1726" aria-hidden="true" tabindex="-1"></a><span class="co"># Taxonomic coverage</span></span>
<span id="cb48-1727"><a href="#cb48-1727" aria-hidden="true" tabindex="-1"></a>taxa_coverage <span class="ot">&lt;-</span> tbl_species <span class="sc">|&gt;</span></span>
<span id="cb48-1728"><a href="#cb48-1728" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(worms_id)) <span class="sc">|&gt;</span></span>
<span id="cb48-1729"><a href="#cb48-1729" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">scientificName =</span> scientific_name) <span class="sc">|&gt;</span></span>
<span id="cb48-1730"><a href="#cb48-1730" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span> </span>
<span id="cb48-1731"><a href="#cb48-1731" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.list</span>()</span>
<span id="cb48-1732"><a href="#cb48-1732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1733"><a href="#cb48-1733" aria-hidden="true" tabindex="-1"></a><span class="co"># Create EML document</span></span>
<span id="cb48-1734"><a href="#cb48-1734" aria-hidden="true" tabindex="-1"></a>my_eml <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb48-1735"><a href="#cb48-1735" aria-hidden="true" tabindex="-1"></a>  <span class="at">packageId =</span> dataset_id,</span>
<span id="cb48-1736"><a href="#cb48-1736" aria-hidden="true" tabindex="-1"></a>  <span class="at">system    =</span> <span class="st">"calcofi_db.{version}_{dataset}.{render-date}"</span>,</span>
<span id="cb48-1737"><a href="#cb48-1737" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="fu">list</span>(</span>
<span id="cb48-1738"><a href="#cb48-1738" aria-hidden="true" tabindex="-1"></a>    <span class="at">title   =</span> dataset_title,</span>
<span id="cb48-1739"><a href="#cb48-1739" aria-hidden="true" tabindex="-1"></a>    <span class="at">creator =</span> <span class="fu">list</span>(</span>
<span id="cb48-1740"><a href="#cb48-1740" aria-hidden="true" tabindex="-1"></a>      <span class="at">individualName =</span> <span class="fu">list</span>(</span>
<span id="cb48-1741"><a href="#cb48-1741" aria-hidden="true" tabindex="-1"></a>        <span class="at">givenName =</span> <span class="st">"Ed"</span>,</span>
<span id="cb48-1742"><a href="#cb48-1742" aria-hidden="true" tabindex="-1"></a>        <span class="at">surName   =</span> <span class="st">"Weber"</span>),</span>
<span id="cb48-1743"><a href="#cb48-1743" aria-hidden="true" tabindex="-1"></a>    <span class="at">organizationName      =</span> <span class="st">"NOAA SWFSC"</span>,</span>
<span id="cb48-1744"><a href="#cb48-1744" aria-hidden="true" tabindex="-1"></a>    <span class="at">electronicMailAddress =</span> <span class="st">"ed.weber@noaa.gov"</span>,</span>
<span id="cb48-1745"><a href="#cb48-1745" aria-hidden="true" tabindex="-1"></a>      <span class="at">userId =</span> <span class="fu">list</span>(</span>
<span id="cb48-1746"><a href="#cb48-1746" aria-hidden="true" tabindex="-1"></a>        <span class="at">directory =</span> <span class="st">"https://orcid.org/"</span>,</span>
<span id="cb48-1747"><a href="#cb48-1747" aria-hidden="true" tabindex="-1"></a>        <span class="at">userId =</span> <span class="st">"0000-0002-0942-434X"</span>) ),</span>
<span id="cb48-1748"><a href="#cb48-1748" aria-hidden="true" tabindex="-1"></a>    <span class="at">abstract =</span> dataset_abstract,</span>
<span id="cb48-1749"><a href="#cb48-1749" aria-hidden="true" tabindex="-1"></a>    <span class="at">keywordSet =</span> <span class="fu">list</span>(</span>
<span id="cb48-1750"><a href="#cb48-1750" aria-hidden="true" tabindex="-1"></a>      <span class="at">keyword          =</span> dataset_keywords,</span>
<span id="cb48-1751"><a href="#cb48-1751" aria-hidden="true" tabindex="-1"></a>      <span class="at">keywordThesaurus =</span> <span class="st">"GCMD Science Keywords"</span>),</span>
<span id="cb48-1752"><a href="#cb48-1752" aria-hidden="true" tabindex="-1"></a>    <span class="at">coverage =</span> <span class="fu">list</span>(</span>
<span id="cb48-1753"><a href="#cb48-1753" aria-hidden="true" tabindex="-1"></a>      <span class="at">geographicCoverage =</span> <span class="fu">list</span>(</span>
<span id="cb48-1754"><a href="#cb48-1754" aria-hidden="true" tabindex="-1"></a>        <span class="at">geographicDescription =</span> <span class="st">"California Current Large Marine Ecoregion"</span>,</span>
<span id="cb48-1755"><a href="#cb48-1755" aria-hidden="true" tabindex="-1"></a>        <span class="at">boundingCoordinates   =</span> geo_coverage),</span>
<span id="cb48-1756"><a href="#cb48-1756" aria-hidden="true" tabindex="-1"></a>      <span class="at">temporalCoverage =</span> <span class="fu">list</span>(</span>
<span id="cb48-1757"><a href="#cb48-1757" aria-hidden="true" tabindex="-1"></a>        <span class="at">rangeOfDates =</span> <span class="fu">list</span>(</span>
<span id="cb48-1758"><a href="#cb48-1758" aria-hidden="true" tabindex="-1"></a>          <span class="at">beginDate =</span> <span class="fu">list</span>(<span class="at">calendarDate =</span> <span class="fu">as.character</span>(temp_coverage<span class="sc">$</span>beginDate)),</span>
<span id="cb48-1759"><a href="#cb48-1759" aria-hidden="true" tabindex="-1"></a>          <span class="at">endDate   =</span> <span class="fu">list</span>(<span class="at">calendarDate =</span> <span class="fu">as.character</span>(temp_coverage<span class="sc">$</span>endDate)) )),</span>
<span id="cb48-1760"><a href="#cb48-1760" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxonomicCoverage =</span> <span class="fu">list</span>(</span>
<span id="cb48-1761"><a href="#cb48-1761" aria-hidden="true" tabindex="-1"></a>        <span class="at">generalTaxonomicCoverage =</span> <span class="st">"Marine ichthyoplankton and fish eggs"</span>,</span>
<span id="cb48-1762"><a href="#cb48-1762" aria-hidden="true" tabindex="-1"></a>        <span class="at">taxonomicClassification =</span> taxa_coverage )),</span>
<span id="cb48-1763"><a href="#cb48-1763" aria-hidden="true" tabindex="-1"></a>    <span class="at">contact =</span> <span class="fu">list</span>(</span>
<span id="cb48-1764"><a href="#cb48-1764" aria-hidden="true" tabindex="-1"></a>      <span class="at">individualName =</span> <span class="fu">list</span>(</span>
<span id="cb48-1765"><a href="#cb48-1765" aria-hidden="true" tabindex="-1"></a>        <span class="at">givenName =</span> <span class="st">"Ed"</span>,</span>
<span id="cb48-1766"><a href="#cb48-1766" aria-hidden="true" tabindex="-1"></a>        <span class="at">surName   =</span> <span class="st">"Weber"</span>),</span>
<span id="cb48-1767"><a href="#cb48-1767" aria-hidden="true" tabindex="-1"></a>      <span class="at">electronicMailAddress =</span> <span class="st">"ed.weber@noaa.gov"</span>),</span>
<span id="cb48-1768"><a href="#cb48-1768" aria-hidden="true" tabindex="-1"></a>    <span class="at">methods =</span> <span class="fu">list</span>(</span>
<span id="cb48-1769"><a href="#cb48-1769" aria-hidden="true" tabindex="-1"></a>      <span class="at">methodStep =</span> <span class="fu">list</span>(</span>
<span id="cb48-1770"><a href="#cb48-1770" aria-hidden="true" tabindex="-1"></a>        <span class="at">description =</span> <span class="fu">list</span>(</span>
<span id="cb48-1771"><a href="#cb48-1771" aria-hidden="true" tabindex="-1"></a>          <span class="at">para =</span> <span class="st">"[SAMPLING METHODS DESCRIPTION]"</span> )), <span class="co"># </span><span class="al">TODO</span><span class="co">: sampling methods</span></span>
<span id="cb48-1772"><a href="#cb48-1772" aria-hidden="true" tabindex="-1"></a>      <span class="at">sampling =</span> <span class="fu">list</span>(</span>
<span id="cb48-1773"><a href="#cb48-1773" aria-hidden="true" tabindex="-1"></a>        <span class="at">studyExtent =</span> <span class="fu">list</span>(</span>
<span id="cb48-1774"><a href="#cb48-1774" aria-hidden="true" tabindex="-1"></a>          <span class="at">description =</span> <span class="fu">list</span>(</span>
<span id="cb48-1775"><a href="#cb48-1775" aria-hidden="true" tabindex="-1"></a>            <span class="at">para =</span> <span class="st">"[STUDY EXTENT DESCRIPTION]"</span>)),    <span class="co"># </span><span class="al">TODO</span><span class="co">: study extent</span></span>
<span id="cb48-1776"><a href="#cb48-1776" aria-hidden="true" tabindex="-1"></a>        <span class="at">samplingDescription =</span> <span class="fu">list</span>(</span>
<span id="cb48-1777"><a href="#cb48-1777" aria-hidden="true" tabindex="-1"></a>          <span class="at">para =</span> <span class="st">"[SAMPLING DESCRIPTION]"</span> ))),        <span class="co"># </span><span class="al">TODO</span><span class="co">: sampling</span></span>
<span id="cb48-1778"><a href="#cb48-1778" aria-hidden="true" tabindex="-1"></a>    <span class="at">project =</span> <span class="fu">list</span>(</span>
<span id="cb48-1779"><a href="#cb48-1779" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> dataset_title,                          <span class="co"># </span><span class="al">TODO</span><span class="co">: project title?</span></span>
<span id="cb48-1780"><a href="#cb48-1780" aria-hidden="true" tabindex="-1"></a>      <span class="at">personnel =</span> <span class="fu">list</span>(</span>
<span id="cb48-1781"><a href="#cb48-1781" aria-hidden="true" tabindex="-1"></a>        <span class="at">individualName =</span> <span class="fu">list</span>(</span>
<span id="cb48-1782"><a href="#cb48-1782" aria-hidden="true" tabindex="-1"></a>          <span class="at">givenName =</span> <span class="st">"Ed"</span>,                           <span class="co"># </span><span class="al">TODO</span><span class="co">: PI?</span></span>
<span id="cb48-1783"><a href="#cb48-1783" aria-hidden="true" tabindex="-1"></a>          <span class="at">surName   =</span> <span class="st">"Weber"</span> ),</span>
<span id="cb48-1784"><a href="#cb48-1784" aria-hidden="true" tabindex="-1"></a>        <span class="at">role =</span> <span class="st">"Principal Investigator"</span>),</span>
<span id="cb48-1785"><a href="#cb48-1785" aria-hidden="true" tabindex="-1"></a>      <span class="at">funding =</span> <span class="fu">list</span>(</span>
<span id="cb48-1786"><a href="#cb48-1786" aria-hidden="true" tabindex="-1"></a>        <span class="at">para =</span> <span class="st">"[FUNDING INFORMATION]"</span> ))))          <span class="co"># </span><span class="al">TODO</span><span class="co">: Funding</span></span>
<span id="cb48-1787"><a href="#cb48-1787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1788"><a href="#cb48-1788" aria-hidden="true" tabindex="-1"></a><span class="co"># Write EML</span></span>
<span id="cb48-1789"><a href="#cb48-1789" aria-hidden="true" tabindex="-1"></a><span class="fu">write_eml</span>(my_eml, <span class="fu">file.path</span>(dir_out, <span class="st">"eml.xml"</span>))</span>
<span id="cb48-1790"><a href="#cb48-1790" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-1791"><a href="#cb48-1791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1792"><a href="#cb48-1792" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Quality Checks</span></span>
<span id="cb48-1793"><a href="#cb48-1793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1796"><a href="#cb48-1796" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-1797"><a href="#cb48-1797" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check-data-quality</span></span>
<span id="cb48-1798"><a href="#cb48-1798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1799"><a href="#cb48-1799" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for missing WoRMS IDs</span></span>
<span id="cb48-1800"><a href="#cb48-1800" aria-hidden="true" tabindex="-1"></a>d_missing_worms <span class="ot">&lt;-</span> tbl_species <span class="sc">|&gt;</span></span>
<span id="cb48-1801"><a href="#cb48-1801" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(worms_id)) <span class="sc">|&gt;</span></span>
<span id="cb48-1802"><a href="#cb48-1802" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(species_id, scientific_name) <span class="sc">|&gt;</span> </span>
<span id="cb48-1803"><a href="#cb48-1803" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb48-1804"><a href="#cb48-1804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1805"><a href="#cb48-1805" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(d_missing_worms) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb48-1806"><a href="#cb48-1806" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"WARNING: The following species are missing WoRMS IDs:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb48-1807"><a href="#cb48-1807" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(d_missing_worms)</span>
<span id="cb48-1808"><a href="#cb48-1808" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Please add WoRMS AphiaIDs for these species before finalizing the dataset.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb48-1809"><a href="#cb48-1809" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-1810"><a href="#cb48-1810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1811"><a href="#cb48-1811" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for orphan records</span></span>
<span id="cb48-1812"><a href="#cb48-1812" aria-hidden="true" tabindex="-1"></a>d_orphan_occurrences <span class="ot">&lt;-</span> q_occurrence_extension <span class="sc">|&gt;</span></span>
<span id="cb48-1813"><a href="#cb48-1813" aria-hidden="true" tabindex="-1"></a>  <span class="fu">anti_join</span>(q_event_core, <span class="at">by =</span> <span class="st">"eventID"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb48-1814"><a href="#cb48-1814" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb48-1815"><a href="#cb48-1815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1816"><a href="#cb48-1816" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(d_orphan_occurrences) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb48-1817"><a href="#cb48-1817" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">WARNING: Found"</span>, <span class="fu">nrow</span>(d_orphan_occurrences), <span class="st">"occurrence records without matching events.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb48-1818"><a href="#cb48-1818" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-1819"><a href="#cb48-1819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1820"><a href="#cb48-1820" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics</span></span>
<span id="cb48-1821"><a href="#cb48-1821" aria-hidden="true" tabindex="-1"></a>n_events   <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb48-1822"><a href="#cb48-1822" aria-hidden="true" tabindex="-1"></a>n_events   <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"net_sample"</span>) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb48-1823"><a href="#cb48-1823" aria-hidden="true" tabindex="-1"></a>n_cruises  <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"cruise"</span>)     <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb48-1824"><a href="#cb48-1824" aria-hidden="true" tabindex="-1"></a>n_sites    <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"site"</span>)       <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb48-1825"><a href="#cb48-1825" aria-hidden="true" tabindex="-1"></a>n_tows     <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"tow"</span>)        <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb48-1826"><a href="#cb48-1826" aria-hidden="true" tabindex="-1"></a>n_nets     <span class="ot">&lt;-</span> q_event_core <span class="sc">|&gt;</span> <span class="fu">filter</span>(eventType <span class="sc">==</span> <span class="st">"net_sample"</span>) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb48-1827"><a href="#cb48-1827" aria-hidden="true" tabindex="-1"></a>n_occs     <span class="ot">&lt;-</span> q_occurrence_extension <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb48-1828"><a href="#cb48-1828" aria-hidden="true" tabindex="-1"></a>n_species  <span class="ot">&lt;-</span> q_occurrence_extension <span class="sc">|&gt;</span> <span class="fu">distinct</span>(scientificName) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>(n)</span>
<span id="cb48-1829"><a href="#cb48-1829" aria-hidden="true" tabindex="-1"></a>n_measures <span class="ot">&lt;-</span> d_extendedmeasurementorfact_extension <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb48-1830"><a href="#cb48-1830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1831"><a href="#cb48-1831" aria-hidden="true" tabindex="-1"></a><span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb48-1832"><a href="#cb48-1832" aria-hidden="true" tabindex="-1"></a><span class="st">  === Dataset Summary ===</span></span>
<span id="cb48-1833"><a href="#cb48-1833" aria-hidden="true" tabindex="-1"></a><span class="st">  Total events:        {prettyNum(n_events, big.mark = ',')}</span></span>
<span id="cb48-1834"><a href="#cb48-1834" aria-hidden="true" tabindex="-1"></a><span class="st">  - Cruises:           {prettyNum(n_cruises, big.mark = ',')}</span></span>
<span id="cb48-1835"><a href="#cb48-1835" aria-hidden="true" tabindex="-1"></a><span class="st">  - Sites:             {prettyNum(n_sites, big.mark = ',')}</span></span>
<span id="cb48-1836"><a href="#cb48-1836" aria-hidden="true" tabindex="-1"></a><span class="st">  - Tows:              {prettyNum(n_tows, big.mark = ',')}</span></span>
<span id="cb48-1837"><a href="#cb48-1837" aria-hidden="true" tabindex="-1"></a><span class="st">  - Net samples:       {prettyNum(n_nets, big.mark = ',')}</span></span>
<span id="cb48-1838"><a href="#cb48-1838" aria-hidden="true" tabindex="-1"></a><span class="st">  Total occurrences:   {prettyNum(n_occs, big.mark = ',')}</span></span>
<span id="cb48-1839"><a href="#cb48-1839" aria-hidden="true" tabindex="-1"></a><span class="st">  Total species:       {prettyNum(n_species, big.mark = ',')}</span></span>
<span id="cb48-1840"><a href="#cb48-1840" aria-hidden="true" tabindex="-1"></a><span class="st">  Total measurements:  {prettyNum(n_measures, big.mark = ',')}"</span>)</span>
<span id="cb48-1841"><a href="#cb48-1841" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-1842"><a href="#cb48-1842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1843"><a href="#cb48-1843" aria-hidden="true" tabindex="-1"></a><span class="fu">## Package Creation</span></span>
<span id="cb48-1844"><a href="#cb48-1844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1847"><a href="#cb48-1847" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-1848"><a href="#cb48-1848" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: create-dwc-archive</span></span>
<span id="cb48-1849"><a href="#cb48-1849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1850"><a href="#cb48-1850" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DwC-A zip file</span></span>
<span id="cb48-1851"><a href="#cb48-1851" aria-hidden="true" tabindex="-1"></a>zip_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_out, <span class="fu">paste0</span>(<span class="st">"../larvae_"</span>, <span class="fu">Sys.Date</span>(), <span class="st">".zip"</span>))</span>
<span id="cb48-1852"><a href="#cb48-1852" aria-hidden="true" tabindex="-1"></a><span class="fu">zip</span>(zip_file,</span>
<span id="cb48-1853"><a href="#cb48-1853" aria-hidden="true" tabindex="-1"></a>    <span class="at">files =</span> <span class="fu">file.path</span>(</span>
<span id="cb48-1854"><a href="#cb48-1854" aria-hidden="true" tabindex="-1"></a>      dir_out, <span class="fu">c</span>(</span>
<span id="cb48-1855"><a href="#cb48-1855" aria-hidden="true" tabindex="-1"></a>        <span class="st">"event.csv"</span>, <span class="st">"occurrence.csv"</span>,</span>
<span id="cb48-1856"><a href="#cb48-1856" aria-hidden="true" tabindex="-1"></a>        <span class="st">"extendedMeasurementOrFact.csv"</span>, <span class="st">"meta.xml"</span>, <span class="st">"eml.xml"</span>)),</span>
<span id="cb48-1857"><a href="#cb48-1857" aria-hidden="true" tabindex="-1"></a>      <span class="at">flags =</span> <span class="st">"-j"</span>) <span class="co"># exclude parent folders</span></span>
<span id="cb48-1858"><a href="#cb48-1858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1859"><a href="#cb48-1859" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Darwin Core Archive created:"</span>, zip_file, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb48-1860"><a href="#cb48-1860" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-1861"><a href="#cb48-1861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1862"><a href="#cb48-1862" aria-hidden="true" tabindex="-1"></a><span class="fu">## Check CSV</span></span>
<span id="cb48-1863"><a href="#cb48-1863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1866"><a href="#cb48-1866" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb48-1867"><a href="#cb48-1867" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check-csv</span></span>
<span id="cb48-1868"><a href="#cb48-1868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1869"><a href="#cb48-1869" aria-hidden="true" tabindex="-1"></a>d_event      <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(dir_out, <span class="st">"event.csv"</span>))</span>
<span id="cb48-1870"><a href="#cb48-1870" aria-hidden="true" tabindex="-1"></a>d_occurrence <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(dir_out, <span class="st">"occurrence.csv"</span>))</span>
<span id="cb48-1871"><a href="#cb48-1871" aria-hidden="true" tabindex="-1"></a>d_emof       <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(dir_out, <span class="st">"extendedMeasurementOrFact.csv"</span>))</span>
<span id="cb48-1872"><a href="#cb48-1872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1873"><a href="#cb48-1873" aria-hidden="true" tabindex="-1"></a>d_event</span>
<span id="cb48-1874"><a href="#cb48-1874" aria-hidden="true" tabindex="-1"></a>d_occurrence</span>
<span id="cb48-1875"><a href="#cb48-1875" aria-hidden="true" tabindex="-1"></a>d_emof</span>
<span id="cb48-1876"><a href="#cb48-1876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1877"><a href="#cb48-1877" aria-hidden="true" tabindex="-1"></a>d_emof <span class="sc">|&gt;</span> <span class="fu">select</span>(measurementType, measurementUnit) <span class="sc">|&gt;</span> <span class="fu">table</span>(<span class="at">useNA =</span> <span class="st">"ifany"</span>)</span>
<span id="cb48-1878"><a href="#cb48-1878" aria-hidden="true" tabindex="-1"></a><span class="co">#                              measurementUnit</span></span>
<span id="cb48-1879"><a href="#cb48-1879" aria-hidden="true" tabindex="-1"></a><span class="co"># measurementType               dimensionless  grams individuals millimeters</span></span>
<span id="cb48-1880"><a href="#cb48-1880" aria-hidden="true" tabindex="-1"></a><span class="co">#   abundance by life stage                 0      0      125347           0</span></span>
<span id="cb48-1881"><a href="#cb48-1881" aria-hidden="true" tabindex="-1"></a><span class="co">#   body length                             0      0           0      241871</span></span>
<span id="cb48-1882"><a href="#cb48-1882" aria-hidden="true" tabindex="-1"></a><span class="co">#   proportion of sample sorted         76512      0           0           0</span></span>
<span id="cb48-1883"><a href="#cb48-1883" aria-hidden="true" tabindex="-1"></a><span class="co">#   small plankton biomass                  0  45287           0           0</span></span>
<span id="cb48-1884"><a href="#cb48-1884" aria-hidden="true" tabindex="-1"></a><span class="co">#   standardized haul factor            76512      0           0           0</span></span>
<span id="cb48-1885"><a href="#cb48-1885" aria-hidden="true" tabindex="-1"></a><span class="co">#   total plankton biomass                  0  45287           0           0</span></span>
<span id="cb48-1886"><a href="#cb48-1886" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-1887"><a href="#cb48-1887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1888"><a href="#cb48-1888" aria-hidden="true" tabindex="-1"></a><span class="fu">## History of loading into IPT</span></span>
<span id="cb48-1889"><a href="#cb48-1889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1890"><a href="#cb48-1890" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2025-11-11: Second attempt after aligning to OBIS extendedMeasurementOrFact</span></span>
<span id="cb48-1891"><a href="#cb48-1891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1892"><a href="#cb48-1892" aria-hidden="true" tabindex="-1"></a><span class="al">![Messages from loading into IPT as "Sampling evet" on 2025-11-11](./figures/ipt-load-messages_2025-11-11.png)</span></span>
<span id="cb48-1893"><a href="#cb48-1893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1894"><a href="#cb48-1894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1895"><a href="#cb48-1895" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2025-11-10: First attempt to load into GBIF IPT as "Sampling evet" dataset</span></span>
<span id="cb48-1896"><a href="#cb48-1896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1897"><a href="#cb48-1897" aria-hidden="true" tabindex="-1"></a><span class="al">![Messages from loading into IPT as "Sampling evet" on 2025-11-10](./figures/ipt-load-messages_2025-11-10.png)</span></span>
<span id="cb48-1898"><a href="#cb48-1898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1899"><a href="#cb48-1899" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - Skipped mapped term http://rs.tdwg.org/dwc/terms/occurrencelD, which is unknown to extension http://rs.tdwg.org/dwc/terms/MeasurementOrFact</span></span>
<span id="cb48-1900"><a href="#cb48-1900" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; - Skipped mapped term http://rs.tdwg.org/dwc/terms/eventID, which is unknown to extension http://rs.tdwg.org/dwc/terms/MeasurementOrFact</span></span>
<span id="cb48-1901"><a href="#cb48-1901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1902"><a href="#cb48-1902" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>🤔 But <span class="in">`EventID`</span> (vs <span class="in">`eventID`</span>?) clearly is supposed to link <span class="in">`measurementorfact`</span> to <span class="in">`event`</span> to <span class="in">`occurrence`</span>, per <span class="co">[</span><span class="ot">Example: Brackish water invertebrates survey -- Best Practices in Publishing Sampling-event data :: GBIF IPT User Manual</span><span class="co">](https://ipt.gbif.org/manual/en/ipt/latest/best-practices-sampling-event-data#brackish-water-invertebrates-survey)</span>.</span>
<span id="cb48-1903"><a href="#cb48-1903" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>TODO: try renaming <span class="in">`eventID`</span> to <span class="in">`EventID`</span> in all 3 files and re-uploading to IPT.</span>
<span id="cb48-1904"><a href="#cb48-1904" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Prompt: Help debug GBIF IPT response to loading a Sampling event DarwinCore dataset package from zip generated by @publish_larvae_to_obis.qmd: "Skipped mapped term http://rs.tdwg.org/dwc/terms/eventID, which is unknown to extension http://rs.tdwg.org/dwc/terms/MeasurementOrFact"</span>
<span id="cb48-1905"><a href="#cb48-1905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1906"><a href="#cb48-1906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1907"><a href="#cb48-1907" aria-hidden="true" tabindex="-1"></a><span class="fu">## Questions</span></span>
<span id="cb48-1908"><a href="#cb48-1908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1909"><a href="#cb48-1909" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`datasetID`</span>: </span>
<span id="cb48-1910"><a href="#cb48-1910" aria-hidden="true" tabindex="-1"></a>  https://manual.obis.org/examples.html -&gt; datasetID: https://marineinfo.org/id/dataset/6403</span>
<span id="cb48-1911"><a href="#cb48-1911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1912"><a href="#cb48-1912" aria-hidden="true" tabindex="-1"></a><span class="fu">## Required Information Prompts</span></span>
<span id="cb48-1913"><a href="#cb48-1913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1914"><a href="#cb48-1914" aria-hidden="true" tabindex="-1"></a>Please provide the following information to complete the DarwinCore package:</span>
<span id="cb48-1915"><a href="#cb48-1915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1916"><a href="#cb48-1916" aria-hidden="true" tabindex="-1"></a><span class="fu">### Dataset Information</span></span>
<span id="cb48-1917"><a href="#cb48-1917" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Dataset title</span>
<span id="cb48-1918"><a href="#cb48-1918" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Dataset abstract (200-500 words describing the dataset)</span>
<span id="cb48-1919"><a href="#cb48-1919" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Keywords (3-5 relevant keywords)</span>
<span id="cb48-1920"><a href="#cb48-1920" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Country code (ISO 3166-1 alpha-2)</span>
<span id="cb48-1921"><a href="#cb48-1921" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Water body name</span>
<span id="cb48-1922"><a href="#cb48-1922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1923"><a href="#cb48-1923" aria-hidden="true" tabindex="-1"></a><span class="fu">### Personnel Information</span></span>
<span id="cb48-1924"><a href="#cb48-1924" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Dataset creator name and ORCID</span>
<span id="cb48-1925"><a href="#cb48-1925" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Creator organization</span>
<span id="cb48-1926"><a href="#cb48-1926" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Creator email</span>
<span id="cb48-1927"><a href="#cb48-1927" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Dataset contact name and email</span>
<span id="cb48-1928"><a href="#cb48-1928" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Principal investigator name</span>
<span id="cb48-1929"><a href="#cb48-1929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1930"><a href="#cb48-1930" aria-hidden="true" tabindex="-1"></a><span class="fu">### Project Information</span></span>
<span id="cb48-1931"><a href="#cb48-1931" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Project title</span>
<span id="cb48-1932"><a href="#cb48-1932" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Funding information (agency and grant numbers)</span>
<span id="cb48-1933"><a href="#cb48-1933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1934"><a href="#cb48-1934" aria-hidden="true" tabindex="-1"></a><span class="fu">### Methodology</span></span>
<span id="cb48-1935"><a href="#cb48-1935" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Detailed sampling methods description</span>
<span id="cb48-1936"><a href="#cb48-1936" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Study extent description</span>
<span id="cb48-1937"><a href="#cb48-1937" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Sampling design and protocols</span>
<span id="cb48-1938"><a href="#cb48-1938" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Measurement methods for environmental variables</span>
<span id="cb48-1939"><a href="#cb48-1939" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Size measurement methods for larvae</span>
<span id="cb48-1940"><a href="#cb48-1940" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Taxonomist name(s) who identified specimens</span>
<span id="cb48-1941"><a href="#cb48-1941" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Identification date(s)</span>
<span id="cb48-1942"><a href="#cb48-1942" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Identification references used</span>
<span id="cb48-1943"><a href="#cb48-1943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1944"><a href="#cb48-1944" aria-hidden="true" tabindex="-1"></a><span class="fu">### Geographic Information</span></span>
<span id="cb48-1945"><a href="#cb48-1945" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Geographic description of the study area</span>
<span id="cb48-1946"><a href="#cb48-1946" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> GPS accuracy (coordinate uncertainty in meters)</span>
<span id="cb48-1947"><a href="#cb48-1947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1948"><a href="#cb48-1948" aria-hidden="true" tabindex="-1"></a>Once this information is provided, update the placeholders marked with <span class="co">[</span><span class="ot">NEED ...</span><span class="co">]</span> in the code above.</span>
<span id="cb48-1949"><a href="#cb48-1949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1950"><a href="#cb48-1950" aria-hidden="true" tabindex="-1"></a><span class="fu">## TODO</span></span>
<span id="cb48-1951"><a href="#cb48-1951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1952"><a href="#cb48-1952" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> drop <span class="in">`lifeStageID`</span> (does not exist) and make **eMoF** like <span class="co">[</span><span class="ot">"Lifestage" in 16 Dataset Examples: ENV-DATA | The OBIS Manual</span><span class="co">]</span>(https://manual.obis.org/examples.html#:~:text=TripNR3242TripStationNR16781MidasTripActionID105598occurenceIDTA_105598_(Pseudo%2D)pediastrum_5-,Lifestage,-http%3A//vocab.nerc):</span>
<span id="cb48-1953"><a href="#cb48-1953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-1954"><a href="#cb48-1954" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`measurementType`</span>: "Lifestage"</span>
<span id="cb48-1955"><a href="#cb48-1955" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`measurementTypeID`</span>: "http://vocab.nerc.ac.uk/collection/P01/current/LSTAGE01/"</span>
<span id="cb48-1956"><a href="#cb48-1956" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`measurementValue`</span>: "adult" </span>
<span id="cb48-1957"><a href="#cb48-1957" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`measurementValueID`</span>: "http://vocab.nerc.ac.uk/collection/S11/current/S1116/"</span>
<span id="cb48-1958"><a href="#cb48-1958" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`measurementUnit`</span>:  </span>
<span id="cb48-1959"><a href="#cb48-1959" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`measurementUnitID`</span>: </span>
<span id="cb48-1960"><a href="#cb48-1960" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`measurementDeterminedBy`</span>: "Flanders Marine Institute"</span>
<span id="cb48-1961"><a href="#cb48-1961" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`measurementMethod`</span>: "identified and counted by image analysis and normalised to a unit volume of water body, validated by human"</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>