<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2026-02-24">

<title>Merge Ichthyo &amp; Bottle to Working DuckLake</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="merge_ichthyo_bottle_files/libs/clipboard/clipboard.min.js"></script>
<script src="merge_ichthyo_bottle_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="merge_ichthyo_bottle_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="merge_ichthyo_bottle_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="merge_ichthyo_bottle_files/libs/quarto-html/popper.min.js"></script>
<script src="merge_ichthyo_bottle_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="merge_ichthyo_bottle_files/libs/quarto-html/anchor.min.js"></script>
<link href="merge_ichthyo_bottle_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="merge_ichthyo_bottle_files/libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="merge_ichthyo_bottle_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="merge_ichthyo_bottle_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="merge_ichthyo_bottle_files/libs/bootstrap/bootstrap-d6a003b94517c951b2d65075d42fb01b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="merge_ichthyo_bottle_files/libs/quarto-diagram/mermaid.min.js"></script>
<script src="merge_ichthyo_bottle_files/libs/quarto-diagram/mermaid-init.js"></script>
<link href="merge_ichthyo_bottle_files/libs/quarto-diagram/mermaid.css" rel="stylesheet">
<link href="merge_ichthyo_bottle_files/libs/htmltools-fill-0.5.9/fill.css" rel="stylesheet">
<script src="merge_ichthyo_bottle_files/libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="merge_ichthyo_bottle_files/libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="merge_ichthyo_bottle_files/libs/datatables-binding-0.34.0/datatables.js"></script>
<script src="merge_ichthyo_bottle_files/libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="merge_ichthyo_bottle_files/libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="merge_ichthyo_bottle_files/libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="merge_ichthyo_bottle_files/libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="merge_ichthyo_bottle_files/libs/crosstalk-1.2.2/css/crosstalk.min.css" rel="stylesheet">
<script src="merge_ichthyo_bottle_files/libs/crosstalk-1.2.2/js/crosstalk.min.js"></script>
<script src="merge_ichthyo_bottle_files/libs/viz-1.8.2/viz.js"></script>
<link href="merge_ichthyo_bottle_files/libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="merge_ichthyo_bottle_files/libs/grViz-binding-1.0.11/grViz.js"></script>


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup"><span class="header-section-number">0.1</span> Setup</a></li>
  <li><a href="#check-upstream-workflows" id="toc-check-upstream-workflows" class="nav-link" data-scroll-target="#check-upstream-workflows"><span class="header-section-number">0.2</span> Check Upstream Workflows</a></li>
  <li><a href="#load-swfsc-tables" id="toc-load-swfsc-tables" class="nav-link" data-scroll-target="#load-swfsc-tables"><span class="header-section-number">0.3</span> Load SWFSC Tables</a></li>
  <li><a href="#load-bottle-tables" id="toc-load-bottle-tables" class="nav-link" data-scroll-target="#load-bottle-tables"><span class="header-section-number">0.4</span> Load Bottle Tables</a></li>
  <li><a href="#show-loaded-tables" id="toc-show-loaded-tables" class="nav-link" data-scroll-target="#show-loaded-tables"><span class="header-section-number">0.5</span> Show Loaded Tables</a></li>
  <li><a href="#fuzzy-ship-matching" id="toc-fuzzy-ship-matching" class="nav-link" data-scroll-target="#fuzzy-ship-matching"><span class="header-section-number">0.6</span> Fuzzy Ship Matching</a>
  <ul>
  <li><a href="#match-statistics" id="toc-match-statistics" class="nav-link" data-scroll-target="#match-statistics"><span class="header-section-number">0.6.1</span> Match Statistics</a></li>
  </ul></li>
  <li><a href="#build-cruise-bridge" id="toc-build-cruise-bridge" class="nav-link" data-scroll-target="#build-cruise-bridge"><span class="header-section-number">0.7</span> Build Cruise Bridge</a>
  <ul>
  <li><a href="#step-1-add-ship_key-to-casts" id="toc-step-1-add-ship_key-to-casts" class="nav-link" data-scroll-target="#step-1-add-ship_key-to-casts"><span class="header-section-number">0.7.1</span> Step 1: Add ship_key to casts</a></li>
  <li><a href="#step-2-derive-cruise_key" id="toc-step-2-derive-cruise_key" class="nav-link" data-scroll-target="#step-2-derive-cruise_key"><span class="header-section-number">0.7.2</span> Step 2: Derive cruise_key</a></li>
  <li><a href="#step-3-validate-against-swfsc-cruise-table" id="toc-step-3-validate-against-swfsc-cruise-table" class="nav-link" data-scroll-target="#step-3-validate-against-swfsc-cruise-table"><span class="header-section-number">0.7.3</span> Step 3: Validate against swfsc cruise table</a></li>
  <li><a href="#step-4-report-unmatched-ship-codes" id="toc-step-4-report-unmatched-ship-codes" class="nav-link" data-scroll-target="#step-4-report-unmatched-ship-codes"><span class="header-section-number">0.7.4</span> Step 4: Report unmatched ship codes</a></li>
  </ul></li>
  <li><a href="#standardize-taxonomy" id="toc-standardize-taxonomy" class="nav-link" data-scroll-target="#standardize-taxonomy"><span class="header-section-number">0.8</span> Standardize Taxonomy</a>
  <ul>
  <li><a href="#taxonomy-statistics" id="toc-taxonomy-statistics" class="nav-link" data-scroll-target="#taxonomy-statistics"><span class="header-section-number">0.8.1</span> Taxonomy Statistics</a></li>
  </ul></li>
  <li><a href="#validate-cross-dataset-integrity" id="toc-validate-cross-dataset-integrity" class="nav-link" data-scroll-target="#validate-cross-dataset-integrity"><span class="header-section-number">0.9</span> Validate Cross-Dataset Integrity</a></li>
  <li><a href="#show-combined-schema" id="toc-show-combined-schema" class="nav-link" data-scroll-target="#show-combined-schema"><span class="header-section-number">0.10</span> Show Combined Schema</a></li>
  <li><a href="#write-modified-parquet-outputs" id="toc-write-modified-parquet-outputs" class="nav-link" data-scroll-target="#write-modified-parquet-outputs"><span class="header-section-number">0.11</span> Write Modified Parquet Outputs</a>
  <ul>
  <li><a href="#build-combined-manifest" id="toc-build-combined-manifest" class="nav-link" data-scroll-target="#build-combined-manifest"><span class="header-section-number">0.11.1</span> Build Combined Manifest</a></li>
  </ul></li>
  <li><a href="#ingest-to-working-ducklake" id="toc-ingest-to-working-ducklake" class="nav-link" data-scroll-target="#ingest-to-working-ducklake"><span class="header-section-number">0.12</span> Ingest to Working DuckLake</a></li>
  <li><a href="#list-working-tables" id="toc-list-working-tables" class="nav-link" data-scroll-target="#list-working-tables"><span class="header-section-number">0.13</span> List Working Tables</a></li>
  <li><a href="#save-working-ducklake" id="toc-save-working-ducklake" class="nav-link" data-scroll-target="#save-working-ducklake"><span class="header-section-number">0.14</span> Save Working DuckLake</a></li>
  <li><a href="#create-frozen-release" id="toc-create-frozen-release" class="nav-link" data-scroll-target="#create-frozen-release"><span class="header-section-number">0.15</span> Create Frozen Release</a>
  <ul>
  <li><a href="#release-notes" id="toc-release-notes" class="nav-link" data-scroll-target="#release-notes"><span class="header-section-number">0.15.1</span> Release Notes</a></li>
  </ul></li>
  <li><a href="#calcofi-database-release-v2026.02" id="toc-calcofi-database-release-v2026.02" class="nav-link" data-scroll-target="#calcofi-database-release-v2026.02"><span class="header-section-number">1</span> CalCOFI Database Release v2026.02</a>
  <ul>
  <li><a href="#tables-included" id="toc-tables-included" class="nav-link" data-scroll-target="#tables-included"><span class="header-section-number">1.1</span> Tables Included</a></li>
  <li><a href="#total" id="toc-total" class="nav-link" data-scroll-target="#total"><span class="header-section-number">1.2</span> Total</a></li>
  <li><a href="#data-sources" id="toc-data-sources" class="nav-link" data-scroll-target="#data-sources"><span class="header-section-number">1.3</span> Data Sources</a></li>
  <li><a href="#cross-dataset-integration" id="toc-cross-dataset-integration" class="nav-link" data-scroll-target="#cross-dataset-integration"><span class="header-section-number">1.4</span> Cross-Dataset Integration</a></li>
  <li><a href="#access" id="toc-access" class="nav-link" data-scroll-target="#access"><span class="header-section-number">1.5</span> Access</a>
  <ul class="collapse">
  <li><a href="#upload-frozen-release-to-gcs" id="toc-upload-frozen-release-to-gcs" class="nav-link" data-scroll-target="#upload-frozen-release-to-gcs"><span class="header-section-number">1.5.1</span> Upload Frozen Release to GCS</a></li>
  </ul></li>
  <li><a href="#cleanup" id="toc-cleanup" class="nav-link" data-scroll-target="#cleanup"><span class="header-section-number">1.6</span> Cleanup</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Merge Ichthyo &amp; Bottle to Working DuckLake</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2026-02-24</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="overview" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="overview">Overview</h2>
<p><strong>Goal</strong>: Merge parquet outputs from both upstream ingest workflows, perform cross-dataset reconciliation (ship matching, cruise bridge, taxonomy standardization), then load into Working DuckLake and create a frozen release.</p>
<p><strong>Steps</strong>:</p>
<ol type="1">
<li>Load parquet files from both upstream workflows into local temp DuckDB</li>
<li>Fuzzy match ships between datasets</li>
<li>Build cruise bridge (casts → cruise_key)</li>
<li>Standardize taxonomy (species → WoRMS/ITIS/GBIF)</li>
<li>Validate cross-dataset integrity</li>
<li>Write modified parquet outputs + manifest with GCS references</li>
<li>Ingest all tables into Working DuckLake with provenance</li>
<li>Freeze release (strip provenance)</li>
<li>Upload to GCS</li>
</ol>
<p><strong>Upstream workflows</strong> (must complete first):</p>
<ul>
<li><code>ingest_swfsc.noaa.gov_calcofi-db.qmd</code> → ichthyo tables (10)</li>
<li><code>ingest_calcofi.org_bottle-database.qmd</code> → bottle/cast tables (5)</li>
</ul>
<div class="cell" data-layout-align="default">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>flowchart LR</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    subgraph upstream["Upstream Parquet"]</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>        s["swfsc&lt;br/&gt;10 tables"]</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>        b["bottle&lt;br/&gt;5 tables"]</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    subgraph merge["Merge DuckDB"]</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>        m1["Ship matching"]</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>        m2["Cruise bridge"]</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        m3["Taxonomy"]</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    subgraph output["Output"]</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        p["Modified parquet&lt;br/&gt;+ manifest"]</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        w["Working DuckLake"]</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>        f["Frozen Release"]</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    s --&gt; merge</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    b --&gt; merge</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    merge --&gt; p --&gt; w --&gt; f</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    style upstream fill:#e3f2fd,stroke:#1565c0</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    style merge fill:#fff3e0,stroke:#ef6c00</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    style output fill:#e8f4e8,stroke:#2e7d32</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div id="fig-workflow" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-workflow-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-workflow">flowchart LR
    subgraph upstream["Upstream Parquet"]
        s["swfsc&lt;br/&gt;10 tables"]
        b["bottle&lt;br/&gt;5 tables"]
    end
    subgraph merge["Merge DuckDB"]
        m1["Ship matching"]
        m2["Cruise bridge"]
        m3["Taxonomy"]
    end
    subgraph output["Output"]
        p["Modified parquet&lt;br/&gt;+ manifest"]
        w["Working DuckLake"]
        f["Frozen Release"]
    end
    s --&gt; merge
    b --&gt; merge
    merge --&gt; p --&gt; w --&gt; f

    style upstream fill:#e3f2fd,stroke:#1565c0
    style merge fill:#fff3e0,stroke:#ef6c00
    style output fill:#e8f4e8,stroke:#2e7d32
</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-workflow-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Integration workflow: upstream parquet → merge → Working DuckLake → Frozen Release
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="setup" class="level2" data-number="0.1">
<h2 data-number="0.1" class="anchored" data-anchor-id="setup"><span class="header-section-number">0.1</span> Setup</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">load_all</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"../calcofi4db"</span>))</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">load_all</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"../calcofi4R"</span>))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  CalCOFI<span class="sc">/</span>calcofi4db, DBI, dm, dplyr, DT, fs, glue, here,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  jsonlite, purrr, readr, stringr, tibble, tidyr,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  worrms, taxize,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">quiet =</span> T)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">readr.show_col_types =</span> F)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">DT.options =</span> <span class="fu">list</span>(<span class="at">scrollX =</span> <span class="cn">TRUE</span>))</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># parquet input directories (from upstream workflows)</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>dir_pq_ichthyo <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/parquet/swfsc.noaa.gov_calcofi-db"</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>dir_pq_bottle  <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/parquet/calcofi.org_bottle-database"</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># release version</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>release_version <span class="ot">&lt;-</span> <span class="fu">format</span>(<span class="fu">Sys.Date</span>(), <span class="st">"v%Y.%m"</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># local merge database</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>db_path   <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/wrangling/merge_ichthyo_bottle.duckdb"</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>overwrite <span class="ot">&lt;-</span> <span class="cn">FALSE</span>  <span class="co"># set TRUE to rebuild from scratch (takes ~1hr for taxonomy APIs)</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (overwrite <span class="sc">&amp;&amp;</span> <span class="fu">file_exists</span>(db_path)) <span class="fu">file_delete</span>(db_path)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="fu">dir_create</span>(<span class="fu">dirname</span>(db_path))</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">get_duckdb_con</span>(db_path)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="fu">load_duckdb_extension</span>(con, <span class="st">"spatial"</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co"># check if database already has tables (from previous run)</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>existing_tables <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbListTables</span>(con)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>skip_load <span class="ot">&lt;-</span> <span class="fu">length</span>(existing_tables) <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (skip_load) {</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Using existing database with {length(existing_tables)} tables"</span>))</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="check-upstream-workflows" class="level2" data-number="0.2">
<h2 data-number="0.2" class="anchored" data-anchor-id="check-upstream-workflows"><span class="header-section-number">0.2</span> Check Upstream Workflows</h2>
<p>Verify that parquet outputs and manifests exist from both upstream workflows.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check ichthyo manifest</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>ichthyo_manifest_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_pq_ichthyo, <span class="st">"manifest.json"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Missing ichthyo parquet outputs. Run ingest_swfsc.noaa.gov_calcofi-db.qmd first."</span> <span class="ot">=</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.exists</span>(ichthyo_manifest_path))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>ichthyo_manifest <span class="ot">&lt;-</span> <span class="fu">read_json</span>(ichthyo_manifest_path)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Ichthyo parquet: {ichthyo_manifest$total_rows} total rows, "</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"created {ichthyo_manifest$created_at}"</span>))</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># check bottle manifest</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>bottle_manifest_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_pq_bottle, <span class="st">"manifest.json"</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Missing bottle parquet outputs. Run ingest_calcofi.org_bottle-database.qmd first."</span> <span class="ot">=</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.exists</span>(bottle_manifest_path))</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>bottle_manifest <span class="ot">&lt;-</span> <span class="fu">read_json</span>(bottle_manifest_path)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Bottle parquet: {bottle_manifest$total_rows} total rows, "</span>,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"created {bottle_manifest$created_at}"</span>))</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># show manifest stats</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">source   =</span> <span class="fu">c</span>(<span class="st">"ichthyo"</span>, <span class="st">"bottle"</span>),</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">tables   =</span> <span class="fu">c</span>(</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(ichthyo_manifest<span class="sc">$</span>tables),</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(bottle_manifest<span class="sc">$</span>tables)),</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">rows     =</span> <span class="fu">c</span>(</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    ichthyo_manifest<span class="sc">$</span>total_rows,</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    bottle_manifest<span class="sc">$</span>total_rows),</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">created  =</span> <span class="fu">c</span>(</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    ichthyo_manifest<span class="sc">$</span>created_at,</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    bottle_manifest<span class="sc">$</span>created_at)) <span class="sc">|&gt;</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Upstream workflow manifest stats"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-f74abb59f8e24876eb8f" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-f74abb59f8e24876eb8f">{"x":{"filter":"none","vertical":false,"caption":"<caption>Upstream workflow manifest stats<\/caption>","data":[["1","2"],["ichthyo","bottle"],[10,5],[1106535,12302175],["2026-02-24 16:32:45.009946","2026-02-24 17:00:16.452848"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>source<\/th>\n      <th>tables<\/th>\n      <th>rows<\/th>\n      <th>created<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"source","targets":1},{"name":"tables","targets":2},{"name":"rows","targets":3},{"name":"created","targets":4}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="load-swfsc-tables" class="level2" data-number="0.3">
<h2 data-number="0.3" class="anchored" data-anchor-id="load-swfsc-tables"><span class="header-section-number">0.3</span> Load SWFSC Tables</h2>
<p>Load all ichthyo parquet files into the local merge DuckDB. Tables with geometry columns (grid, site, segment) need WKB→GEOMETRY conversion.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>ichthyo_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  dir_pq_ichthyo, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.parquet$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># tables with geometry columns that need WKB conversion</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>geom_tables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"grid"</span>, <span class="st">"site"</span>, <span class="st">"segment"</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (skip_load) {</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Using existing ichthyo tables from database"</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  ichthyo_stats <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(ichthyo_files, <span class="cf">function</span>(pqt_path) {</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    tbl_name <span class="ot">&lt;-</span> tools<span class="sc">::</span><span class="fu">file_path_sans_ext</span>(<span class="fu">basename</span>(pqt_path))</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con, <span class="fu">glue</span>(<span class="st">"SELECT COUNT(*) AS n FROM {tbl_name}"</span>))<span class="sc">$</span>n</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">table =</span> tbl_name, <span class="at">rows =</span> n, <span class="at">source =</span> <span class="st">"ichthyo"</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  ichthyo_stats <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(ichthyo_files, <span class="cf">function</span>(pqt_path) {</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    tbl_name <span class="ot">&lt;-</span> tools<span class="sc">::</span><span class="fu">file_path_sans_ext</span>(<span class="fu">basename</span>(pqt_path))</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (tbl_name <span class="sc">%in%</span> geom_tables) {</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>      <span class="co"># use load_gcs_parquet_to_duckdb for WKB→GEOMETRY conversion</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>      DBI<span class="sc">::</span><span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"CREATE OR REPLACE TABLE {tbl_name} AS</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="st">         SELECT * FROM read_parquet('{pqt_path}')"</span>))</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>      <span class="co"># detect and convert WKB BLOB columns</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>      blob_cols <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con, <span class="fu">glue</span>(</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"SELECT column_name FROM information_schema.columns</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="st">         WHERE table_name = '{tbl_name}'</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="st">           AND data_type = 'BLOB'</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="st">           AND column_name LIKE '%geom%'"</span>))<span class="sc">$</span>column_name</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (gc <span class="cf">in</span> blob_cols) {</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        tmp_col <span class="ot">&lt;-</span> <span class="fu">paste0</span>(gc, <span class="st">"_tmp"</span>)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        DBI<span class="sc">::</span><span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>          <span class="st">'ALTER TABLE {tbl_name} ADD COLUMN {tmp_col} GEOMETRY'</span>))</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        DBI<span class="sc">::</span><span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>          <span class="st">'UPDATE {tbl_name} SET {tmp_col} = ST_GeomFromWKB({gc})'</span>))</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        DBI<span class="sc">::</span><span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>          <span class="st">'ALTER TABLE {tbl_name} DROP COLUMN {gc}'</span>))</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>        DBI<span class="sc">::</span><span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>          <span class="st">'ALTER TABLE {tbl_name} RENAME COLUMN {tmp_col} TO {gc}'</span>))</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>      DBI<span class="sc">::</span><span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">"CREATE OR REPLACE TABLE {tbl_name} AS</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="st">         SELECT * FROM read_parquet('{pqt_path}')"</span>))</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con, <span class="fu">glue</span>(<span class="st">"SELECT COUNT(*) AS n FROM {tbl_name}"</span>))<span class="sc">$</span>n</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">table =</span> tbl_name, <span class="at">rows =</span> n, <span class="at">source =</span> <span class="st">"ichthyo"</span>)</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>ichthyo_stats <span class="sc">|&gt;</span> <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"SWFSC ichthyo tables loaded"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-fef4633e5aed7ec7b44d" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-fef4633e5aed7ec7b44d">{"x":{"filter":"none","vertical":false,"caption":"<caption>SWFSC ichthyo tables loaded<\/caption>","data":[["1","2","3","4","5","6","7","8","9","10"],["cruise","grid","ichthyo","lookup","net","segment","ship","site","species","tow"],[691,218,830873,26,76512,60413,48,61104,1144,75506],["ichthyo","ichthyo","ichthyo","ichthyo","ichthyo","ichthyo","ichthyo","ichthyo","ichthyo","ichthyo"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table<\/th>\n      <th>rows<\/th>\n      <th>source<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"table","targets":1},{"name":"rows","targets":2},{"name":"source","targets":3}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="load-bottle-tables" class="level2" data-number="0.4">
<h2 data-number="0.4" class="anchored" data-anchor-id="load-bottle-tables"><span class="header-section-number">0.4</span> Load Bottle Tables</h2>
<p>Load bottle parquet files (grid excluded from bottle export — canonical from swfsc).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>bottle_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  dir_pq_bottle, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.parquet$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># belt-and-suspenders: skip grid.parquet if it still exists</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>bottle_files <span class="ot">&lt;-</span> bottle_files[<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"grid</span><span class="sc">\\</span><span class="st">.parquet$"</span>, bottle_files)]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (skip_load) {</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Using existing bottle tables from database"</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  bottle_stats <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(bottle_files, <span class="cf">function</span>(pqt_path) {</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    tbl_name <span class="ot">&lt;-</span> tools<span class="sc">::</span><span class="fu">file_path_sans_ext</span>(<span class="fu">basename</span>(pqt_path))</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con, <span class="fu">glue</span>(<span class="st">"SELECT COUNT(*) AS n FROM {tbl_name}"</span>))<span class="sc">$</span>n</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">table =</span> tbl_name, <span class="at">rows =</span> n, <span class="at">source =</span> <span class="st">"bottle"</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  bottle_stats <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(bottle_files, <span class="cf">function</span>(pqt_path) {</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    tbl_name <span class="ot">&lt;-</span> tools<span class="sc">::</span><span class="fu">file_path_sans_ext</span>(<span class="fu">basename</span>(pqt_path))</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    DBI<span class="sc">::</span><span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CREATE OR REPLACE TABLE {tbl_name} AS</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="st">       SELECT * FROM read_parquet('{pqt_path}')"</span>))</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con, <span class="fu">glue</span>(<span class="st">"SELECT COUNT(*) AS n FROM {tbl_name}"</span>))<span class="sc">$</span>n</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">table =</span> tbl_name, <span class="at">rows =</span> n, <span class="at">source =</span> <span class="st">"bottle"</span>)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>bottle_stats <span class="sc">|&gt;</span> <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Bottle tables loaded"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-acc97c8d9dd8b0344391" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-acc97c8d9dd8b0344391">{"x":{"filter":"none","vertical":false,"caption":"<caption>Bottle tables loaded<\/caption>","data":[["1","2","3","4","5"],["bottle_measurement","bottle","cast_condition","casts","measurement_type"],[11135600,895371,235513,35644,47],["bottle","bottle","bottle","bottle","bottle"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table<\/th>\n      <th>rows<\/th>\n      <th>source<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"table","targets":1},{"name":"rows","targets":2},{"name":"source","targets":3}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="show-loaded-tables" class="level2" data-number="0.5">
<h2 data-number="0.5" class="anchored" data-anchor-id="show-loaded-tables"><span class="header-section-number">0.5</span> Show Loaded Tables</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>all_stats <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(ichthyo_stats, bottle_stats)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Loaded {nrow(all_stats)} tables: "</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"{sum(all_stats$source == 'ichthyo')} ichthyo + "</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"{sum(all_stats$source == 'bottle')} bottle"</span>))</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>all_stats <span class="sc">|&gt;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(source, table) <span class="sc">|&gt;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"All loaded tables"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-dc301b7a6838d5795dc6" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-dc301b7a6838d5795dc6">{"x":{"filter":"none","vertical":false,"caption":"<caption>All loaded tables<\/caption>","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15"],["bottle","bottle_measurement","cast_condition","casts","measurement_type","cruise","grid","ichthyo","lookup","net","segment","ship","site","species","tow"],[895371,11135600,235513,35644,47,691,218,830873,26,76512,60413,48,61104,1144,75506],["bottle","bottle","bottle","bottle","bottle","ichthyo","ichthyo","ichthyo","ichthyo","ichthyo","ichthyo","ichthyo","ichthyo","ichthyo","ichthyo"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table<\/th>\n      <th>rows<\/th>\n      <th>source<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"table","targets":1},{"name":"rows","targets":2},{"name":"source","targets":3}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="fuzzy-ship-matching" class="level2" data-number="0.6">
<h2 data-number="0.6" class="anchored" data-anchor-id="fuzzy-ship-matching"><span class="header-section-number">0.6</span> Fuzzy Ship Matching</h2>
<p>Reconcile ship codes between bottle casts and swfsc ship reference table. Uses <code>calcofi4db::match_ships()</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get unmatched ships from casts</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>unmatched <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT DISTINCT c.ship_code, c.ship_name</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM casts c</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="st">  LEFT JOIN ship s ON c.ship_code = s.ship_nodc</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE s.ship_key IS NULL"</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"{nrow(unmatched)} unmatched ship codes in casts"</span>))</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ship renames CSV (manual overrides from previous reconciliation)</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>ship_renames_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"metadata/calcofi.org/bottle-database/ship_renames.csv"</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># run fuzzy matching</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>ship_matches <span class="ot">&lt;-</span> <span class="fu">match_ships</span>(</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">unmatched_ships  =</span> unmatched,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">reference_ships  =</span> <span class="fu">dbReadTable</span>(con, <span class="st">"ship"</span>),</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">ship_renames_csv =</span> ship_renames_csv,</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">fetch_ices       =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>ship_matches <span class="sc">|&gt;</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Ship matching results"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-592ac8e366415175d986" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-592ac8e366415175d986">{"x":{"filter":"none","vertical":false,"caption":"<caption>Ship matching results<\/caption>","data":[["1","2","3","4"],["33DP","31AR","32BH","31WE"],["DAVID PHILLIP DOLPHIN","ARGO","RV BOLD HORIZON","WESTWIND"],["manual_override","manual_override","fuzzy","unmatched"],[null,null,"BH",null],["33DP","31AR","39C2",null],["DAVID PHILLIP DOLPHIN","ARGO","BOLD HORIZON",null],[1,1,0.6666666666666666,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>ship_code<\/th>\n      <th>ship_name<\/th>\n      <th>match_type<\/th>\n      <th>matched_ship_key<\/th>\n      <th>matched_ship_nodc<\/th>\n      <th>matched_ship_name<\/th>\n      <th>confidence<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":7},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"ship_code","targets":1},{"name":"ship_name","targets":2},{"name":"match_type","targets":3},{"name":"matched_ship_key","targets":4},{"name":"matched_ship_nodc","targets":5},{"name":"matched_ship_name","targets":6},{"name":"confidence","targets":7}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<section id="match-statistics" class="level3" data-number="0.6.1">
<h3 data-number="0.6.1" class="anchored" data-anchor-id="match-statistics"><span class="header-section-number">0.6.1</span> Match Statistics</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>ship_matches <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(match_type) <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Ship match type counts"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-3142fce8dc560365dc3d" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-3142fce8dc560365dc3d">{"x":{"filter":"none","vertical":false,"caption":"<caption>Ship match type counts<\/caption>","data":[["1","2","3"],["fuzzy","manual_override","unmatched"],[1,2,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>match_type<\/th>\n      <th>n<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"match_type","targets":1},{"name":"n","targets":2}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
<section id="build-cruise-bridge" class="level2" data-number="0.7">
<h2 data-number="0.7" class="anchored" data-anchor-id="build-cruise-bridge"><span class="header-section-number">0.7</span> Build Cruise Bridge</h2>
<p>Link bottle casts to swfsc cruise table via ship_key → cruise_key.</p>
<section id="step-1-add-ship_key-to-casts" class="level3" data-number="0.7.1">
<h3 data-number="0.7.1" class="anchored" data-anchor-id="step-1-add-ship_key-to-casts"><span class="header-section-number">0.7.1</span> Step 1: Add ship_key to casts</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add ship_key column</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con, <span class="st">"ALTER TABLE casts ADD COLUMN IF NOT EXISTS ship_key TEXT"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># exact match: casts.ship_code = ship.ship_nodc</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con, <span class="st">"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="st">  UPDATE casts SET ship_key = (</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT s.ship_key FROM ship s</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE s.ship_nodc = casts.ship_code</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="st">    LIMIT 1)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 35644</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>n_exact <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SELECT COUNT(*) AS n FROM casts WHERE ship_key IS NOT NULL"</span>)<span class="sc">$</span>n</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Exact ship_nodc match: {n_exact} casts"</span>))</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># apply fuzzy match results for previously unmatched ships</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>matched_ships <span class="ot">&lt;-</span> ship_matches <span class="sc">|&gt;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(match_type <span class="sc">!=</span> <span class="st">"unmatched"</span>, <span class="sc">!</span><span class="fu">is.na</span>(matched_ship_key))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(matched_ships) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(matched_ships))) {</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> matched_ships[i, ]</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="st">      UPDATE casts SET ship_key = '{m$matched_ship_key}'</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="st">      WHERE ship_code = '{m$ship_code}'</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="st">        AND ship_key IS NULL"</span>))</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  n_fuzzy <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con,</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT COUNT(*) AS n FROM casts WHERE ship_key IS NOT NULL"</span>)<span class="sc">$</span>n <span class="sc">-</span> n_exact</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Fuzzy/manual match: {n_fuzzy} additional casts"</span>))</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="co"># summary</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>ship_key_stats <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="st">    CASE WHEN ship_key IS NULL THEN 'no_ship_match'</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="st">         ELSE 'matched' END AS status,</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="st">    COUNT(*) AS n_casts</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM casts</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="st">  GROUP BY status"</span>)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>ship_key_stats <span class="sc">|&gt;</span> <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"ship_key assignment stats"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-dbf0e23226b7a126178c" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-dbf0e23226b7a126178c">{"x":{"filter":"none","vertical":false,"caption":"<caption>ship_key assignment stats<\/caption>","data":[["1","2"],["matched","no_ship_match"],[35595,49]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>status<\/th>\n      <th>n_casts<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"status","targets":1},{"name":"n_casts","targets":2}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="step-2-derive-cruise_key" class="level3" data-number="0.7.2">
<h3 data-number="0.7.2" class="anchored" data-anchor-id="step-2-derive-cruise_key"><span class="header-section-number">0.7.2</span> Step 2: Derive cruise_key</h3>
<p>Cruise key format: YYMMKK (2-digit year, 2-digit month, 2-letter ship key). The bottle ingest stores the original <code>Cruise_ID</code> as <code>cruise_key_0</code> (interim), so <code>cruise_key</code> is a new column bridging bottle casts to the SWFSC <code>cruise</code> table.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add cruise_key column</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con, <span class="st">"ALTER TABLE casts ADD COLUMN IF NOT EXISTS cruise_key TEXT"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># derive YYMMKK from datetime_utc + ship_key</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con, <span class="st">"</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="st">  UPDATE casts SET cruise_key = CONCAT(</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="st">    LPAD(CAST(EXTRACT(YEAR FROM datetime_utc) % 100 AS VARCHAR), 2, '0'),</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="st">    LPAD(CAST(EXTRACT(MONTH FROM datetime_utc) AS VARCHAR), 2, '0'),</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="st">    ship_key)</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE ship_key IS NOT NULL"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 35595</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>n_cruise <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SELECT COUNT(*) AS n FROM casts WHERE cruise_key IS NOT NULL"</span>)<span class="sc">$</span>n</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Derived cruise_key for {n_cruise} casts"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="step-3-validate-against-swfsc-cruise-table" class="level3" data-number="0.7.3">
<h3 data-number="0.7.3" class="anchored" data-anchor-id="step-3-validate-against-swfsc-cruise-table"><span class="header-section-number">0.7.3</span> Step 3: Validate against swfsc cruise table</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>cruise_stats <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="st">    CASE</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="st">      WHEN c.ship_key IS NULL THEN 'no_ship_match'</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="st">      WHEN c.cruise_key IS NULL THEN 'no_cruise_key'</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="st">      WHEN cr.cruise_key IS NULL THEN 'no_cruise_match'</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="st">      ELSE 'matched'</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="st">    END AS status,</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="st">    COUNT(*) AS n_casts</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM casts c</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="st">  LEFT JOIN cruise cr ON c.cruise_key = cr.cruise_key</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="st">  GROUP BY status</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="st">  ORDER BY status"</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>cruise_stats <span class="sc">|&gt;</span> <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Cruise bridge match statistics"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-775d632c89c26bb2e3b8" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-775d632c89c26bb2e3b8">{"x":{"filter":"none","vertical":false,"caption":"<caption>Cruise bridge match statistics<\/caption>","data":[["1","2","3"],["matched","no_cruise_match","no_ship_match"],[27251,8344,49]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>status<\/th>\n      <th>n_casts<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"status","targets":1},{"name":"n_casts","targets":2}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="step-4-report-unmatched-ship-codes" class="level3" data-number="0.7.4">
<h3 data-number="0.7.4" class="anchored" data-anchor-id="step-4-report-unmatched-ship-codes"><span class="header-section-number">0.7.4</span> Step 4: Report unmatched ship codes</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>unmatched_report <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT DISTINCT</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="st">    c.ship_code, c.ship_name,</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="st">    COUNT(*) AS n_casts,</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="st">    MIN(c.datetime_utc) AS first_cast,</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="st">    MAX(c.datetime_utc) AS last_cast</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM casts c</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE c.ship_key IS NULL</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="st">  GROUP BY c.ship_code, c.ship_name</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="st">  ORDER BY n_casts DESC"</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(unmatched_report) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  unmatched_report <span class="sc">|&gt;</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Unmatched ship codes (no ship_key)"</span>)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"All ship codes matched!"</span>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-26c76cc54f1156ca3625" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-26c76cc54f1156ca3625">{"x":{"filter":"none","vertical":false,"caption":"<caption>Unmatched ship codes (no ship_key)<\/caption>","data":[["1","2","3"],["33DP","31WE","31AR"],["DAVID PHILLIP DOLPHIN","WESTWIND","ARGO"],[34,11,4],["1973-05-23T15:25:00Z","1983-04-06T15:48:00Z","1962-01-11T02:48:00Z"],["1973-05-27T00:43:00Z","1983-04-07T15:39:00Z","1962-01-17T04:06:00Z"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>ship_code<\/th>\n      <th>ship_name<\/th>\n      <th>n_casts<\/th>\n      <th>first_cast<\/th>\n      <th>last_cast<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":3},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"ship_code","targets":1},{"name":"ship_name","targets":2},{"name":"n_casts","targets":3},{"name":"first_cast","targets":4},{"name":"last_cast","targets":5}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
<section id="standardize-taxonomy" class="level2" data-number="0.8">
<h2 data-number="0.8" class="anchored" data-anchor-id="standardize-taxonomy"><span class="header-section-number">0.8</span> Standardize Taxonomy</h2>
<p>Update species table with WoRMS/ITIS/GBIF identifiers using <code>standardize_species()</code> and build taxonomy hierarchy using <code>build_taxon_table()</code> from <code>calcofi4db/R/taxonomy.R</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check if species already standardized (all taxonomy columns exist with data)</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>sp_cols <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SELECT column_name FROM information_schema.columns</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="st">   WHERE table_name = 'species'"</span>)<span class="sc">$</span>column_name</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>sp_standardized <span class="ot">&lt;-</span> <span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"worms_id"</span>, <span class="st">"itis_id"</span>, <span class="st">"gbif_id"</span>) <span class="sc">%in%</span> sp_cols) <span class="sc">&amp;&amp;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT COUNT(*) AS n FROM species WHERE worms_id IS NOT NULL"</span>)<span class="sc">$</span>n <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (sp_standardized <span class="sc">&amp;&amp;</span> <span class="sc">!</span>overwrite) {</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Species already standardized, skipping API calls"</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  sp_results <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT species_id, scientific_name, worms_id, itis_id, gbif_id</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="st">     FROM species"</span>)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># standardize species identifiers (slow - makes API calls)</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  sp_results <span class="ot">&lt;-</span> <span class="fu">standardize_species</span>(</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">con           =</span> con,</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_tbl   =</span> <span class="st">"species"</span>,</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">include_gbif  =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>sp_results <span class="sc">|&gt;</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Species standardization results"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-d145dc0b16d19bbf26fa" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-d145dc0b16d19bbf26fa">{"x":{"filter":"none","vertical":false,"caption":"<caption>Species standardization results<\/caption>","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200","201","202","203","204","205","206","207","208","209","210","211","212","213","214","215","216","217","218","219","220","221","222","223","224","225","226","227","228","229","230","231","232","233","234","235","236","237","238","239","240","241","242","243","244","245","246","247","248","249","250","251","252","253","254","255","256","257","258","259","260","261","262","263","264","265","266","267","268","269","270","271","272","273","274","275","276","277","278","279","280","281","282","283","284","285","286","287","288","289","290","291","292","293","294","295","296","297","298","299","300","301","302","303","304","305","306","307","308","309","310","311","312","313","314","315","316","317","318","319","320","321","322","323","324","325","326","327","328","329","330","331","332","333","334","335","336","337","338","339","340","341","342","343","344","345","346","347","348","349","350","351","352","353","354","355","356","357","358","359","360","361","362","363","364","365","366","367","368","369","370","371","372","373","374","375","376","377","378","379","380","381","382","383","384","385","386","387","388","389","390","391","392","393","394","395","396","397","398","399","400","401","402","403","404","405","406","407","408","409","410","411","412","413","414","415","416","417","418","419","420","421","422","423","424","425","426","427","428","429","430","431","432","433","434","435","436","437","438","439","440","441","442","443","444","445","446","447","448","449","450","451","452","453","454","455","456","457","458","459","460","461","462","463","464","465","466","467","468","469","470","471","472","473","474","475","476","477","478","479","480","481","482","483","484","485","486","487","488","489","490","491","492","493","494","495","496","497","498","499","500","501","502","503","504","505","506","507","508","509","510","511","512","513","514","515","516","517","518","519","520","521","522","523","524","525","526","527","528","529","530","531","532","533","534","535","536","537","538","539","540","541","542","543","544","545","546","547","548","549","550","551","552","553","554","555","556","557","558","559","560","561","562","563","564","565","566","567","568","569","570","571","572","573","574","575","576","577","578","579","580","581","582","583","584","585","586","587","588","589","590","591","592","593","594","595","596","597","598","599","600","601","602","603","604","605","606","607","608","609","610","611","612","613","614","615","616","617","618","619","620","621","622","623","624","625","626","627","628","629","630","631","632","633","634","635","636","637","638","639","640","641","642","643","644","645","646","647","648","649","650","651","652","653","654","655","656","657","658","659","660","661","662","663","664","665","666","667","668","669","670","671","672","673","674","675","676","677","678","679","680","681","682","683","684","685","686","687","688","689","690","691","692","693","694","695","696","697","698","699","700","701","702","703","704","705","706","707","708","709","710","711","712","713","714","715","716","717","718","719","720","721","722","723","724","725","726","727","728","729","730","731","732","733","734","735","736","737","738","739","740","741","742","743","744","745","746","747","748","749","750","751","752","753","754","755","756","757","758","759","760","761","762","763","764","765","766","767","768","769","770","771","772","773","774","775","776","777","778","779","780","781","782","783","784","785","786","787","788","789","790","791","792","793","794","795","796","797","798","799","800","801","802","803","804","805","806","807","808","809","810","811","812","813","814","815","816","817","818","819","820","821","822","823","824","825","826","827","828","829","830","831","832","833","834","835","836","837","838","839","840","841","842","843","844","845","846","847","848","849","850","851","852","853","854","855","856","857","858","859","860","861","862","863","864","865","866","867","868","869","870","871","872","873","874","875","876","877","878","879","880","881","882","883","884","885","886","887","888","889","890","891","892","893","894","895","896","897","898","899","900","901","902","903","904","905","906","907","908","909","910","911","912","913","914","915","916","917","918","919","920","921","922","923","924","925","926","927","928","929","930","931","932","933","934","935","936","937","938","939","940","941","942","943","944","945","946","947","948","949","950","951","952","953","954","955","956","957","958","959","960","961","962","963","964","965","966","967","968","969","970","971","972","973","974","975","976","977","978","979","980","981","982","983","984","985","986","987","988","989","990","991","992","993","994","995","996","997","998","999","1000","1001","1002","1003","1004","1005","1006","1007","1008","1009","1010","1011","1012","1013","1014","1015","1016","1017","1018","1019","1020","1021","1022","1023","1024","1025","1026","1027","1028","1029","1030","1031","1032","1033","1034","1035","1036","1037","1038","1039","1040","1041","1042","1043","1044","1045","1046","1047","1048","1049","1050","1051","1052","1053","1054","1055","1056","1057","1058","1059","1060","1061","1062","1063","1064","1065","1066","1067","1068","1069","1070","1071","1072","1073","1074","1075","1076","1077","1078","1079","1080","1081","1082","1083","1084","1085","1086","1087","1088","1089","1090","1091","1092","1093","1094","1095","1096","1097","1098","1099","1100","1101","1102","1103","1104","1105","1106","1107","1108","1109","1110","1111","1112","1113","1114","1115","1116","1117","1118","1119","1120","1121","1122","1123","1124","1125","1126","1127","1128","1129","1130","1131","1132","1133","1134","1135","1136","1137","1138","1139","1140","1141","1142","1143","1144"],[1,3,4,5,7,9,12,15,16,19,20,21,22,25,26,27,28,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,84,85,86,87,88,89,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,120,121,130,131,132,133,134,135,136,137,138,139,140,142,150,151,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,200,201,202,203,204,206,207,208,209,210,211,214,215,216,217,219,221,224,225,226,227,228,229,239,241,242,243,248,249,250,251,252,253,254,255,256,257,258,261,263,264,265,266,267,270,272,273,274,275,276,277,281,282,283,285,286,287,288,289,292,293,296,297,298,299,301,302,303,305,306,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,331,332,333,334,335,336,337,338,339,340,341,342,343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358,359,361,362,363,364,365,366,367,368,369,370,371,372,373,374,375,376,377,378,379,380,381,382,383,384,385,386,387,388,389,390,391,392,393,394,395,396,397,398,399,400,401,402,403,404,405,406,407,408,409,410,411,412,413,414,415,416,417,418,419,420,421,422,423,424,425,426,427,428,429,430,431,432,433,434,435,436,437,438,439,440,441,442,443,444,445,446,447,448,449,450,451,452,453,454,455,456,457,458,459,460,461,462,470,471,479,480,481,485,486,487,488,490,491,492,493,494,495,496,497,498,499,500,501,502,503,504,505,506,507,508,509,510,511,512,513,514,515,516,517,518,519,520,521,522,523,524,525,526,527,528,529,530,531,533,534,535,536,541,543,545,546,547,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,565,566,567,571,572,574,576,577,578,580,581,584,585,586,587,588,590,591,592,593,594,595,596,597,598,599,600,601,602,604,605,607,608,609,610,611,612,613,614,615,616,617,618,619,620,621,622,623,624,625,626,627,628,629,630,631,632,633,635,636,637,638,639,640,642,643,648,649,650,651,656,660,661,665,666,669,670,671,672,675,676,678,681,682,683,684,685,686,687,688,689,690,691,692,693,694,707,708,709,710,711,715,717,718,719,720,726,727,728,730,732,733,734,735,736,737,738,739,740,741,742,743,744,745,746,747,748,749,750,751,752,753,754,755,756,757,758,760,761,762,763,764,765,766,767,768,769,770,771,772,773,774,775,776,780,781,784,785,786,787,788,789,790,791,792,793,794,795,796,797,798,799,800,801,802,803,804,805,806,807,808,809,810,811,812,813,814,815,816,817,818,819,820,821,822,823,824,825,826,827,828,829,830,831,832,833,834,835,836,837,838,839,840,841,842,843,844,845,846,847,848,849,850,851,852,853,854,855,856,857,858,859,860,861,862,863,864,865,866,867,868,869,870,871,872,873,874,875,876,877,878,879,880,881,882,883,884,885,886,887,888,889,890,891,892,893,894,895,896,897,898,899,900,901,902,903,904,905,906,907,908,909,910,911,912,913,914,915,916,917,918,919,920,921,922,923,924,925,926,927,928,929,930,931,932,933,934,935,936,937,938,939,940,941,942,943,944,945,946,947,948,949,950,951,952,953,954,955,956,957,958,959,960,961,962,964,965,966,967,968,969,970,971,972,973,974,975,976,977,978,979,980,981,982,983,984,985,986,987,988,989,990,991,992,993,994,995,996,997,998,999,1005,1015,1020,1025,1030,1031,1050,1060,1062,1075,1085,1090,1100,1115,1123,1125,1126,1127,1128,1140,1143,1150,1155,1158,1170,1176,1180,1185,1191,1194,1196,1200,1203,1204,1205,1210,1217,1222,1228,1230,1231,1241,1245,1249,1250,1255,1257,1260,1275,1280,1283,1286,1295,1297,1300,1305,1310,1315,1320,1323,1325,1328,1330,1345,1355,1357,1360,1370,1375,1380,1381,1383,1395,1398,1410,1411,1412,1420,1425,1440,1460,1480,1485,1488,1490,1500,1520,1525,1528,1529,1530,1540,1550,1580,1590,1595,1600,1610,1630,1640,1650,1654,1656,1675,1700,1715,1725,1750,1770,1775,1780,1790,1815,1825,1840,1855,1875,1890,1900,1906,1910,1935,1945,1950,1956,1960,1962,1964,1969,1975,2005,2006,2007,2008,2009,2012,2015,2016,2020,2040,2070,2100,2115,2120,2125,2130,2140,2155,2160,2165,2167,2170,2175,2190,2200,2210,2219,2220,2230,2240,2245,2250,2270,2275,2278,2280,2290,2295,2301,2303,2309,2310,2311,2500,2550,3000,3010,3011,3012,3013,3014,3015,3016,3017,3018,3019,3020,3021,3022,3024,3025,3026,3027,3028,3029,3030,3031,3032,3033,3034,3035,3036,3037,3038,3039,3040,3041,3042,3043,3044,3045,3046,3047,3048,3049,3050,3051,3052,3053,3054,3055,3500,9000,9400,9490,9525,9535,9540,9550,9555,9556,9559,9560,9561,9567,9568,9575,9576,9577,9578,9579,9580,9581,9585,9586,9587,9588,9590,9591,9594,9595,9596,9599,9604,9612,9615,9616,9622,9630,9631,9632,9640,9641,9642,9651,9653,9660,9661,9662,9665,9669,9670,9675,9676,9679,9681,9682,9683,9687,9692,9693,9705,9706,9708,9710,9711,9712,9715,9720,9725,9726,9727,9731,9735,9740,9750,9751,9752,9757,9760,9761,9801,9802,9805,9810,9811,9820,10000,10001,10002,10003,10004,10005,10006,10007,10008,10009,10010],["Teleostei","Elopidae","Elops affinis","Albulidae","Albula","Clupeiformes","Etrumeus teres","Clupeidae","Opisthonema","Sardinops sagax","Clupea pallasii","Harengula thrissina","Torpedo californica","Engraulidae","Anchoa","Anchoa compressa","Engraulis ringens","Engraulis mordax","Cetengraulis","Cetengraulis mysticetus","Chanos chanos","Alepocephalidae","Alepocephalus","Alepocephalus tenebrosus","Bajacalifornia burragei","Bathylaco nigricans","Holtbyrnia latifrons","Sagamichthys abei","Mirorictus taningi","Platytroctidae","Talismania bifurcata","Osmeridae","Mentodus eubranchus","Hypomesus pretiosus","Opisthoproctidae","Argentinoidei","Dolichopteryx longipes","Macropinna microstoma","Bathylychnops exilis","Argentinidae","Argentina sialis","Argentina","Microstoma","Cyclothone atraria","Cyclothone pallida","Nansenia","Nansenia candida","Nansenia crassa","Leuroglossus urotranus","Bathylagidae","Pseudobathylagus milleri","Bathylagoides nigrigenys","Lipolagus ochotensis","Bathylagus pacificus","Bathylagus","Bathylagoides wesethi","Leuroglossus stilbius","Dolicholagus longirostris","Leuroglossus schmidti","Gonostomatidae","Cyclothone","Cyclothone acclinidens","Cyclothone signata","Cyclothone pseudopallida","Gonostoma","Gonostoma atlanticum","Sigmops ebelingi","Danaphos oculatus","Diplophos proximus","Diplophos","Diplophos taenia","Ichthyococcus","Ichthyococcus irregularis","Valenciennellus tripunctulatus","Vinciguerria","Vinciguerria lucetia","Vinciguerria poweriae","Woodsia nonsuchae","Vinciguerria nimbaria","Yarrella blackfordi","Maurolicus muelleri","Maurolicus","Sternoptychidae","Argyropelecus","Argyropelecus lychnus","Argyropelecus affinis","Argyropelecus hemigymnus","Argyropelecus sladeni","Sternoptyx diaphana","Sternoptyx","Osmeriformes","Stomiiformes","Astronesthinae","Sternoptyx obscura","Astronesthes gibbsi","Astronesthes","Sternoptyx pseudobscura","Borostomias panamensis","Stomiinae","Stomias atriventer","Melanostomiinae","Bathophilus","Bathophilus filifer","Bathophilus flemingi","Melanostomias valdiviae","Opostomias mitsuii","Eustomias","Leptostomias","Stomias","Photonectes","Photonectes margarita","Tactostoma macropus","Malacosteinae","Aristostomias scintillans","Chauliodus","Chauliodontinae","Chauliodus macouni","Chauliodus sloani","Exocoetus","Exocoetus volitans","Idiacanthinae","Idiacanthus antrostomus","Idiacanthus","Cheilopogon xenopterus","Strongylura exilis","Scomberesocidae","Cololabis saira","Cololabis adocetus","Prognichthys tringa","Exocoetus monocirrhus","Hemiramphidae","Atherinops affinis","Atherinella","Atherinopsis californiensis","Leuresthes tenuis","Belonidae","Ablennes hians","Hemiramphus saltator","Cheilopogon pinnatibarbatus","Cypselurus callopterus","Exocoetidae","Oxyporhamphus micropterus","Euleptorhamphus viridis","Cheilopogon","Cheilopogon heterurus","Fodiator acutus","Hirundichthys","Hirundichthys marginatus","Hirundichthys rondeletii","Prognichthys","Myctophiformes","Scomberesox saurus","Hirundichthys speculiger","Cheilopogon dorsomacula","Hyporhamphus","Notosudidae","Scopelosaurus","Aulopidae","Aulopus","Synodus lacertinus","Synodus scituliceps","Synodontidae","Synodus","Synodus lucioceps","Synodus sechurae","Synodus evermanni","Alepisauridae","Alepisaurus ferox","Bathypterois","Myctophidae","Benthosema","Benthosema panamense","Benthosema suborbitale","Centrobranchus nigroocellatus","Ceratoscopelus warmingii","Ceratoscopelus","Ceratoscopelus townsendi","Diaphus theta","Diaphus","Diaphus pacificus","Diogenichthys atlanticus","Diogenichthys","Diogenichthys laternatus","Electrona risso","Lampadena","Gonichthys tenuiculus","Hygophum","Hygophum atratum","Hygophum reinhardtii","Hygophum proximum","Bolinichthys","Bolinichthys longipes","Lampadena urophaos","Lampadena luminosa","Taaningichthys minimus","Lampanyctus","Lampanyctus omostigma","Lampanyctus parvicauda","Lampanyctus steinbecki","Lobianchia gemellarii","Lampanyctus tenuiformis","Loweina rara","Myctophum aurolaternatum","Myctophum nitidulum","Myctophum","Myctophum lychnobium","Myctophum asperum","Lampanyctus nobilis","Notolychnus valdiviae","Notoscopelus","Notoscopelus resplendens","Parvilux boschmai","Parvilux ingens","Protomyctophum thompsoni","Protomyctophum crockeri","Protomyctophum","Stenobrachius leucopsarus","Stenobrachius nannochir","Symbolophorus californiensis","Symbolophorus evermanni","Symbolophorus","Tarletonbeania crenularis","Triphoturus mexicanus","Triphoturus nigrescens","Triphoturus","Scopelengys tristis","Scopelengys","Paralepididae","Lestidiops ringens","Lestidiops","Lestidiops neles","Lestidiops pacificus","Stemonosudis macrura","Stemonosudis","Arctozenus risso","Magnisudis atlantica","Saccopharyngidae","Saccopharynx","Sudis atrox","Saccopharynx lavenbergi","Lestidium","Lestidium bigelowi","Chlorophthalmus","Anotopterus pharao","Uncisudis quadrimaculata","Uncisudis advena","Nemichthyidae","Omosudis lowii","Avocettina","Avocettina infans","Benthalbella","Scopelarchidae","Benthalbella dentata","Benthalbella linguidens","Scopelarchus","Scopelarchus analis","Scopelarchus guentheri","Scopelarchus stephensi","Scopelarchoides nicholsi","Rosenblattichthys volucris","Neoconger vermiformis","Evermannellidae","Evermannella indica","Evermannella ahlstromi","Eurypharynx pelecanoides","Gymnothorax","Mirapinnidae","Eutaeniophorus","Eutaeniophorus festivus","Facciolella gilbertii","Rhynchoconger","Anguilliformes","Nettastomatidae","Bathycongrus macrurus","Congridae","Ariosoma gilberti","Paraconger californiensis","Rhynchoconger nitens","Chiloconger","Nemichthys","Nemichthys scolopaceus","Heteroconger digueti","Cyema atrum","Cyematidae","Leptocephalus holti","Muraenidae","Chlopsis","Gymnothorax mordax","Avocettina bowersii","Serrivomer sector","Ophichthidae","Ophichthus zophochir","Ophichthus","Serrivomeridae","Leptocephalus giganteus","Trachipteridae","Trachipterus","Trachipterus altivelis","Trachipterus fukuzakii","Zu cristatus","Desmodema lorum","Radiicephalus elongatus","Lophotidae","Beryciformes","Sargocentron suborbitalis","Diretmidae","Diretmoides pauciradiatus","Myrophis vafer","Monacanthidae","Aluterus scriptus","Melamphaidae","Melamphaes lugubris","Melamphaes parvus","Melamphaes","Melamphaes simus","Mola mola","Myripristis","Anoplogaster cornuta","Congriscus megastomus","Poromitra","Poromitra crassiceps","Poromitra megalops","Myripristis leiognathus","Lactoria fornasini","Scopeloberyx robustus","Lactoria diaphana","Scopelogadus","Scopelogadus mizolepis bispinosus","Holocentridae","Ostraciidae","Balistidae","Ostracion meleagris","Balistes polylepis","Canthidermis maculata","Diodon hystrix","Tetraodontidae","Diodon eydouxii","Diodon holocanthus","Perciformes","Diodon","Serranidae","Epinephelus","Epinephelinae","Pronotogrammus multifasciatus","Paralabrax clathratus","Serraninae","Paralabrax","Paralabrax nebulifer","Diplectrum","Serranus","Anthiinae","Phtheirichthys lineatus","Hemanthias peruanus","Grammistini","Hemanthias signifer","Priacanthidae","Pristigenys serrula","Remora","Howellidae","Apogon","Apogonidae","Howella","Howella pammelas","Hemanthias","Lutjanus novemfasciatus","Lutjanidae","Xenichthys xanti","Xenistius californiensis","Paranthias colonus","Lutjanus","Lutjanus peru","Haemulon","Pronotogrammus","Pomadasys","Apogon atricaudus","Mullidae","Mulloidichthys dentatus","Apogon retrosella","Atherinopsidae","Atherinops","Lobotes surinamensis","Mugilidae","Mugil","Sphyraenidae","Sphyraena argentea","Sphyraena","Sphyraena ensis","Polynemidae","Gnathanodon speciosus","Selene peruviana","Trachinotus paitensis","Trachinotus kennedyi","Gerreidae","Eucinostomus","Trachinotus rhodopus","Oligoplites saurus","Alectis ciliaris","Carangidae","Caranx","Caranx caballus","Caranx sexfasciatus","Elagatis bipinnulata","Selene","Chloroscombrus","Chloroscombrus orqueta","Decapterus","Decapterus scombrinus","Hemicaranx","Nematistius pectoralis","Naucrates ductor","Oligoplites","Trachurus symmetricus","Seriola rivoliana","Seriola","Seriola lalandi","Selar crumenophthalmus","Seriola peruana","Nomeidae","Nomeus gronovii","Cubiceps","Psenes","Psenes sio","Psenes pellucidus","Cubiceps baxteri","Cubiceps pauciradiatus","Psenes arafurensis","Psenes cyanophrys","Stromateidae","Peprilus simillimus","Psenes maculatus","Amarsipus carlsbergi","Centrolophidae","Icichthys lockingtoni","Icosteus aenigmaticus","Opistognathidae","Tetragonuridae","Tetragonurus cuvieri","Tetragonurus atlanticus","Taractichthys steindachneri","Pteraclis aesticola","Bramidae","Brama","Brama japonica","Brama dussumieri","Coryphaena","Coryphaenidae","Coryphaena hippurus","Coryphaena equiselis","Caristiidae","Caristius maderensis","Scombridae","Auxis","Auxis thazard","Auxis rochei","Euthynnus","Euthynnus lineatus","Caristius","Katsuwonus pelamis","Sarda chiliensis","Sarda orientalis","Scomber japonicus","Acanthocybium solandri","Scomberomorus","Scomberomorus sierra","Thunnus","Thunnus albacares","Istiophoridae","Acanthuridae","Istiophorus platypterus","Luvarus imperialis","Acanthurus triostegus","Gempylidae","Gempylus serpens","Nealotus tripes","Lepidocybium flavobrunneum","Ruvettus pretiosus","Trichiuridae","Lepidopus fitchi","Diplospinus multistriatus","Trichiurus lepturus","Larimus","Haemulidae","Anisotremus davidsonii","Anisotremus","Centropomus","Sparidae","Calamus brachysomus","Chaetodontidae","Atractoscion nobilis","Sciaenidae","Cynoscion","Genyonemus lineatus","Seriphus politus","Cheilotrema saturnum","Ephippidae","Chaetodipterus zonatus","Menticirrhus","Roncador stearnsii","Umbrina roncador","Menticirrhus undulatus","Abudefduf declivifrons","Abudefduf troschelii","Abudefduf","Stegastes","Pomacentridae","Chromis punctipinnis","Stegastes rectifraenum","Hypsypops rubicundus","Mugil cephalus","Mugil curema","Polydactylus approximans","Polydactylus opercularis","Cheilodactylus","Labridae","Halichoeres","Halichoeres semicinctus","Xyrichtys","Oxyjulis californica","Thalassoma","Xyrichtys mundiceps","Polylepion cruentum","Chromis atrilobata","Microspathodon","Scaridae","Scarus","Girella nigricans","Kyphosidae","Kyphosus","Sectator ocyurus","Medialuna californiensis","Scorpaeniformes","Scorpaenidae","Pontinus","Pontinus sierra","Scorpaenodes xyris","Scorpaena","Scorpaena guttata","Sebastes semicinctus","Sebastes saxicola","Sebastes","Sebastes jordani","Sebastes levis","Sebastes paucispinis","Sebastes macdonaldi","Sebastes aurora","Sebastes diploproa","Sebastes lentiginosus","Sebastes pinniger","Sebastes dallii","Sebastes goodei","Sebastes melanostomus","Sebastolobus","Sebastolobus alascanus","Sebastolobus altivelis","Anoplopomatidae","Anoplopoma fimbria","Hexagrammidae","Hexagrammos","Hexagrammos decagrammus","Hexagrammos lagocephalus","Ophiodon elongatus","Zaniolepis","Zaniolepis frenata","Zaniolepis latipinnis","Oxylebius pictus","Ascelichthys rhodorus","Ruscarius meanyi","Orthonopias triacis","Cottidae","Scorpaenichthys marmoratus","Artedius","Artedius harringtoni","Hemilepidotus spinosus","Hemilepidotus hemilepidotus","Icelinus","Leptocottus armatus","Ruscarius creaseri","Chitonotus pugetensis","Artedius fenestralis","Clinocottus analis","Icelinus quadriseriatus","Artedius lateralis","Oligocottus","Paricelinus hopliticus","Enophrys bison","Radulinus asprellus","Oligocottus maculosus","Psychrolutes phrictus","Triglidae","Prionotus","Prionotus stephanophrys","Prionotus ruscarius","Agonidae","Bathyagonus pentacanthus","Odontopyxis trispinosa","Sarritor frenatus","Xeneretmus latifrons","Xeneretmus leiops","Agonopsis sterletus","Bothragonus swanii","Stellerina xyosterna","Agonopsis vulsa","Cyclopteridae","Liparis","Liparis florae","Liparis fucensis","Liparis mucosus","Liparis pulchellus","Careproctus melanurus","Macroramphosidae","Macroramphosus gracilis","Brotula clarkae","Fistulariidae","Ophidion","Acanthogobius flavimanus","Syngnathus leptorhynchus","Cosmocampus arctus","Syngnathidae","Syngnathus","Syngnathus californiensis","Macroramphosus","Aulorhynchus flavidus","Gobiidae","Rhinogobiops nicholsii","Lepidogobius lepidus","Lythrypnus","Lythrypnus dalli","Lythrypnus zebra","Typhlogobius californiensis","Ilypnus gilberti","Dormitator latifrons","Clevelandia ios","Clarkichthys bilineatus","Ptereleotris","Eleotridae","Erotelis armiger","Microdesmus","Malacanthidae","Caulolatilus princeps","Caulolatilus","Pseudoscopelus","Kali","Chiasmodontidae","Chiasmodon subniger","Dactyloscopidae","Gobiesox rhessodon","Rimicola eigenmanni","Batrachoididae","Porichthys","Rimicola","Chaenopsidae","Chaenopsis alepidota","Gobiesocidae","Gobiesox maeandricus","Gobiesox eugrammus","Alloclinus holderi","Labrisomus","Synchiropus atrilabiatus","Labrisomidae","Cryptotrema corallinum","Labrisomus multiporosus","Labrisomus xanti","Uranoscopidae","Astroscopus","Neoclinus blanchardi","Neoclinus","Neoclinus stephensae","Clinidae","Gibbonsia","Heterostichus rostratus","Zoarcoidei","Microdesmidae","Blennioidei","Stichaeidae","Anoplarchus purpurescens","Pholidae","Plectobranchus evides","Blenniidae","Hypsoblennius","Hypsoblennius gentilis","Hypsoblennius jenkinsi","Hypsoblennius gilberti","Bathymasteridae","Rathbunella","Rathbunella alleni","Ronquilus jordani","Entomacrodus chiostictus","Zoarcidae","Paraclinus integripinnis","Anarrhichthys ocellatus","Hypsoblennius proteus","Hypsoblennius brevipinnis","Bythitidae","Brosmophycis marginata","Cataetyx rubrirostris","Ophioblennius steindachneri","Ophidiiformes","Ophidiidae","Ophidion scrippsae","Chilara taylori","Cherublemma emmelas","Paraclinus","Carapidae","Echiodon exsilium","Scartichthys","Kali normani","Lepophidium","Ammodytidae","Ammodytes hexapterus","Lamprogrammus niger","Lycenchelys","Ammodytoides gilli","Bregmacerotidae","Bregmaceros","Bregmaceros bathymaster","Lycodapus mandibularis","Melanonus zugmayeri","Melanostigma pammelas","Coryphaenoides","Coryphaenoides acrolepis","Coryphaenoides leptolepis","Nezumia","Macrouridae","Albatrossia pectoralis","Lepophidium negropinna","Malacoctenus hubbsi","Merluccius","Merlucciidae","Merluccius productus","Merluccius gayi","Lophiodes spilurus","Gadus macrocephalus","Gadidae","Microgadus proximus","Gadus chalcogrammus","Physiculus","Moridae","Physiculus rastrelliger","Physiculus nematopus","Citharichthys gordae","Etropus","Syacium","Pleuronectiformes","Bothidae","Bothus","Bothus leopardinus","Paralichthyidae","Citharichthys platophrys","Citharichthys fragilis","Citharichthys gilberti","Citharichthys sordidus","Citharichthys","Citharichthys stigmaeus","Citharichthys xanthostigma","Syacium ovale","Etropus crossotus","Hippoglossina stomata","Cyclopsetta","Engyophrys sanctilaurentii","Paralichthys californicus","Hippoglossina","Paralichthys","Perissias taeniopterus","Xystreurys liolepis","Monolene","Etropus peruvianus","Cyclopsetta panamensis","Pleuronectidae","Glyptocephalus zachirus","Hypsopsetta guttulata","Lyopsetta exilis","Lepidopsetta bilineata","Hippoglossus stenolepis","Microstomus pacificus","Hippoglossoides elassodon","Parophrys vetulus","Platichthys stellatus","Reinhardtius hippoglossoides","Pleuronichthys coenosus","Pleuronichthys decurrens","Pleuronichthys ritteri","Pleuronichthys","Pleuronichthys verticalis","Lophiodes caulinaris","Oneirodes eschrichtii","Psettichthys melanostictus","Atheresthes stomias","Eopsetta jordani","Embassichthys bathybius","Isopsetta isolepis","Symphurus elongatus","Cynoglossidae","Symphurus","Symphurus atricaudus","Soleidae","Achirus mazatlanus","Symphurus callopterus","Lophiiformes","Borophryne apogon","Zalieutes elater","Borophryne","Lophiidae","Dolopichthys","Antennarius avalonis","Cryptopsaras couesii","Ceratias holboelli","Antennariidae","Antennarius","Chaenophryne","Centrophryne spinulosa","Melanocetus","Chaunacidae","Chaunax","Caulophryne","Caulophryne pelagica","Melanocetus johnsonii","Ogcocephalioidei","Oneirodidae","Ceratiidae","Linophrynidae","Melanocetidae","Gigantactinidae","Gigantactis","Linophryne","Ogcocephalidae","Oneirodes","Chlopsidae","Bathycongrus","Gnathophis cinctus","Derichthys serpentinus","Ariosoma","Ariosoma marginatum","Serrivomer beanii","Hoplunnis","Hoplunnis sicarius","Encrasicholina punctifer","Bathylagoides","Melanolagus bericoides","Dolichopteryx","Maurolicinae","Margrethia obtusirostra","Sigmops","Gonostoma elongatum","Sigmops gracilis","Gonostoma bathyphilum","Phosichthyidae","Vinciguerria attenuata","Stomiidae","Borostomias","Bathophilus brevis","Aristostomias","Idiacanthus fasciola","Gigantura indica","Aulopus bajacali","Benthalbella infans","Rosenblattichthys hubbsi","Scopelarchus michaelsarsi","Ahliesaurus brevis","Scopelosaurus hoedti","Scopelosaurus smithii","Scopelosaurus hubbsi","Synodus binotatus","Trachinocephalus myops","Lestidiops indopacifica","Lestrolepis","Lestrolepis intermedia","Lestrolepis japonica","Stemonosudis elegans","Uncisudis","Coccorella atlantica","Evermannella","Bolinichthys distofax","Diaphus anderseni","Lampanyctus acanthurus","Notoscopelus caudispinosus","Benthosema fibulatum","Centrobranchus andreae","Hygophum hygomii","Lampris guttatus","Stylephorus chordatus","Gadiformes","Mesobius berryi","Laemonema verecundum","Brotula","Spectrunculus grandis","Echiodon","Encheliophis","Porichthys notatus","Himantolophus","Lophodolos indicus","Ceratias","Gobiesox","Odontesthes regia","Tylosurus pacificus","Hemiramphus depauperatus","Hyporhamphus acutus pacificus","Hyporhamphus rosae","Hyporhamphus unifasciatus","Parexocoetus brachypterus","Prognichthys sealei","Scopeloberyx","Diretmichthys parini","Diretmus argenteus","Beryx splendens","Holocentrinae","Myripristinae","Zenion","Aulostomus chinensis","Fistularia corneta","Syngnathus exilis","Hippocampus kuda","Hexagrammos stelleri","Hemilepidotus","Clinocottus","Oligocottus snyderi","Radulinus","Bathyagonus","Synchirus gilli","Nectoliparis pelagicus","Paralabrax maculatofasciatus","Luzonichthys","Pseudogramma thaumasium","Epinephelus analogus","Symphysanodon","Apogon guadalupensis","Pseudamiops","Epigonus","Trachinotus","Echeneidae","Lutjanus argentiventris","Hoplopagrus guentherii","Conodon serrifer","Polydactylus","Chaetodon","Pomacanthidae","Centropyge","Cirrhitidae","Opistognathus","Chromis","Plectroglyphidodon imparipennis","Bodianus diplotaenia","Halichoeres dispilus","Oxycheilinus","Pseudocheilinus","Iniistius pavo","Calotomus","Nicholsina denticulata","Chiasmodon","Champsodon","Pinguipedidae","Parapercis","Parapercis schauinslandii","Crystallodytes cookei","Limnichthys","Ammodytoides pylei","Kathetostoma averruncus","Cryptacanthodes aleutensis","Cebidichthys violaceus","Chirolophis","Pholis","Chirolophis decoratus","Apodichthys sanctaerosae","Gibbonsia elegans","Gibbonsia metzi","Gillellus","Cirripectes","Plagiotremus","Callionymidae","Gillichthys mirabilis","Gnatholepis","Gobulus crescentalis","Quietula y-cauda","Oxyurichthys","Cerdale","Gunnellichthys curiosus","Microdesmus multiradiatus","Microdesmus suttkusi","Ptereleotrinae","Ptereleotris heteroptera","Acanthurus","Ctenochaetus hawaiiensis","Naso","Scombroidei","Scombrolabrax heterolepis","Nesiarchus nasutus","Aphanopus arigato","Assurger anzac","Lepidopus calcar","Bothus pantherinus","Engyprosopon","Monolene asaedae","Parabothus","Samariscus","Achirus","Sphoeroides","Sphoeroides lobatus","Diodontidae","Chilomycterus","Aseraggodes","Orthopristis","Micropogonias","Xeneretmus","Sebastes aleutianus","Sebastes alutus","Sebastes atrovirens","Sebastes auriculatus","Sebastes babcocki","Sebastes borealis","Sebastes brevispinis","Sebastes carnatus","Sebastes caurinus","Sebastes chlorostictus","Sebastes chrysomelas","Sebastes constellatus","Sebastes crameri","Sebastes elongatus","Sebastes ensifer","Sebastes entomelas","Sebastes eos","Sebastes flavidus","Sebastes gilli","Sebastes helvomaculatus","Sebastes hopkinsi","Sebastes maliger","Sebastes melanops","Sebastes miniatus","Sebastes moseri","Sebastes mystinus","Sebastes nebulosus","Sebastes nigrocinctus","Sebastes ovalis","Sebastes phillipsi","Sebastes proriger","Sebastes rastrelliger","Sebastes reedi","Sebastes rosaceus","Sebastes rosenblatti","Sebastes ruberrimus","Sebastes rubrivinctus","Sebastes rufinanus","Sebastes rufus","Sebastes serranoides","Sebastes serriceps","Sebastes simulator","Sebastes umbrosus","Sebastes wilsoni","Sebastes zacentrus","Lepophidium stigmatistium","Animalia","Halobates","Palinuridae","Euprymna scolopes","Heteroteuthis hawaiiensis","Teuthida","Enoploteuthidae","Abralia","Abralia trigonura","Abraliopsis affinis","Abraliopsis","Abraliopsis felis","Enoploteuthis","Enoploteuthis jonesi","Ancistrocheirus lesueurii","Pyroteuthidae","Pterygioteuthis","Pterygioteuthis gemmata","Pterygioteuthis giardi","Pyroteuthis","Pyroteuthis addolux","Octopoteuthidae","Octopoteuthis","Octopoteuthis deletron","Octopoteuthis nielseni","Onychoteuthidae","Moroteuthis","Onychoteuthis","Onychoteuthis borealijaponicus","Onychoteuthis compacta","Onychoteuthis banksii","Onykia","Cycloteuthis sirventi","Gonatidae","Berryteuthis","Gonatopsis borealis","Gonatus","Gonatus onyx","Gonatus pyros","Histioteuthis","Histioteuthis heteropsis","Histioteuthis hoylei","Chtenopteryx sicula","Brachioteuthis","Ommastrephidae","Dosidicus gigas","Eucleoteuthis luminosa","Nototodarus hawaiiensis","Ommastrephes bartramii","Sthenoteuthis oualaniensis","Hyaloteuthis pelagica","Thysanoteuthidae","Chiroteuthidae","Chiroteuthis","Chiroteuthis calyx","Chiroteuthis imperator","Planctoteuthis","Mastigoteuthis inermis","Mastigoteuthis pyrodes","Cranchiidae","Cranchiinae","Cranchia scabra","Drechselia danae","Liocranchia","Liocranchia reinhardti","Leachia pacifica","Taoniinae","Galiteuthis","Galiteuthis pacifica","Galiteuthis phyllura","Helicocranchia pfefferi","Liguriella podophthalma","Megalocranchia","Eledonella pygmaea","Japetella","Japetella diaphana","Vitreledonellidae","Octopodidae","Octopus","Tremoctopus","Tremoctopus violaceus","Ocythoe tuberculata","Argonauta","Argonauta argo","Haliphron atlanticus","Pyrosoma","Siphonophorae","Grimothea planipes","Salpida","Cnidaria","Crustacea","Heteropoda","Gastropoda","Velella velella","Ctenophora","Cirripedia"],[293496,153689,275403,151805,157878,10297,584793,125464,158694,217452,151159,277552,845703,125465,158697,275512,272287,272286,268692,280092,217625,125507,125868,272849,272857,126688,272944,234630,281579,125514,272884,125513,272950,279422,125512,10304,126731,281482,126730,125508,272897,125885,125892,274943,127288,125893,272926,272927,313514,125509,282406,712443,281374,272919,125888,712444,313514,126720,254551,125601,126187,127282,154831,127289,126189,127293,279335,280483,127292,126188,127292,126191,274954,127316,126194,274961,127304,283166,127303,158835,127312,126197,125603,126196,158836,127307,127309,158837,127314,126199,10304,10306,154228,275004,275018,126202,127315,275052,154227,275178,154229,126203,275045,275046,127365,281926,126208,126212,126220,126217,127370,282922,154693,275007,126205,154226,275055,127338,125692,126385,154230,275151,126211,272166,275978,125454,280366,280365,277927,217869,125453,279812,268430,279813,281344,125451,159246,272178,126383,278730,125452,217871,220012,125691,126382,280791,125693,272170,126386,205070,10309,126392,126387,272153,125696,125445,125672,125441,125663,272130,272139,125449,125686,272132,272140,272124,125439,126333,125669,125498,125815,272648,126581,126584,126586,125818,272656,272694,125819,272684,126599,125820,272701,126600,125824,272702,125823,272704,126604,217700,125816,272650,126609,158896,126632,125825,272714,272715,272717,158901,158898,126625,217715,126626,125829,272723,317659,158897,126629,125831,158916,282177,282178,272732,272731,125832,254363,254364,272733,217718,125833,282927,278566,217721,205908,126636,125836,125447,272096,125675,272094,272095,220334,158749,126352,126359,125586,126138,158752,274336,158870,398374,125664,126334,126364,272101,125432,272087,125638,126304,125681,125448,254572,272103,125683,126367,217724,272107,275617,272106,275441,125443,126339,272063,127165,125636,125460,125711,126409,271908,158570,10295,125433,276870,125427,271722,271789,275426,268744,125639,126306,271778,127164,125583,125583,125431,125621,271856,271904,272005,125434,271991,125647,125435,314780,125483,125788,272531,272532,126529,275872,126524,125479,10322,1021098,125457,126397,275496,125610,159491,125599,274932,274935,126181,127269,127405,159383,126393,280374,126182,127273,127274,276199,219902,127276,219903,126184,306621,125458,125611,125607,219905,275234,127398,127403,125612,127401,127402,11014,126231,125561,126068,151758,282366,282054,151756,270221,282059,159349,126070,1061345,126849,275930,151758,275931,125555,276037,125964,267023,125913,125518,126040,273683,159223,276544,151453,283177,1577329,282083,159791,276546,158806,270526,126011,272978,125547,277990,273084,266995,268431,126973,125546,126032,125565,273978,126084,273979,125551,218429,273286,273296,273292,151456,159731,273297,159645,159629,125523,125936,273271,218404,126809,125943,159481,276245,125937,273279,159638,281664,126811,159642,273305,126818,125944,218436,159646,276650,125548,126991,126037,126039,273682,126993,219745,159424,273681,159427,125567,276563,126992,219735,125526,279354,281153,151443,125569,127080,127079,221420,273151,125520,125924,273148,221416,125960,125531,126846,126845,125524,282011,125559,126057,127016,127015,126058,273806,125947,127018,293729,219713,127022,127014,126064,273821,126065,127027,125539,125515,158812,126974,219630,125536,126862,126864,126863,126867,125571,274018,126861,127089,159319,125538,279617,268319,268680,125564,275967,125528,278535,125558,159304,280830,282761,280137,151426,276412,159324,282628,273802,276150,273698,273702,126044,203822,125553,273751,276680,281130,126983,159416,276587,367295,205497,125541,158813,275798,126025,240727,126024,273604,282314,1580692,269877,125557,159299,280865,125540,126015,1018702,281541,154247,125595,126170,274693,274756,126171,274713,274851,274848,126175,274806,274812,274833,274814,274774,274787,274811,274836,274786,274798,274819,270859,282740,282741,154666,159463,154415,240731,240732,240735,240745,271274,283208,283209,240743,279706,282637,281935,125589,282726,268390,279701,279413,254521,269476,254345,282636,280162,279700,280219,281141,279702,270085,282147,275355,282541,281872,274678,125598,159569,276291,276290,125588,254506,281836,254374,283171,283172,279521,279947,254366,279522,125590,126160,274513,274515,274527,274533,254549,154403,275181,275888,154577,125863,279475,275218,293571,125606,126227,275218,126222,279839,125537,282580,281292,269761,281457,281472,283075,281174,276408,280215,280208,204246,151420,280709,159407,151447,276217,159400,125958,125957,125529,273379,151416,275679,282616,125450,158783,270760,151415,293559,125477,275671,275669,279560,269590,273238,151414,280447,281258,281266,125573,159250,281679,269994,281685,125530,269206,281075,151739,151423,1517542,125566,279633,125550,282283,125519,159603,276323,276328,276324,151388,270703,282555,282629,277243,125575,282025,279605,276330,276319,125503,280000,272767,273126,10314,125505,272835,280146,280144,270199,125504,272782,270817,302801,158761,125516,254510,126672,126103,276856,125468,125727,272290,279391,126483,274134,125748,272313,158959,125754,125471,236135,275623,281499,125762,125473,272458,293628,278534,254538,125469,275873,300735,125770,125474,272510,272504,275690,158797,158875,10331,125576,126110,274186,154168,275693,275687,275688,275694,158786,275696,275699,275843,158799,275827,158794,276187,275809,158831,158823,282219,283199,159208,275709,275702,125579,274287,293680,281452,281305,274290,274294,274289,254393,154781,127144,282290,282292,282294,270459,282295,278525,126572,282396,279792,280690,305684,281189,274241,125578,126113,305635,125581,279494,274237,10316,279941,283203,268562,125493,125807,712506,126538,126537,125484,125790,125805,126536,125803,125488,125796,125792,272546,126556,10316,125496,125487,125492,125494,125490,125798,125801,125495,125811,125426,203953,271755,126291,125622,271725,126319,158589,275449,219982,268508,126721,125895,154224,127297,221510,221512,279336,398363,125602,127302,125604,126204,127329,126201,127354,158858,272041,126365,126366,126368,272078,272084,126350,272085,217674,158884,220327,158872,158873,275835,220335,125680,126337,125666,272649,272657,272709,158914,217681,272653,126603,126522,126526,10313,1524320,272479,159065,126678,125854,206890,275658,125799,272619,125794,158785,281830,272147,272176,1018969,272195,159281,217872,217874,126183,126396,126398,126395,267057,267056,126245,217964,276231,275223,212237,254545,248338,268796,281875,270690,254303,282921,281641,282058,203852,398485,273835,159830,273016,206303,125967,125945,125533,276524,281087,280387,159849,125954,151470,206379,151475,159746,126045,212856,273527,275763,205227,205714,219004,203850,276038,125956,206066,151413,204083,219158,280453,204983,276859,275989,276390,280053,126086,126041,254576,322270,280833,280835,269211,203854,205546,125522,280851,204522,280908,282537,125998,268690,219608,293677,276230,151752,219617,125908,277561,205230,151748,127030,126865,274008,279766,274016,219795,204480,1015120,270184,206731,268211,126241,275279,125608,126230,268394,158809,151157,271228,274771,254573,274772,274773,274775,274777,274778,274779,274780,274781,240737,274783,274785,274788,274790,274791,274792,274795,274796,274799,274800,274815,274817,274820,274822,274823,274824,274825,274830,274835,274838,274839,274840,274841,274842,274844,274845,274846,274847,274852,274853,274854,274862,274868,274869,275628,2,204105,106794,342322,342189,11716,11740,137930,341844,341845,137931,341849,341421,342299,138747,23109,138422,342104,141097,138423,342242,11741,138271,342057,818990,11742,138292,138291,342069,342070,140649,138292,139472,11743,341413,342326,138036,341859,341861,138074,341868,410403,181377,137697,11760,342291,342313,342376,181382,342066,342337,11762,11767,137777,341796,341798,238752,341901,834048,11774,559391,181386,559389,137851,341818,341815,325296,137848,341806,341807,139424,342354,137852,410340,137695,138849,742053,11782,138268,138563,141694,140610,137676,138803,341781,137224,1371,1607504,137214,1267,1066,382213,101,117832,1248,1082],[161105,161109,161112,161119,161120,161694,161743,161700,161747,161729,551209,161757,160833,553173,161837,161847,551340,161828,161860,161862,162838,162303,162308,162316,162350,162367,623649,162305,623659,553188,182875,162028,623655,162030,162099,162056,162103,162101,162109,162057,162068,162061,162093,162165,162167,162058,162059,623630,182856,162080,623626,623379,623625,162086,162081,623380,162096,623331,162098,162163,162164,162172,162168,162175,162182,162183,622492,162232,622691,162179,162181,162198,622698,162203,162192,182865,162195,162211,162194,622360,162187,162186,162212,162213,162214,162216,162219,162221,162227,162226,553133,553138,622316,622675,622505,162234,162228,162241,622317,162290,622318,162243,622559,162244,622394,622645,162248,162254,162286,162295,162296,162247,622320,162274,162278,622321,162279,162281,165506,165508,622319,162301,162299,645246,165555,165607,165609,165610,645264,165509,553172,165986,630593,166012,166014,165546,165548,165463,616685,645247,165431,165520,165504,165433,616688,165511,165515,645257,616693,165523,162368,165612,165517,645237,165473,553189,162565,644666,162370,644734,644735,162374,162375,162378,644736,644732,162523,162527,162439,162575,162679,623748,162682,162732,623722,162576,162577,162584,162583,623790,162676,162675,162677,623732,162702,623813,162692,162695,623875,623721,162761,623750,162703,162706,162742,162632,182885,623832,623836,623876,623716,162717,162727,162726,162719,623845,162721,162643,162729,162653,162654,623860,162771,162687,162685,162684,162664,162665,623871,162671,162666,162673,162766,623873,162765,162777,162776,162463,644717,162476,644724,644725,644731,162501,644687,644691,161644,161645,162505,635769,162464,644835,162428,162534,644716,644693,161612,644694,161614,161619,162549,162548,162550,644721,162553,162555,162561,644730,644696,644711,635484,162535,162544,644723,161653,161185,162809,162814,162815,635857,635342,161123,161301,635917,161324,635894,635695,635725,635341,161621,161624,635966,161632,161630,635826,161160,161157,161194,635681,161609,161419,161469,161458,161603,635825,166339,166340,166341,166343,166353,166351,615910,166332,166083,622127,166131,622112,161454,203428,173134,166092,166094,649666,166093,166103,173414,166210,166152,635931,166107,166108,166110,166238,173255,182909,173257,166115,182911,166170,173235,173128,173252,173140,173169,173391,173283,615870,173392,167640,173390,167674,167694,551018,167841,167832,643089,167830,167834,167791,167849,167675,168578,167802,643093,167804,168176,168192,168568,641836,168197,168196,168331,641889,167799,168890,168845,630232,169118,551113,168846,168897,169057,167839,169091,642065,169406,169414,168278,630579,165985,169007,170333,170334,170424,170426,170425,170437,170445,168753,168683,168714,168713,169013,169014,168715,168673,168602,168584,168605,168611,168620,168738,168679,168669,168671,168723,168731,168739,168744,168742,168672,168586,168691,168688,168695,168677,641997,172535,172554,172545,172555,642597,172558,642573,172546,172560,172556,172563,172565,172557,642535,172508,172510,171663,170920,172578,172580,172581,170313,170309,170287,170288,170289,170292,168790,168789,168791,168792,168820,645450,172398,172454,172456,172455,172399,172405,168821,172401,172408,172410,172412,172451,172434,172440,172418,172423,172486,172250,172488,172485,172270,172354,172360,172368,172362,172364,172378,172393,172376,172385,169268,169055,553364,169080,167643,169180,169204,169554,169387,169237,169238,169257,169362,169358,553178,169540,169273,646515,169303,169280,615041,170054,170045,613171,170044,170085,615080,170120,170335,170336,170449,170452,170253,170477,170501,170511,613036,170597,170567,614509,614109,170102,170115,170809,170810,169515,169503,169504,169527,169522,166702,166704,166798,644371,166864,166811,166827,166762,166741,166705,166725,166754,166733,166755,166709,166716,166769,166734,644576,166722,166728,166782,166783,166784,167121,167123,167108,167109,167110,167111,167116,167127,167129,167128,167118,167218,167424,167388,167196,692068,167211,167213,167283,167279,167290,167302,167422,167380,167212,167227,167298,167214,167332,167338,167267,167347,167333,167414,166972,166973,166995,166993,167426,167450,167460,167464,167467,167469,167431,643659,167472,167428,167483,167550,167559,167560,167570,167572,167504,644842,551496,164821,166414,164839,171882,166462,166603,166443,166444,166457,551495,166404,171746,636877,171762,171898,171899,171903,171914,171892,171918,171748,637146,171953,172171,637280,172163,168537,168540,168539,171093,171087,171084,630466,171036,164464,164467,164412,164413,164465,171550,171467,164457,164459,164461,171465,171408,642601,553227,171472,638559,171418,171053,171054,171478,171477,171479,171396,171397,171476,165214,172161,171123,171554,171564,171632,171592,171124,171155,171158,171160,171159,170945,170952,170953,170951,171184,165215,171432,171345,636384,636379,165140,164809,164905,636462,553139,164807,164856,165006,164998,171427,165094,165117,636246,171091,164823,171670,171672,164933,165230,630395,164694,164695,550687,165253,164746,165295,165333,165334,622867,165393,165332,165427,623190,638573,164790,164789,164792,164799,649761,164711,164701,164719,934083,164678,164670,164681,550848,616291,172728,172790,172702,172714,172758,616278,553179,616294,172727,616289,172716,172715,172717,172726,616481,172729,172784,172775,616354,172743,172782,172734,616165,172800,172785,616374,616306,172859,172978,172945,172871,172917,172932,172887,172875,172921,172893,172930,172923,172924,172925,172922,172926,164508,622880,172928,172862,172868,172866,172919,616489,173060,173061,616607,172980,172989,616485,164495,622907,164598,622778,164497,164635,164529,623188,164655,164518,164522,164626,164652,164612,164569,164570,164660,649743,622873,553153,164625,164653,164661,164611,164642,164643,164662,164573,164629,553181,635345,635714,161601,161343,635690,635762,161289,635754,161879,623317,623332,162102,622314,622694,622342,162185,622490,162184,622313,162193,162282,162239,622372,162273,162300,644689,644741,162552,644709,162558,644705,162570,162569,644826,162384,162420,644790,162515,162516,644793,644829,162517,162537,162541,623739,162586,623827,162657,623747,162734,623714,166326,166360,164665,623139,623030,164817,622862,165114,165119,164414,164623,690540,164654,164458,630683,645131,165464,165483,165477,165474,165522,165528,166112,622111,166133,166156,622094,622095,166276,166412,644991,166461,166495,167113,167276,167222,167335,167346,167444,167365,167591,167833,643104,643392,167697,167907,168211,168312,168295,168707,168567,168851,643073,630219,170446,169555,553237,169610,170222,170925,170079,170129,170494,613701,613121,170628,170765,170871,614667,171085,171081,553226,170958,170959,171019,171026,630417,171063,171610,171618,171565,171637,171572,630995,171401,171398,171037,636225,171206,171691,171967,171827,637464,171910,171945,172168,637470,637628,637630,636573,171956,172251,172306,172288,172353,172366,172370,646749,172397,551142,172764,172816,1007802,172822,172946,172984,173289,173301,173382,173383,172996,169076,169282,167466,166706,166707,166747,166708,166710,166712,166711,166767,166713,166748,166773,166749,166715,166717,166768,166719,166751,166720,166752,166723,166753,166726,166727,166729,644590,166730,166731,166732,166757,166758,166736,166759,166737,166738,166771,166740,166760,166772,166761,166763,166764,166770,166765,166743,166744,164838,202423,103825,97646,556020,556001,82367,82397,82406,556021,82402,82398,82401,82396,556064,556106,555715,82404,556078,82405,555803,556639,82431,82432,556640,556422,82436,82437,82439,82442,556017,82440,82443,82567,82414,82429,82417,82418,82425,82423,82485,82499,556138,82469,82474,82514,82538,556451,556014,82527,556284,556061,82544,82547,82548,82551,556080,555776,556383,82559,82575,555740,82578,556251,555779,556517,556231,555741,205734,556426,556714,205733,556232,555782,82658,82654,82655,82660,82590,82595,82667,82668,82678,82681,82683,205738,159635,718928,1202386,159643,48738,83677,872208,69459,51267,53856,89433],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>species_id<\/th>\n      <th>scientific_name<\/th>\n      <th>worms_id<\/th>\n      <th>itis_id<\/th>\n      <th>gbif_id<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,3,4,5]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"species_id","targets":1},{"name":"scientific_name","targets":2},{"name":"worms_id","targets":3},{"name":"itis_id","targets":4},{"name":"gbif_id","targets":5}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check if taxon table already exists with data</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>taxon_exists <span class="ot">&lt;-</span> <span class="st">"taxon"</span> <span class="sc">%in%</span> existing_tables <span class="sc">&amp;&amp;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con, <span class="st">"SELECT COUNT(*) AS n FROM taxon"</span>)<span class="sc">$</span>n <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (taxon_exists <span class="sc">&amp;&amp;</span> <span class="sc">!</span>overwrite) {</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Taxon table already exists, skipping API calls"</span>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  taxon_rows <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbReadTable</span>(con, <span class="st">"taxon"</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># build taxon hierarchy table (slow - makes API calls)</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  taxon_rows <span class="ot">&lt;-</span> <span class="fu">build_taxon_table</span>(</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">con          =</span> con,</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_tbl  =</span> <span class="st">"species"</span>,</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">taxon_tbl    =</span> <span class="st">"taxon"</span>,</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">include_itis =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co"># show taxon stats</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(taxon_rows) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>  taxon_rows <span class="sc">|&gt;</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>(authority, taxonRank) <span class="sc">|&gt;</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(authority, taxonRank) <span class="sc">|&gt;</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Taxon hierarchy by authority and rank"</span>)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-9e92957924751824bced" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-9e92957924751824bced">{"x":{"filter":"none","vertical":false,"caption":"<caption>Taxon hierarchy by authority and rank<\/caption>","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20"],["WoRMS","WoRMS","WoRMS","WoRMS","WoRMS","WoRMS","WoRMS","WoRMS","WoRMS","WoRMS","WoRMS","WoRMS","WoRMS","WoRMS","WoRMS","WoRMS","WoRMS","WoRMS","WoRMS","WoRMS"],["Class","Family","Genus","Gigaclass","Infraclass","Infraorder","Infraphylum","Kingdom","Order","Parvphylum","Phylum","Species","Subclass","Subfamily","Suborder","Subphylum","Superclass","Superfamily","Superorder","Tribe"],[9,220,535,1,2,3,1,1,55,2,5,691,7,88,24,4,3,12,3,5]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>authority<\/th>\n      <th>taxonRank<\/th>\n      <th>n<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":3},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"authority","targets":1},{"name":"taxonRank","targets":2},{"name":"n","targets":3}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show taxa_rank lookup</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dbReadTable</span>(con, <span class="st">"taxa_rank"</span>) <span class="sc">|&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Taxa rank ordering"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-304fbcdf4ef3e6e56feb" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-304fbcdf4ef3e6e56feb">{"x":{"filter":"none","vertical":false,"caption":"<caption>Taxa rank ordering<\/caption>","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41"],["Kingdom","Subkingdom","Phylum","Subphylum","Infraphylum","Superclass","Class","Subclass","Infraclass","Megacohort","Supercohort","Cohort","Subcohort","Infracohort","Superorder","Order","Suborder","Infraorder","Parvorder","Superfamily","Family","Subfamily","Supertribe","Tribe","Subtribe","Genus","Subgenus","Series","Subseries","Species","Subspecies","Natio","Mutatio","Form","Forma","Subform","Subforma","Variety","Subvariety","Coll. sp.","Aggr."],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>taxonRank<\/th>\n      <th>rank_order<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"taxonRank","targets":1},{"name":"rank_order","targets":2}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<section id="taxonomy-statistics" class="level3" data-number="0.8.1">
<h3 data-number="0.8.1" class="anchored" data-anchor-id="taxonomy-statistics"><span class="header-section-number">0.8.1</span> Taxonomy Statistics</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>n_species   <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"SELECT COUNT(*) AS n FROM species"</span>)<span class="sc">$</span>n</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>n_worms     <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SELECT COUNT(*) AS n FROM species WHERE worms_id IS NOT NULL"</span>)<span class="sc">$</span>n</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>n_itis      <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SELECT COUNT(*) AS n FROM species WHERE itis_id IS NOT NULL"</span>)<span class="sc">$</span>n</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>n_gbif      <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SELECT COUNT(*) AS n FROM species WHERE gbif_id IS NOT NULL"</span>)<span class="sc">$</span>n</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>n_taxon     <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"SELECT COUNT(*) AS n FROM taxon"</span>)<span class="sc">$</span>n</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">metric =</span> <span class="fu">c</span>(<span class="st">"total species"</span>, <span class="st">"with worms_id"</span>, <span class="st">"with itis_id"</span>,</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>             <span class="st">"with gbif_id"</span>, <span class="st">"taxon hierarchy rows"</span>),</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">count  =</span> <span class="fu">c</span>(n_species, n_worms, n_itis, n_gbif, n_taxon)) <span class="sc">|&gt;</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Taxonomy standardization summary"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-2466bf6c5135722bb0a8" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-2466bf6c5135722bb0a8">{"x":{"filter":"none","vertical":false,"caption":"<caption>Taxonomy standardization summary<\/caption>","data":[["1","2","3","4","5"],["total species","with worms_id","with itis_id","with gbif_id","taxon hierarchy rows"],[1144,1144,1144,0,1671]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>metric<\/th>\n      <th>count<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"metric","targets":1},{"name":"count","targets":2}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
</section>
<section id="validate-cross-dataset-integrity" class="level2" data-number="0.9">
<h2 data-number="0.9" class="anchored" data-anchor-id="validate-cross-dataset-integrity"><span class="header-section-number">0.9</span> Validate Cross-Dataset Integrity</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># grid_key integrity: casts.grid_key should all be in grid.grid_key</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">"grid_key"</span> <span class="sc">%in%</span> <span class="fu">dbListFields</span>(con, <span class="st">"casts"</span>) <span class="sc">&amp;&amp;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"grid_key"</span> <span class="sc">%in%</span> <span class="fu">dbListFields</span>(con, <span class="st">"grid"</span>)) {</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  grid_orphans <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT COUNT(*) AS n FROM casts c</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE c.grid_key IS NOT NULL</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="st">      AND c.grid_key NOT IN (SELECT grid_key FROM grid)"</span>)<span class="sc">$</span>n</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Grid key orphans in casts: {grid_orphans}"</span>))</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ship PK uniqueness</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>ship_dups <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT ship_key, COUNT(*) AS n FROM ship</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="st">  GROUP BY ship_key HAVING COUNT(*) &gt; 1"</span>)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(ship_dups) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="fu">glue</span>(<span class="st">"Duplicate ship_key values: {nrow(ship_dups)}"</span>))</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="co"># cruise PK uniqueness</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>cruise_dups <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT cruise_key, COUNT(*) AS n FROM cruise</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="st">  GROUP BY cruise_key HAVING COUNT(*) &gt; 1"</span>)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(cruise_dups) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="fu">glue</span>(<span class="st">"Duplicate cruise_key values: {nrow(cruise_dups)}"</span>))</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="co"># cruise bridge match statistics</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>bridge_stats <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="st">    COUNT(*) AS total_casts,</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="st">    SUM(CASE WHEN ship_key IS NOT NULL THEN 1 ELSE 0 END) AS with_ship_key,</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="st">    SUM(CASE WHEN cruise_key IS NOT NULL THEN 1 ELSE 0 END) AS with_cruise_key</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM casts"</span>)</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>bridge_stats <span class="sc">|&gt;</span> <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Cruise bridge coverage"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-aa2cbef019ff3219027f" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-aa2cbef019ff3219027f">{"x":{"filter":"none","vertical":false,"caption":"<caption>Cruise bridge coverage<\/caption>","data":[["1"],[35644],[35595],[35644]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>total_casts<\/th>\n      <th>with_ship_key<\/th>\n      <th>with_cruise_key<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,2,3]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"total_casts","targets":1},{"name":"with_ship_key","targets":2},{"name":"with_cruise_key","targets":3}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Cross-dataset validation complete"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="show-combined-schema" class="level2" data-number="0.10">
<h2 data-number="0.10" class="anchored" data-anchor-id="show-combined-schema"><span class="header-section-number">0.10</span> Show Combined Schema</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># build dm from connection (exclude internal tables)</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>tbls <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">dbListTables</span>(con), <span class="fu">c</span>(<span class="st">"_sp_update"</span>))</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> dm<span class="sc">::</span><span class="fu">dm_from_con</span>(con, <span class="at">table_names =</span> tbls, <span class="at">learn_keys =</span> <span class="cn">FALSE</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co"># set table colors by group</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  dm<span class="sc">::</span><span class="fu">dm_set_colors</span>(</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">lightblue    =</span> <span class="fu">c</span>(cruise, site, tow, net),      <span class="co"># ichthyo chain</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">lightyellow  =</span> <span class="fu">c</span>(ichthyo, species, lookup),     <span class="co"># species/lookup</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">lightgreen   =</span> <span class="fu">c</span>(grid, segment),                <span class="co"># spatial</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">pink         =</span> <span class="fu">c</span>(casts, bottle, bottle_measurement,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>                     cast_condition, measurement_type))  <span class="co"># bottle chain</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="co"># add colors for new taxonomy tables if they exist</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">"taxon"</span> <span class="sc">%in%</span> tbls)</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> dm<span class="sc">::</span><span class="fu">dm_set_colors</span>(<span class="at">lightyellow =</span> taxon)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">"taxa_rank"</span> <span class="sc">%in%</span> tbls)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> dm<span class="sc">::</span><span class="fu">dm_set_colors</span>(<span class="at">lightyellow =</span> taxa_rank)</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">"ship"</span> <span class="sc">%in%</span> tbls)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> dm<span class="sc">::</span><span class="fu">dm_set_colors</span>(<span class="at">lightblue =</span> ship)</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>dm<span class="sc">::</span><span class="fu">dm_draw</span>(d, <span class="at">rankdir =</span> <span class="st">"LR"</span>, <span class="at">view_type =</span> <span class="st">"all"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-728a299c4ad1d77c0eba" style="width:100%;height:541px;"></div>
<script type="application/json" data-for="htmlwidget-728a299c4ad1d77c0eba">{"x":{"diagram":"#data_model\ndigraph {\ngraph [rankdir=LR tooltip=\"Data Model\" ]\n\nnode [margin=0 fontcolor = \"#444444\" ]\n\nedge [color = \"#555555\", arrowsize = 1, ]\n\npack=true\npackmode= \"node\"\n\n  \"bottle\" [id = \"bottle\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#AA8087AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#FFC0CBFF\" BORDER=\"0\"><FONT COLOR=\"#000000\">bottle<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">cast_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">bottle_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">sta_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">depth_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">depth_m<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">btl_num<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">rec_ind<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">depth_qual<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">inc_tim<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">_source_file<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">_source_row<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">_ingested_at<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">_source_uuid<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"bottle_measurement\" [id = \"bottle_measurement\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#AA8087AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#FFC0CBFF\" BORDER=\"0\"><FONT COLOR=\"#000000\">bottle_measurement<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">bottle_measurement_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">bottle_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">measurement_type<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">measurement_value<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">measurement_prec<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">measurement_qual<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"cast_condition\" [id = \"cast_condition\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#AA8087AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#FFC0CBFF\" BORDER=\"0\"><FONT COLOR=\"#000000\">cast_condition<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">cast_condition_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">cast_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">condition_type<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">condition_value<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"casts\" [id = \"casts\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#AA8087AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#FFC0CBFF\" BORDER=\"0\"><FONT COLOR=\"#000000\">casts<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">cast_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">cruise_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">cast_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">sta_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">sta_code<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">distance<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">lat_dec<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">lon_dec<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">rpt_line<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">st_line<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">ac_line<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">rpt_sta<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">st_station<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">ac_sta<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">bottom_depth_m<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">ship_name<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">ship_code<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">data_type<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">order_occ<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">event_num<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">cruz_leg<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">orig_sta_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">data_or<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">int_chl<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">int_c14<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">inc_str<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">inc_end<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">pst_lan<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">civil_t<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">_source_file<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">_source_row<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">_ingested_at<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">_source_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">datetime_utc<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">geom<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">grid_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">ship_key<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"cruise\" [id = \"cruise\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#739099AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#ADD8E6FF\" BORDER=\"0\"><FONT COLOR=\"#000000\">cruise<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">date_ym<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">ship_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_source_file<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_source_row<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_ingested_at<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_source_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">cruise_key<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"grid\" [id = \"grid\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#609E60AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#90EE90FF\" BORDER=\"0\"><FONT COLOR=\"#000000\">grid<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">grid_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">station<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">line<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">shore<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">pattern<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">spacing<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">zone<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">area_km2<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">geom<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">geom_ctr<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"ichthyo\" [id = \"ichthyo\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#AAAA95AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#FFFFE0FF\" BORDER=\"0\"><FONT COLOR=\"#000000\">ichthyo<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">species_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">life_stage<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">measurement_type<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">measurement_value<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">tally<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">_source_file<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">_source_row<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">_ingested_at<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">_source_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">net_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">ichthyo_id<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"lookup\" [id = \"lookup\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#AAAA95AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#FFFFE0FF\" BORDER=\"0\"><FONT COLOR=\"#000000\">lookup<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">lookup_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">lookup_type<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">lookup_num<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">lookup_chr<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">description<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">_source_file<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">_source_row<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">_ingested_at<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">_source_uuid<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"measurement_type\" [id = \"measurement_type\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#AA8087AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#FFC0CBFF\" BORDER=\"0\"><FONT COLOR=\"#000000\">measurement_type<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">measurement_type<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">dataset<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">description<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">units<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">_source_column<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">_source_table<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFF2F4FF\">_source_workflow<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"net\" [id = \"net\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#739099AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#ADD8E6FF\" BORDER=\"0\"><FONT COLOR=\"#000000\">net<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">side<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">std_haul_factor<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">vol_sampled_m3<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">prop_sorted<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">smallplankton<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">totalplankton<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_source_file<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_source_row<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_ingested_at<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_source_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">tow_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">net_id<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"segment\" [id = \"segment\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#609E60AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#90EE90FF\" BORDER=\"0\"><FONT COLOR=\"#000000\">segment<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">cruise_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">site_id_beg<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">site_id_end<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">lon_beg<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">lat_beg<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">lon_end<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">lat_end<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">time_beg<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">time_end<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">time_hr<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">length_km<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">km_per_hr<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">geom<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#E8FBE8FF\">segment_id<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"ship\" [id = \"ship\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#739099AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#ADD8E6FF\" BORDER=\"0\"><FONT COLOR=\"#000000\">ship<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">ship_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">ship_name<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">ship_nodc<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_source_file<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_source_row<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_ingested_at<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_source_uuid<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"site\" [id = \"site\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#739099AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#ADD8E6FF\" BORDER=\"0\"><FONT COLOR=\"#000000\">site<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">orderocc<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">longitude<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">latitude<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">line<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">station<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_source_file<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_source_row<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_ingested_at<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_source_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">cruise_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">site_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">geom<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">grid_key<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"species\" [id = \"species\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#AAAA95AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#FFFFE0FF\" BORDER=\"0\"><FONT COLOR=\"#000000\">species<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">species_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">scientific_name<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">itis_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">worms_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">common_name<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">_source_file<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">_source_row<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">_ingested_at<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">_source_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">gbif_id<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"taxa_rank\" [id = \"taxa_rank\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#AAAA95AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#FFFFE0FF\" BORDER=\"0\"><FONT COLOR=\"#000000\">taxa_rank<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">taxonRank<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">rank_order<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"taxon\" [id = \"taxon\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#AAAA95AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#FFFFE0FF\" BORDER=\"0\"><FONT COLOR=\"#000000\">taxon<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">authority<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">taxonID<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">acceptedNameUsageID<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">parentNameUsageID<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">scientificName<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">taxonRank<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">taxonomicStatus<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFF8FF\">scientificNameAuthorship<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"tow\" [id = \"tow\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#739099AA\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#ADD8E6FF\" BORDER=\"0\"><FONT COLOR=\"#000000\">tow<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">tow_type_key<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">tow_number<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">time_start<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_source_file<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_source_row<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_ingested_at<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">_source_uuid<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">site_id<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#EEF7FAFF\">tow_id<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n\n}","config":{"engine":null,"options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="write-modified-parquet-outputs" class="level2" data-number="0.11">
<h2 data-number="0.11" class="anchored" data-anchor-id="write-modified-parquet-outputs"><span class="header-section-number">0.11</span> Write Modified Parquet Outputs</h2>
<p>Only export tables that differ from upstream (modified or new). Unchanged tables reference upstream GCS URIs in the manifest.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tables modified by this workflow</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>modified_tables <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"casts"</span>,      <span class="co"># added ship_key, cruise_key columns</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"species"</span>,    <span class="co"># updated worms_id, itis_id, gbif_id</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"taxon"</span>,      <span class="co"># new table (taxonomy hierarchy)</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"taxa_rank"</span>)  <span class="co"># new table (rank ordering)</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>dir_pq_merged <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/parquet/merge_ichthyo_bottle"</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>merge_stats <span class="ot">&lt;-</span> <span class="fu">write_parquet_outputs</span>(</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">con              =</span> con,</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_dir       =</span> dir_pq_merged,</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">tables           =</span> modified_tables,</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">strip_provenance =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>merge_stats <span class="sc">|&gt;</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">file =</span> <span class="fu">basename</span>(path)) <span class="sc">|&gt;</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>path) <span class="sc">|&gt;</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Modified parquet export statistics"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-4fb71b237bbc68eda565" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-4fb71b237bbc68eda565">{"x":{"filter":"none","vertical":false,"caption":"<caption>Modified parquet export statistics<\/caption>","data":[["1","2","3","4"],["casts","species","taxon","taxa_rank"],[35644,1144,1671,41],[2136071,42620,36090,817],["casts.parquet","species.parquet","taxon.parquet","taxa_rank.parquet"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table<\/th>\n      <th>rows<\/th>\n      <th>file_size<\/th>\n      <th>file<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"table","targets":1},{"name":"rows","targets":2},{"name":"file_size","targets":3},{"name":"file","targets":4}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<section id="build-combined-manifest" class="level3" data-number="0.11.1">
<h3 data-number="0.11.1" class="anchored" data-anchor-id="build-combined-manifest"><span class="header-section-number">0.11.1</span> Build Combined Manifest</h3>
<p>Reference GCS URIs for unchanged upstream tables + local parquet for modified tables.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read upstream manifests</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>ichthyo_manifest <span class="ot">&lt;-</span> <span class="fu">read_json</span>(ichthyo_manifest_path)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>bottle_manifest  <span class="ot">&lt;-</span> <span class="fu">read_json</span>(bottle_manifest_path)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># build combined manifest</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>manifest <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">created_at      =</span> <span class="fu">as.character</span>(<span class="fu">Sys.time</span>()),</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">release_version =</span> release_version,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">modified_tables =</span> merge_stats <span class="sc">|&gt;</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(table, rows, file_size) <span class="sc">|&gt;</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.list</span>(),</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">upstream_refs   =</span> <span class="fu">list</span>(</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">ichthyo =</span> <span class="fu">list</span>(</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">manifest =</span> ichthyo_manifest<span class="sc">$</span>created_at,</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">tables   =</span> <span class="fu">setdiff</span>(</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>        ichthyo_manifest<span class="sc">$</span>tables,</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>        modified_tables)),</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">bottle  =</span> <span class="fu">list</span>(</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">manifest =</span> bottle_manifest<span class="sc">$</span>created_at,</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">tables   =</span> <span class="fu">setdiff</span>(</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>        bottle_manifest<span class="sc">$</span>tables,</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(modified_tables, <span class="st">"grid"</span>)))))  <span class="co"># grid canonical from swfsc</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>  manifest,</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(dir_pq_merged, <span class="st">"manifest.json"</span>),</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Manifest written: {length(modified_tables)} modified tables, "</span>,</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"upstream refs for {length(manifest$upstream_refs$ichthyo$tables)} "</span>,</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ichthyo + {length(manifest$upstream_refs$bottle$tables)} bottle"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
</section>
<section id="ingest-to-working-ducklake" class="level2" data-number="0.12">
<h2 data-number="0.12" class="anchored" data-anchor-id="ingest-to-working-ducklake"><span class="header-section-number">0.12</span> Ingest to Working DuckLake</h2>
<p>Load ALL tables into Working DuckLake with provenance. Unchanged tables read directly from upstream parquet. Modified tables read from merge output dir.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>con_wdl <span class="ot">&lt;-</span> <span class="fu">get_working_ducklake</span>()</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load_duckdb_extension</span>(con_wdl, <span class="st">"spatial"</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># helper to ingest a parquet file with provenance</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>ingest_pqt <span class="ot">&lt;-</span> <span class="cf">function</span>(pqt_path, tbl_name, source_label) {</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(pqt_path)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ingest_to_working</span>(</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">con         =</span> con_wdl,</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">data        =</span> data,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">table       =</span> tbl_name,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">source_file =</span> source_label,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">mode        =</span> <span class="st">"replace"</span>)</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="co"># ingest ichthyo upstream tables (skip modified ones)</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>ichthyo_upstream <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(ichthyo_manifest<span class="sc">$</span>tables, modified_tables)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>ichthyo_wdl <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(ichthyo_upstream, <span class="cf">function</span>(tbl) {</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  pqt <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_pq_ichthyo, <span class="fu">paste0</span>(tbl, <span class="st">".parquet"</span>))</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(pqt)) {</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ingest_pqt</span>(pqt, tbl, <span class="fu">glue</span>(<span class="st">"parquet/swfsc.noaa.gov_calcofi-db/{tbl}.parquet"</span>))</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a><span class="co"># ingest bottle upstream tables (skip modified + grid)</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>bottle_upstream <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>  bottle_manifest<span class="sc">$</span>tables, <span class="fu">c</span>(modified_tables, <span class="st">"grid"</span>))</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>bottle_wdl <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(bottle_upstream, <span class="cf">function</span>(tbl) {</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>  pqt <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_pq_bottle, <span class="fu">paste0</span>(tbl, <span class="st">".parquet"</span>))</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(pqt)) {</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ingest_pqt</span>(pqt, tbl, <span class="fu">glue</span>(<span class="st">"parquet/calcofi.org_bottle-database/{tbl}.parquet"</span>))</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a><span class="co"># ingest modified tables from merge output</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>merge_wdl <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(modified_tables, <span class="cf">function</span>(tbl) {</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>  pqt <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_pq_merged, <span class="fu">paste0</span>(tbl, <span class="st">".parquet"</span>))</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(pqt)) {</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ingest_pqt</span>(pqt, tbl, <span class="fu">glue</span>(<span class="st">"parquet/merge_ichthyo_bottle/{tbl}.parquet"</span>))</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a><span class="co"># combine stats</span></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>wdl_stats <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>  ichthyo_wdl <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"ichthyo_upstream"</span>),</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>  bottle_wdl  <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"bottle_upstream"</span>),</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>  merge_wdl   <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"merge_modified"</span>))</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>wdl_stats <span class="sc">|&gt;</span> <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Working DuckLake ingestion stats"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-645776a82628367b3685" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-645776a82628367b3685">{"x":{"filter":"none","vertical":false,"caption":"<caption>Working DuckLake ingestion stats<\/caption>","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17"],["cruise","grid","ichthyo","lookup","net","segment","ship","site","tow","bottle","bottle_measurement","cast_condition","measurement_type","casts","species","taxon","taxa_rank"],["replace","replace","replace","replace","replace","replace","replace","replace","replace","replace","replace","replace","replace","replace","replace","replace","replace"],[691,218,830873,26,76512,60413,48,61104,75506,895371,11135600,235513,47,35644,1144,1671,41],[691,218,830873,26,76512,60413,48,61104,75506,895371,11135600,235513,47,35644,1144,1671,41],["2026-02-24T16:03:11Z","2026-02-24T16:03:11Z","2026-02-24T16:03:11Z","2026-02-24T16:03:12Z","2026-02-24T16:03:12Z","2026-02-24T16:03:12Z","2026-02-24T16:03:13Z","2026-02-24T16:03:13Z","2026-02-24T16:03:13Z","2026-02-24T16:03:13Z","2026-02-24T16:03:16Z","2026-02-24T16:03:22Z","2026-02-24T16:03:22Z","2026-02-24T16:03:22Z","2026-02-24T16:03:22Z","2026-02-24T16:03:22Z","2026-02-24T16:03:22Z"],["ichthyo_upstream","ichthyo_upstream","ichthyo_upstream","ichthyo_upstream","ichthyo_upstream","ichthyo_upstream","ichthyo_upstream","ichthyo_upstream","ichthyo_upstream","bottle_upstream","bottle_upstream","bottle_upstream","bottle_upstream","merge_modified","merge_modified","merge_modified","merge_modified"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table<\/th>\n      <th>mode<\/th>\n      <th>rows_input<\/th>\n      <th>rows_after<\/th>\n      <th>ingested_at<\/th>\n      <th>source<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[3,4]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"table","targets":1},{"name":"mode","targets":2},{"name":"rows_input","targets":3},{"name":"rows_after","targets":4},{"name":"ingested_at","targets":5},{"name":"source","targets":6}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="list-working-tables" class="level2" data-number="0.13">
<h2 data-number="0.13" class="anchored" data-anchor-id="list-working-tables"><span class="header-section-number">0.13</span> List Working Tables</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>working_tables <span class="ot">&lt;-</span> <span class="fu">list_working_tables</span>(con_wdl)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>working_tables <span class="sc">|&gt;</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Working DuckLake tables with provenance"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-b51707835f777efa9f2c" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-b51707835f777efa9f2c">{"x":{"filter":"none","vertical":false,"caption":"<caption>Working DuckLake tables with provenance<\/caption>","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17"],["bottle","bottle_measurement","cast_condition","casts","cruise","grid","ichthyo","lookup","measurement_type","net","segment","ship","site","species","taxa_rank","taxon","tow"],[895371,11135600,235513,35644,691,218,830873,26,47,76512,60413,48,61104,1144,41,1671,75506],["2026-02-24T16:03:13Z","2026-02-24T16:03:16Z","2026-02-24T16:03:22Z","2026-02-24T16:03:22Z","2026-02-24T16:03:11Z","2026-02-24T16:03:11Z","2026-02-24T16:03:11Z","2026-02-24T16:03:12Z","2026-02-24T16:03:22Z","2026-02-24T16:03:12Z","2026-02-24T16:03:12Z","2026-02-24T16:03:13Z","2026-02-24T16:03:13Z","2026-02-24T16:03:22Z","2026-02-24T16:03:22Z","2026-02-24T16:03:22Z","2026-02-24T16:03:13Z"],["2026-02-24T16:03:13Z","2026-02-24T16:03:16Z","2026-02-24T16:03:22Z","2026-02-24T16:03:22Z","2026-02-24T16:03:11Z","2026-02-24T16:03:11Z","2026-02-24T16:03:11Z","2026-02-24T16:03:12Z","2026-02-24T16:03:22Z","2026-02-24T16:03:12Z","2026-02-24T16:03:12Z","2026-02-24T16:03:13Z","2026-02-24T16:03:13Z","2026-02-24T16:03:22Z","2026-02-24T16:03:22Z","2026-02-24T16:03:22Z","2026-02-24T16:03:13Z"],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table<\/th>\n      <th>rows<\/th>\n      <th>first_ingested<\/th>\n      <th>last_ingested<\/th>\n      <th>source_files<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[2,5]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"table","targets":1},{"name":"rows","targets":2},{"name":"first_ingested","targets":3},{"name":"last_ingested","targets":4},{"name":"source_files","targets":5}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="save-working-ducklake" class="level2" data-number="0.14">
<h2 data-number="0.14" class="anchored" data-anchor-id="save-working-ducklake"><span class="header-section-number">0.14</span> Save Working DuckLake</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">save_working_ducklake</span>(con_wdl)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "gs://calcofi-db/ducklake/working/calcofi.duckdb"</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Working DuckLake saved to GCS"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="create-frozen-release" class="level2" data-number="0.15">
<h2 data-number="0.15" class="anchored" data-anchor-id="create-frozen-release"><span class="header-section-number">0.15</span> Create Frozen Release</h2>
<p>Create a frozen (immutable) release for public access. Strips provenance columns and exports clean parquet files. See <a href="https://ducklake.select/2025/10/24/frozen-ducklake/">Frozen DuckLake</a> pattern.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>dir_frozen <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="fu">glue</span>(<span class="st">"data/releases/{release_version}"</span>))</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Creating frozen release: {release_version}"</span>))</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co"># get tables to freeze (exclude internal tables)</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>tables_to_freeze <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbListTables</span>(con_wdl) <span class="sc">|&gt;</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setdiff</span>(<span class="fu">c</span>(<span class="st">"_meta"</span>))</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co"># create frozen parquet (strips provenance)</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>freeze_stats <span class="ot">&lt;-</span> <span class="fu">write_parquet_outputs</span>(</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">con              =</span> con_wdl,</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_dir       =</span> <span class="fu">file.path</span>(dir_frozen, <span class="st">"parquet"</span>),</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">tables           =</span> tables_to_freeze,</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">strip_provenance =</span> <span class="cn">TRUE</span>,</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">compression      =</span> <span class="st">"zstd"</span>)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>freeze_stats <span class="sc">|&gt;</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="fu">glue</span>(<span class="st">"Frozen release {release_version} statistics"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-efae36a5be815c60a2ed" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-efae36a5be815c60a2ed">{"x":{"filter":"none","vertical":false,"caption":"<caption>Frozen release v2026.02 statistics<\/caption>","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17"],["bottle","bottle_measurement","cast_condition","casts","cruise","grid","ichthyo","lookup","measurement_type","net","segment","ship","site","species","taxa_rank","taxon","tow"],[895371,11135600,235513,35644,691,218,830873,26,47,76512,60413,48,61104,1144,41,1671,75506],[5974142,66072706,1088442,1426257,4656,100165,15526486,1579,3192,821762,2776846,1188,772216,25379,671,25664,474284],["/Users/bbest/Github/CalCOFI/workflows/data/releases/v2026.02/parquet/bottle.parquet","/Users/bbest/Github/CalCOFI/workflows/data/releases/v2026.02/parquet/bottle_measurement.parquet","/Users/bbest/Github/CalCOFI/workflows/data/releases/v2026.02/parquet/cast_condition.parquet","/Users/bbest/Github/CalCOFI/workflows/data/releases/v2026.02/parquet/casts.parquet","/Users/bbest/Github/CalCOFI/workflows/data/releases/v2026.02/parquet/cruise.parquet","/Users/bbest/Github/CalCOFI/workflows/data/releases/v2026.02/parquet/grid.parquet","/Users/bbest/Github/CalCOFI/workflows/data/releases/v2026.02/parquet/ichthyo.parquet","/Users/bbest/Github/CalCOFI/workflows/data/releases/v2026.02/parquet/lookup.parquet","/Users/bbest/Github/CalCOFI/workflows/data/releases/v2026.02/parquet/measurement_type.parquet","/Users/bbest/Github/CalCOFI/workflows/data/releases/v2026.02/parquet/net.parquet","/Users/bbest/Github/CalCOFI/workflows/data/releases/v2026.02/parquet/segment.parquet","/Users/bbest/Github/CalCOFI/workflows/data/releases/v2026.02/parquet/ship.parquet","/Users/bbest/Github/CalCOFI/workflows/data/releases/v2026.02/parquet/site.parquet","/Users/bbest/Github/CalCOFI/workflows/data/releases/v2026.02/parquet/species.parquet","/Users/bbest/Github/CalCOFI/workflows/data/releases/v2026.02/parquet/taxa_rank.parquet","/Users/bbest/Github/CalCOFI/workflows/data/releases/v2026.02/parquet/taxon.parquet","/Users/bbest/Github/CalCOFI/workflows/data/releases/v2026.02/parquet/tow.parquet"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>table<\/th>\n      <th>rows<\/th>\n      <th>file_size<\/th>\n      <th>path<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"table","targets":1},{"name":"rows","targets":2},{"name":"file_size","targets":3},{"name":"path","targets":4}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<section id="release-notes" class="level3" data-number="0.15.1">
<h3 data-number="0.15.1" class="anchored" data-anchor-id="release-notes"><span class="header-section-number">0.15.1</span> Release Notes</h3>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># build release notes using paste() to avoid glue() parsing issues with code blocks</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>tables_list <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- "</span>, freeze_stats<span class="sc">$</span>table, <span class="st">" ("</span>,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">format</span>(freeze_stats<span class="sc">$</span>rows, <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">" rows)"</span>)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>release_notes <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"# CalCOFI Database Release "</span>, release_version, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"**Release Date**: "</span>, <span class="fu">Sys.Date</span>(), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"## Tables Included</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(tables_list, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"## Total</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- **Tables**: "</span>, <span class="fu">nrow</span>(freeze_stats), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- **Total Rows**: "</span>, <span class="fu">format</span>(<span class="fu">sum</span>(freeze_stats<span class="sc">$</span>rows), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- **Total Size**: "</span>, <span class="fu">round</span>(<span class="fu">sum</span>(freeze_stats<span class="sc">$</span>file_size) <span class="sc">/</span> <span class="dv">1024</span> <span class="sc">/</span> <span class="dv">1024</span>, <span class="dv">1</span>), <span class="st">" MB</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"## Data Sources</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- `ingest_swfsc.noaa.gov_calcofi-db.qmd` - Ichthyo tables (cruise, ship, site, tow, net, species, ichthyo, grid, segment, lookup)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- `ingest_calcofi.org_bottle-database.qmd` - Bottle/cast tables (casts, bottle, bottle_measurement, cast_condition, measurement_type)</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"## Cross-Dataset Integration</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- **Ship matching**: Reconciled ship codes between bottle casts and swfsc ship reference</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- **Cruise bridge**: Derived cruise_key (YYMMKK) for bottle casts via ship_key + datetime</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- **Taxonomy**: Standardized species with WoRMS AphiaID, ITIS TSN, GBIF backbone key</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- **Taxon hierarchy**: Built taxon + taxa_rank tables from WoRMS/ITIS classification</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"## Access</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Parquet files can be queried directly from GCS:</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"```r</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"library(duckdb)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"con &lt;- dbConnect(duckdb())</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dbExecute(con, 'INSTALL httpfs; LOAD httpfs;')</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dbGetQuery(con, </span><span class="sc">\"\n</span><span class="st">"</span>,</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">"  SELECT * FROM read_parquet(</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"    'https://storage.googleapis.com/calcofi-db/ducklake/releases/"</span>, release_version, <span class="st">"/parquet/ichthyo.parquet')</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>  <span class="st">"  LIMIT 10</span><span class="sc">\"</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"```</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Or use calcofi4r:</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>  <span class="st">"```r</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>  <span class="st">"library(calcofi4r)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>  <span class="st">"con &lt;- cc_get_db(version = '"</span>, release_version, <span class="st">"')</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>  <span class="st">"```</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(release_notes, <span class="fu">file.path</span>(dir_frozen, <span class="st">"RELEASE_NOTES.md"</span>))</span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Release notes written to {file.path(dir_frozen, 'RELEASE_NOTES.md')}"</span>))</span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(release_notes)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</section>
</section>
<section id="calcofi-database-release-v2026.02" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> CalCOFI Database Release v2026.02</h1>
<p><strong>Release Date</strong>: 2026-02-24</p>
<section id="tables-included" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="tables-included"><span class="header-section-number">1.1</span> Tables Included</h2>
<ul>
<li>bottle ( 895,371 rows)</li>
<li>bottle_measurement (11,135,600 rows)</li>
<li>cast_condition ( 235,513 rows)</li>
<li>casts ( 35,644 rows)</li>
<li>cruise ( 691 rows)</li>
<li>grid ( 218 rows)</li>
<li>ichthyo ( 830,873 rows)</li>
<li>lookup ( 26 rows)</li>
<li>measurement_type ( 47 rows)</li>
<li>net ( 76,512 rows)</li>
<li>segment ( 60,413 rows)</li>
<li>ship ( 48 rows)</li>
<li>site ( 61,104 rows)</li>
<li>species ( 1,144 rows)</li>
<li>taxa_rank ( 41 rows)</li>
<li>taxon ( 1,671 rows)</li>
<li>tow ( 75,506 rows)</li>
</ul>
</section>
<section id="total" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="total"><span class="header-section-number">1.2</span> Total</h2>
<ul>
<li><strong>Tables</strong>: 17</li>
<li><strong>Total Rows</strong>: 13,410,422</li>
<li><strong>Total Size</strong>: 90.7 MB</li>
</ul>
</section>
<section id="data-sources" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="data-sources"><span class="header-section-number">1.3</span> Data Sources</h2>
<ul>
<li><code>ingest_swfsc.noaa.gov_calcofi-db.qmd</code> - Ichthyo tables (cruise, ship, site, tow, net, species, ichthyo, grid, segment, lookup)</li>
<li><code>ingest_calcofi.org_bottle-database.qmd</code> - Bottle/cast tables (casts, bottle, bottle_measurement, cast_condition, measurement_type)</li>
</ul>
</section>
<section id="cross-dataset-integration" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="cross-dataset-integration"><span class="header-section-number">1.4</span> Cross-Dataset Integration</h2>
<ul>
<li><strong>Ship matching</strong>: Reconciled ship codes between bottle casts and swfsc ship reference</li>
<li><strong>Cruise bridge</strong>: Derived cruise_key (YYMMKK) for bottle casts via ship_key + datetime</li>
<li><strong>Taxonomy</strong>: Standardized species with WoRMS AphiaID, ITIS TSN, GBIF backbone key</li>
<li><strong>Taxon hierarchy</strong>: Built taxon + taxa_rank tables from WoRMS/ITIS classification</li>
</ul>
</section>
<section id="access" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="access"><span class="header-section-number">1.5</span> Access</h2>
<p>Parquet files can be queried directly from GCS:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(duckdb)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="fu">duckdb</span>())</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con, <span class="st">'INSTALL httpfs; LOAD httpfs;'</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dbGetQuery</span>(con, <span class="st">"</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT * FROM read_parquet(</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="st">    'https://storage.googleapis.com/calcofi-db/ducklake/releases/v2026.02/parquet/ichthyo.parquet')</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="st">  LIMIT 10"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Or use calcofi4r:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(calcofi4r)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">cc_get_db</span>(<span class="at">version =</span> <span class="st">'v2026.02'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="upload-frozen-release-to-gcs" class="level3" data-number="1.5.1">
<h3 data-number="1.5.1" class="anchored" data-anchor-id="upload-frozen-release-to-gcs"><span class="header-section-number">1.5.1</span> Upload Frozen Release to GCS</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># upload frozen release to GCS (creates catalog.json, updates versions.json and latest.txt)</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">upload_frozen_release</span>(</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">release_dir =</span> dir_frozen,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">version     =</span> release_version,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">set_latest  =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
</section>
<section id="cleanup" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="cleanup"><span class="header-section-number">1.6</span> Cleanup</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># close working ducklake connection</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">close_duckdb</span>(con_wdl)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Working DuckLake connection closed"</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co"># close local merge database</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="fu">close_duckdb</span>(con)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Local merge database connection closed"</span>)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="co"># summary</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== Summary ==="</span>))</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Working DuckLake: saved to GCS"</span>))</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Frozen release: {release_version} created at {dir_frozen}"</span>))</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Tables: {nrow(freeze_stats)}"</span>))</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Total rows: {format(sum(freeze_stats$rows), big.mark = ',')}"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Caution</span>Session Info
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">session_info</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>─ Session info ───────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.5.2 (2025-10-31)
 os       macOS Sequoia 15.7.1
 system   aarch64, darwin20
 ui       X11
 language (EN)
 collate  en_US.UTF-8
 ctype    en_US.UTF-8
 tz       Europe/Rome
 date     2026-02-24
 pandoc   3.8.3 @ /opt/homebrew/bin/ (via rmarkdown)
 quarto   1.8.25 @ /usr/local/bin/quarto

─ Packages ───────────────────────────────────────────────────────────────────
 !  package            * version    date (UTC) lib source
    abind                1.4-8      2024-09-12 [1] CRAN (R 4.5.0)
    ape                  5.8-1      2024-12-16 [1] CRAN (R 4.5.0)
    arrow                22.0.0.1   2025-12-23 [1] CRAN (R 4.5.2)
    assertthat           0.2.1      2019-03-21 [1] CRAN (R 4.5.0)
    backports            1.5.0      2024-05-23 [1] CRAN (R 4.5.0)
    base64enc            0.1-6      2026-02-02 [1] CRAN (R 4.5.2)
    bit                  4.6.0      2025-03-06 [1] CRAN (R 4.5.0)
    bit64                4.6.0-1    2025-01-16 [1] CRAN (R 4.5.0)
    blob                 1.3.0      2026-01-14 [1] CRAN (R 4.5.2)
    broom                1.0.10     2025-09-13 [1] CRAN (R 4.5.0)
    bslib                0.10.0     2026-01-26 [1] CRAN (R 4.5.2)
    cachem               1.1.0      2024-05-16 [1] CRAN (R 4.5.0)
 VP calcofi4db         * 2.4.0      2026-02-04 [?] load_all() (on disk 2.1.0)
 P  calcofi4r          * 1.1.3      2026-02-09 [?] Github (calcofi/calcofi4r@304d271)
    chromote             0.5.1      2025-04-24 [1] CRAN (R 4.5.0)
    class                7.3-23     2025-01-01 [1] CRAN (R 4.5.2)
    classInt             0.4-11     2025-01-08 [1] CRAN (R 4.5.0)
    cli                  3.6.5      2025-04-23 [1] CRAN (R 4.5.0)
    codetools            0.2-20     2024-03-31 [1] CRAN (R 4.5.2)
    crayon               1.5.3      2024-06-20 [1] CRAN (R 4.5.0)
    crosstalk            1.2.2      2025-08-26 [1] CRAN (R 4.5.0)
    crul                 1.6.0      2025-07-23 [1] CRAN (R 4.5.0)
    curl                 7.0.0      2025-08-19 [1] CRAN (R 4.5.0)
    data.table           1.18.2.1   2026-01-27 [1] CRAN (R 4.5.2)
    DBI                * 1.2.3      2024-06-02 [1] CRAN (R 4.5.0)
    dbplyr               2.5.1      2025-09-10 [1] CRAN (R 4.5.0)
    desc                 1.4.3      2023-12-10 [1] CRAN (R 4.5.0)
    devtools             2.4.6      2025-10-03 [1] CRAN (R 4.5.0)
    DiagrammeR           1.0.11     2024-02-02 [1] CRAN (R 4.5.0)
    DiagrammeRsvg        0.1        2016-02-04 [1] CRAN (R 4.5.0)
    digest               0.6.39     2025-11-19 [1] CRAN (R 4.5.2)
    dm                 * 1.0.12     2025-07-02 [1] CRAN (R 4.5.0)
    dplyr              * 1.2.0      2026-02-03 [1] CRAN (R 4.5.2)
    DT                 * 0.34.0     2025-09-02 [1] CRAN (R 4.5.0)
    duckdb               1.4.4      2026-01-28 [1] CRAN (R 4.5.2)
    dygraphs             1.1.1.6    2018-07-11 [1] CRAN (R 4.5.0)
    e1071                1.7-17     2025-12-18 [1] CRAN (R 4.5.2)
    ellipsis             0.3.2      2021-04-29 [1] CRAN (R 4.5.0)
    evaluate             1.0.5      2025-08-27 [1] CRAN (R 4.5.0)
    farver               2.1.2      2024-05-13 [1] CRAN (R 4.5.0)
    fastmap              1.2.0      2024-05-15 [1] CRAN (R 4.5.0)
    fs                 * 1.6.6      2025-04-12 [1] CRAN (R 4.5.0)
    fuzzyjoin            0.1.6.1    2025-07-10 [1] CRAN (R 4.5.0)
    gargle               1.6.1      2026-01-29 [1] CRAN (R 4.5.2)
    generics             0.1.4      2025-05-09 [1] CRAN (R 4.5.0)
    geojsonsf            2.0.5      2025-11-26 [1] CRAN (R 4.5.2)
    ggplot2              4.0.2      2026-02-03 [1] CRAN (R 4.5.2)
    glue               * 1.8.0      2024-09-30 [1] CRAN (R 4.5.0)
    googledrive          2.1.2      2025-09-10 [1] CRAN (R 4.5.0)
    gtable               0.3.6      2024-10-25 [1] CRAN (R 4.5.0)
    here               * 1.0.2      2025-09-15 [1] CRAN (R 4.5.0)
    highcharter          0.9.4      2022-01-03 [1] CRAN (R 4.5.0)
    hms                  1.1.4      2025-10-17 [1] CRAN (R 4.5.0)
    htmltools            0.5.9      2025-12-04 [1] CRAN (R 4.5.2)
    htmlwidgets          1.6.4      2023-12-06 [1] CRAN (R 4.5.0)
    httpcode             0.3.0      2020-04-10 [1] CRAN (R 4.5.0)
    httpuv               1.6.16     2025-04-16 [1] CRAN (R 4.5.0)
    httr                 1.4.7      2023-08-15 [1] CRAN (R 4.5.0)
    httr2                1.2.2      2025-12-08 [1] CRAN (R 4.5.2)
    igraph               2.2.1      2025-10-27 [1] CRAN (R 4.5.0)
    isoband              0.3.0      2025-12-07 [1] CRAN (R 4.5.2)
    janitor              2.2.1      2024-12-22 [1] CRAN (R 4.5.0)
    jquerylib            0.1.4      2021-04-26 [1] CRAN (R 4.5.0)
    jsonlite           * 2.0.0      2025-03-27 [1] CRAN (R 4.5.0)
    KernSmooth           2.23-26    2025-01-01 [1] CRAN (R 4.5.2)
    knitr                1.51       2025-12-20 [1] CRAN (R 4.5.2)
    later                1.4.5      2026-01-08 [1] CRAN (R 4.5.2)
    lattice              0.22-7     2025-04-02 [1] CRAN (R 4.5.2)
    lazyeval             0.2.2      2019-03-15 [1] CRAN (R 4.5.0)
    leafem               0.2.5      2025-08-28 [1] CRAN (R 4.5.0)
    leaflet              2.2.3      2025-09-04 [1] CRAN (R 4.5.0)
    librarian            1.8.1      2021-07-12 [1] CRAN (R 4.5.0)
    lifecycle            1.0.5      2026-01-08 [1] CRAN (R 4.5.2)
    lubridate            1.9.5      2026-02-04 [1] CRAN (R 4.5.2)
    magrittr             2.0.4      2025-09-12 [1] CRAN (R 4.5.0)
    mapgl                0.4.4      2026-01-12 [1] CRAN (R 4.5.2)
    mapview              2.11.4     2025-09-08 [1] CRAN (R 4.5.0)
    markdown             2.0        2025-03-23 [1] CRAN (R 4.5.0)
    Matrix               1.7-4      2025-08-28 [1] CRAN (R 4.5.2)
    memoise              2.0.1      2021-11-26 [1] CRAN (R 4.5.0)
    mgcv                 1.9-3      2025-04-04 [1] CRAN (R 4.5.2)
    mime                 0.13       2025-03-17 [1] CRAN (R 4.5.0)
    nlme                 3.1-168    2025-03-31 [1] CRAN (R 4.5.2)
    otel                 0.2.0      2025-08-29 [1] CRAN (R 4.5.0)
    pillar               1.11.1     2025-09-17 [1] CRAN (R 4.5.0)
    pkgbuild             1.4.8      2025-05-26 [1] CRAN (R 4.5.0)
    pkgconfig            2.0.3      2019-09-22 [1] CRAN (R 4.5.0)
    pkgload              1.4.1      2025-09-23 [1] CRAN (R 4.5.0)
    plotly               4.12.0     2026-01-24 [1] CRAN (R 4.5.2)
    png                  0.1-8      2022-11-29 [1] CRAN (R 4.5.0)
    processx             3.8.6      2025-02-21 [1] CRAN (R 4.5.0)
    promises             1.5.0      2025-11-01 [1] CRAN (R 4.5.0)
    proxy                0.4-29     2025-12-29 [1] CRAN (R 4.5.2)
    ps                   1.9.1      2025-04-12 [1] CRAN (R 4.5.0)
    purrr              * 1.2.1      2026-01-09 [1] CRAN (R 4.5.2)
    quantmod             0.4.28     2025-06-19 [1] CRAN (R 4.5.0)
    R6                   2.6.1      2025-02-15 [1] CRAN (R 4.5.0)
    rappdirs             0.3.4      2026-01-17 [1] CRAN (R 4.5.2)
    raster               3.6-32     2025-03-28 [1] CRAN (R 4.5.0)
    RColorBrewer         1.1-3      2022-04-03 [1] CRAN (R 4.5.0)
    Rcpp                 1.1.1      2026-01-10 [1] CRAN (R 4.5.2)
    readr              * 2.1.6      2025-11-14 [1] CRAN (R 4.5.2)
    remotes              2.5.0      2024-03-17 [1] CRAN (R 4.5.0)
    rlang                1.1.7      2026-01-09 [1] CRAN (R 4.5.2)
    rlist                0.4.6.2    2021-09-03 [1] CRAN (R 4.5.0)
    rmarkdown            2.30       2025-09-28 [1] CRAN (R 4.5.0)
    rnaturalearth        1.2.0      2026-01-19 [1] CRAN (R 4.5.2)
    rnaturalearthhires   1.0.0.9000 2025-10-02 [1] Github (ropensci/rnaturalearthhires@e4736f6)
    RPostgres            1.4.8      2025-02-25 [1] CRAN (R 4.5.0)
    rprojroot            2.1.1      2025-08-26 [1] CRAN (R 4.5.0)
    rstudioapi           0.18.0     2026-01-16 [1] CRAN (R 4.5.2)
    rvest                1.0.5      2025-08-29 [1] CRAN (R 4.5.0)
    S7                   0.2.1      2025-11-14 [1] CRAN (R 4.5.2)
    sass                 0.4.10     2025-04-11 [1] CRAN (R 4.5.0)
    satellite            1.0.6      2025-08-21 [1] CRAN (R 4.5.0)
    scales               1.4.0      2025-04-24 [1] CRAN (R 4.5.0)
    selectr              0.4-2      2019-11-20 [1] CRAN (R 4.5.0)
    sessioninfo          1.2.3      2025-02-05 [1] CRAN (R 4.5.0)
    sf                   1.0-24     2026-01-13 [1] CRAN (R 4.5.2)
    shiny                1.11.1     2025-07-03 [1] CRAN (R 4.5.0)
    shinyWidgets         0.9.0      2025-02-21 [1] CRAN (R 4.5.0)
    snakecase            0.11.1     2023-08-27 [1] CRAN (R 4.5.0)
    sp                   2.2-0      2025-02-01 [1] CRAN (R 4.5.0)
    stars                0.7-0      2025-12-14 [1] CRAN (R 4.5.2)
    stringi              1.8.7      2025-03-27 [1] CRAN (R 4.5.0)
    stringr            * 1.6.0      2025-11-04 [1] CRAN (R 4.5.0)
    taxize             * 0.10.0     2025-02-07 [1] CRAN (R 4.5.0)
    terra                1.8-93     2026-01-12 [1] CRAN (R 4.5.2)
    tibble             * 3.3.1      2026-01-11 [1] CRAN (R 4.5.2)
    tidyr              * 1.3.2      2025-12-19 [1] CRAN (R 4.5.2)
    tidyselect           1.2.1      2024-03-11 [1] CRAN (R 4.5.0)
    timechange           0.4.0      2026-01-29 [1] CRAN (R 4.5.2)
    TTR                  0.24.4     2023-11-28 [1] CRAN (R 4.5.0)
    tzdb                 0.5.0      2025-03-15 [1] CRAN (R 4.5.0)
    units                1.0-0      2025-10-09 [1] CRAN (R 4.5.0)
    usethis              3.2.1      2025-09-06 [1] CRAN (R 4.5.0)
    uuid                 1.2-2      2026-01-23 [1] CRAN (R 4.5.2)
    V8                   8.0.1      2025-10-10 [1] CRAN (R 4.5.0)
    vctrs                0.7.1      2026-01-23 [1] CRAN (R 4.5.2)
    viridisLite          0.4.3      2026-02-04 [1] CRAN (R 4.5.2)
    visNetwork           2.1.4      2025-09-04 [1] CRAN (R 4.5.0)
    vroom                1.7.0      2026-01-27 [1] CRAN (R 4.5.2)
    websocket            1.4.4      2025-04-10 [1] CRAN (R 4.5.0)
    withr                3.0.2      2024-10-28 [1] CRAN (R 4.5.0)
    worrms             * 0.4.3      2023-06-20 [1] CRAN (R 4.5.0)
    xfun                 0.56       2026-01-18 [1] CRAN (R 4.5.2)
    xml2                 1.5.2      2026-01-17 [1] CRAN (R 4.5.2)
    xtable               1.8-4      2019-04-21 [1] CRAN (R 4.5.0)
    xts                  0.14.1     2024-10-15 [1] CRAN (R 4.5.0)
    yaml                 2.3.12     2025-12-10 [1] CRAN (R 4.5.2)
    zoo                  1.8-15     2025-12-15 [1] CRAN (R 4.5.2)

 [1] /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/library

 * ── Packages attached to the search path.
 V ── Loaded and on-disk version mismatch.
 P ── Loaded and on-disk path mismatch.

──────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
</div>
</div>
</div>
</div>
<!-- -->

</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Merge Ichthyo &amp; Bottle to Working DuckLake"</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="co">  markdown:</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="co">    wrap: 72</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview {.unnumbered}</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>**Goal**: Merge parquet outputs from both upstream ingest workflows,</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>perform cross-dataset reconciliation (ship matching, cruise bridge,</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>taxonomy standardization), then load into Working DuckLake and create a</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>frozen release.</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>**Steps**:</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Load parquet files from both upstream workflows into local temp</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    DuckDB</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Fuzzy match ships between datasets</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Build cruise bridge (casts → cruise_key)</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>Standardize taxonomy (species → WoRMS/ITIS/GBIF)</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a><span class="ss">5.  </span>Validate cross-dataset integrity</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a><span class="ss">6.  </span>Write modified parquet outputs + manifest with GCS references</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a><span class="ss">7.  </span>Ingest all tables into Working DuckLake with provenance</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a><span class="ss">8.  </span>Freeze release (strip provenance)</span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a><span class="ss">9.  </span>Upload to GCS</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>**Upstream workflows** (must complete first):</span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`ingest_swfsc.noaa.gov_calcofi-db.qmd`</span> → ichthyo tables (10)</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`ingest_calcofi.org_bottle-database.qmd`</span> → bottle/cast tables (5)</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>%%| label: fig-workflow</span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>%%| fig-cap: <span class="ot">"</span><span class="st">Integration workflow: upstream parquet → merge → Working DuckLake → Frozen Release</span><span class="ot">"</span></span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>flowchart LR</span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>    subgraph upstream[<span class="ot">"</span><span class="st">Upstream Parquet</span><span class="ot">"</span>]</span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>        <span class="ot">s["swfsc&lt;br/&gt;10 tables"]</span></span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a><span class="st">        b</span><span class="ot">[</span><span class="st">"bottle&lt;br/&gt;5 tables"</span><span class="ot">]</span></span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>    subgraph merge[<span class="ot">"</span><span class="st">Merge DuckDB</span><span class="ot">"</span>]</span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>        m1[<span class="ot">"</span><span class="st">Ship matching</span><span class="ot">"</span>]</span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>        m2[<span class="ot">"</span><span class="st">Cruise bridge</span><span class="ot">"</span>]</span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>        m3[<span class="ot">"</span><span class="st">Taxonomy</span><span class="ot">"</span>]</span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>    subgraph output[<span class="ot">"</span><span class="st">Output</span><span class="ot">"</span>]</span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a>        p[<span class="ot">"</span><span class="st">Modified parquet&lt;br/&gt;+ manifest</span><span class="ot">"</span>]</span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>        w[<span class="ot">"</span><span class="st">Working DuckLake</span><span class="ot">"</span>]</span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a>        f[<span class="ot">"</span><span class="st">Frozen Release</span><span class="ot">"</span>]</span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a>    <span class="ot">s</span> <span class="ot">--</span><span class="st">&gt; merge</span></span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a><span class="st">    b </span><span class="ot">-</span>-&gt; merge</span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>    merge --&gt; p --&gt; w --&gt; f</span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a>    style upstream fill:<span class="co">#e3f2fd,stroke:#1565c0</span></span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a>    style merge fill:<span class="co">#fff3e0,stroke:#ef6c00</span></span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a>    style output fill:<span class="co">#e8f4e8,stroke:#2e7d32</span></span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-71"><a href="#cb43-71" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup</span></span>
<span id="cb43-72"><a href="#cb43-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-75"><a href="#cb43-75" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-76"><a href="#cb43-76" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb43-77"><a href="#cb43-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-78"><a href="#cb43-78" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">load_all</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"../calcofi4db"</span>))</span>
<span id="cb43-79"><a href="#cb43-79" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">load_all</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"../calcofi4R"</span>))</span>
<span id="cb43-80"><a href="#cb43-80" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb43-81"><a href="#cb43-81" aria-hidden="true" tabindex="-1"></a>  CalCOFI<span class="sc">/</span>calcofi4db, DBI, dm, dplyr, DT, fs, glue, here,</span>
<span id="cb43-82"><a href="#cb43-82" aria-hidden="true" tabindex="-1"></a>  jsonlite, purrr, readr, stringr, tibble, tidyr,</span>
<span id="cb43-83"><a href="#cb43-83" aria-hidden="true" tabindex="-1"></a>  worrms, taxize,</span>
<span id="cb43-84"><a href="#cb43-84" aria-hidden="true" tabindex="-1"></a>  <span class="at">quiet =</span> T)</span>
<span id="cb43-85"><a href="#cb43-85" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">readr.show_col_types =</span> F)</span>
<span id="cb43-86"><a href="#cb43-86" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">DT.options =</span> <span class="fu">list</span>(<span class="at">scrollX =</span> <span class="cn">TRUE</span>))</span>
<span id="cb43-87"><a href="#cb43-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-88"><a href="#cb43-88" aria-hidden="true" tabindex="-1"></a><span class="co"># parquet input directories (from upstream workflows)</span></span>
<span id="cb43-89"><a href="#cb43-89" aria-hidden="true" tabindex="-1"></a>dir_pq_ichthyo <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/parquet/swfsc.noaa.gov_calcofi-db"</span>)</span>
<span id="cb43-90"><a href="#cb43-90" aria-hidden="true" tabindex="-1"></a>dir_pq_bottle  <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/parquet/calcofi.org_bottle-database"</span>)</span>
<span id="cb43-91"><a href="#cb43-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-92"><a href="#cb43-92" aria-hidden="true" tabindex="-1"></a><span class="co"># release version</span></span>
<span id="cb43-93"><a href="#cb43-93" aria-hidden="true" tabindex="-1"></a>release_version <span class="ot">&lt;-</span> <span class="fu">format</span>(<span class="fu">Sys.Date</span>(), <span class="st">"v%Y.%m"</span>)</span>
<span id="cb43-94"><a href="#cb43-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-95"><a href="#cb43-95" aria-hidden="true" tabindex="-1"></a><span class="co"># local merge database</span></span>
<span id="cb43-96"><a href="#cb43-96" aria-hidden="true" tabindex="-1"></a>db_path   <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/wrangling/merge_ichthyo_bottle.duckdb"</span>)</span>
<span id="cb43-97"><a href="#cb43-97" aria-hidden="true" tabindex="-1"></a>overwrite <span class="ot">&lt;-</span> <span class="cn">FALSE</span>  <span class="co"># set TRUE to rebuild from scratch (takes ~1hr for taxonomy APIs)</span></span>
<span id="cb43-98"><a href="#cb43-98" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (overwrite <span class="sc">&amp;&amp;</span> <span class="fu">file_exists</span>(db_path)) <span class="fu">file_delete</span>(db_path)</span>
<span id="cb43-99"><a href="#cb43-99" aria-hidden="true" tabindex="-1"></a><span class="fu">dir_create</span>(<span class="fu">dirname</span>(db_path))</span>
<span id="cb43-100"><a href="#cb43-100" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">get_duckdb_con</span>(db_path)</span>
<span id="cb43-101"><a href="#cb43-101" aria-hidden="true" tabindex="-1"></a><span class="fu">load_duckdb_extension</span>(con, <span class="st">"spatial"</span>)</span>
<span id="cb43-102"><a href="#cb43-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-103"><a href="#cb43-103" aria-hidden="true" tabindex="-1"></a><span class="co"># check if database already has tables (from previous run)</span></span>
<span id="cb43-104"><a href="#cb43-104" aria-hidden="true" tabindex="-1"></a>existing_tables <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbListTables</span>(con)</span>
<span id="cb43-105"><a href="#cb43-105" aria-hidden="true" tabindex="-1"></a>skip_load <span class="ot">&lt;-</span> <span class="fu">length</span>(existing_tables) <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb43-106"><a href="#cb43-106" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (skip_load) {</span>
<span id="cb43-107"><a href="#cb43-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Using existing database with {length(existing_tables)} tables"</span>))</span>
<span id="cb43-108"><a href="#cb43-108" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-109"><a href="#cb43-109" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-110"><a href="#cb43-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-111"><a href="#cb43-111" aria-hidden="true" tabindex="-1"></a><span class="fu">## Check Upstream Workflows</span></span>
<span id="cb43-112"><a href="#cb43-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-113"><a href="#cb43-113" aria-hidden="true" tabindex="-1"></a>Verify that parquet outputs and manifests exist from both upstream</span>
<span id="cb43-114"><a href="#cb43-114" aria-hidden="true" tabindex="-1"></a>workflows.</span>
<span id="cb43-115"><a href="#cb43-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-118"><a href="#cb43-118" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-119"><a href="#cb43-119" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check_upstream</span></span>
<span id="cb43-120"><a href="#cb43-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-121"><a href="#cb43-121" aria-hidden="true" tabindex="-1"></a><span class="co"># check ichthyo manifest</span></span>
<span id="cb43-122"><a href="#cb43-122" aria-hidden="true" tabindex="-1"></a>ichthyo_manifest_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_pq_ichthyo, <span class="st">"manifest.json"</span>)</span>
<span id="cb43-123"><a href="#cb43-123" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(</span>
<span id="cb43-124"><a href="#cb43-124" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Missing ichthyo parquet outputs. Run ingest_swfsc.noaa.gov_calcofi-db.qmd first."</span> <span class="ot">=</span></span>
<span id="cb43-125"><a href="#cb43-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.exists</span>(ichthyo_manifest_path))</span>
<span id="cb43-126"><a href="#cb43-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-127"><a href="#cb43-127" aria-hidden="true" tabindex="-1"></a>ichthyo_manifest <span class="ot">&lt;-</span> <span class="fu">read_json</span>(ichthyo_manifest_path)</span>
<span id="cb43-128"><a href="#cb43-128" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(</span>
<span id="cb43-129"><a href="#cb43-129" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Ichthyo parquet: {ichthyo_manifest$total_rows} total rows, "</span>,</span>
<span id="cb43-130"><a href="#cb43-130" aria-hidden="true" tabindex="-1"></a>  <span class="st">"created {ichthyo_manifest$created_at}"</span>))</span>
<span id="cb43-131"><a href="#cb43-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-132"><a href="#cb43-132" aria-hidden="true" tabindex="-1"></a><span class="co"># check bottle manifest</span></span>
<span id="cb43-133"><a href="#cb43-133" aria-hidden="true" tabindex="-1"></a>bottle_manifest_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_pq_bottle, <span class="st">"manifest.json"</span>)</span>
<span id="cb43-134"><a href="#cb43-134" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(</span>
<span id="cb43-135"><a href="#cb43-135" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Missing bottle parquet outputs. Run ingest_calcofi.org_bottle-database.qmd first."</span> <span class="ot">=</span></span>
<span id="cb43-136"><a href="#cb43-136" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.exists</span>(bottle_manifest_path))</span>
<span id="cb43-137"><a href="#cb43-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-138"><a href="#cb43-138" aria-hidden="true" tabindex="-1"></a>bottle_manifest <span class="ot">&lt;-</span> <span class="fu">read_json</span>(bottle_manifest_path)</span>
<span id="cb43-139"><a href="#cb43-139" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(</span>
<span id="cb43-140"><a href="#cb43-140" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Bottle parquet: {bottle_manifest$total_rows} total rows, "</span>,</span>
<span id="cb43-141"><a href="#cb43-141" aria-hidden="true" tabindex="-1"></a>  <span class="st">"created {bottle_manifest$created_at}"</span>))</span>
<span id="cb43-142"><a href="#cb43-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-143"><a href="#cb43-143" aria-hidden="true" tabindex="-1"></a><span class="co"># show manifest stats</span></span>
<span id="cb43-144"><a href="#cb43-144" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb43-145"><a href="#cb43-145" aria-hidden="true" tabindex="-1"></a>  <span class="at">source   =</span> <span class="fu">c</span>(<span class="st">"ichthyo"</span>, <span class="st">"bottle"</span>),</span>
<span id="cb43-146"><a href="#cb43-146" aria-hidden="true" tabindex="-1"></a>  <span class="at">tables   =</span> <span class="fu">c</span>(</span>
<span id="cb43-147"><a href="#cb43-147" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(ichthyo_manifest<span class="sc">$</span>tables),</span>
<span id="cb43-148"><a href="#cb43-148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(bottle_manifest<span class="sc">$</span>tables)),</span>
<span id="cb43-149"><a href="#cb43-149" aria-hidden="true" tabindex="-1"></a>  <span class="at">rows     =</span> <span class="fu">c</span>(</span>
<span id="cb43-150"><a href="#cb43-150" aria-hidden="true" tabindex="-1"></a>    ichthyo_manifest<span class="sc">$</span>total_rows,</span>
<span id="cb43-151"><a href="#cb43-151" aria-hidden="true" tabindex="-1"></a>    bottle_manifest<span class="sc">$</span>total_rows),</span>
<span id="cb43-152"><a href="#cb43-152" aria-hidden="true" tabindex="-1"></a>  <span class="at">created  =</span> <span class="fu">c</span>(</span>
<span id="cb43-153"><a href="#cb43-153" aria-hidden="true" tabindex="-1"></a>    ichthyo_manifest<span class="sc">$</span>created_at,</span>
<span id="cb43-154"><a href="#cb43-154" aria-hidden="true" tabindex="-1"></a>    bottle_manifest<span class="sc">$</span>created_at)) <span class="sc">|&gt;</span></span>
<span id="cb43-155"><a href="#cb43-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Upstream workflow manifest stats"</span>)</span>
<span id="cb43-156"><a href="#cb43-156" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-157"><a href="#cb43-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-158"><a href="#cb43-158" aria-hidden="true" tabindex="-1"></a><span class="fu">## Load SWFSC Tables</span></span>
<span id="cb43-159"><a href="#cb43-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-160"><a href="#cb43-160" aria-hidden="true" tabindex="-1"></a>Load all ichthyo parquet files into the local merge DuckDB. Tables with</span>
<span id="cb43-161"><a href="#cb43-161" aria-hidden="true" tabindex="-1"></a>geometry columns (grid, site, segment) need WKB→GEOMETRY conversion.</span>
<span id="cb43-162"><a href="#cb43-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-165"><a href="#cb43-165" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-166"><a href="#cb43-166" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load_ichthyo</span></span>
<span id="cb43-167"><a href="#cb43-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-168"><a href="#cb43-168" aria-hidden="true" tabindex="-1"></a>ichthyo_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(</span>
<span id="cb43-169"><a href="#cb43-169" aria-hidden="true" tabindex="-1"></a>  dir_pq_ichthyo, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.parquet$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-170"><a href="#cb43-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-171"><a href="#cb43-171" aria-hidden="true" tabindex="-1"></a><span class="co"># tables with geometry columns that need WKB conversion</span></span>
<span id="cb43-172"><a href="#cb43-172" aria-hidden="true" tabindex="-1"></a>geom_tables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"grid"</span>, <span class="st">"site"</span>, <span class="st">"segment"</span>)</span>
<span id="cb43-173"><a href="#cb43-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-174"><a href="#cb43-174" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (skip_load) {</span>
<span id="cb43-175"><a href="#cb43-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Using existing ichthyo tables from database"</span>)</span>
<span id="cb43-176"><a href="#cb43-176" aria-hidden="true" tabindex="-1"></a>  ichthyo_stats <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(ichthyo_files, <span class="cf">function</span>(pqt_path) {</span>
<span id="cb43-177"><a href="#cb43-177" aria-hidden="true" tabindex="-1"></a>    tbl_name <span class="ot">&lt;-</span> tools<span class="sc">::</span><span class="fu">file_path_sans_ext</span>(<span class="fu">basename</span>(pqt_path))</span>
<span id="cb43-178"><a href="#cb43-178" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con, <span class="fu">glue</span>(<span class="st">"SELECT COUNT(*) AS n FROM {tbl_name}"</span>))<span class="sc">$</span>n</span>
<span id="cb43-179"><a href="#cb43-179" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">table =</span> tbl_name, <span class="at">rows =</span> n, <span class="at">source =</span> <span class="st">"ichthyo"</span>)</span>
<span id="cb43-180"><a href="#cb43-180" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb43-181"><a href="#cb43-181" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb43-182"><a href="#cb43-182" aria-hidden="true" tabindex="-1"></a>  ichthyo_stats <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(ichthyo_files, <span class="cf">function</span>(pqt_path) {</span>
<span id="cb43-183"><a href="#cb43-183" aria-hidden="true" tabindex="-1"></a>    tbl_name <span class="ot">&lt;-</span> tools<span class="sc">::</span><span class="fu">file_path_sans_ext</span>(<span class="fu">basename</span>(pqt_path))</span>
<span id="cb43-184"><a href="#cb43-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-185"><a href="#cb43-185" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (tbl_name <span class="sc">%in%</span> geom_tables) {</span>
<span id="cb43-186"><a href="#cb43-186" aria-hidden="true" tabindex="-1"></a>      <span class="co"># use load_gcs_parquet_to_duckdb for WKB→GEOMETRY conversion</span></span>
<span id="cb43-187"><a href="#cb43-187" aria-hidden="true" tabindex="-1"></a>      DBI<span class="sc">::</span><span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(</span>
<span id="cb43-188"><a href="#cb43-188" aria-hidden="true" tabindex="-1"></a>        <span class="st">"CREATE OR REPLACE TABLE {tbl_name} AS</span></span>
<span id="cb43-189"><a href="#cb43-189" aria-hidden="true" tabindex="-1"></a><span class="st">         SELECT * FROM read_parquet('{pqt_path}')"</span>))</span>
<span id="cb43-190"><a href="#cb43-190" aria-hidden="true" tabindex="-1"></a>      <span class="co"># detect and convert WKB BLOB columns</span></span>
<span id="cb43-191"><a href="#cb43-191" aria-hidden="true" tabindex="-1"></a>      blob_cols <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con, <span class="fu">glue</span>(</span>
<span id="cb43-192"><a href="#cb43-192" aria-hidden="true" tabindex="-1"></a>        <span class="st">"SELECT column_name FROM information_schema.columns</span></span>
<span id="cb43-193"><a href="#cb43-193" aria-hidden="true" tabindex="-1"></a><span class="st">         WHERE table_name = '{tbl_name}'</span></span>
<span id="cb43-194"><a href="#cb43-194" aria-hidden="true" tabindex="-1"></a><span class="st">           AND data_type = 'BLOB'</span></span>
<span id="cb43-195"><a href="#cb43-195" aria-hidden="true" tabindex="-1"></a><span class="st">           AND column_name LIKE '%geom%'"</span>))<span class="sc">$</span>column_name</span>
<span id="cb43-196"><a href="#cb43-196" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (gc <span class="cf">in</span> blob_cols) {</span>
<span id="cb43-197"><a href="#cb43-197" aria-hidden="true" tabindex="-1"></a>        tmp_col <span class="ot">&lt;-</span> <span class="fu">paste0</span>(gc, <span class="st">"_tmp"</span>)</span>
<span id="cb43-198"><a href="#cb43-198" aria-hidden="true" tabindex="-1"></a>        DBI<span class="sc">::</span><span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(</span>
<span id="cb43-199"><a href="#cb43-199" aria-hidden="true" tabindex="-1"></a>          <span class="st">'ALTER TABLE {tbl_name} ADD COLUMN {tmp_col} GEOMETRY'</span>))</span>
<span id="cb43-200"><a href="#cb43-200" aria-hidden="true" tabindex="-1"></a>        DBI<span class="sc">::</span><span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(</span>
<span id="cb43-201"><a href="#cb43-201" aria-hidden="true" tabindex="-1"></a>          <span class="st">'UPDATE {tbl_name} SET {tmp_col} = ST_GeomFromWKB({gc})'</span>))</span>
<span id="cb43-202"><a href="#cb43-202" aria-hidden="true" tabindex="-1"></a>        DBI<span class="sc">::</span><span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(</span>
<span id="cb43-203"><a href="#cb43-203" aria-hidden="true" tabindex="-1"></a>          <span class="st">'ALTER TABLE {tbl_name} DROP COLUMN {gc}'</span>))</span>
<span id="cb43-204"><a href="#cb43-204" aria-hidden="true" tabindex="-1"></a>        DBI<span class="sc">::</span><span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(</span>
<span id="cb43-205"><a href="#cb43-205" aria-hidden="true" tabindex="-1"></a>          <span class="st">'ALTER TABLE {tbl_name} RENAME COLUMN {tmp_col} TO {gc}'</span>))</span>
<span id="cb43-206"><a href="#cb43-206" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb43-207"><a href="#cb43-207" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb43-208"><a href="#cb43-208" aria-hidden="true" tabindex="-1"></a>      DBI<span class="sc">::</span><span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(</span>
<span id="cb43-209"><a href="#cb43-209" aria-hidden="true" tabindex="-1"></a>        <span class="st">"CREATE OR REPLACE TABLE {tbl_name} AS</span></span>
<span id="cb43-210"><a href="#cb43-210" aria-hidden="true" tabindex="-1"></a><span class="st">         SELECT * FROM read_parquet('{pqt_path}')"</span>))</span>
<span id="cb43-211"><a href="#cb43-211" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb43-212"><a href="#cb43-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-213"><a href="#cb43-213" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con, <span class="fu">glue</span>(<span class="st">"SELECT COUNT(*) AS n FROM {tbl_name}"</span>))<span class="sc">$</span>n</span>
<span id="cb43-214"><a href="#cb43-214" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">table =</span> tbl_name, <span class="at">rows =</span> n, <span class="at">source =</span> <span class="st">"ichthyo"</span>)</span>
<span id="cb43-215"><a href="#cb43-215" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb43-216"><a href="#cb43-216" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-217"><a href="#cb43-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-218"><a href="#cb43-218" aria-hidden="true" tabindex="-1"></a>ichthyo_stats <span class="sc">|&gt;</span> <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"SWFSC ichthyo tables loaded"</span>)</span>
<span id="cb43-219"><a href="#cb43-219" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-220"><a href="#cb43-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-221"><a href="#cb43-221" aria-hidden="true" tabindex="-1"></a><span class="fu">## Load Bottle Tables</span></span>
<span id="cb43-222"><a href="#cb43-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-223"><a href="#cb43-223" aria-hidden="true" tabindex="-1"></a>Load bottle parquet files (grid excluded from bottle export — canonical</span>
<span id="cb43-224"><a href="#cb43-224" aria-hidden="true" tabindex="-1"></a>from swfsc).</span>
<span id="cb43-225"><a href="#cb43-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-228"><a href="#cb43-228" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-229"><a href="#cb43-229" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load_bottle</span></span>
<span id="cb43-230"><a href="#cb43-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-231"><a href="#cb43-231" aria-hidden="true" tabindex="-1"></a>bottle_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(</span>
<span id="cb43-232"><a href="#cb43-232" aria-hidden="true" tabindex="-1"></a>  dir_pq_bottle, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.parquet$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-233"><a href="#cb43-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-234"><a href="#cb43-234" aria-hidden="true" tabindex="-1"></a><span class="co"># belt-and-suspenders: skip grid.parquet if it still exists</span></span>
<span id="cb43-235"><a href="#cb43-235" aria-hidden="true" tabindex="-1"></a>bottle_files <span class="ot">&lt;-</span> bottle_files[<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"grid</span><span class="sc">\\</span><span class="st">.parquet$"</span>, bottle_files)]</span>
<span id="cb43-236"><a href="#cb43-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-237"><a href="#cb43-237" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (skip_load) {</span>
<span id="cb43-238"><a href="#cb43-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Using existing bottle tables from database"</span>)</span>
<span id="cb43-239"><a href="#cb43-239" aria-hidden="true" tabindex="-1"></a>  bottle_stats <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(bottle_files, <span class="cf">function</span>(pqt_path) {</span>
<span id="cb43-240"><a href="#cb43-240" aria-hidden="true" tabindex="-1"></a>    tbl_name <span class="ot">&lt;-</span> tools<span class="sc">::</span><span class="fu">file_path_sans_ext</span>(<span class="fu">basename</span>(pqt_path))</span>
<span id="cb43-241"><a href="#cb43-241" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con, <span class="fu">glue</span>(<span class="st">"SELECT COUNT(*) AS n FROM {tbl_name}"</span>))<span class="sc">$</span>n</span>
<span id="cb43-242"><a href="#cb43-242" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">table =</span> tbl_name, <span class="at">rows =</span> n, <span class="at">source =</span> <span class="st">"bottle"</span>)</span>
<span id="cb43-243"><a href="#cb43-243" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb43-244"><a href="#cb43-244" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb43-245"><a href="#cb43-245" aria-hidden="true" tabindex="-1"></a>  bottle_stats <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(bottle_files, <span class="cf">function</span>(pqt_path) {</span>
<span id="cb43-246"><a href="#cb43-246" aria-hidden="true" tabindex="-1"></a>    tbl_name <span class="ot">&lt;-</span> tools<span class="sc">::</span><span class="fu">file_path_sans_ext</span>(<span class="fu">basename</span>(pqt_path))</span>
<span id="cb43-247"><a href="#cb43-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-248"><a href="#cb43-248" aria-hidden="true" tabindex="-1"></a>    DBI<span class="sc">::</span><span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(</span>
<span id="cb43-249"><a href="#cb43-249" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CREATE OR REPLACE TABLE {tbl_name} AS</span></span>
<span id="cb43-250"><a href="#cb43-250" aria-hidden="true" tabindex="-1"></a><span class="st">       SELECT * FROM read_parquet('{pqt_path}')"</span>))</span>
<span id="cb43-251"><a href="#cb43-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-252"><a href="#cb43-252" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con, <span class="fu">glue</span>(<span class="st">"SELECT COUNT(*) AS n FROM {tbl_name}"</span>))<span class="sc">$</span>n</span>
<span id="cb43-253"><a href="#cb43-253" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">table =</span> tbl_name, <span class="at">rows =</span> n, <span class="at">source =</span> <span class="st">"bottle"</span>)</span>
<span id="cb43-254"><a href="#cb43-254" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb43-255"><a href="#cb43-255" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-256"><a href="#cb43-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-257"><a href="#cb43-257" aria-hidden="true" tabindex="-1"></a>bottle_stats <span class="sc">|&gt;</span> <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Bottle tables loaded"</span>)</span>
<span id="cb43-258"><a href="#cb43-258" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-259"><a href="#cb43-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-260"><a href="#cb43-260" aria-hidden="true" tabindex="-1"></a><span class="fu">## Show Loaded Tables</span></span>
<span id="cb43-261"><a href="#cb43-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-264"><a href="#cb43-264" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-265"><a href="#cb43-265" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: show_tables</span></span>
<span id="cb43-266"><a href="#cb43-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-267"><a href="#cb43-267" aria-hidden="true" tabindex="-1"></a>all_stats <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(ichthyo_stats, bottle_stats)</span>
<span id="cb43-268"><a href="#cb43-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-269"><a href="#cb43-269" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(</span>
<span id="cb43-270"><a href="#cb43-270" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Loaded {nrow(all_stats)} tables: "</span>,</span>
<span id="cb43-271"><a href="#cb43-271" aria-hidden="true" tabindex="-1"></a>  <span class="st">"{sum(all_stats$source == 'ichthyo')} ichthyo + "</span>,</span>
<span id="cb43-272"><a href="#cb43-272" aria-hidden="true" tabindex="-1"></a>  <span class="st">"{sum(all_stats$source == 'bottle')} bottle"</span>))</span>
<span id="cb43-273"><a href="#cb43-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-274"><a href="#cb43-274" aria-hidden="true" tabindex="-1"></a>all_stats <span class="sc">|&gt;</span></span>
<span id="cb43-275"><a href="#cb43-275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(source, table) <span class="sc">|&gt;</span></span>
<span id="cb43-276"><a href="#cb43-276" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"All loaded tables"</span>)</span>
<span id="cb43-277"><a href="#cb43-277" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-278"><a href="#cb43-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-279"><a href="#cb43-279" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fuzzy Ship Matching</span></span>
<span id="cb43-280"><a href="#cb43-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-281"><a href="#cb43-281" aria-hidden="true" tabindex="-1"></a>Reconcile ship codes between bottle casts and swfsc ship reference</span>
<span id="cb43-282"><a href="#cb43-282" aria-hidden="true" tabindex="-1"></a>table. Uses <span class="in">`calcofi4db::match_ships()`</span>.</span>
<span id="cb43-283"><a href="#cb43-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-286"><a href="#cb43-286" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-287"><a href="#cb43-287" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ship_matching</span></span>
<span id="cb43-288"><a href="#cb43-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-289"><a href="#cb43-289" aria-hidden="true" tabindex="-1"></a><span class="co"># get unmatched ships from casts</span></span>
<span id="cb43-290"><a href="#cb43-290" aria-hidden="true" tabindex="-1"></a>unmatched <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"</span></span>
<span id="cb43-291"><a href="#cb43-291" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT DISTINCT c.ship_code, c.ship_name</span></span>
<span id="cb43-292"><a href="#cb43-292" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM casts c</span></span>
<span id="cb43-293"><a href="#cb43-293" aria-hidden="true" tabindex="-1"></a><span class="st">  LEFT JOIN ship s ON c.ship_code = s.ship_nodc</span></span>
<span id="cb43-294"><a href="#cb43-294" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE s.ship_key IS NULL"</span>)</span>
<span id="cb43-295"><a href="#cb43-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-296"><a href="#cb43-296" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"{nrow(unmatched)} unmatched ship codes in casts"</span>))</span>
<span id="cb43-297"><a href="#cb43-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-298"><a href="#cb43-298" aria-hidden="true" tabindex="-1"></a><span class="co"># ship renames CSV (manual overrides from previous reconciliation)</span></span>
<span id="cb43-299"><a href="#cb43-299" aria-hidden="true" tabindex="-1"></a>ship_renames_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(</span>
<span id="cb43-300"><a href="#cb43-300" aria-hidden="true" tabindex="-1"></a>  <span class="st">"metadata/calcofi.org/bottle-database/ship_renames.csv"</span>)</span>
<span id="cb43-301"><a href="#cb43-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-302"><a href="#cb43-302" aria-hidden="true" tabindex="-1"></a><span class="co"># run fuzzy matching</span></span>
<span id="cb43-303"><a href="#cb43-303" aria-hidden="true" tabindex="-1"></a>ship_matches <span class="ot">&lt;-</span> <span class="fu">match_ships</span>(</span>
<span id="cb43-304"><a href="#cb43-304" aria-hidden="true" tabindex="-1"></a>  <span class="at">unmatched_ships  =</span> unmatched,</span>
<span id="cb43-305"><a href="#cb43-305" aria-hidden="true" tabindex="-1"></a>  <span class="at">reference_ships  =</span> <span class="fu">dbReadTable</span>(con, <span class="st">"ship"</span>),</span>
<span id="cb43-306"><a href="#cb43-306" aria-hidden="true" tabindex="-1"></a>  <span class="at">ship_renames_csv =</span> ship_renames_csv,</span>
<span id="cb43-307"><a href="#cb43-307" aria-hidden="true" tabindex="-1"></a>  <span class="at">fetch_ices       =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-308"><a href="#cb43-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-309"><a href="#cb43-309" aria-hidden="true" tabindex="-1"></a>ship_matches <span class="sc">|&gt;</span></span>
<span id="cb43-310"><a href="#cb43-310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Ship matching results"</span>)</span>
<span id="cb43-311"><a href="#cb43-311" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-312"><a href="#cb43-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-313"><a href="#cb43-313" aria-hidden="true" tabindex="-1"></a><span class="fu">### Match Statistics</span></span>
<span id="cb43-314"><a href="#cb43-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-317"><a href="#cb43-317" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-318"><a href="#cb43-318" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ship_match_stats</span></span>
<span id="cb43-319"><a href="#cb43-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-320"><a href="#cb43-320" aria-hidden="true" tabindex="-1"></a>ship_matches <span class="sc">|&gt;</span></span>
<span id="cb43-321"><a href="#cb43-321" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(match_type) <span class="sc">|&gt;</span></span>
<span id="cb43-322"><a href="#cb43-322" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Ship match type counts"</span>)</span>
<span id="cb43-323"><a href="#cb43-323" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-324"><a href="#cb43-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-325"><a href="#cb43-325" aria-hidden="true" tabindex="-1"></a><span class="fu">## Build Cruise Bridge</span></span>
<span id="cb43-326"><a href="#cb43-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-327"><a href="#cb43-327" aria-hidden="true" tabindex="-1"></a>Link bottle casts to swfsc cruise table via ship_key → cruise_key.</span>
<span id="cb43-328"><a href="#cb43-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-329"><a href="#cb43-329" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 1: Add ship_key to casts</span></span>
<span id="cb43-330"><a href="#cb43-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-333"><a href="#cb43-333" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-334"><a href="#cb43-334" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cruise_bridge_ship_key</span></span>
<span id="cb43-335"><a href="#cb43-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-336"><a href="#cb43-336" aria-hidden="true" tabindex="-1"></a><span class="co"># add ship_key column</span></span>
<span id="cb43-337"><a href="#cb43-337" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con, <span class="st">"ALTER TABLE casts ADD COLUMN IF NOT EXISTS ship_key TEXT"</span>)</span>
<span id="cb43-338"><a href="#cb43-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-339"><a href="#cb43-339" aria-hidden="true" tabindex="-1"></a><span class="co"># exact match: casts.ship_code = ship.ship_nodc</span></span>
<span id="cb43-340"><a href="#cb43-340" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con, <span class="st">"</span></span>
<span id="cb43-341"><a href="#cb43-341" aria-hidden="true" tabindex="-1"></a><span class="st">  UPDATE casts SET ship_key = (</span></span>
<span id="cb43-342"><a href="#cb43-342" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT s.ship_key FROM ship s</span></span>
<span id="cb43-343"><a href="#cb43-343" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE s.ship_nodc = casts.ship_code</span></span>
<span id="cb43-344"><a href="#cb43-344" aria-hidden="true" tabindex="-1"></a><span class="st">    LIMIT 1)"</span>)</span>
<span id="cb43-345"><a href="#cb43-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-346"><a href="#cb43-346" aria-hidden="true" tabindex="-1"></a>n_exact <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con,</span>
<span id="cb43-347"><a href="#cb43-347" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SELECT COUNT(*) AS n FROM casts WHERE ship_key IS NOT NULL"</span>)<span class="sc">$</span>n</span>
<span id="cb43-348"><a href="#cb43-348" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Exact ship_nodc match: {n_exact} casts"</span>))</span>
<span id="cb43-349"><a href="#cb43-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-350"><a href="#cb43-350" aria-hidden="true" tabindex="-1"></a><span class="co"># apply fuzzy match results for previously unmatched ships</span></span>
<span id="cb43-351"><a href="#cb43-351" aria-hidden="true" tabindex="-1"></a>matched_ships <span class="ot">&lt;-</span> ship_matches <span class="sc">|&gt;</span></span>
<span id="cb43-352"><a href="#cb43-352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(match_type <span class="sc">!=</span> <span class="st">"unmatched"</span>, <span class="sc">!</span><span class="fu">is.na</span>(matched_ship_key))</span>
<span id="cb43-353"><a href="#cb43-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-354"><a href="#cb43-354" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(matched_ships) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb43-355"><a href="#cb43-355" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(matched_ships))) {</span>
<span id="cb43-356"><a href="#cb43-356" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> matched_ships[i, ]</span>
<span id="cb43-357"><a href="#cb43-357" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb43-358"><a href="#cb43-358" aria-hidden="true" tabindex="-1"></a><span class="st">      UPDATE casts SET ship_key = '{m$matched_ship_key}'</span></span>
<span id="cb43-359"><a href="#cb43-359" aria-hidden="true" tabindex="-1"></a><span class="st">      WHERE ship_code = '{m$ship_code}'</span></span>
<span id="cb43-360"><a href="#cb43-360" aria-hidden="true" tabindex="-1"></a><span class="st">        AND ship_key IS NULL"</span>))</span>
<span id="cb43-361"><a href="#cb43-361" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-362"><a href="#cb43-362" aria-hidden="true" tabindex="-1"></a>  n_fuzzy <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con,</span>
<span id="cb43-363"><a href="#cb43-363" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT COUNT(*) AS n FROM casts WHERE ship_key IS NOT NULL"</span>)<span class="sc">$</span>n <span class="sc">-</span> n_exact</span>
<span id="cb43-364"><a href="#cb43-364" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Fuzzy/manual match: {n_fuzzy} additional casts"</span>))</span>
<span id="cb43-365"><a href="#cb43-365" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-366"><a href="#cb43-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-367"><a href="#cb43-367" aria-hidden="true" tabindex="-1"></a><span class="co"># summary</span></span>
<span id="cb43-368"><a href="#cb43-368" aria-hidden="true" tabindex="-1"></a>ship_key_stats <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"</span></span>
<span id="cb43-369"><a href="#cb43-369" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT</span></span>
<span id="cb43-370"><a href="#cb43-370" aria-hidden="true" tabindex="-1"></a><span class="st">    CASE WHEN ship_key IS NULL THEN 'no_ship_match'</span></span>
<span id="cb43-371"><a href="#cb43-371" aria-hidden="true" tabindex="-1"></a><span class="st">         ELSE 'matched' END AS status,</span></span>
<span id="cb43-372"><a href="#cb43-372" aria-hidden="true" tabindex="-1"></a><span class="st">    COUNT(*) AS n_casts</span></span>
<span id="cb43-373"><a href="#cb43-373" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM casts</span></span>
<span id="cb43-374"><a href="#cb43-374" aria-hidden="true" tabindex="-1"></a><span class="st">  GROUP BY status"</span>)</span>
<span id="cb43-375"><a href="#cb43-375" aria-hidden="true" tabindex="-1"></a>ship_key_stats <span class="sc">|&gt;</span> <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"ship_key assignment stats"</span>)</span>
<span id="cb43-376"><a href="#cb43-376" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-377"><a href="#cb43-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-378"><a href="#cb43-378" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 2: Derive cruise_key</span></span>
<span id="cb43-379"><a href="#cb43-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-380"><a href="#cb43-380" aria-hidden="true" tabindex="-1"></a>Cruise key format: YYMMKK (2-digit year, 2-digit month, 2-letter ship</span>
<span id="cb43-381"><a href="#cb43-381" aria-hidden="true" tabindex="-1"></a>key). The bottle ingest stores the original <span class="in">`Cruise_ID`</span> as <span class="in">`cruise_key_0`</span></span>
<span id="cb43-382"><a href="#cb43-382" aria-hidden="true" tabindex="-1"></a>(interim), so <span class="in">`cruise_key`</span> is a new column bridging bottle casts to the</span>
<span id="cb43-383"><a href="#cb43-383" aria-hidden="true" tabindex="-1"></a>SWFSC <span class="in">`cruise`</span> table.</span>
<span id="cb43-384"><a href="#cb43-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-387"><a href="#cb43-387" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-388"><a href="#cb43-388" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cruise_bridge_cruise_key</span></span>
<span id="cb43-389"><a href="#cb43-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-390"><a href="#cb43-390" aria-hidden="true" tabindex="-1"></a><span class="co"># add cruise_key column</span></span>
<span id="cb43-391"><a href="#cb43-391" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con, <span class="st">"ALTER TABLE casts ADD COLUMN IF NOT EXISTS cruise_key TEXT"</span>)</span>
<span id="cb43-392"><a href="#cb43-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-393"><a href="#cb43-393" aria-hidden="true" tabindex="-1"></a><span class="co"># derive YYMMKK from datetime_utc + ship_key</span></span>
<span id="cb43-394"><a href="#cb43-394" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(con, <span class="st">"</span></span>
<span id="cb43-395"><a href="#cb43-395" aria-hidden="true" tabindex="-1"></a><span class="st">  UPDATE casts SET cruise_key = CONCAT(</span></span>
<span id="cb43-396"><a href="#cb43-396" aria-hidden="true" tabindex="-1"></a><span class="st">    LPAD(CAST(EXTRACT(YEAR FROM datetime_utc) % 100 AS VARCHAR), 2, '0'),</span></span>
<span id="cb43-397"><a href="#cb43-397" aria-hidden="true" tabindex="-1"></a><span class="st">    LPAD(CAST(EXTRACT(MONTH FROM datetime_utc) AS VARCHAR), 2, '0'),</span></span>
<span id="cb43-398"><a href="#cb43-398" aria-hidden="true" tabindex="-1"></a><span class="st">    ship_key)</span></span>
<span id="cb43-399"><a href="#cb43-399" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE ship_key IS NOT NULL"</span>)</span>
<span id="cb43-400"><a href="#cb43-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-401"><a href="#cb43-401" aria-hidden="true" tabindex="-1"></a>n_cruise <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con,</span>
<span id="cb43-402"><a href="#cb43-402" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SELECT COUNT(*) AS n FROM casts WHERE cruise_key IS NOT NULL"</span>)<span class="sc">$</span>n</span>
<span id="cb43-403"><a href="#cb43-403" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Derived cruise_key for {n_cruise} casts"</span>))</span>
<span id="cb43-404"><a href="#cb43-404" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-405"><a href="#cb43-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-406"><a href="#cb43-406" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 3: Validate against swfsc cruise table</span></span>
<span id="cb43-407"><a href="#cb43-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-410"><a href="#cb43-410" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-411"><a href="#cb43-411" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cruise_bridge_validate</span></span>
<span id="cb43-412"><a href="#cb43-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-413"><a href="#cb43-413" aria-hidden="true" tabindex="-1"></a>cruise_stats <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"</span></span>
<span id="cb43-414"><a href="#cb43-414" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT</span></span>
<span id="cb43-415"><a href="#cb43-415" aria-hidden="true" tabindex="-1"></a><span class="st">    CASE</span></span>
<span id="cb43-416"><a href="#cb43-416" aria-hidden="true" tabindex="-1"></a><span class="st">      WHEN c.ship_key IS NULL THEN 'no_ship_match'</span></span>
<span id="cb43-417"><a href="#cb43-417" aria-hidden="true" tabindex="-1"></a><span class="st">      WHEN c.cruise_key IS NULL THEN 'no_cruise_key'</span></span>
<span id="cb43-418"><a href="#cb43-418" aria-hidden="true" tabindex="-1"></a><span class="st">      WHEN cr.cruise_key IS NULL THEN 'no_cruise_match'</span></span>
<span id="cb43-419"><a href="#cb43-419" aria-hidden="true" tabindex="-1"></a><span class="st">      ELSE 'matched'</span></span>
<span id="cb43-420"><a href="#cb43-420" aria-hidden="true" tabindex="-1"></a><span class="st">    END AS status,</span></span>
<span id="cb43-421"><a href="#cb43-421" aria-hidden="true" tabindex="-1"></a><span class="st">    COUNT(*) AS n_casts</span></span>
<span id="cb43-422"><a href="#cb43-422" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM casts c</span></span>
<span id="cb43-423"><a href="#cb43-423" aria-hidden="true" tabindex="-1"></a><span class="st">  LEFT JOIN cruise cr ON c.cruise_key = cr.cruise_key</span></span>
<span id="cb43-424"><a href="#cb43-424" aria-hidden="true" tabindex="-1"></a><span class="st">  GROUP BY status</span></span>
<span id="cb43-425"><a href="#cb43-425" aria-hidden="true" tabindex="-1"></a><span class="st">  ORDER BY status"</span>)</span>
<span id="cb43-426"><a href="#cb43-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-427"><a href="#cb43-427" aria-hidden="true" tabindex="-1"></a>cruise_stats <span class="sc">|&gt;</span> <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Cruise bridge match statistics"</span>)</span>
<span id="cb43-428"><a href="#cb43-428" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-429"><a href="#cb43-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-430"><a href="#cb43-430" aria-hidden="true" tabindex="-1"></a><span class="fu">### Step 4: Report unmatched ship codes</span></span>
<span id="cb43-431"><a href="#cb43-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-434"><a href="#cb43-434" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-435"><a href="#cb43-435" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: unmatched_ships</span></span>
<span id="cb43-436"><a href="#cb43-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-437"><a href="#cb43-437" aria-hidden="true" tabindex="-1"></a>unmatched_report <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"</span></span>
<span id="cb43-438"><a href="#cb43-438" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT DISTINCT</span></span>
<span id="cb43-439"><a href="#cb43-439" aria-hidden="true" tabindex="-1"></a><span class="st">    c.ship_code, c.ship_name,</span></span>
<span id="cb43-440"><a href="#cb43-440" aria-hidden="true" tabindex="-1"></a><span class="st">    COUNT(*) AS n_casts,</span></span>
<span id="cb43-441"><a href="#cb43-441" aria-hidden="true" tabindex="-1"></a><span class="st">    MIN(c.datetime_utc) AS first_cast,</span></span>
<span id="cb43-442"><a href="#cb43-442" aria-hidden="true" tabindex="-1"></a><span class="st">    MAX(c.datetime_utc) AS last_cast</span></span>
<span id="cb43-443"><a href="#cb43-443" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM casts c</span></span>
<span id="cb43-444"><a href="#cb43-444" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE c.ship_key IS NULL</span></span>
<span id="cb43-445"><a href="#cb43-445" aria-hidden="true" tabindex="-1"></a><span class="st">  GROUP BY c.ship_code, c.ship_name</span></span>
<span id="cb43-446"><a href="#cb43-446" aria-hidden="true" tabindex="-1"></a><span class="st">  ORDER BY n_casts DESC"</span>)</span>
<span id="cb43-447"><a href="#cb43-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-448"><a href="#cb43-448" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(unmatched_report) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb43-449"><a href="#cb43-449" aria-hidden="true" tabindex="-1"></a>  unmatched_report <span class="sc">|&gt;</span></span>
<span id="cb43-450"><a href="#cb43-450" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Unmatched ship codes (no ship_key)"</span>)</span>
<span id="cb43-451"><a href="#cb43-451" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb43-452"><a href="#cb43-452" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"All ship codes matched!"</span>)</span>
<span id="cb43-453"><a href="#cb43-453" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-454"><a href="#cb43-454" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-455"><a href="#cb43-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-456"><a href="#cb43-456" aria-hidden="true" tabindex="-1"></a><span class="fu">## Standardize Taxonomy</span></span>
<span id="cb43-457"><a href="#cb43-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-458"><a href="#cb43-458" aria-hidden="true" tabindex="-1"></a>Update species table with WoRMS/ITIS/GBIF identifiers using</span>
<span id="cb43-459"><a href="#cb43-459" aria-hidden="true" tabindex="-1"></a><span class="in">`standardize_species()`</span> and build taxonomy hierarchy using</span>
<span id="cb43-460"><a href="#cb43-460" aria-hidden="true" tabindex="-1"></a><span class="in">`build_taxon_table()`</span> from <span class="in">`calcofi4db/R/taxonomy.R`</span>.</span>
<span id="cb43-461"><a href="#cb43-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-464"><a href="#cb43-464" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-465"><a href="#cb43-465" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: standardize_species</span></span>
<span id="cb43-466"><a href="#cb43-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-467"><a href="#cb43-467" aria-hidden="true" tabindex="-1"></a><span class="co"># check if species already standardized (all taxonomy columns exist with data)</span></span>
<span id="cb43-468"><a href="#cb43-468" aria-hidden="true" tabindex="-1"></a>sp_cols <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con,</span>
<span id="cb43-469"><a href="#cb43-469" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SELECT column_name FROM information_schema.columns</span></span>
<span id="cb43-470"><a href="#cb43-470" aria-hidden="true" tabindex="-1"></a><span class="st">   WHERE table_name = 'species'"</span>)<span class="sc">$</span>column_name</span>
<span id="cb43-471"><a href="#cb43-471" aria-hidden="true" tabindex="-1"></a>sp_standardized <span class="ot">&lt;-</span> <span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"worms_id"</span>, <span class="st">"itis_id"</span>, <span class="st">"gbif_id"</span>) <span class="sc">%in%</span> sp_cols) <span class="sc">&amp;&amp;</span></span>
<span id="cb43-472"><a href="#cb43-472" aria-hidden="true" tabindex="-1"></a>  DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con,</span>
<span id="cb43-473"><a href="#cb43-473" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT COUNT(*) AS n FROM species WHERE worms_id IS NOT NULL"</span>)<span class="sc">$</span>n <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb43-474"><a href="#cb43-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-475"><a href="#cb43-475" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (sp_standardized <span class="sc">&amp;&amp;</span> <span class="sc">!</span>overwrite) {</span>
<span id="cb43-476"><a href="#cb43-476" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Species already standardized, skipping API calls"</span>)</span>
<span id="cb43-477"><a href="#cb43-477" aria-hidden="true" tabindex="-1"></a>  sp_results <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con,</span>
<span id="cb43-478"><a href="#cb43-478" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT species_id, scientific_name, worms_id, itis_id, gbif_id</span></span>
<span id="cb43-479"><a href="#cb43-479" aria-hidden="true" tabindex="-1"></a><span class="st">     FROM species"</span>)</span>
<span id="cb43-480"><a href="#cb43-480" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb43-481"><a href="#cb43-481" aria-hidden="true" tabindex="-1"></a>  <span class="co"># standardize species identifiers (slow - makes API calls)</span></span>
<span id="cb43-482"><a href="#cb43-482" aria-hidden="true" tabindex="-1"></a>  sp_results <span class="ot">&lt;-</span> <span class="fu">standardize_species</span>(</span>
<span id="cb43-483"><a href="#cb43-483" aria-hidden="true" tabindex="-1"></a>    <span class="at">con           =</span> con,</span>
<span id="cb43-484"><a href="#cb43-484" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_tbl   =</span> <span class="st">"species"</span>,</span>
<span id="cb43-485"><a href="#cb43-485" aria-hidden="true" tabindex="-1"></a>    <span class="at">include_gbif  =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-486"><a href="#cb43-486" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-487"><a href="#cb43-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-488"><a href="#cb43-488" aria-hidden="true" tabindex="-1"></a>sp_results <span class="sc">|&gt;</span></span>
<span id="cb43-489"><a href="#cb43-489" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Species standardization results"</span>)</span>
<span id="cb43-490"><a href="#cb43-490" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-491"><a href="#cb43-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-494"><a href="#cb43-494" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-495"><a href="#cb43-495" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: build_taxon</span></span>
<span id="cb43-496"><a href="#cb43-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-497"><a href="#cb43-497" aria-hidden="true" tabindex="-1"></a><span class="co"># check if taxon table already exists with data</span></span>
<span id="cb43-498"><a href="#cb43-498" aria-hidden="true" tabindex="-1"></a>taxon_exists <span class="ot">&lt;-</span> <span class="st">"taxon"</span> <span class="sc">%in%</span> existing_tables <span class="sc">&amp;&amp;</span></span>
<span id="cb43-499"><a href="#cb43-499" aria-hidden="true" tabindex="-1"></a>  DBI<span class="sc">::</span><span class="fu">dbGetQuery</span>(con, <span class="st">"SELECT COUNT(*) AS n FROM taxon"</span>)<span class="sc">$</span>n <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb43-500"><a href="#cb43-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-501"><a href="#cb43-501" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (taxon_exists <span class="sc">&amp;&amp;</span> <span class="sc">!</span>overwrite) {</span>
<span id="cb43-502"><a href="#cb43-502" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Taxon table already exists, skipping API calls"</span>)</span>
<span id="cb43-503"><a href="#cb43-503" aria-hidden="true" tabindex="-1"></a>  taxon_rows <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbReadTable</span>(con, <span class="st">"taxon"</span>)</span>
<span id="cb43-504"><a href="#cb43-504" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb43-505"><a href="#cb43-505" aria-hidden="true" tabindex="-1"></a>  <span class="co"># build taxon hierarchy table (slow - makes API calls)</span></span>
<span id="cb43-506"><a href="#cb43-506" aria-hidden="true" tabindex="-1"></a>  taxon_rows <span class="ot">&lt;-</span> <span class="fu">build_taxon_table</span>(</span>
<span id="cb43-507"><a href="#cb43-507" aria-hidden="true" tabindex="-1"></a>    <span class="at">con          =</span> con,</span>
<span id="cb43-508"><a href="#cb43-508" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_tbl  =</span> <span class="st">"species"</span>,</span>
<span id="cb43-509"><a href="#cb43-509" aria-hidden="true" tabindex="-1"></a>    <span class="at">taxon_tbl    =</span> <span class="st">"taxon"</span>,</span>
<span id="cb43-510"><a href="#cb43-510" aria-hidden="true" tabindex="-1"></a>    <span class="at">include_itis =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-511"><a href="#cb43-511" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-512"><a href="#cb43-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-513"><a href="#cb43-513" aria-hidden="true" tabindex="-1"></a><span class="co"># show taxon stats</span></span>
<span id="cb43-514"><a href="#cb43-514" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(taxon_rows) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb43-515"><a href="#cb43-515" aria-hidden="true" tabindex="-1"></a>  taxon_rows <span class="sc">|&gt;</span></span>
<span id="cb43-516"><a href="#cb43-516" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>(authority, taxonRank) <span class="sc">|&gt;</span></span>
<span id="cb43-517"><a href="#cb43-517" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(authority, taxonRank) <span class="sc">|&gt;</span></span>
<span id="cb43-518"><a href="#cb43-518" aria-hidden="true" tabindex="-1"></a>    <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Taxon hierarchy by authority and rank"</span>)</span>
<span id="cb43-519"><a href="#cb43-519" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-520"><a href="#cb43-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-521"><a href="#cb43-521" aria-hidden="true" tabindex="-1"></a><span class="co"># show taxa_rank lookup</span></span>
<span id="cb43-522"><a href="#cb43-522" aria-hidden="true" tabindex="-1"></a><span class="fu">dbReadTable</span>(con, <span class="st">"taxa_rank"</span>) <span class="sc">|&gt;</span></span>
<span id="cb43-523"><a href="#cb43-523" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Taxa rank ordering"</span>)</span>
<span id="cb43-524"><a href="#cb43-524" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-525"><a href="#cb43-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-526"><a href="#cb43-526" aria-hidden="true" tabindex="-1"></a><span class="fu">### Taxonomy Statistics</span></span>
<span id="cb43-527"><a href="#cb43-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-530"><a href="#cb43-530" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-531"><a href="#cb43-531" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: taxonomy_stats</span></span>
<span id="cb43-532"><a href="#cb43-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-533"><a href="#cb43-533" aria-hidden="true" tabindex="-1"></a>n_species   <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"SELECT COUNT(*) AS n FROM species"</span>)<span class="sc">$</span>n</span>
<span id="cb43-534"><a href="#cb43-534" aria-hidden="true" tabindex="-1"></a>n_worms     <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con,</span>
<span id="cb43-535"><a href="#cb43-535" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SELECT COUNT(*) AS n FROM species WHERE worms_id IS NOT NULL"</span>)<span class="sc">$</span>n</span>
<span id="cb43-536"><a href="#cb43-536" aria-hidden="true" tabindex="-1"></a>n_itis      <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con,</span>
<span id="cb43-537"><a href="#cb43-537" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SELECT COUNT(*) AS n FROM species WHERE itis_id IS NOT NULL"</span>)<span class="sc">$</span>n</span>
<span id="cb43-538"><a href="#cb43-538" aria-hidden="true" tabindex="-1"></a>n_gbif      <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con,</span>
<span id="cb43-539"><a href="#cb43-539" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SELECT COUNT(*) AS n FROM species WHERE gbif_id IS NOT NULL"</span>)<span class="sc">$</span>n</span>
<span id="cb43-540"><a href="#cb43-540" aria-hidden="true" tabindex="-1"></a>n_taxon     <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"SELECT COUNT(*) AS n FROM taxon"</span>)<span class="sc">$</span>n</span>
<span id="cb43-541"><a href="#cb43-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-542"><a href="#cb43-542" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb43-543"><a href="#cb43-543" aria-hidden="true" tabindex="-1"></a>  <span class="at">metric =</span> <span class="fu">c</span>(<span class="st">"total species"</span>, <span class="st">"with worms_id"</span>, <span class="st">"with itis_id"</span>,</span>
<span id="cb43-544"><a href="#cb43-544" aria-hidden="true" tabindex="-1"></a>             <span class="st">"with gbif_id"</span>, <span class="st">"taxon hierarchy rows"</span>),</span>
<span id="cb43-545"><a href="#cb43-545" aria-hidden="true" tabindex="-1"></a>  <span class="at">count  =</span> <span class="fu">c</span>(n_species, n_worms, n_itis, n_gbif, n_taxon)) <span class="sc">|&gt;</span></span>
<span id="cb43-546"><a href="#cb43-546" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Taxonomy standardization summary"</span>)</span>
<span id="cb43-547"><a href="#cb43-547" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-548"><a href="#cb43-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-549"><a href="#cb43-549" aria-hidden="true" tabindex="-1"></a><span class="fu">## Validate Cross-Dataset Integrity</span></span>
<span id="cb43-550"><a href="#cb43-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-553"><a href="#cb43-553" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-554"><a href="#cb43-554" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: validate</span></span>
<span id="cb43-555"><a href="#cb43-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-556"><a href="#cb43-556" aria-hidden="true" tabindex="-1"></a><span class="co"># grid_key integrity: casts.grid_key should all be in grid.grid_key</span></span>
<span id="cb43-557"><a href="#cb43-557" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">"grid_key"</span> <span class="sc">%in%</span> <span class="fu">dbListFields</span>(con, <span class="st">"casts"</span>) <span class="sc">&amp;&amp;</span></span>
<span id="cb43-558"><a href="#cb43-558" aria-hidden="true" tabindex="-1"></a>    <span class="st">"grid_key"</span> <span class="sc">%in%</span> <span class="fu">dbListFields</span>(con, <span class="st">"grid"</span>)) {</span>
<span id="cb43-559"><a href="#cb43-559" aria-hidden="true" tabindex="-1"></a>  grid_orphans <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"</span></span>
<span id="cb43-560"><a href="#cb43-560" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT COUNT(*) AS n FROM casts c</span></span>
<span id="cb43-561"><a href="#cb43-561" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE c.grid_key IS NOT NULL</span></span>
<span id="cb43-562"><a href="#cb43-562" aria-hidden="true" tabindex="-1"></a><span class="st">      AND c.grid_key NOT IN (SELECT grid_key FROM grid)"</span>)<span class="sc">$</span>n</span>
<span id="cb43-563"><a href="#cb43-563" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Grid key orphans in casts: {grid_orphans}"</span>))</span>
<span id="cb43-564"><a href="#cb43-564" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-565"><a href="#cb43-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-566"><a href="#cb43-566" aria-hidden="true" tabindex="-1"></a><span class="co"># ship PK uniqueness</span></span>
<span id="cb43-567"><a href="#cb43-567" aria-hidden="true" tabindex="-1"></a>ship_dups <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"</span></span>
<span id="cb43-568"><a href="#cb43-568" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT ship_key, COUNT(*) AS n FROM ship</span></span>
<span id="cb43-569"><a href="#cb43-569" aria-hidden="true" tabindex="-1"></a><span class="st">  GROUP BY ship_key HAVING COUNT(*) &gt; 1"</span>)</span>
<span id="cb43-570"><a href="#cb43-570" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(ship_dups) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb43-571"><a href="#cb43-571" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="fu">glue</span>(<span class="st">"Duplicate ship_key values: {nrow(ship_dups)}"</span>))</span>
<span id="cb43-572"><a href="#cb43-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-573"><a href="#cb43-573" aria-hidden="true" tabindex="-1"></a><span class="co"># cruise PK uniqueness</span></span>
<span id="cb43-574"><a href="#cb43-574" aria-hidden="true" tabindex="-1"></a>cruise_dups <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"</span></span>
<span id="cb43-575"><a href="#cb43-575" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT cruise_key, COUNT(*) AS n FROM cruise</span></span>
<span id="cb43-576"><a href="#cb43-576" aria-hidden="true" tabindex="-1"></a><span class="st">  GROUP BY cruise_key HAVING COUNT(*) &gt; 1"</span>)</span>
<span id="cb43-577"><a href="#cb43-577" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(cruise_dups) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb43-578"><a href="#cb43-578" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="fu">glue</span>(<span class="st">"Duplicate cruise_key values: {nrow(cruise_dups)}"</span>))</span>
<span id="cb43-579"><a href="#cb43-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-580"><a href="#cb43-580" aria-hidden="true" tabindex="-1"></a><span class="co"># cruise bridge match statistics</span></span>
<span id="cb43-581"><a href="#cb43-581" aria-hidden="true" tabindex="-1"></a>bridge_stats <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(con, <span class="st">"</span></span>
<span id="cb43-582"><a href="#cb43-582" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT</span></span>
<span id="cb43-583"><a href="#cb43-583" aria-hidden="true" tabindex="-1"></a><span class="st">    COUNT(*) AS total_casts,</span></span>
<span id="cb43-584"><a href="#cb43-584" aria-hidden="true" tabindex="-1"></a><span class="st">    SUM(CASE WHEN ship_key IS NOT NULL THEN 1 ELSE 0 END) AS with_ship_key,</span></span>
<span id="cb43-585"><a href="#cb43-585" aria-hidden="true" tabindex="-1"></a><span class="st">    SUM(CASE WHEN cruise_key IS NOT NULL THEN 1 ELSE 0 END) AS with_cruise_key</span></span>
<span id="cb43-586"><a href="#cb43-586" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM casts"</span>)</span>
<span id="cb43-587"><a href="#cb43-587" aria-hidden="true" tabindex="-1"></a>bridge_stats <span class="sc">|&gt;</span> <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Cruise bridge coverage"</span>)</span>
<span id="cb43-588"><a href="#cb43-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-589"><a href="#cb43-589" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Cross-dataset validation complete"</span>)</span>
<span id="cb43-590"><a href="#cb43-590" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-591"><a href="#cb43-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-592"><a href="#cb43-592" aria-hidden="true" tabindex="-1"></a><span class="fu">## Show Combined Schema</span></span>
<span id="cb43-593"><a href="#cb43-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-596"><a href="#cb43-596" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-597"><a href="#cb43-597" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: combined_schema</span></span>
<span id="cb43-598"><a href="#cb43-598" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb43-599"><a href="#cb43-599" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb43-600"><a href="#cb43-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-601"><a href="#cb43-601" aria-hidden="true" tabindex="-1"></a><span class="co"># build dm from connection (exclude internal tables)</span></span>
<span id="cb43-602"><a href="#cb43-602" aria-hidden="true" tabindex="-1"></a>tbls <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">dbListTables</span>(con), <span class="fu">c</span>(<span class="st">"_sp_update"</span>))</span>
<span id="cb43-603"><a href="#cb43-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-604"><a href="#cb43-604" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> dm<span class="sc">::</span><span class="fu">dm_from_con</span>(con, <span class="at">table_names =</span> tbls, <span class="at">learn_keys =</span> <span class="cn">FALSE</span>)</span>
<span id="cb43-605"><a href="#cb43-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-606"><a href="#cb43-606" aria-hidden="true" tabindex="-1"></a><span class="co"># set table colors by group</span></span>
<span id="cb43-607"><a href="#cb43-607" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb43-608"><a href="#cb43-608" aria-hidden="true" tabindex="-1"></a>  dm<span class="sc">::</span><span class="fu">dm_set_colors</span>(</span>
<span id="cb43-609"><a href="#cb43-609" aria-hidden="true" tabindex="-1"></a>    <span class="at">lightblue    =</span> <span class="fu">c</span>(cruise, site, tow, net),      <span class="co"># ichthyo chain</span></span>
<span id="cb43-610"><a href="#cb43-610" aria-hidden="true" tabindex="-1"></a>    <span class="at">lightyellow  =</span> <span class="fu">c</span>(ichthyo, species, lookup),     <span class="co"># species/lookup</span></span>
<span id="cb43-611"><a href="#cb43-611" aria-hidden="true" tabindex="-1"></a>    <span class="at">lightgreen   =</span> <span class="fu">c</span>(grid, segment),                <span class="co"># spatial</span></span>
<span id="cb43-612"><a href="#cb43-612" aria-hidden="true" tabindex="-1"></a>    <span class="at">pink         =</span> <span class="fu">c</span>(casts, bottle, bottle_measurement,</span>
<span id="cb43-613"><a href="#cb43-613" aria-hidden="true" tabindex="-1"></a>                     cast_condition, measurement_type))  <span class="co"># bottle chain</span></span>
<span id="cb43-614"><a href="#cb43-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-615"><a href="#cb43-615" aria-hidden="true" tabindex="-1"></a><span class="co"># add colors for new taxonomy tables if they exist</span></span>
<span id="cb43-616"><a href="#cb43-616" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">"taxon"</span> <span class="sc">%in%</span> tbls)</span>
<span id="cb43-617"><a href="#cb43-617" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> dm<span class="sc">::</span><span class="fu">dm_set_colors</span>(<span class="at">lightyellow =</span> taxon)</span>
<span id="cb43-618"><a href="#cb43-618" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">"taxa_rank"</span> <span class="sc">%in%</span> tbls)</span>
<span id="cb43-619"><a href="#cb43-619" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> dm<span class="sc">::</span><span class="fu">dm_set_colors</span>(<span class="at">lightyellow =</span> taxa_rank)</span>
<span id="cb43-620"><a href="#cb43-620" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">"ship"</span> <span class="sc">%in%</span> tbls)</span>
<span id="cb43-621"><a href="#cb43-621" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> dm<span class="sc">::</span><span class="fu">dm_set_colors</span>(<span class="at">lightblue =</span> ship)</span>
<span id="cb43-622"><a href="#cb43-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-623"><a href="#cb43-623" aria-hidden="true" tabindex="-1"></a>dm<span class="sc">::</span><span class="fu">dm_draw</span>(d, <span class="at">rankdir =</span> <span class="st">"LR"</span>, <span class="at">view_type =</span> <span class="st">"all"</span>)</span>
<span id="cb43-624"><a href="#cb43-624" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-625"><a href="#cb43-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-626"><a href="#cb43-626" aria-hidden="true" tabindex="-1"></a><span class="fu">## Write Modified Parquet Outputs</span></span>
<span id="cb43-627"><a href="#cb43-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-628"><a href="#cb43-628" aria-hidden="true" tabindex="-1"></a>Only export tables that differ from upstream (modified or new). Unchanged</span>
<span id="cb43-629"><a href="#cb43-629" aria-hidden="true" tabindex="-1"></a>tables reference upstream GCS URIs in the manifest.</span>
<span id="cb43-630"><a href="#cb43-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-633"><a href="#cb43-633" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-634"><a href="#cb43-634" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: write_parquet</span></span>
<span id="cb43-635"><a href="#cb43-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-636"><a href="#cb43-636" aria-hidden="true" tabindex="-1"></a><span class="co"># tables modified by this workflow</span></span>
<span id="cb43-637"><a href="#cb43-637" aria-hidden="true" tabindex="-1"></a>modified_tables <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb43-638"><a href="#cb43-638" aria-hidden="true" tabindex="-1"></a>  <span class="st">"casts"</span>,      <span class="co"># added ship_key, cruise_key columns</span></span>
<span id="cb43-639"><a href="#cb43-639" aria-hidden="true" tabindex="-1"></a>  <span class="st">"species"</span>,    <span class="co"># updated worms_id, itis_id, gbif_id</span></span>
<span id="cb43-640"><a href="#cb43-640" aria-hidden="true" tabindex="-1"></a>  <span class="st">"taxon"</span>,      <span class="co"># new table (taxonomy hierarchy)</span></span>
<span id="cb43-641"><a href="#cb43-641" aria-hidden="true" tabindex="-1"></a>  <span class="st">"taxa_rank"</span>)  <span class="co"># new table (rank ordering)</span></span>
<span id="cb43-642"><a href="#cb43-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-643"><a href="#cb43-643" aria-hidden="true" tabindex="-1"></a>dir_pq_merged <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data/parquet/merge_ichthyo_bottle"</span>)</span>
<span id="cb43-644"><a href="#cb43-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-645"><a href="#cb43-645" aria-hidden="true" tabindex="-1"></a>merge_stats <span class="ot">&lt;-</span> <span class="fu">write_parquet_outputs</span>(</span>
<span id="cb43-646"><a href="#cb43-646" aria-hidden="true" tabindex="-1"></a>  <span class="at">con              =</span> con,</span>
<span id="cb43-647"><a href="#cb43-647" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_dir       =</span> dir_pq_merged,</span>
<span id="cb43-648"><a href="#cb43-648" aria-hidden="true" tabindex="-1"></a>  <span class="at">tables           =</span> modified_tables,</span>
<span id="cb43-649"><a href="#cb43-649" aria-hidden="true" tabindex="-1"></a>  <span class="at">strip_provenance =</span> <span class="cn">FALSE</span>)</span>
<span id="cb43-650"><a href="#cb43-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-651"><a href="#cb43-651" aria-hidden="true" tabindex="-1"></a>merge_stats <span class="sc">|&gt;</span></span>
<span id="cb43-652"><a href="#cb43-652" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">file =</span> <span class="fu">basename</span>(path)) <span class="sc">|&gt;</span></span>
<span id="cb43-653"><a href="#cb43-653" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>path) <span class="sc">|&gt;</span></span>
<span id="cb43-654"><a href="#cb43-654" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Modified parquet export statistics"</span>)</span>
<span id="cb43-655"><a href="#cb43-655" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-656"><a href="#cb43-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-657"><a href="#cb43-657" aria-hidden="true" tabindex="-1"></a><span class="fu">### Build Combined Manifest</span></span>
<span id="cb43-658"><a href="#cb43-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-659"><a href="#cb43-659" aria-hidden="true" tabindex="-1"></a>Reference GCS URIs for unchanged upstream tables + local parquet for</span>
<span id="cb43-660"><a href="#cb43-660" aria-hidden="true" tabindex="-1"></a>modified tables.</span>
<span id="cb43-661"><a href="#cb43-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-664"><a href="#cb43-664" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-665"><a href="#cb43-665" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: build_manifest</span></span>
<span id="cb43-666"><a href="#cb43-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-667"><a href="#cb43-667" aria-hidden="true" tabindex="-1"></a><span class="co"># read upstream manifests</span></span>
<span id="cb43-668"><a href="#cb43-668" aria-hidden="true" tabindex="-1"></a>ichthyo_manifest <span class="ot">&lt;-</span> <span class="fu">read_json</span>(ichthyo_manifest_path)</span>
<span id="cb43-669"><a href="#cb43-669" aria-hidden="true" tabindex="-1"></a>bottle_manifest  <span class="ot">&lt;-</span> <span class="fu">read_json</span>(bottle_manifest_path)</span>
<span id="cb43-670"><a href="#cb43-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-671"><a href="#cb43-671" aria-hidden="true" tabindex="-1"></a><span class="co"># build combined manifest</span></span>
<span id="cb43-672"><a href="#cb43-672" aria-hidden="true" tabindex="-1"></a>manifest <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb43-673"><a href="#cb43-673" aria-hidden="true" tabindex="-1"></a>  <span class="at">created_at      =</span> <span class="fu">as.character</span>(<span class="fu">Sys.time</span>()),</span>
<span id="cb43-674"><a href="#cb43-674" aria-hidden="true" tabindex="-1"></a>  <span class="at">release_version =</span> release_version,</span>
<span id="cb43-675"><a href="#cb43-675" aria-hidden="true" tabindex="-1"></a>  <span class="at">modified_tables =</span> merge_stats <span class="sc">|&gt;</span></span>
<span id="cb43-676"><a href="#cb43-676" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(table, rows, file_size) <span class="sc">|&gt;</span></span>
<span id="cb43-677"><a href="#cb43-677" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.list</span>(),</span>
<span id="cb43-678"><a href="#cb43-678" aria-hidden="true" tabindex="-1"></a>  <span class="at">upstream_refs   =</span> <span class="fu">list</span>(</span>
<span id="cb43-679"><a href="#cb43-679" aria-hidden="true" tabindex="-1"></a>    <span class="at">ichthyo =</span> <span class="fu">list</span>(</span>
<span id="cb43-680"><a href="#cb43-680" aria-hidden="true" tabindex="-1"></a>      <span class="at">manifest =</span> ichthyo_manifest<span class="sc">$</span>created_at,</span>
<span id="cb43-681"><a href="#cb43-681" aria-hidden="true" tabindex="-1"></a>      <span class="at">tables   =</span> <span class="fu">setdiff</span>(</span>
<span id="cb43-682"><a href="#cb43-682" aria-hidden="true" tabindex="-1"></a>        ichthyo_manifest<span class="sc">$</span>tables,</span>
<span id="cb43-683"><a href="#cb43-683" aria-hidden="true" tabindex="-1"></a>        modified_tables)),</span>
<span id="cb43-684"><a href="#cb43-684" aria-hidden="true" tabindex="-1"></a>    <span class="at">bottle  =</span> <span class="fu">list</span>(</span>
<span id="cb43-685"><a href="#cb43-685" aria-hidden="true" tabindex="-1"></a>      <span class="at">manifest =</span> bottle_manifest<span class="sc">$</span>created_at,</span>
<span id="cb43-686"><a href="#cb43-686" aria-hidden="true" tabindex="-1"></a>      <span class="at">tables   =</span> <span class="fu">setdiff</span>(</span>
<span id="cb43-687"><a href="#cb43-687" aria-hidden="true" tabindex="-1"></a>        bottle_manifest<span class="sc">$</span>tables,</span>
<span id="cb43-688"><a href="#cb43-688" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(modified_tables, <span class="st">"grid"</span>)))))  <span class="co"># grid canonical from swfsc</span></span>
<span id="cb43-689"><a href="#cb43-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-690"><a href="#cb43-690" aria-hidden="true" tabindex="-1"></a><span class="fu">write_json</span>(</span>
<span id="cb43-691"><a href="#cb43-691" aria-hidden="true" tabindex="-1"></a>  manifest,</span>
<span id="cb43-692"><a href="#cb43-692" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(dir_pq_merged, <span class="st">"manifest.json"</span>),</span>
<span id="cb43-693"><a href="#cb43-693" aria-hidden="true" tabindex="-1"></a>  <span class="at">auto_unbox =</span> <span class="cn">TRUE</span>, <span class="at">pretty =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-694"><a href="#cb43-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-695"><a href="#cb43-695" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(</span>
<span id="cb43-696"><a href="#cb43-696" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Manifest written: {length(modified_tables)} modified tables, "</span>,</span>
<span id="cb43-697"><a href="#cb43-697" aria-hidden="true" tabindex="-1"></a>  <span class="st">"upstream refs for {length(manifest$upstream_refs$ichthyo$tables)} "</span>,</span>
<span id="cb43-698"><a href="#cb43-698" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ichthyo + {length(manifest$upstream_refs$bottle$tables)} bottle"</span>))</span>
<span id="cb43-699"><a href="#cb43-699" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-700"><a href="#cb43-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-701"><a href="#cb43-701" aria-hidden="true" tabindex="-1"></a><span class="fu">## Ingest to Working DuckLake</span></span>
<span id="cb43-702"><a href="#cb43-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-703"><a href="#cb43-703" aria-hidden="true" tabindex="-1"></a>Load ALL tables into Working DuckLake with provenance. Unchanged tables</span>
<span id="cb43-704"><a href="#cb43-704" aria-hidden="true" tabindex="-1"></a>read directly from upstream parquet. Modified tables read from merge</span>
<span id="cb43-705"><a href="#cb43-705" aria-hidden="true" tabindex="-1"></a>output dir.</span>
<span id="cb43-706"><a href="#cb43-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-709"><a href="#cb43-709" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-710"><a href="#cb43-710" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ingest_working</span></span>
<span id="cb43-711"><a href="#cb43-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-712"><a href="#cb43-712" aria-hidden="true" tabindex="-1"></a>con_wdl <span class="ot">&lt;-</span> <span class="fu">get_working_ducklake</span>()</span>
<span id="cb43-713"><a href="#cb43-713" aria-hidden="true" tabindex="-1"></a><span class="fu">load_duckdb_extension</span>(con_wdl, <span class="st">"spatial"</span>)</span>
<span id="cb43-714"><a href="#cb43-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-715"><a href="#cb43-715" aria-hidden="true" tabindex="-1"></a><span class="co"># helper to ingest a parquet file with provenance</span></span>
<span id="cb43-716"><a href="#cb43-716" aria-hidden="true" tabindex="-1"></a>ingest_pqt <span class="ot">&lt;-</span> <span class="cf">function</span>(pqt_path, tbl_name, source_label) {</span>
<span id="cb43-717"><a href="#cb43-717" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(pqt_path)</span>
<span id="cb43-718"><a href="#cb43-718" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ingest_to_working</span>(</span>
<span id="cb43-719"><a href="#cb43-719" aria-hidden="true" tabindex="-1"></a>    <span class="at">con         =</span> con_wdl,</span>
<span id="cb43-720"><a href="#cb43-720" aria-hidden="true" tabindex="-1"></a>    <span class="at">data        =</span> data,</span>
<span id="cb43-721"><a href="#cb43-721" aria-hidden="true" tabindex="-1"></a>    <span class="at">table       =</span> tbl_name,</span>
<span id="cb43-722"><a href="#cb43-722" aria-hidden="true" tabindex="-1"></a>    <span class="at">source_file =</span> source_label,</span>
<span id="cb43-723"><a href="#cb43-723" aria-hidden="true" tabindex="-1"></a>    <span class="at">mode        =</span> <span class="st">"replace"</span>)</span>
<span id="cb43-724"><a href="#cb43-724" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-725"><a href="#cb43-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-726"><a href="#cb43-726" aria-hidden="true" tabindex="-1"></a><span class="co"># ingest ichthyo upstream tables (skip modified ones)</span></span>
<span id="cb43-727"><a href="#cb43-727" aria-hidden="true" tabindex="-1"></a>ichthyo_upstream <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(ichthyo_manifest<span class="sc">$</span>tables, modified_tables)</span>
<span id="cb43-728"><a href="#cb43-728" aria-hidden="true" tabindex="-1"></a>ichthyo_wdl <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(ichthyo_upstream, <span class="cf">function</span>(tbl) {</span>
<span id="cb43-729"><a href="#cb43-729" aria-hidden="true" tabindex="-1"></a>  pqt <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_pq_ichthyo, <span class="fu">paste0</span>(tbl, <span class="st">".parquet"</span>))</span>
<span id="cb43-730"><a href="#cb43-730" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(pqt)) {</span>
<span id="cb43-731"><a href="#cb43-731" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ingest_pqt</span>(pqt, tbl, <span class="fu">glue</span>(<span class="st">"parquet/swfsc.noaa.gov_calcofi-db/{tbl}.parquet"</span>))</span>
<span id="cb43-732"><a href="#cb43-732" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-733"><a href="#cb43-733" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb43-734"><a href="#cb43-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-735"><a href="#cb43-735" aria-hidden="true" tabindex="-1"></a><span class="co"># ingest bottle upstream tables (skip modified + grid)</span></span>
<span id="cb43-736"><a href="#cb43-736" aria-hidden="true" tabindex="-1"></a>bottle_upstream <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(</span>
<span id="cb43-737"><a href="#cb43-737" aria-hidden="true" tabindex="-1"></a>  bottle_manifest<span class="sc">$</span>tables, <span class="fu">c</span>(modified_tables, <span class="st">"grid"</span>))</span>
<span id="cb43-738"><a href="#cb43-738" aria-hidden="true" tabindex="-1"></a>bottle_wdl <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(bottle_upstream, <span class="cf">function</span>(tbl) {</span>
<span id="cb43-739"><a href="#cb43-739" aria-hidden="true" tabindex="-1"></a>  pqt <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_pq_bottle, <span class="fu">paste0</span>(tbl, <span class="st">".parquet"</span>))</span>
<span id="cb43-740"><a href="#cb43-740" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(pqt)) {</span>
<span id="cb43-741"><a href="#cb43-741" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ingest_pqt</span>(pqt, tbl, <span class="fu">glue</span>(<span class="st">"parquet/calcofi.org_bottle-database/{tbl}.parquet"</span>))</span>
<span id="cb43-742"><a href="#cb43-742" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-743"><a href="#cb43-743" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb43-744"><a href="#cb43-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-745"><a href="#cb43-745" aria-hidden="true" tabindex="-1"></a><span class="co"># ingest modified tables from merge output</span></span>
<span id="cb43-746"><a href="#cb43-746" aria-hidden="true" tabindex="-1"></a>merge_wdl <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(modified_tables, <span class="cf">function</span>(tbl) {</span>
<span id="cb43-747"><a href="#cb43-747" aria-hidden="true" tabindex="-1"></a>  pqt <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir_pq_merged, <span class="fu">paste0</span>(tbl, <span class="st">".parquet"</span>))</span>
<span id="cb43-748"><a href="#cb43-748" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(pqt)) {</span>
<span id="cb43-749"><a href="#cb43-749" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ingest_pqt</span>(pqt, tbl, <span class="fu">glue</span>(<span class="st">"parquet/merge_ichthyo_bottle/{tbl}.parquet"</span>))</span>
<span id="cb43-750"><a href="#cb43-750" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-751"><a href="#cb43-751" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb43-752"><a href="#cb43-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-753"><a href="#cb43-753" aria-hidden="true" tabindex="-1"></a><span class="co"># combine stats</span></span>
<span id="cb43-754"><a href="#cb43-754" aria-hidden="true" tabindex="-1"></a>wdl_stats <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb43-755"><a href="#cb43-755" aria-hidden="true" tabindex="-1"></a>  ichthyo_wdl <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"ichthyo_upstream"</span>),</span>
<span id="cb43-756"><a href="#cb43-756" aria-hidden="true" tabindex="-1"></a>  bottle_wdl  <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"bottle_upstream"</span>),</span>
<span id="cb43-757"><a href="#cb43-757" aria-hidden="true" tabindex="-1"></a>  merge_wdl   <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">source =</span> <span class="st">"merge_modified"</span>))</span>
<span id="cb43-758"><a href="#cb43-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-759"><a href="#cb43-759" aria-hidden="true" tabindex="-1"></a>wdl_stats <span class="sc">|&gt;</span> <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Working DuckLake ingestion stats"</span>)</span>
<span id="cb43-760"><a href="#cb43-760" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-761"><a href="#cb43-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-762"><a href="#cb43-762" aria-hidden="true" tabindex="-1"></a><span class="fu">## List Working Tables</span></span>
<span id="cb43-763"><a href="#cb43-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-766"><a href="#cb43-766" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-767"><a href="#cb43-767" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: list_working</span></span>
<span id="cb43-768"><a href="#cb43-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-769"><a href="#cb43-769" aria-hidden="true" tabindex="-1"></a>working_tables <span class="ot">&lt;-</span> <span class="fu">list_working_tables</span>(con_wdl)</span>
<span id="cb43-770"><a href="#cb43-770" aria-hidden="true" tabindex="-1"></a>working_tables <span class="sc">|&gt;</span></span>
<span id="cb43-771"><a href="#cb43-771" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="st">"Working DuckLake tables with provenance"</span>)</span>
<span id="cb43-772"><a href="#cb43-772" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-773"><a href="#cb43-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-774"><a href="#cb43-774" aria-hidden="true" tabindex="-1"></a><span class="fu">## Save Working DuckLake</span></span>
<span id="cb43-775"><a href="#cb43-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-778"><a href="#cb43-778" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-779"><a href="#cb43-779" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: save_working</span></span>
<span id="cb43-780"><a href="#cb43-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-781"><a href="#cb43-781" aria-hidden="true" tabindex="-1"></a><span class="fu">save_working_ducklake</span>(con_wdl)</span>
<span id="cb43-782"><a href="#cb43-782" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Working DuckLake saved to GCS"</span>)</span>
<span id="cb43-783"><a href="#cb43-783" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-784"><a href="#cb43-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-785"><a href="#cb43-785" aria-hidden="true" tabindex="-1"></a><span class="fu">## Create Frozen Release</span></span>
<span id="cb43-786"><a href="#cb43-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-787"><a href="#cb43-787" aria-hidden="true" tabindex="-1"></a>Create a frozen (immutable) release for public access. Strips provenance</span>
<span id="cb43-788"><a href="#cb43-788" aria-hidden="true" tabindex="-1"></a>columns and exports clean parquet files. See</span>
<span id="cb43-789"><a href="#cb43-789" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Frozen DuckLake</span><span class="co">](https://ducklake.select/2025/10/24/frozen-ducklake/)</span></span>
<span id="cb43-790"><a href="#cb43-790" aria-hidden="true" tabindex="-1"></a>pattern.</span>
<span id="cb43-791"><a href="#cb43-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-794"><a href="#cb43-794" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-795"><a href="#cb43-795" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: freeze_release</span></span>
<span id="cb43-796"><a href="#cb43-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-797"><a href="#cb43-797" aria-hidden="true" tabindex="-1"></a>dir_frozen <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="fu">glue</span>(<span class="st">"data/releases/{release_version}"</span>))</span>
<span id="cb43-798"><a href="#cb43-798" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Creating frozen release: {release_version}"</span>))</span>
<span id="cb43-799"><a href="#cb43-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-800"><a href="#cb43-800" aria-hidden="true" tabindex="-1"></a><span class="co"># get tables to freeze (exclude internal tables)</span></span>
<span id="cb43-801"><a href="#cb43-801" aria-hidden="true" tabindex="-1"></a>tables_to_freeze <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbListTables</span>(con_wdl) <span class="sc">|&gt;</span></span>
<span id="cb43-802"><a href="#cb43-802" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setdiff</span>(<span class="fu">c</span>(<span class="st">"_meta"</span>))</span>
<span id="cb43-803"><a href="#cb43-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-804"><a href="#cb43-804" aria-hidden="true" tabindex="-1"></a><span class="co"># create frozen parquet (strips provenance)</span></span>
<span id="cb43-805"><a href="#cb43-805" aria-hidden="true" tabindex="-1"></a>freeze_stats <span class="ot">&lt;-</span> <span class="fu">write_parquet_outputs</span>(</span>
<span id="cb43-806"><a href="#cb43-806" aria-hidden="true" tabindex="-1"></a>  <span class="at">con              =</span> con_wdl,</span>
<span id="cb43-807"><a href="#cb43-807" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_dir       =</span> <span class="fu">file.path</span>(dir_frozen, <span class="st">"parquet"</span>),</span>
<span id="cb43-808"><a href="#cb43-808" aria-hidden="true" tabindex="-1"></a>  <span class="at">tables           =</span> tables_to_freeze,</span>
<span id="cb43-809"><a href="#cb43-809" aria-hidden="true" tabindex="-1"></a>  <span class="at">strip_provenance =</span> <span class="cn">TRUE</span>,</span>
<span id="cb43-810"><a href="#cb43-810" aria-hidden="true" tabindex="-1"></a>  <span class="at">compression      =</span> <span class="st">"zstd"</span>)</span>
<span id="cb43-811"><a href="#cb43-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-812"><a href="#cb43-812" aria-hidden="true" tabindex="-1"></a>freeze_stats <span class="sc">|&gt;</span></span>
<span id="cb43-813"><a href="#cb43-813" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">caption =</span> <span class="fu">glue</span>(<span class="st">"Frozen release {release_version} statistics"</span>))</span>
<span id="cb43-814"><a href="#cb43-814" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-815"><a href="#cb43-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-816"><a href="#cb43-816" aria-hidden="true" tabindex="-1"></a><span class="fu">### Release Notes</span></span>
<span id="cb43-817"><a href="#cb43-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-820"><a href="#cb43-820" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-821"><a href="#cb43-821" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: release_notes</span></span>
<span id="cb43-822"><a href="#cb43-822" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: asis</span></span>
<span id="cb43-823"><a href="#cb43-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-824"><a href="#cb43-824" aria-hidden="true" tabindex="-1"></a><span class="co"># build release notes using paste() to avoid glue() parsing issues with code blocks</span></span>
<span id="cb43-825"><a href="#cb43-825" aria-hidden="true" tabindex="-1"></a>tables_list <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb43-826"><a href="#cb43-826" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- "</span>, freeze_stats<span class="sc">$</span>table, <span class="st">" ("</span>,</span>
<span id="cb43-827"><a href="#cb43-827" aria-hidden="true" tabindex="-1"></a>  <span class="fu">format</span>(freeze_stats<span class="sc">$</span>rows, <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">" rows)"</span>)</span>
<span id="cb43-828"><a href="#cb43-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-829"><a href="#cb43-829" aria-hidden="true" tabindex="-1"></a>release_notes <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb43-830"><a href="#cb43-830" aria-hidden="true" tabindex="-1"></a>  <span class="st">"# CalCOFI Database Release "</span>, release_version, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb43-831"><a href="#cb43-831" aria-hidden="true" tabindex="-1"></a>  <span class="st">"**Release Date**: "</span>, <span class="fu">Sys.Date</span>(), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb43-832"><a href="#cb43-832" aria-hidden="true" tabindex="-1"></a>  <span class="st">"## Tables Included</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb43-833"><a href="#cb43-833" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(tables_list, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb43-834"><a href="#cb43-834" aria-hidden="true" tabindex="-1"></a>  <span class="st">"## Total</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb43-835"><a href="#cb43-835" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- **Tables**: "</span>, <span class="fu">nrow</span>(freeze_stats), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb43-836"><a href="#cb43-836" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- **Total Rows**: "</span>, <span class="fu">format</span>(<span class="fu">sum</span>(freeze_stats<span class="sc">$</span>rows), <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb43-837"><a href="#cb43-837" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- **Total Size**: "</span>, <span class="fu">round</span>(<span class="fu">sum</span>(freeze_stats<span class="sc">$</span>file_size) <span class="sc">/</span> <span class="dv">1024</span> <span class="sc">/</span> <span class="dv">1024</span>, <span class="dv">1</span>), <span class="st">" MB</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb43-838"><a href="#cb43-838" aria-hidden="true" tabindex="-1"></a>  <span class="st">"## Data Sources</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb43-839"><a href="#cb43-839" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- `ingest_swfsc.noaa.gov_calcofi-db.qmd` - Ichthyo tables (cruise, ship, site, tow, net, species, ichthyo, grid, segment, lookup)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb43-840"><a href="#cb43-840" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- `ingest_calcofi.org_bottle-database.qmd` - Bottle/cast tables (casts, bottle, bottle_measurement, cast_condition, measurement_type)</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb43-841"><a href="#cb43-841" aria-hidden="true" tabindex="-1"></a>  <span class="st">"## Cross-Dataset Integration</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb43-842"><a href="#cb43-842" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- **Ship matching**: Reconciled ship codes between bottle casts and swfsc ship reference</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb43-843"><a href="#cb43-843" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- **Cruise bridge**: Derived cruise_key (YYMMKK) for bottle casts via ship_key + datetime</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb43-844"><a href="#cb43-844" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- **Taxonomy**: Standardized species with WoRMS AphiaID, ITIS TSN, GBIF backbone key</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb43-845"><a href="#cb43-845" aria-hidden="true" tabindex="-1"></a>  <span class="st">"- **Taxon hierarchy**: Built taxon + taxa_rank tables from WoRMS/ITIS classification</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb43-846"><a href="#cb43-846" aria-hidden="true" tabindex="-1"></a>  <span class="st">"## Access</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb43-847"><a href="#cb43-847" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Parquet files can be queried directly from GCS:</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb43-848"><a href="#cb43-848" aria-hidden="true" tabindex="-1"></a>  <span class="st">"```r</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb43-849"><a href="#cb43-849" aria-hidden="true" tabindex="-1"></a>  <span class="st">"library(duckdb)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb43-850"><a href="#cb43-850" aria-hidden="true" tabindex="-1"></a>  <span class="st">"con &lt;- dbConnect(duckdb())</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb43-851"><a href="#cb43-851" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dbExecute(con, 'INSTALL httpfs; LOAD httpfs;')</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb43-852"><a href="#cb43-852" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dbGetQuery(con, </span><span class="sc">\"\n</span><span class="st">"</span>,</span>
<span id="cb43-853"><a href="#cb43-853" aria-hidden="true" tabindex="-1"></a>  <span class="st">"  SELECT * FROM read_parquet(</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb43-854"><a href="#cb43-854" aria-hidden="true" tabindex="-1"></a>  <span class="st">"    'https://storage.googleapis.com/calcofi-db/ducklake/releases/"</span>, release_version, <span class="st">"/parquet/ichthyo.parquet')</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb43-855"><a href="#cb43-855" aria-hidden="true" tabindex="-1"></a>  <span class="st">"  LIMIT 10</span><span class="sc">\"</span><span class="st">)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb43-856"><a href="#cb43-856" aria-hidden="true" tabindex="-1"></a>  <span class="st">"```</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb43-857"><a href="#cb43-857" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Or use calcofi4r:</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb43-858"><a href="#cb43-858" aria-hidden="true" tabindex="-1"></a>  <span class="st">"```r</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb43-859"><a href="#cb43-859" aria-hidden="true" tabindex="-1"></a>  <span class="st">"library(calcofi4r)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb43-860"><a href="#cb43-860" aria-hidden="true" tabindex="-1"></a>  <span class="st">"con &lt;- cc_get_db(version = '"</span>, release_version, <span class="st">"')</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb43-861"><a href="#cb43-861" aria-hidden="true" tabindex="-1"></a>  <span class="st">"```</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb43-862"><a href="#cb43-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-863"><a href="#cb43-863" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(release_notes, <span class="fu">file.path</span>(dir_frozen, <span class="st">"RELEASE_NOTES.md"</span>))</span>
<span id="cb43-864"><a href="#cb43-864" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Release notes written to {file.path(dir_frozen, 'RELEASE_NOTES.md')}"</span>))</span>
<span id="cb43-865"><a href="#cb43-865" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(release_notes)</span>
<span id="cb43-866"><a href="#cb43-866" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-867"><a href="#cb43-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-868"><a href="#cb43-868" aria-hidden="true" tabindex="-1"></a><span class="fu">### Upload Frozen Release to GCS</span></span>
<span id="cb43-869"><a href="#cb43-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-872"><a href="#cb43-872" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-873"><a href="#cb43-873" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: upload_frozen</span></span>
<span id="cb43-874"><a href="#cb43-874" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb43-875"><a href="#cb43-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-876"><a href="#cb43-876" aria-hidden="true" tabindex="-1"></a><span class="co"># upload frozen release to GCS (creates catalog.json, updates versions.json and latest.txt)</span></span>
<span id="cb43-877"><a href="#cb43-877" aria-hidden="true" tabindex="-1"></a><span class="fu">upload_frozen_release</span>(</span>
<span id="cb43-878"><a href="#cb43-878" aria-hidden="true" tabindex="-1"></a>  <span class="at">release_dir =</span> dir_frozen,</span>
<span id="cb43-879"><a href="#cb43-879" aria-hidden="true" tabindex="-1"></a>  <span class="at">version     =</span> release_version,</span>
<span id="cb43-880"><a href="#cb43-880" aria-hidden="true" tabindex="-1"></a>  <span class="at">set_latest  =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-881"><a href="#cb43-881" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-882"><a href="#cb43-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-883"><a href="#cb43-883" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cleanup</span></span>
<span id="cb43-884"><a href="#cb43-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-887"><a href="#cb43-887" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb43-888"><a href="#cb43-888" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cleanup</span></span>
<span id="cb43-889"><a href="#cb43-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-890"><a href="#cb43-890" aria-hidden="true" tabindex="-1"></a><span class="co"># close working ducklake connection</span></span>
<span id="cb43-891"><a href="#cb43-891" aria-hidden="true" tabindex="-1"></a><span class="fu">close_duckdb</span>(con_wdl)</span>
<span id="cb43-892"><a href="#cb43-892" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Working DuckLake connection closed"</span>)</span>
<span id="cb43-893"><a href="#cb43-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-894"><a href="#cb43-894" aria-hidden="true" tabindex="-1"></a><span class="co"># close local merge database</span></span>
<span id="cb43-895"><a href="#cb43-895" aria-hidden="true" tabindex="-1"></a><span class="fu">close_duckdb</span>(con)</span>
<span id="cb43-896"><a href="#cb43-896" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Local merge database connection closed"</span>)</span>
<span id="cb43-897"><a href="#cb43-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-898"><a href="#cb43-898" aria-hidden="true" tabindex="-1"></a><span class="co"># summary</span></span>
<span id="cb43-899"><a href="#cb43-899" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== Summary ==="</span>))</span>
<span id="cb43-900"><a href="#cb43-900" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Working DuckLake: saved to GCS"</span>))</span>
<span id="cb43-901"><a href="#cb43-901" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Frozen release: {release_version} created at {dir_frozen}"</span>))</span>
<span id="cb43-902"><a href="#cb43-902" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Tables: {nrow(freeze_stats)}"</span>))</span>
<span id="cb43-903"><a href="#cb43-903" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"Total rows: {format(sum(freeze_stats$rows), big.mark = ',')}"</span>))</span>
<span id="cb43-904"><a href="#cb43-904" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-905"><a href="#cb43-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-906"><a href="#cb43-906" aria-hidden="true" tabindex="-1"></a>::: {.callout-caution collapse="true"}</span>
<span id="cb43-907"><a href="#cb43-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-908"><a href="#cb43-908" aria-hidden="true" tabindex="-1"></a><span class="fu">## Session Info</span></span>
<span id="cb43-909"><a href="#cb43-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-910"><a href="#cb43-910" aria-hidden="true" tabindex="-1"></a><span class="in">```{r session_info}</span></span>
<span id="cb43-911"><a href="#cb43-911" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">session_info</span>()</span>
<span id="cb43-912"><a href="#cb43-912" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb43-913"><a href="#cb43-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-914"><a href="#cb43-914" aria-hidden="true" tabindex="-1"></a>:::</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>