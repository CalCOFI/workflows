---
title: "Publish Larvae to OBIS"
editor_options: 
  chunk_output_type: console
---

## Goals

- Create a DarwinCore Archive (DwC-A) for CalCOFI ichthyoplankton (fish eggs and larvae) data to publish to OBIS.
- Use the existing CalCOFI database schema and connection.
- Ensure compliance with DarwinCore standards, including event hierarchy and extensions.

### References

DarwinCore:

- [The OBIS Manual](https://manual.obis.org/)
  - [7.2 ExtendedMeasurementOrFact Extension (eMoF) | The OBIS Manual](https://manual.obis.org/data_format.html#extendedmeasurementorfact-extension-emof)
  ![](https://manual.obis.org/images/EventCoreSchema.png)
  - [20.2 IPT: Integrated Publishing Toolkit | The OBIS Manual](https://manual.obis.org/ipt)
- [Darwin Core Quick Reference Guide](https://dwc.tdwg.org/terms/)
- [Guide for publishing biological survey and monitoring data to GBIF](https://docs.gbif.org/guide-publishing-survey-data/en/)
- [Survey and Monitoring Data Quick-Start Guide: A how-to for updating a Darwin Core dataset using the Humboldt Extension](https://docs.gbif.org/survey-monitoring-quick-start/en/)
- [Best Practices in Publishing Sampling-event data - planned additions and notes for revision :: GBIF IPT User Manual](https://ipt.gbif.org/manual/en/ipt/latest/best-practices-sampling-event-planned-additions)

CalCOFI:

- [CalCOFI.org: Fish Eggs & Larvae ](https://calcofi.org/data/marine-ecosystem-data/fish-eggs-larvae/)
  - [ERDDAP: CoastWatch - Search 'CalCOFI'](https://coastwatch.pfeg.noaa.gov/erddap/search/index.html?page=1&itemsPerPage=1000&searchFor=CalCOFI)
    - [CalCOFI info](https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html)
  - [EDI: CALCOFI fish larvae at 66 standard stations, 1966 - ongoing](https://portal.edirepository.org/nis/mapbrowse?scope=edi&identifier=109&revision=4)

```{r}
#| label: setup

librarian::shelf(
  CalCOFI / calcofi4db,
  DBI,
  dm,
  dplyr,
  DT,
  EML,
  glue,
  here,
  lubridate,
  purrr,
  readr,
  tibble,
  tidyr,
  uuid,
  quiet = T
)
options(readr.show_col_types = F)

# Dataset metadata
dataset_title <- "CalCOFI Fish Larvae Tows"
dataset_abstract <- "Fish larvae counts and standardized counts for eggs captured in CalCOFI icthyoplankton nets (primarily vertical [Calvet or Pairovet], oblique [bongo or ring nets], and surface tows [Manta nets]). Surface tows are normally standardized to count per 1,000 m^3 strained. Oblique tows are normally standardized to count per 10 m^2 of surface sampled."
dataset_keywords <- c(
  "atmosphere",
  "biology",
  "biosphere",
  "calcofi",
  "earth science",
  "environment",
  "latitude",
  "longitude",
  "ocean",
  "time"
) # GCMD Science Keywords (source: https://catalog.data.gov/dataset/calcofi-larvae-counts-positive-tows)
# dataset_uuid <- UUIDgenerate() # Or use existing dataset UUID
country_code <- "US"
water_body <- "California Current" # LME: http://marineregions.org/mrgid/8549
dataset_id <- glue(
  "calcofi.io_workflow_larvae_to_obis_{format(Sys.Date(), '%Y-%m-%d')}"
)
sampling_methods_description <- "Standard CalCOFI ichthyoplankton tows. The standard oblique tow uses a bongo net (71 cm diameter, 0.505 mm mesh) or 1-m ring net (prior to 1978) retrieved at a constant wire angle (45 degrees) from 210 m depth to surface. Surface tows use a Manta net; vertical tows use CalVET/Pairovet nets. Flowmeters measure volume filtered. Samples are preserved in 5% formalin. In the lab, fish eggs and larvae are sorted, identified to lowest taxon possible, enumerated, and measured."
study_extent_description <- "The study covers the California Current ecosystem, primarily off Southern California (standard lines 77-93) but historically extending from the border of Canada to the tip of Baja California. The time series for this dataset generally begins in 1951 and continues to the present, with quarterly cruises."
sampling_description <- "Samples are collected at fixed stations along the CalCOFI grid. Oblique tows are standardized to counts per 10 m^2 of sea surface. Surface tows are standardized to counts per 1,000 m^3. Data includes raw counts (tallies) and standardized abundances."
funding_information <- "CalCOFI is a partnership between the NOAA National Marine Fisheries Service (NMFS), Scripps Institution of Oceanography (SIO), and California Department of Fish and Wildlife (CDFW)."

dir_out <- here("data/darwincore/larvae")

# get database connection
schema <- "dev"
con <- get_db_con(schema)
```

## Show Database Tables

```{r}
#| label: fig-dm_tbls
#| fig-cap: "Entity relationship diagram (ERD) of the CalCOFI database. Created using the data models `dm` R package function [`dm_draw()`](https://krlmlr.github.io/dm/reference/dm_draw.html)."

# exclude experimental tables
tbls <- dbListTables(con) |>
  sort() |>
  setdiff(
    c("schema_version", "grid", "site_seg", "bottle", "cast")
  )

# learn relations from database and draw
dm <- dm_from_con(con, schema = schema, table_names = tbls, learn_keys = T)
dm_draw(dm, view_type = "all")
```

```{mermaid}
%%| label: fig-calcofi_erd
%%| fig-cap: "Entity relationship diagram (ERD) of the CalCOFI database. Created from image above and prompt to [Claude](https://claude.ai/): 'Generate an ERD mermaid diagram from the image.'"
%%| file: diagrams/calcofi_erd.mmd
```

## Evaluate Merging Egg and Larva Stage Tables

### Egg Stages

```{r}
#| label: egg_stage.stage

tbl(con, "egg_stage") |>
  group_by(stage) |>
  summarize(n = n()) |>
  collect() |>
  arrange(stage)

#    stage       n
#    <int> <int64>
#  1     1     346
#  2     2    1684
#  3     3    1703
#  4     4    1279
#  5     5    1685
#  6     6    2693
#  7     7    1995
#  8     8    1644
#  9     9    2247
# 10    10    2156
# 11    11    1746
# 12    12     727
# 13    13      41
# 14    14       6
# 15    15      16
# TODO: ask Ed Weber what stages 12 through 15 mean?
```

[ERDDAP - Information about CalCOFI NOAA Fish Egg Stages, from NOAA SWFSC](https://coastwatch.pfeg.noaa.gov/erddap/info/erdCalCOFIeggstg/index.html#:~:text=NC_GLOBAL-,summary,-String):

  > Egg morphological developmental stage for eggs of selected species captured in CalCOFI icthyoplankton nets. Sequential developmental stages are described by Moser and Ahlstrom (1985; see the info url references section). -- 

https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html:

  > - Moser, H. G. and E. H. Ahlstrom. 1985. Staging anchovy eggs. An egg production method for estimating spawning biomass of pelagic fish: implication to the northern anchovy (Engraulis mordax). P. 37-41 in R. Lasker, ed. U.S. Dep. Commer. Tech. Rep. NMFS 36.  ([PDF](https://repository.library.noaa.gov/view/noaa/5695/noaa_5695_DS1.pdf))

#### Stage I

Cell division has not yet begun. In intact eggs the cytoplasm of the
single cell appears as a clear hemisphere at one pole, easily dif-
ferentiated from the yolk mass which is divided into granules. The
cytoplasm may be displaced to other locations around the periphery
of the yolk mass, but there is usually some accumulation at one pole,
which allows the stage to be identified.

#### Stage II

This begins with the division of the single cell into two cells or
blastomeres. The division is first noticeable when a furrow develops
in the middle of the cytoplasmic cap. Small bubble-like structures
(probably artifacts) are often visible along the furrow and help iden-
tify it. The next cleavage plane is at right angles to the first, and
subsequent synchronous divisions in both meridional and latitudinal
planes produce a hemispherical mound of cells, termed the blasto-
disc. After the 5th or 6th division, the blastodisc has a berry-like
appearance, the so-called "mulberry stage," and with subsequent
divisions the blastomeres become increasingly smaller and more
difficult to distinguish individually. During a certain phase of the
early divisions the blastomeres are about the same size as the yolk
granules. Ifthe blastodisc and yolk mass become disrupted during
collection or preservation, the blastomeres may become distributed
among the yolk granules. They may be distinguished from one
another since they have different refractive indices and the
blastomeres appear darker when viewed with transmitted light.

#### Stage III

Ahlstrom (1943) defined this stage in sardine eggs as beginning with
the appearance of the segmentation cavity. The segmentation cavity
of teleost eggs is the space formed between the blastodisc and the
yolk mass during late cleavage. In most anchovy eggs in our collec-
tions the blastodisc is shrunken and somewhat cup-shaped and con-
sequently the segmentation cavity, which is a delicate structure, is
obliterated. We have found it preferable to define the beginning of
Stage ill on the basis of the appearance of the blastoderm, i.e., when
it has the appearance of tissue rather than of a collection of individual
cells. This stage marks the beginning of gastrulation. The margin
of the blastodisc becomes slightly thickened and is termed the germ
ring. At one region of the germ ring the thickening extends inward
to form the embryonic shield, which defines the future axis of the
embryo. Gastrulation proceeds by further proliferation and downward
movement of cells in the region of the germ ring by a process known
as epiboly. Simultaneously, proliferation and inward migration (em-
boly) of cells from the margin of the embryonic shield produce the
organ-forming cell layers of the primordial embryo. At the end of
Stage III the germ ring is one-third down the yolk mass and the
bilateral nature of the primordial embryo is apparent.

#### Stage IV

At the beginning of this stage the germ ring has enclosed one-third
of the yolk mass and the embryo is beginning to form along the
median region of the embryonic shield. At the end of this stage,
defined by the germ ring enveloping two-thirds of the yolk, the head
region of the embryo is becoming apparent.

#### Stage V

This stage begins with the germ ring two-thirds down the yolk and
ends with the closure of the blastopore and the complete enclosure
of the yolk by the cellular sheath of the embryo. The stage is charac-
terized by rapid differentiation resulting in the formation of several
somites in the midregion of the embryonic axis, development of the
notochord which can be seen from a dorsal viewpoint, and differ-
entiation of the optic vesicles from the brain.

#### Stage VI

This stage begins with the closure of the blastopore and ends when
the tail starts to separate from the yolk mass. The embryonic sheath
of cells is extremely thin and, in some samples, it may be difficult
to determine the point of blastopore closure. In these cases the event
can be estimated from the position of the caudal terminus of the
embryonic axis, since it grows toward the pole with the edge of the
cellular sheath. Initially the caudal region lies flat against the polar
region of the yolk, then gradually thickens and becomes more round-
ed at the tip until it is clearly separate from the yolk. During this
stage the somites are apparent along the entire body axis (except
at the caudal portion), the lens primordium appears in the eye, and
the regions of the brain begin to differentiate.

#### Stage VII

At the beginning of this stage the tip of the tail free from the yolk
is broadly rounded, then begins to narrow as it elongates. The noto-
chord extends almost to the tip and the finfold is just becoming visi-
ble. At the end of this stage the length of the free tail is one-half
the length of the head. For this purpose, head length is considered
the distance from the tip of the snout to the back of the cerebellum
(see Fig. 2H). Relative tail length is the criterion for each remain-
ing stage.

#### Stage VIII

This stage begins when the free tail length is l:,reater than one-half
the head length and ends when tail length equals head length. The
tail becomes pointed during this stage and begins to bend away from
the axis of the body, to the right or left side. The curvature of the
tail generally increases with development, but is subject to individual
variability (Fig. 2). Judgement is required in compensating for curva-
ture in estimating relative tail length; however, accuracy and preci-
sion increase rapidly with practice.

#### Stage IX

This stage begins with the tail extending one-quarter the length of
the yolk sac and ends when it reaches one-half the yolk sac length.
The gut is now apparent along the ventral surface of the tail, and
its terminal section passes through the fin fold which is now con-
siderably wider than in the previous stage. The pectoral fin buds
appear as lateral thickenings as do the otic vesicles.

#### Stage X

This stage starts when the tail is one-half the length of the yolk sac
and ends when it reaches three-quarters of the yolk sac length.

#### Stage XI

This is the final stage before hatching and is defined by a tail length
greater than three-quarters of the length of the yolk sac.

### Larva Stages

```{r}
#| label: larva_stage.stage

tbl(con, "larva_stage") |>
  group_by(stage) |>
  summarize(n = n()) |>
  collect()
# 1 FLEX    18882
# 2 POST    22446
# 3 PREF    56913
# 4 YOLK     5384
# 5 TRNS     1754
```

- [ERDDAP - Information about CalCOFI NOAA Fish Larvae Stages, from NOAA SWFSC](https://coastwatch.pfeg.noaa.gov/erddap/info/erdCalCOFIlrvstg/index.html#:~:text=NC_GLOBAL-,summary,-String):

  > Developmental stages (yolk sac, preflexion, flexion, postflexion, or transformation) of selected fish larvae captured in CalCOFI icthyoplankton nets.

### dwc:lifeStage

- [dwc:lifeStage (n_concepts: 39) Darwin Core List of Terms - Darwin Core](https://dwc.tdwg.org/list/#dwc_lifeStage)

- [LifeStage | GBIF Registry Vocabulary](https://registry.gbif.org/vocabulary/LifeStage) (n_concepts: 39)
  > A vocabulary to capture the broad stages that an organism passes through during its life cycle. This vocabulary was assembled based on the observed terms commonly used by the open data community, including those from citizen scientists.

  - [**Egg**](https://registry.gbif.org/vocabulary/LifeStage/concept/Egg) (n_children: 0)
    > The egg is the organic vessel containing the zygote in which an embryo develops until it can survive on its own, at which point the animal hatches

  - [**Larva**](https://registry.gbif.org/vocabulary/LifeStage/concept/Larva) (n_children: 11)
    > A larva is a distinct juvenile form many animals undergo before metamorphosis into adults. Larvae often have different body structures from the adult form, and may also have different habitats and feeding behaviors.

### other dataset: ICES Eggs and larvae | OBIS

- [ICES Eggs and larvae | OBIS](https://obis.org/dataset/66fe7e4b-ddcc-44aa-8378-c7c7482c2844)
- [Eggs and larvae | ICES](https://www.ices.dk/data/data-portals/Pages/Eggs-and-larvae.aspx)

- [Vocabularies/ LifeStage / concepts | GBIF Registry](https://registry.gbif.org/vocabulary/LifeStage/concepts)
- [BODC parameter semantic model biological entity development stage terms | NERC Vocabulary Server](https://vocab.nerc.ac.uk/collection/S11/current/)

- [Frequently Asked Questions About Ichthyoplankton | NOAA Fisheries](https://www.fisheries.noaa.gov/west-coast/science-data/frequently-asked-questions-about-ichthyoplankton)

- [Zooplankton taxonomy-related abundance per unit volume of the water column | NVS](https://vocab.nerc.ac.uk/collection/P02/current/ZATX/)

- [14 Controlled vocabulary for eMoF | The OBIS Manual](https://manual.obis.org/vocabulary.html)
  - [MoF viewer](https://mof.obis.org/)

- [P01 concept: Abundance of Fish (WoRMS 11676) [Stage: egg] per unit volume of the water body by optical microscopy | NVS](https://vocab.nerc.ac.uk/collection/P01/current/Z830M00T/)
  - [Pisces (11676; unaccepted Superclass) | WoRMS](https://www.marinespecies.org/aphia.php?p=taxdetails&id=11676)

![VThe P01 wheel, demonstrating how P01 elements are represented by other NVS collections | Vocabulary - OBIS Manual](https://manual.obis.org/images/P01_wheel.png)

### Lifestage	S11 - BODC Parameter Semantic Model Life Cycle Stages

https://github.com/nvs-vocszxrabs/S11

A controlled vocabulary for terms used in the BODC parameter semantic model to specify the development stage (life cycle stage) of a biological entity

Terms and mappings available from: http://vocab.nerc.ac.uk/collection/S11/current/

Search interface: https://www.bodc.ac.uk/resources/vocabularies/vocabulary_search/S11/

#### Request for new terms and ways to contribute

- Request for new S11 terms can be made using this [form](https://docs.google.com/forms/d/e/1FAIpQLSe-ZTKJZmNT5FmyPRFsPsNt2hpB_gb6MAmm7Zp-7GSMpn5NFA/viewform?usp=pp_url&entry.1396013310=S11)

Reporting errors or suggestions for improving content can be submitted as [regular issues](https://github.com/nvs-vocabs/S11/issues/new) in this repository or emailed to vocab.services-at-bodc.ac.uk.

## Prompt Claude to merge egg and larva tables

PROMPT (plan mode): Help me figure out a strategy for sensibly merging egg, egg_stage, larva, larva_stage into a DarwinCore archive that accounts for total count (ie `tally`), stage (combining egg and larva `stage`), and size (`length_mm`) by `net_uuid`. Also incorporate recommended vocabularies, per:
- https://manual.obis.org/vocabulary.html
- https://ipt.gbif.org/manual/en/ipt/latest/best-practices-sampling-event-data

Claude‚Äôs Plan: Strategy for Merging Egg/Larva Data into DarwinCore Archive

### Current State Analysis

Your existing implementation creates **separate occurrence records** for each stage:

- `egg` ‚Üí lifeStage: "egg"
- `egg_stage` ‚Üí lifeStage: "egg_1", "egg_2", etc.
- `larva` ‚Üí lifeStage: "larva"
- `larva_stage` ‚Üí lifeStage: "larva_FLEX", "larva_POST", etc.
- `larva_size` ‚Üí lifeStage: "larva" (size in remarks)

This creates 5 separate occurrence records for a single species in one net sample.

### Recommended Strategy: Consolidated Occurrence with eMoF Extension

Following OBIS/GBIF best practices, I recommend **consolidating to fewer occurrences** and using the **ExtendedMeasurementOrFact (eMoF)** extension for detailed measurements:

**Approach: Two occurrences per species per net_uuid**

- **One "egg" occurrence** (if eggs present)
- **One "larva" occurrence** (if larvae present)

**Implementation Details:**

**1. Occurrence Extension:**

- `occurrenceID`: UUID per life stage (egg or larva)
- `eventID: Links to net_uuid
- `lifeStage: Use S11 vocabulary terms:
  - `"egg" ‚Üí http://vocab.nerc.ac.uk/collection/S11/current/S1110/
  - "larva" ‚Üí http://vocab.nerc.ac.uk/collection/S11/current/S1133/
- `organismQuantity`: **TOTAL count** (sum across all stages/sizes)
- `organismQuantityType`: "individuals"

**2. MeasurementOrFact Extension for Stage Details:**

- `occurrenceID`: Links to parent occurrence
- `measurementType`: "life stage abundance"
- `measurementTypeID`: P01 code for abundance by life stage
- `measurementValue`: tally for specific stage
- `measurementValueID`: S11 code for specific stage (e.g., "FLEX", "POST", "egg stage 5")
- `measurementUnit`: "individuals"
- `measurementUnitID`: P06 code

**3. MeasurementOrFact Extension for Size:**

- `occurrenceID`: Links to larva occurrence
- `measurementType`: "body length"
- `measurementTypeID`: P01 code for body length (search P01 for appropriate term)
- `measurementValue`: length_mm value
- `measurementUnit`: "millimeters"
- `measurementUnitID`: http://vocab.nerc.ac.uk/collection/P06/current/UXMM/
- `measurementRemarks`: Include tally if multiple individuals at same length

**Key Changes Required:**

1. **Aggregate totals** by net_uuid + species_id + major life stage (egg vs larva)
1. **Map stage vocabularies** to S11 terms (needs vocabulary mapping table)
1. **Expand eMoF records** for each stage detail instead of separate occurrences
1. **Add vocabulary URIs** for measurementTypeID, measurementValueID, measurementUnitID
1. **Update meta.xml** to properly define eMoF extension relationships

**Benefits:**

- ‚úì Follows OBIS/GBIF best practices
- ‚úì Uses standardized vocabularies (S11, P01, P06)
- ‚úì Reduces occurrence record count by ~5x
- ‚úì Preserves all granular stage and size information
- ‚úì Better separates taxonomy (occurrence) from measurements (eMoF)
- ‚úì Makes data more queryable and comparable across datasets

**Questions to Resolve:**

1. Should we create separate occurrences for egg vs larva, or merge into one occurrence per species?

Answer: Yes, keep separate occurrences for egg and larva.

2. How should we map egg stages (1-15) and larva stages (YOLK, PREF, FLEX, POST, TRNS) to S11 vocabulary?
Map egg stages to S11 terms for egg development stages (if available) or create custom mappings. Map larva stages to corresponding S11 terms.

Answer: Use S11 terms as prefix, ie "egg" or "larva", and custom suffixes:

- Egg stages: "egg, stage 1 of 11 (Moser & Ahlstrom, 1985)", "egg, stage 2 of 11 (Moser & Ahlstrom, 1985)", ..., "egg, stage 12 of 12 (Moser & Ahlstrom, 1985)", ..., "egg, stage 15 of 12 (Moser & Ahlstrom, 1985)" (admittedly stages 12 to 15 are unclear and will need revision later)

- Larva stages: "larva, yolk sac"; "larva, preflexion", "larva, flexion"; "larva, postflexion"; or "larva, transformation"

3. For larva_size records with the same length_mm but different tallies - should we sum them or keep separate eMoF records?

Always use the `larva.tally` and `egg.tally` as the overall count for the occurrence record. For `larva_size`, create separate eMoF records for each unique length_mm with its corresponding tally.

4. Also help debug GBIF IPT response from loading the existing dataset package as zip generated by @publish_larvae_to_obis.qmd as a "Sampling event" in DarwinCore: "Skipped mapped term http://rs.tdwg.org/dwc/terms/eventID, which is unknown to extension http://rs.tdwg.org/dwc/terms/MeasurementOrFact". I thought that eventID was required in both core and extension, but given the [Example: Brackish water invertebrates survey -- Best Practices in Publishing Sampling-event data :: GBIF IPT User Manual](https://ipt.gbif.org/manual/en/ipt/latest/best-practices-sampling-event-data#brackish-water-invertebrates-survey) perhaps it should be called "EventID" instead of "eventID"?

Comprehensive Strategy for DarwinCore Archive Implementation

### Part 1: Fix Current GBIF IPT Error

Problem Identified: The `meta.xml:54-55` incorrectly defines eventID as BOTH:

- `<coreid index="0" />` (line 54) - the linking column
- `<field index="0" term="...eventID"/>` (line 55) - a data field

**Solution**: Remove line 55 from meta.xml. The coreid column should NOT be duplicated as a field definition. The corrected MeasurementOrFact extension should be:

```xml
<extension ... rowType="http://rs.tdwg.org/dwc/terms/MeasurementOrFact">
  <coreid index="0" />
  <!-- Remove: <field index="0" term="...eventID"/> -->
  <field index="1" term="http://rs.tdwg.org/dwc/terms/measurementType"/>
  <field index="2" term="http://rs.tdwg.org/dwc/terms/measurementValue"/>
  ...
  <field index="7" term="http://rs.tdwg.org/dwc/terms/occurrenceID"/>
</extension>
```
Note: eventID (column 0) remains as coreid; occurrenceID (column 7) stays as a regular field for biological measurements.

### Part 2: Revised Data Structure for Egg/Larva Merging

Based on your specifications:

**Occurrence Extension Structure**

**One occurrence per major life stage per species per net_uuid:**

1. **Egg occurrence** (if eggs present):

- `occurrenceID`: UUID
- `eventID`: net_uuid
- `scientificName`: species name
- `lifeStage`: "egg" (with S11 URI)
- `organismQuantity`: **egg.tally** (total across all stages)
- `organismQuantityType`: "individuals"

2. **Larva occurrence** (if larvae present):

- `occurrenceID`: UUID
- `eventID`: net_uuid
- `scientificName`: species name
- `lifeStage`: "larva" (with S11 URI)
- `organismQuantity`: larva.tally (total across all stages)
- `organismQuantityType`: "individuals"

**MeasurementOrFact Extension Structure**

**Three types of measurements:**

**1. Environmental measurements** (link to eventID):

- `eventID`: net_uuid
- `occurrenceID`: NA
- Measurements: std_haul_factor, vol_sampled_m3, prop_sorted, smallplankton, totalplankton

**2. Stage-specific counts** (link to occurrenceID):

- `eventID`: NA
- `occurrenceID`: links to egg or larva occurrence
- `measurementType`: "abundance by life stage"
- `measurementTypeID`: P01 code (TBD - search P01 for appropriate term)
- `measurementValue`: tally for specific stage
- `measurementValueID`: Custom life stage term (see vocabulary mapping below)
- `measurementUnit`: "individuals"
- `measurementUnitID`: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/


**3. Size measurements**2 (link to occurrenceID):

- `eventID`: NA
- `occurrenceID`: links to larva occurrence
- `measurementType`: "body length"
- `measurementTypeID`: P01 code for body length
- `measurementValue`: length_mm
- `measurementUnit`: "millimeters"
- `measurementUnitID`: http://vocab.nerc.ac.uk/collection/P06/current/UXMM/
- `measurementRemarks`: Include tally value

### Part 3: Life Stage Vocabulary Mapping

Per your specifications, use S11 URI prefix with custom suffixes:

**Egg Stages (from egg_stage table)**:

- Stage 1: "egg, stage 1 of 11 (Moser & Ahlstrom, 1985)"
- Stage 2: "egg, stage 2 of 11 (Moser & Ahlstrom, 1985)"
...
- Stage 11: "egg, stage 11 of 11 (Moser & Ahlstrom, 1985)"
- Stage 12: "egg, stage 12 of 11 (Moser & Ahlstrom, 1985)" [needs revision]
- Stage 13: "egg, stage 13 of 11 (Moser & Ahlstrom, 1985)" [needs revision]
- Stage 14: "egg, stage 14 of 11 (Moser & Ahlstrom, 1985)" [needs revision]
- Stage 15: "egg, stage 15 of 11 (Moser & Ahlstrom, 1985)" [needs revision]

**S11 base URI**: http://vocab.nerc.ac.uk/collection/S11/current/S1110/ (egg)

**Larva Stages (from larva_stage table)**:

- YOLK: "larva, yolk sac"
- PREF: "larva, preflexion"
- FLEX: "larva, flexion"
- POST: "larva, postflexion"
- TRNS: "larva, transformation"

**S11 base URI**: http://vocab.nerc.ac.uk/collection/S11/current/S1133/ (larva)

### Part 4: Data Aggregation Logic

SQL aggregation strategy:

1. **Create egg occurrences**:

```sql
SELECT 
  net_uuid,
  species_id,
  SUM(tally) as total_tally  -- sum from egg table
FROM egg
GROUP BY net_uuid, species_id
```

2. **Create larva occurrences**:

```sql
SELECT 
  net_uuid,
  species_id,
  SUM(tally) as total_tally  -- sum from larva table
FROM larva
GROUP BY net_uuid, species_id
```

3. **Create stage-specific eMoF records**:

- Join egg_stage ‚Üí egg occurrence
- Join larva_stage ‚Üí larva occurrence
- Each stage row becomes one eMoF measurement

4. **Create size eMoF records**:

- Join larva_size ‚Üí larva occurrence
- Each unique length_mm becomes one eMoF measurement
- Include tally in measurementRemarks

### Part 5: Required Vocabulary URIs

To add to the implementation:

1. lifeStage URIs:

- Egg: http://vocab.nerc.ac.uk/collection/S11/current/S1110/
- Larva: http://vocab.nerc.ac.uk/collection/S11/current/S1133/

2. **measurementTypeID** (P01 codes to research):

- Abundance by life stage: [search P01 collection]
- Body length: [search P01 collection for fish larvae length]

3. **measurementUnitID**:

- Individuals: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/
- Millimeters: http://vocab.nerc.ac.uk/collection/P06/current/UXMM/
- Dimensionless: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/
- Cubic meters: http://vocab.nerc.ac.uk/collection/P06/current/MCUB/
- Grams: http://vocab.nerc.ac.uk/collection/P06/current/UGRM/
- Proportion: http://vocab.nerc.ac.uk/collection/P06/current/UPCT/ (or dimensionless)

### Part 6: Implementation Changes in publish_larvae_to_obis.qmd

Key modifications needed:

1. **Aggregate occurrence data** from 5 tables ‚Üí 2 types (egg, larva)
1. **Update lifeStage field** to use only "egg" or "larva" (not stage-specific)
1. **Expand eMoF records** to include stage-specific counts
1. **Add vocabulary URI fields**: lifeStageID, measurementTypeID, measurementValueID, measurementUnitID
1. **Fix meta.xml** by removing duplicate eventID field definition
1. **Create stage vocabulary lookup table** for mapping numeric/text stages to descriptive terms

### Expected Outcome

- **Occurrence reduction**: From ~867k occurrence records ‚Üí ~491k occurrence records (combining 5 tables into 2 life stages)

- **eMoF expansion**: From ~19k eMoF records ‚Üí ~395k eMoF records (adding stage and size details) 

### Benefits:

- ‚úì Follows OBIS/GBIF best practices
- ‚úì Fixes GBIF IPT validation error
- ‚úì Uses standardized vocabularies (S11, P01, P06)
- ‚úì Preserves all granular data through eMoF
- ‚úì Cleaner separation of taxonomy and measurements
- ‚úì More queryable and comparable data structure

PROMPT: Instead of using MeasurementOrFact, be sure to explicitly use OBIS ExtendedMeasurementOrFact (eMoF) by for instance renaming output table to extendedMeasurementOrFact.csv and allowing occurrenceID to relate to individual occurrence records. Be sure to process https://manual.obis.org/format_emof.html and think hard before proceeding with plan and edits. Incorporate `vol_sampled_m3` as `sampleSizeValue` with `sampleSizeUnit` = "m^3". Research good options to incorporate **proportion sorted** `prop_sorted` and if possible **standard haul factor** (`std_haul_factor`).

https://web.archive.org/web/20250417074825if_/https://calcofi.org/downloads/publications/atlases/CalCOFI_Atlas_28.pdf

DISTRIBUTIONAL ATLAS OF FISH LARVAE IN THE CALIFORNIA CURRENT REGION:
NORTHERN ANCHOVY, Engraulis mordax GIRARD,
1966 THROUGH 1979
by Roger Hewitt

> Samples are standardized by adjusting to a standard unit of sea surface area. The standard unit is 10 m^2^ and the adjustment (**standard haul factor**) is calculated as the ratio of a standard volume of water filtered per unit depth and the total volume of water filtered over the total depth. Thus:

$$
SHF = ((10 m^3) / m) / (v/d) = 10 d
$$

> where $v$ is the volume of water filtered, determined by flowmeter, and $d$ is the depth fished, determined by the amount of wire out times the cosine of the average angle of stray from the vertical.
> 
> Sample counts were adjusted for fractioning (minimum aliquot was 25%) and standardized to each other. The charts are thus in units of the number of larvae under 10 m^2^ of sea surface.

[ 
`occurrence.csv: organismQuantity | organismQuantityType: "individuals"`
]

Comprehensive Strategy for DarwinCore Archive with OBIS ExtendedMeasurementOrFact

### Part 1: Fix GBIF IPT Error & Use Proper eMoF Format

Critical Changes:

1. **Rename file**: measurementorfact.csv ‚Üí extendedMeasurementOrFact.csv
2. **Update rowType URI** in meta.xml from:

```
rowType="http://rs.tdwg.org/dwc/terms/MeasurementOrFact"
```

to:

```
rowType="http://rs.gbif.org/terms/1.0/ExtendedMeasurementOrFact"
```

or the OBIS schema URI:

```
rowType="https://rs.gbif.org/extension/obis/extended_measurement_or_fact.xml"
```

3. **Remove duplicate eventID field definition** from meta.xml:

- Keep: `<coreid index="0" />` (links extension to core)
- Remove: `<field index="0" term="...eventID"/>` (duplicates the coreid)

4. **Retain occurrenceID field** (index 7) to enable biological measurement linking

### Part 2: Move Volume Sampled to Event Core

**Change: vol_sampled_m3 from eMoF ‚Üí Event core** 

Add to event.csv and event section of meta.xml:

- `sampleSizeValue`: value from net.vol_sampled_m3
- `sampleSizeUnit`: "m^3" (or "cubic meters")

**Rationale**: Volume sampled is a fundamental sample attribute, not a measurement derived from the sample. OBIS best practices support placing this in the Event core.

### Part 3: Restructured Occurrence Records

**Create TWO occurrences per species per net_uuid**:

**Egg Occurrence (when eggs present)**:

```
occurrenceID: UUID
eventID: net_uuid
scientificName: species name from species table
scientificNameID: urn:lsid:marinespecies.org:taxname:{worms_id}
kingdom: Animalia
lifeStage: "egg"
lifeStageID: http://vocab.nerc.ac.uk/collection/S11/current/S1110/
organismQuantity: egg.tally (TOTAL across all stages)
organismQuantityType: "individuals"
occurrenceStatus: "present"
basisOfRecord: "HumanObservation"
```

**Larva Occurrence (when larvae present)**:

```
occurrenceID: UUID
eventID: net_uuid
scientificName: species name from species table
scientificNameID: urn:lsid:marinespecies.org:taxname:{worms_id}
kingdom: Animalia
lifeStage: "larva"
lifeStageID: http://vocab.nerc.ac.uk/collection/S11/current/S1133/
organismQuantity: larva.tally (TOTAL across all stages)
organismQuantityType: "individuals"
occurrenceStatus: "present"
basisOfRecord: "HumanObservation"
```

**Key change**: Use aggregated totals from egg/larva tables, not stage-specific tables.

### Part 4: ExtendedMeasurementOrFact Structure

**Three measurement categories**:

1. **Sample-Level Measurements** (link to eventID)

A. **Proportion Sorted**:

```
eventID: net_uuid
occurrenceID: [blank/NA]
measurementID: UUID
measurementType: "proportion of sample sorted"
measurementTypeID: [P01 code - TBD, search for "subsample fraction" or "sorting proportion"]
measurementValue: net.prop_sorted (e.g., "1" or "0.5")
measurementUnit: "dimensionless" or "proportion"
measurementUnitID: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/
measurementRemarks: "Fraction of total sample examined"
```

B. **Standard Haul Factor**:

```
eventID: net_uuid
occurrenceID: [blank/NA]
measurementID: UUID
measurementType: "standardized haul factor"
measurementTypeID: [P01 code - TBD, search for "catch standardization" or "sampling effort coefficient"]
measurementValue: net.std_haul_factor (e.g., "3.14")
measurementUnit: "dimensionless"
measurementUnitID: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/
measurementMethod: "https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"
measurementRemarks: "Standardization factor accounting for water filtered; abundances expressed as per 10 m¬≤ (Smith 1977)"
```

C. **Plankton Biomass**:

```
eventID: net_uuid
occurrenceID: [blank/NA]
measurementID: UUID
measurementType: "small plankton biomass" / "total plankton biomass"
measurementTypeID: [P01 code for biomass]
measurementValue: net.smallplankton / net.totalplankton
measurementUnit: "grams"
measurementUnitID: http://vocab.nerc.ac.uk/collection/P06/current/UGRM/
```

2. **Stage-Specific Abundance** (link to occurrenceID)

**Egg stages**:

```
eventID: [blank/NA]
occurrenceID: egg occurrence UUID
measurementID: UUID
measurementType: "abundance by life stage"
measurementTypeID: [P01 code - search for "abundance" + "development stage"]
measurementValue: egg_stage.tally
measurementValueID: [custom vocabulary URI - see below]
measurementUnit: "individuals"
measurementUnitID: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/
measurementRemarks: "egg, stage {N} of 11 (Moser & Ahlstrom, 1985)"
```

**Larva stages**:

```
eventID: [blank/NA]
occurrenceID: larva occurrence UUID
measurementID: UUID
measurementType: "abundance by life stage"
measurementTypeID: [P01 code]
measurementValue: larva_stage.tally
measurementValueID: [custom vocabulary URI]
measurementUnit: "individuals"
measurementUnitID: http://vocab.nerc.ac.uk/collection/P06/current/UUUU/
measurementRemarks: Life stage mapping (see Part 5)
```

3. **Body Length Measurements** (link to occurrenceID)

```
eventID: [blank/NA]
occurrenceID: larva occurrence UUID
measurementID: UUID
measurementType: "body length"
measurementTypeID: [P01 code for fish larvae length - e.g., OBSINDLX or similar]
measurementValue: larva_size.length_mm
measurementUnit: "millimeters"
measurementUnitID: http://vocab.nerc.ac.uk/collection/P06/current/UXMM/
measurementMethod: "https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html"
measurementRemarks: "Count: {larva_size.tally}; Total length measurement"
```

### Part 5: Life Stage Vocabulary Mapping

Custom terms based on S11 vocabulary:

**Egg Stages (egg_stage.stage values 1-15)**:

- Stage 1: "egg, stage 1 of 11 (Moser & Ahlstrom, 1985)"
- Stage 2: "egg, stage 2 of 11 (Moser & Ahlstrom, 1985)"
- ...
- Stage 11: "egg, stage 11 of 11 (Moser & Ahlstrom, 1985)"
- Stage 12-15: "egg, stage {N} of 11 (Moser & Ahlstrom, 1985)" [pending revision]

Base vocabulary: S11/S1110 (egg)

**Larva Stages** (larva_stage.stage values):

stage |	measurementRemarks | Custom term
------|--------------------|------------
YOLK	| larva, yolk sac	| Yolk-sac larva
PREF	| larva, preflexion	| Preflexion larva
FLEX	| larva, flexion	| Flexion larva
POST	| larva, postflexion	| Postflexion larva
TRNS	| larva, transformation	| Transformation stage larva

**Base vocabulary**: S11/S1133 (larva)

**Implementation**: Create lookup table mapping stage codes to full descriptive terms.

### Part 6: Required P01 Code Research

To complete before implementation, search P01 vocabulary for:

1. Proportion sorted:
  - Search terms: "subsample", "fraction sorted", "aliquot"
  - Alternative: Create custom term if no exact match
1. Standard haul factor:
  - Search terms: "standardization", "catch per unit effort", "sampling effort coefficient"
  - Possibly related to CPUE codes
1. Abundance by life stage:
  - Search terms: "abundance", "count", "life stage", "development stage"
  - May need fish-specific or zooplankton codes
1. Body length:
  - Search terms: "body length", "total length", "fish larvae", "Actinopterygii"
  - Example code: OBSINDLX (commonly used for fish length)

**P01 Search Tool**: https://vocab.seadatanet.org/p01-facet-search

### Part 7: Implementation Changes in publish_larvae_to_obis.qmd

Major code modifications:

1. Event Core: Add sampleSizeValue and sampleSizeUnit columns
1. Occurrence Extension:
  - Aggregate by (net_uuid, species_id, major life stage)
  - Reduce from 5 source tables to 2 occurrence types
  - Add lifeStageID field
1. eMoF Extension:
  - Rename file to extendedMeasurementOrFact.csv
  - Remove vol_sampled_m3 (moved to Event)
  - Add prop_sorted and std_haul_factor as event-level measurements
  - Expand to include stage-specific abundances (egg_stage, larva_stage)
  - Include all larva_size measurements
  - Add all vocabulary ID fields: measurementTypeID, measurementValueID, measurementUnitID
1. meta.xml:
  - Update eMoF rowType URI
  - Remove duplicate eventID field definition
  - Add sampleSizeValue/Unit to Event core mapping
  - Add vocabulary ID fields to eMoF mapping

### Part 8: Expected Data Structure Changes

Current structure:

- Occurrences: ~867k records (5 types per species/net)
- eMoF: ~19k records (mostly environmental)

New structure:

- Occurrences: ~491k records (2 types per species/net)
- eMoF: ~395k records (environmental + stage counts + sizes)

**Benefits**:

- ‚úì OBIS-compliant eMoF format 
- ‚úì Fixes GBIF IPT validation error
- ‚úì Uses standardized vocabularies (S11, P01, P06) 
- ‚úì Preserves all data granularity
- ‚úì Clearer semantic separation (taxonomy vs. measurements)
- ‚úì More queryable for biological analyses ‚úì Follows best practices for sampling-event datasets

Perfect! I've completed all the implementation tasks for merging the egg and larva data into a proper OBIS-compliant DarwinCore archive. Here's a summary of all the changes made:

### Summary of Changes to publish_larvae_to_obis.qmd

‚úÖ Completed Implementation

1. **Event Core Updates** _(lines 1082-1085)_

- Changed `sampleSizeUnit` from "cubic meters" to "m^3" per OBIS standards
- `vol_sampled_m3` now populates `sampleSizeValue` in Event core (removed from eMoF)

2. **Life Stage Vocabulary Lookup Tables** _(lines 948-1001 - NEW SECTION)_

- Created egg_stage_vocab: Maps stages 1-15 to descriptive terms following Moser & Ahlstrom (1985)
- Created larva_stage_vocab: Maps YOLK, PREF, FLEX, POST, TRNS to descriptive terms
- Created measurement_unit_vocab: Maps units to P06 vocabulary URIs

3. **Consolidated Occurrence Records** _(lines 1129-1188)_

- **BEFORE**: 5 separate occurrence types (egg, egg_stage, larva, larva_stage, larva_size)
- **AFTER**: 2 occurrence types per species per net (egg, larva)
- Added `lifeStageID` field with S11 vocabulary URIs:
  - Egg: http://vocab.nerc.ac.uk/collection/S11/current/S1110/
  - Larva: http://vocab.nerc.ac.uk/collection/S11/current/S1133/
- Uses total counts from `egg.tally` and `larva.tally` for `organismQuantity`

4. **Completely Rewritten ExtendedMeasurementOrFact Extension** _(lines 1245-1371)_

Created three measurement categories: 

**A. Sample-level measurements** (linked to eventID):

- std_haul_factor: Standardization factor
- prop_sorted: Proportion of sample examined
- smallplankton & totalplankton: Biomass measurements
- Includes measurementTypeID and measurementUnitID fields (with TODOs for P01 codes)

**B. Stage-specific abundance** (linked to occurrenceID):

- Egg stage abundances from egg_stage table
- Larva stage abundances from larva_stage table
- Uses descriptive stage terms in measurementRemarks
- Includes measurementValueID for vocabulary references

**C. Body length measurements** (linked to occurrenceID):

- From larva_size table
- Includes tally count in measurementRemarks

**5. File Naming Updates**

- Output file renamed: measurementorfact.csv ‚Üí extendedMeasurementOrFact.csv (line 1384)
- Updated zip file creation (line 1702)
- Updated data quality checks (line 1677)

**6. Meta.xml Generation Updates** _(lines 1393-1545)_

- Updated rowType URI to: http://rs.gbif.org/terms/1.0/ExtendedMeasurementOrFact _(line 1437)_
- Added vocabulary ID field mappings:
  - measurementTypeID, measurementValueID, measurementUnitID
  - lifeStageID
- **Fixed GBIF IPT error**: Modified create_field_elements() to skip coreid column (prevents duplicate eventID field definition)
- Updated all filename references from measurementorfact to extendedMeasurementOrFact

**üìä Expected Outcome**

**Current structure** (before):

- Occurrences: ~867k records (5 types per species/net)
- eMoF: ~19k records (mostly environmental)

**New structure** (after):

- Occurrences: ~491k records (2 types per species/net) - **~43% reduction**
- eMoF: ~395k records (environmental + stage counts + sizes) - **~20x increase**

**‚ú® Benefits**

- ‚úÖ OBIS-compliant ExtendedMeasurementOrFact format
- ‚úÖ Fixes GBIF IPT validation error ("eventID unknown to extension")
- ‚úÖ Uses standardized vocabularies (S11, P06)
- ‚úÖ P01 codes ready to be added (TODOs marked in code)
- ‚úÖ Preserves all granular data (stages, sizes) through eMoF
- ‚úÖ Cleaner semantic separation (taxonomy vs. measurements)
- ‚úÖ More queryable and comparable data structure
- ‚úÖ Follows best practices for sampling-event datasets


**üìù Remaining TODOs in Code**

The following P01 vocabulary codes need to be researched and added:

1. Standard haul factor
1. Proportion sorted / subsample fraction
1. Zooplankton biomass
1. Abundance by life stage / development stage
1. Fish larvae body length

**P01 Search Tool**: https://vocab.seadatanet.org/p01-facet-search 

All changes are complete and ready for testing! The code should now generate a fully OBIS-compliant DarwinCore archive with proper ExtendedMeasurementOrFact extension.

## Prompt Claude to Generate DarwinCore

PROMPT: Using the ERD above, create a Quarto document with chunks of R code and tidyverse style use of the database connection object `con` to generate a DarwinCore package using the `species.worms_id` (aka WoRMS AphiaID) to populate the species identifiers. Combine biological observation where possible, otherwise compose as seperate datasets, given the different biological observations: egg, eggstage, larva, larvasize, larvastage. Generate DarwinCore with as much of the extended information (i.e.,  `event`, `occurrence`, and `measurementOrFact` ) as possible.
Compose Ecological Metadata Language (EML) metadata for the DarwinCore package, including the `dataset` and `creator` elements. Include prompts where more
information is needed.

```{r}
#| label: stop_eval
# knitr::opts_chunk$set(eval = F)
```

## Data Extraction from Database

First, let's extract all necessary tables from the database:

```{r}
#| label: extract-tables

# Get simple lazy table references
tbl_ship <- tbl(con, "ship")
tbl_cruise <- tbl(con, "cruise")
tbl_site <- tbl(con, "site")
tbl_tow <- tbl(con, "tow")
tbl_tow_type <- tbl(con, "tow_type")
tbl_net <- tbl(con, "net")
tbl_species <- tbl(con, "species")
# biological observation tables
tbl_egg <- tbl(con, "egg")
tbl_egg_stage <- tbl(con, "egg_stage")
tbl_larva <- tbl(con, "larva")
tbl_larva_stage <- tbl(con, "larva_stage")
tbl_larva_size <- tbl(con, "larva_size")
```

## Create Life Stage Vocabulary Lookup Tables

Define mappings for egg and larva developmental stages to descriptive terms:

```{r}
#| label: vocabulary-lookups

# Egg stage vocabulary mapping (Moser & Ahlstrom, 1985)
egg_stage_vocab <- tibble(
  stage = 1:15,
  stage_description = c(
    "egg, stage 1 of 11 (Moser & Ahlstrom, 1985)",
    "egg, stage 2 of 11 (Moser & Ahlstrom, 1985)",
    "egg, stage 3 of 11 (Moser & Ahlstrom, 1985)",
    "egg, stage 4 of 11 (Moser & Ahlstrom, 1985)",
    "egg, stage 5 of 11 (Moser & Ahlstrom, 1985)",
    "egg, stage 6 of 11 (Moser & Ahlstrom, 1985)",
    "egg, stage 7 of 11 (Moser & Ahlstrom, 1985)",
    "egg, stage 8 of 11 (Moser & Ahlstrom, 1985)",
    "egg, stage 9 of 11 (Moser & Ahlstrom, 1985)",
    "egg, stage 10 of 11 (Moser & Ahlstrom, 1985)",
    "egg, stage 11 of 11 (Moser & Ahlstrom, 1985)",
    "egg, stage 12 of 11 (Moser & Ahlstrom, 1985)", # TODO: needs revision
    "egg, stage 13 of 11 (Moser & Ahlstrom, 1985)", # TODO: needs revision
    "egg, stage 14 of 11 (Moser & Ahlstrom, 1985)", # TODO: needs revision
    "egg, stage 15 of 11 (Moser & Ahlstrom, 1985)" # TODO: needs revision
  )
)

# Larva stage vocabulary mapping
larva_stage_vocab <- tibble(
  stage = c("YOLK", "PREF", "FLEX", "POST", "TRNS"),
  stage_description = c(
    "larva, yolk sac",
    "larva, preflexion",
    "larva, flexion",
    "larva, postflexion",
    "larva, transformation"
  )
)

# P06 Measurement Unit vocabulary (NERC)
measurement_unit_vocab <- tibble(
  measurementUnit = c(
    "individuals",
    "millimeters",
    "dimensionless",
    "cubic meters",
    "grams",
    "proportion",
    "m^3"
  ),
  measurementUnitID = c(
    "http://vocab.nerc.ac.uk/collection/P06/current/UUUU/",
    "http://vocab.nerc.ac.uk/collection/P06/current/UXMM/",
    "http://vocab.nerc.ac.uk/collection/P06/current/UUUU/",
    "http://vocab.nerc.ac.uk/collection/P06/current/MCUB/",
    "http://vocab.nerc.ac.uk/collection/P06/current/UGRM/",
    "http://vocab.nerc.ac.uk/collection/P06/current/UUUU/", # or UPCT?
    "http://vocab.nerc.ac.uk/collection/P06/current/MCUB/"
  )
)
```

## Create Event Hierarchy

DarwinCore uses an event-based model. We'll create a hierarchical event structure:

- cruise
  - site
    - tow
      - net

```{mermaid}
%%| label: fig-larvae_event_hierarchy
%%| fig-cap: "Event hierarchy for CalCOFI larvae data in DarwinCore Archive format with Extended Measurement or Fact."
%%| file: diagrams/larvae_event_hierarchy.mmd
```

Per [3.3.2. Simple nested datasets with Project-level information ‚Äì Guide for publishing biological survey and monitoring data to GBIF](https://docs.gbif.org/guide-publishing-survey-data/en/#simple-nested-datasets-with-project-level-information)

```{r}
#| label: build-event-hierarchy

# Build complete event hierarchy
q_events <- tbl_net |>
  left_join(tbl_tow, by = "tow_uuid") |>
  left_join(tbl_tow_type, by = "tow_type_key") |>
  left_join(tbl_site, by = "site_uuid") |>
  left_join(tbl_cruise, by = "cruise_uuid") |>
  left_join(tbl_ship, by = "ship_key")

# Create event core at different levels ----

flds_to_iso8601 <- function(flds, output = "datetime") {
  # helper function to convert date/time fields to ISO 8601 format
  # per https://dwc.tdwg.org/terms/ eventDate: add 2007-03-01T13:00:00Z/2008-05-11T15:30:00Z (some time within the interval beginning 1 March 2007 at 1pm UTC and before 11 May 2008 at 3:30pm UTC)

  stopifnot(length(flds) %in% c(1, 2))
  stopifnot(output %in% c("datetime", "time"))

  if (length(flds) == 1 & output == "datetime") {
    s <- glue::glue(
      "to_char({flds}, 'YYYY-MM-DD\"T\"HH24:MI:SS\"Z\"')"
    )
  }
  if (length(flds) == 2 & output == "datetime") {
    s <- glue::glue(
      "to_char({flds[1]}, 'YYYY-MM-DD\"T\"HH24:MI:SS\"Z\"') || '/' || 
         to_char({flds[2]}, 'YYYY-MM-DD\"T\"HH24:MI:SS\"Z\"')"
    )
  }

  if (length(flds) == 1 & output == "time") {
    s <- glue::glue(
      "to_char({flds}, 'HH24:MI:SS\"Z\"')"
    )
  }
  if (length(flds) == 2 & output == "time") {
    s <- glue::glue(
      "to_char({flds[1]}, 'HH24:MI:SS\"Z\"') || '/' || 
       to_char({flds[2]}, 'HH24:MI:SS\"Z\"')"
    )
  }

  as.character(s)
}

# * Cruise level events ----

# get min/max datetimes for cruises
q_cruise_event_date <- q_events |>
  group_by(cruise_uuid) |>
  summarize(
    dtime_min = min(time_start, na.rm = T),
    dtime_max = max(time_start, na.rm = T),
    .groups = "drop"
  ) |>
  mutate(
    eventDate = sql(flds_to_iso8601(c("dtime_min", "dtime_max")))
  ) |>
  select(cruise_uuid, eventDate)

q_cruise_events <- q_events |>
  distinct(cruise_uuid, ship_name, ship_nodc, date_ym) |>
  mutate(
    eventID = cruise_uuid,
    # parentEventID  = NA, # no parent for cruise level; NA generated with union_all
    eventRemarks = paste("Cruise on", ship_name),
    samplingProtocol = "Marine plankton survey cruise",
    sampleSizeValue = NA_real_,
    sampleSizeUnit = NA_character_,
    habitat = "marine",
    eventType = "cruise"
  ) |>
  left_join(
    q_cruise_event_date,
    by = "cruise_uuid"
  ) |>
  select(
    eventID, # parentEventID,
    eventType,
    eventDate,
    samplingProtocol,
    eventRemarks,
    habitat
  )

# Site level events
q_site_events <- q_events |>
  distinct(
    site_uuid,
    cruise_uuid,
    longitude,
    latitude,
    line,
    station,
    orderocc
  ) |>
  mutate(
    eventID = site_uuid,
    parentEventID = cruise_uuid,
    decimalLatitude = latitude,
    decimalLongitude = longitude,
    eventRemarks = paste("CalCOFI station", station, "on line", line),
    # per https://proj.org/en/stable/operations/projections/calcofi.html
    locationID = paste0(line, "_", station),
    eventType = "site",
    samplingProtocol = "Marine plankton survey station"
  ) |>
  select(
    eventID,
    parentEventID,
    eventType,
    samplingProtocol,
    eventRemarks,
    decimalLatitude,
    decimalLongitude,
    locationID
  )

# Tow level events
q_tow_events <- q_events |>
  distinct(
    tow_uuid,
    site_uuid,
    tow_number,
    tow_type_key,
    tow_type_description = description,
    time_start
  ) |>
  mutate(
    eventID = tow_uuid,
    parentEventID = site_uuid,
    eventDate = sql(flds_to_iso8601("time_start")),
    eventRemarks = paste("Tow", tow_number, "-", tow_type_description),
    eventType = "tow",
    samplingProtocol = paste(tow_type_key, ":", tow_type_description)
  ) |>
  select(
    eventID,
    parentEventID,
    eventType,
    eventDate,
    samplingProtocol,
    eventRemarks
  )

# Net level events (sampling events)
q_net_events_allflds <- q_events |>
  distinct(
    net_uuid,
    tow_uuid,
    side,
    std_haul_factor,
    vol_sampled_m3,
    prop_sorted,
    smallplankton,
    totalplankton
  ) |>
  mutate(
    eventID = net_uuid,
    parentEventID = tow_uuid,
    eventRemarks = paste(
      "Net sample from side",
      side,
      "; only",
      prop_sorted,
      "proportion sorted of",
      vol_sampled_m3,
      "cubic meters sampled"
    ),
    eventType = "net_sample",
    samplingProtocol = paste("Plankton net tow -", side, "side"),
    sampleSizeValue = vol_sampled_m3,
    sampleSizeUnit = "m^3"
  )
q_net_events <- q_net_events_allflds |>
  select(
    eventID,
    parentEventID,
    eventType,
    samplingProtocol,
    eventRemarks,
    sampleSizeValue,
    sampleSizeUnit
  )

# Combine all event levels
db_version <- tbl(con, "schema_version") |> pull(version)
# dataset_id <- paste0(
#   # "https://github.com/CalCOFI/calcofi4db/releases/tag/v",
#   "calcofi_db.",
#   db_version,
#   "_larvae.",
#   format(Sys.Date(), "%Y-%m-%d")
# )
# "calcofi_db.1.1.0_larvae.2025-10-09"

q_event_core <- list(
  q_cruise_events |>
    mutate(
      parentEventID = sql("NULL::uuid"),
      sampleSizeValue = sql("NULL::numeric"),
      sampleSizeUnit = NA_character_
    ),
  q_site_events |>
    mutate(
      sampleSizeValue = sql("NULL::numeric"),
      sampleSizeUnit = NA_character_
    ),
  q_tow_events |>
    mutate(
      sampleSizeValue = sql("NULL::numeric"),
      sampleSizeUnit = NA_character_
    ),
  q_net_events
) |>
  reduce(union_all) |>
  mutate(
    # basisOfRecord                 = "HumanObservation",
    geodeticDatum = "WGS84",
    coordinateUncertaintyInMeters = 1000, # TODO: adjust based on accuracy of GPS/Loran/dead-reckoning over time
    countryCode = country_code, # country_code <- "US"
    waterBody = water_body,
    datasetID = dataset_id
  )
# TODO: datasetID: permalink to this qmd in calcofi4db release?
```

## Create Occurrence Records

Now let's combine all biological observations into occurrence records:

```{r}
#| label: build-occurrences

# Create consolidated egg occurrences (one per species per net)
q_egg_occurrences <- tbl_egg |>
  left_join(tbl_species, by = "species_id") |>
  mutate(
    occurrenceID = sql("gen_random_uuid()"),
    eventID = net_uuid,
    scientificName = scientific_name,
    scientificNameID = paste0("urn:lsid:marinespecies.org:taxname:", worms_id),
    kingdom = "Animalia",
    occurrenceStatus = ifelse(tally > 0, "present", "absent"),
    organismQuantity = tally, # TOTAL count from egg table
    organismQuantityType = "individuals",
    lifeStage = "egg",
    #lifeStage            = "https://vocab.nerc.ac.uk/collection/S11/current/S1122/",
    # lifeStageID          = "http://vocab.nerc.ac.uk/collection/S11/current/S1110/",
    preparations = "egg sample",
    basisOfRecord = "HumanObservation"
  ) |>
  select(
    occurrenceID,
    eventID,
    species_id,
    scientificName,
    scientificNameID,
    kingdom,
    occurrenceStatus,
    organismQuantity,
    organismQuantityType,
    lifeStage, # lifeStageID,
    preparations,
    basisOfRecord
  )

# Create consolidated larva occurrences (one per species per net)
q_larva_occurrences <- tbl_larva |>
  left_join(tbl_species, by = "species_id") |>
  mutate(
    occurrenceID = sql("gen_random_uuid()"),
    eventID = net_uuid,
    scientificName = scientific_name,
    scientificNameID = paste0("urn:lsid:marinespecies.org:taxname:", worms_id),
    kingdom = "Animalia",
    occurrenceStatus = ifelse(tally > 0, "present", "absent"),
    organismQuantity = tally, # TOTAL count from larva table
    organismQuantityType = "individuals",
    lifeStage = "larva",
    # lifeStageID          = "http://vocab.nerc.ac.uk/collection/S11/current/S1133/",
    preparations = "larva sample",
    basisOfRecord = "HumanObservation"
  ) |>
  select(
    occurrenceID,
    eventID,
    species_id,
    scientificName,
    scientificNameID,
    kingdom,
    occurrenceStatus,
    organismQuantity,
    organismQuantityType,
    lifeStage, # lifeStageID,
    preparations,
    basisOfRecord
  )

# Combine egg and larva occurrences
q_occurrence_extension <- list(
  q_egg_occurrences,
  q_larva_occurrences
) |>
  reduce(union_all) |>
  # Add additional required/recommended fields
  mutate(
    # TODO: identifiedBy, dateIdentified,identificationReferences
    # identifiedBy = "[NEED IDENTIFIER NAME]", # Prompt: Add taxonomist name
    # dateIdentified = "[NEED IDENTIFICATION DATE]", # Prompt: Add identification date
    # identificationReferences = "[NEED REFERENCES]", # Prompt: Add identification guides used
    modified = sql("CURRENT_DATE")
  ) |>
  # Remove species_id (internal field used only for joins)
  select(
    occurrenceID,
    eventID,
    scientificName,
    scientificNameID,
    kingdom,
    occurrenceStatus,
    organismQuantity,
    organismQuantityType,
    lifeStage, # lifeStageID,
    preparations,
    basisOfRecord,
    modified
  )
```

## Create ExtendedMeasurementOrFact Extension

Create eMoF records for three types of measurements:

1. Sample-level measurements (linked to eventID)
2. Stage-specific abundance (linked to occurrenceID)
3. Body length measurements (linked to occurrence ID)

```{r}
#| label: build-emof

# 1. Sample-level measurements (eventID, occurrenceID = NA) ----
d_sample_measurements <- q_net_events_allflds |>
  select(
    eventID,
    std_haul_factor,
    prop_sorted,
    smallplankton,
    totalplankton
  ) |> # vol_sampled_m3 moved to Event core
  collect() |>
  pivot_longer(
    cols = c(std_haul_factor, prop_sorted, smallplankton, totalplankton),
    names_to = "meas_type",
    values_to = "measurementValue"
  ) |>
  filter(!is.na(measurementValue)) |>
  mutate(
    measurementID = UUIDgenerate(n = n()),
    occurrenceID = NA_character_,
    measurementType = case_when(
      meas_type == "std_haul_factor" ~ "standardized haul factor",
      meas_type == "prop_sorted" ~ "proportion of sample sorted",
      meas_type == "smallplankton" ~ "small plankton biomass",
      meas_type == "totalplankton" ~ "total plankton biomass"
    ),
    measurementTypeID = case_when(
      meas_type == "std_haul_factor" ~ NA_character_, # TODO: search P01 for standardization factor
      meas_type == "prop_sorted" ~ NA_character_, # TODO: search P01 for subsample fraction
      meas_type == "smallplankton" ~ NA_character_, # TODO: search P01 for zooplankton biomass
      meas_type == "totalplankton" ~ NA_character_
    ), # TODO: search P01 for zooplankton biomass
    measurementUnit = case_when(
      meas_type == "std_haul_factor" ~ "dimensionless",
      meas_type == "prop_sorted" ~ "dimensionless",
      meas_type %in% c("smallplankton", "totalplankton") ~ "grams"
    ),
    measurementMethod = "https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html",
    measurementRemarks = case_when(
      meas_type ==
        "std_haul_factor" ~ "Standardization factor accounting for water filtered; abundances expressed as per 10 m¬≤ (Smith 1977)",
      meas_type == "prop_sorted" ~ "Fraction of total sample examined",
      TRUE ~ NA_character_
    )
  ) |>
  left_join(measurement_unit_vocab, by = "measurementUnit") |>
  select(
    eventID,
    occurrenceID,
    measurementID,
    measurementType,
    measurementTypeID,
    measurementValue,
    measurementUnit,
    measurementUnitID,
    measurementMethod,
    measurementRemarks
  )

# 2. Stage-specific abundance (eventID = NA, occurrenceID) ----

# Egg stage abundances - need to join with egg occurrences to get occurrenceID
d_egg_stage_abundance <- tbl_egg_stage |>
  left_join(
    egg_stage_vocab |>
      copy_to(
        con,
        df = _,
        name = "egg_stage_vocab_tmp",
        temporary = TRUE,
        overwrite = T
      ),
    by = "stage"
  ) |>
  collect() |>
  left_join(
    q_egg_occurrences |>
      collect() |>
      select(net_uuid = eventID, species_id, occurrenceID),
    by = c("net_uuid", "species_id")
  ) |>
  mutate(
    eventID = NA_character_,
    measurementID = UUIDgenerate(n = n()),
    measurementType = "abundance by life stage",
    measurementTypeID = NA_character_, # TODO: search P01 for "abundance" + "development stage"
    measurementValue = tally,
    measurementValueID = NA_character_, # Could reference custom vocabulary for egg stages
    measurementUnit = "individuals",
    measurementMethod = "https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html",
    measurementRemarks = stage_description
  ) |>
  left_join(measurement_unit_vocab, by = "measurementUnit") |>
  select(
    eventID,
    occurrenceID,
    measurementID,
    measurementType,
    measurementTypeID,
    measurementValue,
    measurementValueID,
    #measurementUnit, measurementUnitID = measurementUnitID.y, measurementMethod,
    measurementUnit,
    measurementUnitID,
    measurementMethod,
    measurementRemarks
  )

# Larva stage abundances - need to join with larva occurrences to get occurrenceID
d_larva_stage_abundance <- tbl_larva_stage |>
  left_join(
    larva_stage_vocab |>
      copy_to(
        con,
        df = _,
        name = "larva_stage_vocab_tmp",
        temporary = TRUE,
        overwrite = T
      ),
    by = "stage"
  ) |>
  collect() |>
  left_join(
    q_larva_occurrences |>
      collect() |>
      select(net_uuid = eventID, species_id, occurrenceID),
    by = c("net_uuid", "species_id")
  ) |>
  mutate(
    eventID = NA_character_,
    measurementID = UUIDgenerate(n = n()),
    measurementType = "abundance by life stage",
    measurementTypeID = NA_character_, # TODO: search P01 for "abundance" + "development stage"
    measurementValue = tally,
    measurementValueID = NA_character_, # Could reference custom vocabulary for larva stages
    measurementUnit = "individuals",
    measurementMethod = "https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html",
    measurementRemarks = stage_description
  ) |>
  left_join(measurement_unit_vocab, by = "measurementUnit") |>
  select(
    eventID,
    occurrenceID,
    measurementID,
    measurementType,
    measurementTypeID,
    measurementValue,
    measurementValueID,
    measurementUnit,
    measurementUnitID,
    measurementMethod,
    measurementRemarks
  )

# 3. Body length measurements (eventID = NA, occurrenceID) ----
d_body_length <- tbl_larva_size |>
  collect() |>
  left_join(
    q_larva_occurrences |>
      collect() |>
      select(net_uuid = eventID, species_id, occurrenceID),
    by = c("net_uuid", "species_id")
  ) |>
  filter(!is.na(length_mm)) |>
  mutate(
    eventID = NA_character_,
    measurementID = UUIDgenerate(n = n()),
    measurementType = "body length",
    measurementTypeID = NA_character_, # TODO: search P01 for fish larvae body length (e.g., OBSINDLX)
    measurementValue = length_mm,
    measurementValueID = NA_character_,
    measurementUnit = "millimeters",
    measurementMethod = "https://oceanview.pfeg.noaa.gov/CalCOFI/calcofi_info.html",
    measurementRemarks = paste0("Count: ", tally, "; Total length measurement")
  ) |>
  left_join(measurement_unit_vocab, by = "measurementUnit") |>
  select(
    eventID,
    occurrenceID,
    measurementID,
    measurementType,
    measurementTypeID,
    measurementValue,
    measurementValueID,
    measurementUnit,
    measurementUnitID,
    measurementMethod,
    measurementRemarks
  )

# Combine all eMoF records ----
d_extendedmeasurementorfact_extension <- bind_rows(
  d_sample_measurements,
  d_egg_stage_abundance,
  d_larva_stage_abundance,
  d_body_length
)

# table(is.na(d_extendedmeasurementorfact_extension$occurrenceID))
#   FALSE    TRUE
# 367,218 243,598
#
# table(is.na(d_extendedmeasurementorfact_extension$eventID))
#   FALSE    TRUE
# 243,598 367,218

```

## Write DarwinCore Archive Files

```{r}
#| label: export-dwc

# Create output directory
dir.create(dir_out, showWarnings = F)

# Write core and extension files
write_csv(q_event_core |> collect(), file.path(dir_out, "event.csv"))
write_csv(
  q_occurrence_extension |> collect(),
  file.path(dir_out, "occurrence.csv")
)
write_csv(
  d_extendedmeasurementorfact_extension,
  file.path(dir_out, "extendedMeasurementOrFact.csv")
)
```

## Create meta.xml programmatically by cross-walking CSV fields to DwC terms

```{r}
#| label: create-meta-xml

# Define DarwinCore term mappings for each file type
dwc_terms <- list(
  event = list(
    rowType = "http://rs.tdwg.org/dwc/terms/Event",
    idField = "eventID",
    terms = c(
      eventID = "http://rs.tdwg.org/dwc/terms/eventID",
      parentEventID = "http://rs.tdwg.org/dwc/terms/parentEventID",
      eventType = "http://rs.tdwg.org/dwc/terms/eventType",
      eventDate = "http://rs.tdwg.org/dwc/terms/eventDate",
      eventTime = "http://rs.tdwg.org/dwc/terms/eventTime",
      samplingProtocol = "http://rs.tdwg.org/dwc/terms/samplingProtocol",
      sampleSizeValue = "http://rs.tdwg.org/dwc/terms/sampleSizeValue",
      sampleSizeUnit = "http://rs.tdwg.org/dwc/terms/sampleSizeUnit",
      eventRemarks = "http://rs.tdwg.org/dwc/terms/eventRemarks",
      habitat = "http://rs.tdwg.org/dwc/terms/habitat",
      decimalLatitude = "http://rs.tdwg.org/dwc/terms/decimalLatitude",
      decimalLongitude = "http://rs.tdwg.org/dwc/terms/decimalLongitude",
      geodeticDatum = "http://rs.tdwg.org/dwc/terms/geodeticDatum",
      coordinateUncertaintyInMeters = "http://rs.tdwg.org/dwc/terms/coordinateUncertaintyInMeters",
      locationID = "http://rs.tdwg.org/dwc/terms/locationID",
      countryCode = "http://rs.tdwg.org/dwc/terms/countryCode",
      waterBody = "http://rs.tdwg.org/dwc/terms/waterBody",
      datasetID = "http://rs.tdwg.org/dwc/terms/datasetID"
      # basisOfRecord                 = "http://rs.tdwg.org/dwc/terms/basisOfRecord"
    )
  ),
  occurrence = list(
    rowType = "http://rs.tdwg.org/dwc/terms/Occurrence",
    idField = "occurrenceID",
    coreIdField = "eventID",
    terms = c(
      occurrenceID = "http://rs.tdwg.org/dwc/terms/occurrenceID",
      eventID = "http://rs.tdwg.org/dwc/terms/eventID",
      scientificName = "http://rs.tdwg.org/dwc/terms/scientificName",
      scientificNameID = "http://rs.tdwg.org/dwc/terms/scientificNameID",
      kingdom = "http://rs.tdwg.org/dwc/terms/kingdom",
      occurrenceStatus = "http://rs.tdwg.org/dwc/terms/occurrenceStatus",
      organismQuantity = "http://rs.tdwg.org/dwc/terms/organismQuantity",
      organismQuantityType = "http://rs.tdwg.org/dwc/terms/organismQuantityType",
      lifeStage = "http://rs.tdwg.org/dwc/terms/lifeStage",
      # lifeStageID          = "http://rs.tdwg.org/dwc/terms/lifeStageID",
      preparations = "http://rs.tdwg.org/dwc/terms/preparations",
      basisOfRecord = "http://rs.tdwg.org/dwc/terms/basisOfRecord",
      modified = "http://purl.org/dc/terms/modified"
    )
  ),
  extendedmeasurementorfact = list(
    rowType = "http://rs.iobis.org/obis/terms/ExtendedMeasurementOrFact",
    idField = "measurementID",
    coreIdField = "eventID", # Primary linking field
    terms = c(
      eventID = "http://rs.tdwg.org/dwc/terms/eventID",
      occurrenceID = "http://rs.tdwg.org/dwc/terms/occurrenceID",
      measurementID = "http://rs.tdwg.org/dwc/terms/measurementID",
      measurementType = "http://rs.tdwg.org/dwc/terms/measurementType",
      measurementTypeID = "http://rs.iobis.org/obis/terms/measurementTypeID",
      measurementValue = "http://rs.tdwg.org/dwc/terms/measurementValue",
      measurementValueID = "http://rs.iobis.org/obis/terms/measurementValueID",
      measurementUnit = "http://rs.tdwg.org/dwc/terms/measurementUnit",
      measurementUnitID = "http://rs.iobis.org/obis/terms/measurementUnitID",
      measurementMethod = "http://rs.tdwg.org/dwc/terms/measurementMethod",
      measurementRemarks = "http://rs.tdwg.org/dwc/terms/measurementRemarks"
    )
  )
)

# Function to create field elements for meta.xml
create_field_elements <- function(csv_file, term_map, coreid_field = NULL) {
  # Read column names from CSV
  col_names <- names(read_csv(csv_file, n_max = 0, show_col_types = FALSE))

  # Map columns to DwC terms
  field_elements <- map(seq_along(col_names), function(i) {
    col <- col_names[i]

    # Skip coreid column if specified (it's defined separately in <coreid> element)
    if (!is.null(coreid_field) && col == coreid_field) {
      return(NULL)
    }

    term <- term_map$terms[[col]]

    if (!is.null(term)) {
      glue::glue('    <field index="{i-1}" term="{term}"/>')
    } else {
      # Field exists in CSV but not in DwC mapping - skip or warn
      message(
        "Warning: Column '",
        col,
        "' in ",
        csv_file,
        " has no DwC mapping and will be skipped in meta.xml."
      )
      NULL
    }
  })

  # Remove NULL entries and combine
  field_elements <- compact(field_elements)
  paste(field_elements, collapse = "\n")
}

# Function to determine coreID index
get_coreid_index <- function(csv_file, coreid_field) {
  col_names <- names(read_csv(csv_file, n_max = 0, show_col_types = FALSE))

  # Handle multiple possible coreID fields (eventID or occurrenceID)
  if (length(coreid_field) > 1) {
    # Find which one exists in the CSV
    coreid_field <- intersect(coreid_field, col_names)[1]
  }

  which(col_names == coreid_field) - 1 # 0-indexed
}

# Generate meta.xml content
generate_meta_xml <- function(dir_out) {
  # Core (Event)
  event_file <- file.path(dir_out, "event.csv")
  event_fields <- create_field_elements(event_file, dwc_terms$event)
  event_id_idx <- which(
    names(read_csv(event_file, n_max = 0, show_col_types = FALSE)) ==
      dwc_terms$event$idField
  ) -
    1

  # Extension: Occurrence
  occ_file <- file.path(dir_out, "occurrence.csv")
  occ_fields <- create_field_elements(
    occ_file,
    dwc_terms$occurrence,
    coreid_field = dwc_terms$occurrence$coreIdField
  )
  occ_coreid_idx <- get_coreid_index(occ_file, dwc_terms$occurrence$coreIdField)

  # Extension: ExtendedMeasurementOrFact
  emof_file <- file.path(dir_out, "extendedMeasurementOrFact.csv")
  emof_fields <- create_field_elements(
    emof_file,
    dwc_terms$extendedmeasurementorfact,
    coreid_field = dwc_terms$extendedmeasurementorfact$coreIdField
  )
  emof_coreid_idx <- get_coreid_index(
    emof_file,
    dwc_terms$extendedmeasurementorfact$coreIdField
  )

  # Build complete meta.xml
  meta_xml <- glue::glue(
    '<?xml version="1.0" encoding="UTF-8"?>
<archive xmlns="http://rs.tdwg.org/dwc/text/"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://rs.tdwg.org/dwc/text/ http://rs.tdwg.org/dwc/text/tdwg_dwc_text.xsd">
  <core encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="\\n"
        fieldsEnclosedBy=\'"\' ignoreHeaderLines="1" rowType="{dwc_terms$event$rowType}">
    <files>
      <location>event.csv</location>
    </files>
    <id index="{event_id_idx}" />
{event_fields}
  </core>
  <extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="\\n"
             fieldsEnclosedBy=\'"\' ignoreHeaderLines="1" rowType="{dwc_terms$occurrence$rowType}">
    <files>
      <location>occurrence.csv</location>
    </files>
    <coreid index="{occ_coreid_idx}" />
{occ_fields}
  </extension>
  <extension encoding="UTF-8" fieldsTerminatedBy="," linesTerminatedBy="\\n"
             fieldsEnclosedBy=\'"\' ignoreHeaderLines="1" rowType="{dwc_terms$extendedmeasurementorfact$rowType}">
    <files>
      <location>extendedMeasurementOrFact.csv</location>
    </files>
    <coreid index="{emof_coreid_idx}" />
{emof_fields}
  </extension>
</archive>'
  )

  return(meta_xml)
}

# Generate and write meta.xml
meta_xml <- generate_meta_xml(dir_out)
writeLines(meta_xml, file.path(dir_out, "meta.xml"))

cat("Generated meta.xml with field mappings:\n")
cat(meta_xml)
```

## Create EML Metadata

```{r}
#| label: build-eml

# Geographic coverage
geo_coverage <- tbl_site |>
  summarise(
    westBoundingCoordinate = min(longitude, na.rm = T),
    eastBoundingCoordinate = max(longitude, na.rm = T),
    northBoundingCoordinate = max(latitude, na.rm = T),
    southBoundingCoordinate = min(latitude, na.rm = T)
  ) |>
  collect()

# Temporal coverage
temp_coverage <- tbl_tow |>
  summarise(
    beginDate = min(time_start, na.rm = TRUE),
    endDate = max(time_start, na.rm = TRUE)
  ) |>
  collect() |>
  pivot_longer(
    cols = everything(),
    names_to = "name",
    values_to = "value"
  ) |>
  mutate(
    value = as.Date(value)
  ) |>
  deframe() |>
  as.list()

# Taxonomic coverage

librarian::shelf(duckdb)
db <- "https://file.calcofi.io/data/calcofi.duckdb"
tmp_db <- file.path(tempdir(), "calcofi.duckdb")
con_dk <- dbConnect(duckdb::duckdb(), dbdir = tmp_db, read_only = F)
# attach remote duckdb database
dbSendQuery(con_dk, glue::glue("ATTACH DATABASE '{db}' AS cc;"))
# dbListTables(con)
#  [1] "bottle"         "cast"           "cruise"         "egg"            "egg_stage"      "grid"
#  [7] "larva"          "larva_size"     "larva_stage"    "net"            "schema_version" "ship"
# [13] "site"           "site_seg"       "species"        "taxa_rank"      "taxonomy"       "tow"
# [19] "tow_type"
d_taxa <- dbReadTable(con_dk, Id(schema = "cc", table = "taxonomy"))

taxa_coverage <- tbl_species |>
  filter(!is.na(worms_id)) |>
  distinct(species_id, worms_id, common_name) |>
  collect() |>
  left_join(
    d_taxa |>
      distinct(
        taxonID,
        taxonRank,
        scientificName
      ),
    by = join_by(worms_id == taxonID)
  ) |>
  # De-duplicate in case multiple local species map to same WoRMS ID
  group_by(worms_id, taxonRank, scientificName) |>
  summarize(
    species_id = first(species_id),
    common_name = paste(unique(na.omit(common_name)), collapse = ", "),
    .groups = "drop"
  ) |>
  arrange(species_id) |>
  pmap(function(
    species_id,
    taxonRank,
    scientificName,
    common_name,
    worms_id,
    ...
  ) {
    item <- list(
      id = glue("calcofi_species_{species_id}"),
      taxonRankName = taxonRank,
      taxonRankValue = scientificName,
      taxonId = list(
        provider = "https://www.marinespecies.org",
        as.character(worms_id)
      )
    )

    if (!is.na(common_name) && common_name != "") {
      item$commonName <- common_name
    }

    return(item)
  })

# Create EML document
my_eml <- list(
  packageId = dataset_id,
  system = "calcofi.io",
  dataset = list(
    title = dataset_title,
    creator = list(
      individualName = list(
        givenName = "Ed",
        surName = "Weber"
      ),
      organizationName = "NOAA SWFSC",
      electronicMailAddress = "ed.weber@noaa.gov",
      userId = list(
        directory = "https://orcid.org/",
        userId = "0000-0002-0942-434X"
      )
    ),
    abstract = dataset_abstract,
    keywordSet = list(
      keyword = dataset_keywords,
      keywordThesaurus = "GCMD Science Keywords"
    ),
    coverage = list(
      geographicCoverage = list(
        geographicDescription = "California Current Large Marine Ecoregion",
        boundingCoordinates = geo_coverage
      ),
      temporalCoverage = list(
        rangeOfDates = list(
          beginDate = list(
            calendarDate = as.character(temp_coverage$beginDate)
          ),
          endDate = list(calendarDate = as.character(temp_coverage$endDate))
        )
      ),
      taxonomicCoverage = list(
        generalTaxonomicCoverage = "Marine ichthyoplankton and fish eggs",
        taxonomicClassification = taxa_coverage
      )
    ),
    contact = list(
      individualName = list(
        givenName = "Ed",
        surName = "Weber"
      ),
      electronicMailAddress = "ed.weber@noaa.gov"
    ),
    methods = list(
      methodStep = list(
        description = list(
          para = sampling_methods_description
        )
      ), # TODO: sampling methods
      sampling = list(
        studyExtent = list(
          description = list(
            para = study_extent_description
          )
        ), # TODO: study extent
        samplingDescription = list(
          para = sampling_description
        )
      )
    ), # TODO: sampling
    project = list(
      title = dataset_title, # TODO: project title?
      personnel = list(
        individualName = list(
          givenName = "Ed", # TODO: PI?
          surName = "Weber"
        ),
        role = "Principal Investigator"
      ),
      funding = list(
        para = funding_information
      )
    )
  )
)

eml_xml <- glue("{dir_out}/eml.xml")

# my_eml <- EML::read_eml(eml_xml)

# Validate EML before writing
validation_result <- eml_validate(my_eml)
if (!validation_result) {
  cat("EML validation errors:\n")
  print(attr(validation_result, "errors"))
  stop()
} else {
  cat("EML is valid!\n")
}

# Write EML
write_eml(my_eml, eml_xml)
# browseURL(eml_xml)
```

## Data Quality Checks

```{r}
#| label: check-data-quality

# Check for missing WoRMS IDs
d_missing_worms <- tbl_species |>
  filter(is.na(worms_id)) |>
  select(species_id, scientific_name) |>
  collect()

if (nrow(d_missing_worms) > 0) {
  cat("WARNING: The following species are missing WoRMS IDs:\n")
  print(d_missing_worms)
  cat(
    "\nPlease add WoRMS AphiaIDs for these species before finalizing the dataset.\n"
  )
}

# Check for orphan records
d_orphan_occurrences <- q_occurrence_extension |>
  anti_join(q_event_core, by = "eventID") |>
  collect()

if (nrow(d_orphan_occurrences) > 0) {
  cat(
    "\nWARNING: Found",
    nrow(d_orphan_occurrences),
    "occurrence records without matching events.\n"
  )
}

# Summary statistics
n_events <- q_event_core |> summarize(n = n()) |> pull(n)
n_events <- q_event_core |>
  filter(eventType == "net_sample") |>
  summarize(n = n()) |>
  pull(n)
n_cruises <- q_event_core |>
  filter(eventType == "cruise") |>
  summarize(n = n()) |>
  pull(n)
n_sites <- q_event_core |>
  filter(eventType == "site") |>
  summarize(n = n()) |>
  pull(n)
n_tows <- q_event_core |>
  filter(eventType == "tow") |>
  summarize(n = n()) |>
  pull(n)
n_nets <- q_event_core |>
  filter(eventType == "net_sample") |>
  summarize(n = n()) |>
  pull(n)
n_occs <- q_occurrence_extension |> summarize(n = n()) |> pull(n)
n_species <- q_occurrence_extension |>
  distinct(scientificName) |>
  summarize(n = n()) |>
  pull(n)
n_measures <- d_extendedmeasurementorfact_extension |> nrow()

glue(
  "
  === Dataset Summary ===
  Total events:        {prettyNum(n_events, big.mark = ',')}
  - Cruises:           {prettyNum(n_cruises, big.mark = ',')}
  - Sites:             {prettyNum(n_sites, big.mark = ',')}
  - Tows:              {prettyNum(n_tows, big.mark = ',')}
  - Net samples:       {prettyNum(n_nets, big.mark = ',')}
  Total occurrences:   {prettyNum(n_occs, big.mark = ',')}
  Total species:       {prettyNum(n_species, big.mark = ',')}
  Total measurements:  {prettyNum(n_measures, big.mark = ',')}"
)
```

## Package Creation

```{r}
#| label: create-dwc-archive

# Create DwC-A zip file
zip_file <- file.path(dir_out, paste0("../larvae_", Sys.Date(), ".zip"))
zip(
  zip_file,
  files = file.path(
    dir_out,
    c(
      "event.csv",
      "occurrence.csv",
      "extendedMeasurementOrFact.csv",
      "meta.xml",
      "eml.xml"
    )
  ),
  flags = "-j"
) # exclude parent folders

cat("\nDarwin Core Archive created:", zip_file, "\n")
```

## Check CSV

```{r}
#| label: check-csv

d_event <- read_csv(glue("{dir_out}/event.csv"))
d_occurrence <- read_csv(glue("{dir_out}/occurrence.csv"))
d_emof <- read_csv(glue("{dir_out}/extendedMeasurementOrFact.csv"))

# d_event
# d_occurrence
# d_emof

# d_emof |> select(measurementType, measurementUnit) |> table(useNA = "ifany")
#                              measurementUnit
# measurementType               dimensionless  grams individuals millimeters
#   abundance by life stage                 0      0      125347           0
#   body length                             0      0           0      241871
#   proportion of sample sorted         76512      0           0           0
#   small plankton biomass                  0  45287           0           0
#   standardized haul factor            76512      0           0           0
#   total plankton biomass                  0  45287           0           0
```

## History of loading into IPT

### 2025-11-11: Second attempt after aligning to OBIS extendedMeasurementOrFact

![Messages from loading into IPT as "Sampling evet" on 2025-11-11](./figures/ipt-load-messages_2025-11-11.png)


### 2025-11-10: First attempt to load into GBIF IPT as "Sampling evet" dataset

![Messages from loading into IPT as "Sampling evet" on 2025-11-10](./figures/ipt-load-messages_2025-11-10.png)

> - Skipped mapped term http://rs.tdwg.org/dwc/terms/occurrencelD, which is unknown to extension http://rs.tdwg.org/dwc/terms/MeasurementOrFact
> - Skipped mapped term http://rs.tdwg.org/dwc/terms/eventID, which is unknown to extension http://rs.tdwg.org/dwc/terms/MeasurementOrFact

- ü§î But `EventID` (vs `eventID`?) clearly is supposed to link `measurementorfact` to `event` to `occurrence`, per [Example: Brackish water invertebrates survey -- Best Practices in Publishing Sampling-event data :: GBIF IPT User Manual](https://ipt.gbif.org/manual/en/ipt/latest/best-practices-sampling-event-data#brackish-water-invertebrates-survey).
- TODO: try renaming `eventID` to `EventID` in all 3 files and re-uploading to IPT.
  - Prompt: Help debug GBIF IPT response to loading a Sampling event DarwinCore dataset package from zip generated by @publish_larvae_to_obis.qmd: "Skipped mapped term http://rs.tdwg.org/dwc/terms/eventID, which is unknown to extension http://rs.tdwg.org/dwc/terms/MeasurementOrFact"


## Questions for Ed

Please confirm the following seem reasonable to you:

- [ ] Dataset ID \
  `dataset_id`: `r dataset_id` \
  See: <https://manual.obis.org/examples.html> -> `datasetID`: <https://marineinfo.org/id/dataset/6403>

- [ ] Dataset title \
  `dataset_title`: `r dataset_title`\

- [ ] Dataset abstract (200-500 words describing the dataset) \
  `dataset_abstract`: `r dataset_abstract`

- [ ] Keywords (3-5 relevant keywords) \
  `dataset_keywords`: `r dataset_keywords`\

- [ ] Country code (ISO 3166-1 alpha-2) \
  `country_code`: `r country_code`\

- [ ] Water body name \
  `water_body`: `r water_body`\

- [ ] Sampling Methods Description\
  `sampling_methods_description`: `r sampling_methods_description`\

- [ ] Study Extent Description \
  `study_extent_description`: `r study_extent_description`\

- [ ] Sampling Description \
  `sampling_description`: `r sampling_description`\

- [ ] Funding Information \
  `funding_information`: `r funding_information`\


<!-- 
## Other Checklist Items

### Personnel Information

- [ ] Dataset creator name and ORCID
- [ ] Creator organization
- [ ] Creator email
- [ ] Dataset contact name and email
- [ ] Principal investigator name

### Project Information

- [ ] Project title
- [ ] Funding information (agency and grant numbers)

### Methodology
- [ ] Detailed sampling methods description
- [ ] Study extent description
- [ ] Sampling design and protocols
- [ ] Measurement methods for environmental variables
- [ ] Size measurement methods for larvae
- [ ] Taxonomist name(s) who identified specimens
- [ ] Identification date(s)
- [ ] Identification references used

### Geographic Information
- [ ] Geographic description of the study area
- [ ] GPS accuracy (coordinate uncertainty in meters)

## Done

- [x] drop `lifeStageID` (does not exist) and make **eMoF** like ["Lifestage" in 16 Dataset Examples: ENV-DATA | The OBIS Manual](https://manual.obis.org/examples.html#:~:text=TripNR3242TripStationNR16781MidasTripActionID105598occurenceIDTA_105598_(Pseudo%2D)pediastrum_5-,Lifestage,-http%3A//vocab.nerc):

  - `measurementType`: "Lifestage"
  - `measurementTypeID`: "http://vocab.nerc.ac.uk/collection/P01/current/LSTAGE01/"
  - `measurementValue`: "adult"	
  - `measurementValueID`: "http://vocab.nerc.ac.uk/collection/S11/current/S1116/"
  - `measurementUnit`: 	
  - `measurementUnitID`: 
  - `measurementDeterminedBy`: "Flanders Marine Institute"
  - `measurementMethod`: "identified and counted by image analysis and normalised to a unit volume of water body, validated by human"
-->
