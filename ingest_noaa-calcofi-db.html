<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Ingest NOAA CalCOFI Database</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="ingest_noaa-calcofi-db_files/libs/clipboard/clipboard.min.js"></script>
<script src="ingest_noaa-calcofi-db_files/libs/quarto-html/quarto.js"></script>
<script src="ingest_noaa-calcofi-db_files/libs/quarto-html/popper.min.js"></script>
<script src="ingest_noaa-calcofi-db_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="ingest_noaa-calcofi-db_files/libs/quarto-html/anchor.min.js"></script>
<link href="ingest_noaa-calcofi-db_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="ingest_noaa-calcofi-db_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="ingest_noaa-calcofi-db_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="ingest_noaa-calcofi-db_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="ingest_noaa-calcofi-db_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="ingest_noaa-calcofi-db_files/libs/quarto-diagram/mermaid.min.js"></script>
<script src="ingest_noaa-calcofi-db_files/libs/quarto-diagram/mermaid-init.js"></script>
<link href="ingest_noaa-calcofi-db_files/libs/quarto-diagram/mermaid.css" rel="stylesheet">
<link href="ingest_noaa-calcofi-db_files/libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="ingest_noaa-calcofi-db_files/libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="ingest_noaa-calcofi-db_files/libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="ingest_noaa-calcofi-db_files/libs/datatables-binding-0.33/datatables.js"></script>
<script src="ingest_noaa-calcofi-db_files/libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="ingest_noaa-calcofi-db_files/libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="ingest_noaa-calcofi-db_files/libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="ingest_noaa-calcofi-db_files/libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="ingest_noaa-calcofi-db_files/libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="ingest_noaa-calcofi-db_files/libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>
<link href="ingest_noaa-calcofi-db_files/libs/dt-ext-colreorder-1.13.6/css/colReorder.dataTables.min.css" rel="stylesheet">
<script src="ingest_noaa-calcofi-db_files/libs/dt-ext-colreorder-1.13.6/js/dataTables.colReorder.min.js"></script>
<link href="ingest_noaa-calcofi-db_files/libs/dt-ext-rowgroup-1.13.6/css/rowGroup.dataTables.min.css" rel="stylesheet">
<script src="ingest_noaa-calcofi-db_files/libs/dt-ext-rowgroup-1.13.6/js/dataTables.rowGroup.min.js"></script>
<link href="ingest_noaa-calcofi-db_files/libs/dt-ext-responsive-1.13.6/css/responsive.dataTables.min.css" rel="stylesheet">
<script src="ingest_noaa-calcofi-db_files/libs/dt-ext-responsive-1.13.6/js/dataTables.responsive.min.js"></script>
<link href="ingest_noaa-calcofi-db_files/libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="ingest_noaa-calcofi-db_files/libs/nouislider-7.0.10/jquery.nouislider.min.js"></script>
<link href="ingest_noaa-calcofi-db_files/libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="ingest_noaa-calcofi-db_files/libs/selectize-0.12.0/selectize.min.js"></script>


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#read-csv-files" id="toc-read-csv-files" class="nav-link" data-scroll-target="#read-csv-files"><span class="header-section-number">1</span> Read CSV Files</a></li>
  <li><a href="#show-table-and-field-renames" id="toc-show-table-and-field-renames" class="nav-link" data-scroll-target="#show-table-and-field-renames"><span class="header-section-number">2</span> Show table and field renames</a></li>
  <li><a href="#apply-remappings-to-data" id="toc-apply-remappings-to-data" class="nav-link" data-scroll-target="#apply-remappings-to-data"><span class="header-section-number">3</span> Apply remappings to data</a></li>
  <li><a href="#load-tables-into-database" id="toc-load-tables-into-database" class="nav-link" data-scroll-target="#load-tables-into-database"><span class="header-section-number">4</span> Load Tables into Database</a></li>
  <li><a href="#data-quality-checks" id="toc-data-quality-checks" class="nav-link" data-scroll-target="#data-quality-checks"><span class="header-section-number">5</span> Data Quality Checks</a></li>
  <li><a href="#cleanup" id="toc-cleanup" class="nav-link" data-scroll-target="#cleanup"><span class="header-section-number">6</span> Cleanup</a></li>
  <li><a href="#todo" id="toc-todo" class="nav-link" data-scroll-target="#todo"><span class="header-section-number">7</span> TODO</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Ingest NOAA CalCOFI Database</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="overview">Overview</h2>
<p><strong>Goal</strong>: Generate the database from source files with workflow scripts to make updating easier and provenance fully transparent. This allows us to:</p>
<ul>
<li><p>Rename tables and column names, control data types and use Unicode encoding for a consistent database ingestion strategy, per Database naming conventions in <a href="https://calcofi.io/docs/db.html">Database – CalCOFI.io Docs</a>.</p></li>
<li><p>Differentiate between raw and derived or updated tables and columns. For instance, the taxonomy for any given species can change over time, such as lumping or splitting of a given taxa, and by taxonomic authority (e.g., WoRMS, ITIS or GBIF). These taxonomic identifiers and the full taxonomic hierarchy should get regularly updated regardless of source observational data, and can either be updated in the table directly or joined one-to-one with a seperate table in a materialized view (so as not to slow down queries with a regular view).</p></li>
</ul>
<p>This workflow processes NOAA CalCOFI database CSV files and updates the PostgreSQL database. The workflow:</p>
<ol type="1">
<li>Reads CSV files from source directory</li>
<li>Compares with lookup tables for field descriptions</li>
<li>Initializes or updates database tables</li>
<li>Generates summary statistics</li>
</ol>
<div class="cell" data-file="diagrams/ingest_noaa-calcofi-db_overview.mmd" data-layout-align="default">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>graph TD</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    A[Read CSV Files] --&gt; B[Extract Column Names]</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    B --&gt; C[Compare with Lookups]</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    C --&gt; D[Process Field Descriptions]</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    D --&gt; E{Table Exists?}</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    E --&gt;|Yes| F[Update Table]</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    E --&gt;|No| G[Initialize Table]</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    F --&gt; H[Summary Stats]</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    G --&gt; H</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="overview">
<div>
<pre class="mermaid mermaid-js" data-label="overview">graph TD
    A[Read CSV Files] --&gt; B[Extract Column Names]
    B --&gt; C[Compare with Lookups]
    C --&gt; D[Process Field Descriptions]
    D --&gt; E{Table Exists?}
    E --&gt;|Yes| F[Update Table]
    E --&gt;|No| G[Initialize Table]
    F --&gt; H[Summary Stats]
    G --&gt; H
</pre>
</div>
<p>Overview diagram of CSV ingestion process into the database.</p>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  DBI, DT, glue, here, janitor, lubridate, purrr, readr, rlang, tibble, tidyr, uuid,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">quiet =</span> T)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">readr.show_col_types =</span> F)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Source database connection</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">here</span>(<span class="st">"../apps_dev/libs/db.R"</span>))</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># define paths ---</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># dataset with external data folder</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>dir_data <span class="ot">&lt;-</span> <span class="st">"/Users/bbest/My Drive/projects/calcofi/data"</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>dataset  <span class="ot">&lt;-</span> <span class="st">"noaa-calcofi-db"</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>dir_csv  <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{dir_data}/{dataset}"</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># input tables (version controlled)</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>tbls_in_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="fu">glue</span>(<span class="st">"data/ingest/{dataset}/tbls_in.csv"</span>))</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>flds_in_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="fu">glue</span>(<span class="st">"data/ingest/{dataset}/flds_in.csv"</span>))</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># rename tables (version controlled)</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>tbls_rn_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="fu">glue</span>(<span class="st">"data/ingest/{dataset}/tbls_rename.csv"</span>))</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>flds_rn_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="fu">glue</span>(<span class="st">"data/ingest/{dataset}/flds_rename.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="read-csv-files" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="read-csv-files"><span class="header-section-number">1</span> Read CSV Files</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read data, extract field headers</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">csv =</span> <span class="fu">list.files</span>(</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    dir_csv, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">tbl  =</span> tools<span class="sc">::</span><span class="fu">file_path_sans_ext</span>(<span class="fu">basename</span>(csv)),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">map</span>(csv, read_csv),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> <span class="fu">map_int</span>(data, nrow),</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">ncol =</span> <span class="fu">map_int</span>(data, ncol),</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">flds =</span> <span class="fu">map2</span>(tbl, data, \(tbl, data){</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">fld  =</span> <span class="fu">names</span>(data),</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="fu">map_chr</span>(fld, \(fld) <span class="fu">class</span>(data[[fld]])[<span class="dv">1</span>] )) })) <span class="sc">|&gt;</span> </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(tbl)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">dirname</span>(tbls_in_csv)))</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">dirname</span>(tbls_in_csv), <span class="at">recursive =</span> T)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>d_tbls_in <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(tbl, nrow, ncol)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d_tbls_in, tbls_in_csv)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>d_flds_in <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(tbl, flds) <span class="sc">|&gt;</span> </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(flds) </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d_flds_in, flds_in_csv)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(d_tbls_in, <span class="at">caption =</span> <span class="st">"Tables to ingest."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-f0e3b0676d87557f8c9c" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-f0e3b0676d87557f8c9c">{"x":{"filter":"none","vertical":false,"caption":"<caption>Tables to ingest.<\/caption>","data":[["1","2","3","4","5","6","7","8","9"],["cruise","eggs","larvae","net","shiplookup","species","station","tow","towtypelookup"],[692,93065,398124,76512,48,1148,61220,75506,10],[3,3,3,8,3,5,7,5,2]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>tbl<\/th>\n      <th>nrow<\/th>\n      <th>ncol<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"tbl","targets":1},{"name":"nrow","targets":2},{"name":"ncol","targets":3}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(d_flds_in, <span class="at">caption =</span> <span class="st">"Fields to ingest."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-08577b5fa01c486688c5" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-08577b5fa01c486688c5">{"x":{"filter":"none","vertical":false,"caption":"<caption>Fields to ingest.<\/caption>","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39"],["cruise","cruise","cruise","eggs","eggs","eggs","larvae","larvae","larvae","net","net","net","net","net","net","net","net","shiplookup","shiplookup","shiplookup","species","species","species","species","species","station","station","station","station","station","station","station","tow","tow","tow","tow","tow","towtypelookup","towtypelookup"],["cruise_id","cruise_ymd","Ship","netid","sppcode","tally","netid","sppcode","tally","netid","towid","netside","shf","volsampled","propsorted","smallplankton","totalplankton","shipcode","shipname","shipnodc","sppcode","scientific_name","itis_tsn","aphiaid","common_name","stationid...1","cruise_id","orderocc","latidude","longitude","line","stationid...7","towid","stationid","towtype","townumber","starttime","code","description"],["character","numeric","character","character","numeric","numeric","character","numeric","numeric","character","character","character","numeric","numeric","numeric","numeric","numeric","character","character","character","numeric","character","numeric","numeric","character","character","character","numeric","numeric","numeric","numeric","numeric","character","character","character","numeric","POSIXct","character","character"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>tbl<\/th>\n      <th>fld<\/th>\n      <th>type<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"tbl","targets":1},{"name":"fld","targets":2},{"name":"type","targets":3}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="show-table-and-field-renames" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="show-table-and-field-renames"><span class="header-section-number">2</span> Show table and field renames</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(flds_rn_csv)){</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  d_tbls_in <span class="sc">|&gt;</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">tbl_old =</span> tbl, </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">tbl_new =</span> tbl) <span class="sc">|&gt;</span> </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(tbls_rn_csv)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  d_flds_in <span class="sc">|&gt;</span> </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(tbl) <span class="sc">|&gt;</span> </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">fld_new  =</span> <span class="fu">make_clean_names</span>(fld),</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">order    =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(),</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">comment  =</span> <span class="st">""</span>,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">notes    =</span> <span class="st">""</span>,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">mutation =</span> <span class="st">""</span>,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">type_new =</span> <span class="fu">map2_chr</span>(tbl, fld, \(x, y){</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        v <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>            tbl <span class="sc">==</span> x) <span class="sc">|&gt;</span> </span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pull</span>(data) <span class="sc">|&gt;</span> </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pluck</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pull</span>(y)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        cl <span class="ot">&lt;-</span> <span class="fu">class</span>(v)[<span class="dv">1</span>]</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (cl <span class="sc">==</span> <span class="st">"character"</span>){</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">as.UUID</span>(v))))</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="st">"uuid"</span>)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"varchar"</span>)</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># integer</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (cl <span class="sc">==</span> <span class="st">"numeric"</span> <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(v<span class="sc">%%</span><span class="dv">1</span><span class="sc">==</span><span class="dv">0</span>)){</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>          <span class="co"># https://www.postgresql.org/docs/current/datatype-numeric.html</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>            <span class="fu">min</span>(v) <span class="sc">&gt;=</span> <span class="sc">-</span><span class="dv">32768</span> <span class="sc">&amp;</span> </span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>            <span class="fu">max</span>(v) <span class="sc">&lt;=</span> <span class="dv">32767</span>)</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="st">"smallint"</span>)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>            <span class="fu">min</span>(v) <span class="sc">&gt;=</span> <span class="sc">-</span><span class="dv">2147483648</span> <span class="sc">&amp;</span> </span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>            <span class="fu">max</span>(v) <span class="sc">&lt;=</span> <span class="dv">2147483647</span>)</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="st">"integer"</span>)</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>            <span class="fu">min</span>(v) <span class="sc">&gt;=</span> <span class="sc">-</span><span class="dv">9223372036854775808</span> <span class="sc">&amp;</span> </span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>            <span class="fu">max</span>(v) <span class="sc">&lt;=</span> <span class="dv">9223372036854775807</span>)</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="st">"bigint"</span>)</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (cl <span class="sc">==</span> <span class="st">"POSIXct"</span>)</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"timestamp"</span>)</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (cl <span class="sc">==</span> <span class="st">"Date"</span>)</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"date"</span>)</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(cl)</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>        })) <span class="sc">|&gt;</span> </span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>      <span class="at">tbl_old   =</span> tbl,   <span class="at">tbl_new =</span> tbl,</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">fld_old   =</span> fld,   fld_new,</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>      <span class="at">order_old =</span> order, <span class="at">order_new =</span> order,</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>      <span class="at">type_old  =</span> type,  type_new,</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>      comment, notes, mutation) <span class="sc">|&gt;</span> </span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(flds_rn_csv)</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="fu">glue</span>(</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Please update the table and field rename tables before proceeding:</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a><span class="st">      {tbls_rn_csv}</span></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a><span class="st">      {flds_rn_csv}"</span>))</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>d_tbls_rn <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(tbls_rn_csv)</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>d_flds_rn <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(flds_rn_csv)</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>d_tbls_rn <span class="sc">|&gt;</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_equal =</span> tbl_old <span class="sc">==</span> tbl_new) <span class="sc">|&gt;</span> </span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Tables to rename."</span>,</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>      <span class="at">columnDefs =</span> <span class="fu">list</span>(<span class="fu">list</span>(</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>        <span class="at">targets =</span> <span class="st">"is_equal"</span>, <span class="at">visible =</span> F)))) <span class="sc">|&gt;</span> </span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatStyle</span>(</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tbl_new"</span>,</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">backgroundColor =</span> <span class="fu">styleEqual</span>(</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(T,F), </span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">"lightgray"</span>,<span class="st">"lightgreen"</span>)),</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">valueColumns    =</span> <span class="st">"is_equal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-eff840908a253cc179d9" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-eff840908a253cc179d9">{"x":{"filter":"none","vertical":false,"caption":"<caption>Tables to rename.<\/caption>","data":[["1","2","3","4","5","6","7","8","9"],["cruise","eggs","larvae","net","shiplookup","species","station","tow","towtypelookup"],["cruise","eggs","larvae","net","ship","species","site","tow","tow_type"],[true,true,true,true,false,true,false,true,false]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>tbl_old<\/th>\n      <th>tbl_new<\/th>\n      <th>is_equal<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":3,"visible":false},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"tbl_old","targets":1},{"name":"tbl_new","targets":2},{"name":"is_equal","targets":3}],"order":[],"autoWidth":false,"orderClasses":false,"rowCallback":"function(row, data, displayNum, displayIndex, dataIndex) {\nvar value=data[3]; $(this.api().cell(row, 2).node()).css({'background-color':value == true ? \"lightgray\" : value == false ? \"lightgreen\" : null});\n}"}},"evals":["options.rowCallback"],"jsHooks":[]}</script>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>d_flds_rn <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">tbl_is_equal   =</span> tbl_old   <span class="sc">==</span> tbl_new,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">fld_is_equal   =</span> fld_old   <span class="sc">==</span> fld_new,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">type_is_equal  =</span> type_old  <span class="sc">==</span> type_new,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">order_is_equal =</span> order_old <span class="sc">==</span> order_new,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">tbl =</span> <span class="fu">ifelse</span>(</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>      tbl_is_equal,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>      tbl_old,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">glue</span>(<span class="st">"{tbl_old} → {tbl_new}"</span>)),</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">fld =</span> <span class="fu">ifelse</span>(</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>      fld_is_equal,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>      fld_old,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">glue</span>(<span class="st">"{fld_old} → {fld_new}"</span>)),</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">ifelse</span>(</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>      type_is_equal,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>      type_old,</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">glue</span>(<span class="st">"{type_old} → {type_new}"</span>)),</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">order =</span> <span class="fu">ifelse</span>(</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>      order_is_equal,</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>      order_old,</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">glue</span>(<span class="st">"{order_old} → {order_new}"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>tbl_old,   <span class="sc">-</span>tbl_new,</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>fld_old,   <span class="sc">-</span>fld_new,</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>type_old,  <span class="sc">-</span>type_new,</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>order_old, <span class="sc">-</span>order_new) <span class="sc">|&gt;</span> </span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(tbl, fld, type, order) <span class="sc">|&gt;</span> </span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Fields to rename."</span>,</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> F,</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">colReorder =</span> T,</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">rowGroup =</span> <span class="fu">list</span>(<span class="at">dataSrc =</span> <span class="dv">0</span>),</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">pageLength =</span> <span class="dv">50</span>,</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">columnDefs =</span> <span class="fu">list</span>(<span class="fu">list</span>(</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">targets =</span> <span class="fu">c</span>(</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>          <span class="st">"tbl"</span>,</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>          <span class="st">"tbl_is_equal"</span>, <span class="st">"fld_is_equal"</span>, </span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>          <span class="st">"type_is_equal"</span>, <span class="st">"order_is_equal"</span>), </span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">visible =</span> F))),</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">extensions =</span> <span class="fu">c</span>(<span class="st">"ColReorder"</span>, <span class="st">"RowGroup"</span>, <span class="st">"Responsive"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatStyle</span>(</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fld"</span>,</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">backgroundColor =</span> <span class="fu">styleEqual</span>(</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(T, F), </span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">"lightgray"</span>,<span class="st">"lightgreen"</span>)),</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">valueColumns    =</span> <span class="st">"fld_is_equal"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatStyle</span>(</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"type"</span>,</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">backgroundColor =</span> <span class="fu">styleEqual</span>(</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(T, F), </span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">"lightgray"</span>,<span class="st">"lightgreen"</span>)),</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">valueColumns    =</span> <span class="st">"type_is_equal"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatStyle</span>(</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"order"</span>,</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">backgroundColor =</span> <span class="fu">styleEqual</span>(</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(T, F), </span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">"lightgray"</span>,<span class="st">"lightgreen"</span>)),</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">valueColumns    =</span> <span class="st">"order_is_equal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-dcaff1975b08ca13c21f" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-dcaff1975b08ca13c21f">{"x":{"filter":"none","vertical":false,"extensions":["ColReorder","RowGroup","Responsive"],"caption":"<caption>Fields to rename.<\/caption>","data":[["cruise","cruise","cruise","eggs","eggs","eggs","larvae","larvae","larvae","net","net","net","net","net","net","net","net","shiplookup → ship","shiplookup → ship","shiplookup → ship","species","species","species","species","species","station → site","station → site","station → site","station → site","station → site","station → site","station → site","tow","tow","tow","tow","tow","towtypelookup → tow_type","towtypelookup → tow_type"],["cruise_id → cruise_uuid","cruise_ymd → date_ym","Ship → ship_key","netid → net_uuid","sppcode → sp_id","tally","netid → net_uuid","sppcode → sp_id","tally","netid → net_uuid","towid → tow_uuid","netside → side","shf","volsampled","propsorted","smallplankton","totalplankton","shipcode → ship_key","shipname → name","shipnodc → nodc","sppcode → sp_id","scientific_name","itis_tsn","aphiaid → aphia_id","common_name","stationid...1 → site_uuid","cruise_id → cruise_uuid","orderocc","latidude → latitude","longitude","line","stationid...7 → station","towid → tow_uuid","stationid → site_uuid","towtype → tow_type_key","townumber → tow_number","starttime → time_start","code → tow_type_key","description"],["character → uuid","numeric → date","character → varchar","character → uuid","numeric → smallint","numeric → integer","character → uuid","numeric → smallint","numeric → smallint","character → uuid","character → uuid","character → varchar","numeric","numeric","numeric","numeric","numeric","character → varchar","character → varchar","character → varchar","numeric → smallint","character → varchar","numeric → integer","numeric → integer","character → varchar","character → uuid","character → uuid","numeric → smallint","numeric","numeric","numeric","numeric","character → uuid","character → uuid","character → varchar","numeric → smallint","POSIXct → timestamp","character → varchar","character → varchar"],["1","2","3","1","2","3","1","2","3","1","2","3","4","5","6","7","8","1","2","3","1","2","3","4","5","1","2","3","4 → 5","5 → 4","6","7","1","2","3","4","5","1","2"],[null,null,null,null,null,null,null,null,null,null,null,null,"haul factor","volume sampled (m^3)","proportion sorted","small plankton (ml)","total plankton (ml)",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,"\"n\"?",null,null,"\"n\"?",null,null,null,"shf?",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,"tow_number?",null,null,null],[null,"as.Date(glue(\"{date_ym}-01\"), format=\"%Y%m-%d\")",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,false,false,false,true,true,true,true,true,false,false,false,false,false,false,false,true,true,true,true,true,false,false],[false,false,false,false,false,true,false,false,true,false,false,false,true,true,true,true,true,false,false,false,false,true,true,false,true,false,false,true,false,true,true,false,false,false,false,false,false,false,true],[false,false,false,false,false,false,false,false,false,false,false,false,true,true,true,true,true,false,false,false,false,false,false,false,false,false,false,false,true,true,true,true,false,false,false,false,false,false,false],[true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,false,false,true,true,true,true,true,true,true,true,true]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>tbl<\/th>\n      <th>fld<\/th>\n      <th>type<\/th>\n      <th>order<\/th>\n      <th>comment<\/th>\n      <th>notes<\/th>\n      <th>mutation<\/th>\n      <th>tbl_is_equal<\/th>\n      <th>fld_is_equal<\/th>\n      <th>type_is_equal<\/th>\n      <th>order_is_equal<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"colReorder":true,"rowGroup":{"dataSrc":0},"pageLength":50,"columnDefs":[{"targets":[0,7,8,9,10],"visible":false},{"name":"tbl","targets":0},{"name":"fld","targets":1},{"name":"type","targets":2},{"name":"order","targets":3},{"name":"comment","targets":4},{"name":"notes","targets":5},{"name":"mutation","targets":6},{"name":"tbl_is_equal","targets":7},{"name":"fld_is_equal","targets":8},{"name":"type_is_equal","targets":9},{"name":"order_is_equal","targets":10}],"order":[],"autoWidth":false,"orderClasses":false,"responsive":true,"rowCallback":"function(row, data, displayNum, displayIndex, dataIndex) {\nvar value=data[8]; $(this.api().cell(row, 1).node()).css({'background-color':value == true ? \"lightgray\" : value == false ? \"lightgreen\" : null});\nvar value=data[9]; $(this.api().cell(row, 2).node()).css({'background-color':value == true ? \"lightgray\" : value == false ? \"lightgreen\" : null});\nvar value=data[10]; $(this.api().cell(row, 3).node()).css({'background-color':value == true ? \"lightgray\" : value == false ? \"lightgreen\" : null});\n}"}},"evals":["options.rowCallback"],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="apply-remappings-to-data" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="apply-remappings-to-data"><span class="header-section-number">3</span> Apply remappings to data</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>d0 <span class="ot">&lt;-</span> d</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>mutate_table <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl, data) {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># message(glue("Processing table: {tbl}"))</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  d_f <span class="ot">&lt;-</span> d_flds_rn <span class="sc">|&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(tbl_old <span class="sc">==</span> tbl)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rename fields ----</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  f_rn <span class="ot">&lt;-</span> d_f <span class="sc">|&gt;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(fld_old, fld_new) <span class="sc">|&gt;</span> </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">deframe</span>()</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">rename_with</span>(data, <span class="sc">~</span> f_rn[.x])</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate fields ----</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  d_m <span class="ot">&lt;-</span> d_f <span class="sc">|&gt;</span> </span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(fld_new, mutation) <span class="sc">|&gt;</span> </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(mutation))</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(d_m))) {</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    fld <span class="ot">&lt;-</span> d_m<span class="sc">$</span>fld_new[i]</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    mx  <span class="ot">&lt;-</span> d_m<span class="sc">$</span>mutation[i]</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># message(glue("mutating {tbl}.{fld}: `{mx}`"))</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    fld_sym <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">sym</span>(fld)</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    mx_expr <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">parse_expr</span>(mx)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> y <span class="sc">|&gt;</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="sc">!!</span><span class="at">fld_sym :=</span> <span class="fu">eval</span>(mx_expr, <span class="at">envir =</span> y))</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># order fields ----</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>  flds_ordered <span class="ot">&lt;-</span> d_f <span class="sc">|&gt;</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(order_new) <span class="sc">|&gt;</span> </span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(fld_new)</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> y <span class="sc">|&gt;</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(<span class="fu">all_of</span>(flds_ordered))</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(y)</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    d_tbls_rn,</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"tbl"</span> <span class="ot">=</span> <span class="st">"tbl_old"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_new =</span> <span class="fu">map2</span>(tbl, data, mutate_table))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="load-tables-into-database" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="load-tables-into-database"><span class="header-section-number">4</span> Load Tables into Database</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>schema    <span class="ot">&lt;-</span> <span class="st">"dev"</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>overwrite <span class="ot">&lt;-</span> T</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>tbl_to_db <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl){ <span class="co"># tbl = "eggs" # tbl = "ship"</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"{schema}.{tbl}  ~ {Sys.time()}"</span> ))</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if table exists</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  tbl_exists <span class="ot">&lt;-</span> <span class="fu">dbExistsTable</span>(</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    con, <span class="fu">Id</span>(<span class="at">schema =</span> schema, <span class="at">table =</span> tbl))</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  d_tbl <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(tbl_new <span class="sc">==</span> <span class="sc">!!</span>tbl) <span class="sc">|&gt;</span> </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(data_new) <span class="sc">|&gt;</span> </span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pluck</span>(<span class="dv">1</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  v_fld_types <span class="ot">&lt;-</span> d_flds_rn <span class="sc">|&gt;</span> </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(tbl_new <span class="sc">==</span> <span class="sc">!!</span>tbl) <span class="sc">|&gt;</span> </span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(order_new) <span class="sc">|&gt;</span> </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(fld_new, type_new) <span class="sc">|&gt;</span> </span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">deframe</span>()</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>tbl_exists <span class="sc">|</span> overwrite) {</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"  loading table"</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dbWriteTable</span>(</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>      con, </span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Id</span>(<span class="at">schema =</span> schema, <span class="at">table =</span> tbl), </span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>      d_tbl, </span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">field.types =</span> v_fld_types, </span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">append      =</span> F,</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">overwrite   =</span> T)</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"  exists, skipping"</span>)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # Get existing data</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># existing_data &lt;- dbGetQuery(</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   con, sprintf("SELECT * FROM %s LIMIT 1", table_name))</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # Compare schemas</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># new_cols &lt;- setdiff(names(data), names(existing_data))</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if (length(new_cols) &gt; 0) {</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   cat(sprintf("New columns found in %s: %s\n", table_name, paste(new_cols, collapse = ", ")))</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># }</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # Update data - this is a simple example, you might want more sophisticated merge logic</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dbWriteTable(con, table_name, data, overwrite = TRUE)</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return summary stats</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">tibble</span>(</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">tbl =</span> tbl,</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> <span class="fu">nrow</span>(d_tbl),</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">ncol =</span> <span class="fu">ncol</span>(d_tbl),</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">dtime_ingested =</span> <span class="fu">Sys.time</span>()))</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Process each table</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>tbl_stats <span class="ot">&lt;-</span> <span class="fu">map</span>(d<span class="sc">$</span>tbl_new, tbl_to_db) <span class="sc">|&gt;</span> </span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Display summary statistics</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>tbl_stats <span class="sc">|&gt;</span> </span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">rownames =</span> <span class="cn">FALSE</span>, <span class="at">filter =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-8ab30fa13f60f95d6b6f" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-8ab30fa13f60f95d6b6f">{"x":{"filter":"top","vertical":false,"filterHTML":"<tr>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"integer\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"10\" data-max=\"398124\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"integer\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"2\" data-max=\"8\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"time\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"1738110663829.24\" data-max=\"1738110688391.38\" data-scale=\"3\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["cruise","eggs","larvae","net","ship","species","site","tow","tow_type"],[692,93065,398124,76512,48,1148,61220,75506,10],[3,3,3,8,3,5,7,5,2],["2025-01-29T00:31:03Z","2025-01-29T00:31:06Z","2025-01-29T00:31:14Z","2025-01-29T00:31:18Z","2025-01-29T00:31:20Z","2025-01-29T00:31:22Z","2025-01-29T00:31:24Z","2025-01-29T00:31:26Z","2025-01-29T00:31:28Z"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>tbl<\/th>\n      <th>nrow<\/th>\n      <th>ncol<\/th>\n      <th>dtime_ingested<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2]},{"name":"tbl","targets":0},{"name":"nrow","targets":1},{"name":"ncol","targets":2},{"name":"dtime_ingested","targets":3}],"order":[],"autoWidth":false,"orderClasses":false,"orderCellsTop":true}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="data-quality-checks" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="data-quality-checks"><span class="header-section-number">5</span> Data Quality Checks</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform basic data quality checks</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>check_data_quality <span class="ot">&lt;-</span> <span class="cf">function</span>(table_name) {</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get row count</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  row_count <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    con, </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"SELECT COUNT(*) as count FROM %s"</span>, table_name)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">$</span>count</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get null counts per column</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  null_counts <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    con,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="st">      SELECT column_name, </span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="st">             COUNT(*) - COUNT(column_value) as null_count,</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="st">             ROUND(100.0 * (COUNT(*) - COUNT(column_value)) / COUNT(*), 2) as null_percentage</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="st">      FROM %s</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="st">      CROSS JOIN LATERAL (</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT json_object_keys(to_json(%s)) as column_name</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="st">      ) cols</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="st">      CROSS JOIN LATERAL (</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT %s.%I as column_value</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="st">      ) vals</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="st">      GROUP BY column_name</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="st">      HAVING COUNT(*) - COUNT(column_value) &gt; 0</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="st">      ORDER BY null_count DESC"</span>,</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>      table_name, table_name, table_name, column_name</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">row_count =</span> row_count,</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">null_analysis =</span> null_counts</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Run quality checks for each table</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>quality_results <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="fu">names</span>(processed_data), check_data_quality)</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(quality_results) <span class="ot">&lt;-</span> <span class="fu">names</span>(processed_data)</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Display quality check results</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (name <span class="cf">in</span> <span class="fu">names</span>(quality_results)) {</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Quality Check Results for %s:</span><span class="sc">\n</span><span class="st">"</span>, name))</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Total Rows: %d</span><span class="sc">\n</span><span class="st">"</span>, quality_results[[name]]<span class="sc">$</span>row_count))</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(quality_results[[name]]<span class="sc">$</span>null_analysis) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Columns with NULL values:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(quality_results[[name]]<span class="sc">$</span>null_analysis)</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"No NULL values found</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="cleanup" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="cleanup"><span class="header-section-number">6</span> Cleanup</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Close database connection</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="todo" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="todo"><span class="header-section-number">7</span> TODO</h2>
<ul class="task-list">
<li><label><input type="checkbox">Check all <code>type_new</code> are valid for db connection.</label></li>
<li><label><input type="checkbox">Check that all <code>flds_in</code> are in <code>flds_rn</code>.</label></li>
<li><label><input type="checkbox">Insert table and field SQL <code>COMMENT</code>s into database, using <code>comment</code> field + <code>workflow_md</code> (markdown with name and link) + source with tbl.fld</label></li>
<li><label><input type="checkbox">Review documentation for more comment descriptions at <a href="https://calcofi.com/index.php?option=com_content&amp;view=category&amp;id=73&amp;Itemid=993">Data &gt; Data Formats | CalCOFI.org</a></label></li>
</ul>
<!-- -->

</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb11" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Ingest NOAA CalCOFI Database"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true  </span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview {-}</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>**Goal**: Generate the database from source files with workflow scripts to make</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>updating easier and provenance fully transparent. This allows us to:</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Rename tables and column names, control data types and use Unicode encoding </span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>for a consistent database ingestion strategy, per Database naming conventions in <span class="co">[</span><span class="ot">Database – CalCOFI.io Docs</span><span class="co">](https://calcofi.io/docs/db.html)</span>.</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Differentiate between raw and derived or updated tables and columns. For </span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>instance, the taxonomy for any given species can change over time, such as</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>lumping or splitting of a given taxa, and by taxonomic authority (e.g., WoRMS, </span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>ITIS or GBIF). These taxonomic identifiers and the full taxonomic hierarchy </span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>should get regularly updated regardless of source observational data, and can</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>either be updated in the table directly or joined one-to-one with a seperate</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>table in a materialized view (so as not to slow down queries with a regular view).</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>This workflow processes NOAA CalCOFI database CSV files and updates the PostgreSQL database. The workflow:</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Reads CSV files from source directory</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Compares with lookup tables for field descriptions</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Initializes or updates database tables</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Generates summary statistics</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="in">%%| label: overview</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a><span class="in">%%| fig-cap: "Overview diagram of CSV ingestion process into the database."</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a><span class="in">%%| file: diagrams/ingest_noaa-calcofi-db_overview.mmd</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>  DBI, DT, glue, here, janitor, lubridate, purrr, readr, rlang, tibble, tidyr, uuid,</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>  <span class="at">quiet =</span> T)</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">readr.show_col_types =</span> F)</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Source database connection</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">here</span>(<span class="st">"../apps_dev/libs/db.R"</span>))</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a><span class="co"># define paths ---</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a><span class="co"># dataset with external data folder</span></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>dir_data <span class="ot">&lt;-</span> <span class="st">"/Users/bbest/My Drive/projects/calcofi/data"</span></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>dataset  <span class="ot">&lt;-</span> <span class="st">"noaa-calcofi-db"</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>dir_csv  <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{dir_data}/{dataset}"</span>)</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a><span class="co"># input tables (version controlled)</span></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>tbls_in_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="fu">glue</span>(<span class="st">"data/ingest/{dataset}/tbls_in.csv"</span>))</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>flds_in_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="fu">glue</span>(<span class="st">"data/ingest/{dataset}/flds_in.csv"</span>))</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a><span class="co"># rename tables (version controlled)</span></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>tbls_rn_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="fu">glue</span>(<span class="st">"data/ingest/{dataset}/tbls_rename.csv"</span>))</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>flds_rn_csv <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="fu">glue</span>(<span class="st">"data/ingest/{dataset}/flds_rename.csv"</span>))</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a><span class="fu">## Read CSV Files</span></span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: read_csvs</span></span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a><span class="co"># read data, extract field headers</span></span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>  <span class="at">csv =</span> <span class="fu">list.files</span>(</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>    dir_csv, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">tbl  =</span> tools<span class="sc">::</span><span class="fu">file_path_sans_ext</span>(<span class="fu">basename</span>(csv)),</span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">map</span>(csv, read_csv),</span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> <span class="fu">map_int</span>(data, nrow),</span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">ncol =</span> <span class="fu">map_int</span>(data, ncol),</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">flds =</span> <span class="fu">map2</span>(tbl, data, \(tbl, data){</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>        <span class="at">fld  =</span> <span class="fu">names</span>(data),</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="fu">map_chr</span>(fld, \(fld) <span class="fu">class</span>(data[[fld]])[<span class="dv">1</span>] )) })) <span class="sc">|&gt;</span> </span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(tbl)</span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">dirname</span>(tbls_in_csv)))</span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">dirname</span>(tbls_in_csv), <span class="at">recursive =</span> T)</span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>d_tbls_in <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(tbl, nrow, ncol)</span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d_tbls_in, tbls_in_csv)</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>d_flds_in <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(tbl, flds) <span class="sc">|&gt;</span> </span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(flds) </span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d_flds_in, flds_in_csv)</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(d_tbls_in, <span class="at">caption =</span> <span class="st">"Tables to ingest."</span>)</span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: dt_flds_in</span></span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a><span class="fu">datatable</span>(d_flds_in, <span class="at">caption =</span> <span class="st">"Fields to ingest."</span>)</span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a><span class="fu">## Show table and field renames</span></span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: create_or_read_flds_rn_csv</span></span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(flds_rn_csv)){</span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>  d_tbls_in <span class="sc">|&gt;</span> </span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a>      <span class="at">tbl_old =</span> tbl, </span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>      <span class="at">tbl_new =</span> tbl) <span class="sc">|&gt;</span> </span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(tbls_rn_csv)</span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a>  d_flds_in <span class="sc">|&gt;</span> </span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(tbl) <span class="sc">|&gt;</span> </span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a>      <span class="at">fld_new  =</span> <span class="fu">make_clean_names</span>(fld),</span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a>      <span class="at">order    =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(),</span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a>      <span class="at">comment  =</span> <span class="st">""</span>,</span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a>      <span class="at">notes    =</span> <span class="st">""</span>,</span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a>      <span class="at">mutation =</span> <span class="st">""</span>,</span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a>      <span class="at">type_new =</span> <span class="fu">map2_chr</span>(tbl, fld, \(x, y){</span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a>        v <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(</span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a>            tbl <span class="sc">==</span> x) <span class="sc">|&gt;</span> </span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pull</span>(data) <span class="sc">|&gt;</span> </span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pluck</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pull</span>(y)</span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a>        cl <span class="ot">&lt;-</span> <span class="fu">class</span>(v)[<span class="dv">1</span>]</span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (cl <span class="sc">==</span> <span class="st">"character"</span>){</span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">as.UUID</span>(v))))</span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="st">"uuid"</span>)</span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"varchar"</span>)</span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a>        <span class="co"># integer</span></span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (cl <span class="sc">==</span> <span class="st">"numeric"</span> <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(v<span class="sc">%%</span><span class="dv">1</span><span class="sc">==</span><span class="dv">0</span>)){</span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a>          <span class="co"># https://www.postgresql.org/docs/current/datatype-numeric.html</span></span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (</span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a>            <span class="fu">min</span>(v) <span class="sc">&gt;=</span> <span class="sc">-</span><span class="dv">32768</span> <span class="sc">&amp;</span> </span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a>            <span class="fu">max</span>(v) <span class="sc">&lt;=</span> <span class="dv">32767</span>)</span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="st">"smallint"</span>)</span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (</span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a>            <span class="fu">min</span>(v) <span class="sc">&gt;=</span> <span class="sc">-</span><span class="dv">2147483648</span> <span class="sc">&amp;</span> </span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a>            <span class="fu">max</span>(v) <span class="sc">&lt;=</span> <span class="dv">2147483647</span>)</span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="st">"integer"</span>)</span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (</span>
<span id="cb11-168"><a href="#cb11-168" aria-hidden="true" tabindex="-1"></a>            <span class="fu">min</span>(v) <span class="sc">&gt;=</span> <span class="sc">-</span><span class="dv">9223372036854775808</span> <span class="sc">&amp;</span> </span>
<span id="cb11-169"><a href="#cb11-169" aria-hidden="true" tabindex="-1"></a>            <span class="fu">max</span>(v) <span class="sc">&lt;=</span> <span class="dv">9223372036854775807</span>)</span>
<span id="cb11-170"><a href="#cb11-170" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="st">"bigint"</span>)</span>
<span id="cb11-171"><a href="#cb11-171" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb11-172"><a href="#cb11-172" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-173"><a href="#cb11-173" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (cl <span class="sc">==</span> <span class="st">"POSIXct"</span>)</span>
<span id="cb11-174"><a href="#cb11-174" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"timestamp"</span>)</span>
<span id="cb11-175"><a href="#cb11-175" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (cl <span class="sc">==</span> <span class="st">"Date"</span>)</span>
<span id="cb11-176"><a href="#cb11-176" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"date"</span>)</span>
<span id="cb11-177"><a href="#cb11-177" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-178"><a href="#cb11-178" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(cl)</span>
<span id="cb11-179"><a href="#cb11-179" aria-hidden="true" tabindex="-1"></a>        })) <span class="sc">|&gt;</span> </span>
<span id="cb11-180"><a href="#cb11-180" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb11-181"><a href="#cb11-181" aria-hidden="true" tabindex="-1"></a>      <span class="at">tbl_old   =</span> tbl,   <span class="at">tbl_new =</span> tbl,</span>
<span id="cb11-182"><a href="#cb11-182" aria-hidden="true" tabindex="-1"></a>      <span class="at">fld_old   =</span> fld,   fld_new,</span>
<span id="cb11-183"><a href="#cb11-183" aria-hidden="true" tabindex="-1"></a>      <span class="at">order_old =</span> order, <span class="at">order_new =</span> order,</span>
<span id="cb11-184"><a href="#cb11-184" aria-hidden="true" tabindex="-1"></a>      <span class="at">type_old  =</span> type,  type_new,</span>
<span id="cb11-185"><a href="#cb11-185" aria-hidden="true" tabindex="-1"></a>      comment, notes, mutation) <span class="sc">|&gt;</span> </span>
<span id="cb11-186"><a href="#cb11-186" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(flds_rn_csv)</span>
<span id="cb11-187"><a href="#cb11-187" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-188"><a href="#cb11-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="fu">glue</span>(</span>
<span id="cb11-189"><a href="#cb11-189" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Please update the table and field rename tables before proceeding:</span></span>
<span id="cb11-190"><a href="#cb11-190" aria-hidden="true" tabindex="-1"></a><span class="st">      {tbls_rn_csv}</span></span>
<span id="cb11-191"><a href="#cb11-191" aria-hidden="true" tabindex="-1"></a><span class="st">      {flds_rn_csv}"</span>))</span>
<span id="cb11-192"><a href="#cb11-192" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-193"><a href="#cb11-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-194"><a href="#cb11-194" aria-hidden="true" tabindex="-1"></a>d_tbls_rn <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(tbls_rn_csv)</span>
<span id="cb11-195"><a href="#cb11-195" aria-hidden="true" tabindex="-1"></a>d_flds_rn <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(flds_rn_csv)</span>
<span id="cb11-196"><a href="#cb11-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-197"><a href="#cb11-197" aria-hidden="true" tabindex="-1"></a>d_tbls_rn <span class="sc">|&gt;</span></span>
<span id="cb11-198"><a href="#cb11-198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-199"><a href="#cb11-199" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_equal =</span> tbl_old <span class="sc">==</span> tbl_new) <span class="sc">|&gt;</span> </span>
<span id="cb11-200"><a href="#cb11-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(</span>
<span id="cb11-201"><a href="#cb11-201" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Tables to rename."</span>,</span>
<span id="cb11-202"><a href="#cb11-202" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb11-203"><a href="#cb11-203" aria-hidden="true" tabindex="-1"></a>      <span class="at">columnDefs =</span> <span class="fu">list</span>(<span class="fu">list</span>(</span>
<span id="cb11-204"><a href="#cb11-204" aria-hidden="true" tabindex="-1"></a>        <span class="at">targets =</span> <span class="st">"is_equal"</span>, <span class="at">visible =</span> F)))) <span class="sc">|&gt;</span> </span>
<span id="cb11-205"><a href="#cb11-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatStyle</span>(</span>
<span id="cb11-206"><a href="#cb11-206" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tbl_new"</span>,</span>
<span id="cb11-207"><a href="#cb11-207" aria-hidden="true" tabindex="-1"></a>    <span class="at">backgroundColor =</span> <span class="fu">styleEqual</span>(</span>
<span id="cb11-208"><a href="#cb11-208" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(T,F), </span>
<span id="cb11-209"><a href="#cb11-209" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">"lightgray"</span>,<span class="st">"lightgreen"</span>)),</span>
<span id="cb11-210"><a href="#cb11-210" aria-hidden="true" tabindex="-1"></a>    <span class="at">valueColumns    =</span> <span class="st">"is_equal"</span>)</span>
<span id="cb11-211"><a href="#cb11-211" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-212"><a href="#cb11-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-215"><a href="#cb11-215" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb11-216"><a href="#cb11-216" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: dt_flds_rn</span></span>
<span id="cb11-217"><a href="#cb11-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-218"><a href="#cb11-218" aria-hidden="true" tabindex="-1"></a>d_flds_rn <span class="sc">|&gt;</span></span>
<span id="cb11-219"><a href="#cb11-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-220"><a href="#cb11-220" aria-hidden="true" tabindex="-1"></a>    <span class="at">tbl_is_equal   =</span> tbl_old   <span class="sc">==</span> tbl_new,</span>
<span id="cb11-221"><a href="#cb11-221" aria-hidden="true" tabindex="-1"></a>    <span class="at">fld_is_equal   =</span> fld_old   <span class="sc">==</span> fld_new,</span>
<span id="cb11-222"><a href="#cb11-222" aria-hidden="true" tabindex="-1"></a>    <span class="at">type_is_equal  =</span> type_old  <span class="sc">==</span> type_new,</span>
<span id="cb11-223"><a href="#cb11-223" aria-hidden="true" tabindex="-1"></a>    <span class="at">order_is_equal =</span> order_old <span class="sc">==</span> order_new,</span>
<span id="cb11-224"><a href="#cb11-224" aria-hidden="true" tabindex="-1"></a>    <span class="at">tbl =</span> <span class="fu">ifelse</span>(</span>
<span id="cb11-225"><a href="#cb11-225" aria-hidden="true" tabindex="-1"></a>      tbl_is_equal,</span>
<span id="cb11-226"><a href="#cb11-226" aria-hidden="true" tabindex="-1"></a>      tbl_old,</span>
<span id="cb11-227"><a href="#cb11-227" aria-hidden="true" tabindex="-1"></a>      <span class="fu">glue</span>(<span class="st">"{tbl_old} → {tbl_new}"</span>)),</span>
<span id="cb11-228"><a href="#cb11-228" aria-hidden="true" tabindex="-1"></a>    <span class="at">fld =</span> <span class="fu">ifelse</span>(</span>
<span id="cb11-229"><a href="#cb11-229" aria-hidden="true" tabindex="-1"></a>      fld_is_equal,</span>
<span id="cb11-230"><a href="#cb11-230" aria-hidden="true" tabindex="-1"></a>      fld_old,</span>
<span id="cb11-231"><a href="#cb11-231" aria-hidden="true" tabindex="-1"></a>      <span class="fu">glue</span>(<span class="st">"{fld_old} → {fld_new}"</span>)),</span>
<span id="cb11-232"><a href="#cb11-232" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">ifelse</span>(</span>
<span id="cb11-233"><a href="#cb11-233" aria-hidden="true" tabindex="-1"></a>      type_is_equal,</span>
<span id="cb11-234"><a href="#cb11-234" aria-hidden="true" tabindex="-1"></a>      type_old,</span>
<span id="cb11-235"><a href="#cb11-235" aria-hidden="true" tabindex="-1"></a>      <span class="fu">glue</span>(<span class="st">"{type_old} → {type_new}"</span>)),</span>
<span id="cb11-236"><a href="#cb11-236" aria-hidden="true" tabindex="-1"></a>    <span class="at">order =</span> <span class="fu">ifelse</span>(</span>
<span id="cb11-237"><a href="#cb11-237" aria-hidden="true" tabindex="-1"></a>      order_is_equal,</span>
<span id="cb11-238"><a href="#cb11-238" aria-hidden="true" tabindex="-1"></a>      order_old,</span>
<span id="cb11-239"><a href="#cb11-239" aria-hidden="true" tabindex="-1"></a>      <span class="fu">glue</span>(<span class="st">"{order_old} → {order_new}"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb11-240"><a href="#cb11-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb11-241"><a href="#cb11-241" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>tbl_old,   <span class="sc">-</span>tbl_new,</span>
<span id="cb11-242"><a href="#cb11-242" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>fld_old,   <span class="sc">-</span>fld_new,</span>
<span id="cb11-243"><a href="#cb11-243" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>type_old,  <span class="sc">-</span>type_new,</span>
<span id="cb11-244"><a href="#cb11-244" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>order_old, <span class="sc">-</span>order_new) <span class="sc">|&gt;</span> </span>
<span id="cb11-245"><a href="#cb11-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(tbl, fld, type, order) <span class="sc">|&gt;</span> </span>
<span id="cb11-246"><a href="#cb11-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(</span>
<span id="cb11-247"><a href="#cb11-247" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Fields to rename."</span>,</span>
<span id="cb11-248"><a href="#cb11-248" aria-hidden="true" tabindex="-1"></a>    <span class="at">rownames =</span> F,</span>
<span id="cb11-249"><a href="#cb11-249" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb11-250"><a href="#cb11-250" aria-hidden="true" tabindex="-1"></a>      <span class="at">colReorder =</span> T,</span>
<span id="cb11-251"><a href="#cb11-251" aria-hidden="true" tabindex="-1"></a>      <span class="at">rowGroup =</span> <span class="fu">list</span>(<span class="at">dataSrc =</span> <span class="dv">0</span>),</span>
<span id="cb11-252"><a href="#cb11-252" aria-hidden="true" tabindex="-1"></a>      <span class="at">pageLength =</span> <span class="dv">50</span>,</span>
<span id="cb11-253"><a href="#cb11-253" aria-hidden="true" tabindex="-1"></a>      <span class="at">columnDefs =</span> <span class="fu">list</span>(<span class="fu">list</span>(</span>
<span id="cb11-254"><a href="#cb11-254" aria-hidden="true" tabindex="-1"></a>        <span class="at">targets =</span> <span class="fu">c</span>(</span>
<span id="cb11-255"><a href="#cb11-255" aria-hidden="true" tabindex="-1"></a>          <span class="st">"tbl"</span>,</span>
<span id="cb11-256"><a href="#cb11-256" aria-hidden="true" tabindex="-1"></a>          <span class="st">"tbl_is_equal"</span>, <span class="st">"fld_is_equal"</span>, </span>
<span id="cb11-257"><a href="#cb11-257" aria-hidden="true" tabindex="-1"></a>          <span class="st">"type_is_equal"</span>, <span class="st">"order_is_equal"</span>), </span>
<span id="cb11-258"><a href="#cb11-258" aria-hidden="true" tabindex="-1"></a>        <span class="at">visible =</span> F))),</span>
<span id="cb11-259"><a href="#cb11-259" aria-hidden="true" tabindex="-1"></a>    <span class="at">extensions =</span> <span class="fu">c</span>(<span class="st">"ColReorder"</span>, <span class="st">"RowGroup"</span>, <span class="st">"Responsive"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb11-260"><a href="#cb11-260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatStyle</span>(</span>
<span id="cb11-261"><a href="#cb11-261" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fld"</span>,</span>
<span id="cb11-262"><a href="#cb11-262" aria-hidden="true" tabindex="-1"></a>    <span class="at">backgroundColor =</span> <span class="fu">styleEqual</span>(</span>
<span id="cb11-263"><a href="#cb11-263" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(T, F), </span>
<span id="cb11-264"><a href="#cb11-264" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">"lightgray"</span>,<span class="st">"lightgreen"</span>)),</span>
<span id="cb11-265"><a href="#cb11-265" aria-hidden="true" tabindex="-1"></a>    <span class="at">valueColumns    =</span> <span class="st">"fld_is_equal"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb11-266"><a href="#cb11-266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatStyle</span>(</span>
<span id="cb11-267"><a href="#cb11-267" aria-hidden="true" tabindex="-1"></a>    <span class="st">"type"</span>,</span>
<span id="cb11-268"><a href="#cb11-268" aria-hidden="true" tabindex="-1"></a>    <span class="at">backgroundColor =</span> <span class="fu">styleEqual</span>(</span>
<span id="cb11-269"><a href="#cb11-269" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(T, F), </span>
<span id="cb11-270"><a href="#cb11-270" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">"lightgray"</span>,<span class="st">"lightgreen"</span>)),</span>
<span id="cb11-271"><a href="#cb11-271" aria-hidden="true" tabindex="-1"></a>    <span class="at">valueColumns    =</span> <span class="st">"type_is_equal"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb11-272"><a href="#cb11-272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">formatStyle</span>(</span>
<span id="cb11-273"><a href="#cb11-273" aria-hidden="true" tabindex="-1"></a>    <span class="st">"order"</span>,</span>
<span id="cb11-274"><a href="#cb11-274" aria-hidden="true" tabindex="-1"></a>    <span class="at">backgroundColor =</span> <span class="fu">styleEqual</span>(</span>
<span id="cb11-275"><a href="#cb11-275" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(T, F), </span>
<span id="cb11-276"><a href="#cb11-276" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(<span class="st">"lightgray"</span>,<span class="st">"lightgreen"</span>)),</span>
<span id="cb11-277"><a href="#cb11-277" aria-hidden="true" tabindex="-1"></a>    <span class="at">valueColumns    =</span> <span class="st">"order_is_equal"</span>)</span>
<span id="cb11-278"><a href="#cb11-278" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-279"><a href="#cb11-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-280"><a href="#cb11-280" aria-hidden="true" tabindex="-1"></a><span class="fu">## Apply remappings to data</span></span>
<span id="cb11-281"><a href="#cb11-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-284"><a href="#cb11-284" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb11-285"><a href="#cb11-285" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: make_data_new</span></span>
<span id="cb11-286"><a href="#cb11-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-287"><a href="#cb11-287" aria-hidden="true" tabindex="-1"></a>d0 <span class="ot">&lt;-</span> d</span>
<span id="cb11-288"><a href="#cb11-288" aria-hidden="true" tabindex="-1"></a>mutate_table <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl, data) {</span>
<span id="cb11-289"><a href="#cb11-289" aria-hidden="true" tabindex="-1"></a>  <span class="co"># message(glue("Processing table: {tbl}"))</span></span>
<span id="cb11-290"><a href="#cb11-290" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-291"><a href="#cb11-291" aria-hidden="true" tabindex="-1"></a>  d_f <span class="ot">&lt;-</span> d_flds_rn <span class="sc">|&gt;</span></span>
<span id="cb11-292"><a href="#cb11-292" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(tbl_old <span class="sc">==</span> tbl)</span>
<span id="cb11-293"><a href="#cb11-293" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-294"><a href="#cb11-294" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rename fields ----</span></span>
<span id="cb11-295"><a href="#cb11-295" aria-hidden="true" tabindex="-1"></a>  f_rn <span class="ot">&lt;-</span> d_f <span class="sc">|&gt;</span></span>
<span id="cb11-296"><a href="#cb11-296" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(fld_old, fld_new) <span class="sc">|&gt;</span> </span>
<span id="cb11-297"><a href="#cb11-297" aria-hidden="true" tabindex="-1"></a>    <span class="fu">deframe</span>()</span>
<span id="cb11-298"><a href="#cb11-298" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-299"><a href="#cb11-299" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">rename_with</span>(data, <span class="sc">~</span> f_rn[.x])</span>
<span id="cb11-300"><a href="#cb11-300" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-301"><a href="#cb11-301" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate fields ----</span></span>
<span id="cb11-302"><a href="#cb11-302" aria-hidden="true" tabindex="-1"></a>  d_m <span class="ot">&lt;-</span> d_f <span class="sc">|&gt;</span> </span>
<span id="cb11-303"><a href="#cb11-303" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(fld_new, mutation) <span class="sc">|&gt;</span> </span>
<span id="cb11-304"><a href="#cb11-304" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(mutation))</span>
<span id="cb11-305"><a href="#cb11-305" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-306"><a href="#cb11-306" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(d_m))) {</span>
<span id="cb11-307"><a href="#cb11-307" aria-hidden="true" tabindex="-1"></a>    fld <span class="ot">&lt;-</span> d_m<span class="sc">$</span>fld_new[i]</span>
<span id="cb11-308"><a href="#cb11-308" aria-hidden="true" tabindex="-1"></a>    mx  <span class="ot">&lt;-</span> d_m<span class="sc">$</span>mutation[i]</span>
<span id="cb11-309"><a href="#cb11-309" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-310"><a href="#cb11-310" aria-hidden="true" tabindex="-1"></a>    <span class="co"># message(glue("mutating {tbl}.{fld}: `{mx}`"))</span></span>
<span id="cb11-311"><a href="#cb11-311" aria-hidden="true" tabindex="-1"></a>    fld_sym <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">sym</span>(fld)</span>
<span id="cb11-312"><a href="#cb11-312" aria-hidden="true" tabindex="-1"></a>    mx_expr <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">parse_expr</span>(mx)</span>
<span id="cb11-313"><a href="#cb11-313" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-314"><a href="#cb11-314" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> y <span class="sc">|&gt;</span></span>
<span id="cb11-315"><a href="#cb11-315" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="sc">!!</span><span class="at">fld_sym :=</span> <span class="fu">eval</span>(mx_expr, <span class="at">envir =</span> y))</span>
<span id="cb11-316"><a href="#cb11-316" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-317"><a href="#cb11-317" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-318"><a href="#cb11-318" aria-hidden="true" tabindex="-1"></a>  <span class="co"># order fields ----</span></span>
<span id="cb11-319"><a href="#cb11-319" aria-hidden="true" tabindex="-1"></a>  flds_ordered <span class="ot">&lt;-</span> d_f <span class="sc">|&gt;</span></span>
<span id="cb11-320"><a href="#cb11-320" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(order_new) <span class="sc">|&gt;</span> </span>
<span id="cb11-321"><a href="#cb11-321" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(fld_new)</span>
<span id="cb11-322"><a href="#cb11-322" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> y <span class="sc">|&gt;</span></span>
<span id="cb11-323"><a href="#cb11-323" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(<span class="fu">all_of</span>(flds_ordered))</span>
<span id="cb11-324"><a href="#cb11-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-325"><a href="#cb11-325" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(y)</span>
<span id="cb11-326"><a href="#cb11-326" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-327"><a href="#cb11-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-328"><a href="#cb11-328" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb11-329"><a href="#cb11-329" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb11-330"><a href="#cb11-330" aria-hidden="true" tabindex="-1"></a>    d_tbls_rn,</span>
<span id="cb11-331"><a href="#cb11-331" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"tbl"</span> <span class="ot">=</span> <span class="st">"tbl_old"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb11-332"><a href="#cb11-332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-333"><a href="#cb11-333" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_new =</span> <span class="fu">map2</span>(tbl, data, mutate_table))</span>
<span id="cb11-334"><a href="#cb11-334" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-335"><a href="#cb11-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-336"><a href="#cb11-336" aria-hidden="true" tabindex="-1"></a><span class="fu">## Load Tables into Database</span></span>
<span id="cb11-337"><a href="#cb11-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-340"><a href="#cb11-340" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb11-341"><a href="#cb11-341" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: db-operations</span></span>
<span id="cb11-342"><a href="#cb11-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-343"><a href="#cb11-343" aria-hidden="true" tabindex="-1"></a>schema    <span class="ot">&lt;-</span> <span class="st">"dev"</span></span>
<span id="cb11-344"><a href="#cb11-344" aria-hidden="true" tabindex="-1"></a>overwrite <span class="ot">&lt;-</span> T</span>
<span id="cb11-345"><a href="#cb11-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-346"><a href="#cb11-346" aria-hidden="true" tabindex="-1"></a>tbl_to_db <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl){ <span class="co"># tbl = "eggs" # tbl = "ship"</span></span>
<span id="cb11-347"><a href="#cb11-347" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"{schema}.{tbl}  ~ {Sys.time()}"</span> ))</span>
<span id="cb11-348"><a href="#cb11-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-349"><a href="#cb11-349" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if table exists</span></span>
<span id="cb11-350"><a href="#cb11-350" aria-hidden="true" tabindex="-1"></a>  tbl_exists <span class="ot">&lt;-</span> <span class="fu">dbExistsTable</span>(</span>
<span id="cb11-351"><a href="#cb11-351" aria-hidden="true" tabindex="-1"></a>    con, <span class="fu">Id</span>(<span class="at">schema =</span> schema, <span class="at">table =</span> tbl))</span>
<span id="cb11-352"><a href="#cb11-352" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-353"><a href="#cb11-353" aria-hidden="true" tabindex="-1"></a>  d_tbl <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb11-354"><a href="#cb11-354" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(tbl_new <span class="sc">==</span> <span class="sc">!!</span>tbl) <span class="sc">|&gt;</span> </span>
<span id="cb11-355"><a href="#cb11-355" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(data_new) <span class="sc">|&gt;</span> </span>
<span id="cb11-356"><a href="#cb11-356" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pluck</span>(<span class="dv">1</span>)</span>
<span id="cb11-357"><a href="#cb11-357" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-358"><a href="#cb11-358" aria-hidden="true" tabindex="-1"></a>  v_fld_types <span class="ot">&lt;-</span> d_flds_rn <span class="sc">|&gt;</span> </span>
<span id="cb11-359"><a href="#cb11-359" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(tbl_new <span class="sc">==</span> <span class="sc">!!</span>tbl) <span class="sc">|&gt;</span> </span>
<span id="cb11-360"><a href="#cb11-360" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(order_new) <span class="sc">|&gt;</span> </span>
<span id="cb11-361"><a href="#cb11-361" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(fld_new, type_new) <span class="sc">|&gt;</span> </span>
<span id="cb11-362"><a href="#cb11-362" aria-hidden="true" tabindex="-1"></a>    <span class="fu">deframe</span>()</span>
<span id="cb11-363"><a href="#cb11-363" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-364"><a href="#cb11-364" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>tbl_exists <span class="sc">|</span> overwrite) {</span>
<span id="cb11-365"><a href="#cb11-365" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-366"><a href="#cb11-366" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"  loading table"</span>)</span>
<span id="cb11-367"><a href="#cb11-367" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dbWriteTable</span>(</span>
<span id="cb11-368"><a href="#cb11-368" aria-hidden="true" tabindex="-1"></a>      con, </span>
<span id="cb11-369"><a href="#cb11-369" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Id</span>(<span class="at">schema =</span> schema, <span class="at">table =</span> tbl), </span>
<span id="cb11-370"><a href="#cb11-370" aria-hidden="true" tabindex="-1"></a>      d_tbl, </span>
<span id="cb11-371"><a href="#cb11-371" aria-hidden="true" tabindex="-1"></a>      <span class="at">field.types =</span> v_fld_types, </span>
<span id="cb11-372"><a href="#cb11-372" aria-hidden="true" tabindex="-1"></a>      <span class="at">append      =</span> F,</span>
<span id="cb11-373"><a href="#cb11-373" aria-hidden="true" tabindex="-1"></a>      <span class="at">overwrite   =</span> T)</span>
<span id="cb11-374"><a href="#cb11-374" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-375"><a href="#cb11-375" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb11-376"><a href="#cb11-376" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-377"><a href="#cb11-377" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"  exists, skipping"</span>)</span>
<span id="cb11-378"><a href="#cb11-378" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-379"><a href="#cb11-379" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # Get existing data</span></span>
<span id="cb11-380"><a href="#cb11-380" aria-hidden="true" tabindex="-1"></a>    <span class="co"># existing_data &lt;- dbGetQuery(</span></span>
<span id="cb11-381"><a href="#cb11-381" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   con, sprintf("SELECT * FROM %s LIMIT 1", table_name))</span></span>
<span id="cb11-382"><a href="#cb11-382" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span></span>
<span id="cb11-383"><a href="#cb11-383" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # Compare schemas</span></span>
<span id="cb11-384"><a href="#cb11-384" aria-hidden="true" tabindex="-1"></a>    <span class="co"># new_cols &lt;- setdiff(names(data), names(existing_data))</span></span>
<span id="cb11-385"><a href="#cb11-385" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if (length(new_cols) &gt; 0) {</span></span>
<span id="cb11-386"><a href="#cb11-386" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   cat(sprintf("New columns found in %s: %s\n", table_name, paste(new_cols, collapse = ", ")))</span></span>
<span id="cb11-387"><a href="#cb11-387" aria-hidden="true" tabindex="-1"></a>    <span class="co"># }</span></span>
<span id="cb11-388"><a href="#cb11-388" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span></span>
<span id="cb11-389"><a href="#cb11-389" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # Update data - this is a simple example, you might want more sophisticated merge logic</span></span>
<span id="cb11-390"><a href="#cb11-390" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dbWriteTable(con, table_name, data, overwrite = TRUE)</span></span>
<span id="cb11-391"><a href="#cb11-391" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-392"><a href="#cb11-392" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-393"><a href="#cb11-393" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return summary stats</span></span>
<span id="cb11-394"><a href="#cb11-394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">tibble</span>(</span>
<span id="cb11-395"><a href="#cb11-395" aria-hidden="true" tabindex="-1"></a>    <span class="at">tbl =</span> tbl,</span>
<span id="cb11-396"><a href="#cb11-396" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> <span class="fu">nrow</span>(d_tbl),</span>
<span id="cb11-397"><a href="#cb11-397" aria-hidden="true" tabindex="-1"></a>    <span class="at">ncol =</span> <span class="fu">ncol</span>(d_tbl),</span>
<span id="cb11-398"><a href="#cb11-398" aria-hidden="true" tabindex="-1"></a>    <span class="at">dtime_ingested =</span> <span class="fu">Sys.time</span>()))</span>
<span id="cb11-399"><a href="#cb11-399" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-400"><a href="#cb11-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-401"><a href="#cb11-401" aria-hidden="true" tabindex="-1"></a><span class="co"># Process each table</span></span>
<span id="cb11-402"><a href="#cb11-402" aria-hidden="true" tabindex="-1"></a>tbl_stats <span class="ot">&lt;-</span> <span class="fu">map</span>(d<span class="sc">$</span>tbl_new, tbl_to_db) <span class="sc">|&gt;</span> </span>
<span id="cb11-403"><a href="#cb11-403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span>
<span id="cb11-404"><a href="#cb11-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-405"><a href="#cb11-405" aria-hidden="true" tabindex="-1"></a><span class="co"># Display summary statistics</span></span>
<span id="cb11-406"><a href="#cb11-406" aria-hidden="true" tabindex="-1"></a>tbl_stats <span class="sc">|&gt;</span> </span>
<span id="cb11-407"><a href="#cb11-407" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(<span class="at">rownames =</span> <span class="cn">FALSE</span>, <span class="at">filter =</span> <span class="st">"top"</span>)</span>
<span id="cb11-408"><a href="#cb11-408" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-409"><a href="#cb11-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-410"><a href="#cb11-410" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Quality Checks</span></span>
<span id="cb11-411"><a href="#cb11-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-414"><a href="#cb11-414" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb11-415"><a href="#cb11-415" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: quality-checks</span></span>
<span id="cb11-416"><a href="#cb11-416" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb11-417"><a href="#cb11-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-418"><a href="#cb11-418" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform basic data quality checks</span></span>
<span id="cb11-419"><a href="#cb11-419" aria-hidden="true" tabindex="-1"></a>check_data_quality <span class="ot">&lt;-</span> <span class="cf">function</span>(table_name) {</span>
<span id="cb11-420"><a href="#cb11-420" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get row count</span></span>
<span id="cb11-421"><a href="#cb11-421" aria-hidden="true" tabindex="-1"></a>  row_count <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(</span>
<span id="cb11-422"><a href="#cb11-422" aria-hidden="true" tabindex="-1"></a>    con, </span>
<span id="cb11-423"><a href="#cb11-423" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"SELECT COUNT(*) as count FROM %s"</span>, table_name)</span>
<span id="cb11-424"><a href="#cb11-424" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">$</span>count</span>
<span id="cb11-425"><a href="#cb11-425" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-426"><a href="#cb11-426" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get null counts per column</span></span>
<span id="cb11-427"><a href="#cb11-427" aria-hidden="true" tabindex="-1"></a>  null_counts <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(</span>
<span id="cb11-428"><a href="#cb11-428" aria-hidden="true" tabindex="-1"></a>    con,</span>
<span id="cb11-429"><a href="#cb11-429" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"</span></span>
<span id="cb11-430"><a href="#cb11-430" aria-hidden="true" tabindex="-1"></a><span class="st">      SELECT column_name, </span></span>
<span id="cb11-431"><a href="#cb11-431" aria-hidden="true" tabindex="-1"></a><span class="st">             COUNT(*) - COUNT(column_value) as null_count,</span></span>
<span id="cb11-432"><a href="#cb11-432" aria-hidden="true" tabindex="-1"></a><span class="st">             ROUND(100.0 * (COUNT(*) - COUNT(column_value)) / COUNT(*), 2) as null_percentage</span></span>
<span id="cb11-433"><a href="#cb11-433" aria-hidden="true" tabindex="-1"></a><span class="st">      FROM %s</span></span>
<span id="cb11-434"><a href="#cb11-434" aria-hidden="true" tabindex="-1"></a><span class="st">      CROSS JOIN LATERAL (</span></span>
<span id="cb11-435"><a href="#cb11-435" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT json_object_keys(to_json(%s)) as column_name</span></span>
<span id="cb11-436"><a href="#cb11-436" aria-hidden="true" tabindex="-1"></a><span class="st">      ) cols</span></span>
<span id="cb11-437"><a href="#cb11-437" aria-hidden="true" tabindex="-1"></a><span class="st">      CROSS JOIN LATERAL (</span></span>
<span id="cb11-438"><a href="#cb11-438" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT %s.%I as column_value</span></span>
<span id="cb11-439"><a href="#cb11-439" aria-hidden="true" tabindex="-1"></a><span class="st">      ) vals</span></span>
<span id="cb11-440"><a href="#cb11-440" aria-hidden="true" tabindex="-1"></a><span class="st">      GROUP BY column_name</span></span>
<span id="cb11-441"><a href="#cb11-441" aria-hidden="true" tabindex="-1"></a><span class="st">      HAVING COUNT(*) - COUNT(column_value) &gt; 0</span></span>
<span id="cb11-442"><a href="#cb11-442" aria-hidden="true" tabindex="-1"></a><span class="st">      ORDER BY null_count DESC"</span>,</span>
<span id="cb11-443"><a href="#cb11-443" aria-hidden="true" tabindex="-1"></a>      table_name, table_name, table_name, column_name</span>
<span id="cb11-444"><a href="#cb11-444" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-445"><a href="#cb11-445" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-446"><a href="#cb11-446" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-447"><a href="#cb11-447" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb11-448"><a href="#cb11-448" aria-hidden="true" tabindex="-1"></a>    <span class="at">row_count =</span> row_count,</span>
<span id="cb11-449"><a href="#cb11-449" aria-hidden="true" tabindex="-1"></a>    <span class="at">null_analysis =</span> null_counts</span>
<span id="cb11-450"><a href="#cb11-450" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb11-451"><a href="#cb11-451" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-452"><a href="#cb11-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-453"><a href="#cb11-453" aria-hidden="true" tabindex="-1"></a><span class="co"># Run quality checks for each table</span></span>
<span id="cb11-454"><a href="#cb11-454" aria-hidden="true" tabindex="-1"></a>quality_results <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="fu">names</span>(processed_data), check_data_quality)</span>
<span id="cb11-455"><a href="#cb11-455" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(quality_results) <span class="ot">&lt;-</span> <span class="fu">names</span>(processed_data)</span>
<span id="cb11-456"><a href="#cb11-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-457"><a href="#cb11-457" aria-hidden="true" tabindex="-1"></a><span class="co"># Display quality check results</span></span>
<span id="cb11-458"><a href="#cb11-458" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (name <span class="cf">in</span> <span class="fu">names</span>(quality_results)) {</span>
<span id="cb11-459"><a href="#cb11-459" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Quality Check Results for %s:</span><span class="sc">\n</span><span class="st">"</span>, name))</span>
<span id="cb11-460"><a href="#cb11-460" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Total Rows: %d</span><span class="sc">\n</span><span class="st">"</span>, quality_results[[name]]<span class="sc">$</span>row_count))</span>
<span id="cb11-461"><a href="#cb11-461" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-462"><a href="#cb11-462" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(quality_results[[name]]<span class="sc">$</span>null_analysis) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb11-463"><a href="#cb11-463" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Columns with NULL values:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-464"><a href="#cb11-464" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(quality_results[[name]]<span class="sc">$</span>null_analysis)</span>
<span id="cb11-465"><a href="#cb11-465" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb11-466"><a href="#cb11-466" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"No NULL values found</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-467"><a href="#cb11-467" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-468"><a href="#cb11-468" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-469"><a href="#cb11-469" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-470"><a href="#cb11-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-471"><a href="#cb11-471" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cleanup</span></span>
<span id="cb11-472"><a href="#cb11-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-475"><a href="#cb11-475" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb11-476"><a href="#cb11-476" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cleanup</span></span>
<span id="cb11-477"><a href="#cb11-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-478"><a href="#cb11-478" aria-hidden="true" tabindex="-1"></a><span class="co"># Close database connection</span></span>
<span id="cb11-479"><a href="#cb11-479" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con)</span>
<span id="cb11-480"><a href="#cb11-480" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb11-481"><a href="#cb11-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-482"><a href="#cb11-482" aria-hidden="true" tabindex="-1"></a><span class="fu">## TODO</span></span>
<span id="cb11-483"><a href="#cb11-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-484"><a href="#cb11-484" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Check all <span class="in">`type_new`</span> are valid for db connection.</span>
<span id="cb11-485"><a href="#cb11-485" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Check that all <span class="in">`flds_in`</span> are in <span class="in">`flds_rn`</span>.</span>
<span id="cb11-486"><a href="#cb11-486" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Insert table and field SQL <span class="in">`COMMENT`</span>s into database, using <span class="in">`comment`</span> field + <span class="in">`workflow_md`</span> (markdown with name and link) + source with tbl.fld </span>
<span id="cb11-487"><a href="#cb11-487" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Review documentation for more comment descriptions at <span class="co">[</span><span class="ot">Data &gt; Data Formats | CalCOFI.org</span><span class="co">](https://calcofi.com/index.php?option=com_content&amp;view=category&amp;id=73&amp;Itemid=993)</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>